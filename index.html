<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#12101a">
<link rel="preconnect" href="https://unpkg.com">
<link rel="manifest" href="./manifest.json">
<title>Watch Advisor v24.6</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;600&family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#07060a;--card:#0d0c14;--card2:#12101a;--card3:#14121e;--border:#1c1828;--gold:#c9a84c;--text:#e0dcd4;--sub:#7a7484;--dim:#4a4458;--warn:#c85a3a;--good:#7ab87a;--badge-good:#0a1a0a;--badge-warn:#1a0a0a;--badge-neutral:#0a0a1a;--del-text:#6a3a3a;--del-border:#2a1a1a;--rep-border:#2a2520;--f:'DM Sans',sans-serif;--sf:'Cormorant Garamond',Georgia,serif}
html,body{background:var(--bg);color:var(--text);font-family:var(--sf);min-height:100vh;-webkit-font-smoothing:antialiased}
body.modal-open{overflow:hidden}
/* Safety: ensure modal class gets cleaned up */
body:not(.modal-open){position:static}
input,select,button,textarea{font-family:var(--f);outline:none}
input[type="file"]{display:none}
input,select,textarea{font-size:16px!important}
/* GPU-accelerated transforms for all interactive elements */
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translate3d(0,10px,0)}to{opacity:1;transform:translate3d(0,0,0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes slideUp{from{opacity:0;transform:translate3d(0,100%,0)}to{opacity:1;transform:translate3d(0,0,0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.fu{animation:fadeUp .35s cubic-bezier(.22,.68,0,1) both}.sp{animation:spin 1s linear infinite}.pu{animation:pulse 1.5s ease infinite}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.hscroll{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;scroll-snap-type:x proximity}.hscroll::-webkit-scrollbar{display:none}
.chip{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:12px;font-size:11px;font-family:var(--f);cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--sub);white-space:nowrap;transition:background .15s,border-color .15s,color .15s;min-height:32px;user-select:none}
.chip.on{background:rgba(201,168,76,0.1);border-color:rgba(201,168,76,0.3);color:var(--gold)}
.chip:active{transform:scale(0.95)}
.inp{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.inp:focus{border-color:rgba(201,168,76,0.4)}
.sel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.lbl{font-size:9px;font-family:var(--f);color:var(--dim);letter-spacing:0.1em;margin-bottom:4px;display:block;text-transform:uppercase}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;display:flex;flex-direction:column;justify-content:flex-end;animation:fadeIn .15s ease-out;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px)}
.modal-body{background:var(--card);border-radius:20px 20px 0 0;padding:20px 20px max(env(safe-area-inset-bottom,20px),20px);max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:slideUp .3s cubic-bezier(.22,.68,0,1)}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 14px}
.swatch{width:34px;height:34px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .15s,box-shadow .15s;flex-shrink:0}
.swatch:active{transform:scale(0.9)}
.swatch.on{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,0.3)}
.btn{border:none;border-radius:10px;padding:14px;cursor:pointer;font-family:var(--f);font-size:14px;font-weight:600;width:100%;text-align:center;min-height:48px;user-select:none;transition:transform .15s cubic-bezier(.22,.68,0,1),box-shadow .2s ease}
.btn:active{transform:scale(0.97)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8882a);color:var(--bg)}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--sub)}
.outfit-slot{background:var(--bg);border:2px dashed var(--border);border-radius:12px;padding:10px;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:border-color .2s,background .2s}
.outfit-slot.filled{border-style:solid;border-color:var(--border)}
.outfit-slot.active{border-color:var(--gold);background:var(--card)}
.score-bar{height:5px;border-radius:3px;background:var(--border);overflow:hidden}
.score-fill{height:100%;border-radius:3px;transition:width .5s cubic-bezier(.22,.68,0,1)}
.card-lift{box-shadow:0 2px 8px rgba(0,0,0,0.25);transition:transform .2s cubic-bezier(.22,.68,0,1);content-visibility:auto;contain-intrinsic-size:auto 200px}
.card-lift:active{box-shadow:0 1px 4px rgba(0,0,0,0.2)}
.gcard{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .2s cubic-bezier(.22,.68,0,1);content-visibility:auto;contain-intrinsic-size:auto 180px}
.gcard:active{transform:scale(0.97)}
.gcard-overlay{position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,0.7));pointer-events:none}
img{image-rendering:auto;-webkit-image-rendering:auto}
.dots-row{display:flex;gap:3px;align-items:center}
.onboard{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
.onboard h1{font-size:32px;font-weight:300;letter-spacing:0.2em;color:var(--gold);margin-bottom:8px}
body.light{--bg:#f5f4f0;--card:#ffffff;--card2:#fafaf8;--card3:#f0efe8;--border:#e0dcd4;--gold:#b8962a;--text:#1a1a1a;--sub:#6a6464;--dim:#9a9494;--warn:#c85a3a;--good:#2a8a2a;--badge-good:#e6f4e6;--badge-warn:#f4e6e6;--badge-neutral:#eaeaf2;--del-text:#c85a3a;--del-border:#e0c8c8;--rep-border:#d0ccc4}
body.light .chip{background:#f0efe8;color:#6a6464;border-color:#e0dcd4}
body.light .chip.on{background:rgba(184,150,42,0.12);border-color:rgba(184,150,42,0.35);color:#b8962a}
body.light .inp,body.light .sel{background:#f5f4f0;border-color:#e0dcd4;color:#1a1a1a}
body.light .modal-backdrop{background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
body.light .modal-body{background:#ffffff}
body.light .modal-handle{background:var(--border)}
body.light .score-bar{background:var(--border)}
body.light .card-lift{box-shadow:0 2px 8px rgba(0,0,0,0.08)}
body.light .btn-gold{background:linear-gradient(135deg,#b8962a,#9a7a1a);color:#fff}
body.light .btn-ghost{border-color:#e0dcd4;color:#6a6464}
body.light .gcard{border-color:#e0dcd4}
body.light .swatch.on{border-color:#b8962a;box-shadow:0 0 0 3px rgba(184,150,42,0.3)}
body.light .gcard-overlay{background:linear-gradient(transparent,rgba(255,255,255,0.6))}
body.light input,body.light select,body.light textarea{color:#1a1a1a}
body.light .outfit-slot.active{background:rgba(184,150,42,0.06)}
.theme-toggle{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;color:var(--dim);font-size:14px;min-height:32px;transition:border-color .2s,color .2s}
.theme-toggle:hover{border-color:var(--gold);color:var(--gold)}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useRef,useMemo,useEffect,useCallback,memo}=React;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INDEXED DB PHOTO STORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _idb=null,_pc={};
function idbOpen(){if(_idb)return Promise.resolve(_idb);return new Promise(function(ok,no){var r=indexedDB.open("wa-photos",1);r.onupgradeneeded=function(){r.result.createObjectStore("imgs")};r.onsuccess=function(){_idb=r.result;ok(_idb)};r.onerror=function(){no(r.error)}})}
function idbPut(k,v){return idbOpen().then(function(db){return new Promise(function(ok,no){var t=db.transaction("imgs","readwrite");t.objectStore("imgs").put(v,k);t.oncomplete=function(){ok()};t.onerror=function(){no(t.error)}})})}
function idbGet(k){return idbOpen().then(function(db){return new Promise(function(ok){var t=db.transaction("imgs","readonly");var r=t.objectStore("imgs").get(k);r.onsuccess=function(){ok(r.result||null)};r.onerror=function(){ok(null)}})})}
function d2b(d){var p=d.split(","),m=p[0].match(/:(.*?);/)[1],r=atob(p[1]),a=new Uint8Array(r.length);for(var i=0;i<r.length;i++)a[i]=r.charCodeAt(i);return new Blob([a],{type:m})}
async function savePhoto(k,dataUrl){try{await idbPut(k,d2b(dataUrl));var b=await idbGet(k);if(b){_pc["idb:"+k]=URL.createObjectURL(b)}return "idb:"+k}catch(e){console.warn("[IDB]",e);return dataUrl}}
function ph(s){if(!s)return null;if(s.startsWith("idb:"))return _pc[s]||null;return s}
async function preloadPhotos(items){var refs=[];for(var it of items){if(it.photoUrl&&it.photoUrl.startsWith("idb:"))refs.push(it.photoUrl);if(it.straps)for(var s of it.straps)if(s.photoUrl&&s.photoUrl.startsWith("idb:"))refs.push(s.photoUrl)}if(!refs.length)return;try{var db=await idbOpen();var tx=db.transaction("imgs","readonly");var st=tx.objectStore("imgs");await Promise.all(refs.map(function(ref){if(_pc[ref])return;return new Promise(function(ok){var r=st.get(ref.slice(4));r.onsuccess=function(){if(r.result)_pc[ref]=URL.createObjectURL(r.result);ok()};r.onerror=ok})}))}catch(e){console.warn("[IDB] preload:",e)}}
async function migrateToIDB(items,pfx){var ch=false;for(var it of items){if(it.photoUrl&&it.photoUrl.startsWith("data:")){it.photoUrl=await savePhoto(pfx+"_"+it.id,it.photoUrl);ch=true}if(it.straps)for(var j=0;j<it.straps.length;j++){if(it.straps[j].photoUrl&&it.straps[j].photoUrl.startsWith("data:")){it.straps[j].photoUrl=await savePhoto(pfx+"_"+it.id+"_s"+j,it.straps[j].photoUrl);ch=true}}}return ch}
async function photoAsDataUrl(ref){if(!ref||!ref.startsWith("idb:"))return ref;try{var b=await idbGet(ref.slice(4));if(!b)return null;return new Promise(function(ok){var r=new FileReader();r.onload=function(){ok(r.result)};r.readAsDataURL(b)})}catch(e){return null}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* Set IS_SHARED=true to create a version for friends (empty collection, onboarding) */
const IS_SHARED=false;

/* ‚ïê‚ïê‚ïê ENCRYPTED BACKUP / RECOVERY ‚ïê‚ïê‚ïê */
async function deriveKey(password,salt){
  if(!crypto||!crypto.subtle)throw new Error("Web Crypto API requires HTTPS. Backup/restore is not available on HTTP pages.");
  var enc=new TextEncoder();
  var keyMaterial=await crypto.subtle.importKey("raw",enc.encode(password),"PBKDF2",false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:310000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encryptData(plaintext,password){
  var salt=crypto.getRandomValues(new Uint8Array(16));
  var iv=crypto.getRandomValues(new Uint8Array(12));
  var key=await deriveKey(password,salt);
  var enc=new TextEncoder();
  var ct=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc.encode(plaintext));
  /* Pack: 16 salt + 12 iv + ciphertext */
  var buf=new Uint8Array(16+12+ct.byteLength);
  buf.set(salt,0);buf.set(iv,16);buf.set(new Uint8Array(ct),28);
  return buf;
}
async function decryptData(packed,password){
  var salt=packed.slice(0,16);
  var iv=packed.slice(16,28);
  var ct=packed.slice(28);
  var key=await deriveKey(password,salt);
  var pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,ct);
  return new TextDecoder().decode(pt);
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API KEY ENCRYPTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* Encrypts the API key at rest using a random device secret.
   Not military-grade, but prevents plaintext key in localStorage/storage. */
function _getDeviceSecret(){
  try{var s=localStorage.getItem("wa_dsec");if(s&&s.length>=32)return s;
  var arr=new Uint8Array(32);crypto.getRandomValues(arr);
  s=Array.from(arr,function(b){return b.toString(16).padStart(2,"0")}).join("");
  localStorage.setItem("wa_dsec",s);return s}catch(e){return"wa_fallback_key_00000000000000000"}
}
function encryptApiKey(key){
  if(!key)return"";
  try{var secret=_getDeviceSecret();var out=[];
  for(var i=0;i<key.length;i++){out.push(key.charCodeAt(i)^secret.charCodeAt(i%secret.length))}
  return"ENC:"+btoa(String.fromCharCode.apply(null,out))}catch(e){return key}
}
function decryptApiKey(stored){
  if(!stored)return"";
  if(!stored.startsWith("ENC:"))return stored; /* legacy plaintext ‚Äî will be re-encrypted on next save */
  try{var secret=_getDeviceSecret();var raw=atob(stored.slice(4));var out=[];
  for(var i=0;i<raw.length;i++){out.push(String.fromCharCode(raw.charCodeAt(i)^secret.charCodeAt(i%secret.length)))}
  return out.join("")}catch(e){return""}
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEMISPHERE-AWARE SEASON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* Temperature-first, month fallback respects latitude for hemisphere */
function getSeason(temp,lat){
  if(temp!==undefined&&temp!==null){
    if(temp>=28)return"summer";if(temp>=20)return"spring";if(temp>=12)return"fall";return"winter";
  }
  var m=new Date().getMonth();
  /* Northern hemisphere (default): Mar-May spring, Jun-Aug summer, Sep-Nov fall, Dec-Feb winter */
  var nSeason;
  if(m>=2&&m<=4)nSeason="spring";else if(m>=5&&m<=7)nSeason="summer";else if(m>=8&&m<=10)nSeason="fall";else nSeason="winter";
  /* Southern hemisphere: flip seasons */
  if(lat!==undefined&&lat<0){
    var flip={"spring":"fall","summer":"winter","fall":"spring","winter":"summer"};
    return flip[nSeason]||nSeason;
  }
  return nSeason;
}
const SK="v14"; /* storage key suffix ‚Äî change to reset data */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CM={
"black":{h:"#1a1a1a",t:"cool"},"white":{h:"#f0f0ec",t:"neutral"},"cream":{h:"#f5f0e0",t:"warm"},
"ivory":{h:"#f8f4ea",t:"warm"},"grey":{h:"#8a8a8a",t:"cool"},"light grey":{h:"#c0c0c0",t:"cool"},
"charcoal":{h:"#3a3a3a",t:"cool"},"navy":{h:"#1a2a4a",t:"cool"},"blue":{h:"#2a5a9a",t:"cool"},
"light blue":{h:"#7ab0d8",t:"cool"},"cobalt":{h:"#0047AB",t:"cool"},"teal":{h:"#1a8a7a",t:"cool"},
"turquoise":{h:"#2ab8a8",t:"cool"},"green":{h:"#2a6a3a",t:"cool"},"forest green":{h:"#1a4a2a",t:"cool"},
"olive":{h:"#5a6a3a",t:"warm"},"sage":{h:"#8aaa7a",t:"cool"},"red":{h:"#b83a3a",t:"warm"},
"burgundy":{h:"#6a1a2a",t:"warm"},"wine":{h:"#5a1a2a",t:"warm"},"plum":{h:"#6a2a5a",t:"warm"},
"pink":{h:"#d88a9a",t:"warm"},"orange":{h:"#d87a2a",t:"warm"},"burnt orange":{h:"#b85a2a",t:"warm"},
"yellow":{h:"#d4b82a",t:"warm"},"brown":{h:"#6a4a2a",t:"warm"},"tan":{h:"#c8a878",t:"warm"},
"camel":{h:"#c8a060",t:"warm"},"chocolate":{h:"#3a2a1a",t:"warm"},"khaki":{h:"#b8a878",t:"warm"},
"beige":{h:"#d8c8a8",t:"warm"},"lavender":{h:"#9a8abc",t:"cool"},"purple":{h:"#5a2a7a",t:"cool"},
"denim":{h:"#4a6a8a",t:"cool"},"dark brown":{h:"#4a3020",t:"warm"},"rust":{h:"#a84a2a",t:"warm"},
"sand":{h:"#c8b898",t:"warm"},"mint":{h:"#7ac8a8",t:"cool"},"slate":{h:"#6a7a8a",t:"cool"},
"gold":{h:"#c9a84c",t:"warm"},"mauve":{h:"#a07888",t:"warm"},"silver":{h:"#b0b0b0",t:"cool"},
"coral":{h:"#e87461",t:"warm"},"dusty rose":{h:"#c4867a",t:"warm"},"pewter":{h:"#8e9196",t:"cool"},
"mushroom":{h:"#b5a99a",t:"warm"},"charcoal blue":{h:"#36454f",t:"cool"},"stone":{h:"#bab5a8",t:"warm"},
"steel blue":{h:"#4682b4",t:"cool"},"taupe":{h:"#8b7d6b",t:"warm"},"indigo":{h:"#3f4fa1",t:"cool"},
"cognac":{h:"#9a4a2a",t:"warm"},"ecru":{h:"#c8b88a",t:"warm"},"powder blue":{h:"#a8c8e0",t:"cool"},
"emerald":{h:"#1a7a4a",t:"cool"},"copper":{h:"#b87333",t:"warm"},"graphite":{h:"#4a4a52",t:"cool"},
};
const AC=Object.keys(CM);
const CG=[
{l:"Neutrals",c:["black","charcoal","graphite","grey","light grey","pewter","silver","slate","white","cream","ivory","ecru","beige","sand","stone","mushroom","taupe"]},
{l:"Blues",c:["navy","indigo","cobalt","blue","steel blue","charcoal blue","light blue","powder blue","denim","teal","turquoise","mint"]},
{l:"Greens",c:["forest green","emerald","green","olive","sage"]},
{l:"Reds",c:["burgundy","wine","red","coral","dusty rose","rust","burnt orange","orange","copper"]},
{l:"Warm",c:["brown","dark brown","chocolate","cognac","tan","camel","khaki","gold","yellow"]},
{l:"Others",c:["plum","purple","lavender","mauve","pink"]},
];
const PATTERNS=["solid","plaid","striped","checked","print","textured"];
const MATERIALS=["cotton","linen","wool","cashmere","silk","denim","chino","suede","leather","canvas","synthetic","knit","tweed","corduroy","fleece","nylon"];
/* ‚ïê‚ïê‚ïê AUTO GARMENT NAME BUILDER ‚ïê‚ïê‚ïê */
/* Builds "Color [Material] Type" name. Used when user changes color/material/type. */
function buildGarmentName(color,material,garmentType){
  var parts=[];
  if(color){parts.push(color.charAt(0).toUpperCase()+color.slice(1))}
  /* Include material only if it's not redundant with garmentType (e.g. skip "Denim Jeans", "Chino Chinos") */
  if(material){
    var mt=(material||"").toLowerCase(),gt=(garmentType||"").toLowerCase();
    var redundant=(mt==="denim"&&gt==="jeans")||(mt==="chino"&&gt==="chinos")||(mt==="leather"&&gt==="shoes")||(mt==="knit"&&(gt==="sweater/knit"||gt==="cardigan"));
    if(!redundant)parts.push(material.charAt(0).toUpperCase()+material.slice(1));
  }
  if(garmentType)parts.push(garmentType);
  return parts.join(" ")||"";
}
/* Garment type aliases ‚Äî AI might say "Blazer" instead of "Jacket/Blazer" */
var _typeAliases={"jacket/blazer":["blazer","jacket","sport coat","sports coat"],"sweater/knit":["sweater","knit","knitwear","jumper","pullover"],"pants/trousers":["trousers","pants","slacks","dress pants"],"t-shirt":["tee","t shirt","tshirt"]};
function _typeWords(gt){
  if(!gt)return[];
  var lc=gt.toLowerCase();
  var words=[lc];
  Object.keys(_typeAliases).forEach(function(k){
    if(k===lc)words=words.concat(_typeAliases[k]);
    else if(_typeAliases[k].indexOf(lc)>=0)words.push(k);
    _typeAliases[k].forEach(function(a){if(a===lc)words.push(k)});
  });
  return words;
}
/* Check if a name looks auto-generated (matches "Color [Material] Type" pattern or is empty).
   Also detects AI-style names like "Navy Wool Blazer" where Type is an alias. */
function isAutoName(name,color,material,garmentType){
  if(!name||!name.trim())return true;
  var nm=name.trim().toLowerCase();
  /* Exact match against buildGarmentName combos */
  var candidates=[
    buildGarmentName(color,material,garmentType),
    buildGarmentName(color,null,garmentType),
    buildGarmentName(color,material,null),
    (color||"")+" "+(garmentType||"")
  ].map(function(s){return s.trim().toLowerCase()});
  if(candidates.indexOf(nm)>=0)return true;
  /* Fuzzy: also check with type aliases ("Blazer" ‚Üî "Jacket/Blazer") */
  var tw=_typeWords(garmentType);
  for(var i=0;i<tw.length;i++){
    var alt=[buildGarmentName(color,material,tw[i]),buildGarmentName(color,null,tw[i])].map(function(s){return s.trim().toLowerCase()});
    if(alt.indexOf(nm)>=0)return true;
  }
  /* Pattern: name is just color + optional material + any garment-ish word */
  if(color&&nm.indexOf(color.toLowerCase())===0){
    var rest=nm.slice(color.length).trim();
    if(!rest)return true; /* just the color */
    /* Check if the remaining text is just material + type or type alone */
    var matLc=(material||"").toLowerCase();
    if(matLc&&rest.indexOf(matLc)===0)rest=rest.slice(matLc.length).trim();
    var gtLc=(garmentType||"").toLowerCase();
    if(!rest)return true;
    if(rest===gtLc)return true;
    if(tw.indexOf(rest)>=0)return true;
  }
  return false;
}
function smartDefaults(ai){
  var d={};var gt=ai.garmentType;var nm=(ai.name||"").toLowerCase();
  /* Material inference */
  if(gt==="Jeans")d.material="denim";
  else if(gt==="Sweater/Knit"||gt==="Cardigan")d.material="knit";
  else if(gt==="Hoodie"||gt==="Sweatshirt")d.material="fleece";
  else if(gt==="Chinos")d.material="chino";
  else if(nm.includes("suede"))d.material="suede";
  else if(nm.includes("linen"))d.material="linen";
  else if(nm.includes("leather"))d.material="leather";
  else if(nm.includes("canvas"))d.material="canvas";
  else if(nm.includes("corduroy"))d.material="corduroy";
  else if(nm.includes("tweed"))d.material="tweed";
  else if(nm.includes("silk"))d.material="silk";
  else if(nm.includes("wool"))d.material="wool";
  else if(nm.includes("cashmere"))d.material="cashmere";
  else if(nm.includes("fleece"))d.material="fleece";
  else if(nm.includes("denim"))d.material="denim";
  /* Seasons inference */
  if(gt==="Shorts"||gt==="Tank Top")d.seasons=["spring","summer"];
  else if(gt==="Sweater/Knit"||gt==="Jacket/Blazer"||gt==="Cardigan"||gt==="Coat")d.seasons=["fall","winter"];
  else if(gt==="Hoodie"||gt==="Sweatshirt"||gt==="Vest/Gilet"||gt==="Overshirt")d.seasons=["spring","fall","winter"];
  else if(gt==="Jeans")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="Shoes"){d.seasons=["spring","summer","fall","winter"];if(nm.includes("sandal")||nm.includes("espadrille")||nm.includes("flip"))d.seasons=["spring","summer"];else if(nm.includes("boot"))d.seasons=["fall","winter"]}
  else if(gt==="Chinos"||gt==="Pants/Trousers")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="T-Shirt"||gt==="Polo"||gt==="Henley")d.seasons=["spring","summer"];
  else d.seasons=["spring","summer","fall","winter"];
  /* Refine seasons based on inferred material */
  if(d.material==="wool"||d.material==="cashmere"||d.material==="fleece"||d.material==="tweed"||d.material==="corduroy")d.seasons=["fall","winter"];
  else if(d.material==="linen")d.seasons=["spring","summer"];
  return d;
}
const DEFAULT_CX=[
{id:"clinic",l:"Clinic",icon:"üè•"},{id:"smart-casual",l:"Smart Casual",icon:"üëî"},{id:"formal",l:"Formal",icon:"üé©"},
{id:"date",l:"Date",icon:"üåπ"},{id:"riviera",l:"Riviera",icon:"üåä"},{id:"casual",l:"Casual",icon:"‚òÄÔ∏è"},
{id:"weekend",l:"Weekend",icon:"üõí"},{id:"flex",l:"Flex",icon:"üíé"},{id:"travel",l:"Travel",icon:"‚úàÔ∏è"},{id:"event",l:"Event",icon:"üé≠"}];
const SHARE_DEFAULT_CX=[
{id:"office",l:"Office",icon:"üíº"},{id:"smart-casual",l:"Smart Casual",icon:"üëî"},{id:"formal",l:"Formal",icon:"üé©"},
{id:"date",l:"Date",icon:"üåπ"},{id:"riviera",l:"Riviera",icon:"üåä"},{id:"casual",l:"Casual",icon:"‚òÄÔ∏è"},
{id:"weekend",l:"Weekend",icon:"üõí"},{id:"flex",l:"Flex",icon:"üíé"},{id:"travel",l:"Travel",icon:"‚úàÔ∏è"},{id:"event",l:"Event",icon:"üé≠"}];
var ALL_CX=DEFAULT_CX.map(function(c){return c.id});
var CXI={};DEFAULT_CX.forEach(function(c){CXI[c.id]=c.icon});
const CATS={tops:["Shirt","Polo","T-Shirt","Henley","Tank Top","Sweater/Knit","Cardigan","Hoodie","Sweatshirt","Vest/Gilet","Jacket/Blazer","Coat","Overshirt"],bottoms:["Pants/Trousers","Chinos","Jeans","Shorts"],shoes:["Shoes"],accessories:["Hat","Scarf","Belt","Bag","Sunglasses","Accessory"]};
const ALL_T=[...CATS.tops,...CATS.bottoms,...CATS.shoes,...CATS.accessories];
const LAYER_BASE=["Shirt","Polo","T-Shirt","Henley","Tank Top"];
const LAYER_MID=["Sweater/Knit","Cardigan","Hoodie","Sweatshirt","Vest/Gilet"];
const LAYER_OUTER=["Jacket/Blazer","Coat","Overshirt"];
function layerOf(gt){return LAYER_BASE.includes(gt)?"base":LAYER_MID.includes(gt)?"mid":LAYER_OUTER.includes(gt)?"outer":"base"}
const catOf=g=>CATS.tops.includes(g)?"tops":CATS.bottoms.includes(g)?"bottoms":CATS.shoes.includes(g)?"shoes":CATS.accessories.includes(g)?"accessories":"other";
const EMOJIS=["‚åö","‚ùÑÔ∏è","üåø","ü™∑","üî∑","üåô","üíé","üëë","üî¥","üèÅ","‚≠ê","üåç","‚úàÔ∏è","üß≠","üõ©Ô∏è","üçÄ","üîµ","üåä","üç∑","‚óªÔ∏è","üèîÔ∏è","üü¢","‚òÑÔ∏è","üí†","üåª","‚ö´","üî•","üíú","üåë","üî∫","üçá"];
const STRAP_TYPES=[
{id:"bracelet",l:"Bracelet",icon:"‚õìÔ∏è",mats:["steel","titanium","gold","rose gold","ceramic"]},
{id:"leather",l:"Leather",icon:"üîó",mats:["calf leather","alligator","cordovan","suede","shell cordovan","nubuck"]},
{id:"rubber",l:"Rubber",icon:"‚¨õ",mats:["rubber","FKM rubber","silicone"]},
{id:"nato",l:"NATO",icon:"üéóÔ∏è",mats:["nylon"]},
{id:"mesh",l:"Mesh",icon:"üîò",mats:["steel","titanium"]},
{id:"canvas",l:"Canvas",icon:"üìê",mats:["canvas","sailcloth"]},
{id:"perlon",l:"Perlon",icon:"üßµ",mats:["perlon"]}];
const STRAP_COLORS=["black","brown","tan","navy","grey","green","teal","burgundy","blue","white","olive","orange","red","beige"];
/* Strap color ‚Üí hex for visual swatches */
const STRAP_HEX={
"black":"#1a1a1a","brown":"#6a4a2a","tan":"#c8a878","navy":"#1a2a4a","grey":"#8a8a8a",
"green":"#2a6a3a","teal":"#1a8a7a","burgundy":"#6a1a2a","blue":"#2a5a9a","white":"#f0f0ec",
"olive":"#5a6a3a","orange":"#d87a2a","red":"#b83a3a","beige":"#d8c8a8","silver":"#b0b0b0",
"gold":"#c9a84c","rose gold":"#b87a6a","light brown":"#a07848"
};
function strapHex(color){if(!color)return"#8a8a8a";var lc=color.toLowerCase();if(STRAP_HEX[lc])return STRAP_HEX[lc];if(CM[lc])return CM[lc].h;return"#8a8a8a"}
/* Strap swatch: renders a colored dot + type icon for visual identification */
function StrapSwatch(props){
  var st=props.strap;if(!st)return null;
  var hex=st.type==="bracelet"?strapHex(st.color||"silver"):strapHex(st.color);
  var stDef=STRAP_TYPES.find(function(t){return t.id===st.type})||STRAP_TYPES[0];
  var isBracelet=st.type==="bracelet";
  var label=isBracelet?"Bracelet"+(st.material?" ("+st.material+")":""):(st.color||"")+" "+st.type+(st.material&&!isBracelet?" ("+st.material+")":"");
  var sz=props.size||10;
  return React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:4}},
    /* Color swatch ‚Äî gradient ring for bracelet, solid dot for leather/rubber/etc */
    isBracelet?React.createElement("span",{style:{width:sz,height:sz,borderRadius:"50%",background:"linear-gradient(135deg,#c0c0c0,#888,#c0c0c0)",border:"1px solid rgba(255,255,255,0.2)",flexShrink:0}})
    :React.createElement("span",{style:{width:sz,height:sz,borderRadius:"50%",background:hex,border:"1px solid rgba(255,255,255,0.15)",flexShrink:0}}),
    React.createElement("span",null,stDef.icon+" "+label));
}
const STRAP_CTX={
"formal":{bracelet:1,leather:3,rubber:-2,nato:-2,mesh:1,canvas:-2,perlon:-1},
"clinic":{bracelet:2,leather:2,rubber:1,nato:0,mesh:1,canvas:0,perlon:0},
"smart-casual":{bracelet:2,leather:2,rubber:0,nato:0,mesh:1,canvas:0,perlon:0},
"date":{bracelet:1,leather:3,rubber:-1,nato:-1,mesh:1,canvas:-1,perlon:0},
"casual":{bracelet:1,leather:1,rubber:1,nato:1,mesh:1,canvas:1,perlon:1},
"weekend":{bracelet:1,leather:0,rubber:1,nato:2,mesh:0,canvas:1,perlon:1},
"riviera":{bracelet:2,leather:-1,rubber:3,nato:2,mesh:1,canvas:1,perlon:1},
"travel":{bracelet:1,leather:0,rubber:2,nato:2,mesh:0,canvas:1,perlon:1},
"event":{bracelet:1,leather:3,rubber:-2,nato:-2,mesh:1,canvas:-2,perlon:0},
"flex":{bracelet:2,leather:1,rubber:0,nato:0,mesh:1,canvas:0,perlon:0},
"office":{bracelet:1,leather:2,rubber:-1,nato:-1,mesh:1,canvas:-1,perlon:0}
};
const STS=[{id:"active",l:"Active",c:"var(--good)"},{id:"incoming",l:"Incoming",c:"#7ab8d8"},{id:"pending-trade",l:"Pending",c:"var(--warn)"},{id:"sold",l:"Sold",c:"var(--dim)"},{id:"service",l:"Service",c:"#b87ab8"}];
const WT_TIERS=[
{max:5,label:"Freezing",icon:"ü•∂",weight:"heavy",advice:"Heavy layers. Leather straps stay warm."},
{max:12,label:"Cold",icon:"üß•",weight:"heavy",advice:"Layer up: jacket + sweater."},
{max:18,label:"Cool",icon:"üß£",weight:"mid",advice:"Light jacket or sweater."},
{max:24,label:"Mild",icon:"üëî",weight:"mid",advice:"Shirt sleeves or light knit."},
{max:30,label:"Warm",icon:"‚òÄÔ∏è",weight:"light",advice:"Light fabrics. Bracelets/rubber > leather."},
{max:50,label:"Hot",icon:"üî•",weight:"light",advice:"Steel bracelets or rubber only."},
];
const getWT=t=>WT_TIERS.find(x=>t<=x.max)||WT_TIERS[5];
/* WMO Weather Code decoder */
const WMO={0:{i:"‚òÄÔ∏è",l:"Clear",rain:false},1:{i:"üå§Ô∏è",l:"Mostly Clear",rain:false},2:{i:"‚õÖ",l:"Partly Cloudy",rain:false},3:{i:"‚òÅÔ∏è",l:"Overcast",rain:false},
45:{i:"üå´Ô∏è",l:"Fog",rain:false},48:{i:"üå´Ô∏è",l:"Rime Fog",rain:false},
51:{i:"üå¶Ô∏è",l:"Light Drizzle",rain:true},53:{i:"üå¶Ô∏è",l:"Drizzle",rain:true},55:{i:"üåßÔ∏è",l:"Heavy Drizzle",rain:true},
56:{i:"üåßÔ∏è",l:"Freezing Drizzle",rain:true},57:{i:"üåßÔ∏è",l:"Heavy Frzg Drizzle",rain:true},
61:{i:"üå¶Ô∏è",l:"Light Rain",rain:true},63:{i:"üåßÔ∏è",l:"Rain",rain:true},65:{i:"üåßÔ∏è",l:"Heavy Rain",rain:true},
66:{i:"üßä",l:"Freezing Rain",rain:true},67:{i:"üßä",l:"Heavy Frzg Rain",rain:true},
71:{i:"üå®Ô∏è",l:"Light Snow",rain:false},73:{i:"üå®Ô∏è",l:"Snow",rain:false},75:{i:"‚ùÑÔ∏è",l:"Heavy Snow",rain:false},
77:{i:"üå®Ô∏è",l:"Snow Grains",rain:false},
80:{i:"üå¶Ô∏è",l:"Light Showers",rain:true},81:{i:"üåßÔ∏è",l:"Showers",rain:true},82:{i:"‚õàÔ∏è",l:"Heavy Showers",rain:true},
85:{i:"üå®Ô∏è",l:"Snow Showers",rain:false},86:{i:"‚ùÑÔ∏è",l:"Heavy Snow Showers",rain:false},
95:{i:"‚õàÔ∏è",l:"Thunderstorm",rain:true},96:{i:"‚õàÔ∏è",l:"T-Storm + Hail",rain:true},99:{i:"‚õàÔ∏è",l:"T-Storm + Heavy Hail",rain:true}};
const getWMO=c=>WMO[c]||{i:"‚ùì",l:"Unknown",rain:false};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARED MODE PRESETS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WATCH_PRESETS=[
{id:"p-aw",n:"Apple Watch",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"‚åö",mc:["black","grey","navy","white","charcoal"],ac:[],cx:["casual","weekend","clinic","travel"],wt:["light","mid","heavy"]},
{id:"p-gshock",n:"G-Shock",d:"Black",c:"#2a2a2a",br:true,sc:[],mt:"cool",i:"üí™",mc:["black","olive","navy","grey","khaki"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
{id:"p-seiko5",n:"Seiko 5",d:"Blue",c:"#2a5a9a",br:true,sc:[],mt:"cool",i:"üîµ",mc:["navy","white","cream","grey","light blue"],ac:[],cx:["casual","smart-casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-sub",n:"Submariner-style",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"ü§ø",mc:["black","navy","white","grey","olive"],ac:[],cx:["casual","smart-casual","weekend","riviera","travel"],wt:["light","mid","heavy"]},
{id:"p-tank",n:"Tank-style",d:"White",c:"#f0f0ec",br:false,sc:["black"],mt:"cool",i:"üèõÔ∏è",mc:["white","charcoal","navy","cream","black"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-chrono",n:"Chronograph",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"‚è±Ô∏è",mc:["black","navy","white","grey","charcoal"],ac:[],cx:["smart-casual","casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-dress",n:"Dress Watch",d:"White",c:"#f5f0e8",br:false,sc:["brown"],mt:"warm",i:"üëî",mc:["cream","white","charcoal","navy","tan","burgundy"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-field",n:"Field Watch",d:"Green",c:"#3a5a3a",br:false,sc:["brown","olive"],mt:"cool",i:"üß≠",mc:["olive","khaki","cream","brown","tan","navy"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
];
const GARMENT_PRESETS=[
{garmentType:"Shirt",name:"White Shirt",color:"white",pattern:"solid"},
{garmentType:"Shirt",name:"Light Blue Shirt",color:"light blue",pattern:"solid"},
{garmentType:"T-Shirt",name:"Black T-Shirt",color:"black",pattern:"solid"},
{garmentType:"T-Shirt",name:"Grey T-Shirt",color:"grey",pattern:"solid"},
{garmentType:"T-Shirt",name:"Navy T-Shirt",color:"navy",pattern:"solid"},
{garmentType:"T-Shirt",name:"White T-Shirt",color:"white",pattern:"solid"},
{garmentType:"Chinos",name:"Navy Chinos",color:"navy",pattern:"solid"},
{garmentType:"Chinos",name:"Khaki Chinos",color:"khaki",pattern:"solid"},
{garmentType:"Chinos",name:"Charcoal Chinos",color:"charcoal",pattern:"solid"},
{garmentType:"Jeans",name:"Blue Jeans",color:"denim",pattern:"solid"},
{garmentType:"Jeans",name:"Black Jeans",color:"black",pattern:"solid"},
{garmentType:"Shorts",name:"Navy Shorts",color:"navy",pattern:"solid"},
{garmentType:"Shorts",name:"Khaki Shorts",color:"khaki",pattern:"solid"},
{garmentType:"Shoes",name:"White Sneakers",color:"white",pattern:"solid"},
{garmentType:"Shoes",name:"Black Shoes",color:"black",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Shoes",color:"brown",pattern:"solid"},
{garmentType:"Polo",name:"Navy Polo",color:"navy",pattern:"solid"},
{garmentType:"Polo",name:"White Polo",color:"white",pattern:"solid"},
{garmentType:"Sweater/Knit",name:"Grey Sweater",color:"grey",pattern:"solid"},
{garmentType:"Jacket/Blazer",name:"Navy Blazer",color:"navy",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Lace-ups",color:"brown",pattern:"solid"},
{garmentType:"Hoodie",name:"Grey Hoodie",color:"grey",pattern:"solid"},
{garmentType:"Hoodie",name:"Black Hoodie",color:"black",pattern:"solid"},
{garmentType:"Cardigan",name:"Navy Cardigan",color:"navy",pattern:"solid"},
{garmentType:"Cardigan",name:"Grey Cardigan",color:"grey",pattern:"solid"},
{garmentType:"Vest/Gilet",name:"Navy Vest",color:"navy",pattern:"solid"},
{garmentType:"Henley",name:"White Henley",color:"white",pattern:"solid"},
{garmentType:"Henley",name:"Grey Henley",color:"grey",pattern:"solid"},
{garmentType:"Coat",name:"Charcoal Coat",color:"charcoal",pattern:"solid"},
{garmentType:"Coat",name:"Navy Coat",color:"navy",pattern:"solid"},
{garmentType:"Overshirt",name:"Olive Overshirt",color:"olive",pattern:"solid"},
{garmentType:"Sweatshirt",name:"Grey Sweatshirt",color:"grey",pattern:"solid"},
{garmentType:"Tank Top",name:"White Tank Top",color:"white",pattern:"solid"},
];
function autoMatchColors(dialColor){
  var dc=(dialColor||"").toLowerCase().trim();
  var key=Object.keys(CP).find(function(k){return dc.includes(k)||k.includes(dc)});
  if(key)return CP[key].slice(0,8);
  return["white","cream","navy","charcoal","grey","black","tan","light blue"];
}

const _OWNER_DEFAULTS=[
{id:"snowflake",n:"GS Snowflake",t:"genuine",d:"Silver-White",c:"#c8d0d8",straps:[
  {type:"leather",color:"grey",material:"alligator",source:"Gentry Tao",buckle:"GS script pin"},
  {type:"leather",color:"navy",material:"alligator",source:"DayDayWatchband",buckle:"deployant",notes:"Blue contrast stitch, 19‚Üí18mm taper"}
],mt:"cool",i:"‚ùÑÔ∏è",mc:["grey","navy","white","light blue","charcoal","silver","lavender","slate"],ac:["orange","red"],cx:["clinic","formal","smart-casual"],sg:"Grey‚Üídark shoes. Navy‚Üínavy outfits.",wt:["light","mid","heavy"],active:true,status:"active",ref:"SBGA211",size:41,lug:19,mvmt:"Spring Drive 9R65"},
{id:"rikka",n:"GS Rikka",t:"genuine",d:"Green",c:"#5a8a6a",straps:[
  {type:"leather",color:"teal",material:"alligator",source:"Gentry Tao",buckle:"Seiko script pin"},
  {type:"leather",color:"brown",material:"calf leather",buckle:"pin"}
],mt:"cool",i:"üåø",mc:["cream","ivory","sage","olive","teal","khaki","tan","forest green","white"],ac:["black","bright red"],cx:["smart-casual","date","weekend"],sg:"Teal‚Üíbrown shoes. Brown leather‚Üísmart casual.",wt:["light","mid"],active:true,status:"active",ref:"SBGH351",size:40,lug:21,mvmt:"Hi-Beat 36000 9S85"},
{id:"sbgw267",n:"GS SBGW267",t:"genuine",d:"Ivory",c:"#f5f0e8",straps:[
  {type:"leather",color:"burgundy",material:"alligator",source:"Gentry Tao",buckle:"GS script pin",notes:"Reads purple/magenta, not true oxblood"},
  {type:"leather",color:"burgundy",material:"alligator",source:"DayDayWatchband",buckle:"pin",notes:"Redundant with Gentry Tao ‚Äî both read purple"},
  {type:"leather",color:"tan",material:"calf leather",buckle:"pin",notes:"Honey tone, white contrast stitch"}
],mt:"warm",i:"ü™∑",mc:["burgundy","plum","cream","mauve","ivory","charcoal","wine","tan","honey"],ac:["cobalt","neon"],cx:["formal","date","clinic","smart-casual"],sg:"Purple straps‚Üíoxblood shoes. Tan‚Üíbrown Ecco lace-ups.",wt:["mid","heavy"],active:true,status:"active",ref:"SBGW267",size:37.3,lug:19,mvmt:"Manual 9S64"},
{id:"laureato",n:"GP Laureato",t:"genuine",d:"Blue",c:"#2a5a9a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"üî∑",mc:["white","cream","light grey","navy","cobalt","light blue","silver"],ac:["brown","olive"],cx:["riviera","smart-casual","flex","date"],sg:"Integrated bracelet only.",wt:["light","mid"],active:true,status:"active",ref:"81010",size:42,mvmt:"GP03300"},
{id:"reverso",n:"JLC Reverso",t:"genuine",d:"Navy",c:"#1a2a4a",straps:[
  {type:"leather",color:"navy",material:"alligator",buckle:"deployant"}
],mt:"cool",i:"üåô",mc:["white","charcoal","navy","dark grey","silver"],ac:["casual"],cx:["formal","clinic","event"],sg:"Navy‚Üíblack/dark brown shoes.",wt:["mid","heavy"],active:true,status:"active",ref:"216.8.D3",size:42,mvmt:"Cal 986"},
{id:"santos-lg",n:"Santos Large",t:"genuine",d:"White/Gold",c:"#d4af37",straps:[
  {type:"bracelet",color:"silver",material:"steel",notes:"QuickSwitch"},
  {type:"leather",color:"brown",material:"calfskin",source:"Cartier OEM",buckle:"QuickSwitch deployant"}
],mt:"mixed",i:"üíé",mc:["cream","white","light blue","tan","black","navy","gold"],ac:["neon"],cx:["clinic","smart-casual","date","riviera","flex"],sg:"Two-tone. QuickSwitch bracelet + brown calfskin. Most versatile.",wt:["light","mid","heavy"],active:true,status:"active",ref:"W2SA0009",size:39.8,mvmt:"1847MC"},
{id:"santos-oct",n:"Santos Octagon YG",t:"genuine",d:"White",c:"#c5a03a",straps:[
  {type:"leather",color:"brown",material:"alligator",buckle:"deployant",notes:"Brown alligator, stainless deployant, cream lining"}
],mt:"warm",i:"üëë",mc:["cream","tan","camel","chocolate","ivory","gold","brown"],ac:["grey","navy","silver"],cx:["formal","date","flex"],sg:"Brown shoes mandatory.",wt:["mid","heavy"],active:true,status:"active",ref:"Vintage 1980s",size:29,mvmt:"Quartz"},
{id:"bb41",n:"Tudor BB41",t:"genuine",d:"Black/Red",c:"#8b1a1a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Tudor OEM",notes:"Five-link"},
  {type:"leather",color:"brown",material:"distressed leather",source:"Tudor OEM",buckle:"Tudor deployant",notes:"Rough-out finish, ecru stitching. Via Speedmaster trade."},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin",notes:"White stitch, 22/22mm straight. Dressy/clinic."}
],mt:"cool",i:"üî¥",mc:["black","grey","white","charcoal","dark green","navy","olive","rust","brown","tan"],ac:["pastel"],cx:["casual","weekend","smart-casual"],sg:"Bracelet default. Brown strap‚Üíbrown shoes, warm tones. Black strap‚Üíclinic/dressy.",wt:["light","mid","heavy"],active:true,status:"active",ref:"7941A1A0RU",size:41,lug:22,mvmt:"MT5400 METAS"},
{id:"monaco",n:"TAG Monaco",t:"genuine",d:"Black",c:"#1a1a1a",straps:[
  {type:"leather",color:"black",material:"calf leather",buckle:"pin"}
],mt:"cool",i:"üèÅ",mc:["black","charcoal","white","navy"],ac:["brown","warm"],cx:["smart-casual","date","weekend"],sg:"Black shoes ONLY.",wt:["mid","heavy"],active:true,status:"active",ref:"CW2111",size:39,mvmt:"ETA 2894-2"},
{id:"gmt",n:"Rolex GMT-II",t:"genuine",d:"Black",c:"#2a2a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Rolex OEM"}
],mt:"cool",i:"üåç",mc:["black","navy","grey","white","olive"],ac:[],cx:["casual","travel","smart-casual"],sg:"PENDING TRADE‚ÜíAlpine Eagle 8HF.",wt:["light","mid","heavy"],active:true,status:"pending-trade",ref:"116710LN",size:40,mvmt:"Cal 3186"},
{id:"alpine-8hf",n:"Chopard Alpine Eagle 8HF",t:"genuine",d:"Blue-Grey",c:"#5a6a7a",straps:[
  {type:"bracelet",color:"silver",material:"titanium"}
],mt:"cool",i:"üèîÔ∏è",mc:["grey","navy","white","light blue","charcoal","silver","cream","slate"],ac:["orange","bright red"],cx:["clinic","smart-casual","date","flex","riviera"],sg:"GPHG Sports Watch. 8Hz movement. Replaces GMT-II.",wt:["light","mid","heavy"],active:false,status:"incoming",ref:"298600-3005",size:41,mvmt:"L.U.C 01.12-C 8Hz"},
{id:"hanhart",n:"Hanhart Pioneer",t:"genuine",d:"White/Teal",c:"#3a8a8a",straps:[
  {type:"leather",color:"teal",material:"leather",source:"Hanhart OEM",notes:"Yellow lining, statement"},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin"},
  {type:"leather",color:"light brown",material:"calf leather",buckle:"pin"},
  {type:"leather",color:"green",material:"suede",buckle:"pin",notes:"Dark green rough-out, tan lining. Textured casual."},
  {type:"leather",color:"olive",material:"full grain leather",buckle:"pin",notes:"Sage/olive chunky, cream stitch. Field/military."},
  {type:"canvas",color:"grey",material:"canvas",buckle:"bronze pin",notes:"Grey woven canvas. Vintage tool watch vibe."}
],mt:"cool",i:"‚úàÔ∏è",mc:["teal","cream","sage","white","burnt orange","olive","khaki","tan","black","grey"],ac:["formal"],cx:["casual","weekend","riviera","smart-casual"],sg:"Teal‚Üístatement. Black‚Üíversatile. Light brown‚Üíbrown Eccos. Green suede‚Üífield. Olive‚Üímilitary. Canvas‚Üívintage.",wt:["light","mid"],active:true,status:"active",ref:"417 ES",size:39,mvmt:"Flyback chronograph"},
{id:"laco",n:"Laco Flieger",t:"genuine",d:"Black",c:"#3a3a3a",straps:[
  {type:"leather",color:"brown",material:"distressed leather",buckle:"pin",notes:"Pilot style, aged"}
],mt:"cool",i:"üõ©Ô∏è",mc:["olive","brown","dark green","grey","khaki","tan"],ac:["silk","suits"],cx:["casual","weekend"],sg:"Rugged only.",wt:["mid","heavy"],active:true,status:"active",ref:"Type B",size:42,mvmt:"Manual wind"},
{id:"speedy",n:"Omega Speedmaster 3861",t:"genuine",d:"Black",c:"#1a1a1a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Omega OEM"},
  {type:"leather",color:"teal",material:"Buttero Italian veg-tanned",buckle:"pin",notes:"Dark teal, cream stitch. Statement."},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin",notes:"Orange lining, white stitch. NASA heritage nod."},
  {type:"rubber",color:"navy",material:"leather/rubber hybrid",buckle:"pin",notes:"White stitch. Clinic/smart casual."},
  {type:"rubber",color:"white",material:"rubber",buckle:"pin",notes:"Perforated rally-style. Summer statement."},
  {type:"canvas",color:"navy",material:"canvas",buckle:"gold pin",notes:"Dark navy, gold stitch/buckle. Unconventional warm accent."},
  {type:"leather",color:"black",material:"grained leather",buckle:"gold butterfly deployant",notes:"Gold hardware on steel ‚Äî intentional warm accent."},
  {type:"leather",color:"tan",material:"calf leather",buckle:"pin",notes:"Tan/honey, 20‚Üí18mm taper. Brown shoe pairing."},
  {type:"nato",color:"navy",material:"nylon",notes:"Navy/white/orange striped. Regatta casual."}
],mt:"neutral",i:"üåë",mc:["black","navy","white","grey","charcoal","cream","olive","denim","burgundy"],ac:[],cx:["clinic","smart-casual","casual","date","flex","weekend","travel","event"],sg:"Moonwatch. 9 strap options. Most versatile watch in collection.",wt:["mid","heavy"],active:true,status:"active",ref:"310.30.42.50.01.001",size:42,lug:20,mvmt:"Cal 3861 manual"},
{id:"iwc-perp",n:"IWC Perpetual",t:"replica",d:"Blue",c:"#1a3a7a",straps:[
  {type:"leather",color:"blue",material:"alligator",buckle:"deployant"}
],mt:"cool",i:"üîµ",mc:["navy","charcoal","white","silver"],ac:["casual"],cx:["formal","date","flex"],sg:"Dark shoes only.",wt:["mid","heavy"],active:true,status:"active",size:42},
{id:"iwc-ing",n:"IWC Ingenieur",t:"replica",d:"Teal",c:"#1a8a7a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"üåä",mc:["teal","cream","white","sage","turquoise","mint"],ac:["dark heavy"],cx:["riviera","smart-casual","flex"],sg:"Summer coastal.",wt:["light"],active:true,status:"active",size:40},
{id:"vc-perp",n:"VC Overseas Perp",t:"replica",d:"Burgundy",c:"#6a1a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"üç∑",mc:["burgundy","cream","plum","black","ivory","charcoal","wine"],ac:["cobalt"],cx:["date","formal","flex"],sg:"Fills burgundy gap.",wt:["mid","heavy"],active:true,status:"active",size:41.5},
{id:"santos-rep",n:"Santos 35mm",t:"replica",d:"White",c:"#e0d8c8",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"‚óªÔ∏è",mc:["white","light blue","cream","grey"],ac:[],cx:["clinic","smart-casual"],sg:"Universal.",wt:["light","mid"],active:true,status:"active",size:35},
{id:"alpine-red",n:"Chopard Alpine",t:"replica",d:"Red",c:"#b83a3a",straps:[
  {type:"bracelet",color:"rose gold",material:"steel"}
],mt:"warm",i:"üî∫",mc:["black","cream","burgundy","charcoal","white"],ac:["cool blues"],cx:["date","flex","riviera"],sg:"Rose gold. Black anchors.",wt:["light","mid"],active:true,status:"active",size:41},
{id:"ap-roc",n:"AP Royal Oak",t:"replica",d:"Green",c:"#1a5a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"üü¢",mc:["dark green","cream","white","olive","black","navy"],ac:["close greens"],cx:["smart-casual","flex","date"],sg:"Dark makes green pop.",wt:["mid","heavy"],active:true,status:"active",size:41},
{id:"gmt-met",n:"GMT Meteorite",t:"replica",d:"Meteorite",c:"#6a6a6a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"‚òÑÔ∏è",mc:["grey","silver","charcoal","white","black"],ac:["warm earth"],cx:["flex","date"],sg:"Cool monochrome.",wt:["mid","heavy"],active:true,status:"active",size:40},
{id:"dd-turq",n:"Day-Date Turq",t:"replica",d:"Turquoise",c:"#2ab8a8",straps:[
  {type:"bracelet",color:"rose gold",material:"steel"}
],mt:"warm",i:"üí†",mc:["white","cream","turquoise","tan","light blue","sand"],ac:["dark formal"],cx:["riviera","flex","date"],sg:"Pure summer.",wt:["light"],active:true,status:"active",size:36},
{id:"op-grape",n:"Rolex OP Grape",t:"replica",d:"Purple",c:"#6a3d7d",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"üçá",mc:["navy","white","cream","grey","charcoal","light blue","olive","tan","lavender"],ac:["orange","bright red"],cx:["casual","weekend","smart-casual","date","riviera"],sg:"Purple/grape dial. Bold statement.",wt:["light","mid"],active:true,status:"active",size:36},
{id:"breguet",n:"Breguet Tradition",t:"replica",d:"Black",c:"#0a0a0a",straps:[
  {type:"leather",color:"black",material:"alligator",buckle:"pin"}
],mt:"cool",i:"‚ö´",mc:["black","charcoal","white"],ac:["color","casual"],cx:["formal","date"],sg:"Black shoes only.",wt:["mid","heavy"],active:true,status:"active",size:40},
];
function migrateStraps(w){
  if(w.straps&&w.straps.length){
    var o=Object.assign({},w);
    o.br=o.straps.some(function(s){return s.type==="bracelet"});
    o.sc=o.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color});
    return o;
  }
  var straps=[];
  if(w.br)straps.push({type:"bracelet",color:"silver",material:"steel"});
  if(w.sc&&w.sc.length)w.sc.forEach(function(c){straps.push({type:"leather",color:c,material:"calf leather"})});
  if(!straps.length)straps.push({type:"bracelet",color:"silver",material:"steel"});
  return Object.assign({},w,{straps:straps});
}
const DEFAULTS=IS_SHARED?[]:_OWNER_DEFAULTS.map(migrateStraps);
const _OWNER_WARDROBE=[
{id:"ow-blazer-camel",garmentType:"Jacket/Blazer",name:"Camel Wool Blazer",color:"camel",pattern:"solid",active:true,ts:1},
{id:"ow-hoodie-grey",garmentType:"Sweater/Knit",name:"Grey Zip Hoodie",color:"grey",pattern:"solid",active:true,ts:2},
{id:"ow-sweater-ltblue",garmentType:"Sweater/Knit",name:"Light Blue Cable Sweater",color:"light blue",pattern:"textured",active:true,ts:3},
{id:"ow-sweater-black",garmentType:"Sweater/Knit",name:"Black Cable Knit Sweater",color:"black",pattern:"textured",active:true,ts:4},
{id:"ow-coat-camel",garmentType:"Jacket/Blazer",name:"Camel Wool Coat",color:"camel",pattern:"solid",active:true,ts:5},
{id:"ow-shirt-plaid-brown",garmentType:"Shirt",name:"Plaid Button Down Shirt",color:"brown",pattern:"plaid",active:true,ts:6},
{id:"ow-shirt-plaid-blue",garmentType:"Shirt",name:"Blue Plaid Flannel Shirt",color:"blue",pattern:"plaid",active:true,ts:7},
{id:"ow-cardigan-beige",garmentType:"Sweater/Knit",name:"Beige Ribbed Cardigan",color:"beige",pattern:"textured",active:true,ts:8},
{id:"ow-shirt-stripe",garmentType:"Shirt",name:"Striped Button-Up Shirt",color:"cream",pattern:"striped",active:true,ts:9},
{id:"ow-shirt-dot-blue",garmentType:"Shirt",name:"Blue Dotted Dress Shirt",color:"blue",pattern:"print",active:true,ts:10},
{id:"ow-shirt-plaid-multi",garmentType:"Shirt",name:"Multicolor Plaid Flannel Shirt",color:"cream",pattern:"plaid",active:true,ts:11},
{id:"ow-cardigan-grey",garmentType:"Jacket/Blazer",name:"Light Grey Knit Cardigan",color:"light grey",pattern:"textured",active:true,ts:12},
{id:"ow-shirt-dot-cream",garmentType:"Shirt",name:"Cream Dotted Button Shirt",color:"cream",pattern:"print",active:true,ts:13},
{id:"ow-jeans-dist",garmentType:"Jeans",name:"Distressed Blue Jeans",color:"denim",pattern:"solid",active:true,ts:14},
{id:"ow-jeans-light",garmentType:"Jeans",name:"Light Wash Denim Jeans",color:"denim",pattern:"solid",active:true,ts:15},
/* ‚îÄ‚îÄ ESSENTIALS (photograph these to add photos) ‚îÄ‚îÄ */
{id:"ow-shoe-ecco",garmentType:"Shoes",name:"Brown Ecco Lace-ups",color:"brown",pattern:"solid",active:true,ts:16},
{id:"ow-shoe-white",garmentType:"Shoes",name:"White Sneakers",color:"white",pattern:"solid",active:true,ts:17},
{id:"ow-shoe-formal",garmentType:"Shoes",name:"Formal Black Shoes",color:"black",pattern:"solid",active:true,ts:18}
];
const WD_DEFAULTS=IS_SHARED?[]:_OWNER_WARDROBE;

/* ‚ïê‚ïê‚ïê MARKDOWN WATCH LOG PARSER ‚ïê‚ïê‚ïê */
function parseWatchLog(mdText, existingWatches){
  var lines=mdText.split("\n");
  var watches=[];
  var strapMap={};/* watchName -> straps[] */
  var section="";var subSection="";
  
  /* --- Phase 1: Parse watch tables --- */
  var genuineSection=false,replicaSection=false,strapSection=false,pendingSection=false;
  var currentStrapWatch="";
  
  for(var li=0;li<lines.length;li++){
    var line=lines[li].trim();
    
    /* Detect sections */
    if(line.match(/^###?\s+Genuine/i)){genuineSection=true;replicaSection=false;strapSection=false;pendingSection=false;continue}
    if(line.match(/^###?\s+Replica/i)){genuineSection=false;replicaSection=true;strapSection=false;pendingSection=false;continue}
    if(line.match(/^###?\s+Pending/i)){genuineSection=false;replicaSection=false;strapSection=false;pendingSection=true;continue}
    if(line.match(/^##\s+Strap Inventory/i)){genuineSection=false;replicaSection=false;strapSection=true;pendingSection=false;continue}
    if(line.match(/^##\s+(Wishlist|Passed|Traded|Collection by|Dial Color|Trade Summary|Watch Pref|Collection Gap|Strap Sizing|Strap Orders)/i)){strapSection=false;genuineSection=false;replicaSection=false;pendingSection=false;continue}
    
    /* Parse strap sub-sections */
    if(strapSection&&line.match(/^###\s+/)){
      currentStrapWatch=line.replace(/^###\s+/,"").replace(/\s*\([^)]*\)/g,"").trim();
      continue;
    }
    
    /* Parse table rows */
    if(!line.startsWith("|")||line.match(/^\|[-\s|]+$/)||line.match(/^\|\s*Watch\s*\|/i)||line.match(/^\|\s*Strap\s*\|/i)||line.match(/^\|\s*Specification/i)||line.match(/^\|\s*Gap/i)||line.match(/^\|\s*Color/i))continue;
    
    var cells=line.split("|").map(function(c){return c.trim()}).filter(Boolean);
    if(cells.length<2)continue;
    
    /* Genuine watches */
    if(genuineSection&&cells.length>=2){
      var name=cells[0];var details=cells[1]||"";
      var status="active";
      if(details.match(/PENDING TRADE|TRADING TOMORROW/i))status="pending-trade";
      if(details.match(/INCOMING/i))status="incoming";
      var dial=inferDial(name,details);
      var w={id:"md-"+slugify(name),n:name,t:"genuine",d:dial.color,c:dial.hex,br:false,sc:[],mt:dial.temp,i:dial.emoji,mc:autoMatchColors(dial.color),ac:[],cx:inferContexts(name,details),wt:[],sg:[],active:status!=="pending-trade",status:status,size:inferSize(details),ref:inferRef(details)};
      watches.push(w);
    }
    
    /* Replica watches */
    if(replicaSection&&cells.length>=2){
      var rName=cells[0];var rDetails=cells[1]||"";var rStatus=cells[2]||"";
      var st="active";
      if(rStatus.match(/INCOMING/i))st="incoming";
      var rd=inferDial(rName,rDetails);
      var rw={id:"md-"+slugify(rName),n:rName,t:"replica",d:rd.color,c:rd.hex,br:true,sc:[],mt:rd.temp,i:rd.emoji,mc:autoMatchColors(rd.color),ac:[],cx:inferContexts(rName,rDetails),wt:[],sg:[],active:true,status:st,size:inferSize(rDetails)};
      /* Detect bracelet vs strap from details */
      if(rDetails.match(/integrated|bracelet|steel/i))rw.br=true;
      watches.push(rw);
    }
    
    /* Pending acquisitions */
    if(pendingSection&&cells.length>=2){
      var pName=cells[0];var pStatus=cells[1]||"";var pDetails=cells[2]||"";
      var pd=inferDial(pName,pDetails);
      var pw={id:"md-"+slugify(pName),n:pName,t:"genuine",d:pd.color,c:pd.hex,br:true,sc:[],mt:pd.temp,i:pd.emoji,mc:autoMatchColors(pd.color),ac:[],cx:inferContexts(pName,pDetails),wt:[],sg:[],active:false,status:pStatus.match(/INCOMING/i)?"incoming":"pending-trade",size:inferSize(pDetails)};
      watches.push(pw);
    }
    
    /* Strap inventory rows */
    if(strapSection&&currentStrapWatch&&cells.length>=4){
      var strapDesc=cells[0];var source=cells[1]||"";var buckle=cells[2]||"";var useCase=cells[3]||"";
      var strap=parseStrapDesc(strapDesc,source);
      if(!strapMap[currentStrapWatch])strapMap[currentStrapWatch]=[];
      strapMap[currentStrapWatch].push(strap);
    }
  }
  
  /* --- Phase 2: Merge straps into watches --- */
  Object.keys(strapMap).forEach(function(strapWatchName){
    var straps=strapMap[strapWatchName];
    /* Try exact name match first, then best substring, then fuzzy */
    var matchW=watches.find(function(w){return w.n.toLowerCase()===strapWatchName.toLowerCase()});
    if(!matchW){var subs=watches.filter(function(w){var wl=w.n.toLowerCase(),sl=strapWatchName.toLowerCase();var isSubstr=sl.includes(wl)||wl.includes(sl);if(!isSubstr)return false;var shorter=Math.min(wl.length,sl.length),longer=Math.max(wl.length,sl.length);return shorter/longer>=0.5});if(subs.length)matchW=subs.reduce(function(a,b){return a.n.length>b.n.length?a:b})}
    if(!matchW)matchW=watches.find(function(w){return fuzzyMatch(w.n,strapWatchName)});
    if(matchW){
      matchW.straps=straps;
      matchW.br=straps.some(function(s){return s.type==="bracelet"});
      matchW.sc=straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color});
    }
  });
  
  /* --- Phase 3: Detect bracelet watches without explicit straps --- */
  watches.forEach(function(w){
    if(!w.straps||!w.straps.length){
      if(w.br)w.straps=[{type:"bracelet",color:"silver",material:"steel"}];
      else if(w.sc&&w.sc.length)w.straps=w.sc.map(function(c){return{type:"leather",color:c,material:"calf leather"}});
      else w.straps=[{type:"bracelet",color:"silver",material:"steel"}];
    }
  });
  
  /* --- Phase 4: Merge with existing watches --- */
  if(existingWatches&&existingWatches.length){
    watches=watches.map(function(nw){
      var existing=existingWatches.find(function(ew){return fuzzyMatch(ew.n,nw.n)||ew.id===nw.id});
      if(existing){
        /* Preserve user customizations, update from markdown */
        return Object.assign({},existing,{
          status:nw.status,active:nw.active,
          straps:nw.straps&&nw.straps.length>1?nw.straps:existing.straps,
          br:nw.straps?nw.straps.some(function(s){return s.type==="bracelet"}):existing.br,
          sc:nw.straps?nw.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color}):existing.sc
        });
      }
      return nw;
    });
    /* Add existing watches not in markdown */
    existingWatches.forEach(function(ew){
      if(!watches.find(function(w){return fuzzyMatch(w.n,ew.n)||w.id===ew.id})){
        watches.push(ew);
      }
    });
  }
  
  return watches.map(migrateStraps);
}

/* Helper: slugify name to ID */
function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").slice(0,40)}

/* Helper: fuzzy match watch names */
function fuzzyMatch(a,b){
  if(!a||!b)return false;
  var na=a.toLowerCase().replace(/[^a-z0-9]/g,"");
  var nb=b.toLowerCase().replace(/[^a-z0-9]/g,"");
  if(na===nb)return true;
  if(na.includes(nb)||nb.includes(na))return true;
  /* Token overlap */
  var ta=a.toLowerCase().split(/[\s-]+/).filter(function(t){return t.length>2});
  var tb=b.toLowerCase().split(/[\s-]+/).filter(function(t){return t.length>2});
  var overlap=ta.filter(function(t){return tb.some(function(u){return u.includes(t)||t.includes(u)})}).length;
  return(overlap>=2&&overlap/Math.max(ta.length,tb.length)>=0.6)||(overlap>=1&&Math.min(ta.length,tb.length)<=2&&Math.max(ta.length,tb.length)<=3);
}

/* Helper: infer dial color from name/details */
function inferDial(name,details){
  var text=(name+" "+details).toLowerCase();
  var dialMap=[
    {k:["snowflake","silver-white","silvery"],color:"Silver-White",hex:"#c8d0d8",temp:"cool",emoji:"‚ùÑÔ∏è"},
    {k:["rikka","lighter green"],color:"Green",hex:"#5a8a6a",temp:"cool",emoji:"üåø"},
    {k:["ivory","sbgw267"],color:"Ivory",hex:"#f5f0e8",temp:"warm",emoji:"ü™∑"},
    {k:["blue hobnail","laureato"],color:"Blue",hex:"#2a5a9a",temp:"cool",emoji:"üî∑"},
    {k:["reverso","navy blue"],color:"Navy",hex:"#1a2a4a",temp:"cool",emoji:"üåô"},
    {k:["meteorite"],color:"Meteorite",hex:"#6a6a7a",temp:"cool",emoji:"‚òÑÔ∏è"},
    {k:["turquoise","teal"],color:"Turquoise",hex:"#1a8a7a",temp:"cool",emoji:"üíé"},
    {k:["burgundy","oxblood","wine","red dial"],color:"Burgundy",hex:"#6a1a2a",temp:"warm",emoji:"üç∑"},
    {k:["purple","grape"],color:"Purple",hex:"#6a3a7a",temp:"cool",emoji:"üçá"},
    {k:["anthracite","grey dial"],color:"Anthracite",hex:"#5a6a7a",temp:"cool",emoji:"üèîÔ∏è"},
    {k:["rose gold","red dial","rose"],color:"Red/Rose",hex:"#b04040",temp:"warm",emoji:"üåπ"},
    {k:["green dial"],color:"Green",hex:"#2a5a3a",temp:"cool",emoji:"üçÄ"},
    {k:["black dial","black chronograph","black,"],color:"Black",hex:"#1a1a1a",temp:"cool",emoji:"‚ö´"},
    {k:["white dial","white,"],color:"White",hex:"#f0f0ec",temp:"neutral",emoji:"‚ö™"},
    {k:["blue dial","blue chronograph"],color:"Blue",hex:"#2a5a9a",temp:"cool",emoji:"üîµ"},
    {k:["yellow gold","gold,"],color:"White/Gold",hex:"#d4af37",temp:"mixed",emoji:"üíé"},
    {k:["champagne"],color:"Champagne",hex:"#d4c090",temp:"warm",emoji:"ü•Ç"},
    {k:["speedmaster","moonwatch"],color:"Black",hex:"#1a1a1a",temp:"cool",emoji:"üåë"},
    {k:["flieger","laco","pilot"],color:"Black",hex:"#2a2a2a",temp:"cool",emoji:"‚úàÔ∏è"},
  ];
  for(var i=0;i<dialMap.length;i++){
    for(var j=0;j<dialMap[i].k.length;j++){
      if(text.includes(dialMap[i].k[j]))return dialMap[i];
    }
  }
  return{color:"",hex:"#5a5a5a",temp:"cool",emoji:"‚åö"};
}

/* Helper: infer contexts from name/details */
function inferContexts(name,details){
  var text=(name+" "+details).toLowerCase();
  var cx=[];
  if(text.match(/dress|elegance|reverso|santos octagon|tank/))cx.push("formal","date","event");
  if(text.match(/sport|gmt|diver|sea|aqua|tudor|omega|speedmaster/))cx.push("casual","smart-casual","travel");
  if(text.match(/chrono|monaco|flyback|pioneer/))cx.push("smart-casual","casual");
  if(text.match(/flieger|pilot|laco/))cx.push("casual","weekend");
  if(text.match(/perpetual|complication|moon|tourbillon/))cx.push("formal","date");
  if(text.match(/royal oak|overseas|laureato|ingenieur|alpine/))cx.push("smart-casual","flex","casual");
  if(text.match(/santos large|cartier/))cx.push("clinic","smart-casual","date");
  if(text.match(/grand seiko/))cx.push("clinic","smart-casual");
  if(text.match(/day-date|datejust|date /))cx.push("clinic","smart-casual","flex");
  if(!cx.length)cx.push("casual","smart-casual");
  return[...new Set(cx)];
}

/* Helper: infer size from details */
function inferSize(details){
  var m=details.match(/(\d{2})mm(?!\s*lug)/);
  return m?m[1]+"mm":null;
}

/* Helper: infer reference from details */
function inferRef(details){
  var m=details.match(/Ref\s+([A-Z0-9./-]+)/i);
  return m?m[1]:null;
}

/* Helper: parse strap description into {type, color, material} */
function parseStrapDesc(desc,source){
  var text=desc.toLowerCase();
  /* Detect type */
  var type="leather";
  if(text.match(/bracelet|steel|titanium|metal/))type="bracelet";
  else if(text.match(/nato/))type="nato";
  else if(text.match(/rubber|fkm|silicone/))type="rubber";
  else if(text.match(/canvas|sailcloth/))type="canvas";
  else if(text.match(/perlon/))type="perlon";
  else if(text.match(/mesh/))type="mesh";
  
  /* Detect material */
  var material="calf leather";
  if(text.includes("alligator"))material="alligator";
  else if(text.includes("cordovan"))material="cordovan";
  else if(text.includes("suede"))material="suede";
  else if(text.includes("nubuck"))material="nubuck";
  else if(text.includes("calfskin"))material="calf leather";
  else if(type==="bracelet")material="steel";
  else if(type==="nato")material="nylon";
  else if(type==="rubber")material="rubber";
  
  /* Detect color */
  var color="black";
  var colorMap=["grey","navy","brown","tan","honey","teal","burgundy","black","dark brown","light brown","green","olive","blue","white","beige","orange","red","purple","magenta"];
  for(var i=0;i<colorMap.length;i++){
    if(text.includes(colorMap[i])){
      color=colorMap[i];
      if(color==="honey")color="tan";
      if(color==="dark brown")color="brown";
      if(color==="light brown")color="tan";
      if(color==="magenta")color="burgundy";
      break;
    }
  }
  if(type==="bracelet")color="silver";
  
  return{type:type,color:color,material:material};
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORING (null-safe) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CP={
"black":["white","grey","charcoal","light grey","red","navy","cream","silver","gold","burgundy","cobalt","coral","pewter","graphite","powder blue"],
"white":["navy","black","cobalt","teal","grey","cream","light blue","burnt orange","olive","burgundy","charcoal","forest green","red","coral","indigo","emerald","steel blue"],
"cream":["navy","olive","teal","burgundy","brown","tan","sage","burnt orange","forest green","charcoal","wine","plum","cobalt","dark brown","cognac","dusty rose","copper","emerald","indigo"],
"ivory":["navy","olive","burgundy","brown","tan","sage","charcoal","wine","forest green","cobalt","cognac","copper","emerald","dusty rose","teal"],
"navy":["white","cream","light grey","tan","khaki","light blue","grey","gold","burnt orange","ivory","beige","sand","camel","coral","dusty rose","copper","cognac","ecru","stone","powder blue"],
"grey":["white","navy","black","charcoal","light blue","burgundy","teal","lavender","wine","cobalt","cream","dusty rose","coral","pewter","steel blue","powder blue"],
"light grey":["navy","charcoal","cobalt","burgundy","teal","forest green","plum","white","coral","dusty rose","steel blue","indigo"],
"charcoal":["white","cream","light grey","light blue","lavender","burgundy","gold","teal","cobalt","ivory","beige","coral","dusty rose","pewter","powder blue","emerald","copper"],
"light blue":["white","cream","navy","grey","tan","khaki","charcoal","brown","camel","beige","cognac","taupe","stone"],
"teal":["cream","white","tan","khaki","burnt orange","sage","ivory","brown","beige","sand","camel","coral","copper","cognac","mushroom"],
"turquoise":["white","cream","tan","navy","sand","beige","khaki","coral","copper"],
"olive":["cream","white","tan","khaki","brown","burnt orange","navy","ivory","beige","sand","rust","cognac","mushroom","ecru","copper"],
"sage":["cream","ivory","brown","tan","white","khaki","burnt orange","olive","dusty rose","mushroom","stone","taupe"],
"burgundy":["cream","ivory","charcoal","black","grey","white","light grey","beige","camel","gold","stone","mushroom","ecru","taupe"],
"wine":["cream","ivory","charcoal","grey","white","gold","beige","stone","mushroom","taupe"],
"brown":["cream","white","tan","olive","navy","khaki","sage","ivory","beige","light blue","burnt orange","ecru","stone","mushroom","powder blue"],
"dark brown":["cream","ivory","tan","khaki","beige","white","camel","light blue","ecru","stone","mushroom","powder blue"],
"tan":["navy","white","olive","brown","cream","teal","cobalt","light blue","charcoal","forest green","burgundy","indigo","steel blue","emerald"],
"camel":["navy","white","charcoal","cobalt","cream","light blue","burgundy","forest green","indigo","steel blue","teal","emerald"],
"khaki":["navy","white","cobalt","teal","olive","brown","cream","burnt orange","charcoal","burgundy","forest green","indigo","steel blue","emerald"],
"beige":["navy","charcoal","cobalt","forest green","burgundy","brown","teal","olive","indigo","steel blue","emerald"],
"sand":["navy","cobalt","teal","olive","brown","charcoal","forest green","burgundy","indigo","steel blue","emerald"],
"denim":["white","cream","tan","khaki","navy","grey","olive","brown","burnt orange","camel","cognac","coral"],
"red":["black","charcoal","grey","white","navy","cream","graphite"],
"rust":["cream","olive","navy","tan","khaki","ivory","white","brown","teal","sage","mushroom","ecru"],
"burnt orange":["cream","navy","olive","khaki","teal","tan","ivory","white","charcoal","brown","sage","mushroom"],
"gold":["navy","charcoal","black","cream","burgundy","forest green","white","emerald","indigo","wine"],
"lavender":["charcoal","grey","navy","white","cream","light grey","pewter","graphite","slate"],
"plum":["cream","ivory","charcoal","grey","white","gold","light grey","stone","mushroom","taupe"],
"mauve":["cream","charcoal","grey","ivory","navy","white","mushroom","stone","taupe"],
"forest green":["cream","ivory","tan","khaki","white","beige","camel","brown","navy","cognac","copper","stone","mushroom","ecru"],
"mint":["navy","charcoal","white","cream","grey","chocolate","slate"],
"silver":["black","charcoal","navy","white","grey","cobalt","indigo","graphite"],
"cobalt":["white","cream","light grey","tan","khaki","beige","gold","camel","coral","copper"],
"slate":["white","cream","light blue","navy","tan","coral","dusty rose","powder blue"],
"blue":["white","cream","navy","grey","tan","khaki","charcoal","brown","camel","beige","light grey","coral","copper","cognac"],
"green":["cream","ivory","tan","khaki","white","beige","camel","brown","navy","olive","burnt orange","cognac","copper"],
"pink":["navy","charcoal","grey","white","cream","light grey","black","slate","pewter"],
"orange":["navy","white","cream","charcoal","teal","olive","brown","khaki","indigo"],
"yellow":["navy","charcoal","grey","white","cobalt","denim","olive","indigo"],
"purple":["cream","ivory","charcoal","grey","white","gold","light grey","silver","stone","mushroom"],
"chocolate":["cream","ivory","tan","khaki","beige","white","camel","light blue","navy","ecru","stone","mushroom","powder blue"],
"coral":["navy","white","cream","charcoal","teal","light grey","grey","pewter","slate","powder blue","denim","turquoise"],
"dusty rose":["navy","charcoal","grey","cream","white","light grey","olive","sage","pewter","slate","taupe","mushroom"],
"pewter":["white","navy","cream","burgundy","charcoal","black","cobalt","dusty rose","coral","teal","forest green"],
"mushroom":["navy","charcoal","burgundy","forest green","teal","cobalt","cream","white","olive","sage","plum","wine","indigo"],
"charcoal blue":["white","cream","tan","light grey","coral","dusty rose","beige","khaki","gold","ivory","sand"],
"stone":["navy","charcoal","burgundy","forest green","teal","cobalt","olive","brown","wine","plum","indigo","emerald"],
"steel blue":["white","cream","tan","khaki","beige","camel","coral","sand","ivory","brown","cognac"],
"taupe":["navy","cream","white","charcoal","burgundy","forest green","teal","cobalt","light blue","dusty rose","indigo"],
"indigo":["white","cream","tan","khaki","beige","gold","sand","camel","coral","ivory","light grey","copper","cognac"],
"cognac":["navy","cream","white","charcoal","ivory","light blue","olive","forest green","beige","teal","indigo","powder blue"],
"ecru":["navy","burgundy","charcoal","forest green","cobalt","olive","brown","teal","wine","plum","indigo","emerald"],
"powder blue":["navy","charcoal","tan","brown","cream","white","cognac","taupe","chocolate","dark brown","grey","khaki"],
"emerald":["cream","ivory","tan","white","khaki","gold","beige","camel","navy","charcoal","cognac","copper","sand"],
"copper":["navy","cream","white","teal","charcoal","olive","ivory","beige","forest green","cobalt","indigo","emerald"],
"graphite":["white","cream","light grey","light blue","coral","gold","powder blue","lavender","dusty rose","cobalt","teal"],
};
/* Color family mapping for smarter matching */
const COLOR_FAMILIES={
  "blacks":["black","charcoal","graphite"],
  "whites":["white","cream","ivory","ecru"],
  "greys":["grey","light grey","pewter","silver","slate","stone"],
  "blues":["navy","blue","cobalt","light blue","steel blue","powder blue","charcoal blue","indigo","denim"],
  "greens":["green","forest green","emerald","olive","sage","teal","mint"],
  "browns":["brown","dark brown","tan","camel","chocolate","cognac","taupe","mushroom","khaki"],
  "reds":["red","burgundy","wine","rust","coral","dusty rose","copper","burnt orange"],
  "purples":["purple","plum","lavender","mauve"],
};
function getColorFamily(c){for(var fam in COLOR_FAMILIES){if(COLOR_FAMILIES[fam].includes(c))return fam}return null}
var _compatCache={},_compatCacheSize=0;
function clearCompatCache(){_compatCache={};_compatCacheSize=0}
function compat(c1,c2){
  if(!c1||!c2)return 0.1;
  const a=(c1||"").toLowerCase().trim(),b=(c2||"").toLowerCase().trim();
  if(!a||!b)return 0.1;
  var ck=a<b?a+"|"+b:b+"|"+a;
  if(_compatCache[ck]!==undefined)return _compatCache[ck];
  var r;
  if(a===b){r=0.6} /* monochrome ‚Äî intentional pairing */
  /* Exact match in compatibility matrix */
  else if((CP[a]||[]).includes(b)||(CP[b]||[]).includes(a)){r=1}
  /* Substring fallback for compound colors like "light blue" */
  else if((CP[a]||[]).some(x=>b.includes(x)||x.includes(b))){r=0.85}
  else if((CP[b]||[]).some(x=>a.includes(x)||x.includes(a))){r=0.85}
  else{
    var famA=getColorFamily(a),famB=getColorFamily(b);
    /* Color family: same family = decent pairing (tonal dressing) */
    if(famA&&famB&&famA===famB){r=0.65}
    /* Neutral + anything = safe */
    else if((["blacks","whites","greys"].includes(famA)&&famB)||(["blacks","whites","greys"].includes(famB)&&famA)){r=0.55}
    else{
      /* Temperature harmony */
      const t1=Object.entries(CM).find(([k])=>a.includes(k)),t2=Object.entries(CM).find(([k])=>b.includes(k));
      if(t1&&t2){
        var ta=t1[1].t,tb=t2[1].t;
        if(ta===tb&&ta!=="neutral"){r=0.5}
        else if(ta==="neutral"||tb==="neutral"){r=0.4}
        else if(ta==="mixed"||tb==="mixed"){r=0.45}
        else{r=0.2}
      }else{r=0.2}
    }
  }
  _compatCache[ck]=r;_compatCacheSize++;
  if(_compatCacheSize>500){_compatCache={};_compatCacheSize=0}
  return r;
}

function scoreW(w,items,ctx,reps,opts){
  if(!w.active||w.status==="sold"||w.status==="service"||w.status==="pending-trade"||w.status==="incoming")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  if(!reps&&w.t==="replica")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  /* Multi-ctx support: ctx can be string or array */
  var _ctxArr=Array.isArray(ctx)?ctx:[ctx];var _ctxPri=_ctxArr[0]||"smart-casual";var _ctxSet=new Set(_ctxArr);
  var _o=opts||{};var wearLog=_o.wearLog||[];
  let s=0;const bd={ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  const ic=items.filter(i=>i.color).map(i=>i.color.toLowerCase().trim());
  const shoe=items.find(i=>i.garmentType==="Shoes");
  const sc=shoe&&shoe.color?shoe.color.toLowerCase().trim():null;
  /* ‚ïê‚ïê UPGRADE: Formality tier scoring (gradient, not binary) ‚ïê‚ïê */
  var FORM_TIERS={formal:["reverso","sbgw267","santos-lg","santos-oct","santos-rep"],event:["reverso","sbgw267","santos-lg","santos-oct","santos-rep","laureato","speedy","monaco","gmt"],clinic:["snowflake","rikka","sbgw267","santos-lg","reverso","bb41","speedy"],date:["santos-lg","reverso","laureato","rikka","snowflake","monaco","speedy"]};
  /* Score against ALL selected contexts, take best match */
  var _bestCxScore=0;
  _ctxArr.forEach(function(_cx){
    var tierList=FORM_TIERS[_cx];
    var _cxS=0;
    if(_cx&&w.cx&&w.cx.includes(_cx)){
      if(tierList&&tierList.includes(w.id)){_cxS=5}
      else{_cxS=3}
    }else if(tierList&&tierList.includes(w.id)){_cxS=2}
    if(_cxS>_bestCxScore)_bestCxScore=_cxS;
  });
  s+=_bestCxScore;bd.ctx=_bestCxScore;
  for(const c of ic){
    if(!c)continue;
    let matched=false;
    for(const m of(w.mc||[])){if(m==="anything"||c.includes(m)||m.includes(c)){s+=2;bd.color+=2;matched=true;break}}
    if(!matched)for(const a of(w.ac||[])){if(c.includes(a)||a.includes(c)){s-=2;bd.color-=2;break}}
  }
  const temps=ic.map(c=>{const e=Object.entries(CM).find(([k])=>c.includes(k));return e?e[1].t:"neutral"});
  const wm=temps.filter(x=>x==="warm").length,co=temps.filter(x=>x==="cool").length;
  if(w.mt==="warm"&&wm>co){s+=2;bd.temp=2}if(w.mt==="cool"&&co>=wm){s+=1;bd.temp=1}if(w.mt==="warm"&&co>wm+1){s-=1;bd.temp=-1}
  /* ‚ïê‚ïê UPGRADE: Hard strap-shoe enforcement (non-negotiable leather rule) ‚ïê‚ïê */
  if(!w.br&&sc&&w.sc&&w.sc.length&&!(w.straps&&w.straps.length)){
    const sB=sc.includes("black"),sBr=sc.includes("brown")||sc.includes("tan")||sc.includes("cognac");
    const hB=w.sc.some(x=>x.includes("black")),hBr=w.sc.some(x=>x.includes("brown")||x.includes("tan")||x.includes("teal")||x.includes("green")||x.includes("burgundy")),hN=w.sc.some(x=>x.includes("navy")||x.includes("blue"));
    if(sB&&hB){s+=3;bd.strap=3}
    if(sB&&!hB&&!hN){s-=5;bd.strap=-5}
    if(sBr&&hBr){s+=3;bd.strap=3}
    if(sBr&&hB&&!hBr){s-=5;bd.strap=-5}
    if(sB&&hN){s+=1;bd.strap+=1}
  }
  /* New strap system: hard enforcement too */
  if(!w.br&&sc&&w.straps&&w.straps.length){
    var _sB2=sc.includes("black"),_sBr2=sc.includes("brown")||sc.includes("tan")||sc.includes("cognac");
    var _anyMatch=w.straps.some(function(st){
      if(st.type==="bracelet"||st.type==="rubber"||st.type==="mesh"||st.type==="nato")return true;
      var stc=(st.color||"").toLowerCase();
      if(_sB2&&(stc.includes("black")||stc.includes("navy")))return true;
      if(_sBr2&&(stc.includes("brown")||stc.includes("tan")||stc.includes("burgundy")||stc.includes("teal")||stc.includes("green")||stc.includes("cognac")))return true;
      return false;
    });
    if(!_anyMatch){s-=5;bd.strap-=5}
  }
  if(w.br){s+=1;bd.br=1}
  /* Strap type √ó context fitness */
  if(_ctxPri&&w.straps&&w.straps.length){
    var ctxMap=STRAP_CTX[_ctxPri]||{};
    var bestStrapFit=Math.max.apply(null,w.straps.map(function(st){return ctxMap[st.type]||0}));
    if(bestStrapFit>0){s+=Math.min(bestStrapFit,2);bd.strap+=Math.min(bestStrapFit,2)}
    else if(bestStrapFit<0&&w.straps.length===1){s+=bestStrapFit;bd.strap+=bestStrapFit}
  }
  /* Watch size √ó context scoring */
  var sz=w.size?parseInt(w.size):0;
  if(sz>0){
    if((_ctxSet.has("formal")||_ctxSet.has("clinic"))&&sz>=43){s-=1;bd.ctx-=1}
    if((_ctxSet.has("formal")||_ctxSet.has("clinic"))&&sz<=39){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("date")&&sz<=37){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("date")&&sz>=44){s-=0.5;bd.ctx-=0.5}
    if((_ctxSet.has("casual")||_ctxSet.has("weekend"))&&sz>=44){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("riviera")&&sz>=40&&sz<=42){s+=0.5;bd.ctx+=0.5}
  }
  /* Material harmony */
  if(!w.br&&shoe){
    var sm=(shoe.material||shoe.name||"").toLowerCase();
    if(sm.includes("leather")&&w.sc&&w.sc.some(function(x){return x.includes("leather")||x.includes("croc")||x.includes("alligator")})){s+=1;bd.strap+=1}
    if(sm.includes("suede")&&w.sc&&w.sc.some(function(x){return x.includes("suede")})){s+=1;bd.strap+=1}
  }
  /* Formality: penalize dressy watches with very casual items */
  var hasCasualItem=items.some(function(it){return it.garmentType==="T-Shirt"||it.garmentType==="Shorts"||it.garmentType==="Tank Top"||it.garmentType==="Hoodie"||it.garmentType==="Sweatshirt"});
  var isFormalCtx=_ctxSet.has("formal")||_ctxSet.has("event");
  if(isFormalCtx&&hasCasualItem){s-=2;bd.ctx-=2}
  /* ‚ïê‚ïê UPGRADE: Rotation freshness ‚Äî recently worn = score penalty ‚ïê‚ïê */
  if(wearLog&&wearLog.length){
    var _now2=Date.now();var _last=null;
    for(var _e of wearLog){if(_e.watchId===w.id&&(!_last||_e.ts>_last))_last=_e.ts}
    if(_last){
      var _daysAgo=Math.floor((_now2-_last)/(864e5));
      if(_daysAgo<=1){s-=3;bd.fresh=-3}
      else if(_daysAgo<=3){s-=1.5;bd.fresh=-1.5}
      else if(_daysAgo>=14){s+=2;bd.fresh=2}
      else if(_daysAgo>=7){s+=1;bd.fresh=1}
    }else{s+=1;bd.fresh=1}
  }
  /* ‚ïê‚ïê UPGRADE: Genuine/replica context bonus ‚ïê‚ïê */
  var _authCtx=["formal","event","clinic","date"];
  if(w.t==="genuine"&&_authCtx.some(function(a){return _ctxSet.has(a)})){s+=1.5;bd.auth=1.5}
  if(w.t==="replica"&&(_ctxSet.has("casual")||_ctxSet.has("weekend")||_ctxSet.has("riviera"))){s+=0.5;bd.auth=0.5}
  return{total:s,...bd};
}
function strapRec(w,items,ctx,wxOpts){
  /* Weather + straps-aware recommendation ‚Äî UPGRADED */
  var _rain=wxOpts&&wxOpts.rain;
  if(w.straps&&w.straps.length){
    if(w.straps.length===1){
      var s0=w.straps[0];var st0=STRAP_TYPES.find(function(t){return t.id===s0.type})||STRAP_TYPES[0];
      var _warn="";
      if(_rain&&s0.type==="leather")_warn=" ‚ö†Ô∏è rain";
      return{text:s0.type==="bracelet"?(st0.icon+" Bracelet ("+s0.material+")"+_warn):(st0.icon+" "+s0.color+" "+s0.type+_warn),type:_rain&&s0.type==="leather"?"warn":"info",strap:s0};
    }
    var shoe=items.find(function(i){return i.garmentType==="Shoes"});
    var sc=shoe&&shoe.color?shoe.color.toLowerCase():"";
    var sm=(shoe&&(shoe.material||shoe.name)||"").toLowerCase();
    var _ctxPri2=Array.isArray(ctx)?ctx[0]||"smart-casual":ctx;var ctxMap=STRAP_CTX[_ctxPri2]||{};
    var scored=w.straps.map(function(st){
      var pts=ctxMap[st.type]||0;
      var stc=st.color?st.color.toLowerCase():"";
      /* Shoe-strap color matching */
      if(st.type!=="bracelet"&&sc){
        if(sc.includes("black")&&(stc.includes("black")||stc.includes("navy")))pts+=3;
        if((sc.includes("brown")||sc.includes("tan")||sc.includes("cognac"))&&(stc.includes("brown")||stc.includes("tan")||stc.includes("burgundy")||stc.includes("teal")))pts+=3;
        if(sc.includes("black")&&(stc.includes("brown")||stc.includes("tan")))pts-=2;
        if((sc.includes("brown")||sc.includes("tan"))&&stc.includes("black"))pts-=2;
      }
      /* Material harmony */
      if(sm.includes("leather")&&(st.material||"").toLowerCase().match(/leather|alligator|cordovan|nubuck/))pts+=1;
      if(sm.includes("suede")&&(st.material||"").toLowerCase().includes("suede"))pts+=1;
      /* ‚ïê‚ïê UPGRADE: Weather-aware strap scoring ‚ïê‚ïê */
      if(_rain){
        if(st.type==="bracelet"||st.type==="rubber"||st.type==="mesh")pts+=4;
        if(st.type==="leather")pts-=4;
        if(st.type==="nato"||st.type==="canvas")pts+=1;
      }
      return{strap:st,score:pts};
    }).sort(function(a,b){return b.score-a.score});
    var best=scored[0];var stDef=STRAP_TYPES.find(function(t){return t.id===best.strap.type})||STRAP_TYPES[0];
    var label=best.strap.type==="bracelet"?"Bracelet ("+best.strap.material+")":best.strap.color+" "+best.strap.type;
    var _rainNote=_rain&&best.strap.type==="leather"?" ‚ö†Ô∏è rain":"";
    return{text:"‚Üí "+stDef.icon+" "+label+_rainNote,type:_rain&&best.strap.type==="leather"?"warn":"good",strap:best.strap,all:scored};
  }
  /* Legacy fallback */
  if(w.br)return{text:"‚õìÔ∏è Bracelet"+(_rain?" ‚úì rain-safe":""),type:"info"};
  if(!w.sc||!w.sc.length)return{text:"Default strap",type:"info"};
  const shoe2=items.find(i=>i.garmentType==="Shoes");const sc2=shoe2&&shoe2.color?shoe2.color.toLowerCase():"";
  if(w.sc.length===1)return{text:w.sc[0]+" strap",type:"info"};
  for(const st of w.sc){
    if(sc2.includes("black")&&(st.includes("black")||st.includes("navy")))return{text:"‚Üí "+st,type:"good"};
    if((sc2.includes("brown")||sc2.includes("tan"))&&(st.includes("brown")||st.includes("tan")||st.includes("teal")||st.includes("burgundy")))return{text:"‚Üí "+st,type:"good"};
  }
  return{text:w.sc.join(" / "),type:"info"};
}
function getWarns(w,items){
  const ws=[];const shoe=items.find(i=>i.garmentType==="Shoes");
  var hasLeather=w.straps?w.straps.some(function(s){return s.type==="leather"}):!w.br;
  var nonBrStraps=w.straps?w.straps.filter(function(s){return s.type!=="bracelet"}):[];
  if(hasLeather&&shoe&&shoe.color){const sc=shoe.color.toLowerCase();
    if(sc.includes("white"))ws.push("‚ö†Ô∏è Leather strap+white shoes");
    var strapColors=nonBrStraps.length?nonBrStraps.map(function(s){return s.color.toLowerCase()}):w.sc||[];
    if(sc.includes("brown")&&strapColors.length&&strapColors.every(function(x){return x.includes("black")||x.includes("navy")}))ws.push("üö´ Brown shoes+dark strap");
    if(sc.includes("black")&&strapColors.length&&strapColors.every(function(x){return x.includes("brown")||x.includes("tan")||x.includes("teal")}))ws.push("üö´ Black shoes+warm strap");
  }
  /* Strap type formality warnings */
  if(w.straps&&w.straps.length===1){
    var onlyType=w.straps[0].type;
    if((onlyType==="nato"||onlyType==="rubber"||onlyType==="canvas")&&w.cx&&(w.cx.includes("formal")||w.cx.includes("date")))ws.push("‚ö†Ô∏è "+onlyType+" strap may be too casual ‚Äî consider adding a leather option");
  }
  /* Formality warnings */
  var hasShorts=items.some(function(it){return it.garmentType==="Shorts"});
  var hasTee=items.some(function(it){return it.garmentType==="T-Shirt"||it.garmentType==="Tank Top"});
  var hasCasualKnit=items.some(function(it){return it.garmentType==="Hoodie"||it.garmentType==="Sweatshirt"});
  if(hasShorts&&w.cx&&!w.cx.includes("casual")&&!w.cx.includes("weekend")&&!w.cx.includes("riviera"))ws.push("‚ö†Ô∏è Shorts may clash with this watch's formality");
  if(hasTee&&w.cx&&w.cx.includes("formal")&&!w.cx.includes("casual"))ws.push("‚ö†Ô∏è T-shirt may be too casual for this watch");
  if(hasCasualKnit&&w.cx&&(w.cx.includes("formal")||w.cx.includes("clinic")))ws.push("‚ö†Ô∏è Hoodie/sweatshirt too casual for this context");
  return ws;
}
const CXR={
"clinic":{no:["Shorts","Jeans","T-Shirt","Tank Top","Hoodie","Sweatshirt"]},
"smart-casual":{no:["Shorts","Tank Top","Hoodie","Sweatshirt"]},
"formal":{no:["T-Shirt","Shorts","Jeans","Polo","Henley","Tank Top","Hoodie","Sweatshirt","Overshirt"]},
"date":{no:["Shorts","T-Shirt","Tank Top","Hoodie","Sweatshirt"]},
"riviera":{no:[]},
"casual":{no:[]},
"weekend":{no:[]},
"flex":{no:["Shorts","Tank Top","Hoodie","Sweatshirt"]},
"travel":{no:[]},
"event":{no:["T-Shirt","Shorts","Tank Top","Hoodie","Sweatshirt"]},
"office":{no:["Shorts","T-Shirt","Jeans","Tank Top","Hoodie","Sweatshirt"]},
};

function makeOutfit(items,watches,ctx,reps,wxOpts,tempVal,extraOpts){
  var _wl=extraOpts&&extraOpts.wearLog||[];
  var tops=items.filter(i=>catOf(i.garmentType)==="tops");
  const top=tops[0]||null,bot=items.find(i=>catOf(i.garmentType)==="bottoms"),shoe=items.find(i=>catOf(i.garmentType)==="shoes");
  /* outermost top layer is what's visible ‚Äî used for primary color scoring */
  var outerTop=tops.length>0?tops[tops.length-1]:null;
  if(wxOpts&&tempVal!==undefined)wxOpts.temp=tempVal;
  let fs=0;
  /* Layering bonus ‚Äî reward multi-layer outfits */
  if(tops.length>=2)fs+=0.5;
  if(tops.length>=3)fs+=0.5;
  /* Season penalty for off-season items */
  /* Season ‚Äî temperature-based when weather available, hemisphere-aware month fallback */
  var _csn=getSeason(wxOpts&&wxOpts.temp!==undefined?wxOpts.temp:undefined,wxOpts&&wxOpts.lat);
  items.forEach(function(it){var s=it.seasons;if(s&&s.length>0&&s.length<4&&!s.includes(_csn))fs-=1});
  /* Freshness penalty ‚Äî discourage recently-worn garments for variety */
  var _now=Date.now();
  items.forEach(function(it){if(it.lastWorn){var daysAgo=Math.floor((_now-new Date(it.lastWorn).getTime())/(864e5));if(daysAgo<=1)fs-=2;else if(daysAgo<=3)fs-=0.8;else if(daysAgo<=5)fs-=0.3;else if(daysAgo>=14)fs+=0.3}});
  /* Color compat ‚Äî use outermost visible layer for primary scoring */
  if(outerTop&&bot)fs+=compat(outerTop.color,bot.color)*3;
  if(outerTop&&shoe)fs+=compat(outerTop.color,shoe.color)*2;
  if(bot&&shoe)fs+=compat(bot.color,shoe.color)*2;
  /* Layer-to-layer color harmony */
  for(var li=0;li<tops.length-1;li++){fs+=compat(tops[li].color,tops[li+1].color)*1.5}
  /* Jeans-first preference: jeans are the default bottom unless formality demands otherwise.
     If no jeans exist in the current bottom pool, remove casual penalties on chinos/trousers
     so scores don't get artificially depressed when jeans simply aren't available. */
  if(bot){
    var _cx=Array.isArray(ctx)?ctx[0]:ctx;
    var _formalCx=_cx==="formal"||_cx==="event"||_cx==="office";
    var _semiCx=_cx==="clinic"||_cx==="smart-casual"||_cx==="date";
    var _hasJeans=extraOpts&&extraOpts.hasJeansInPool||false;
    if(bot.garmentType==="Jeans"){fs+=_formalCx?0:_semiCx?1.2:2.0}
    else if(bot.garmentType==="Chinos"){fs+=_formalCx?1.0:_semiCx?0:(_hasJeans?-0.8:0.5)}
    else if(bot.garmentType==="Pants/Trousers"){fs+=_formalCx?1.5:_semiCx?0.3:(_hasJeans?-1.2:0)}
  }
  /* Pattern bonus ‚Äî check outermost top vs bottom */
  if(outerTop&&bot){
    var tp=(outerTop.pattern||"solid"),bp=(bot.pattern||"solid");
    if(tp!=="solid"&&bp!=="solid")fs-=1.5;
    else if((tp==="textured"||bp==="textured")&&(tp==="solid"||bp==="solid"))fs+=0.8;
    else if(tp==="striped"&&bp==="solid")fs+=0.4;
  }
  /* Weather condition scoring */
  var isRainy=wxOpts&&wxOpts.rain;
  var isWindy=wxOpts&&wxOpts.wind&&wxOpts.wind>30;
  var uvHigh=wxOpts&&wxOpts.uv&&wxOpts.uv>=6;
  if(isRainy&&shoe){
    var sc2=(shoe.color||"").toLowerCase();
    var sn2=(shoe.name||"").toLowerCase();
    /* Penalize white/cream shoes in rain */
    if(sc2==="white"||sc2==="cream"||sc2==="beige"||sc2==="sand")fs-=2;
    /* Black shoes safest in rain */
    if(sc2==="black")fs+=1;
    /* Suede/canvas/material penalty in rain */
    var sm=(shoe.material||"").toLowerCase();
    if(sn2.includes("suede")||sm==="suede")fs-=2;
    else if(sn2.includes("canvas")||sm==="canvas")fs-=1;
  }
  /* Material-weather scoring for all items */
  if(wxOpts){
    var wxTemp=wxOpts.temp||18;
    items.forEach(function(it){
      var mat=(it.material||"").toLowerCase();
      if(!mat)return;
      if(isRainy&&mat==="suede")fs-=2;
      if(isRainy&&mat==="canvas")fs-=1;
      if((mat==="wool"||mat==="cashmere"||mat==="fleece")&&wxTemp>28)fs-=2;
      if(mat==="linen"&&wxTemp<10)fs-=1;
      if((mat==="linen"||mat==="cotton")&&wxTemp>25)fs+=1;
      if((mat==="wool"||mat==="cashmere"||mat==="tweed"||mat==="corduroy"||mat==="fleece")&&wxTemp<15)fs+=1;
    });
  }
  const wr=watches.map(w=>{
    var sc=scoreW(w,items,ctx,reps,{wearLog:_wl});
    /* Rain: penalize leather/suede, boost bracelets & rubber */
    if(isRainy){
      if(w.straps&&w.straps.length){
        var hasWR=w.straps.some(function(s){return s.type==="bracelet"||s.type==="rubber"||s.type==="mesh"});
        var onlyLeather=w.straps.every(function(s){return s.type==="leather"});
        if(hasWR){sc.total+=2;sc.br+=2}
        if(onlyLeather){sc.total-=2;sc.strap-=2}
      }else{
        if(w.br){sc.total+=2;sc.br+=2}else{sc.total-=2;sc.strap-=2}
      }
    }
    return{...w,score:sc.total,bd:sc,sr:strapRec(w,items,ctx,{rain:isRainy}),wn:getWarns(w,items)}
  }).filter(w=>w.score>-1).sort((a,b)=>b.score-a.score);
  if(wr[0])fs+=wr[0].score*0.5;
  /* Rain warning */
  var wxWarns=[];
  if(isRainy)wxWarns.push("üåßÔ∏è Rain expected ‚Äî bracelets/rubber preferred over leather");
  if(isWindy)wxWarns.push("üí® High wind ‚Äî secure light items");
  return{fs:Math.round(fs*10)/10,watches:wr.slice(0,3),allW:wr,top,bot,shoe,outerTop:outerTop,tops:tops,items,wxWarns:wxWarns};
}

function genFits(wardrobe,watches,ctx,reps,ww,count,opts){
  count=count||10;opts=opts||{};
  var wxOpts=opts.wx||null;
  var rules=CXR[Array.isArray(ctx)?ctx[0]:ctx]||CXR["smart-casual"];
  var curSeason=getSeason(opts.temp,opts.lat);
  var seasonFilter=function(i){var s=i.seasons;if(!s||!s.length||s.length>=4)return true;return s.includes(curSeason)};
  var valid=wardrobe.filter(function(i){return i.color&&!i.needsEdit});
  var allTops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  var bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  if(!allTops.length)allTops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)});
  if(!bots.length)bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)});
  var shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"&&seasonFilter(i)});
  if(!shoes.length)shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"});
  if(opts.topType&&opts.topType!=="all"){var ft=allTops.filter(function(i){return i.garmentType===opts.topType});if(ft.length)allTops=ft}
  var lockItem=opts.lockItem||null;
  if(lockItem){var lcat=catOf(lockItem.garmentType);if(lcat==="tops")allTops=[lockItem];else if(lcat==="bottoms")bots=[lockItem]}
  var baseTops=allTops.filter(function(i){return layerOf(i.garmentType)==="base"});
  var midTops=allTops.filter(function(i){return layerOf(i.garmentType)==="mid"});
  var outerTops=allTops.filter(function(i){return layerOf(i.garmentType)==="outer"});
  var topCombos=[];
  if(ww==="light"){
    (baseTops.length?baseTops:allTops).forEach(function(t){topCombos.push([t])});
    var lb=bots.filter(function(i){return["Shorts","Chinos","Jeans"].includes(i.garmentType)});if(lb.length)bots=lb;
  }else if(ww==="mid"){
    var midTemp=opts.temp||18;
    if(midTemp<18){
      baseTops.forEach(function(b){topCombos.push([b]);midTops.forEach(function(m){if(b.id!==m.id&&compat(b.color,m.color)>=0.15)topCombos.push([b,m])});outerTops.forEach(function(o){if(b.id!==o.id&&compat(b.color,o.color)>=0.15)topCombos.push([b,o])})});
      if(!baseTops.length){midTops.forEach(function(m){topCombos.push([m])});outerTops.forEach(function(o){topCombos.push([o])})}
    }else{
      baseTops.forEach(function(b){topCombos.push([b])});midTops.forEach(function(m){topCombos.push([m])});
      baseTops.slice(0,3).forEach(function(b){midTops.filter(function(m){return m.garmentType==="Cardigan"||m.garmentType==="Vest/Gilet"}).forEach(function(m){if(compat(b.color,m.color)>=0.2)topCombos.push([b,m])})});
    }
    var cmb=bots.filter(function(i){return["Pants/Trousers","Jeans","Chinos"].includes(i.garmentType)});if(cmb.length)bots=cmb;
  }else if(ww==="heavy"){
    baseTops.forEach(function(b){
      midTops.forEach(function(m){if(b.id!==m.id&&compat(b.color,m.color)>=0.1)topCombos.push([b,m])});
      outerTops.forEach(function(o){if(b.id!==o.id&&compat(b.color,o.color)>=0.1)topCombos.push([b,o])});
      midTops.forEach(function(m){outerTops.forEach(function(o){if(b.id!==m.id&&m.id!==o.id&&b.id!==o.id&&compat(b.color,m.color)>=0.1&&compat(m.color,o.color)>=0.1)topCombos.push([b,m,o])})});
    });
    if(!baseTops.length){midTops.forEach(function(m){topCombos.push([m]);outerTops.forEach(function(o){if(m.id!==o.id)topCombos.push([m,o])})});outerTops.forEach(function(o){topCombos.push([o])})}
    if(!topCombos.length)allTops.forEach(function(t){topCombos.push([t])});
    var hb=bots.filter(function(i){return["Jeans","Pants/Trousers","Chinos"].includes(i.garmentType)});if(hb.length)bots=hb;
  }
  if(!topCombos.length)allTops.forEach(function(t){topCombos.push([t])});
  if(!topCombos.length||!bots.length)return[];
  if(topCombos.length>50){topCombos.sort(function(a,b){var sa=0,sb=0;for(var ii=0;ii<a.length-1;ii++)sa+=compat(a[ii].color,a[ii+1].color);for(var ii=0;ii<b.length-1;ii++)sb+=compat(b[ii].color,b[ii+1].color);sb+=b.length*0.3;sa+=a.length*0.3;return sb-sa});topCombos=topCombos.slice(0,50)}
  var combos=[];
  for(var tci=0;tci<topCombos.length;tci++){var tc=topCombos[tci];for(var bi=0;bi<bots.length;bi++){var bot=bots[bi];
    var outerItem=tc[tc.length-1];
    if(tc.some(function(t){return t.id===bot.id}))continue;
    var tb=compat(outerItem.color,bot.color);if(tb<0.2)continue;
    for(var si2=0;si2<(shoes.length||1);si2++){var shoe=shoes.length?shoes[si2]:null;
      if(shoe&&tc.some(function(t){return t.id===shoe.id}))continue;
      if(shoe&&shoe.id===bot.id)continue;
      var items=tc.concat([bot]).concat(shoe?[shoe]:[]);
      var r=makeOutfit(items,watches,ctx,reps,wxOpts,opts.temp,{wearLog:opts.wearLog||[],hasJeansInPool:bots.some(function(b2){return b2.garmentType==="Jeans"})});
      var topIds=tc.map(function(t){return t.id}).join("+");
      combos.push({id:topIds+"-"+bot.id+"-"+(shoe?shoe.id:"x"),fs:r.fs,watches:r.watches,allW:r.allW,top:r.outerTop||tc[0],bot:r.bot,shoe:r.shoe,outerTop:r.outerTop,tops:tc,layers:tc,items:r.items,topType:outerItem.garmentType,wxWarns:r.wxWarns});
    }
  }}
  combos.sort(function(a,b){return b.fs-a.fs});
  var seen=new Set(),botUse={},uniq=[];
  for(var ci=0;ci<combos.length;ci++){var c=combos[ci];
    var outerC=c.outerTop||c.top;
    var ck=(outerC?outerC.color:"")+ "-"+(c.bot?c.bot.color:"") +"-"+(c.layers?c.layers.length:1);
    var bid=c.bot?c.bot.id:"x";
    if(seen.has(ck)&&uniq.length>2)continue;
    if((botUse[bid]||0)>=3&&uniq.length>4)continue;
    seen.add(ck);botUse[bid]=(botUse[bid]||0)+1;
    uniq.push(c);if(uniq.length>=count)break;
  }
  if(opts.shuffle){for(var shi=uniq.length-1;shi>0;shi--){var shj=Math.floor(Math.random()*(shi+1));var st=uniq[shi];uniq[shi]=uniq[shj];uniq[shj]=st}}
  return uniq;
}

function getSwaps(wd,fit,slot){
  const cat=slot==="top"?"tops":slot==="bot"?"bottoms":"shoes";
  const cur=slot==="top"?fit.top:slot==="bot"?fit.bot:fit.shoe;if(!cur)return[];
  return wd.filter(function(i){return i.color&&!i.needsEdit&&catOf(i.garmentType)===cat&&i.id!==cur.id}).map(function(alt){
    const o1=slot==="top"?fit.bot:fit.top;const o2=slot==="top"?fit.shoe:(slot==="bot"?fit.shoe:fit.bot);
    let sc=o1?compat(alt.color,o1.color)*3:0;if(o2)sc+=compat(alt.color,o2.color)*2;
    return Object.assign({},alt,{ss:Math.round(sc*10)/10})}).sort(function(a,b){return b.ss-a.ss}).slice(0,3);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMAGE COMPRESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function compressImage(dataUrl,maxDim,quality){
  maxDim=maxDim||800;quality=quality||0.7;
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.width,h=img.height;
      if(w>maxDim||h>maxDim){if(w>h){h=Math.round(h*(maxDim/w));w=maxDim}else{w=Math.round(w*(maxDim/h));h=maxDim}}
      var c=document.createElement("canvas");c.width=w;c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      resolve(c.toDataURL("image/jpeg",quality));
    };
    img.onerror=function(){resolve(dataUrl)};
    img.src=dataUrl;
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI ERROR LOG (visible in UI) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _lastAiError="";
function getLastAiError(){return _lastAiError}

async function aiID(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:700,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"Identify ALL distinct clothing items visible in this photo for a luxury wardrobe management app.\n\nRules:\n1. If a FULL OUTFIT is shown (person wearing top+bottom+shoes), return EACH as a separate item.\n2. If photo shows a single garment laid flat or folded, return just one item.\n3. If multiple garments are layered (e.g. blazer over shirt), identify each distinct layer.\n4. If multiple garments are stacked/folded together, identify each distinct one.\n5. For each item, note its position in the frame (e.g. 'top half','bottom half','left','right','center','full frame','layered front','layered back').\n6. Include shoes if visible.\n7. Maximum 5 items per photo.\n8. Detect fabric/material where possible (cotton, wool, linen, denim, leather, silk, cashmere, knit, corduroy, tweed, fleece, suede, canvas, nylon, chino, synthetic).\n9. COLOR ACCURACY IS CRITICAL: Look carefully at the actual garment color. Distinguish between navy vs black, charcoal vs grey, cream vs white, olive vs sage, burgundy vs brown, tan vs beige vs camel, etc. If a color is between two options, pick the closest match.\n10. For patterns: 'textured' means visible weave/knit texture but no distinct pattern. 'print' means graphic/floral/abstract. Be specific.\n\nReturn ONLY a JSON ARRAY, no markdown:\n[{\"garmentType\":\"Shirt\"|\"Polo\"|\"T-Shirt\"|\"Sweater/Knit\"|\"Jacket/Blazer\"|\"Pants/Trousers\"|\"Chinos\"|\"Jeans\"|\"Shorts\"|\"Shoes\"|\"Hat\"|\"Scarf\"|\"Belt\"|\"Bag\"|\"Sunglasses\"|\"Accessory\",\"name\":\"2-4 word descriptive name (e.g. 'Navy Wool Blazer', 'White Oxford Shirt')\",\"color\":\"one from: "+AC.join(",")+"\",\"pattern\":\"solid\"|\"plaid\"|\"striped\"|\"checked\"|\"print\"|\"textured\",\"material\":\"detected fabric type or null\",\"position\":\"where in frame\",\"season_hint\":\"all-season\"|\"warm-weather\"|\"cold-weather\"|\"transitional\"}]\nPick the single dominant color per item. If only ONE item is visible, still return an array with one element."}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    var p=JSON.parse(txt);
    /* Handle both array and single object responses */
    if(Array.isArray(p)){if(p.length&&p[0].garmentType&&p[0].color)return p;_lastAiError="AI returned empty array";return null}
    if(p.garmentType&&p.color)return[p];
    _lastAiError="AI returned incomplete: "+JSON.stringify(p).slice(0,80);return null;
  }catch(e){_lastAiError="Exception: "+String(e.message||e).slice(0,120);return null}
}

async function aiVision(fit,watch,ctx,apiKey){
  _lastAiError="";
  var top=fit.top,bot=fit.bot,shoe=fit.shoe;
  var layers=fit.layers||fit.tops||[];
  var prompt="You are an elite men's luxury style advisor for high-net-worth clients. Analyze this outfit with the precision of a GQ editor and Savile Row tailor combined.\n\n";
  prompt+="OUTFIT DETAILS:\n";
  if(layers&&layers.length>1){
    layers.forEach(function(l,i){prompt+="- Layer "+(i+1)+": "+l.color+" "+(l.pattern||"solid")+" "+l.garmentType+(l.name?" ("+l.name+")":"")+(l.material?" ["+l.material+"]":"")+"\n"});
  }else if(top){prompt+="- Top: "+top.color+" "+(top.pattern||"solid")+" "+(top.garmentType||"")+(top.name?" ("+top.name+")":"")+(top.material?" ["+top.material+"]":"")+"\n"}
  if(bot)prompt+="- Bottom: "+bot.color+" "+(bot.pattern||"solid")+" "+(bot.garmentType||"")+(bot.name?" ("+bot.name+")":"")+(bot.material?" ["+bot.material+"]":"")+"\n";
  if(shoe)prompt+="- Shoes: "+shoe.color+" "+(shoe.name||shoe.garmentType||"shoes")+(shoe.material?" ["+shoe.material+"]":"")+"\n";
  prompt+="- Watch: "+watch.n+" ‚Äî "+watch.d+" dial, "+(watch.straps&&watch.straps.length?watch.straps.map(function(s){return s.type+(s.material?" ("+s.material+")":"")+(s.color&&s.type!=="bracelet"?" in "+s.color:"")}).join(" + "):watch.br?"steel bracelet":"leather strap"+(watch.sc?" ("+watch.sc.join("/")+")":""))+(IS_SHARED?"":", "+(watch.t==="replica"?"replica":"genuine"))+"\n";
  prompt+="- Context: "+(Array.isArray(ctx)?ctx.join(" + "):ctx)+"\n\n";
  prompt+="Return ONLY valid JSON, no markdown fences:\n";
  prompt+='{"vision":"A 3-4 sentence cinematic, editorial description. Describe the man walking into the room ‚Äî how fabrics drape, colors interact, and the watch catches light. Write like a luxury editorial spread.",';
  prompt+='"impact":1-10,"impact_why":"One sentence explaining the psychological impact on observers.",';
  prompt+='"color_story":"Analyze the color palette ‚Äî is it monochrome, complementary, analogous, or triadic? Does the warm/cool balance work? (1-2 sentences).",';
  prompt+='"works":"What color/texture/material combinations create the strongest visual effect (1-2 sentences).",';
  prompt+='"risk":"Any clash, proportion issue, formality mismatch, color temperature conflict, or execution risk (1-2 sentences, or null if flawless).",';
  prompt+='"upgrade":"One specific change that would elevate this outfit even further (1 sentence).",';
  prompt+='"strap_call":"If watch has strap options, which one for this outfit and why (1 sentence, or null if bracelet)."}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:500,
        messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Vision HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Vision error: "+String(e.message||e).slice(0,100);return null}
}

async function aiStyleCoach(wardrobe,watches,ctx,apiKey){
  _lastAiError="";
  var colorCounts={};wardrobe.filter(function(i){return i.color}).forEach(function(i){colorCounts[i.color]=(colorCounts[i.color]||0)+1});
  var colors=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]}).slice(0,10).map(function(e){return e[0]+" (√ó"+e[1]+")"}).join(", ");
  var types={};wardrobe.forEach(function(i){if(i.garmentType)types[i.garmentType]=(types[i.garmentType]||0)+1});
  var typeStr=Object.entries(types).sort(function(a,b){return b[1]-a[1]}).map(function(e){return e[0]+" √ó"+e[1]}).join(", ");
  var watchStr=watches.map(function(w){return w.n+" ("+w.d+" dial, "+(w.straps&&w.straps.length?w.straps.map(function(s){return s.type}).join("+"):w.br?"bracelet":"strap")+")"}).join(", ");
  var prompt="You are an expert luxury men's style advisor. Analyze this wardrobe and give specific actionable advice.\n\n";
  prompt+="WARDROBE ("+wardrobe.length+" items):\n- Types: "+typeStr+"\n- Colors: "+colors+"\n";
  prompt+="WATCHES: "+watchStr+"\n";
  prompt+="Primary context: "+ctx+"\n\n";
  prompt+='Return ONLY valid JSON:\n{"summary":"2-3 sentence overall assessment ‚Äî be specific about style identity and trajectory","strengths":["4-5 specific strengths with examples from the wardrobe"],"gaps":["4-5 specific gaps with recommended colors and pieces"],"next_buys":["5 specific items to buy next with exact color and brand tier suggestions"],"style_tip":"One expert styling tip personalized to this exact collection ‚Äî reference specific pieces","seasonal_weak":"Which season needs most work and why (1 sentence)","signature_combos":["3 killer outfit combinations possible from the current wardrobe ‚Äî use exact item names/colors"],"versatility":1-10}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Coach HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Coach error: "+String(e.message||e).slice(0,100);return null}
}

async function aiOccasionPlan(occasion,wardrobe,watches,apiKey){
  _lastAiError="";
  var items=wardrobe.filter(function(i){return i.color&&!i.needsEdit}).map(function(i){return{type:i.garmentType,name:i.name||i.color,color:i.color,pattern:i.pattern||"solid",material:i.material||""}});
  var watchList=watches.map(function(w){return{name:w.n,ref:w.ref||null,size_mm:w.size||null,movement:w.mvmt||null,type:w.t==="replica"?"REP":"GEN",dial:w.d,bracelet:w.br,strap_colors:w.sc||[],straps:w.straps?w.straps.map(function(s){return{type:s.type,color:s.color,material:s.material}}):[]}}); 
  var prompt="You are a luxury men's style advisor. A client needs outfit recommendations for a specific occasion.\n\n";
  prompt+="OCCASION: "+occasion+"\n\n";
  prompt+="AVAILABLE WARDROBE ("+items.length+" items):\n"+JSON.stringify(items.slice(0,30))+"\n\n";
  prompt+="AVAILABLE WATCHES:\n"+JSON.stringify(watchList)+"\n\n";
  prompt+='Create 2 outfit recommendations from the available pieces. Return ONLY valid JSON:\n{"occasion_tips":"3-4 sentences of detailed advice for this specific occasion ‚Äî dress code nuances, common mistakes, and power moves","outfits":[{"name":"Creative editorial outfit name","top":"exact item name/color from wardrobe","bottom":"exact item name/color","shoes":"exact item name/color or suggestion","watch":"exact watch name","layers":"optional mid/outer layer from wardrobe if weather warrants","why":"2 sentences explaining the color story and why this combination works","confidence":1-10},{"name":"...","top":"...","bottom":"...","shoes":"...","watch":"...","layers":"...","why":"...","confidence":1-10}],"avoid":"2 sentences on what to avoid for this occasion with specific examples","power_move":"One unexpected styling choice that would make a statement (1 sentence)"}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Occasion HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Occasion error: "+String(e.message||e).slice(0,100);return null}
}

async function aiWardrobeAudit(wardrobe,watches,saved,wearLog,apiKey){
  _lastAiError="";
  var colorCounts={};wardrobe.filter(function(i){return i.color}).forEach(function(i){colorCounts[i.color]=(colorCounts[i.color]||0)+1});
  var colors=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]}).map(function(e){return e[0]+" √ó"+e[1]}).join(", ");
  var types={};wardrobe.forEach(function(i){if(i.garmentType)types[i.garmentType]=(types[i.garmentType]||0)+1});
  var mats={};wardrobe.forEach(function(i){if(i.material)mats[i.material]=(mats[i.material]||0)+1});
  var prompt="You are a luxury men's wardrobe consultant performing a comprehensive audit.\n\n";
  prompt+="WARDROBE ("+wardrobe.length+" items):\n";
  prompt+="Types: "+Object.entries(types).map(function(e){return e[0]+" √ó"+e[1]}).join(", ")+"\n";
  prompt+="Colors: "+colors+"\n";
  prompt+="Materials: "+Object.entries(mats).map(function(e){return e[0]+" √ó"+e[1]}).join(", ")+"\n";
  prompt+="Watches: "+watches.length+" ("+watches.map(function(w){return w.n}).join(", ")+")\n";
  prompt+="Saved outfits: "+saved.length+"\n";
  prompt+="Wear log entries: "+wearLog.length+"\n\n";
  prompt+='Provide a comprehensive wardrobe audit. Return ONLY valid JSON:\n{"grade":"A+/A/B+/B/C+/C/D/F overall wardrobe grade","grade_why":"2 sentence detailed explanation of the grade","color_harmony":"Assessment of color palette balance ‚Äî warm/cool ratio, missing neutrals, dominant tones (2-3 sentences)","versatility":"How many distinct looks possible, cross-functionality of pieces (2 sentences)","cost_efficiency":"Whether the wardrobe is well-optimized for max outfits per piece (1-2 sentences)","declutter":["Up to 5 specific items/categories that are redundant with reasoning"],"invest":["Up to 5 specific items worth investing in with price tier and color"],"seasonal_score":{"spring":1-10,"summer":1-10,"fall":1-10,"winter":1-10},"watch_wardrobe_synergy":"How well watches complement the wardrobe ‚Äî specific matches and gaps (2-3 sentences)","style_identity":"What style archetype this wardrobe represents (1-2 sentences)","pro_tip":"One advanced styling insight specific to this collection (1-2 sentences)"}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1200,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Audit HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Audit error: "+String(e.message||e).slice(0,100);return null}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI WATCH IDENTIFICATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function aiWatchID(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:800,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"You are an expert watch identifier for a luxury watch collection app. Analyze this watch photo and identify it.\n\nReturn ONLY valid JSON, no markdown:\n{\"brand\":\"Full brand name\",\"model\":\"Model name\",\"reference\":\"Reference number if identifiable or null\",\"dial_color\":\"Primary dial color description (e.g. Silver-White, Blue, Black, Teal, Burgundy, Green, White, Meteorite, Turquoise, Ivory, Purple)\",\"dial_hex\":\"Hex color code for the dial\",\"case_material\":\"steel/titanium/gold/rose gold/two-tone\",\"case_size\":\"Estimated size in mm or null\",\"movement_type\":\"automatic/manual/quartz/spring drive\",\"has_bracelet\":true/false,\"strap_type\":\"bracelet/leather/rubber/nato/canvas or null\",\"strap_color\":\"strap color or null\",\"complications\":[\"list of complications like chronograph, GMT, moon phase, perpetual calendar, date, day-date\"],\"style_category\":\"dress/sport/diver/pilot/chronograph/field/integrated\",\"suggested_contexts\":[\"formal\",\"clinic\",\"smart-casual\",\"casual\",\"date\",\"weekend\",\"riviera\",\"flex\",\"event\",\"travel\"],\"temperature\":\"warm/cool/neutral/mixed\",\"confidence\":1-10,\"emoji\":\"Single emoji that best represents this watch\",\"notes\":\"Any additional identification notes (1 sentence)\"}"}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="WatchID HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="WatchID error: "+String(e.message||e).slice(0,120);return null}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI SELFIE CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function aiSelfieCheck(b64,mime,apiKey,watches,selWatch,ctx){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:800,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"You are an elite men's luxury style advisor with encyclopedic horological knowledge.\n\nOWNER'S COLLECTION (ref numbers, sizes, movements for watch identification):\n"+JSON.stringify((watches||[]).map(function(w){return{name:w.n,ref:w.ref||null,size_mm:w.size||null,movement:w.mvmt||null,dial:w.d,bracelet:w.br,straps:w.straps?w.straps.map(function(s){return{type:s.type,color:s.color}}):[]}}),null,0)+"\n\n"+(selWatch?"CONFIRMED: "+selWatch.n+(selWatch.ref?" (Ref "+selWatch.ref+")":"")+(selWatch.size?" "+selWatch.size+"mm":"")+"\n":"")+"Context: "+(Array.isArray(ctx)?ctx.join(" + "):ctx||"smart-casual")+"\n\nAnalyze:\n1. Every visible garment ‚Äî color, material, fit, proportion\n2. WATCH DETECTION ‚Äî examine wrist for: case shape, dial color/texture, bezel, bracelet/strap, size. Match against collection using ref numbers.\n3. Color harmony, formality coherence\n4. CRITICAL: brown strap MUST match brown shoes, black strap MUST match black shoes\n5. Overall impression\n\nReturn ONLY valid JSON, no markdown:\n{\"impact\":1-10,\"impact_why\":\"One sentence on the psychological impression this look makes\",\"vision\":\"3-4 sentence cinematic editorial description of the look\",\"color_story\":\"Analysis of color palette ‚Äî monochrome/complementary/analogous? Warm/cool balance? (2 sentences)\",\"fit_assessment\":\"How well do the clothes fit? Proportions correct? (1-2 sentences)\",\"works\":\"What specific elements create the strongest visual effect (1-2 sentences)\",\"risk\":\"Any clash, proportion issue, formality mismatch, or execution risk (1-2 sentences, or null if flawless)\",\"upgrade\":\"One specific change to elevate this look (1 sentence)\",\"strap_call\":\"Strap recommendation for the watch, or null if current is optimal (1 sentence)\",\"better_watch\":\"If a different watch from the collection would score higher, name it with ref and why (1 sentence, or null)\",\"watch_confidence\":1-10,\"watch_details\":\"What watch is visible and how it fits the outfit, or 'No watch visible' (1-2 sentences)\",\"items_detected\":[{\"type\":\"Top/Bottom/Shoes/Watch/Accessory\",\"color\":\"detected color\",\"description\":\"brief description\"}]}"}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="Selfie HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Selfie error: "+String(e.message||e).slice(0,120);return null}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPONENTS (OUTSIDE App) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Dot=memo(function DotC(props){
  var color=props.color,size=props.size||10;
  return React.createElement("span",{style:{width:size,height:size,borderRadius:"50%",flexShrink:0,display:"inline-block",background:(CM[color?color.toLowerCase():""]||{}).h||"#5a5a5a",border:color&&color.toLowerCase()==="black"?"1px solid #444":"none"}});
});

const Pill=memo(function PillC(props){
  return React.createElement("button",{onClick:props.onClick,style:{background:props.on?"var(--gold)":"var(--card)",border:"1px solid "+(props.on?"var(--gold)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",color:props.on?"var(--bg)":"#6a6474",fontFamily:"var(--f)",fontSize:11,fontWeight:props.on?600:400,whiteSpace:"nowrap",minHeight:36}},props.children);
});

const ColorGrid=memo(function ColorGridC(props){
  return React.createElement("div",null,CG.map(function(g){
    return React.createElement("div",{key:g.l,style:{marginBottom:10}},
      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",textTransform:"uppercase"}},g.l),
      React.createElement("div",{style:{display:"flex",gap:7,flexWrap:"wrap",marginTop:5}},
        g.c.map(function(c){return React.createElement("div",{key:c,onClick:function(){props.onChange(c)},className:"swatch "+(props.value===c?"on":""),style:{background:(CM[c]||{}).h||"#5a5a5a"},title:c})})));
  }));
});

const OutfitFigure=memo(function OutfitFigureC(props){
  var tc=(CM[props.topColor]||{}).h||"#5a5a5a";
  var bc=(CM[props.botColor]||{}).h||"#3a3a3a";
  var sc=(CM[props.shoeColor]||{}).h||"#2a2a2a";
  var wc=props.watchColor||"#c9a84c";
  var wi=props.watchIcon||"‚åö";
  var skin="#c8a882";
  return React.createElement("div",{style:{width:props.size||120,margin:"0 auto",position:"relative"}},
    React.createElement("svg",{viewBox:"0 0 120 220",width:props.size||120,height:Math.round((props.size||120)*220/120),style:{filter:"drop-shadow(0 4px 12px rgba(0,0,0,0.4))"}},
      /* Head */
      React.createElement("ellipse",{cx:60,cy:22,rx:14,ry:16,fill:skin}),
      /* Neck */
      React.createElement("rect",{x:54,y:36,width:12,height:8,fill:skin,rx:2}),
      /* Torso / shirt */
      React.createElement("path",{d:"M 36 44 Q 34 44 32 48 L 18 52 L 20 62 L 36 58 L 36 110 Q 36 114 40 114 L 80 114 Q 84 114 84 110 L 84 58 L 100 62 L 102 52 L 88 48 Q 86 44 84 44 Z",fill:tc,stroke:"rgba(255,255,255,0.08)",strokeWidth:0.5}),
      /* Collar detail */
      React.createElement("path",{d:"M 50 44 L 60 56 L 70 44",fill:"none",stroke:"rgba(255,255,255,0.15)",strokeWidth:1.5}),
      /* Left arm */
      React.createElement("path",{d:"M 36 58 L 22 62 L 18 90 L 24 92 L 30 68 L 36 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right arm */
      React.createElement("path",{d:"M 84 58 L 98 62 L 102 90 L 96 92 L 90 68 L 84 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left hand */
      React.createElement("ellipse",{cx:21,cy:93,rx:5,ry:4,fill:skin}),
      /* Right hand */
      React.createElement("ellipse",{cx:99,cy:93,rx:5,ry:4,fill:skin}),
      /* Watch on left wrist */
      React.createElement("rect",{x:15,y:84,width:12,height:10,rx:2,fill:wc,stroke:"rgba(255,255,255,0.2)",strokeWidth:0.5}),
      React.createElement("circle",{cx:21,cy:89,r:3,fill:"rgba(255,255,255,0.15)"}),
      /* Belt */
      React.createElement("rect",{x:36,y:112,width:48,height:5,fill:"#1a1a1a",rx:1}),
      React.createElement("rect",{x:57,y:113,width:6,height:3,rx:1,fill:"#c9a84c"}),
      /* Left leg */
      React.createElement("path",{d:"M 38 117 L 36 185 L 32 186 L 32 190 Q 32 192 34 192 L 48 192 Q 50 192 50 190 L 50 186 L 48 185 L 50 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right leg */
      React.createElement("path",{d:"M 70 117 L 72 185 L 70 186 L 70 190 Q 70 192 72 192 L 86 192 Q 88 192 88 190 L 88 186 L 84 185 L 82 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left shoe */
      React.createElement("path",{d:"M 30 188 L 30 196 Q 30 200 34 200 L 50 200 Q 54 200 54 196 L 54 192 L 48 192 L 34 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Right shoe */
      React.createElement("path",{d:"M 68 188 L 68 196 Q 68 200 72 200 L 88 200 Q 92 200 92 196 L 92 192 L 86 192 L 72 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Subtle fabric texture lines on shirt */
      React.createElement("line",{x1:45,y1:60,x2:45,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:55,y1:55,x2:55,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:65,y1:55,x2:65,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:75,y1:60,x2:75,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5})),
    /* Watch label */
    React.createElement("div",{style:{position:"absolute",left:-2,top:"38%",background:"rgba(0,0,0,0.6)",borderRadius:4,padding:"2px 5px",border:"1px solid "+wc+"60",display:"flex",alignItems:"center",gap:2}},
      React.createElement("span",{style:{fontSize:10}},wi),
      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:wc,fontWeight:600}},props.watchName||"")));
});

const WCard=memo(function WCardC(props){
  var w=props.w,rank=props.rank,detail=props.detail;
  var maxS=15;var pct=Math.max(0,Math.min(100,(w.score/maxS)*100));
  var barC=pct>60?"var(--good)":pct>30?"var(--gold)":"var(--warn)";
  return(
    React.createElement("div",{className:"card-lift",style:{background:rank===0?"var(--card2)":"var(--bg)",border:rank===0?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",borderRadius:12,padding:"14px"}},
      React.createElement("div",{style:{display:"flex",gap:10,alignItems:"flex-start"}},
        React.createElement("div",{style:{width:42,height:42,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"18",fontSize:20,flexShrink:0}},w.i),
        React.createElement("div",{style:{flex:1,minWidth:0}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{fontSize:14,fontWeight:600}},w.n),
            !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px"}},"REP"),
            rank===0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700,background:"rgba(201,168,76,0.1)",padding:"2px 6px",borderRadius:4}},"BEST")),
          (w.ref||w.size)&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:3,display:"flex",gap:6,flexWrap:"wrap"}},
            w.ref&&React.createElement("span",null,"Ref "+w.ref),
            w.size&&React.createElement("span",null,w.size+"mm"),
            w.mvmt&&React.createElement("span",null,w.mvmt)),
          React.createElement("div",{className:"score-bar",style:{marginBottom:6,width:"100%"}},React.createElement("div",{className:"score-fill",style:{width:pct+"%",background:barC}})),
          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:3,background:w.sr&&w.sr.type==="good"?"#1a2a1a":"var(--card)",borderRadius:6,padding:"4px 8px",border:"1px solid "+(w.sr&&w.sr.type==="good"?"#2a4a2a":"var(--border)")}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:w.sr&&w.sr.type==="good"?"var(--good)":"var(--sub)"}},w.sr?w.sr.text:(w.br?"‚õìÔ∏è Bracelet":"üîó Strap"))),
            w.sr&&w.sr.strap&&w.sr.strap.material&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",background:"var(--bg)",borderRadius:4,padding:"2px 6px",border:"1px solid var(--border)"}},w.sr.strap.material)),
          detail&&w.bd&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:4}},
            w.bd.ctx>0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"var(--badge-good)",color:"var(--good)",borderRadius:4,padding:"2px 6px"}},"‚úì ctx +"+w.bd.ctx),
            w.bd.color!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.color>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.color>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.color>0?"‚úì":"‚úó")+" color "+(w.bd.color>0?"+":"")+w.bd.color),
            w.bd.strap!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.strap>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.strap>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.strap>0?"‚úì":"‚úó")+" strap "+(w.bd.strap>0?"+":"")+w.bd.strap),
            w.bd.temp!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"var(--badge-neutral)",color:"var(--sub)",borderRadius:4,padding:"2px 6px"}},"üå°Ô∏è"+(w.bd.temp>0?"+":"")+w.bd.temp),
            w.bd.fresh&&w.bd.fresh!==0&&React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",background:w.bd.fresh>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.fresh>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},"üîÑ"+(w.bd.fresh>0?"+":"")+w.bd.fresh),
            w.bd.auth&&w.bd.auth>0&&React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",background:"var(--badge-good)",color:"var(--good)",borderRadius:4,padding:"2px 6px"}},"‚ú¶ genuine +"+w.bd.auth)),
          w.wn&&w.wn.map(function(x,i){return React.createElement("p",{key:i,style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",marginTop:3}},x)}))))
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL WRAPPER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Modal(props){
  useEffect(function(){document.body.classList.add("modal-open");return function(){document.body.classList.remove("modal-open")}},[]);
  return React.createElement("div",{className:"modal-backdrop",role:"dialog","aria-modal":true,onClick:function(e){if(e.target===e.currentTarget)props.onClose()}},
    React.createElement("div",{className:"modal-body"},
      React.createElement("div",{className:"modal-handle"}),props.children));
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAZY IMAGE ‚Äî native lazy + async decode ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var LazyImg=React.memo(function(props){
  return React.createElement("img",Object.assign({},props,{loading:"lazy",decoding:"async"}));
});


function genWeekRotation(watches,forecast,weekCtx,wardrobe,reps,wearLog,rotLock,lat){
  var DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var today=new Date().getDay();
  var plan=[];var used={};var lastId=null;
  var defCtx=["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"];
  /* Build days-since-worn map from log */
  var dsw={};var now=Date.now();
  if(wearLog&&wearLog.length){for(var e of wearLog){if(!dsw[e.watchId]||e.ts>dsw[e.watchId])dsw[e.watchId]=e.ts}}
  for(var d=0;d<7;d++){
    var dayIdx=(today+d)%7;var dayName=DAYS[dayIdx];
    var cx=(weekCtx&&weekCtx.length===7)?weekCtx[dayIdx]:defCtx[dayIdx];
    var fc=forecast&&forecast[d]?forecast[d]:null;
    var dayTier=fc?getWT(fc.feelsAvg):null;
    var dayWt=dayTier?dayTier.weight:"mid";
    /* Check if this day has a locked watch */
    var lockedId=rotLock&&rotLock[d]?rotLock[d]:null;
    var lockedWatch=lockedId?watches.find(function(w){return w.id===lockedId}):null;
    var pick;
    if(lockedWatch){
      pick=lockedWatch;
    }else{
      /* Score watches */
      var scored=watches.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"&&w.status!=="pending-trade"&&w.status!=="incoming"&&(reps||w.t!=="replica")}).map(function(w){
        var s=0;
        if(w.cx&&w.cx.includes(cx))s+=4;
        if(w.wt&&w.wt.includes(dayWt))s+=2;
        if(used[w.id])s-=8;
        if(w.id===lastId)s-=15; /* hard block consecutive same watch */
        if(plan.length>1&&plan[plan.length-2]&&plan[plan.length-2].watch&&plan[plan.length-2].watch.id===w.id)s-=10; /* 2-day minimum gap */
        /* ‚ïê‚ïê UPGRADE: Dial color variety ‚Äî penalize consecutive same dial color ‚ïê‚ïê */
        if(plan.length>0){var _prevW=plan[plan.length-1].watch;if(_prevW&&_prevW.d&&w.d&&_prevW.d.toLowerCase()===w.d.toLowerCase())s-=4}
        if(plan.length>1){var _prev2W=plan[plan.length-2]&&plan[plan.length-2].watch;if(_prev2W&&_prev2W.d&&w.d&&_prev2W.d.toLowerCase()===w.d.toLowerCase())s-=2}
        var types=plan.map(function(p){return p.watch?p.watch.t:""});
        var gc=types.filter(function(t){return t==="genuine"}).length;
        var rc=types.filter(function(t){return t==="replica"}).length;
        if(w.t==="genuine"&&rc>gc)s+=1;
        if(w.t==="replica"&&gc>rc)s+=1;
        var lastWorn=dsw[w.id];
        if(lastWorn){var daysAgo=Math.floor((now-lastWorn)/(24*60*60*1000));if(daysAgo<=1)s-=4;else if(daysAgo<=3)s-=1;else if(daysAgo>=7)s+=2;else if(daysAgo>=14)s+=3}
        else{s+=1}
        /* Weather condition scoring ‚Äî rain favors bracelets & rubber */
        var dayRain=fc&&fc.cond&&fc.cond.rain;
        if(dayRain){
          if(w.straps&&w.straps.length){
            var _hasWR=w.straps.some(function(s2){return s2.type==="bracelet"||s2.type==="rubber"||s2.type==="mesh"});
            var _onlyL=w.straps.every(function(s2){return s2.type==="leather"});
            if(_hasWR)s+=3;if(_onlyL)s-=2;
          }else{if(w.br)s+=3;else s-=2}
        }
        return Object.assign({},w,{rotScore:s});
      }).sort(function(a,b){return b.rotScore-a.rotScore});
      pick=scored[0]||null;
    }
    if(pick){used[pick.id]=true;lastId=pick.id}
    /* Generate top outfit for this day's watch+context+weather */
    var dayFit=null;var altFits=[];
    var dayWxOpts=fc?{rain:fc.cond&&fc.cond.rain,wind:fc.wind||0,uv:fc.uv||0,rainPct:fc.rainPct||0,lat:lat}:null;
    if(pick&&wardrobe&&wardrobe.filter(function(z){return!z.archived}).length>=2){
      var dayFits=genFits(wardrobe,[pick],cx,true,dayWt,4,{wx:dayWxOpts,temp:fc?fc.feelsAvg:18,wearLog:wearLog,lat:lat});
      if(dayFits.length)dayFit=dayFits[0];
      altFits=dayFits.slice(1,4);
    }
    plan.push({day:d,dayIdx:dayIdx,dayName:dayName,date:fc?fc.date:"",context:cx,tier:dayTier,weight:dayWt,watch:pick,forecast:fc,outfit:dayFit,altOutfits:altFits,locked:!!lockedWatch,
      strapPick:(function(){if(!pick)return null;var pw=pick.straps&&pick.straps.length?pick:migrateStraps(pick);if(pw.straps&&pw.straps.length>1&&dayFit)return strapRec(pw,dayFit.items,cx,dayWxOpts);if(pw.straps&&pw.straps.length===1)return{text:pw.straps[0].type==="bracelet"?"‚õìÔ∏è Bracelet"+(pw.straps[0].material?" ("+pw.straps[0].material+")":""):pw.straps[0].color+" "+pw.straps[0].type,type:"info",strap:pw.straps[0]};return null})()});
  }
  /* Cross-day dedup: if consecutive days share same top+bot, swap second day to alt */
  for(var dd=0;dd<plan.length-1;dd++){
    var a=plan[dd],b=plan[dd+1];
    if(a.outfit&&b.outfit&&a.outfit.top&&b.outfit.top&&a.outfit.bot&&b.outfit.bot&&a.outfit.top.id===b.outfit.top.id&&a.outfit.bot.id===b.outfit.bot.id){
      if(b.altOutfits&&b.altOutfits.length){var alt=b.altOutfits.find(function(af){return!af.top||!af.bot||af.top.id!==a.outfit.top.id||af.bot.id!==a.outfit.bot.id});if(alt){b.outfit=alt;b.altOutfits=b.altOutfits.filter(function(af){return af!==alt})}}
    }
  }
  return plan;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL ERROR HANDLERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener("unhandledrejection",function(e){console.error("Unhandled promise:",e.reason);e.preventDefault()});
window.addEventListener("error",function(e){console.error("Global error:",e.message)});
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ERROR BOUNDARY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
class ErrorBoundary extends React.Component{
  constructor(props){super(props);this.state={hasError:false,error:null}}
  static getDerivedStateFromError(error){return{hasError:true,error:error}}
  componentDidCatch(error,info){console.error("WatchAdvisor crashed:",error,info)}
  render(){
    if(this.state.hasError)return React.createElement("div",{style:{padding:40,textAlign:"center",fontFamily:"'JetBrains Mono',monospace",color:"#c9a84c",background:"#12101a",minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}},
      React.createElement("div",{style:{fontSize:48,marginBottom:16}},"‚ö†Ô∏è"),
      React.createElement("h2",{style:{margin:"0 0 12px",fontSize:18}},"Something went wrong"),
      React.createElement("p",{style:{color:"#999",fontSize:12,marginBottom:16,maxWidth:300}},String(this.state.error&&this.state.error.message||"Unknown error").slice(0,200)),
      React.createElement("button",{onClick:function(){window.location.reload()},style:{background:"linear-gradient(135deg,#c9a84c,#a8882a)",border:"none",borderRadius:10,padding:"12px 28px",cursor:"pointer",color:"#12101a",fontFamily:"'JetBrains Mono',monospace",fontSize:12,fontWeight:700}},"üîÑ Reload App"));
    return this.props.children;
  }
}

function App(){
  const[W,setW]=useState(DEFAULTS);
  const[wd,setWd]=useState([]);
  const[view,setView]=useState("wardrobe");
  /* ‚ïê‚ïê‚ïê NAVIGATION HISTORY (back/forward) ‚ïê‚ïê‚ïê */
  const navStack=useRef([]); /* back history */
  const navForward=useRef([]); /* forward history */
  const navPushingRef=useRef(false); /* flag to avoid re-entrant pushes from popstate */
  const viewRef=useRef("wardrobe");
  const selFitRef=useRef(null);
  /* Reactive counter ‚Äî increments on every nav change so buttons re-render */
  const[navVer,setNavVer]=useState(0);
  const canGoBack=navStack.current.length>0;
  const canGoFwd=navForward.current.length>0;
  const navTo=useCallback(function(newView,newSelFit){
    navStack.current.push({view:viewRef.current,selFit:selFitRef.current});
    navForward.current=[];
    if(!navPushingRef.current){try{window.history.pushState({idx:navStack.current.length},"","")}catch(e){console.warn("[WA]",e)}}
    viewRef.current=newView;selFitRef.current=newSelFit||null;
    setView(newView);setSelFit(newSelFit||null);setNavVer(function(v){return v+1});
  },[]);
  const navBack=useCallback(function(){
    if(!navStack.current.length)return;
    navForward.current.push({view:viewRef.current,selFit:selFitRef.current});
    var prev=navStack.current.pop();
    navPushingRef.current=true;
    viewRef.current=prev.view;selFitRef.current=prev.selFit||null;
    setView(prev.view);setSelFit(prev.selFit||null);setNavVer(function(v){return v+1});
    navPushingRef.current=false;
  },[]);
  const navFwd=useCallback(function(){
    if(!navForward.current.length)return;
    navStack.current.push({view:viewRef.current,selFit:selFitRef.current});
    var next=navForward.current.pop();
    navPushingRef.current=true;
    try{window.history.pushState({idx:navStack.current.length},"","")}catch(e){console.warn("[WA]",e)}
    viewRef.current=next.view;selFitRef.current=next.selFit||null;
    setView(next.view);setSelFit(next.selFit||null);setNavVer(function(v){return v+1});
    navPushingRef.current=false;
  },[]);
  /* Browser back button support */
  useEffect(function(){
    function onPop(e){
      if(navStack.current.length){
        navForward.current.push({view:viewRef.current,selFit:selFitRef.current});
        var prev=navStack.current.pop();
        navPushingRef.current=true;
        viewRef.current=prev.view;selFitRef.current=prev.selFit||null;
        setView(prev.view);setSelFit(prev.selFit||null);setNavVer(function(v){return v+1});
        navPushingRef.current=false;
      }
    }
    window.addEventListener("popstate",onPop);
    try{window.history.replaceState({idx:0},"","")}catch(e){console.warn("[WA]",e)}
    return function(){window.removeEventListener("popstate",onPop)};
  },[]);
  const[ctx,setCtx]=useState(["smart-casual"]);
  const[reps,setReps]=useState(true);
  const[proc,setProc]=useState([]);
  const[saved,setSaved]=useState([]);
  const[selFit,setSelFit]=useState(null);
  const[fitWatch,setFitWatch]=useState(null);
  const[wFilt,setWFilt]=useState("all");
  const[wMatFilt,setWMatFilt]=useState("all");
  const[weather,setWx]=useState(null);
  const[wxErr,setWxErr]=useState(false);
  const[loc,setLoc]=useState({lat:31.7683,lon:35.2137,name:"Jerusalem"});
  const[editG,setEditG]=useState(null);
  const[editW,setEditW]=useState(null);
  const[addG,setAddG]=useState(false);
  const[mode,setMode]=useState("auto");
  const[topType,setTopType]=useState("all");
  const[lockItem,setLockItem]=useState(null);
  const[shuffleKey,setShuffleKey]=useState(0);
  const[fitCount,setFitCount]=useState(12);
  const[buildSlot,setBuildSlot]=useState(null);
  /* Dynamic layers ‚Äî unlimited, renameable upper-body slots */
  const[buildLayers,setBuildLayers]=useState([{id:1,label:"BASE",item:null}]);
  const nextLayerId=useRef(2);
  const[bBot,setBBot]=useState(null);
  const[bShoe,setBShoe]=useState(null);
  const[bAcc,setBAcc]=useState(null);
  const[wTab,setWTab]=useState("all");
  const[wSearch,setWSearch]=useState("");
  const[aiErr,setAiErr]=useState("");
  const[apiKey,setApiKey]=useState("");
  const[recUser,setRecUser]=useState(function(){try{return localStorage.getItem("wa_rec_user")||""}catch(e){return""}});
  const[recPass,setRecPass]=useState("");
  const[recStatus,setRecStatus]=useState("");
  const[showSettings,setShowSettings]=useState(false);
  const[forecast,setForecast]=useState([]);
  const[planDay,setPlanDay]=useState(0);
  const[onboarded,setOnboarded]=useState(!IS_SHARED);
  const[onboardStep,setOnboardStep]=useState(1);
  const[obWatches,setObWatches]=useState([]);
  const[obGarments,setObGarments]=useState([]);
  const[weekCtx,setWeekCtx]=useState(IS_SHARED?["casual","smart-casual","smart-casual","smart-casual","smart-casual","smart-casual","weekend"]:["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"]);
  const[editRotCtx,setEditRotCtx]=useState(false);
  const[wearLog,setWearLog]=useState([]);
  const[aiCritique,setAiCritique]=useState(null);
  const[aiLoading,setAiLoading]=useState(false);
  const[dailyPick,setDailyPick]=useState(null);
  const[rotLock,setRotLock]=useState([null,null,null,null,null,null,null]);
  const[editDayIdx,setEditDayIdx]=useState(null);
  const[editDayMode,setEditDayMode]=useState(null);
  const[expandDay,setExpandDay]=useState(null);
  const[altSwap,setAltSwap]=useState({});
  const[wearPicker,setWearPicker]=useState(null);
  const[pieceSwap,setPieceSwap]=useState({});
  const[piecePicker,setPiecePicker]=useState(null);
  const[pieceFilter,setPieceFilter]=useState(null);
  const[dayAi,setDayAi]=useState({});
  const[dayAiLoading,setDayAiLoading]=useState(null);
  const[userCx,setUserCx]=useState(null);
  const[theme,setTheme]=useState("dark");
  const[buildName,setBuildName]=useState("");
  const[buildAiCritique,setBuildAiCritique]=useState(null);
  const[buildAiLoading,setBuildAiLoading]=useState(false);
  const[buildWatch,setBuildWatch]=useState(null);
  const[showDupes,setShowDupes]=useState(false);
  const[dupeGroups,setDupeGroups]=useState([]);
  const[wDupeGroups,setWDupeGroups]=useState([]);
  const[showWDupes,setShowWDupes]=useState(false);
  const[wColFilt,setWColFilt]=useState("all");
  const[showQuickWear,setShowQuickWear]=useState(false);
  const[savedView,setSavedView]=useState("list");
  const[showArchived,setShowArchived]=useState(false);
  const[gridLimit,setGridLimit]=useState(24);
  const reScanRef=useRef();
  const touchRef=useRef({sx:0,sy:0,swiping:false});
  const mainRef=useRef(null);
  var TABS=["wardrobe","fits","insights","watches","saved"];
  /* Passive swipe listeners ‚Äî cannot block scroll */
  useEffect(function(){
    var el=mainRef.current;if(!el)return;
    function onStart(e){
      if(e.touches.length!==1)return;
      touchRef.current={sx:e.touches[0].clientX,sy:e.touches[0].clientY,scrollY:window.scrollY,swiping:true};
    }
    function onEnd(e){
      if(!touchRef.current.swiping)return;
      var t=e.changedTouches[0];var dx=t.clientX-touchRef.current.sx;var dy=t.clientY-touchRef.current.sy;
      touchRef.current.swiping=false;
      if(Math.abs(window.scrollY-(touchRef.current.scrollY||0))>15)return;
      if(Math.abs(dx)<120||Math.abs(dy)>Math.abs(dx)*0.25)return;
      var ci=TABS.indexOf(view);if(ci<0)return;
      if(dx<-100&&ci<TABS.length-1)navTo(TABS[ci+1],null);
      else if(dx>100&&ci>0)navTo(TABS[ci-1],null);
    }
    el.addEventListener("touchstart",onStart,{passive:true});
    el.addEventListener("touchend",onEnd,{passive:true});
    return function(){el.removeEventListener("touchstart",onStart);el.removeEventListener("touchend",onEnd)};
  });
  useEffect(function(){
    /* Safety: remove modal-open if no modal is actually showing */
    var anyModal=showSettings||editG||lightboxSrc||showQuickWear||confirmDlg;
    if(!anyModal&&document.body.classList.contains("modal-open")){document.body.classList.remove("modal-open");document.body.style.top=""}
  });
  /* Auto-migrate new base64 photos to IDB */
  useEffect(function(){
    (async function(){var dirty=false;
      var wc=W.slice(),wdc=wd.slice();
      for(var it of wdc){if(it.photoUrl&&it.photoUrl.startsWith("data:")){it.photoUrl=await savePhoto("wd_"+it.id,it.photoUrl);dirty=true}}
      for(var w of wc){
        if(w.photoUrl&&w.photoUrl.startsWith("data:")){w.photoUrl=await savePhoto("w_"+w.id,w.photoUrl);dirty=true}
        if(w.straps)for(var j=0;j<w.straps.length;j++){if(w.straps[j].photoUrl&&w.straps[j].photoUrl.startsWith("data:")){w.straps[j].photoUrl=await savePhoto("w_"+w.id+"_s"+j,w.straps[j].photoUrl);dirty=true}}
      }
      if(dirty){setWd(wdc);ps("wd_"+SK,wdc);setW(wc);ps("w_"+SK,wc)}
    })();
  },[wd.length,W.length]);

  const[aiCoach,setAiCoach]=useState(null);
  const[aiCoachLoading,setAiCoachLoading]=useState(false);
  const[aiOccasion,setAiOccasion]=useState(null);
  const[aiOccasionLoading,setAiOccasionLoading]=useState(false);
  const[aiOccasionInput,setAiOccasionInput]=useState("");
  const[aiAudit,setAiAudit]=useState(null);
  const[aiAuditLoading,setAiAuditLoading]=useState(false);
  const[lightboxSrc,setLightboxSrc]=useState(null);
  const[lightboxItems,setLightboxItems]=useState([]);
  const[showSaveToast,setShowSaveToast]=useState(false);
  const[toast,setToast]=useState(null);
  const toastTmr=useRef(null);
  const[confirmDlg,setConfirmDlg]=useState(null);
  const showToast=useCallback(function(msg,color,dur){if(toastTmr.current)clearTimeout(toastTmr.current);setToast({msg:msg,color:color||"var(--good)"});toastTmr.current=setTimeout(function(){setToast(null);toastTmr.current=null},dur||2500)},[]);
  const[undoDelete,setUndoDelete]=useState(null); /* {outfit, timer} ‚Äî holds recently deleted outfit for undo */
  const undoTimerRef=useRef(null);
  const[watchScanLoading,setWatchScanLoading]=useState(false);
  const[watchScanResult,setWatchScanResult]=useState(null);
  const scanCancelRef=useRef(false);
  const[scanProg,setScanProg]=useState(null);
  const[selfieHistory,setSelfieHistory]=useState([]);
  const[selfieLoading,setSelfieLoading]=useState(false);
  const[selfieResult,setSelfieResult]=useState(null);
  const fRef=useRef();const cRef=useRef();const wPhotoRef=useRef();const wCamRef=useRef();
  const selfieRef=useRef();const selfieRearRef=useRef();const selfieGalRef=useRef();
  const apiKeyRef=useRef("");

  /* Storage: Claude.ai artifact has window.storage.set/get returning promises. Chrome's StorageManager is different. */
  const hasAS=(function(){try{return typeof window.storage==="object"&&typeof window.storage.set==="function"&&typeof window.storage.get==="function"&&window.storage!==navigator.storage}catch(e){return false}})();
  const ps=useCallback(async function(k,v){var j=JSON.stringify(v);try{if(hasAS){await window.storage.set(k,j)}else{localStorage.setItem(k,j)}}catch(e){try{localStorage.setItem(k,j)}catch(e2){if(e2.name==="QuotaExceededError"){console.warn("Storage quota exceeded for key:",k);throw e2}}}},[]);
  const loadKey=function(k){if(hasAS){return window.storage.get(k).then(function(r){return r&&r.value?JSON.parse(r.value):null}).catch(function(){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}})}try{var v=localStorage.getItem(k);return Promise.resolve(v?JSON.parse(v):null)}catch(e){return Promise.resolve(null)}};

  useEffect(function(){var sp=document.getElementById("splash");if(sp)sp.remove();(async function(){
    var wLoaded=false,wdLoaded=false,ofLoaded=false;
    // Load current version
    try{var p=await loadKey("w_"+SK);if(p&&p.length){setW(p.map(migrateStraps));wLoaded=true}}catch(e){console.warn("[WA]",e)}
    try{var p2=await loadKey("wd_"+SK);if(p2&&p2.length){setWd(p2);wdLoaded=true}}catch(e){console.warn("[WA]",e)}
    try{var p3=await loadKey("of_"+SK);if(p3&&p3.length){setSaved(p3);ofLoaded=true}}catch(e){console.warn("[WA]",e)}
    // Migrate from older versions (v12 first, then older)
    if(!wLoaded){for(var vk of["w_v12","w_v11","w_v9","watches_v8"]){try{var pm=await loadKey(vk);if(pm&&pm.length){var mw=pm.map(function(w){return migrateStraps(Object.assign({size:null,photoUrl:null},w))});setW(mw);ps("w_"+SK,mw);wLoaded=true;break}}catch(e){console.warn("[WA]",e)}}}
    if(!wdLoaded){for(var vk2 of["wd_v12","wd_v11","wd_v9","wd_v8"]){try{var pm2=await loadKey(vk2);if(pm2&&pm2.length){var mg=pm2.map(function(g){return Object.assign({material:null,seasons:[],positionHint:null,lastWorn:null},g)});setWd(mg);ps("wd_"+SK,mg);wdLoaded=true;break}}catch(e){console.warn("[WA]",e)}}}
    if(!wdLoaded&&WD_DEFAULTS.length){setWd(WD_DEFAULTS);ps("wd_"+SK,WD_DEFAULTS);wdLoaded=true}
    if(!ofLoaded){for(var vk3 of["of_v12","of_v11","of_v9","of_v8"]){try{var pm3=await loadKey(vk3);if(pm3&&pm3.length){setSaved(pm3);ps("of_"+SK,pm3);ofLoaded=true;break}}catch(e){console.warn("[WA]",e)}}}
    // Load API key
    try{var ak=await loadKey("wa_apikey");if(ak){var dk=decryptApiKey(ak);setApiKey(dk);apiKeyRef.current=dk;/* Auto-upgrade plaintext key to encrypted */if(!String(ak).startsWith("ENC:")){ps("wa_apikey",encryptApiKey(dk))}}}catch(e){console.warn("[WA]",e)}
    try{var wc=await loadKey("wa_weekctx");if(wc&&wc.length===7)setWeekCtx(wc)}catch(e){console.warn("[WA]",e)}
    try{var ucx=await loadKey("wa_usercx_"+SK);if(ucx&&ucx.length)setUserCx(ucx)}catch(e){console.warn("[WA]",e)}
    try{var wl=await loadKey("wa_wearlog_"+SK);if(wl&&wl.length)setWearLog(wl);else{for(var wlk of["wa_wearlog_v12","wa_wearlog_v11"]){try{var wlm=await loadKey(wlk);if(wlm&&wlm.length){setWearLog(wlm);ps("wa_wearlog_"+SK,wlm);break}}catch(e){console.warn("[WA]",e)}}}}catch(e){console.warn("[WA]",e)}
    try{var rl=await loadKey("wa_rotlock_"+SK);if(rl&&rl.length===7)setRotLock(rl);else{for(var rlk of["wa_rotlock_v12","wa_rotlock_v11"]){try{var rlm=await loadKey(rlk);if(rlm&&rlm.length===7){setRotLock(rlm);ps("wa_rotlock_"+SK,rlm);break}}catch(e){console.warn("[WA]",e)}}}}catch(e){console.warn("[WA]",e)}
    // Auto-onboard if existing data found
    if(wLoaded||wdLoaded)setOnboarded(true);
    /* ‚îÄ‚îÄ AUTO-CLEANUP: purge traded watches and ghost entries from localStorage ‚îÄ‚îÄ */
    /* Only runs once per version ‚Äî sets a flag so it doesn't repeat on every load */
    var _cleanedFlag="wa_cleaned_v23";
    var _alreadyCleaned=false;try{_alreadyCleaned=!!localStorage.getItem(_cleanedFlag)}catch(e){console.warn("[WA]",e)}
    if(wLoaded&&!IS_SHARED&&!_alreadyCleaned){
      setW(function(prev){
        /* Known traded/sold watch names and IDs to purge */
        var TRADED_NAMES=["sinn 613","rolex date 15203","sugess chronograph","seiko srph","sugess","srph"];
        var cleaned=prev.filter(function(w){
          /* Remove blank "New Watch" ghosts: default name + no dial color set */
          if(w.n==="New Watch"&&(!w.d||w.d===""))return false;
          /* Remove known traded watches by name match */
          var ln=(w.n||"").toLowerCase();
          for(var tn of TRADED_NAMES){if(ln.includes(tn))return false}
          return true;
        });
        if(cleaned.length!==prev.length){
                    ps("w_"+SK,cleaned);
        }
        try{localStorage.setItem(_cleanedFlag,"1")}catch(e){console.warn("[WA]",e)}
        return cleaned;
      });
    }
    try{var ob=await loadKey("wa_onboarded");if(ob)setOnboarded(true)}catch(e){console.warn("[WA]",e)}
    try{var th=await loadKey("wa_theme");if(th)setTheme(th)}catch(e){console.warn("[WA]",e)}
    try{var sh=await loadKey("wa_selfie_"+SK);if(sh&&sh.length)setSelfieHistory(sh)}catch(e){console.warn("[WA]",e)}
    /* ‚îÄ‚îÄ IDB photo migration + preload ‚îÄ‚îÄ */
    try{
      var _w2=W,_wd2=wd;
      if(!_w2||!_w2.length){try{_w2=await loadKey("w_"+SK)||[]}catch(e){_w2=[]}}
      if(!_wd2||!_wd2.length){try{_wd2=await loadKey("wd_"+SK)||[]}catch(e){_wd2=[]}}
      var wCh=await migrateToIDB(_w2,"w");var wdCh=await migrateToIDB(_wd2,"wd");
      if(wCh){setW(_w2);ps("w_"+SK,_w2)}
      if(wdCh){setWd(_wd2);ps("wd_"+SK,_wd2)}
      await preloadPhotos(_w2.concat(_wd2));
    }catch(e){console.warn("[IDB]",e)}
    // Cleanup old storage keys after successful migration
    var oldKeys=["w_v12","w_v11","w_v9","watches_v8","wd_v12","wd_v11","wd_v9","wd_v8","of_v12","of_v11","of_v9","of_v8","wa_wearlog_v12","wa_wearlog_v11","wa_rotlock_v12","wa_rotlock_v11","w_v13","wd_v13","of_v13","wa_wearlog_v13","wa_rotlock_v13"];
    setTimeout(function(){oldKeys.forEach(function(k){try{localStorage.removeItem(k)}catch(e){console.warn("[WA]",e)}})},3000);
  })()},[]);

  useEffect(function(){if(theme==="light")document.body.classList.add("light");else document.body.classList.remove("light");return function(){document.body.classList.remove("light")}},[theme]);
  useEffect(function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(function(p){setLoc({lat:p.coords.latitude,lon:p.coords.longitude,name:"Your Location"})},function(err){setLoc({lat:31.7683,lon:35.2137,name:"Jerusalem (default)"})},{timeout:8000,maximumAge:300000})}catch(e){console.warn("[WA]",e)}},[]);
  useEffect(function(){(async function(){try{var r=await fetch("https://api.open-meteo.com/v1/forecast?latitude="+loc.lat+"&longitude="+loc.lon+"&current=temperature_2m,apparent_temperature,wind_speed_10m,relative_humidity_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,weather_code,precipitation_probability_max,uv_index_max,wind_speed_10m_max&timezone=auto&forecast_days=7");var d=await r.json();if(d.current){var cwmo=getWMO(d.current.weather_code);setWx({temp:Math.round(d.current.temperature_2m),feels:Math.round(d.current.apparent_temperature),wind:Math.round(d.current.wind_speed_10m),hum:d.current.relative_humidity_2m,code:d.current.weather_code,cond:cwmo})}if(d.daily&&d.daily.time)setForecast(d.daily.time.map(function(dt,i){var wmo=getWMO(d.daily.weather_code?d.daily.weather_code[i]:0);return{date:dt,high:Math.round(d.daily.temperature_2m_max[i]),low:Math.round(d.daily.temperature_2m_min[i]),feelsHigh:Math.round(d.daily.apparent_temperature_max[i]),feelsLow:Math.round(d.daily.apparent_temperature_min[i]),feelsAvg:Math.round((d.daily.apparent_temperature_max[i]+d.daily.apparent_temperature_min[i])/2),code:d.daily.weather_code?d.daily.weather_code[i]:0,cond:wmo,rainPct:d.daily.precipitation_probability_max?d.daily.precipitation_probability_max[i]:0,uv:d.daily.uv_index_max?Math.round(d.daily.uv_index_max[i]):0,wind:d.daily.wind_speed_10m_max?Math.round(d.daily.wind_speed_10m_max[i]):0}}))}catch(e){console.error("Weather fetch failed:",e);setWxErr(true)}})()},[loc]);

  const tier=useMemo(function(){if(planDay===0&&weather)return getWT(weather.feels);if(planDay>0&&forecast[planDay])return getWT(forecast[planDay].feelsAvg);return weather?getWT(weather.feels):null},[weather,forecast,planDay]);
  const ww=tier?tier.weight:"mid";
  const planTemp=useMemo(function(){if(planDay===0&&weather)return{temp:weather.temp,feels:weather.feels};if(forecast[planDay])return{temp:Math.round((forecast[planDay].high+forecast[planDay].low)/2),feels:forecast[planDay].feelsAvg};return weather?{temp:weather.temp,feels:weather.feels}:null},[weather,forecast,planDay]);
  const planWx=useMemo(function(){
    if(planDay===0&&weather)return{rain:weather.cond&&weather.cond.rain,wind:weather.wind,uv:0,cond:weather.cond||null,rainPct:0,lat:loc.lat};
    var fc=forecast[planDay];if(fc)return{rain:fc.cond&&fc.cond.rain,wind:fc.wind,uv:fc.uv,cond:fc.cond||null,rainPct:fc.rainPct||0,lat:loc.lat};
    return null;
  },[weather,forecast,planDay,loc]);
  const effectiveCtx=useMemo(function(){
    if(planDay>0){var dayIdx=(new Date().getDay()+planDay)%7;var wc=weekCtx[dayIdx];return wc?[wc]:ctx}
    return ctx;
  },[planDay,weekCtx,ctx]);
  const primaryCtx=useMemo(function(){return Array.isArray(effectiveCtx)?effectiveCtx[0]||"smart-casual":effectiveCtx},[effectiveCtx]);
  const ctxSet=useMemo(function(){return new Set(Array.isArray(effectiveCtx)?effectiveCtx:[effectiveCtx])},[effectiveCtx]);
  const activeCx=useMemo(function(){return userCx||(IS_SHARED?SHARE_DEFAULT_CX:DEFAULT_CX)},[userCx]);
  const activeCxIds=useMemo(function(){return activeCx.map(function(c){return c.id})},[activeCx]);
  const activeCxIcons=useMemo(function(){var m={};activeCx.forEach(function(c){m[c.id]=c.icon});return m},[activeCx]);
  const actW=useMemo(function(){return W.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"&&w.status!=="pending-trade"&&w.status!=="incoming"})},[W]);
  const byCat=useMemo(function(){return{tops:wd.filter(function(i){return catOf(i.garmentType)==="tops"}),bottoms:wd.filter(function(i){return catOf(i.garmentType)==="bottoms"}),shoes:wd.filter(function(i){return catOf(i.garmentType)==="shoes"}),accessories:wd.filter(function(i){return catOf(i.garmentType)==="accessories"||catOf(i.garmentType)==="other"})}},[wd]);
  /* Memoized filtered+sorted wardrobe for grid ‚Äî avoids recomputing on every unrelated state change */
  const filteredWd=useMemo(function(){var arr=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});if(wMatFilt!=="all")arr=arr.filter(function(i){return i.material===wMatFilt});if(wColFilt!=="all")arr=arr.filter(function(i){return i.color===wColFilt});if(!showArchived)arr=arr.filter(function(i){return!i.archived});return arr.slice().sort(function(a,b){return(b.ts||0)-(a.ts||0)})},[wd,wFilt,wMatFilt,wColFilt,showArchived]);
  const wdStats=useMemo(function(){var at=byCat.tops.filter(function(i){return!i.archived}).length;var ab=byCat.bottoms.filter(function(i){return!i.archived}).length;var as=byCat.shoes.filter(function(i){return!i.archived}).length;var arch=wd.filter(function(i){return i.archived}).length;var mc={};wd.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var ms=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,3);var matStr=ms.length?" ¬∑ "+ms.map(function(e){return e[0]+" √ó"+e[1]}).join(", "):"";var nfIds=new Set();saved.forEach(function(o){(o.items||[]).forEach(function(it){nfIds.add(it.id)})});var unused=wd.filter(function(i){return i.color&&!i.needsEdit&&!nfIds.has(i.id)}).length;var worn=wd.filter(function(i){return i.lastWorn});var fresh=0,mid=0,stale=0;var now=Date.now();worn.forEach(function(i){var d=Math.floor((now-new Date(i.lastWorn).getTime())/864e5);if(d<=3)fresh++;else if(d<=14)mid++;else stale++});return{summary:at+" tops ¬∑ "+ab+" bottoms ¬∑ "+as+" shoes"+(arch?" ¬∑ "+arch+" archived":"")+matStr,unused:unused,fresh:fresh,mid:mid,stale:stale,hasWorn:worn.length>0}},[byCat,wd,saved]);
  const fits=useMemo(function(){return wd.length<2?[]:genFits(wd,actW,effectiveCtx,reps,ww,fitCount,{topType:topType,lockItem:lockItem,shuffle:shuffleKey>0,wx:planWx,temp:planTemp?planTemp.feels:18,wearLog:wearLog,lat:loc.lat})},[wd,actW,effectiveCtx,reps,ww,topType,lockItem,shuffleKey,fitCount,planWx,planTemp,loc]);
  const buildFit=useMemo(function(){var layerItems=buildLayers.map(function(l){return l.item}).filter(Boolean);var items=layerItems.concat([bBot,bShoe,bAcc]).filter(Boolean);return items.length>=2?makeOutfit(items,actW,effectiveCtx,reps,planWx,planTemp?planTemp.feels:18):null},[buildLayers,bBot,bShoe,bAcc,actW,effectiveCtx,reps,planWx,planTemp]);
  const needsFix=useMemo(function(){return wd.filter(function(i){return i.needsEdit||!i.color}).length},[wd]);

  const findDuplicates=useCallback(function(){
    var classified=wd.filter(function(i){return i.color&&!i.needsEdit});
    var groups={};
    classified.forEach(function(item){
      var key=item.garmentType+"_"+item.color.toLowerCase()+(item.pattern&&item.pattern!=="solid"?"_"+item.pattern:"");
      if(!groups[key])groups[key]=[];
      groups[key].push(item);
    });
    /* Also check items with same name */
    classified.forEach(function(item){
      if(!item.name)return;
      var nameKey="name_"+item.name.toLowerCase().trim();
      if(!groups[nameKey])groups[nameKey]=[];
      var already=groups[nameKey].some(function(g){return g.id===item.id});
      if(!already)groups[nameKey].push(item);
    });
    /* Color family grouping: catch "navy chinos" vs "navy pants" */
    var catGroups={};
    classified.forEach(function(item){
      var cat=catOf(item.garmentType);
      var colorFam=getColorFamily((item.color||"").toLowerCase())||item.color;
      var famKey="fam_"+cat+"_"+colorFam+(item.pattern&&item.pattern!=="solid"?"_"+item.pattern:"");
      if(!catGroups[famKey])catGroups[famKey]=[];
      catGroups[famKey].push(item);
    });
    Object.keys(catGroups).forEach(function(k){if(catGroups[k].length>=2&&!groups[k])groups[k]=catGroups[k]});
    /* Deduplicate: remove groups where all items already appear in another group */
    var allGroups=Object.values(groups).filter(function(g){return g.length>=2});
    var seen={};var unique=[];
    allGroups.forEach(function(g){
      var ids=g.map(function(i){return i.id}).sort().join(",");
      if(!seen[ids]){seen[ids]=true;unique.push(g)}
    });
    return unique;
  },[wd]);

  /* Watch duplicate detection */
  const findWatchDupes=useCallback(function(){
    var groups={};
    /* Group by normalized name */
    W.forEach(function(w){
      var normName=w.n.toLowerCase().replace(/[^a-z0-9]/g,"");
      var key="name_"+normName;
      if(!groups[key])groups[key]=[];
      groups[key].push(w);
    });
    /* Group by dial color + type */
    W.forEach(function(w){
      var key2="dial_"+w.t+"_"+(w.d||"").toLowerCase().replace(/[^a-z0-9]/g,"");
      if(!groups[key2])groups[key2]=[];
      var already=groups[key2].some(function(g){return g.id===w.id});
      if(!already)groups[key2].push(w);
    });
    /* Group by fuzzy name similarity (contains check) */
    for(var i=0;i<W.length;i++){
      for(var j=i+1;j<W.length;j++){
        var a=W[i].n.toLowerCase(),b=W[j].n.toLowerCase();
        if(a.length>7&&b.length>7&&(a.includes(b.substring(0,8))||b.includes(a.substring(0,8)))){
          var fk="fuzzy_"+[W[i].id,W[j].id].sort().join("_");
          if(!groups[fk])groups[fk]=[W[i],W[j]];
        }
      }
    }
    /* Filter to groups with 2+ items, dedup */
    var allGroups=Object.values(groups).filter(function(g){return g.length>=2});
    var seen={};var unique=[];
    allGroups.forEach(function(g){
      var ids=g.map(function(w){return w.id}).sort().join(",");
      if(!seen[ids]){seen[ids]=true;unique.push(g)}
    });
    return unique;
  },[W]);

  const saveAll=useCallback(async function(){
    try{
      await ps("w_"+SK,W);await ps("wd_"+SK,wd);await ps("of_"+SK,saved);
      await ps("wa_wearlog_"+SK,wearLog);await ps("wa_weekctx",weekCtx);
      if(userCx)await ps("wa_usercx_"+SK,userCx);
      await ps("wa_theme",theme);
      await ps("wa_selfie_"+SK,selfieHistory);
      await ps("wa_rotlock_"+SK,rotLock);
      setShowSaveToast(true);
      setTimeout(function(){setShowSaveToast(false)},2000);
    }catch(e){console.error("Save failed:",e);showToast("Save failed: "+String(e.message||e),"var(--warn)",4000)}
  },[W,wd,saved,wearLog,weekCtx,userCx,theme,selfieHistory,rotLock,ps]);

  const openLightbox=useCallback(function(src,itemId){
    if(!src)return;
    setLightboxSrc(src);
    var items=wd.filter(function(i){return ph(i.photoUrl)===src||i.photoUrl===src});
    setLightboxItems(items.length>1?items:itemId?wd.filter(function(i){return i.id===itemId}):[]);
  },[wd]);

  const updateW=useCallback(function(id,u){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,u):w});ps("w_"+SK,n);return n})},[ps]);
  const toggleW=useCallback(function(id){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,{active:!w.active}):w});ps("w_"+SK,n);return n})},[ps]);
  const removeW=useCallback(function(id){setW(function(p){var n=p.filter(function(w){return w.id!==id});ps("w_"+SK,n);return n})},[ps]);

  const saveWd=useCallback(function(n){clearCompatCache();setWd(n);ps("wd_"+SK,n)},[ps]);
  const rmG=useCallback(function(id){clearCompatCache();setWd(function(p){var n=p.filter(function(i){return i.id!==id});ps("wd_"+SK,n);return n})},[ps]);
  const updG=useCallback(function(id,u){clearCompatCache();setWd(function(p){var n=p.map(function(i){return i.id===id?Object.assign({},i,u,{needsEdit:false}):i});ps("wd_"+SK,n);return n})},[ps]);
  const addGarment=useCallback(function(item){clearCompatCache();setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n})},[ps]);

  const logWear=useCallback(function(watchId,dateStr){
    setWearLog(function(p){
      /* Remove existing entry for same date, then add new */
      var n=p.filter(function(e){return e.date!==dateStr}).concat([{date:dateStr,watchId:watchId,ts:Date.now()}]);
      /* Keep last 365 days for seasonal analysis */
      var cutoff=Date.now()-365*24*60*60*1000;
      n=n.filter(function(e){return e.ts>cutoff});
      ps("wa_wearlog_"+SK,n);return n;
    });
  },[ps]);
  const undoWear=useCallback(function(dateStr){
    setWearLog(function(p){var n=p.filter(function(e){return e.date!==dateStr});ps("wa_wearlog_"+SK,n);return n});
  },[ps]);
  const daysSince=useCallback(function(watchId){
    var now=Date.now();var last=null;
    for(var e of wearLog){if(e.watchId===watchId&&(!last||e.ts>last))last=e.ts}
    if(!last)return 999;
    return Math.floor((now-last)/(24*60*60*1000));
  },[wearLog]);
  const todayStr=new Date().toISOString().slice(0,10);
  const todayWorn=wearLog.find(function(e){return e.date===todayStr});

  const _processingRef=useRef(false);
  const processFiles=useCallback(async function(files){
    if(_processingRef.current){setAiErr("Already processing files, please wait...");return}
    _processingRef.current=true;
    var arr=Array.from(files);var pids=arr.map(function(_,i){return Date.now()+i});
    setProc(function(p){return p.concat(pids)});
    for(var i=0;i<arr.length;i++){
      var f=arr[i],pid=pids[i];
      try{
        var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(f)});
        /* High-res for storage display, moderate for AI API submission */
        var compressed=await compressImage(rawUrl,800,0.7);
        var thumb=await compressImage(rawUrl,1200,0.82);
        var b64=compressed.split(",")[1];
        var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
        if(aiResult&&Array.isArray(aiResult)&&aiResult.length>0){
          var newItems=aiResult.map(function(ai,idx){var sd=smartDefaults(ai);return Object.assign({},sd,ai,{photoUrl:thumb,id:pid+idx,ts:Date.now(),positionHint:aiResult.length>1?(ai.position||null):null,material:ai.material||null})});
          setWd(function(p){var n=p.concat(newItems);ps("wd_"+SK,n);return n});
          if(aiResult.length>1)setAiErr("üì∏ Found "+aiResult.length+" items in photo");
        }else{
          var item={garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb,id:pid,needsEdit:true,ts:Date.now(),aiError:getLastAiError()};
          setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n});
          setAiErr(getLastAiError());
        }
      }catch(e){
        try{var thumb2=await compressImage(await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(f)}),1200,0.82);
        setWd(function(p){var n=p.concat([{garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb2,id:pid,needsEdit:true,ts:Date.now(),aiError:"FileReader: "+String(e)}]);ps("wd_"+SK,n);return n})}catch(e2){console.warn("[WA]",e2)}
        setAiErr("File error: "+String(e));
      }
      setProc(function(p){return p.filter(function(x){return x!==pid})});
      // Delay between items to avoid rate limit
      if(i<arr.length-1)await new Promise(function(r){setTimeout(r,600)});
    }
    _processingRef.current=false;
  },[ps]);

  const scanWatch=useCallback(async function(files){
    var arr=Array.isArray(files)?files:files instanceof FileList?Array.from(files):files?[files]:[];
    if(!arr.length)return;
    if(arr.length>10){showToast("Max 10 images at once (selected "+arr.length+")","var(--warn)",3000);arr=arr.slice(0,10)}
    scanCancelRef.current=false;
    setWatchScanLoading(true);setWatchScanResult(null);setScanProg(arr.length>1?{c:0,t:arr.length}:null);
    var scannedWatches=[];var errs=[];
    try{
      for(var fi=0;fi<arr.length;fi++){
        try{
          var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=function(){j(x.error||new Error("Read failed"))};x.readAsDataURL(arr[fi])});
          var compressed=await compressImage(rawUrl,600,0.6);
          var thumb=await compressImage(rawUrl,400,0.5);
          var b64=compressed.split(",")[1];
          var result=await aiWatchID(b64,"image/jpeg",apiKeyRef.current);
          if(result&&result.brand){
            var id=(crypto&&crypto.randomUUID)?crypto.randomUUID():("scan-"+Date.now()+"-"+fi);
            var dialInfo=inferDial(result.brand+" "+result.model,result.dial_color||"");
            var mc=autoMatchColors(result.dial_color||dialInfo.color);
            var straps=[];
            if(result.has_bracelet||result.strap_type==="bracelet"){straps.push({type:"bracelet",color:"silver",material:result.case_material||"steel"})}
            if(result.strap_type&&result.strap_type!=="bracelet"){straps.push({type:result.strap_type==="nato"?"nato":result.strap_type==="rubber"?"rubber":result.strap_type==="canvas"?"canvas":"leather",color:result.strap_color||"black",material:result.strap_type||"calf leather"})}
            if(!straps.length)straps.push({type:"bracelet",color:"silver",material:"steel"});
            var nw={id:id,n:(result.brand||"")+" "+(result.model||""),t:"genuine",d:result.dial_color||dialInfo.color||"",c:result.dial_hex||dialInfo.hex||"#5a5a5a",straps:straps,br:straps.some(function(s){return s.type==="bracelet"}),sc:straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color}),mt:result.temperature||"neutral",i:result.emoji||dialInfo.emoji||"‚åö",mc:mc,ac:[],cx:result.suggested_contexts||inferContexts(result.brand+" "+result.model,""),wt:["light","mid","heavy"],sg:result.notes||"",active:true,status:"active",photoUrl:thumb,size:result.case_size?result.case_size+"mm":null,ref:result.reference||null,scanData:result};
            scannedWatches.push({watch:nw,ai:result});
          }else{errs.push({fi:fi,error:getLastAiError()||"Could not identify watch"})}
        }catch(e){errs.push({fi:fi,error:"Error: "+String((e&&e.message)||e)})}
        if(arr.length>1)setScanProg({c:fi+1,t:arr.length});
        if(fi<arr.length-1){if(scanCancelRef.current)break;await new Promise(function(r){setTimeout(r,600)})}
      }
      if(arr.length===1){
        if(scannedWatches.length){setWatchScanResult(scannedWatches[0])}
        else{var msg=(errs[0]&&errs[0].error)||getLastAiError()||"Could not identify watch";setWatchScanResult({error:msg});setAiErr(msg)}
      }else{
        if(scannedWatches.length){
          var newW=scannedWatches.map(function(s){return s.watch});
          setW(function(p){var u=p.concat(newW);ps("w_"+SK,u);return u});
          setWatchScanResult({batch:true,count:scannedWatches.length,watches:scannedWatches,failed:errs});
          showToast("‚úÖ Added "+scannedWatches.length+" watches","var(--good)",3000);
        }else{
          var msg2=getLastAiError()||"No watches identified in "+arr.length+" images";
          setWatchScanResult({batch:true,error:msg2,failed:errs});setAiErr(msg2);
        }
      }
    }finally{setWatchScanLoading(false);setScanProg(null)}
  },[ps]);

  const checkSelfie=useCallback(async function(file){
    setSelfieLoading(true);setSelfieResult(null);
    try{
      var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(file)});
      var compressed=await compressImage(rawUrl,800,0.7);
      var thumb=await compressImage(rawUrl,600,0.7);
      var b64=compressed.split(",")[1];
      var result=await aiSelfieCheck(b64,"image/jpeg",apiKeyRef.current,W,null,effectiveCtx);
      if(result&&result.impact){
        var entry={id:Date.now(),ts:Date.now(),thumb:thumb,result:result,impact:result.impact};
        setSelfieResult(entry);
        setSelfieHistory(function(p){var n=[entry].concat(p).slice(0,20);ps("wa_selfie_"+SK,n);return n});
      }else{
        setSelfieResult({error:getLastAiError()||"Could not analyze photo"});
        setAiErr(getLastAiError()||"Selfie analysis failed");
      }
    }catch(e){
      setSelfieResult({error:"Error: "+String(e.message||e)});
      setAiErr("Selfie error: "+String(e));
    }
    setSelfieLoading(false);
  },[ps,W,effectiveCtx]);

  const delSelfie=useCallback(function(id){
    setSelfieHistory(function(p){var n=p.filter(function(e){return e.id!==id});ps("wa_selfie_"+SK,n);return n});
  },[ps]);

  const saveFit=useCallback(function(fit){var wxSnap=planTemp&&planWx?{temp:planTemp.temp,cond:planWx.cond,rain:planWx.rain}:null;var o={id:Date.now(),name:(function(){var _ly=fit.layers&&fit.layers.length>1?fit.layers:[fit.top].filter(Boolean);var _tn=_ly.map(function(t){return t.name||t.color}).join(" ‚Üí ");return(_tn||"?")+" + "+(fit.bot?fit.bot.name||fit.bot.color:"?")}()),items:fit.items,context:Array.isArray(effectiveCtx)?effectiveCtx.slice():effectiveCtx,watches:fit.watches,fs:fit.fs,ts:Date.now(),weather:wxSnap};setSaved(function(p){var n=p.concat([o]);ps("of_"+SK,n);return n});/* Auto-update lastWorn on garments */var todayISO=new Date().toISOString().slice(0,10);var itemIds=new Set((fit.items||[]).map(function(it){return it.id}));setWd(function(prev){var changed=false;var nw=prev.map(function(g){if(itemIds.has(g.id)){changed=true;return Object.assign({},g,{lastWorn:todayISO})}return g});if(changed)ps("wd_"+SK,nw);return changed?nw:prev})},[effectiveCtx,ps,planTemp,planWx]);
  const delSaved=useCallback(function(id){
    /* Soft delete: remove from UI immediately, but hold the outfit for 5s undo window */
    var deleted=null;
    setSaved(function(p){deleted=p.find(function(o){return o.id===id});var n=p.filter(function(o){return o.id!==id});ps("of_"+SK,n);return n});
    /* Cancel any existing undo timer */
    if(undoTimerRef.current){clearTimeout(undoTimerRef.current);undoTimerRef.current=null}
    /* Show undo toast with the deleted outfit */
    setUndoDelete({outfit:deleted,id:id});
    undoTimerRef.current=setTimeout(function(){setUndoDelete(null);undoTimerRef.current=null},5000);
  },[ps]);
  const undoDeleteFn=useCallback(function(){
    if(!undoDelete||!undoDelete.outfit)return;
    if(undoTimerRef.current){clearTimeout(undoTimerRef.current);undoTimerRef.current=null}
    var restored=undoDelete.outfit;
    setSaved(function(p){var n=p.concat([restored]);ps("of_"+SK,n);return n});
    setUndoDelete(null);
  },[undoDelete,ps]);

  const setOutfitWear=useCallback(function(id,dateStr){
    setSaved(function(p){
      var n=p.map(function(o){
        if(o.id!==id)return o;
        var u=Object.assign({},o);
        if(dateStr){u.wearDate=dateStr}else{delete u.wearDate}
        return u;
      });
      ps("of_"+SK,n);
      /* If wearing today, also log watch to wearLog */
      var todayISO=new Date().toISOString().slice(0,10);
      if(dateStr===todayISO){
        var outfit=p.find(function(o){return o.id===id});
        if(outfit&&outfit.watches&&outfit.watches.length){
          var wId=outfit.watches[0].id;
          if(wId){setWearLog(function(prev){
            var already=prev.find(function(e){return e.date===todayISO&&e.watchId===wId});
            if(already)return prev;
            var entry={watchId:wId,date:todayISO,ts:Date.now(),outfitId:id};
            var next=prev.concat([entry]);
            ps("wa_wearlog_"+SK,next);
            return next;
          })}
        }
      }
      return n;
    });
    setWearPicker(null);
  },[ps]);

  /* ‚ïê‚ïê‚ïê Per-piece swap helpers ‚ïê‚ïê‚ïê */
  const getEP=useCallback(function(di,slot,orig){if(!orig&&!pieceSwap[di+"-"+slot])return null;var k=di+"-"+slot;return pieceSwap[k]||orig},[pieceSwap]);
  const slotAlts=useCallback(function(slot){
    var cat=slot==="top"?"tops":slot==="bot"?"bottoms":"shoes";
    return wd.filter(function(it){return catOf(it.garmentType)===cat});
  },[wd]);
  const slotColors=useCallback(function(slot){
    var items=slotAlts(slot);
    var seen={};items.forEach(function(it){if(it.color)seen[it.color]=1});
    return Object.keys(seen).sort();
  },[slotAlts]);
  const slotPatterns=useCallback(function(slot){
    var items=slotAlts(slot);
    var seen={};items.forEach(function(it){if(it.pattern&&it.pattern!=="solid")seen[it.pattern]=1});
    return Object.keys(seen).sort();
  },[slotAlts]);
  const filteredAlts=useCallback(function(slot,curId){
    var items=slotAlts(slot).filter(function(a){return a.id!==curId});
    if(!pieceFilter)return items;
    if(pieceFilter.startsWith("p:"))return items.filter(function(a){return a.pattern===pieceFilter.slice(2)});
    return items.filter(function(a){return a.color===pieceFilter});
  },[slotAlts,pieceFilter]);

  const CTXS=useMemo(function(){return activeCx.slice(0,8).map(function(c){return{id:c.id,l:c.icon+" "+c.l}})},[activeCx]);
  const filtW=useMemo(function(){var base=wTab==="all"?W:wTab==="genuine"?W.filter(function(w){return w.t==="genuine"}):wTab==="replica"?W.filter(function(w){return w.t==="replica"}):W.filter(function(w){return w.status===wTab});if(!wSearch.trim())return base;var q=wSearch.trim().toLowerCase();return base.filter(function(w){return(w.n||"").toLowerCase().includes(q)||(w.d||"").toLowerCase().includes(q)||(w.ref||"").toLowerCase().includes(q)||(w.movement||"").toLowerCase().includes(q)})},[W,wTab,wSearch]);

  /* ‚ïê‚ïê‚ïê GARMENT EDIT (rendered in modal) ‚ïê‚ïê‚ïê */
  function renderGarmentEdit(item){
    var GE=function(){
      const[f,setF]=useState(Object.assign({},item));
      const[retrying,setRetrying]=useState(false);
      /* Track whether user has manually edited the name */
      const userEditedName=useRef(false);
      var set=function(k,v){setF(function(p){
        var o={};o[k]=v;var next=Object.assign({},p,o);
        /* Auto-rename when color, material, or garmentType changes ‚Äî only if name looks auto-generated */
        if((k==="color"||k==="material"||k==="garmentType")&&!userEditedName.current){
          if(isAutoName(p.name,p.color,p.material,p.garmentType)){
            next.name=buildGarmentName(next.color,next.material,next.garmentType);
          }
        }
        if(k==="name")userEditedName.current=true;
        return next;
      })};
      var retry=async function(){
        if(!item.photoUrl)return;setRetrying(true);
        try{var _raw=item.photoUrl.startsWith("idb:")?await photoAsDataUrl(item.photoUrl):item.photoUrl;if(!_raw){setRetrying(false);return}var compressed=await compressImage(_raw,800,0.7);var b64=compressed.split(",")[1];
          var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
          if(aiResult&&aiResult.length){var first=aiResult[0];setF(function(p){return Object.assign({},p,first)})}
          else showToast(getLastAiError()||"AI couldn't identify. Classify manually.","var(--warn)",3500)}catch(e){showToast("Retry error: "+e,"var(--warn)",3000)}
        setRetrying(false);
      };
      return React.createElement(Modal,{onClose:function(){setEditG(null)}},
        React.createElement("div",{style:{display:"flex",gap:14,marginBottom:16}},
          f.photoUrl&&React.createElement("img",{src:ph(f.photoUrl),alt:"",decoding:"async",onClick:function(){openLightbox(f.photoUrl,item.id)},style:{width:80,height:80,objectFit:"cover",borderRadius:12,flexShrink:0,cursor:"zoom-in"}}),
          React.createElement("div",{style:{flex:1}},
            React.createElement("label",{className:"lbl"},"Name"),
            React.createElement("input",{className:"inp",value:f.name||"",onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy plaid flannel"}))),
        React.createElement("label",{className:"lbl"},"Garment Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:6}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)}),
          f.garmentType&&!ALL_T.includes(f.garmentType)&&React.createElement("span",{className:"chip on",style:{borderColor:"var(--gold)"}},f.garmentType)),
        React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center",marginBottom:14}},
          React.createElement("input",{className:"inp",value:ALL_T.includes(f.garmentType)?"":(f.garmentType||""),onChange:function(e){set("garmentType",e.target.value)},placeholder:"Custom type (e.g. Henley, Bomber...)",style:{fontSize:10,padding:"6px 8px",marginBottom:0,flex:1}})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},
          f.color&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:8}},React.createElement(Dot,{color:f.color,size:14}),React.createElement("span",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:500}},f.color)),
          React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:14}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){set("material",f.material===m?null:m)},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("label",{className:"lbl"},"Seasons"),
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:16}},
          ["spring","summer","fall","winter"].map(function(s){var icons={spring:"üå∏",summer:"‚òÄÔ∏è",fall:"üçÇ",winter:"‚ùÑÔ∏è"};var arr=f.seasons||[];var on=arr.includes(s);return React.createElement("span",{key:s,className:"chip "+(on?"on":""),onClick:function(){set("seasons",on?arr.filter(function(x){return x!==s}):arr.concat([s]))},style:{flex:1,justifyContent:"center",padding:"6px 4px",fontSize:10}},icons[s]+" "+s)})),
        /* Archive toggle */
        React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:14,padding:"8px 12px",background:f.archived?"rgba(200,90,58,0.08)":"var(--bg)",borderRadius:8,border:"1px solid "+(f.archived?"rgba(200,90,58,0.2)":"var(--border)")}},
          React.createElement("span",{style:{fontSize:14}},f.archived?"‚ùÑÔ∏è":"üëÅÔ∏è"),
          React.createElement("span",{style:{flex:1,fontSize:11,fontFamily:"var(--f)",color:f.archived?"var(--warn)":"var(--sub)"}},f.archived?"Archived ‚Äî hidden from scoring & grid":"Active in rotation"),
          React.createElement("button",{onClick:function(){set("archived",!f.archived)},style:{background:f.archived?"rgba(122,184,122,0.12)":"rgba(200,90,58,0.08)",border:"1px solid "+(f.archived?"rgba(122,184,122,0.25)":"rgba(200,90,58,0.2)"),borderRadius:6,padding:"5px 12px",cursor:"pointer",color:f.archived?"var(--good)":"var(--warn)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:26}},f.archived?"Activate":"Archive")),
        React.createElement("label",{className:"lbl"},"Last Worn"),
        React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:14}},
          React.createElement("input",{className:"inp",type:"date",value:f.lastWorn||"",onChange:function(e){set("lastWorn",e.target.value)},style:{marginBottom:0,maxWidth:180,fontSize:11,flex:1}}),
          React.createElement("button",{onClick:function(){set("lastWorn",new Date().toISOString().slice(0,10))},style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28,whiteSpace:"nowrap"}},"üëï Today"),
          f.lastWorn&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d<=2?"var(--warn)":d<=7?"var(--gold)":"var(--good)"})()}},(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d===0?"today":d===1?"yesterday":d+"d ago"})())),
        item.ts&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:8,display:"flex",gap:12,flexWrap:"wrap"}},
          React.createElement("span",null,"Added: "+new Date(item.ts).toLocaleDateString()),
          f.lastWorn&&React.createElement("span",null,"Last worn: "+new Date(f.lastWorn).toLocaleDateString()),
          saved.some(function(o){return(o.items||[]).some(function(it){return it.id===item.id})})&&React.createElement("span",{style:{color:"var(--good)"}},"‚úì Used in "+saved.filter(function(o){return(o.items||[]).some(function(it){return it.id===item.id})}).length+" saved outfit(s)")),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){if(!f.color){showToast("Pick a color first","var(--warn)");return}updG(item.id,f);setEditG(null)}},"‚úì Save"),
          f.color&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){if(!f.color){showToast("Pick a color first","var(--warn)");return}updG(item.id,f);setLockItem(Object.assign({},item,f));setEditG(null);navTo("fits",null);setMode("auto")},title:"Lock for fits"},"üîí"),
          item.photoUrl&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:retry,disabled:retrying},retrying?"‚è≥":"üîÑ"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){var dup=Object.assign({},f,{id:Date.now(),ts:Date.now(),name:(f.name||"")+" copy"});addGarment(dup);setEditG(null)},title:"Duplicate"},"üìã"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){rmG(item.id);setEditG(null)}},"üóëÔ∏è")));
    };
    return React.createElement(GE,{key:item.id});
  }

  /* ‚ïê‚ïê‚ïê QUICK ADD ‚ïê‚ïê‚ïê */
  function renderQuickAdd(){
    var QA=function(){
      const[f,setF]=useState({garmentType:"Shirt",name:"",color:"",pattern:"solid"});
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      return React.createElement(Modal,{onClose:function(){setAddG(false)}},
        React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:14}},"Quick Add"),
        React.createElement("label",{className:"lbl"},"Name"),
        React.createElement("input",{className:"inp",value:f.name,onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy chinos",style:{marginBottom:12}}),
        React.createElement("label",{className:"lbl"},"Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:6}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)}),
          f.garmentType&&!ALL_T.includes(f.garmentType)&&React.createElement("span",{className:"chip on",style:{borderColor:"var(--gold)"}},f.garmentType)),
        React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center",marginBottom:14}},
          React.createElement("input",{className:"inp",value:ALL_T.includes(f.garmentType)?"":(f.garmentType||""),onChange:function(e){set("garmentType",e.target.value)},placeholder:"Custom type (e.g. Bomber, Parka...)",style:{fontSize:10,padding:"6px 8px",marginBottom:0,flex:1}})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:16}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:16}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){setF(function(p){return Object.assign({},p,{material:p.material===m?null:m})})},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){if(!f.color||!f.name){showToast("Need name + color","var(--warn)");return}var sd=smartDefaults(f);addGarment(Object.assign({},sd,f,{id:Date.now(),ts:Date.now()}));setAddG(false)}},
          "+ Add to Wardrobe"));
    };
    return React.createElement(QA,null);
  }

  /* ‚ïê‚ïê‚ïê WATCH EDIT ‚ïê‚ïê‚ïê */
  function renderWatchEdit(w){
    var WE=function(){
      const[f,setF]=useState(Object.assign({},migrateStraps(w)));
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      var togArr=function(k,v){setF(function(p){var arr=p[k]||[];var o={};o[k]=arr.includes(v)?arr.filter(function(x){return x!==v}):arr.concat([v]);return Object.assign({},p,o)})};
      const[addSt,setAddSt]=useState(false);
      const[nSt,setNSt]=useState({type:"leather",color:"",material:"calf leather",photoUrl:null});
      var setNStF=function(k,v){setNSt(function(p){var o=Object.assign({},p);o[k]=v;if(k==="type"){var td=STRAP_TYPES.find(function(t){return t.id===v});o.material=td&&td.mats[0]?td.mats[0]:"";o.color=v==="bracelet"?"silver":""}return o})};
      var addStrap=function(){if(!nSt.type)return;var s={type:nSt.type,color:nSt.color||"",material:nSt.material||""};if(nSt.photoUrl)s.photoUrl=nSt.photoUrl;setF(function(p){var ns=(p.straps||[]).concat([s]);return Object.assign({},p,{straps:ns,br:ns.some(function(x){return x.type==="bracelet"}),sc:ns.filter(function(x){return x.type!=="bracelet"}).map(function(x){return x.color})})});setAddSt(false);setNSt({type:"leather",color:"",material:"calf leather",photoUrl:null})};
      var rmStrap=function(si){setF(function(p){var ns=(p.straps||[]).filter(function(_,i){return i!==si});return Object.assign({},p,{straps:ns,br:ns.some(function(x){return x.type==="bracelet"}),sc:ns.filter(function(x){return x.type!=="bracelet"}).map(function(x){return x.color})})})};
      var handleWPhoto=async function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=async function(e){var fl=e.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,800,0.8);set("photoUrl",compressed)};inp.click()};
      return React.createElement(Modal,{onClose:function(){setEditW(null)}},
        React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:14}},
          React.createElement("div",{onClick:handleWPhoto,style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",overflow:"hidden",flexShrink:0,border:"2px solid "+(f.photoUrl?"var(--gold)":"var(--border)"),background:f.photoUrl?"none":f.c+"20"}},
            f.photoUrl?React.createElement("img",{src:ph(f.photoUrl),alt:"",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("span",{style:{fontSize:28}},f.i)),
          React.createElement("div",{style:{flex:1}},React.createElement("input",{className:"inp",value:f.n,onChange:function(e){set("n",e.target.value)},style:{fontWeight:600,border:"none",padding:0,background:"transparent"}})),
          f.photoUrl&&React.createElement("button",{onClick:function(){set("photoUrl",null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--dim)",fontSize:9,fontFamily:"var(--f)"}},"\u2715")),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:12}},
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Dial Color"),React.createElement("input",{className:"inp",value:f.d,onChange:function(e){set("d",e.target.value);if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:e.target.value,mc:autoMatchColors(e.target.value)})})}},style:{marginBottom:4}}),
            React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},["Black","White","Blue","Green","Silver","Grey","Champagne","Ivory"].map(function(dc){return React.createElement("span",{key:dc,onClick:function(){set("d",dc);set("c",(CM[dc.toLowerCase()]||{}).h||"#5a5a5a");if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:dc,c:(CM[dc.toLowerCase()]||{}).h||"#5a5a5a",mc:autoMatchColors(dc)})})}},style:{fontSize:8,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,cursor:"pointer",background:f.d===dc?"rgba(201,168,76,0.2)":"var(--bg)",border:"1px solid "+(f.d===dc?"rgba(201,168,76,0.3)":"var(--border)"),color:f.d===dc?"var(--gold)":"var(--dim)"}},dc)}))),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Type"),React.createElement("select",{className:"sel",value:f.t,onChange:function(e){set("t",e.target.value)}},React.createElement("option",{value:"genuine"},"Genuine"),React.createElement("option",{value:"replica"},"Replica"))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Status"),React.createElement("select",{className:"sel",value:f.status,onChange:function(e){set("status",e.target.value)}},STS.map(function(s){return React.createElement("option",{key:s.id,value:s.id},s.l)}))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Case Size"),React.createElement("input",{className:"inp",value:f.size||"",onChange:function(e){set("size",e.target.value)},placeholder:"e.g. 40mm"})),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Temp"),React.createElement("select",{className:"sel",value:f.mt,onChange:function(e){set("mt",e.target.value)}},React.createElement("option",{value:"cool"},"Cool"),React.createElement("option",{value:"warm"},"Warm"),React.createElement("option",{value:"mixed"},"Mixed")))),
        React.createElement("div",{style:{marginBottom:12}},
          React.createElement("label",{className:"lbl"},"Straps & Bracelets"),
          (f.straps||[]).map(function(st,si){
            var stDef=STRAP_TYPES.find(function(t){return t.id===st.type})||STRAP_TYPES[0];
            return React.createElement("div",{key:si,style:{display:"flex",gap:6,alignItems:"center",background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:4,border:"1px solid var(--border)"}},
              /* Strap photo: thumbnail + camera/gallery */
              React.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:3,flexShrink:0}},
                React.createElement("div",{onClick:function(){if(st.photoUrl)setLightboxSrc(st.photoUrl)},style:{width:36,height:36,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",cursor:st.photoUrl?"pointer":"default",overflow:"hidden",border:"1px solid "+(st.photoUrl?"var(--gold)":"var(--border)"),background:st.photoUrl?"none":"var(--card2)"}},
                  st.photoUrl?React.createElement("img",{src:ph(st.photoUrl),alt:"",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("span",{style:{fontSize:14,opacity:0.3}},stDef.icon)),
                React.createElement("div",{style:{display:"flex",gap:2}},
                  React.createElement("button",{onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.setAttribute("capture","environment");inp.onchange=async function(ev){var fl=ev.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,400,0.7);var ns=(f.straps||[]).slice();ns[si]=Object.assign({},ns[si],{photoUrl:compressed});set("straps",ns)};inp.click()},style:{background:"none",border:"1px solid var(--border)",borderRadius:4,padding:"1px 4px",cursor:"pointer",fontSize:9,color:"var(--dim)",lineHeight:1,minHeight:18}},"\uD83D\uDCF7"),
                  React.createElement("button",{onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=async function(ev){var fl=ev.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,400,0.7);var ns=(f.straps||[]).slice();ns[si]=Object.assign({},ns[si],{photoUrl:compressed});set("straps",ns)};inp.click()},style:{background:"none",border:"1px solid var(--border)",borderRadius:4,padding:"1px 4px",cursor:"pointer",fontSize:9,color:"var(--dim)",lineHeight:1,minHeight:18}},"\uD83D\uDDBC\uFE0F"))),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",minWidth:55,fontWeight:600}},stDef.l),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},st.material),
              st.type!=="bracelet"&&st.color&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},React.createElement(Dot,{color:st.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},st.color)),
              st.photoUrl&&React.createElement("button",{onClick:function(e){e.stopPropagation();var ns=(f.straps||[]).slice();ns[si]=Object.assign({},ns[si],{photoUrl:null});set("straps",ns)},style:{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",fontSize:8,padding:"2px"}},"‚úï"),
              React.createElement("button",{onClick:function(){rmStrap(si)},style:{marginLeft:"auto",background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"3px 8px",cursor:"pointer",color:"var(--del-text)",fontSize:9,fontFamily:"var(--f)",minHeight:24}},"‚úï"))}),
          !addSt&&React.createElement("button",{onClick:function(){setAddSt(true)},style:{width:"100%",background:"var(--bg)",border:"1px dashed var(--border)",borderRadius:8,padding:"10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:11,marginTop:4,minHeight:36}},"+ Add Strap / Bracelet"),
          addSt&&React.createElement("div",{style:{background:"var(--bg)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:8,padding:10,marginTop:4}},
            React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
              STRAP_TYPES.map(function(st){return React.createElement("span",{key:st.id,className:"chip "+(nSt.type===st.id?"on":""),onClick:function(){setNStF("type",st.id)},style:{fontSize:10,padding:"4px 8px"}},st.icon+" "+st.l)})),
            React.createElement("div",{style:{display:"flex",gap:8,marginBottom:8}},
              nSt.type!=="bracelet"&&React.createElement("div",{style:{flex:1}},
                React.createElement("label",{className:"lbl",style:{fontSize:8,marginBottom:2}},"Color"),
                React.createElement("input",{className:"inp",value:nSt.color,onChange:function(e){setNSt(function(p){return Object.assign({},p,{color:e.target.value})})},placeholder:"brown, black...",style:{fontSize:10,padding:"6px 8px",marginBottom:4}}),
                React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},
                  STRAP_COLORS.map(function(c){return React.createElement("span",{key:c,onClick:function(){setNSt(function(p){return Object.assign({},p,{color:c})})},style:{display:"inline-flex",alignItems:"center",gap:3,fontSize:7,fontFamily:"var(--f)",padding:"2px 5px",borderRadius:3,cursor:"pointer",background:nSt.color===c?"rgba(201,168,76,0.2)":"transparent",border:"1px solid "+(nSt.color===c?"rgba(201,168,76,0.3)":"var(--border)"),color:nSt.color===c?"var(--gold)":"var(--dim)"}},React.createElement("span",{style:{width:6,height:6,borderRadius:"50%",background:strapHex(c),flexShrink:0,border:"1px solid rgba(255,255,255,0.1)"}}),c)}))),
              React.createElement("div",{style:{flex:1}},
                React.createElement("label",{className:"lbl",style:{fontSize:8,marginBottom:2}},"Material"),
                React.createElement("select",{className:"sel",value:nSt.material,onChange:function(e){setNSt(function(p){return Object.assign({},p,{material:e.target.value})})},style:{fontSize:10,padding:"6px 8px"}},
                  (STRAP_TYPES.find(function(t){return t.id===nSt.type})||{mats:[]}).mats.map(function(m){return React.createElement("option",{key:m,value:m},m)})))),
            React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center",marginBottom:8,padding:"6px 8px",background:"var(--card2)",borderRadius:6,border:"1px solid var(--border)"}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Photo:"),
              nSt.photoUrl?React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1}},
                React.createElement("img",{src:ph(nSt.photoUrl),alt:"",style:{width:32,height:32,borderRadius:6,objectFit:"cover",border:"1px solid var(--gold)"}}),
                React.createElement("button",{onClick:function(){setNSt(function(p){return Object.assign({},p,{photoUrl:null})})},style:{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",fontSize:9}},"‚úï Remove"))
              :React.createElement("div",{style:{display:"flex",gap:4,flex:1}},
                React.createElement("button",{onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.setAttribute("capture","environment");inp.onchange=async function(ev){var fl=ev.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,400,0.7);setNSt(function(p){return Object.assign({},p,{photoUrl:compressed})})};inp.click()},style:{background:"none",border:"1px solid rgba(201,168,76,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:26}},"\uD83D\uDCF7 Camera"),
                React.createElement("button",{onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=async function(ev){var fl=ev.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,400,0.7);setNSt(function(p){return Object.assign({},p,{photoUrl:compressed})})};inp.click()},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:26}},"\uD83D\uDDBC\uFE0F Gallery"))),
            React.createElement("div",{style:{display:"flex",gap:6}},
              React.createElement("button",{onClick:addStrap,style:{flex:1,background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:6,padding:"8px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"+  Add"),
              React.createElement("button",{onClick:function(){setAddSt(false)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"8px 14px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:32}},"Cancel")))),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Match Colors"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,maxHeight:100,overflowY:"auto",marginBottom:12}},AC.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.mc||[]).includes(c)?"on":""),onClick:function(){togArr("mc",c)}},React.createElement(Dot,{color:c,size:6}),c)})),
        React.createElement("label",{className:"lbl"},"Contexts"),
        React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,marginBottom:12}},activeCxIds.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.cx||[]).includes(c)?"on":""),onClick:function(){togArr("cx",c)}},(activeCxIcons[c]||"")+" "+c)})),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Weather"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",gap:6,marginBottom:12}},"light,mid,heavy".split(",").map(function(x){return React.createElement("span",{key:x,className:"chip "+((f.wt||[]).includes(x)?"on":""),onClick:function(){togArr("wt",x)},style:{flex:1,justifyContent:"center"}},(x==="light"?"‚òÄÔ∏è":x==="mid"?"üå§Ô∏è":"üß•")+" "+x)})),
        React.createElement("label",{className:"lbl"},"Emoji"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:14}},EMOJIS.map(function(e){return React.createElement("span",{key:e,onClick:function(){set("i",e)},style:{fontSize:22,cursor:"pointer",opacity:f.i===e?1:0.25,padding:3,minWidth:30,textAlign:"center"}},e)})),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){var sv=Object.assign({},f);if(sv.straps&&sv.straps.length){sv.br=sv.straps.some(function(s){return s.type==="bracelet"});sv.sc=sv.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color})}if(IS_SHARED&&(!sv.mc||!sv.mc.length))sv.mc=autoMatchColors(sv.d);updateW(w.id,sv);setEditW(null)}},"Save"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 20px"},onClick:function(){setConfirmDlg({msg:"Delete this watch?",danger:true,onOk:function(){removeW(w.id);setEditW(null);setConfirmDlg(null)}})}},"üóëÔ∏è")));
    };
    return React.createElement(WE,{key:w.id});
  }

  /* ‚ïê‚ïê‚ïê ONBOARDING (shared version only) ‚ïê‚ïê‚ïê */
  if(!onboarded){
    var obDotStyle=function(s){return{width:8,height:8,borderRadius:"50%",background:onboardStep>=s?"var(--gold)":"var(--border)"}};
    var obFinish=function(){
      var nw=obWatches.map(function(pw){return migrateStraps(Object.assign({},pw,{id:pw.id+"-"+Date.now()+Math.random().toString(36).slice(2,5),active:true,status:"active",t:"genuine"}))});
      var ng=obGarments.map(function(pg){var sd=smartDefaults(pg);return Object.assign({},sd,pg,{id:"g-"+Date.now()+Math.random().toString(36).slice(2,5),ts:Date.now()})});
      if(nw.length){setW(nw);ps("w_"+SK,nw)}
      if(ng.length){setWd(ng);ps("wd_"+SK,ng)}
      setOnboarded(true);ps("wa_onboarded",true);
    };
    /* Step 1: Watches */
    if(onboardStep===1){
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"‚åö"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Watches"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap to add watches you own. You can customize later."),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,width:"100%",maxWidth:340,marginBottom:16}},
          WATCH_PRESETS.map(function(wp){
            var sel=obWatches.some(function(o){return o.id===wp.id});
            return React.createElement("button",{key:wp.id,onClick:function(){setObWatches(function(prev){return sel?prev.filter(function(o){return o.id!==wp.id}):prev.concat([wp])})},
              style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",borderRadius:10,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",textAlign:"left"}},
              React.createElement("span",{style:{fontSize:20}},wp.i),
              React.createElement("div",null,
                React.createElement("div",{style:{fontSize:12,fontWeight:600,color:"var(--tx)"}},wp.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},wp.d+" dial")))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(2)}},obWatches.length?"Next ("+obWatches.length+" selected)":"Skip"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px",fontSize:11},onClick:function(){
            var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){
              var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){
                try{var d=JSON.parse(r.result);if(d.watches){var mw=d.watches.map(migrateStraps);setW(mw);ps("w_"+SK,mw)}if(d.wardrobe){setWd(d.wardrobe);ps("wd_"+SK,d.wardrobe)}if(d.outfits){setSaved(d.outfits);ps("of_"+SK,d.outfits)}if(d.wearLog){setWearLog(d.wearLog);ps("wa_wearlog_"+SK,d.wearLog)}if(d.weekCtx&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}setOnboarded(true);ps("wa_onboarded",true)}catch(ex){showToast("Invalid backup file","var(--warn)",3000)}};r.readAsText(f)};inp.click()
          }},"üì• Import")));
    }
    /* Step 2: Closet */
    if(onboardStep===2){
      var gTypes=["Tops","Bottoms","Shoes"];
      var gGroups={Tops:GARMENT_PRESETS.filter(function(g){return["Shirt","T-Shirt","Polo","Sweater/Knit"].includes(g.garmentType)}),Bottoms:GARMENT_PRESETS.filter(function(g){return["Chinos","Jeans","Shorts","Pants/Trousers"].includes(g.garmentType)}),Shoes:GARMENT_PRESETS.filter(function(g){return g.garmentType==="Shoes"})};
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"üëî"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Closet"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap garments you own. You can add photos and more items later."),
        gTypes.map(function(gt){return React.createElement("div",{key:gt,style:{width:"100%",maxWidth:340,marginBottom:12}},
          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)",marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}},gt),
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:6}},
            gGroups[gt].map(function(gp){
              var gKey=gp.garmentType+"-"+gp.color;
              var sel=obGarments.some(function(o){return o.garmentType===gp.garmentType&&o.color===gp.color});
              return React.createElement("button",{key:gKey,onClick:function(){setObGarments(function(prev){return sel?prev.filter(function(o){return!(o.garmentType===gp.garmentType&&o.color===gp.color)}):prev.concat([gp])})},
                style:{padding:"6px 12px",borderRadius:20,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",fontSize:11,fontFamily:"var(--f)",color:sel?"var(--gold)":"var(--tx)"}},gp.name)
            })))}),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:8}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(1)}},"‚Üê Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(3)}},obGarments.length?"Next ("+obGarments.length+" items)":"Skip")));
    }
    /* Step 3: Week context */
    if(onboardStep===3){
      var ctxNames=activeCxIds.length?activeCxIds:["casual","clinic","smart-casual","formal","weekend","travel","date","riviera"];
      var dayNames=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"üìÖ"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Week"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Set the vibe for each day. This helps match outfits to your schedule."),
        React.createElement("div",{style:{width:"100%",maxWidth:340}},
          dayNames.map(function(dn,di){
            return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{width:32,fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)"}},dn),
              React.createElement("select",{value:weekCtx[di],onChange:function(e){setWeekCtx(function(p){var n=p.slice();n[di]=e.target.value;return n})},
                style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border)",background:"var(--card)",color:"var(--tx)",fontFamily:"var(--f)",fontSize:12}},
                ctxNames.map(function(cx){return React.createElement("option",{key:cx,value:cx},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:12}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(2)}},"‚Üê Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_weekctx",weekCtx);obFinish()}},"‚ú® Start Pairing")));
    }
  }

  /* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
  return React.createElement("div",{style:{minHeight:"100vh"}},
    editG&&renderGarmentEdit(editG),
    editW&&renderWatchEdit(editW),
    addG&&renderQuickAdd(),
    /* Duplicate Detection Modal */
    showDupes&&React.createElement(Modal,{onClose:function(){setShowDupes(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"üîç Duplicate Detection"),
      React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:14}},"Items with matching type + color that might be duplicates. Review each group and delete extras."),
      dupeGroups.length===0?React.createElement("div",{style:{textAlign:"center",padding:30}},
        React.createElement("span",{style:{fontSize:28}},"‚úÖ"),
        React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--good)",marginTop:8}},"No duplicates found!"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},"All "+wd.length+" items are unique."))
      :React.createElement("div",null,
        React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",borderRadius:8,padding:"8px 12px",marginBottom:14,border:"1px solid rgba(200,90,58,0.2)"}},
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},dupeGroups.length+" potential duplicate group"+(dupeGroups.length>1?"s":"")+" found")),
        dupeGroups.map(function(group,gi){
          return React.createElement("div",{key:gi,style:{background:"var(--bg)",borderRadius:12,padding:"14px",marginBottom:12,border:"1px solid var(--border)"}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement(Dot,{color:group[0].color,size:12}),
              React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},group[0].garmentType+" ‚Äî "+group[0].color),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",background:"rgba(200,90,58,0.1)",borderRadius:4,padding:"2px 6px"}},group.length+" items")),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat("+Math.min(group.length,3)+",1fr)",gap:10}},
              group.map(function(item){
                return React.createElement("div",{key:item.id,style:{background:"var(--card)",borderRadius:10,overflow:"hidden",border:"1px solid var(--border)"}},
                  item.photoUrl?React.createElement("img",{src:ph(item.photoUrl),alt:"",onClick:function(e){e.stopPropagation();openLightbox(item.photoUrl,item.id)},style:{width:"100%",height:140,objectFit:"cover",display:"block",cursor:"zoom-in"}}):React.createElement("div",{style:{width:"100%",height:100,background:(CM[item.color]||{}).h||"#3a3a3a",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement(Dot,{color:item.color,size:30})),
                  React.createElement("div",{style:{padding:"8px 10px"}},
                    React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:500,marginBottom:2}},item.name||item.color),
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:2}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" ¬∑ "+item.pattern:"")+(item.material?" ¬∑ "+item.material:"")),
                    item.lastWorn&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:4}},"Last worn: "+new Date(item.lastWorn).toLocaleDateString()),
                    React.createElement("button",{onClick:function(){setConfirmDlg({msg:"Delete \""+(item.name||item.color)+"\"?",danger:true,onOk:function(){rmG(item.id);setDupeGroups(function(prev){return prev.map(function(g){return g.filter(function(x){return x.id!==item.id})}).filter(function(g){return g.length>=2})});setConfirmDlg(null)}})},style:{width:"100%",background:"rgba(200,90,58,0.1)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:28}},"üóëÔ∏è Delete")))})));
        }))),
    /* Lightbox Modal */
    lightboxSrc&&React.createElement("div",{onClick:function(){setLightboxSrc(null);setLightboxItems([])},style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.95)",zIndex:200,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",animation:"fadeIn .15s ease",cursor:"pointer",padding:16}},
      React.createElement("button",{onClick:function(){setLightboxSrc(null);setLightboxItems([])},style:{position:"absolute",top:16,right:16,background:"none",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"50%",width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",fontSize:18,zIndex:201}},"‚úï"),
      React.createElement("img",{src:lightboxSrc,alt:"",style:{maxWidth:"92vw",maxHeight:lightboxItems.length>1?"60vh":"85vh",objectFit:"contain",borderRadius:8,boxShadow:"0 8px 32px rgba(0,0,0,0.5)"},onClick:function(e){e.stopPropagation()}}),
      lightboxItems.length>0&&React.createElement("div",{onClick:function(e){e.stopPropagation()},style:{display:"flex",gap:8,flexWrap:"wrap",justifyContent:"center",marginTop:12,maxWidth:"92vw"}},
        lightboxItems.map(function(item){
          return React.createElement("div",{key:item.id,onClick:function(){setLightboxSrc(null);setLightboxItems([]);setEditG(item)},style:{display:"flex",alignItems:"center",gap:6,background:"rgba(255,255,255,0.08)",borderRadius:10,padding:"8px 14px",border:"1px solid rgba(255,255,255,0.12)",cursor:"pointer",transition:"background .15s"}},
            React.createElement("div",{style:{width:14,height:14,borderRadius:"50%",background:(CM[item.color]||{}).h||"#5a5a5a",border:"1px solid rgba(255,255,255,0.2)",flexShrink:0}}),
            React.createElement("div",{style:{flex:1}},
              React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",color:"#fff",fontWeight:600}},item.name||item.color),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"rgba(255,255,255,0.5)"}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" ¬∑ "+item.pattern:"")+(item.material?" ¬∑ "+item.material:""))),
            React.createElement("span",{style:{fontSize:11,color:"rgba(255,255,255,0.4)",marginLeft:4}},"‚úèÔ∏è"),
            item.positionHint&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"rgba(255,255,255,0.35)",marginLeft:4}},"üì∏ "+item.positionHint))}))),

    showWDupes&&React.createElement(Modal,{onClose:function(){setShowWDupes(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"üîç Watch Duplicates"),
      React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:14}},"Watches with matching names, dials, or similar identifiers. Review and delete extras."),
      wDupeGroups.length===0?React.createElement("div",{style:{textAlign:"center",padding:30}},
        React.createElement("span",{style:{fontSize:28}},"‚úÖ"),
        React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--good)",marginTop:8}},"No duplicate watches found!"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},W.length+" watches are all unique."))
      :React.createElement("div",null,
        React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",borderRadius:8,padding:"8px 12px",marginBottom:14,border:"1px solid rgba(200,90,58,0.2)"}},
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},wDupeGroups.length+" potential duplicate group"+(wDupeGroups.length>1?"s":"")+" found")),
        wDupeGroups.map(function(group,gi){
          return React.createElement("div",{key:gi,style:{background:"var(--bg)",borderRadius:12,padding:"14px",marginBottom:12,border:"1px solid var(--border)"}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement("span",{style:{fontSize:16}},group[0].i||"‚åö"),
              React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},group[0].t.toUpperCase()+" ‚Äî "+group[0].d+" dial"),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",background:"rgba(200,90,58,0.1)",borderRadius:4,padding:"2px 6px"}},group.length+" watches")),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat("+Math.min(group.length,2)+",1fr)",gap:10}},
              group.map(function(w){
                return React.createElement("div",{key:w.id,style:{background:"var(--card)",borderRadius:10,padding:"12px",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
                    React.createElement("div",{style:{width:36,height:36,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:18,border:"2px solid "+w.c+"60"}},w.photoUrl?React.createElement("img",{src:ph(w.photoUrl),alt:"",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"50%"}}):w.i||"‚åö"),
                    React.createElement("div",{style:{flex:1}},
                      React.createElement("div",{style:{fontSize:12,fontWeight:600}},w.n),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},w.d+" ¬∑ "+(w.ref||"no ref")+" ¬∑ "+(w.size?w.size+"mm":"")+" ¬∑ "+w.t),
                      w.status&&w.status!=="active"&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:w.status==="incoming"?"#7ab8d8":"var(--warn)",marginTop:2}},w.status))),
                  React.createElement("div",{style:{display:"flex",gap:6}},
                    React.createElement("button",{onClick:function(){setEditW(w);setShowWDupes(false)},style:{flex:1,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:28}},"‚úèÔ∏è Edit"),
                    React.createElement("button",{onClick:function(){setConfirmDlg({msg:"Delete watch \""+w.n+"\"?",danger:true,onOk:function(){removeW(w.id);setWDupeGroups(function(prev){return prev.map(function(g){return g.filter(function(x){return x.id!==w.id})}).filter(function(g){return g.length>=2})});setConfirmDlg(null)}})},style:{flex:1,background:"rgba(200,90,58,0.1)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:28}},"üóëÔ∏è Delete")))}))),
          /* Bulk remove all non-first items */
          React.createElement("div",{style:{borderTop:"1px solid var(--border)",paddingTop:12,marginTop:8}},
            React.createElement("button",{onClick:function(){
              var toRemove=[];
              wDupeGroups.forEach(function(g){g.slice(1).forEach(function(w){toRemove.push(w.id)})});
              if(!toRemove.length)return;
              setConfirmDlg({msg:"Delete "+toRemove.length+" duplicate watch"+(toRemove.length>1?"es":"")+"? Keeps first from each group.",danger:true,onOk:function(){
                setW(function(p){var n=p.filter(function(w){return!toRemove.includes(w.id)});ps("w_"+SK,n);return n});
                setWDupeGroups([]);setConfirmDlg(null)}})},style:{width:"100%",background:"rgba(200,90,58,0.12)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:8,padding:"10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"üóëÔ∏è Remove All Duplicates (keep first of each group)"))}))),
        showSettings&&React.createElement(Modal,{onClose:function(){setShowSettings(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"‚öôÔ∏è Settings"),
      React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:16}},"AI photo classification works automatically inside Claude.ai. To use it in a standalone browser, add your Anthropic API key below."),
      React.createElement("label",{className:"lbl"},"Anthropic API Key"),
      React.createElement("input",{className:"inp",type:"password",value:apiKey,onChange:function(e){setApiKey(e.target.value);apiKeyRef.current=e.target.value},placeholder:"sk-ant-...",style:{marginBottom:12,fontFamily:"monospace"}}),
      React.createElement("div",{style:{display:"flex",gap:8,marginBottom:16}},
        React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_apikey",encryptApiKey(apiKey));apiKeyRef.current=apiKey;setShowSettings(false)}},"üíæ Save Key"),
        apiKey&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setApiKey("");apiKeyRef.current="";ps("wa_apikey","")}},"Clear")),
      React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",border:"1px solid var(--border)"}},
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"‚ÑπÔ∏è Get your key at console.anthropic.com ‚Üí API Keys"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"Cost: ~$0.01 per photo (Sonnet vision)"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:apiKey?"var(--good)":"var(--warn)",margin:0,fontWeight:500}},apiKey?"‚úì Key configured ‚Äî AI classification active":"‚úó No key ‚Äî manual classification only outside Claude.ai")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Context Categories"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:6,marginBottom:8}},
          activeCx.map(function(c){return React.createElement("span",{key:c.id,className:"chip on",style:{gap:6}},c.icon+" "+c.l,
            React.createElement("span",{onClick:function(e){e.stopPropagation();var n=activeCx.filter(function(x){return x.id!==c.id});if(n.length<2)return;setUserCx(n);ps("wa_usercx_"+SK,n)},style:{cursor:"pointer",color:"var(--warn)",fontSize:10,marginLeft:2}},"‚úï"))})),
        React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8}},
          React.createElement("input",{id:"newCxName",className:"inp",placeholder:"New context name",style:{flex:1,fontSize:11,padding:"6px 10px"}}),
          React.createElement("input",{id:"newCxIcon",className:"inp",placeholder:"Emoji",style:{width:50,fontSize:14,textAlign:"center",padding:"6px"}}),
          React.createElement("button",{onClick:function(){var nameEl=document.getElementById("newCxName");var iconEl=document.getElementById("newCxIcon");var nm=(nameEl?nameEl.value:"").trim();var ic=(iconEl?iconEl.value:"").trim()||"üìå";if(!nm)return;var nid=nm.toLowerCase().replace(/\s+/g,"-");var n=(userCx||activeCx).concat([{id:nid,l:nm,icon:ic}]);setUserCx(n);ps("wa_usercx_"+SK,n);if(nameEl)nameEl.value="";if(iconEl)iconEl.value=""},style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontFamily:"var(--f)",fontSize:11,fontWeight:600}},"+Add")),
        React.createElement("button",{onClick:function(){setUserCx(null);ps("wa_usercx_"+SK,null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"6px 12px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,marginBottom:8}},"Reset to Defaults")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"üîê Recovery Credentials"),
        React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:8}},"Set a username + password to encrypt your backups. You'll need these to restore on a new device."),
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:6}},
          React.createElement("input",{className:"inp",type:"text",value:recUser,onChange:function(e){setRecUser(e.target.value)},placeholder:"Username",style:{flex:1,fontSize:11,padding:"8px 12px"}}),
          React.createElement("input",{className:"inp",type:"password",value:recPass,onChange:function(e){setRecPass(e.target.value)},placeholder:"Password",style:{flex:1,fontSize:11,padding:"8px 12px"}})),
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:8}},
          React.createElement("button",{onClick:function(){if(!recUser.trim()||!recPass.trim()){showToast("Enter both username and password","var(--warn)");return}localStorage.setItem("wa_rec_user",recUser);/* password never stored */setRecStatus("saved");setTimeout(function(){setRecStatus("")},2500)},style:{flex:1,background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"üíæ Save Credentials"),
          React.createElement("button",{onClick:async function(){
            if(!recUser.trim()||!recPass.trim()){showToast("Enter username and password first","var(--warn)");return}
            setRecStatus("encrypting...");
            try{
              var data=JSON.stringify({version:"v24.11",user:recUser.trim(),ts:Date.now(),watches:W,wardrobe:wd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,rotLock:rotLock,selfieHistory:selfieHistory,theme:theme});
              var encrypted=await encryptData(data,recUser.trim()+"::"+recPass.trim());
              var blob=new Blob([encrypted],{type:"application/octet-stream"});
              var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="watch-advisor-"+recUser.trim()+".wabackup";a.click();
              setRecStatus("exported \u2713");setTimeout(function(){setRecStatus("")},3000);
            }catch(e){setRecStatus("error: "+e.message);setTimeout(function(){setRecStatus("")},4000)}
          },style:{flex:1,background:"rgba(122,184,216,0.08)",border:"1px solid rgba(122,184,216,0.25)",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--info)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"üì§ Encrypted Export"),
          React.createElement("button",{onClick:function(){
            if(!recPass.trim()){showToast("Enter password to decrypt","var(--warn)");return}
            var inp=document.createElement("input");inp.type="file";inp.accept=".wabackup";inp.onchange=async function(e){
              var f=e.target.files[0];if(!f)return;
              setRecStatus("decrypting...");
              try{
                var buf=await f.arrayBuffer();
                var packed=new Uint8Array(buf);
                var json=await decryptData(packed,((recUser||"").trim()||f.name.replace("watch-advisor-","").replace(".wabackup",""))+"::"+recPass.trim());
                var d=JSON.parse(json);
                var imported=[];
                if(d.watches&&Array.isArray(d.watches)){var valid=d.watches.filter(function(w){return w&&w.id&&w.n});if(valid.length){var mw=valid.map(migrateStraps);setW(mw);ps("w_"+SK,mw);imported.push(valid.length+" watches")}}
                if(d.wardrobe&&Array.isArray(d.wardrobe)){var vwd=d.wardrobe.filter(function(i){return i&&i.id});if(vwd.length){setWd(vwd);ps("wd_"+SK,vwd);imported.push(vwd.length+" wardrobe items")}}
                if(d.outfits&&Array.isArray(d.outfits)){setSaved(d.outfits);ps("of_"+SK,d.outfits);imported.push(d.outfits.length+" outfits")}
                if(d.wearLog&&Array.isArray(d.wearLog)){var vwl=d.wearLog.filter(function(e2){return e2&&e2.date&&e2.watchId});setWearLog(vwl);ps("wa_wearlog_"+SK,vwl);imported.push(vwl.length+" wear logs")}
                if(d.weekCtx&&Array.isArray(d.weekCtx)&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}
                if(d.userCx&&Array.isArray(d.userCx)){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}
                if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}
                if(d.selfieHistory&&Array.isArray(d.selfieHistory)){setSelfieHistory(d.selfieHistory);ps("wa_selfie_"+SK,d.selfieHistory);imported.push(d.selfieHistory.length+" selfies")}
                if(d.theme){setTheme(d.theme);ps("wa_theme",d.theme)}
                setRecStatus("restored \u2713");showToast("‚úÖ Restored: "+imported.join(", "),"var(--good)",4000);setTimeout(function(){setRecStatus("")},4000);
              }catch(err){
                setRecStatus("");
                if(err.name==="OperationError")showToast("‚ùå Wrong password or username","var(--warn)",4000);
                else showToast("Error: "+err.message,"var(--warn)",3000);
              }
            };inp.click();
          },style:{flex:1,background:"rgba(122,184,122,0.08)",border:"1px solid rgba(122,184,122,0.25)",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"üì• Restore .wabackup")),
        recStatus&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:recStatus.includes("error")?"var(--warn)":recStatus.includes("\u2713")?"var(--good)":"var(--info)",marginBottom:6,fontWeight:500}},recStatus),
        React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:16,border:"1px solid var(--border)"}},
          React.createElement("p",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",margin:0}},"AES-256-GCM encryption ¬∑ PBKDF2 310K iterations ¬∑ Your password never leaves this device ¬∑ .wabackup files are unreadable without your credentials"))),
      React.createElement("div",{style:{marginTop:0,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Data Management"),
        React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:6}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:async function(){try{var ew=JSON.parse(JSON.stringify(W)),ewd=JSON.parse(JSON.stringify(wd));for(var it of ewd){if(it.photoUrl&&it.photoUrl.startsWith("idb:"))it.photoUrl=await photoAsDataUrl(it.photoUrl)||null}for(var w of ew){if(w.photoUrl&&w.photoUrl.startsWith("idb:"))w.photoUrl=await photoAsDataUrl(w.photoUrl)||null;if(w.straps)for(var s of w.straps){if(s.photoUrl&&s.photoUrl.startsWith("idb:"))s.photoUrl=await photoAsDataUrl(s.photoUrl)||null}}var data=JSON.stringify({version:"v24.11",watches:ew,wardrobe:ewd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,rotLock:rotLock,selfieHistory:selfieHistory,theme:theme});var blob=new Blob([data],{type:"application/json"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="watch-advisor-backup.json";a.click()}catch(e){console.error("[Export]",e)}}},"‚Äçüì§ Export"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{var d=JSON.parse(r.result);if(typeof d!=="object"||d===null||Array.isArray(d)){showToast("Invalid backup file: expected JSON object","var(--warn)",3000);return}var imported=[];if(d.watches&&Array.isArray(d.watches)){var valid=d.watches.filter(function(w){return w&&typeof w==="object"&&w.id&&w.n});if(valid.length){var mw=valid.map(migrateStraps);setW(mw);ps("w_"+SK,mw);imported.push(valid.length+" watches")}}if(d.wardrobe&&Array.isArray(d.wardrobe)){var vwd=d.wardrobe.filter(function(i){return i&&typeof i==="object"&&i.id});if(vwd.length){setWd(vwd);ps("wd_"+SK,vwd);imported.push(vwd.length+" wardrobe items")}}if(d.outfits&&Array.isArray(d.outfits)){setSaved(d.outfits);ps("of_"+SK,d.outfits);imported.push(d.outfits.length+" outfits")}if(d.wearLog&&Array.isArray(d.wearLog)){var vwl=d.wearLog.filter(function(e){return e&&e.date&&e.watchId});setWearLog(vwl);ps("wa_wearlog_"+SK,vwl);imported.push(vwl.length+" wear logs")}if(d.weekCtx&&Array.isArray(d.weekCtx)&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&Array.isArray(d.userCx)&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}if(d.selfieHistory&&Array.isArray(d.selfieHistory)){setSelfieHistory(d.selfieHistory);ps("wa_selfie_"+SK,d.selfieHistory);imported.push(d.selfieHistory.length+" selfie checks")}if(d.theme&&(d.theme==="dark"||d.theme==="light")){setTheme(d.theme);ps("wa_theme",d.theme)}showToast(imported.length?"‚úÖ Imported: "+imported.join(", "):"No valid data found in file",imported.length?"var(--good)":"var(--warn)",3500)}catch(e){showToast("Invalid file: "+String(e.message||e).slice(0,100),"var(--warn)",3500)}};r.readAsText(f)};inp.click()}},"üì• Import"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept=".md,.txt";inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{var parsed=parseWatchLog(r.result,W);if(parsed&&parsed.length){setW(parsed);ps("w_"+SK,parsed);showToast("‚úÖ Imported "+parsed.length+" watches from markdown!","var(--good)",3000)}else{showToast("No watches found in file","var(--warn)",3000)}}catch(ex){console.error(ex);showToast("Parse error: "+ex.message,"var(--warn)",3000)}};r.readAsText(f)};inp.click()}},"üìÑ Import .md")))),

    /* Floating Save Button */
    /* Quick Backup Button */
    React.createElement("div",{style:{position:"fixed",bottom:20,right:16,zIndex:89,pointerEvents:"none",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:8}},
    React.createElement("button",{onClick:function(){setShowQuickWear(!showQuickWear)},style:{pointerEvents:"auto",width:44,height:44,borderRadius:"50%",background:todayWorn?"linear-gradient(135deg,var(--good),#5a9e5a)":"linear-gradient(135deg,#7ab8d8,#5a8eae)",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.25)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,color:"#fff",transition:"transform .15s"},title:todayWorn?"Change today's watch":"Log today's watch"},todayWorn?"‚úì":"‚åö"),
    React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",pointerEvents:"auto"}},
      React.createElement("button",{onClick:async function(){try{var ew=JSON.parse(JSON.stringify(W)),ewd=JSON.parse(JSON.stringify(wd));for(var it of ewd){if(it.photoUrl&&it.photoUrl.startsWith("idb:"))it.photoUrl=await photoAsDataUrl(it.photoUrl)||null}for(var w of ew){if(w.photoUrl&&w.photoUrl.startsWith("idb:"))w.photoUrl=await photoAsDataUrl(w.photoUrl)||null;if(w.straps)for(var s of w.straps){if(s.photoUrl&&s.photoUrl.startsWith("idb:"))s.photoUrl=await photoAsDataUrl(s.photoUrl)||null}}var data=JSON.stringify({version:"v24.11",ts:Date.now(),watches:ew,wardrobe:ewd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,rotLock:rotLock,selfieHistory:selfieHistory,theme:theme});var blob=new Blob([data],{type:"application/json"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="wa-backup-"+new Date().toISOString().slice(0,10)+".json";a.click()}catch(e){console.error("[Export]",e)}},style:{width:36,height:36,borderRadius:"50%",background:"var(--card)",border:"1px solid var(--border)",boxShadow:"0 2px 8px rgba(0,0,0,0.15)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,color:"var(--dim)",transition:"transform .15s",},title:"Quick backup (JSON)"},"üì§"),
    React.createElement("button",{onClick:saveAll,"aria-label":"Save all changes",style:{width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",boxShadow:"0 4px 16px rgba(201,168,76,0.35)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,color:"var(--bg)",transition:"transform .15s"}},"üíæ"))),
    /* Quick Wear FAB */
    
    /* Quick Wear Picker */
    showQuickWear&&React.createElement("div",{onClick:function(){setShowQuickWear(false)},style:{position:"fixed",inset:0,zIndex:95,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"flex-end",justifyContent:"center",}},
      React.createElement("div",{onClick:function(e){e.stopPropagation()},style:{background:"var(--card)",borderRadius:"16px 16px 0 0",padding:"16px",maxWidth:420,width:"100%",maxHeight:"60vh",overflowY:"auto"}},
        React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
          React.createElement("span",{style:{fontSize:18}},"‚åö"),
          React.createElement("span",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"What are you wearing today?"),
          todayWorn&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--good)",background:"rgba(122,184,122,0.1)",borderRadius:6,padding:"2px 8px"}},"Currently: "+(function(){var w=W.find(function(x){return x.id===todayWorn.watchId});return w?w.n:"?"})())),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
          W.filter(function(w){return w.active&&w.status!=="pending-trade"&&w.status!=="incoming"&&w.status!=="service"}).map(function(w){
            var isToday=todayWorn&&todayWorn.watchId===w.id;
            return React.createElement("button",{key:w.id,onClick:function(){logWear(w.id,todayStr);setShowQuickWear(false)},style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",background:isToday?"rgba(122,184,122,0.1)":"var(--bg)",border:"1px solid "+(isToday?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:10,cursor:"pointer",textAlign:"left"}},
              React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:16,border:"1px solid "+w.c+"40",overflow:"hidden",flexShrink:0}},w.photoUrl?React.createElement("img",{src:ph(w.photoUrl),alt:"",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover"}}):w.i),
              React.createElement("div",{style:{flex:1,minWidth:0}},
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:isToday?"var(--good)":"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},w.n),
                React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},w.d+(isToday?" ‚úì today":""))),
              !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:2,padding:"0 3px"}},"R"))
          })),
        todayWorn&&React.createElement("button",{onClick:function(){undoWear(todayStr);setShowQuickWear(false)},style:{width:"100%",marginTop:8,background:"none",border:"1px solid var(--del-border)",borderRadius:8,padding:"10px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:10,minHeight:36}},"‚úï Clear today's wear log"))),
    /* Universal Toast */
    toast&&React.createElement("div",{className:"fu",onClick:function(){setToast(null)},style:{position:"fixed",top:60,left:16,right:16,zIndex:95,background:toast.color==="var(--warn)"?"rgba(200,90,58,0.95)":"rgba(122,184,122,0.95)",color:"#fff",borderRadius:12,padding:"12px 18px",fontFamily:"var(--f)",fontSize:12,fontWeight:600,boxShadow:"0 4px 20px rgba(0,0,0,0.35)",cursor:"pointer",textAlign:"center",maxWidth:500,margin:"0 auto"}},toast.msg),
    /* Confirm Dialog */
    confirmDlg&&React.createElement("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",padding:24,animation:"fadeIn .15s ease-out"}},
      React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:16,padding:24,maxWidth:320,width:"100%",animation:"fadeUp .2s ease-out"}},
        React.createElement("p",{style:{fontSize:14,fontFamily:"var(--f)",color:"var(--text)",marginBottom:20,lineHeight:1.5,textAlign:"center"}},confirmDlg.msg),
        React.createElement("div",{style:{display:"flex",gap:10}},
          React.createElement("button",{onClick:function(){setConfirmDlg(null)},className:"btn btn-ghost",style:{flex:1}},"Cancel"),
          React.createElement("button",{onClick:function(){if(confirmDlg.onOk)confirmDlg.onOk()},style:{flex:1,background:confirmDlg.danger?"rgba(200,90,58,0.9)":"var(--gold)",border:"none",borderRadius:10,padding:14,cursor:"pointer",fontFamily:"var(--f)",fontSize:14,fontWeight:600,color:"#fff",minHeight:48}},"Confirm")))),
    /* Save Toast */
    showSaveToast&&React.createElement("div",{className:"fu",style:{position:"fixed",bottom:84,right:16,zIndex:91,background:"rgba(122,184,122,0.95)",color:"#fff",borderRadius:10,padding:"10px 18px",fontFamily:"var(--f)",fontSize:12,fontWeight:600,boxShadow:"0 4px 16px rgba(0,0,0,0.3)"}},"‚úì All changes saved!"),
    /* ‚ïê‚ïê‚ïê UNDO DELETE TOAST ‚ïê‚ïê‚ïê */
    undoDelete&&React.createElement("div",{className:"fu",style:{position:"fixed",bottom:84,left:16,right:16,zIndex:92,background:"rgba(200,90,58,0.95)",color:"#fff",borderRadius:12,padding:"12px 16px",fontFamily:"var(--f)",fontSize:12,fontWeight:500,boxShadow:"0 4px 20px rgba(0,0,0,0.4)",display:"flex",alignItems:"center",gap:10}},
      React.createElement("span",{style:{flex:1}},"üóëÔ∏è Outfit deleted"),
      React.createElement("button",{onClick:undoDeleteFn,style:{background:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.4)",borderRadius:8,padding:"6px 16px",cursor:"pointer",color:"#fff",fontFamily:"var(--f)",fontSize:12,fontWeight:700,minHeight:30}},"‚Ü© Undo"),
      React.createElement("button",{onClick:function(){if(undoTimerRef.current){clearTimeout(undoTimerRef.current);undoTimerRef.current=null}setUndoDelete(null)},style:{background:"none",border:"none",color:"rgba(255,255,255,0.6)",fontSize:14,cursor:"pointer",padding:"4px"}},"‚úï")),

    /* HEADER */
    React.createElement("div",{style:{background:theme==="light"?"linear-gradient(180deg,#f0efe8,var(--bg))":"linear-gradient(180deg,var(--card),var(--bg))",borderBottom:"1px solid var(--border)",padding:"max(env(safe-area-inset-top,12px),12px) 16px 0"}},
      React.createElement("div",{style:{maxWidth:860,margin:"0 auto"}},
        React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
            React.createElement("h1",{style:{fontSize:20,fontWeight:300,letterSpacing:"0.14em",color:"var(--gold)"}},"WATCH ADVISOR"),
            /* Back / Forward nav buttons */
            canGoBack&&React.createElement("button",{onClick:function(){try{window.history.back()}catch(e){navBack()}},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"4px 10px",cursor:"pointer",color:"var(--gold)",fontSize:14,minHeight:32,transition:"all .2s cubic-bezier(.22,.68,0,1)",opacity:1},title:"Back"},"‚Äπ"),
            canGoFwd&&React.createElement("button",{onClick:navFwd,style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"4px 10px",cursor:"pointer",color:"var(--gold)",fontSize:14,minHeight:32,transition:"all .2s cubic-bezier(.22,.68,0,1)",opacity:1},title:"Forward"},"‚Ä∫")),
          React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center"}},
            React.createElement("button",{className:"theme-toggle",onClick:function(){var nt=theme==="dark"?"light":"dark";setTheme(nt);ps("wa_theme",nt)},title:theme==="dark"?"Switch to Day mode":"Switch to Night mode"},theme==="dark"?"‚òÄÔ∏è":"üåô"),
            React.createElement("button",{onClick:function(){setShowSettings(true)},style:{background:"none",border:"1px solid "+(apiKey?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:8,padding:"6px 10px",cursor:"pointer",color:apiKey?"var(--good)":"var(--dim)",fontSize:14,minHeight:32}},apiKey?"üîë":"‚öôÔ∏è"))),
        React.createElement("div",{role:"tablist",style:{display:"flex",gap:0,marginTop:6},className:"hscroll"},
          [{id:"wardrobe",l:"üëï CLOSET",c:wd.length},{id:"fits",l:"‚ú® FITS",c:0},{id:"insights",l:"üîÆ INSIGHTS",c:0},{id:"watches",l:"‚åö WATCHES",c:actW.length},{id:"saved",l:"üíæ SAVED",c:saved.length}].map(function(t){
            return React.createElement("button",{key:t.id,role:"tab","aria-selected":view===t.id&&!selFit,onClick:function(){if(view!==t.id||selFit)navTo(t.id,null)},style:{background:"none",border:"none",borderBottom:view===t.id&&!selFit?"2px solid var(--gold)":"2px solid transparent",color:view===t.id&&!selFit?"var(--gold)":"var(--dim)",padding:"10px 14px",fontFamily:"var(--f)",fontSize:10,fontWeight:500,letterSpacing:"0.1em",cursor:"pointer",whiteSpace:"nowrap",flexShrink:0,minHeight:40}},
              t.l+(t.c>0?" "+t.c:""))})),
        React.createElement("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",gap:8,marginTop:2,paddingBottom:2}},React.createElement("button",{onClick:function(){if("serviceWorker" in navigator){navigator.serviceWorker.getRegistration().then(function(reg){if(reg){reg.update().then(function(){if(reg.waiting){reg.waiting.postMessage({type:"SKIP_WAITING"});window.location.reload()}else{window.location.reload()}}).catch(function(){window.location.reload()})}else{window.location.reload()}})}else{window.location.reload()}},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"2px 8px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:8}},"üîÑ Update"),React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"v24.11")))),

    React.createElement("div",{ref:mainRef,style:{maxWidth:860,margin:"0 auto",padding:"0 16px"}},

      /* ‚ïê‚ïê‚ïê WARDROBE ‚ïê‚ïê‚ïê */
      view==="wardrobe"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        wxErr&&!weather&&React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",border:"1px solid rgba(200,90,58,0.25)",borderRadius:12,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",gap:10}},
          React.createElement("span",{style:{fontSize:18}},"‚ö†Ô∏è"),
          React.createElement("div",null,
            React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"Weather unavailable"),
            React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},"Scoring defaults to mid-weight. Enable location or check connection.")),
          React.createElement("button",{onClick:function(){setWxErr(false);if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(p){setLoc({lat:p.coords.latitude,lon:p.coords.longitude,name:"Your Location"})},function(){},{timeout:5000})},style:{background:"none",border:"1px solid rgba(200,90,58,0.3)",borderRadius:8,padding:"6px 12px",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",whiteSpace:"nowrap"}},"Retry")),
        weather&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid "+(planWx&&planWx.rain?"rgba(100,150,220,0.4)":"var(--border)"),borderRadius:12,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"}},
          React.createElement("span",{style:{fontSize:22}},planWx&&planWx.cond?planWx.cond.i:tier?tier.icon:""),
          React.createElement("div",null,React.createElement("div",{style:{fontSize:18,fontWeight:600,fontFamily:"var(--f)"}},planTemp?planTemp.temp+"¬∞C":weather.temp+"¬∞C"),React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Feels "+(planTemp?planTemp.feels:weather.feels)+"¬∞C ¬∑ "+loc.name+(planDay>0&&forecast[planDay]?" ¬∑ "+forecast[planDay].date:""))),
          React.createElement("div",{style:{flex:1,minWidth:100}},
            React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},planWx&&planWx.cond?planWx.cond.l:tier?tier.label:""),
            React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},tier?tier.advice:"")),
          planWx&&React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
            planWx.rainPct>0&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.rainPct>=50?"#7ab8d8":"var(--sub)",background:planWx.rainPct>=50?"rgba(100,150,220,0.1)":"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid "+(planWx.rainPct>=50?"rgba(100,150,220,0.25)":"var(--border)")}},"üåßÔ∏è "+planWx.rainPct+"%"),
            planWx.uv>=4&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.uv>=8?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"‚òÄÔ∏è UV "+planWx.uv),
            planWx.wind>=20&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.wind>=40?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"üí® "+planWx.wind+"km/h"))),

        React.createElement("input",{ref:fRef,type:"file",accept:"image/*",multiple:true,style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("input",{ref:cRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("div",{style:{border:"2px dashed var(--border)",borderRadius:14,padding:"18px 16px",textAlign:"center",background:"var(--card)",marginBottom:14}},
          React.createElement("p",{style:{fontSize:18,margin:"0 0 4px"}},"üì∏"),
          React.createElement("p",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:500,margin:"0 0 10px"}},"Upload photos or add manually"),
          React.createElement("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}},
            React.createElement("button",{onClick:function(){if(fRef.current)fRef.current.click()},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",borderRadius:8,padding:"12px 18px",color:"var(--bg)",fontFamily:"var(--f)",fontSize:12,fontWeight:600,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center",border:"none"}},"üìÅ Upload"),
            React.createElement("button",{onClick:function(){if(cRef.current)cRef.current.click()},style:{background:"var(--card2)",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center"}},"üì∑ Camera"),
            React.createElement("button",{onClick:function(){setAddG(true)},style:{background:"var(--card2)",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44}},"‚úèÔ∏è Manual"))),

        proc.length>0&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginBottom:12}},proc.map(function(p){return React.createElement("div",{key:p,style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",display:"flex",alignItems:"center",gap:8}},React.createElement("div",{className:"sp",style:{width:14,height:14,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Identifying..."))})),

        wd.length>0&&React.createElement(React.Fragment,null,
          needsFix>0&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",margin:0,fontWeight:500,flex:1}},"‚ö†Ô∏è "+needsFix+" items need classification ‚Äî tap to set type & color"),
              React.createElement("button",{onClick:async function(){
                var broken=wd.filter(function(i){return(i.needsEdit||!i.color)&&i.photoUrl});
                if(!broken.length)return;
                for(var k=0;k<broken.length;k++){
                  var it=broken[k];
                  try{var compressed=await compressImage(it.photoUrl,600,0.6);var b64=compressed.split(",")[1];
                    var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
                    if(aiResult&&aiResult.length)updG(it.id,aiResult[0]);else setAiErr(getLastAiError());
                  }catch(e){console.warn("[WA]",e)}
                  if(k<broken.length-1)await new Promise(function(r){setTimeout(r,800)});
                }
              },style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"8px 14px",fontFamily:"var(--f)",fontSize:11,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",minHeight:36}},"üîÑ Retry AI"))),
          aiErr&&React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"flex-start",gap:8}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",margin:0,flex:1,wordBreak:"break-all"}},"üö® AI Error: "+aiErr),
              React.createElement("button",{onClick:function(){setAiErr("")},style:{background:"none",border:"none",color:"var(--warn)",cursor:"pointer",fontSize:14}},"‚úï"))),

          React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:10}},
            [{id:"all",l:"All "+wd.length},{id:"tops",l:"Tops "+byCat.tops.length},{id:"bottoms",l:"Btms "+byCat.bottoms.length},{id:"shoes",l:"Shoes "+byCat.shoes.length}].map(function(f){return React.createElement(Pill,{key:f.id,on:wFilt===f.id,onClick:function(){setWFilt(f.id);setWMatFilt("all");setWColFilt("all");setGridLimit(24)}},f.l)}),
            React.createElement("button",{onClick:function(){var dupes=findDuplicates();setDupeGroups(dupes);setShowDupes(true)},style:{background:"none",border:"1px solid rgba(201,168,76,0.3)",borderRadius:20,padding:"8px 14px",color:"var(--gold)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",minHeight:36,marginLeft:"auto"}},"üîç Duplicates"),
            React.createElement("button",{onClick:function(){setConfirmDlg({msg:"Clear entire wardrobe?",danger:true,onOk:function(){saveWd([]);setWFilt("all");setConfirmDlg(null)}})},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:20,padding:"8px 14px",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",minHeight:36}},"Clear"),
            (function(){var archCount=wd.filter(function(i){return i.archived}).length;return archCount>0?React.createElement(Pill,{on:showArchived,onClick:function(){setShowArchived(!showArchived)}},(showArchived?"üëÅÔ∏è Hide":"‚ùÑÔ∏è Show")+" "+archCount+" archived"):null})()), 
          /* Material quick-filter */
          (function(){var filteredForMats=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});var mc={};filteredForMats.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var mats=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,8);return mats.length>=2?React.createElement("div",{className:"hscroll",style:{display:"flex",gap:4,marginBottom:8,paddingBottom:2}},React.createElement(Pill,{on:wMatFilt==="all",onClick:function(){setWMatFilt("all")}},"All Materials"),mats.map(function(m){return React.createElement(Pill,{key:m[0],on:wMatFilt===m[0],onClick:function(){setWMatFilt(wMatFilt===m[0]?"all":m[0])}},m[0]+" √ó"+m[1])})):null})(),

          /* Color quick-filter dots */
          (function(){var filteredForCols=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});var cc={};filteredForCols.forEach(function(i){if(i.color)cc[i.color]=(cc[i.color]||0)+1});var cols=Object.entries(cc).sort(function(a,b){return b[1]-a[1]}).slice(0,16);return cols.length>=3?React.createElement("div",{className:"hscroll",style:{display:"flex",gap:5,marginBottom:8,paddingBottom:2}},React.createElement("span",{onClick:function(){setWColFilt("all")},style:{display:"inline-flex",alignItems:"center",gap:3,fontSize:8,fontFamily:"var(--f)",padding:"3px 8px",borderRadius:12,cursor:"pointer",background:wColFilt==="all"?"rgba(201,168,76,0.15)":"transparent",border:"1px solid "+(wColFilt==="all"?"rgba(201,168,76,0.3)":"var(--border)"),color:wColFilt==="all"?"var(--gold)":"var(--dim)",whiteSpace:"nowrap"}},"All"),cols.map(function(c){return React.createElement("span",{key:c[0],onClick:function(){setWColFilt(wColFilt===c[0]?"all":c[0])},style:{display:"inline-flex",alignItems:"center",gap:3,fontSize:8,fontFamily:"var(--f)",padding:"3px 8px",borderRadius:12,cursor:"pointer",background:wColFilt===c[0]?"rgba(201,168,76,0.15)":"transparent",border:"1px solid "+(wColFilt===c[0]?"rgba(201,168,76,0.3)":"var(--border)"),color:wColFilt===c[0]?"var(--gold)":"var(--dim)",whiteSpace:"nowrap"}},React.createElement(Dot,{color:c[0],size:6}),c[0]+" √ó"+c[1])})):null})(),
          /* Hidden re-scan input */
          React.createElement("input",{ref:reScanRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"}}),
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(105px,1fr))",gap:8}},
            filteredWd.slice(0,gridLimit).map(function(item){
              return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setEditG(item)},style:{background:item.needsEdit||!item.color?"var(--card2)":"var(--card)",border:"1px solid "+(item.needsEdit||!item.color?"rgba(201,168,76,0.3)":"var(--border)")}},
                item.photoUrl?React.createElement(React.Fragment,null,React.createElement(LazyImg,{src:ph(item.photoUrl),alt:"",onClick:function(e){e.stopPropagation();openLightbox(item.photoUrl,item.id)},style:{width:"100%",height:90,objectFit:"cover",display:"block",cursor:"zoom-in"}}),React.createElement("div",{className:"gcard-overlay"})):React.createElement("div",{style:{width:"100%",height:60,background:(CM[item.color]||{}).h||"#2a2a2a",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"#fff8",textShadow:"0 1px 3px #000"}},item.color)),
                React.createElement("div",{style:{padding:"6px 8px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                    item.color&&React.createElement(Dot,{color:item.color,size:6}),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}},item.name||item.color||"Tap to classify")),
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" ¬∑ "+item.pattern:""))),
                (item.needsEdit||!item.color)&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(201,168,76,0.9)",borderRadius:4,padding:"2px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--bg)",fontWeight:700}},"FIX")),
                item.positionHint&&React.createElement("div",{style:{position:"absolute",top:4,left:4,background:"rgba(0,0,0,0.7)",borderRadius:4,padding:"1px 5px"}},React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)"}},"üì∏ "+item.positionHint)),
                item.photoUrl&&React.createElement("button",{onClick:function(e){e.stopPropagation();var inp=reScanRef.current;if(!inp)return;inp.onchange=async function(ev){var fl=ev.target.files[0];if(!fl)return;try{var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,1200,0.82);updG(item.id,{photoUrl:compressed});inp.value=""}catch(err){console.error(err)}};inp.click()},style:{position:"absolute",bottom:28,right:24,background:"rgba(0,0,0,0.65)",border:"none",borderRadius:4,padding:"2px 5px",cursor:"pointer",color:"#fff",fontSize:8,zIndex:2,lineHeight:1},title:"Re-photograph"},"üì∏"),
                item.material&&React.createElement("div",{style:{position:"absolute",bottom:28,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:"#aaa"}},item.material)),
                item.lastWorn&&React.createElement("div",{style:{position:"absolute",bottom:28,left:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d<=2?"#e8a87c":d<=7?"#aaa":"#7a7"})()}},(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d===0?"worn today":d===1?"1d ago":d+"d ago"})())),
                item.seasons&&item.seasons.length>0&&item.seasons.length<4&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 3px"}},React.createElement("span",{style:{fontSize:6}},item.seasons.map(function(s){return{spring:"üå∏",summer:"‚òÄÔ∏è",fall:"üçÇ",winter:"‚ùÑÔ∏è"}[s]||""}).join(""))))})),

          /* Load More pagination */
          filteredWd.length>gridLimit&&React.createElement("button",{onClick:function(){setGridLimit(function(p){return p+24})},style:{width:"100%",marginTop:10,background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"12px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:44,}},"Show more ("+Math.min(24,filteredWd.length-gridLimit)+" of "+(filteredWd.length-gridLimit)+" remaining)"),
          React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 14px",marginTop:12}},
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",margin:0}},wdStats.summary),
            wdStats.unused>0&&React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",margin:"4px 0 0"}},"üí§ "+wdStats.unused+" item"+(wdStats.unused!==1?"s":"")+" never saved in an outfit"),
            /* Freshness bar */
            (function(){if(!wdStats.hasWorn)return null;var fresh=wdStats.fresh,mid=wdStats.mid,stale=wdStats.stale,total=fresh+mid+stale;if(!total)return null;return React.createElement("div",{style:{marginTop:6}},React.createElement("div",{style:{display:"flex",gap:8,fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:3}},React.createElement("span",null,"Rotation freshness:"),fresh>0&&React.createElement("span",{style:{color:"var(--good)"}},"üü¢ "+fresh+" fresh"),mid>0&&React.createElement("span",{style:{color:"var(--gold)"}},"üü° "+mid+" ok"),stale>0&&React.createElement("span",{style:{color:"var(--warn)"}},"üî¥ "+stale+" stale")),React.createElement("div",{style:{height:3,borderRadius:2,background:"var(--bg)",overflow:"hidden",display:"flex"}},fresh>0&&React.createElement("div",{style:{width:fresh/total*100+"%",background:"var(--good)"}}),mid>0&&React.createElement("div",{style:{width:mid/total*100+"%",background:"var(--gold)"}}),stale>0&&React.createElement("div",{style:{width:stale/total*100+"%",background:"var(--warn)"}})))})()))),

      /* ‚ïê‚ïê‚ïê FITS ‚ïê‚ïê‚ïê */
      view==="fits"&&!selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* MODE CARDS */
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:12}},
          [{id:"auto",icon:"‚ú®",l:"Smart",d:"AI-scored"},{id:"build",icon:"üß©",l:"Create",d:"Build & save"},{id:"selfie",icon:"üì∏",l:"Selfie",d:"Check look"},{id:"rotation",icon:"üìÖ",l:"Week",d:"7-day plan"}].map(function(m){
            var on=mode===m.id;
            return React.createElement("button",{key:m.id,onClick:function(){setMode(m.id);if(m.id!=="auto"){setLockItem(null);setTopType("all")}},style:{background:on?"rgba(201,168,76,0.1)":"var(--card)",border:"1px solid "+(on?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:12,padding:"12px 8px",cursor:"pointer",textAlign:"center",transition:"all .15s"}},
              React.createElement("div",{style:{fontSize:20,marginBottom:2}},m.icon),
              React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:on?700:500,color:on?"var(--gold)":"var(--text)"}},m.l),
              React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:on?"var(--gold)":"var(--dim)",opacity:0.7}},m.d))})),

        /* DAY SELECTOR for Auto/Build */
        mode!=="rotation"&&mode!=="selfie"&&forecast.length>0&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              var t=getWT(fc.feelsAvg);var hasRain=fc.cond&&fc.cond.rain;
              return React.createElement("button",{key:i,onClick:function(){setPlanDay(i)},style:{flex:"0 0 auto",background:planDay===i?"rgba(201,168,76,0.15)":hasRain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(planDay===i?"rgba(201,168,76,0.4)":hasRain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"8px 10px",cursor:"pointer",minWidth:68,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--gold)":"var(--sub)",fontWeight:planDay===i?700:400}},i===0?"Today":i===1?"Tmrw":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:t?t.icon:""),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--text)":"var(--dim)",fontWeight:600}},fc.high+"¬∞/"+fc.low+"¬∞"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)",fontWeight:fc.rainPct>=50?600:400}},"üíß"+fc.rainPct+"%"),
                fc.wind>=25&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},"üí®"+fc.wind))}))),

        /* CONTEXT + CONTROLS ROW */
        mode!=="rotation"&&mode!=="selfie"&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:5,marginBottom:8}},
            planDay>0&&JSON.stringify(effectiveCtx)!==JSON.stringify(ctx)&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",alignSelf:"center",marginRight:4}},"üìÖ "+(activeCxIcons[primaryCtx]||CXI[primaryCtx]||"")+primaryCtx),
            CTXS.map(function(c){return React.createElement(Pill,{key:c.id,on:Array.isArray(ctx)?ctx.includes(c.id):ctx===c.id,onClick:function(){setCtx(function(prev){var arr=Array.isArray(prev)?prev:[prev];if(arr.includes(c.id)){var f=arr.filter(function(x){return x!==c.id});return f.length?f:["smart-casual"]}return arr.concat([c.id])});if(planDay>0)setPlanDay(0)}},c.l)}),
            !IS_SHARED&&React.createElement("button",{onClick:function(){setReps(!reps)},style:{background:reps?"rgba(201,168,76,0.08)":"var(--card)",border:"1px solid "+(reps?"rgba(201,168,76,0.25)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",marginLeft:"auto",color:reps?"var(--gold)":"var(--dim)",fontFamily:"var(--f)",fontSize:11,minHeight:36}},reps?"Rep ON":"Rep OFF"))),

        /* AUTO-SPECIFIC FILTERS */
        mode==="auto"&&React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center",marginBottom:10}},
          /* Top type filter */
          [{id:"all",l:"All Tops"},{id:"Shirt",l:"üëî Shirts"},{id:"Polo",l:"üèá Polos"},{id:"T-Shirt",l:"üëï Tees"},{id:"Sweater/Knit",l:"üß∂ Knits"},{id:"Jacket/Blazer",l:"üß• Jackets"}].map(function(tf){
            return React.createElement("span",{key:tf.id,className:"chip "+(topType===tf.id?"on":""),onClick:function(){setTopType(topType===tf.id&&tf.id!=="all"?"all":tf.id)}},tf.l)}),
          /* Shuffle */
          React.createElement("button",{onClick:function(){setShuffleKey(shuffleKey+1);setPieceSwap({});setPiecePicker(null);setPieceFilter(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:20,padding:"6px 12px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,marginLeft:"auto",minHeight:32}},"üé≤ Shuffle"),
          /* Count */
          React.createElement("select",{className:"sel",value:fitCount,onChange:function(e){setFitCount(parseInt(e.target.value))},style:{width:52,padding:"6px 4px",fontSize:10,textAlign:"center",borderRadius:8}},
            [6,10,15,20].map(function(n){return React.createElement("option",{key:n,value:n},n)}))),

        /* Lock item banner */
        mode==="auto"&&lockItem&&React.createElement("div",{className:"fu",style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:10}},
          lockItem.photoUrl&&React.createElement("img",{src:ph(lockItem.photoUrl),alt:"",style:{width:32,height:32,objectFit:"cover",borderRadius:6}}),
          React.createElement(Dot,{color:lockItem.color,size:8}),
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"üîí Locked: "+( lockItem.name||lockItem.color)+" ‚Äî showing fits around this piece"),
          React.createElement("button",{onClick:function(){setLockItem(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"‚úï Unlock")),

        /* BUILD */
        mode==="build"&&React.createElement("div",null,
          /* ‚ïê‚ïê‚ïê DYNAMIC UPPER LAYERS ‚Äî unlimited, renameable ‚ïê‚ïê‚ïê */
          React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:8}},
            /* Section label */
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.15em"}},"LAYERS"),
              React.createElement("div",{style:{display:"flex",gap:6}},
                buildLayers.length>1&&React.createElement("button",{onClick:function(){setBuildLayers([{id:1,label:"BASE",item:null}]);nextLayerId.current=2;setBuildSlot(null);setBuildAiCritique(null)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"3px 8px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:8,minHeight:22}},"‚úï Clear all"),
                React.createElement("button",{onClick:function(){var nid=nextLayerId.current++;var defaultLabels=["BASE","MID","OUTER","SHELL","LAYER "+nid];var lbl=defaultLabels[buildLayers.length]||"LAYER "+nid;setBuildLayers(function(p){return p.concat([{id:nid,label:lbl,item:null}])})},style:{background:"rgba(201,168,76,0.08)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:6,padding:"3px 10px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:8,fontWeight:600,minHeight:22}},"+ Add Layer"))),
            /* Layer slots grid ‚Äî responsive: 3 cols if ‚â§3, else wrapping */
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:buildLayers.length<=3?"repeat("+buildLayers.length+",1fr)":"repeat(auto-fill,minmax(90px,1fr))",gap:8}},
              buildLayers.map(function(layer,li){
                var slotId="layer-"+layer.id;
                return React.createElement("div",{key:layer.id,className:"outfit-slot "+(layer.item?"filled":"")+" "+(buildSlot===slotId?"active":""),onClick:function(){setBuildSlot(buildSlot===slotId?null:slotId)},style:{position:"relative"}},
                  layer.item?React.createElement(React.Fragment,null,
                    layer.item.photoUrl?React.createElement("img",{src:ph(layer.item.photoUrl),alt:"",style:{width:"100%",height:50,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:layer.item.color,size:18}),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},layer.item.name||layer.item.color),
                    React.createElement("div",{style:{display:"flex",gap:2,justifyContent:"center"}},
                      React.createElement("button",{onClick:function(e){e.stopPropagation();setBuildLayers(function(p){return p.map(function(l){return l.id===layer.id?Object.assign({},l,{item:null}):l})});setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",minHeight:20}},"‚úï"),
                      buildLayers.length>1&&React.createElement("button",{onClick:function(e){e.stopPropagation();setBuildLayers(function(p){return p.filter(function(l){return l.id!==layer.id})});if(buildSlot===slotId)setBuildSlot(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--del-text)",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",minHeight:20}},"üóëÔ∏è")))
                  :React.createElement(React.Fragment,null,
                    /* Editable label ‚Äî tap to rename */
                    React.createElement("input",{value:layer.label,onClick:function(e){e.stopPropagation()},onChange:function(e){var newLabel=e.target.value.toUpperCase().slice(0,12);setBuildLayers(function(p){return p.map(function(l){return l.id===layer.id?Object.assign({},l,{label:newLabel}):l})})},style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",background:"transparent",border:"none",textAlign:"center",width:"100%",cursor:"text",outline:"none",padding:0},maxLength:12}),
                    React.createElement("span",{style:{fontSize:18,color:"var(--dim)"}},"+"),
                    React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},li===0?"T-Shirt / Shirt":"Any top layer"),
                    buildLayers.length>1&&React.createElement("button",{onClick:function(e){e.stopPropagation();setBuildLayers(function(p){return p.filter(function(l){return l.id!==layer.id})});if(buildSlot===slotId)setBuildSlot(null)},style:{background:"none",border:"none",color:"var(--del-text)",fontSize:7,fontFamily:"var(--f)",cursor:"pointer",minHeight:16,marginTop:2}},"remove")))}))),
          /* Bottom row: bottoms + shoes */
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}},
            [{slot:"bot",l:"BOTTOM",sub:"Pants / Jeans",val:bBot,set:setBBot},{slot:"shoe",l:"SHOES",sub:"Footwear",val:bShoe,set:setBShoe}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:ph(o.val.photoUrl),alt:"",style:{width:"100%",height:50,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:18}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"‚úï clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:18,color:"var(--dim)"}},"+"),
                  React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},o.sub)))})),
          /* Accessory row */
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:8,marginBottom:16}},
            [{slot:"acc",l:"ACCESSORY",sub:"Hat / Scarf / Belt / Bag",val:bAcc,set:setBAcc}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)},style:{minHeight:48}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:ph(o.val.photoUrl),alt:"",style:{width:"100%",height:40,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:16}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"‚úï clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:16,color:"var(--dim)"}},"+"),
                  React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},o.sub)))})),

          buildSlot&&(function(){
            /* Determine category and setter based on slot type */
            var isLayer=buildSlot.startsWith("layer-");
            var cat=isLayer?"tops":buildSlot==="bot"?"bottoms":buildSlot==="acc"?"accessories":"shoes";
            var items=byCat[cat].filter(function(i){return i.color&&!i.needsEdit});
            /* For layers: show all tops, no restrictive filtering ‚Äî full flexibility */
            var setter;var pickLabel;
            if(isLayer){
              var layerId=parseInt(buildSlot.split("-")[1]);
              setter=function(item){setBuildLayers(function(p){return p.map(function(l){return l.id===layerId?Object.assign({},l,{item:item}):l})})};
              var layerObj=buildLayers.find(function(l){return l.id===layerId});
              pickLabel=(layerObj?layerObj.label.toLowerCase():"a")+" layer piece";
            }else{
              setter=buildSlot==="bot"?setBBot:buildSlot==="acc"?setBAcc:setBShoe;
              pickLabel=buildSlot==="bot"?"bottoms":buildSlot==="acc"?"an accessory":"shoes";
            }
            return React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:16}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8}},"Pick "+pickLabel),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(80px,1fr))",gap:8}},
                items.map(function(item){return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setter(item);setBuildSlot(null);setBuildAiCritique(null)},style:{background:"var(--bg)",border:"2px solid transparent",textAlign:"center"}},
                  item.photoUrl?React.createElement("img",{src:ph(item.photoUrl),alt:"",style:{width:"100%",height:60,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{height:40,display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement(Dot,{color:item.color,size:14})),
                  React.createElement("div",{style:{padding:"4px 4px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",fontWeight:500}},item.name||item.color)))}),
                !items.length&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",gridColumn:"1/-1",padding:10}},"No classified items")));
          })(),

          buildFit?React.createElement("div",{className:"fu",style:{background:"var(--card2)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"16px"}},
            React.createElement("div",{style:{marginBottom:12}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},
                React.createElement("span",{style:{fontSize:15,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"Score: "+buildFit.fs),
                React.createElement("div",{style:{display:"flex",gap:6}},
                  React.createElement("button",{className:"btn btn-gold",style:{width:"auto",padding:"10px 18px",fontSize:11},onClick:function(){saveFit(buildFit);if(buildName.trim()){setSaved(function(p){var n=p.slice();if(n.length>0){n[n.length-1]=Object.assign({},n[n.length-1],{name:buildName.trim()});ps("of_"+SK,n);}return n;});}setBuildName("");setBuildAiCritique(null);}},"üíæ Save"),
                  React.createElement("button",{className:"btn btn-ghost",style:{width:"auto",padding:"10px 14px",fontSize:11},onClick:async function(){var critW=buildWatch||(buildFit.watches&&buildFit.watches[0]);if(!critW)return;setBuildAiLoading(true);var result=await aiVision({top:buildFit.outerTop||buildFit.top,bot:buildFit.bot,shoe:buildFit.shoe,layers:buildFit.tops},critW,effectiveCtx,apiKeyRef.current);setBuildAiCritique(result||{vision:"AI unavailable. Check your API key in settings.",impact:0});setBuildAiLoading(false)},disabled:buildAiLoading},buildAiLoading?"‚è≥ Analyzing...":"‚ú® AI Critique"))),
              React.createElement("input",{className:"inp",value:buildName,onChange:function(e){setBuildName(e.target.value)},placeholder:"Name this outfit (optional)",style:{fontSize:12}})),
            buildFit.wxWarns&&buildFit.wxWarns.length>0&&React.createElement("div",{style:{marginBottom:10,display:"flex",gap:4,flexWrap:"wrap"}},
              buildFit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
            /* Watch selection */
            React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}},
                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.1em"}},"‚åö WATCH PAIRING"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},buildWatch?"Tap again to deselect":"Tap to choose")),
              buildWatch&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:8}},
                React.createElement("span",{style:{fontSize:18}},buildWatch.i),
                React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"üîí "+buildWatch.n),
                React.createElement("button",{onClick:function(){setBuildWatch(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"‚úï Clear")),
              React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},
                buildFit.allW.slice(0,6).map(function(w,i){return React.createElement("div",{key:w.id,onClick:function(){setBuildWatch(buildWatch&&buildWatch.id===w.id?null:w);setBuildAiCritique(null)},style:{cursor:"pointer",border:buildWatch&&buildWatch.id===w.id?"2px solid var(--gold)":"2px solid transparent",borderRadius:14,transition:"all .15s"}},React.createElement(WCard,{w:w,rank:buildWatch?buildWatch.id===w.id?0:null:i,detail:true}))}))),
            /* Outfit mannequin preview */
            (function(){var selW=buildWatch||((buildFit.watches&&buildFit.watches[0])?buildFit.watches[0]:null);return React.createElement("div",{style:{display:"flex",justifyContent:"center",marginTop:14,marginBottom:8}},
              React.createElement(OutfitFigure,{topColor:buildFit.outerTop?buildFit.outerTop.color:buildFit.top?buildFit.top.color:"grey",botColor:buildFit.bot?buildFit.bot.color:"charcoal",shoeColor:buildFit.shoe?buildFit.shoe.color:"black",watchColor:selW?selW.c:"#c9a84c",watchIcon:selW?selW.i:"‚åö",watchName:selW?selW.n:"",size:120}))})(),
            /* Layers summary */
            buildFit.tops&&buildFit.tops.length>1&&React.createElement("div",{style:{display:"flex",justifyContent:"center",gap:6,marginBottom:8,flexWrap:"wrap"}},
              buildFit.tops.map(function(t,ti){var layerLabel=buildLayers[ti]?buildLayers[ti].label:(ti===0?"Base":"L"+(ti+1));return React.createElement("div",{key:ti,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},
                t.photoUrl?React.createElement("img",{src:ph(t.photoUrl),alt:"",style:{width:16,height:16,objectFit:"cover",borderRadius:3}}):React.createElement(Dot,{color:t.color,size:6}),
                React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)"}},layerLabel),
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--text)"}},t.name||t.color))})),
            /* AI Critique for custom build */
            buildAiCritique&&React.createElement("div",{className:"fu",style:{background:"rgba(201,168,76,0.04)",borderRadius:12,padding:"14px",marginTop:10,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
                React.createElement("span",{style:{fontSize:16}},"‚ú®"),
                React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"AI Analysis")),
              buildAiCritique.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,borderLeft:"3px solid var(--gold)"}},
                React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},buildAiCritique.vision)),
              buildAiCritique.impact>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:8}},
                React.createElement("div",{style:{width:42,height:42,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:buildAiCritique.impact>=7?"rgba(122,184,122,0.15)":buildAiCritique.impact>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:16,fontFamily:"var(--f)",fontWeight:700,color:buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"}},buildAiCritique.impact),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"}},buildAiCritique.impact>=8?"Commanding":buildAiCritique.impact>=6?"Solid":buildAiCritique.impact>=4?"Acceptable":"Needs Work"),
                  buildAiCritique.impact_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},buildAiCritique.impact_why))),
              [buildAiCritique.color_story&&{l:"üé® Colors",t:buildAiCritique.color_story,c:"#9a8abc"},buildAiCritique.works&&{l:"‚úì What Works",t:buildAiCritique.works,c:"var(--good)"},buildAiCritique.risk&&{l:"‚ö† Risk",t:buildAiCritique.risk,c:"var(--warn)"},buildAiCritique.upgrade&&{l:"‚¨Ü Upgrade",t:buildAiCritique.upgrade,c:"var(--gold)"},buildAiCritique.strap_call&&{l:"üîó Strap",t:buildAiCritique.strap_call,c:"var(--sub)"}].filter(Boolean).map(function(item,i){
                return React.createElement("div",{key:i,style:{display:"flex",gap:8,marginBottom:4}},
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:item.c,fontWeight:600,minWidth:70}},item.l),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},item.t))}),
              React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8,fontSize:10},onClick:function(){setBuildAiCritique(null)}},"‚Üª Re-analyze")))
          :!buildSlot&&React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:20}},"Tap the slots above to build your outfit ‚Äî use \"+Add Layer\" for sweater + jacket combos")),

        /* SELFIE CHECK */
        mode==="selfie"&&React.createElement("div",null,
          React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"20px",marginBottom:16,textAlign:"center"}},
            React.createElement("div",{style:{fontSize:32,marginBottom:8}},"üì∏"),
            React.createElement("div",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600,marginBottom:4}},"Selfie Check"),
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:16}},"Take a selfie or upload a photo to get an AI style analysis with impact score"),
            React.createElement("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}},
              React.createElement("button",{onClick:function(){selfieRef.current&&selfieRef.current.click()},className:"btn btn-gold",style:{padding:"12px 20px",fontSize:12}},"ü§≥ Selfie"),
              React.createElement("button",{onClick:function(){selfieRearRef.current&&selfieRearRef.current.click()},className:"btn btn-ghost",style:{padding:"12px 20px",fontSize:12}},"üì∑ Camera"),
              React.createElement("button",{onClick:function(){selfieGalRef.current&&selfieGalRef.current.click()},className:"btn btn-ghost",style:{padding:"12px 20px",fontSize:12}},"üñºÔ∏è Gallery")),
            React.createElement("input",{ref:selfieRef,type:"file",accept:"image/*",capture:"user",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}}),
            React.createElement("input",{ref:selfieRearRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}}),
            React.createElement("input",{ref:selfieGalRef,type:"file",accept:"image/*",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}})),
          /* Loading */
          selfieLoading&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.3)",borderRadius:12,padding:"20px",marginBottom:12,textAlign:"center"}},
            React.createElement("div",{className:"sp",style:{width:28,height:28,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 10px"}}),
            React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing your look...")),
          /* Result */
          selfieResult&&!selfieLoading&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:16}},
            selfieResult.error?React.createElement("div",null,
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
                React.createElement("span",{style:{fontSize:18}},"‚ö†Ô∏è"),
                React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--warn)"}},selfieResult.error)),
              React.createElement("button",{onClick:function(){setSelfieResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))
            :React.createElement("div",null,
              /* Impact score */
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:14,marginBottom:14}},
                selfieResult.thumb&&React.createElement("img",{src:selfieResult.thumb,alt:"",style:{width:70,height:70,objectFit:"cover",borderRadius:12,border:"2px solid var(--gold)"}}),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
                    React.createElement("div",{style:{width:44,height:44,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"3px solid "+(selfieResult.result.impact>=8?"var(--good)":selfieResult.result.impact>=5?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:selfieResult.result.impact>=8?"var(--good)":selfieResult.result.impact>=5?"var(--gold)":"var(--warn)"}},selfieResult.result.impact+"/10"),
                    React.createElement("div",null,
                      React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--gold)"}},"Impact Score"),
                      selfieResult.result.impact_why&&React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.impact_why))))),
              /* Vision */
              selfieResult.result.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.1em",marginBottom:4}},"EDITORIAL"),
                React.createElement("p",{style:{fontSize:11,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},selfieResult.result.vision)),
              /* Color story */
              selfieResult.result.color_story&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"10px 12px",marginBottom:8,border:"1px solid var(--border)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"üé® COLORS "),
                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.color_story)),
              /* Works / Risk / Upgrade */
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:10}},
                selfieResult.result.works&&React.createElement("div",{style:{flex:1,minWidth:140,background:"rgba(122,184,122,0.06)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(122,184,122,0.15)"}},
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:2}},"‚úì WORKS"),
                  React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.works)),
                selfieResult.result.risk&&React.createElement("div",{style:{flex:1,minWidth:140,background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(200,90,58,0.15)"}},
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:2}},"‚ö†Ô∏è RISK"),
                  React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.risk))),
              selfieResult.result.upgrade&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(201,168,76,0.15)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"‚¨Ü UPGRADE "),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.upgrade)),
              selfieResult.result.strap_call&&React.createElement("div",{style:{background:"rgba(122,184,122,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(122,184,122,0.15)"}},
                React.createElement("span",{style:{fontSize:10,fontWeight:600,color:"var(--sub)",marginRight:6}},"üîó Strap"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.strap_call)),
              selfieResult.result.better_watch&&React.createElement("div",{style:{background:"rgba(154,138,188,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(154,138,188,0.15)"}},
                React.createElement("span",{style:{fontSize:10,fontWeight:600,color:"var(--sub)",marginRight:6}},"‚åö Better Pick"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.better_watch)),
              /* Watch detection */
              selfieResult.result.watch_details&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6}},
                  React.createElement("span",{style:{fontSize:14}},"‚åö"),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.watch_details),
                  selfieResult.result.watch_confidence&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:selfieResult.result.watch_confidence>=7?"var(--good)":selfieResult.result.watch_confidence>=4?"var(--gold)":"var(--dim)",background:"var(--card)",borderRadius:4,padding:"1px 5px",border:"1px solid var(--border)"}},selfieResult.result.watch_confidence+"/10"))),
              /* Fit assessment */
              selfieResult.result.fit_assessment&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"üìê FIT "),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.fit_assessment)),
              React.createElement("button",{onClick:function(){setSelfieResult(null)},className:"btn btn-ghost",style:{width:"100%",fontSize:10,marginTop:4}},"‚úï Close"))),
          /* History */
          selfieHistory.length>0&&React.createElement("div",{style:{marginTop:8}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement("span",{style:{fontSize:14}},"üìã"),
              React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600}},"History"),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},selfieHistory.length+" check"+(selfieHistory.length>1?"s":""))),
            selfieHistory.map(function(entry){
              return React.createElement("div",{key:entry.id,style:{display:"flex",gap:10,alignItems:"center",background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 12px",marginBottom:6}},
                entry.thumb&&React.createElement("img",{src:entry.thumb,alt:"",style:{width:44,height:44,objectFit:"cover",borderRadius:8,flexShrink:0}}),
                React.createElement("div",{style:{flex:1,minWidth:0}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6}},
                    React.createElement("div",{style:{width:28,height:28,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(entry.impact>=8?"var(--good)":entry.impact>=5?"var(--gold)":"var(--warn)"),fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:entry.impact>=8?"var(--good)":entry.impact>=5?"var(--gold)":"var(--warn)"}},entry.impact),
                    React.createElement("div",{style:{flex:1}},
                      React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},entry.result&&entry.result.impact_why?entry.result.impact_why.slice(0,60):"Style check"),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},new Date(entry.ts).toLocaleDateString()+" "+new Date(entry.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))))),
                React.createElement("button",{onClick:function(){setSelfieResult(entry)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:24}},"View"),
                React.createElement("button",{onClick:function(){delSelfie(entry.id)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:9,minHeight:24}},"‚úï"))}))),

        /* ROTATION */
        mode==="rotation"&&(function(){
          var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock,loc.lat);
          /* Apply alt swaps */
          Object.keys(altSwap).forEach(function(k){
            var di=parseInt(k),ai=altSwap[k];
            if(rotation[di]&&rotation[di].altOutfits&&rotation[di].altOutfits[ai]){
              var orig=rotation[di].outfit;
              var origFs=rotation[di].fs||rotation[di].altOutfits[ai].fs;
              rotation[di].outfit=rotation[di].altOutfits[ai];
              rotation[di].fs=rotation[di].altOutfits[ai].fs;
              var newAlts=rotation[di].altOutfits.slice();
              newAlts[ai]={top:orig.top,bot:orig.bot,shoe:orig.shoe,fs:origFs};
              rotation[di].altOutfits=newAlts;
            }
          });
          var DAYS7=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          var genC=rotation.filter(function(d){return d.watch&&d.watch.t==="genuine"}).length;
          var repC=rotation.filter(function(d){return d.watch&&d.watch.t==="replica"}).length;
          var uniqueW={};rotation.forEach(function(d){if(d.watch)uniqueW[d.watch.id]=true});
          return React.createElement("div",null,
            /* Header + stats */
            React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"14px 16px",marginBottom:10}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                React.createElement("span",{style:{fontSize:18}},"üìÖ"),
                React.createElement("span",{style:{fontSize:15,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"7-Day Rotation"),
                React.createElement("button",{onClick:function(){setEditRotCtx(!editRotCtx)},style:{marginLeft:"auto",background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},editRotCtx?"Done":"‚öôÔ∏è Edit Days"),
                React.createElement("button",{onClick:function(){
                  var nl=rotation.map(function(d){return d.watch?d.watch.id:null});
                  setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                },style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"üíæ Save"),
                rotLock.some(function(x){return x!==null})&&React.createElement("button",{onClick:function(){
                  setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);
                },style:{background:"none",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"üîì Clear")),
              React.createElement("div",{style:{display:"flex",gap:12,fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},
                React.createElement("span",null,"üî¢ "+Object.keys(uniqueW).length+" unique"),
                !IS_SHARED&&React.createElement("span",null,"‚úì "+genC+" genuine"),
                !IS_SHARED&&React.createElement("span",null,"‚óá "+repC+" replica"),
                rotLock.filter(function(x){return x}).length>0&&React.createElement("span",{style:{color:"var(--good)"}},"üîí "+rotLock.filter(function(x){return x}).length+" locked"))),

            /* Rotation weather summary */
            (function(){
              var clearD=0,rainD=0,windyD=0,snowD=0;
              rotation.forEach(function(d){if(!d.forecast)return;var c=d.forecast.cond;if(c&&c.rain)rainD++;else if(d.forecast.code>=71&&d.forecast.code<=86)snowD++;else clearD++;if(d.forecast.wind>=30)windyD++});
              var parts=[];if(clearD)parts.push("‚òÄÔ∏è "+clearD+" clear");if(rainD)parts.push("üåßÔ∏è "+rainD+" rain");if(snowD)parts.push("‚ùÑÔ∏è "+snowD+" snow");if(windyD)parts.push("üí® "+windyD+" windy");
              return parts.length?React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",background:"var(--bg)",borderRadius:8,padding:"6px 12px",marginBottom:8,border:"1px solid var(--border)",textAlign:"center"}},parts.join(" ¬∑ ")):null;
            })(),

            /* Smart rotation alerts */
            (function(){
              var alerts=[];
              /* Rep-heavy week */
              if(!IS_SHARED&&repC>=5)alerts.push({icon:"‚ö†",text:"Rep-heavy week: "+repC+"/7 days are replicas. Consider swapping 1-2 for genuine.",c:"var(--warn)"});
              /* Back-to-back same watch */
              for(var ai=0;ai<rotation.length-1;ai++){if(rotation[ai].watch&&rotation[ai+1].watch&&rotation[ai].watch.id===rotation[ai+1].watch.id)alerts.push({icon:"üîÅ",text:rotation[ai].watch.n+" repeats "+rotation[ai].dayName+"‚Üí"+rotation[ai+1].dayName+". Variety matters.",c:"var(--warn)"})}
              /* Neglected watches ‚Äî active watches not in rotation and not worn in 14+ days */
              var rotIds={};rotation.forEach(function(d){if(d.watch)rotIds[d.watch.id]=true});
              var neglected=actW.filter(function(w){return !rotIds[w.id]&&daysSince(w.id)>=14&&w.status==="active"});
              if(neglected.length>=3)alerts.push({icon:"üí§",text:neglected.length+" watches haven't been worn in 14+ days: "+neglected.slice(0,3).map(function(w){return w.i+" "+w.n}).join(", "),c:"#7ab8d8"});
              /* Strap mismatch warnings */
              rotation.forEach(function(d){if(d.watch&&d.outfit&&d.outfit.shoe&&!d.watch.br){var sc=d.outfit.shoe.color?d.outfit.shoe.color.toLowerCase():"";var wsc=(d.watch.sc||[]).join(" ").toLowerCase();if(sc.includes("brown")&&wsc.includes("black")&&!wsc.includes("brown"))alerts.push({icon:"üö´",text:d.dayName+": "+d.watch.n+" has black strap but brown shoes. Mismatch.",c:"var(--warn)"});if(sc.includes("black")&&!wsc.includes("black")&&!wsc.includes("navy")&&wsc.length>0)alerts.push({icon:"üö´",text:d.dayName+": "+d.watch.n+" has warm strap but black shoes.",c:"var(--warn)"})}});
              /* Rain + leather strap warnings */
              rotation.forEach(function(d){if(d.forecast&&d.forecast.cond&&d.forecast.cond.rain&&d.watch&&!d.watch.br){alerts.push({icon:"‚òÇÔ∏è",text:d.dayName+": Rain forecast ("+d.forecast.rainPct+"%) but "+d.watch.n+" has leather strap. Consider bracelet watch or waterproof precautions.",c:"#7ab8d8"})}});
              /* Rainy days count */
              var rainyDays=rotation.filter(function(d){return d.forecast&&d.forecast.cond&&d.forecast.cond.rain}).length;
              if(rainyDays>=3)alerts.push({icon:"üåßÔ∏è",text:"Rain-heavy week: "+rainyDays+" of 7 days have precipitation. Bracelet watches prioritized.",c:"#7ab8d8"});
              if(!alerts.length)return null;
              return React.createElement("div",{style:{marginBottom:10}},alerts.map(function(a,idx){
                var isRainAlert=a.c==="#7ab8d8";
                return React.createElement("div",{key:idx,style:{display:"flex",alignItems:"flex-start",gap:8,background:isRainAlert?"rgba(100,150,220,0.04)":"rgba(200,90,58,0.04)",border:"1px solid "+(isRainAlert?"rgba(100,150,220,0.15)":"rgba(200,90,58,0.15)"),borderRadius:8,padding:"8px 12px",marginBottom:4}},
                  React.createElement("span",{style:{fontSize:14,flexShrink:0}},a.icon),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:a.c,lineHeight:1.4}},a.text))}));
            })(),

            /* Context editor */
            editRotCtx&&React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:10}},
              React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8,letterSpacing:"0.1em"}},"SET CONTEXT PER DAY"),
              DAYS7.map(function(dn,di){
                return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:32,fontWeight:600}},dn),
                  React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap",flex:1},className:"hscroll"},
                    activeCxIds.slice(0,8).map(function(cx){
                      return React.createElement("span",{key:cx,className:"chip "+(weekCtx[di]===cx?"on":""),onClick:function(){
                        var nwc=weekCtx.slice();nwc[di]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      },style:{padding:"3px 8px",fontSize:9,minHeight:24}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})));
              })),

            /* Day cards */
            rotation.map(function(day,i){
              if(!day.watch)return null;
              var w=day.watch;var isToday=i===0;
              var of=day.outfit;var sp=day.strapPick;
              var ds=daysSince(w.id);
              var dayDate=day.date||todayStr;
              var worn=wearLog.find(function(e){return e.date===dayDate&&e.watchId===w.id});
              var isEditing=editDayIdx===i;
              return React.createElement("div",{key:i,className:"card-lift",style:{background:isToday?"var(--card2)":"var(--card)",border:"1px solid "+(isToday?"rgba(201,168,76,0.3)":day.locked?"rgba(122,184,122,0.2)":"var(--border)"),borderRadius:12,padding:"12px 14px",marginBottom:8}},
                React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center"}},
                  /* Day + weather */
                  React.createElement("div",{style:{minWidth:48,textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:isToday?"var(--gold)":"var(--sub)",fontWeight:700}},(function(){var sc=[pieceSwap[i+"-top"],pieceSwap[i+"-bot"],pieceSwap[i+"-shoe"]].filter(Boolean).length;return(isToday?"TODAY":day.dayName.toUpperCase())+(sc?" ‚úé"+sc:"")})()),
                    day.forecast&&React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},day.forecast.cond?day.forecast.cond.i:day.tier?day.tier.icon:""),
                    day.forecast&&React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},day.forecast.high+"¬∞/"+day.forecast.low+"¬∞"),
                    day.forecast&&day.forecast.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:day.forecast.rainPct>=50?"#7ab8d8":"var(--dim)"}},day.forecast.rainPct>=50?"üíß"+day.forecast.rainPct+"%":day.forecast.rainPct+"%")),
                  /* Watch ‚Äî tap to swap */
                  React.createElement("div",{onClick:function(){setEditDayIdx(isEditing?null:i);setEditDayMode(isEditing?null:"watch")},style:{width:40,height:40,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:18,flexShrink:0,border:"2px solid "+(isEditing?"var(--gold)":w.c+"40"),cursor:"pointer"}},w.i),
                  React.createElement("div",{style:{flex:1,minWidth:0}},
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:5,flexWrap:"wrap",marginBottom:2}},
                      React.createElement("span",{style:{fontSize:13,fontWeight:600}},w.n),
                      !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 4px"}},"REP"),
                      /* Context badge ‚Äî tap to cycle */
                      React.createElement("span",{onClick:function(e){e.stopPropagation();setEditDayIdx(isEditing&&editDayMode==="ctx"?null:i);setEditDayMode("ctx")},style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",background:"var(--bg)",borderRadius:4,padding:"1px 6px",cursor:"pointer",border:"1px solid "+(isEditing&&editDayMode==="ctx"?"var(--gold)":"transparent")}},(CXI[day.context]||"")+" "+day.context),
                      day.locked&&React.createElement("span",{style:{fontSize:7,color:"var(--good)"}},"üîí"),
                      ds<999&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:ds<=2?"var(--warn)":ds>=7?"var(--good)":"var(--sub)",background:"var(--bg)",borderRadius:4,padding:"1px 5px"}},ds===0?"today":ds+"d ago"),
                      of&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:of.fs>=8?"var(--good)":of.fs>=5?"var(--gold)":"var(--warn)",background:of.fs>=8?"rgba(122,184,122,0.1)":of.fs>=5?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",borderRadius:4,padding:"1px 5px",border:"1px solid "+(of.fs>=8?"rgba(122,184,122,0.2)":of.fs>=5?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},of.fs>=8?"üî•":"üëî"," "+(pieceSwap[i+"-top"]||pieceSwap[i+"-bot"]||pieceSwap[i+"-shoe"]?"~":"")+of.fs)),
                    /* Strap + bracelet line with visual color swatch */
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},
                      (function(){
                        var isRain=day.forecast&&day.forecast.cond&&day.forecast.cond.rain;
                        if(sp&&sp.strap){
                          var isWR=sp.strap.type==="bracelet"||sp.strap.type==="rubber"||sp.strap.type==="mesh";
                          var rainSuffix=isRain&&!isWR?" ‚Äî rain risk":isRain&&isWR?" ‚úì":"";
                          var rainPrefix=isRain&&!isWR?"‚ö†Ô∏è ":"";
                          return React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:4,color:isRain?(isWR?"var(--good)":"var(--warn)"):sp.type==="good"?"var(--good)":"var(--sub)"}},
                            rainPrefix?React.createElement("span",null,rainPrefix):null,
                            React.createElement(StrapSwatch,{strap:sp.strap,size:8}),
                            sp.strap.notes?React.createElement("span",{style:{fontSize:7,color:"var(--dim)",fontStyle:"italic",maxWidth:100,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}," ¬∑ "+sp.strap.notes):"",
                            rainSuffix?React.createElement("span",null,rainSuffix):null);
                        }
                        if(w.br)return React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:4,color:isRain?"var(--good)":"var(--sub)"}},React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:"linear-gradient(135deg,#c0c0c0,#888,#c0c0c0)",flexShrink:0}}),"‚õìÔ∏è Bracelet"+(isRain?" ‚úì":""));
                        return React.createElement("span",null,"üîó "+(w.sc||[]).join(" / "));
                      })())),
                  /* Lock/unlock button */
                  React.createElement("button",{onClick:function(){var nl=rotLock.slice();nl[i]=nl[i]?null:w.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl)},style:{background:"none",border:"1px solid "+(day.locked?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:6,padding:"4px 8px",cursor:"pointer",color:day.locked?"var(--good)":"var(--dim)",fontSize:12,flexShrink:0,minWidth:32,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center"}},day.locked?"üîí":"üîì")),

                /* Inline context picker */
                isEditing&&editDayMode==="ctx"&&React.createElement("div",{className:"fu",style:{display:"flex",gap:3,flexWrap:"wrap",marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                  activeCxIds.slice(0,8).map(function(cx){
                    return React.createElement("span",{key:cx,className:"chip "+(weekCtx[day.dayIdx]===cx?"on":""),onClick:function(){
                      var nwc=weekCtx.slice();nwc[day.dayIdx]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      /* Also unlock this day so rotation recalculates */
                      var nl=rotLock.slice();nl[i]=null;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                      setEditDayIdx(null);setEditDayMode(null);
                    },style:{padding:"4px 10px",fontSize:9,minHeight:28}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})),

                /* Inline watch picker */
                isEditing&&editDayMode==="watch"&&React.createElement("div",{className:"fu",style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                  React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"SWAP WATCH FOR "+day.dayName.toUpperCase()),
                  React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(100px,1fr))",gap:6,maxHeight:200,overflowY:"auto"}},
                    actW.filter(function(aw){return reps||aw.t!=="replica"}).map(function(aw){
                      var isActive=aw.id===w.id;
                      return React.createElement("div",{key:aw.id,onClick:function(){
                        var nl=rotLock.slice();nl[i]=aw.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                        setEditDayIdx(null);setEditDayMode(null);
                      },style:{display:"flex",alignItems:"center",gap:6,background:isActive?"rgba(201,168,76,0.1)":"var(--bg)",border:"1px solid "+(isActive?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:8,padding:"6px 8px",cursor:"pointer"}},
                        React.createElement("span",{style:{fontSize:16}},aw.i),
                        React.createElement("div",{style:{flex:1,minWidth:0}},
                          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},aw.n),
                          React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},aw.d+(!IS_SHARED&&aw.t==="replica"?" ¬∑ rep":""))))}))),

                /* Confirm wear / undo for today */
                isToday&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)",alignItems:"center"}},
                  !worn?React.createElement("button",{onClick:function(){logWear(w.id,todayStr)},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:8,padding:"8px 14px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,flex:1,minHeight:36}},"‚úì Wearing this today")
                  :React.createElement(React.Fragment,null,
                    React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--good)",flex:1}},"‚úì Logged for today"),
                    React.createElement("button",{onClick:function(){undoWear(todayStr)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"Undo"))),
                /* Outfit pairing row ‚Äî tappable for alternatives */
                of&&React.createElement("div",{style:{marginTop:isToday?6:8,paddingTop:isToday?0:8,borderTop:isToday?"none":"1px solid var(--border)"}},
                  React.createElement("div",{onClick:function(){setExpandDay(expandDay===i?null:i);setPiecePicker(null);setPieceFilter(null)},style:{display:"flex",gap:6,cursor:"pointer"}},
                    [{l:"TOP",slot:"top",item:of.top},{l:"BTM",slot:"bot",item:of.bot},{l:"SHOE",slot:"shoe",item:of.shoe}].map(function(o){
                      var ep=getEP(i,o.slot,o.item);if(!ep)return null;
                      var swapped=pieceSwap[i+"-"+o.slot];
                      return React.createElement("div",{key:o.l,style:{flex:1,background:swapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid "+(swapped?"rgba(201,168,76,0.25)":"var(--border)"),minWidth:0}},
                        ep.photoUrl?React.createElement("img",{src:ph(ep.photoUrl),alt:"",style:{width:"100%",height:56,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:56,background:(CM[ep.color]||{}).h||"#3a3a3a"}}),
                        React.createElement("div",{style:{padding:"4px 6px",display:"flex",alignItems:"center",gap:3}},
                          React.createElement(Dot,{color:ep.color,size:5}),
                          React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:swapped?"var(--gold)":"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},swapped?"‚úé ":"",ep.name||ep.color)))}),
                    React.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4,flexShrink:0,minWidth:28}},
                      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},expandDay===i?"‚ñ≤":"‚ñº"),
                      /* Per-day AI critique button */
                      React.createElement("button",{onClick:function(e){e.stopPropagation();
                        if(dayAi[i]){setDayAi(function(p){var n=Object.assign({},p);delete n[i];return n});return}
                        setDayAiLoading(i);
                        aiVision({top:getEP(i,"top",of.top),bot:getEP(i,"bot",of.bot),shoe:getEP(i,"shoe",of.shoe)},w,day.context,apiKeyRef.current).then(function(result){
                          setDayAi(function(p){var n=Object.assign({},p);n[i]=result||{vision:"AI unavailable",impact:0};return n});
                          setDayAiLoading(null);
                        });
                      },style:{background:"none",border:"1px solid "+(dayAi[i]?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:6,padding:"3px 8px",cursor:"pointer",color:dayAiLoading===i?"var(--gold)":dayAi[i]?"var(--gold)":"var(--dim)",fontSize:10,minHeight:24}},dayAiLoading===i?"‚è≥":dayAi[i]?"‚ú® "+dayAi[i].impact:"‚ú®"))),

                  /* Expanded: AI critique result */
                  dayAi[i]&&React.createElement("div",{className:"fu",style:{marginTop:6,background:"rgba(201,168,76,0.04)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(201,168,76,0.15)"}},
                    dayAi[i].vision&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.5,color:"var(--text)",marginBottom:4}},dayAi[i].vision),
                    React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",fontSize:8,fontFamily:"var(--f)"}},
                      dayAi[i].impact>0&&React.createElement("span",{style:{color:dayAi[i].impact>=7?"var(--good)":dayAi[i].impact>=4?"var(--gold)":"var(--warn)",fontWeight:700}},"Impact: "+dayAi[i].impact+"/10"),
                      dayAi[i].color_story&&React.createElement("span",{style:{color:"#9a8abc"}},"üé® "+dayAi[i].color_story),
                      dayAi[i].works&&React.createElement("span",{style:{color:"var(--good)"}},"‚úì "+dayAi[i].works),
                      dayAi[i].risk&&React.createElement("span",{style:{color:"var(--warn)"}},"‚ö† "+dayAi[i].risk))),

                  /* Expanded: outfit mannequin */
                  expandDay===i&&(pieceSwap[i+"-top"]||pieceSwap[i+"-bot"]||pieceSwap[i+"-shoe"])&&React.createElement("div",{style:{display:"flex",justifyContent:"flex-end",gap:6,marginTop:6,padding:"0 4px"},onClick:function(ev){ev.stopPropagation()}},
                    React.createElement("button",{onClick:function(){var ps2=Object.assign({},pieceSwap);delete ps2[i+"-top"];delete ps2[i+"-bot"];delete ps2[i+"-shoe"];setPieceSwap(ps2)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",color:"var(--del-text)",cursor:"pointer"}},"‚Ü© Reset swaps"),
                    React.createElement("button",{onClick:function(){var newFit={watches:[w],top:getEP(i,"top",of.top),bot:getEP(i,"bot",of.bot),shoe:getEP(i,"shoe",of.shoe),context:day.context,name:day.dayName+" custom"};saveFit(newFit)},style:{background:"none",border:"1px solid var(--gold)",borderRadius:6,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",cursor:"pointer"}},"üíæ Save custom")),
                  expandDay===i&&React.createElement("div",{className:"fu",style:{marginTop:8,display:"flex",gap:12,alignItems:"flex-start",justifyContent:"center"}},
                    React.createElement(OutfitFigure,{topColor:getEP(i,"top",of.top)?getEP(i,"top",of.top).color:"grey",botColor:getEP(i,"bot",of.bot)?getEP(i,"bot",of.bot).color:"charcoal",shoeColor:getEP(i,"shoe",of.shoe)?getEP(i,"shoe",of.shoe).color:"black",watchColor:w.c,watchIcon:w.i,watchName:w.n,size:100}),
                    sp&&sp.strap&&React.createElement("div",{style:{textAlign:"center",padding:"6px 0 2px",fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},
                      (function(){var stT=STRAP_TYPES.find(function(t){return t.id===sp.strap.type})||{icon:"üîó"};return stT.icon+" "+(sp.strap.type==="bracelet"?"Bracelet":sp.strap.color+" "+sp.strap.type)+(sp.strap.brand?" ¬∑ "+sp.strap.brand:"")})()),
                    React.createElement("div",{style:{flex:1,minWidth:0}},
                      [{l:"TOP",slot:"top",item:getEP(i,"top",of.top)},{l:"BOTTOM",slot:"bot",item:getEP(i,"bot",of.bot)},{l:"SHOES",slot:"shoe",item:getEP(i,"shoe",of.shoe)}].map(function(o){
                        if(!o.item)return null;
                        var pk=i+"-"+o.slot;var isOpen=piecePicker===pk;var isSwapped=!!pieceSwap[pk];
                        return React.createElement("div",{key:o.l},
                          React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:isOpen?4:8,background:isSwapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:8,padding:"6px 8px",border:isSwapped?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",cursor:"pointer"},onClick:function(ev){ev.stopPropagation();setPiecePicker(isOpen?null:pk);setPieceFilter(null)}},
                            o.item.photoUrl?React.createElement("img",{src:ph(o.item.photoUrl),alt:"",style:{width:44,height:44,objectFit:"cover",borderRadius:6,flexShrink:0}}):React.createElement("div",{style:{width:44,height:44,borderRadius:6,background:(CM[o.item.color]||{}).h||"#3a3a3a",flexShrink:0}}),
                            React.createElement("div",{style:{flex:1,minWidth:0}},
                              React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em"}},o.l+(isSwapped?" ‚úé":"")),
                              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                                React.createElement(Dot,{color:o.item.color,size:6}),
                                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:isSwapped?"var(--gold)":"var(--text)",fontWeight:500}},o.item.name||o.item.color)),
                              React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" ¬∑ "+o.item.pattern:""))),
                            React.createElement("span",{style:{fontSize:10,color:"var(--dim)"}},isOpen?"‚ñ≤":"üîÑ")),
                          /* ‚ïê Piece picker ‚ïê */
                          isOpen&&React.createElement(React.Fragment,null,
                          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"4px 0 2px",marginBottom:2},onClick:function(ev){ev.stopPropagation()}},
                        [null].concat(slotAlts(o.slot).reduce(function(acc,it){if(acc.indexOf(it.color)===-1)acc.push(it.color);return acc},[])).map(function(fc){
                          var label=fc?fc.charAt(0).toUpperCase()+fc.slice(1):"All";var cnt=slotAlts(o.slot).filter(function(a){return !a.id||(fc===null||a.color===fc)}).length;
                          var isActive=pieceFilter===fc;
                          return React.createElement("button",{key:label,onClick:function(){setPieceFilter(isActive?null:fc)},style:{display:"flex",alignItems:"center",gap:3,background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400}},fc&&React.createElement(Dot,{color:fc,size:6}),label,fc?" ("+slotAlts(o.slot).filter(function(x){return x.color===fc}).length+")":"")})),
                        slotPatterns(o.slot).length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"2px 0 4px"},onClick:function(ev){ev.stopPropagation()}},
                          slotPatterns(o.slot).map(function(pt){
                            var isActive=pieceFilter==="p:"+pt;
                            return React.createElement("button",{key:pt,onClick:function(){setPieceFilter(isActive?null:"p:"+pt)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400,fontStyle:"italic"}},pt," (",slotAlts(o.slot).filter(function(x){return x.pattern===pt}).length,")")})),
                          React.createElement("div",{style:{display:"flex",gap:6,overflowX:"auto",padding:"6px 0 8px",marginBottom:8,WebkitOverflowScrolling:"touch"},onClick:function(ev){ev.stopPropagation()}},
                            isSwapped&&React.createElement("div",{onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);delete n[pk];return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 8px",borderRadius:8,border:"1px solid var(--del-border)",cursor:"pointer",minWidth:52}},
                              React.createElement("span",{style:{fontSize:14}},"‚Ü©Ô∏è"),
                              React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--del-text)"}},"Reset")),
                            (function(){var _fa=filteredAlts(o.slot,o.item&&o.item.id);return _fa.length===0?[React.createElement("div",{key:"_empty",style:{flexShrink:0,padding:"8px 12px",color:"var(--dim)",fontSize:8,fontFamily:"var(--f)",fontStyle:"italic",whiteSpace:"nowrap"}},"No matches")]:_fa})().map(function(alt){
                              return React.createElement("div",{key:alt.id,onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);n[pk]=alt;return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 6px",borderRadius:8,border:"1px solid var(--border)",cursor:"pointer",minWidth:52,maxWidth:64}},
                                alt.photoUrl?React.createElement("img",{src:ph(alt.photoUrl),alt:"",style:{width:40,height:40,objectFit:"cover",borderRadius:6}}):React.createElement("div",{style:{width:40,height:40,borderRadius:6,background:(CM[alt.color]||{}).h||"#3a3a3a"}}),
                                React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:56}},alt.name||alt.color))}))))}),
                      React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"6px 8px"}},
                        React.createElement("span",{style:{fontSize:16}},w.i),
                        React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},w.n),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},w.d+" ¬∑ "+(w.straps&&w.straps.length?w.straps.map(function(s){return s.type}).join("+"):w.br?"Bracelet":(w.sc||[]).join("/")))))),

                  /* Expanded: alternative outfits */
                  expandDay===i&&day.altOutfits&&day.altOutfits.length>0&&React.createElement("div",{className:"fu",style:{marginTop:6}},
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:4,letterSpacing:"0.08em"}},"ALTERNATIVES"),
                    day.altOutfits.map(function(alt,ai2){
                      return React.createElement("div",{key:ai2,onClick:function(){var sw=Object.assign({},altSwap);if(sw[i]===ai2){delete sw[i]}else{sw[i]=ai2}setAltSwap(sw);var ps2=Object.assign({},pieceSwap);delete ps2[i+"-top"];delete ps2[i+"-bot"];delete ps2[i+"-shoe"];setPieceSwap(ps2)},style:{display:"flex",gap:6,marginBottom:4,padding:"4px 0",borderBottom:ai2<day.altOutfits.length-1?"1px solid var(--border)":"none",cursor:"pointer",opacity:altSwap[i]===ai2?1:0.7,background:altSwap[i]===ai2?"rgba(184,150,42,0.08)":"none",borderRadius:4}},
                        [{item:alt.top},{item:alt.bot},{item:alt.shoe}].map(function(o,oi){
                          if(!o.item)return null;
                          return React.createElement("div",{key:oi,style:{display:"flex",alignItems:"center",gap:3,flex:"1 1 0",minWidth:0}},
                            o.item.photoUrl&&React.createElement("img",{src:ph(o.item.photoUrl),alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}),
                            React.createElement(Dot,{color:o.item.color,size:4}),
                            React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))}),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",flexShrink:0}},alt.fs))})),
                  expandDay===i&&(!day.altOutfits||!day.altOutfits.length)&&React.createElement("div",{style:{marginTop:6,fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:6}},"No alternative combos for this context")));
            }),
            React.createElement("button",{onClick:function(){setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);setMode("auto");setTimeout(function(){setMode("rotation")},50)},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,minHeight:40}},"üîÑ Shuffle Rotation"));
        })(),

        /* AUTO */
        mode==="auto"&&React.createElement(React.Fragment,null,
          tier&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 8px"}},"üå°Ô∏è ",React.createElement("strong",{style:{color:"var(--gold)"}},tier.label+(planDay>0?" ("+forecast[planDay].date+")":"")),
            " ¬∑ "+ww+" ¬∑ "+actW.length+" watches ¬∑ "+fits.length+" fits",
            planWx&&planWx.cond?React.createElement("span",{style:{color:planWx.rain?"#7ab8d8":"var(--sub)",marginLeft:6}},planWx.cond.i+" "+planWx.cond.l):null),
          /* Weather-specific advice banner */
          planWx&&(planWx.rain||planWx.uv>=8||(planWx.wind&&planWx.wind>=35))&&React.createElement("div",{style:{background:planWx.rain?"rgba(100,150,220,0.06)":"rgba(200,90,58,0.06)",border:"1px solid "+(planWx.rain?"rgba(100,150,220,0.2)":"rgba(200,90,58,0.2)"),borderRadius:10,padding:"8px 12px",marginBottom:10,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},
            React.createElement("span",{style:{fontSize:14}},planWx.rain?"‚òÇÔ∏è":planWx.uv>=8?"üï∂Ô∏è":"üí®"),
            React.createElement("div",{style:{flex:1,minWidth:120}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:planWx.rain?"#7ab8d8":"var(--warn)"}},planWx.rain?"Rain Day ‚Äî Bracelet Watches Boosted":planWx.uv>=8?"High UV ‚Äî Light Fabrics":"High Wind ‚Äî Secure Layers"),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},planWx.rain?"Leather straps penalized. White/cream shoes downranked."+(planWx.rainPct?" "+planWx.rainPct+"% chance.":""):planWx.uv>=8?"UV "+planWx.uv+" ‚Äî light colors preferred":"Wind "+planWx.wind+"km/h"))),
          !fits.length?React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"üëï"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},wd.length<2?"Add wardrobe items":needsFix>0?"Classify items first":"No valid combos"))
          :fits.map(function(fit,idx){
            return React.createElement("div",{key:fit.id,className:"card-lift",onClick:function(){navTo("fits",fit);setFitWatch(null)},style:{background:idx===0?"var(--card2)":"var(--card)",border:idx===0?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10,cursor:"pointer",position:"relative"}},
              idx===0&&React.createElement("div",{style:{position:"absolute",top:8,right:12,fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700}},"TOP"),
              React.createElement("div",{className:"dots-row",style:{marginBottom:8}},
                [fit.top,fit.bot,fit.shoe].filter(Boolean).map(function(item,i){return React.createElement(Dot,{key:i,color:item.color,size:8})}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:fit.fs>=8?"var(--good)":fit.fs>=5?"var(--gold)":"var(--warn)",marginLeft:4,fontWeight:600}},(fit.fs>=8?"üî• ":fit.fs>=5?"":"‚ö† ")+fit.fs),
                fit.layers&&fit.layers.length>1&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--gold)",marginLeft:2,fontWeight:600}},fit.layers.length+"L"),fit.topType&&fit.topType!=="Shirt"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:2}},fit.topType==="Sweater/Knit"?"üß∂":fit.topType==="Jacket/Blazer"?"üß•":fit.topType==="Polo"?"üèá":fit.topType==="T-Shirt"?"üëï":"")),
              React.createElement("div",{style:{display:"flex",gap:6,marginBottom:10}},
                [{l:"TOP",item:fit.top},{l:"BTM",item:fit.bot},{l:"SHOE",item:fit.shoe}].map(function(o){
                  if(!o.item)return null;
                  return React.createElement("div",{key:o.l,style:{flex:1,background:"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid var(--border)",minWidth:0}},
                    o.item.photoUrl?React.createElement("img",{src:ph(o.item.photoUrl),alt:"",style:{width:"100%",height:52,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:36,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{padding:"4px 6px"}},React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},React.createElement(Dot,{color:o.item.color,size:5}),React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))))})),
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                fit.watches.map(function(w,i){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"var(--sub)",fontWeight:i===0?600:400}},w.n))})),
              fit.wxWarns&&fit.wxWarns.length>0&&React.createElement("div",{style:{marginTop:6,display:"flex",gap:4,flexWrap:"wrap"}},
                fit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
              /* Recently worn warning */
              (function(){var rw=fit.items.filter(function(it){if(!it.lastWorn)return false;return Math.floor((Date.now()-new Date(it.lastWorn).getTime())/864e5)<=2});return rw.length?React.createElement("div",{style:{marginTop:4,fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},
                "üîÑ "+(rw.length===1?(rw[0].name||rw[0].color)+" worn recently":rw.length+" items worn recently")):null})())}))),

      /* ‚ïê‚ïê‚ïê FIT DETAIL ‚ïê‚ïê‚ïê */
      view==="fits"&&selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        React.createElement("button",{onClick:function(){navBack()},style:{background:"none",border:"none",color:"var(--gold)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",padding:0,marginBottom:12,minHeight:44}},"‚Üê Back"),
        /* Outfit mannequin preview */
        React.createElement("div",{style:{display:"flex",justifyContent:"center",marginBottom:16,background:"linear-gradient(145deg,var(--card),var(--card2))",borderRadius:14,padding:"16px",border:"1px solid rgba(201,168,76,0.15)"}},
          (function(){var dw=fitWatch||(selFit.watches&&selFit.watches[0])||null;return React.createElement(OutfitFigure,{topColor:selFit.top?selFit.top.color:"grey",botColor:selFit.bot?selFit.bot.color:"charcoal",shoeColor:selFit.shoe?selFit.shoe.color:"black",watchColor:dw?dw.c:"#c9a84c",watchIcon:dw?dw.i:"‚åö",watchName:dw?dw.n:"",size:130})})()),
        (function(){var _ls=selFit.layers&&selFit.layers.length>1?selFit.layers:[selFit.top].filter(Boolean);var _sl=_ls.map(function(item,idx){var _lb=_ls.length===1?"TOP":layerOf(item.garmentType)==="outer"?"OUTER":layerOf(item.garmentType)==="mid"?"MID":"BASE";return{slot:"top",l:_lb,item:item}});_sl.push({slot:"bot",l:"BOTTOM",item:selFit.bot});_sl.push({slot:"shoes",l:"SHOES",item:selFit.shoe});return _sl}()).map(function(o){
          if(!o.item)return null;
          var swaps=getSwaps(wd,selFit,o.slot);
          return React.createElement("div",{key:o.slot,style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px 14px",marginBottom:8}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10}},
              o.item.photoUrl&&React.createElement("img",{src:ph(o.item.photoUrl),alt:"",onClick:function(e){e.stopPropagation();openLightbox(o.item.photoUrl,o.item.id)},style:{width:64,height:64,objectFit:"cover",borderRadius:10,cursor:"zoom-in"}}),
              React.createElement("div",{onClick:function(){setEditG(o.item)},style:{flex:1,cursor:"pointer"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.l),React.createElement("div",{style:{display:"flex",alignItems:"center",gap:4}},React.createElement(Dot,{color:o.item.color}),React.createElement("span",{style:{fontSize:14,fontWeight:500}},o.item.name||(o.item.color+" "+o.item.garmentType))),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" ¬∑ "+o.item.pattern:""))),
              React.createElement("button",{onClick:function(e){e.stopPropagation();setEditG(o.item)},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,flexShrink:0,minHeight:32}},"‚úèÔ∏è Edit"),
              React.createElement("button",{onClick:function(e){e.stopPropagation();setLockItem(o.item);navBack();setMode("auto")},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,flexShrink:0,minHeight:32}},"üîí Lock")),
            swaps.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
              React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em",textTransform:"uppercase"}},"SWAP WITH"),
              React.createElement("div",{style:{display:"flex",gap:6,marginTop:4},className:"hscroll"},
                swaps.map(function(s){return React.createElement("div",{key:s.id,onClick:function(){
                  var newItems=(selFit.items||[]).map(function(it){return it.id===(o.slot==="top"?selFit.top:o.slot==="bot"?selFit.bot:selFit.shoe).id?s:it});
                  var newFit=makeOutfit(newItems,actW,effectiveCtx,reps,planWx,planTemp?planTemp.feels:18);
                  setSelFit(newFit);
                },style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:8,padding:"6px 10px",border:"1px solid var(--border)",flexShrink:0,cursor:"pointer",transition:"all .15s"},className:"card-lift"},
                  s.photoUrl&&React.createElement("img",{src:ph(s.photoUrl),alt:"",style:{width:24,height:24,objectFit:"cover",borderRadius:4}}),
                  React.createElement(Dot,{color:s.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},s.name||s.color),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)"}},s.ss))}))))}),
        React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"16px 0 10px"}},
          React.createElement("h2",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,letterSpacing:"0.14em",color:"var(--gold)",textTransform:"uppercase",margin:0}},"Watch Pairings"),
          React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},fitWatch?"Tap again to deselect":"Tap to choose")),
        fitWatch&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:8}},
          React.createElement("span",{style:{fontSize:18}},fitWatch.i),
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"üîí "+fitWatch.n),
          React.createElement("button",{onClick:function(){setFitWatch(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"‚úï Clear")),
        React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:16}},(selFit.allW||selFit.watches).slice(0,6).map(function(w,i){
          return React.createElement("div",{key:w.id,onClick:function(){setFitWatch(fitWatch&&fitWatch.id===w.id?null:w)},style:{cursor:"pointer",border:fitWatch&&fitWatch.id===w.id?"2px solid var(--gold)":"2px solid transparent",borderRadius:14,transition:"all .15s"}},
            React.createElement(WCard,{w:w,rank:fitWatch?fitWatch.id===w.id?0:null:i,detail:true}))})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){
          /* If user selected a watch, reorder watches so selected is first */
          if(fitWatch){var reordered=[fitWatch].concat((selFit.allW||selFit.watches).filter(function(w){return w.id!==fitWatch.id}));var updFit=Object.assign({},selFit,{watches:reordered.slice(0,3)});saveFit(updFit)}else{saveFit(selFit)}
        }},"üíæ Save Outfit")),

      /* ‚ïê‚ïê‚ïê INSIGHTS ‚ïê‚ïê‚ïê */
      view==="insights"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},

        /* 7-day weather strip */
        forecast.length>0&&React.createElement("div",{style:{marginBottom:14}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              return React.createElement("div",{key:i,style:{flex:"0 0 auto",background:fc.cond&&fc.cond.rain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(fc.cond&&fc.cond.rain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"6px 10px",minWidth:62,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",fontWeight:500}},i===0?"Today":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:""),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",fontWeight:600}},fc.high+"¬∞/"+fc.low+"¬∞"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)"}},"üíß"+fc.rainPct+"%"))}))),

        /* ‚îÄ‚îÄ ONE-TAP DAILY PICK ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"‚ö°"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"Today's Pick")),
          !dailyPick?React.createElement("button",{className:"btn btn-gold",onClick:function(){
            var cx0=weekCtx[new Date().getDay()]||"smart-casual";
            var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock,loc.lat);
            /* Apply alt swaps for today */
            if(altSwap[0]!=null&&rotation[0]&&rotation[0].altOutfits&&rotation[0].altOutfits[altSwap[0]]){
              var orig0=rotation[0].outfit;var origFs0=rotation[0].fs||rotation[0].altOutfits[altSwap[0]].fs;
              rotation[0].outfit=rotation[0].altOutfits[altSwap[0]];rotation[0].fs=rotation[0].altOutfits[altSwap[0]].fs;
              var na0=rotation[0].altOutfits.slice();na0[altSwap[0]]={top:orig0.top,bot:orig0.bot,shoe:orig0.shoe,fs:origFs0};rotation[0].altOutfits=na0;
            }
            var today=rotation[0];
            if(today&&today.watch){
              var sp=today.strapPick;
              setDailyPick({watch:today.watch,outfit:today.outfit,strap:sp,context:cx0,tier:tier});setPieceSwap(function(p){var n=Object.assign({},p);delete n["t-top"];delete n["t-bot"];delete n["t-shoe"];return n});setPiecePicker(null);
            }
          }},"‚ö° What Should I Wear?")
          :React.createElement("div",{className:"fu"},
            /* Watch */
            React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:12}},
              React.createElement("div",{style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:dailyPick.watch.c+"25",fontSize:26,border:"3px solid "+dailyPick.watch.c+"50"}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:18,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",display:"flex",alignItems:"center",gap:4}},
                  React.createElement("span",null,dailyPick.watch.d+" ¬∑ "),
                  dailyPick.strap&&dailyPick.strap.strap?React.createElement(StrapSwatch,{strap:dailyPick.strap.strap,size:8}):dailyPick.watch.br?React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:3}},React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:"linear-gradient(135deg,#c0c0c0,#888)",flexShrink:0}}),"‚õìÔ∏è Bracelet"):React.createElement("span",null,dailyPick.strap?dailyPick.strap.text:"Strap"),
                  React.createElement("span",null," ¬∑ "+(CXI[dailyPick.context]||"")+dailyPick.context)),
                !IS_SHARED&&dailyPick.watch.t==="replica"&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px",marginTop:2,display:"inline-block"}},"REP"))),
            /* Outfit with mannequin */
            dailyPick.outfit&&React.createElement("div",{style:{display:"flex",gap:12,marginBottom:12,alignItems:"flex-start"}},
              React.createElement(OutfitFigure,{topColor:getEP("t","top",dailyPick.outfit.top)?getEP("t","top",dailyPick.outfit.top).color:"grey",botColor:getEP("t","bot",dailyPick.outfit.bot)?getEP("t","bot",dailyPick.outfit.bot).color:"charcoal",shoeColor:getEP("t","shoe",dailyPick.outfit.shoe)?getEP("t","shoe",dailyPick.outfit.shoe).color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:dailyPick.watch.n,size:110}),
              React.createElement("div",{style:{flex:1,display:"flex",flexDirection:"column",gap:6}},
                [{l:"TOP",slot:"top",item:getEP("t","top",dailyPick.outfit.top)},{l:"BTM",slot:"bot",item:getEP("t","bot",dailyPick.outfit.bot)},{l:"SHOE",slot:"shoe",item:getEP("t","shoe",dailyPick.outfit.shoe)}].map(function(o){
                  if(!o.item)return null;
                  var pk="t-"+o.slot;var isOpen=piecePicker===pk;var isSwapped=!!pieceSwap[pk];
                  return React.createElement("div",{key:o.l},
                    React.createElement("div",{style:{background:isSwapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:10,overflow:"hidden",border:isSwapped?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",cursor:"pointer"},onClick:function(ev){ev.stopPropagation();setPiecePicker(isOpen?null:pk);setPieceFilter(null)}},
                      o.item.photoUrl?React.createElement("img",{src:ph(o.item.photoUrl),alt:"",style:{width:"100%",height:64,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:40,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                      React.createElement("div",{style:{padding:"5px 8px",display:"flex",alignItems:"center",gap:4}},
                        React.createElement(Dot,{color:o.item.color,size:6}),
                        React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:isSwapped?"var(--gold)":"var(--text)",fontWeight:500}},o.item.name||o.item.color),
                        React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:"auto"}},o.l+(isSwapped?" ‚úé":"")),
                        React.createElement("span",{style:{fontSize:10,color:"var(--dim)",marginLeft:4}},isOpen?"‚ñ≤":"üîÑ"))),
                    isOpen&&React.createElement(React.Fragment,null,
                    React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"4px 0 6px",marginBottom:2},onClick:function(ev){ev.stopPropagation()}},
                      [null].concat(slotAlts(o.slot).reduce(function(acc,it){if(acc.indexOf(it.color)===-1)acc.push(it.color);return acc},[])).map(function(fc){
                        var label=fc?fc.charAt(0).toUpperCase()+fc.slice(1):"All";var cnt=slotAlts(o.slot).filter(function(a){return !a.id||(fc===null||a.color===fc)}).length;
                        var isActive=pieceFilter===fc;
                        return React.createElement("button",{key:label,onClick:function(){setPieceFilter(isActive?null:fc)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400}},fc?React.createElement(React.Fragment,null,React.createElement(Dot,{color:fc,size:5})," ",label," (",slotAlts(o.slot).filter(function(x){return x.color===fc}).length,")"):label)})),
                    slotPatterns(o.slot).length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"2px 0 4px"},onClick:function(ev){ev.stopPropagation()}},
                      slotPatterns(o.slot).map(function(pt){
                        var isActive=pieceFilter==="p:"+pt;
                        return React.createElement("button",{key:pt,onClick:function(){setPieceFilter(isActive?null:"p:"+pt)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400,fontStyle:"italic"}},pt," (",slotAlts(o.slot).filter(function(x){return x.pattern===pt}).length,")")})),
                    React.createElement("div",{style:{display:"flex",gap:6,overflowX:"auto",padding:"6px 0",WebkitOverflowScrolling:"touch"},onClick:function(ev){ev.stopPropagation()}},
                      isSwapped&&React.createElement("div",{onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);delete n[pk];return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 8px",borderRadius:8,border:"1px solid var(--del-border)",cursor:"pointer",minWidth:52}},
                        React.createElement("span",{style:{fontSize:14}},"‚Ü©Ô∏è"),
                        React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--del-text)"}},"Reset")),
                      (function(){var _fa=filteredAlts(o.slot,o.item&&o.item.id);return _fa.length===0?[React.createElement("div",{key:"_empty",style:{flexShrink:0,padding:"8px 12px",color:"var(--dim)",fontSize:8,fontFamily:"var(--f)",fontStyle:"italic",whiteSpace:"nowrap"}},"No matches")]:_fa})().map(function(alt){
                        return React.createElement("div",{key:alt.id,onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);n[pk]=alt;return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 6px",borderRadius:8,border:"1px solid var(--border)",cursor:"pointer",minWidth:52,maxWidth:64}},
                          alt.photoUrl?React.createElement("img",{src:ph(alt.photoUrl),alt:"",style:{width:40,height:40,objectFit:"cover",borderRadius:6}}):React.createElement("div",{style:{width:40,height:40,borderRadius:6,background:(CM[alt.color]||{}).h||"#3a3a3a"}}),
                          React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:56}},alt.name||alt.color))}))))}))),
            /* Actions */
            React.createElement("div",{style:{display:"flex",gap:8}},
              !todayWorn&&React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){logWear(dailyPick.watch.id,todayStr)}},"‚úì Wearing This"),
              todayWorn&&React.createElement("span",{style:{flex:1,textAlign:"center",fontSize:12,fontFamily:"var(--f)",color:"var(--good)",padding:14}},"‚úì Logged"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setDailyPick(null);setAiCritique(null);setPieceSwap(function(p){var n=Object.assign({},p);delete n["t-top"];delete n["t-bot"];delete n["t-shoe"];return n});setPiecePicker(null)}},"‚Üª")))),

        /* ‚îÄ‚îÄ AI OUTFIT CRITIQUE ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"üß†"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Critique")),
          dailyPick&&dailyPick.outfit&&dailyPick.watch?React.createElement("div",null,
            !aiCritique&&!aiLoading&&React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiLoading(true);
              var result=await aiVision(dailyPick.outfit,dailyPick.watch,dailyPick.context,apiKeyRef.current);
              if(result)setAiCritique(result);else setAiCritique({vision:"AI unavailable. Check your API key in settings.",impact:0,impact_why:"",works:"",risk:"",strap_call:""});
              setAiLoading(false);
            }},"üß† Critique Today's Pick"),
            aiLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing...")),
            aiCritique&&React.createElement("div",{className:"fu"},
              /* Vision */
              aiCritique.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,borderLeft:"3px solid var(--gold)"}},
                React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiCritique.vision)),
              /* Impact score */
              aiCritique.impact>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:10}},
                React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiCritique.impact>=7?"rgba(122,184,122,0.15)":aiCritique.impact>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact>=8?"Commanding":aiCritique.impact>=6?"Solid":aiCritique.impact>=4?"Acceptable":"Needs Work"),
                  aiCritique.impact_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},aiCritique.impact_why))),
              /* Details */
              [aiCritique.color_story&&{l:"üé® Colors",t:aiCritique.color_story,c:"#9a8abc"},aiCritique.works&&{l:"‚úì What Works",t:aiCritique.works,c:"var(--good)"},aiCritique.risk&&{l:"‚ö† Risk",t:aiCritique.risk,c:"var(--warn)"},aiCritique.upgrade&&{l:"‚¨Ü Upgrade",t:aiCritique.upgrade,c:"var(--gold)"},aiCritique.strap_call&&{l:"üîó Strap Call",t:aiCritique.strap_call,c:"var(--sub)"}].filter(Boolean).map(function(item,i){
                return React.createElement("div",{key:i,style:{display:"flex",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:item.c,fontWeight:600,minWidth:70}},item.l),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},item.t))}),
              React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8,fontSize:11},onClick:function(){setAiCritique(null)}},"‚Üª Re-critique")))
          :React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Generate Today's Pick first ‚Üë")),

        /* ‚îÄ‚îÄ VISUAL OUTFIT CARD ‚îÄ‚îÄ */
        dailyPick&&dailyPick.outfit&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üé¥"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Outfit Card")),
          /* The card itself */
          React.createElement("div",{id:"outfit-card",style:{background:"linear-gradient(145deg,var(--card),var(--card2))",borderRadius:16,padding:"20px",border:"1px solid rgba(201,168,76,0.2)",maxWidth:340,margin:"0 auto"}},
            /* Date + context header */
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.12em"}},new Date().toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}).toUpperCase()),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},(CXI[dailyPick.context]||"")+" "+dailyPick.context)),
            /* Mannequin + Color blocks */
            React.createElement("div",{style:{display:"flex",gap:12,marginBottom:16,alignItems:"center"}},
              React.createElement(OutfitFigure,{topColor:getEP("t","top",dailyPick.outfit.top)?getEP("t","top",dailyPick.outfit.top).color:"grey",botColor:getEP("t","bot",dailyPick.outfit.bot)?getEP("t","bot",dailyPick.outfit.bot).color:"charcoal",shoeColor:getEP("t","shoe",dailyPick.outfit.shoe)?getEP("t","shoe",dailyPick.outfit.shoe).color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:"",size:90}),
              React.createElement("div",{style:{flex:1,display:"flex",gap:4,height:120}},
                [dailyPick.outfit.top,dailyPick.outfit.bot,dailyPick.outfit.shoe].filter(Boolean).map(function(item,i){
                  return React.createElement("div",{key:i,style:{flex:1,borderRadius:10,overflow:"hidden",position:"relative"}},
                    item.photoUrl?React.createElement("img",{src:ph(item.photoUrl),alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("div",{style:{width:"100%",height:"100%",background:(CM[item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent,rgba(0,0,0,0.7))",padding:"4px 6px"}},
                      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#fff"}},["TOP","BTM","SHOE"][i])))}))),
            /* Watch row */
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,background:"rgba(201,168,76,0.06)",borderRadius:10,padding:"10px 12px"}},
              React.createElement("span",{style:{fontSize:24}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},dailyPick.watch.d+" ¬∑ "+(dailyPick.strap&&dailyPick.strap.strap?((STRAP_TYPES.find(function(t){return t.id===dailyPick.strap.strap.type})||{icon:"üîó"}).icon+" "+(dailyPick.strap.strap.type==="bracelet"?"Bracelet":dailyPick.strap.strap.color+" "+dailyPick.strap.strap.type)):dailyPick.watch.br?"‚õìÔ∏è Bracelet":dailyPick.strap?dailyPick.strap.text:"Strap"))),
              aiCritique&&aiCritique.impact>0&&React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact)),
            React.createElement("div",{style:{textAlign:"center",marginTop:12}},
              React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--border)",letterSpacing:"0.2em"}},"WATCH ADVISOR")))),

        /* ‚îÄ‚îÄ WATCH WEAR STATS ‚îÄ‚îÄ */
        (function(){
          if(!wearLog.length&&!actW.length)return null;
          var now=Date.now();var d30=now-30*864e5;var d7=now-7*864e5;
          /* Only count wears for watches that still exist in the collection */
          var activeIds=new Set(actW.map(function(w){return w.id}));
          var validLog=wearLog.filter(function(e){return activeIds.has(e.watchId)&&(e.ts||0)>0});
          var last30=validLog.filter(function(e){return e.ts>d30});
          var last7=validLog.filter(function(e){return e.ts>d7});
          /* Frequency map: watchId ‚Üí count in last 30 days */
          var freq={};last30.forEach(function(e){freq[e.watchId]=(freq[e.watchId]||0)+1});
          /* Last worn map: watchId ‚Üí most recent timestamp */
          var lastW={};validLog.forEach(function(e){if(!lastW[e.watchId]||e.ts>lastW[e.watchId])lastW[e.watchId]=e.ts});
          /* Build sorted watch stats */
          var stats=actW.filter(function(w){return w.status==="active"}).map(function(w){
            var cnt=freq[w.id]||0;var lw=lastW[w.id]||0;var ago=lw?Math.floor((now-lw)/864e5):999;
            return{id:w.id,n:w.n,i:w.i,c:w.c,t:w.t,d:w.d,cnt:cnt,ago:ago,lw:lw}});
          stats.sort(function(a,b){return b.cnt-a.cnt});
          var maxCnt=Math.max.apply(null,stats.map(function(s){return s.cnt}).concat([1]));
          /* Neglected: active genuine watches not worn in 7+ days */
          var neglected=stats.filter(function(s){return s.ago>=7&&s.t!=="replica"});
          /* Current streak: consecutive days with a logged wear */
          var streak=0;var sd=new Date();sd.setHours(0,0,0,0);
          for(var si=0;si<60;si++){var ds=new Date(sd.getTime()-si*864e5).toISOString().slice(0,10);if(validLog.some(function(e){return e.date===ds}))streak++;else break}
          /* Empty state: watches exist but no wear data yet */
          if(!validLog.length)return React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{fontSize:20}},"üìä"),
              React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Wear Stats")),
            React.createElement("div",{style:{textAlign:"center",padding:"12px 0",color:"var(--dim)",fontSize:10,fontFamily:"var(--f)"}},"No wear data yet. Tap \"‚úì Wearing this today\" on a watch to start tracking."));
          return React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
              React.createElement("span",{style:{fontSize:20}},"üìä"),
              React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Wear Stats")),
            /* Summary row */
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:14}},
              [{v:last30.length,l:"This Month",i:"üìÖ"},{v:last7.length,l:"This Week",i:"üóìÔ∏è"},{v:streak,l:"Day Streak",i:"üî•"}].map(function(st){
                return React.createElement("div",{key:st.l,style:{background:"var(--bg)",borderRadius:10,padding:"10px 8px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:22,fontFamily:"var(--f)",fontWeight:700,color:"var(--gold)"}},st.v),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginTop:2}},st.i+" "+st.l))})),
            /* Frequency bars */
            React.createElement("div",{style:{marginBottom:neglected.length?12:0}},
              stats.slice(0,12).map(function(s){
                var pct=maxCnt>0?Math.round(s.cnt/maxCnt*100):0;
                var agoLabel=s.ago===0?"today":s.ago===1?"yesterday":s.ago<999?s.ago+"d ago":"never";
                var barColor=s.cnt>=6?"var(--good)":s.cnt>=3?"var(--gold)":"var(--warn)";
                return React.createElement("div",{key:s.id,style:{display:"flex",alignItems:"center",gap:8,marginBottom:5}},
                  React.createElement("span",{style:{fontSize:14,width:20,textAlign:"center",flexShrink:0}},s.i),
                  React.createElement("div",{style:{width:70,fontSize:9,fontFamily:"var(--f)",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flexShrink:0}},s.n),
                  React.createElement("div",{style:{flex:1,height:12,background:"var(--bg)",borderRadius:6,overflow:"hidden",border:"1px solid var(--border)"}},
                    React.createElement("div",{style:{width:Math.max(pct,2)+"%",height:"100%",background:barColor,borderRadius:6,transition:"width 0.3s"}})),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,minWidth:16,textAlign:"right",flexShrink:0}},s.cnt),
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:s.ago>=7?"var(--warn)":"var(--dim)",minWidth:42,textAlign:"right",flexShrink:0}},agoLabel))})),
            /* Neglected watches alert */
            neglected.length>0&&React.createElement("div",{style:{background:"rgba(200,90,58,0.06)",border:"1px solid rgba(200,90,58,0.15)",borderRadius:10,padding:"10px 12px"}},
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"‚è∞ Neglected ‚Äî "+neglected.length+" watch"+(neglected.length>1?"es":"")+" not worn in 7+ days"),
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                neglected.slice(0,6).map(function(s){
                  return React.createElement("span",{key:s.id,style:{display:"inline-flex",alignItems:"center",gap:4,fontSize:9,fontFamily:"var(--f)",color:"var(--text)",background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},
                    React.createElement("span",{style:{fontSize:12}},s.i),s.n+" ("+s.ago+"d)")}))))})(),

        /* ‚îÄ‚îÄ AI STYLE COACH ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"üéì"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Style Coach")),
          !aiCoach&&!aiCoachLoading&&React.createElement("div",null,
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Get personalized style advice based on your entire wardrobe and watch collection."),
            React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiCoachLoading(true);
              var result=await aiStyleCoach(wd,actW,ctx,apiKeyRef.current);
              setAiCoach(result||{summary:"AI unavailable. Check your API key in settings.",strengths:[],gaps:[],next_buys:[],style_tip:"",versatility:0});
              setAiCoachLoading(false);
            }},"üéì Get Style Advice")),
          aiCoachLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing your wardrobe...")),
          aiCoach&&React.createElement("div",{className:"fu"},
            aiCoach.versatility>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12}},
              React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiCoach.versatility>=7?"rgba(122,184,122,0.15)":aiCoach.versatility>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(aiCoach.versatility>=7?"var(--good)":aiCoach.versatility>=4?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:aiCoach.versatility>=7?"var(--good)":aiCoach.versatility>=4?"var(--gold)":"var(--warn)"}},aiCoach.versatility+"/10"),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"Versatility Score"),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},aiCoach.versatility>=8?"Exceptional range":"Room to grow"))),
            aiCoach.summary&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:12,borderLeft:"3px solid var(--gold)"}},
              React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiCoach.summary)),
            aiCoach.strengths&&aiCoach.strengths.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:6}},"‚úì STRENGTHS"),
              aiCoach.strengths.map(function(s,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},"‚Ä¢ "+s)})),
            aiCoach.gaps&&aiCoach.gaps.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"‚ö† GAPS"),
              aiCoach.gaps.map(function(g,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},"‚Ä¢ "+g)})),
            aiCoach.next_buys&&aiCoach.next_buys.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"üõçÔ∏è NEXT BUYS"),
              aiCoach.next_buys.map(function(b,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},(i+1)+". "+b)})),
            aiCoach.signature_combos&&aiCoach.signature_combos.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"üî• SIGNATURE COMBINATIONS"),
              aiCoach.signature_combos.map(function(c,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"6px 8px",marginBottom:4,background:"rgba(201,168,76,0.04)",borderRadius:6,border:"1px solid rgba(201,168,76,0.1)",borderLeft:"3px solid var(--gold)"}},(i+1)+". "+c)})),
            aiCoach.seasonal_weak&&React.createElement("div",{style:{background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 12px",marginBottom:8,border:"1px solid rgba(200,90,58,0.15)"}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"üìÖ Seasonal Gap: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiCoach.seasonal_weak)),
            aiCoach.style_tip&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"10px 12px",marginTop:8,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"üí° Pro Tip: "),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiCoach.style_tip)),
            React.createElement("button",{className:"btn btn-ghost",style:{marginTop:10,fontSize:10},onClick:function(){setAiCoach(null)}},"‚Üª Re-analyze"))),

        /* ‚îÄ‚îÄ AI OCCASION PLANNER ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"üéØ"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Occasion Planner")),
          React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Describe an event or occasion and get outfit recommendations from your wardrobe."),
          React.createElement("input",{className:"inp",value:aiOccasionInput,onChange:function(e){setAiOccasionInput(e.target.value)},placeholder:"e.g. Business dinner, Beach wedding, First date at rooftop bar...",style:{marginBottom:10,fontSize:12}}),
          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:10}},
            ["Business Dinner","Date Night","Wedding Guest","Casual Friday","Cocktail Party","Weekend Brunch"].map(function(sug){
              return React.createElement("span",{key:sug,className:"chip",onClick:function(){setAiOccasionInput(sug)},style:{fontSize:9}},sug)})),
          !aiOccasion&&!aiOccasionLoading&&React.createElement("button",{className:"btn btn-gold",onClick:async function(){
            if(!aiOccasionInput.trim()){showToast("Describe an occasion first","var(--warn)");return}
            setAiOccasionLoading(true);
            var result=await aiOccasionPlan(aiOccasionInput.trim(),wd,actW,apiKeyRef.current);
            setAiOccasion(result||{occasion_tips:"AI unavailable. Check your API key in settings.",outfits:[],avoid:""});
            setAiOccasionLoading(false);
          }},"üéØ Plan My Outfit"),
          aiOccasionLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Planning outfit...")),
          aiOccasion&&React.createElement("div",{className:"fu"},
            aiOccasion.occasion_tips&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:12,borderLeft:"3px solid var(--gold)"}},
              React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiOccasion.occasion_tips)),
            aiOccasion.outfits&&aiOccasion.outfits.map(function(outfit,oi){
              return React.createElement("div",{key:oi,style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,border:"1px solid "+(oi===0?"rgba(201,168,76,0.3)":"var(--border)")}},
                React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
                  React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600,color:oi===0?"var(--gold)":"var(--text)"}},outfit.name),
                  outfit.confidence&&React.createElement("div",{style:{width:28,height:28,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(outfit.confidence>=7?"var(--good)":"var(--gold)"),fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:outfit.confidence>=7?"var(--good)":"var(--gold)"}},outfit.confidence)),
                React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,marginBottom:6}},
                  [{l:"üëï Top",v:outfit.top},{l:"üëñ Bottom",v:outfit.bottom},{l:"üëû Shoes",v:outfit.shoes},{l:"‚åö Watch",v:outfit.watch},outfit.layers&&{l:"üß• Layers",v:outfit.layers}].filter(Boolean).map(function(p,pi){
                    return React.createElement("div",{key:pi,style:{display:"flex",gap:8,fontSize:10,fontFamily:"var(--f)"}},
                      React.createElement("span",{style:{color:"var(--dim)",minWidth:55}},p.l),
                      React.createElement("span",{style:{color:"var(--text)",fontWeight:500}},p.v))})),
                outfit.why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",fontStyle:"italic",marginTop:4}},outfit.why))}),
            aiOccasion.avoid&&React.createElement("div",{style:{background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 12px",border:"1px solid rgba(200,90,58,0.15)",marginBottom:8}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"‚ùå Avoid: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiOccasion.avoid)),
            aiOccasion.power_move&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"8px 12px",border:"1px solid rgba(201,168,76,0.2)",marginBottom:8}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"‚ö° Power Move: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiOccasion.power_move)),
            React.createElement("button",{className:"btn btn-ghost",style:{fontSize:10},onClick:function(){setAiOccasion(null)}},"‚Üª Try Again"))),

        /* ‚îÄ‚îÄ AI WARDROBE AUDIT ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"üìã"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Wardrobe Audit")),
          !aiAudit&&!aiAuditLoading&&React.createElement("div",null,
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Comprehensive AI analysis of your entire wardrobe ‚Äî grading, seasonal readiness, and investment recommendations."),
            React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiAuditLoading(true);
              var result=await aiWardrobeAudit(wd,actW,saved,wearLog,apiKeyRef.current);
              setAiAudit(result||{grade:"?",grade_why:"AI unavailable. Check your API key in settings."});
              setAiAuditLoading(false);
            }},"üìã Run Full Audit")),
          aiAuditLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Auditing wardrobe...")),
          aiAudit&&React.createElement("div",{className:"fu"},
            /* Grade */
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:14,marginBottom:14}},
              React.createElement("div",{style:{width:56,height:56,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiAudit.grade==="A"||aiAudit.grade==="A+"?"rgba(122,184,122,0.15)":aiAudit.grade==="B"?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"3px solid "+(aiAudit.grade==="A"||aiAudit.grade==="A+"?"var(--good)":aiAudit.grade==="B"?"var(--gold)":"var(--warn)"),fontSize:22,fontFamily:"var(--f)",fontWeight:700,color:aiAudit.grade==="A"||aiAudit.grade==="A+"?"var(--good)":aiAudit.grade==="B"?"var(--gold)":"var(--warn)"}},aiAudit.grade),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},"Wardrobe Grade"),
                aiAudit.grade_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},aiAudit.grade_why))),
            /* Details */
            [aiAudit.color_harmony&&{l:"üé® Color Harmony",t:aiAudit.color_harmony},aiAudit.versatility&&{l:"üîÑ Versatility",t:aiAudit.versatility},aiAudit.cost_efficiency&&{l:"üí∞ Efficiency",t:aiAudit.cost_efficiency},aiAudit.watch_wardrobe_synergy&&{l:"‚åö Watch Synergy",t:aiAudit.watch_wardrobe_synergy}].filter(Boolean).map(function(d,i){
              return React.createElement("div",{key:i,style:{background:"var(--bg)",borderRadius:8,padding:"10px 12px",marginBottom:6,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:3}},d.l),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},d.t))}),
            /* Seasonal scores */
            aiAudit.seasonal_score&&React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:10,marginTop:8}},
              [{s:"spring",i:"üå∏"},{s:"summer",i:"‚òÄÔ∏è"},{s:"fall",i:"üçÇ"},{s:"winter",i:"‚ùÑÔ∏è"}].map(function(sn){
                var sc=aiAudit.seasonal_score[sn.s]||0;
                return React.createElement("div",{key:sn.s,style:{textAlign:"center",background:"var(--bg)",borderRadius:8,padding:"8px 4px",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:16}},sn.i),
                  React.createElement("div",{style:{fontSize:16,fontFamily:"var(--f)",fontWeight:700,color:sc>=7?"var(--good)":sc>=4?"var(--gold)":"var(--warn)"}},sc+"/10"),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textTransform:"capitalize"}},sn.s))})),
            /* Declutter + Invest */
            aiAudit.declutter&&aiAudit.declutter.length>0&&React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:4}},"üßπ Consider Decluttering"),
              aiAudit.declutter.map(function(d,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"3px 0"}},"‚Ä¢ "+d)})),
            aiAudit.invest&&aiAudit.invest.length>0&&React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:4}},"üíé Worth Investing In"),
              aiAudit.invest.map(function(d,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"3px 0"}},"‚Ä¢ "+d)})),
            aiAudit.style_identity&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"10px 12px",marginBottom:8,border:"1px solid var(--border)"}},
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:3}},"üé≠ Style Identity"),
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiAudit.style_identity)),
            aiAudit.pro_tip&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"10px 12px",marginTop:8,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"üí° "),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiAudit.pro_tip)),
            React.createElement("button",{className:"btn btn-ghost",style:{marginTop:10,fontSize:10},onClick:function(){setAiAudit(null)}},"‚Üª Re-audit"))),

        /* ‚îÄ‚îÄ COLLECTION HEATMAP ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üó∫Ô∏è"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Context Coverage")),
          React.createElement("div",{style:{overflowX:"auto"},className:"hscroll"},
            React.createElement("div",{style:{minWidth:Math.max(500,activeCxIds.slice(0,8).length*60+120)}},
              /* Header row */
              React.createElement("div",{style:{display:"flex",gap:2,marginBottom:4,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.05em"}},(activeCxIcons[cx]||CXI[cx]||"")+"\n"+cx)})),
              /* Watch rows */
              actW.slice(0,20).map(function(w){
                return React.createElement("div",{key:w.id,style:{display:"flex",gap:2,marginBottom:2,alignItems:"center"}},
                  React.createElement("div",{style:{flex:"0 0 108px",display:"flex",alignItems:"center",gap:4,overflow:"hidden"}},
                    React.createElement("span",{style:{fontSize:12}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},w.n)),
                  activeCxIds.slice(0,8).map(function(cx){
                    var inCtx=(w.cx||[]).includes(cx);
                    var colorScore=0;
                    (w.mc||[]).forEach(function(mc){if(["navy","charcoal","white","cream","black","grey"].includes(mc))colorScore++});
                    var heat=inCtx?(colorScore>4?3:colorScore>2?2:1):0;
                    var bg=heat===3?"rgba(122,184,122,0.4)":heat===2?"rgba(122,184,122,0.2)":heat===1?"rgba(201,168,76,0.15)":"var(--card)";
                    return React.createElement("div",{key:cx,style:{flex:"0 0 52px",height:20,borderRadius:3,background:bg,border:"1px solid "+(inCtx?"rgba(122,184,122,0.15)":"var(--border)")}})}))}),
              /* Coverage summary */
              React.createElement("div",{style:{display:"flex",gap:2,marginTop:8,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){
                  var count=actW.filter(function(w){return(w.cx||[]).includes(cx)}).length;
                  var pct=actW.length?Math.round(count/actW.length*100):0;
                  return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:700,color:count>=5?"var(--good)":count>=3?"var(--gold)":"var(--warn)"}},count),
                    React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},pct+"%"))})),
              /* Legend */
              React.createElement("div",{style:{display:"flex",gap:12,marginTop:10,paddingLeft:110}},
                [{c:"rgba(122,184,122,0.4)",l:"Strong"},{c:"rgba(122,184,122,0.2)",l:"Good"},{c:"rgba(201,168,76,0.15)",l:"Basic"},{c:"var(--card)",l:"None"}].map(function(lg){
                  return React.createElement("div",{key:lg.l,style:{display:"flex",alignItems:"center",gap:4}},
                    React.createElement("div",{style:{width:12,height:12,borderRadius:2,background:lg.c,border:"1px solid var(--border)"}}),
                    React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},lg.l))})))),

        /* ‚îÄ‚îÄ WARDROBE COLOR WHEEL ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üé®"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Color Distribution")),
          (function(){
            /* Count colors across wardrobe */
            var colorCounts={};
            wd.filter(function(i){return i.color}).forEach(function(i){var c=i.color.toLowerCase();colorCounts[c]=(colorCounts[c]||0)+1});
            var sorted=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]});
            var total=wd.filter(function(i){return i.color}).length||1;
            /* Watch dial colors */
            var watchColors={};
            actW.forEach(function(w){var d=(w.d||"").toLowerCase();watchColors[d]=(watchColors[d]||0)+1});
            var wSorted=Object.entries(watchColors).sort(function(a,b){return b[1]-a[1]});
            /* Temperature balance */
            var warm=0,cool=0,neutral=0;
            sorted.forEach(function(e){var t=(CM[e[0]]||{}).t;if(t==="warm")warm+=e[1];else if(t==="cool")cool+=e[1];else neutral+=e[1]});
            return React.createElement("div",null,
              /* Color bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var pct=Math.round(e[1]/total*100);
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
                    React.createElement(Dot,{color:e[0],size:12}),
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:70}},e[0]),
                    React.createElement("div",{style:{flex:1,height:14,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:(CM[e[0]]||{}).h||"#5a5a5a",borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:24,textAlign:"right"}},e[1]))})),
              /* Temp balance */
              React.createElement("div",{style:{display:"flex",gap:4,marginBottom:14}},
                [{l:"Warm",v:warm,c:"#d87a2a"},{l:"Cool",v:cool,c:"#2a5a9a"},{l:"Neutral",v:neutral,c:"#8a8a8a"}].map(function(t){
                  var pct=Math.round(t.v/total*100);
                  return React.createElement("div",{key:t.l,style:{flex:t.v||1,background:t.c+"30",borderRadius:8,padding:"8px 10px",textAlign:"center",border:"1px solid "+t.c+"20"}},
                    React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:t.c}},pct+"%"),
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},t.l))})),
              /* Watch dials */
              wSorted.length>0&&React.createElement("div",null,
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WATCH DIAL COLORS"),
                React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                  wSorted.map(function(e){return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},e[0]),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"√ó"+e[1]))}))));
          })())),

        /* ‚îÄ‚îÄ SEASONAL CLOSET GAPS ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üìÖ"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Seasonal Readiness")),
          (function(){
            var seasons=["spring","summer","fall","winter"];var icons={spring:"üå∏",summer:"‚òÄÔ∏è",fall:"üçÇ",winter:"‚ùÑÔ∏è"};
            var cats=["tops","bottoms","shoes"];
            var data=seasons.map(function(s){
              var counts={};cats.forEach(function(cat){
                counts[cat]=wd.filter(function(i){return catOf(i.garmentType)===cat&&i.color&&(!i.seasons||!i.seasons.length||i.seasons.length>=4||i.seasons.includes(s))}).length;
              });
              var total=counts.tops+counts.bottoms+counts.shoes;
              var ready=counts.tops>=2&&counts.bottoms>=2&&counts.shoes>=1;
              return{s:s,icon:icons[s],counts:counts,total:total,ready:ready};
            });
            var curSn=getSeason(weather?weather.temp:undefined,loc?loc.lat:undefined);
            return React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
              data.map(function(d){
                return React.createElement("div",{key:d.s,style:{background:d.s===curSn?"rgba(201,168,76,0.06)":"var(--bg)",border:"1px solid "+(d.s===curSn?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:10,padding:"10px 12px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:6}},
                    React.createElement("span",{style:{fontSize:16}},d.icon),
                    React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:d.s===curSn?"var(--gold)":"var(--text)",textTransform:"capitalize"}},d.s),
                    d.s===curSn&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--gold)",background:"rgba(201,168,76,0.15)",borderRadius:3,padding:"1px 5px"}},"NOW"),
                    React.createElement("span",{style:{marginLeft:"auto",fontSize:10,color:d.ready?"var(--good)":"var(--warn)"}},d.ready?"‚úì":"‚ö†")),
                  React.createElement("div",{style:{display:"flex",gap:4}},
                    [{l:"üëï",v:d.counts.tops,min:2},{l:"üëñ",v:d.counts.bottoms,min:2},{l:"üëû",v:d.counts.shoes,min:1}].map(function(c,ci){
                      return React.createElement("div",{key:ci,style:{flex:1,textAlign:"center",borderRadius:6,padding:"4px 2px",background:c.v>=c.min?"rgba(122,184,122,0.1)":"rgba(200,90,58,0.08)",border:"1px solid "+(c.v>=c.min?"rgba(122,184,122,0.15)":"rgba(200,90,58,0.15)")}},
                        React.createElement("div",{style:{fontSize:10}},c.l),
                        React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:c.v>=c.min?"var(--good)":"var(--warn)"}},c.v))})));
              }));
          })()),

        /* ‚îÄ‚îÄ COLOR GAP ANALYSIS ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üîç"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Color Gap Analysis")),
          (function(){
            /* Find colors needed by watches but missing from wardrobe */
            var wdColors={};wd.filter(function(i){return i.color}).forEach(function(i){wdColors[i.color.toLowerCase()]=true});
            var needed={};actW.forEach(function(w){(w.mc||[]).forEach(function(c){if(c!=="anything"&&!wdColors[c])needed[c]=(needed[c]||0)+1})});
            var gaps=Object.entries(needed).sort(function(a,b){return b[1]-a[1]}).slice(0,8);
            if(!gaps.length)return React.createElement("div",{style:{textAlign:"center",padding:10}},
              React.createElement("span",{style:{fontSize:12}},"‚úì"),
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--good)",margin:"4px 0 0"}},"Great coverage! Your wardrobe has colors for all your watches."));
            return React.createElement("div",null,
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Colors your watches want but your wardrobe doesn't have:"),
              React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:6}},
                gaps.map(function(g){
                  var matchingWatches=actW.filter(function(w){return(w.mc||[]).includes(g[0])}).slice(0,3);
                  return React.createElement("div",{key:g[0],style:{display:"flex",alignItems:"center",gap:8,background:"var(--bg)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(200,90,58,0.15)"}},
                    React.createElement(Dot,{color:g[0],size:14}),
                    React.createElement("div",{style:{flex:1,minWidth:0}},
                      React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)",textTransform:"capitalize"}},g[0]),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Needed by "+matchingWatches.map(function(w){return w.i+" "+w.n}).join(", "))),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,flexShrink:0}},g[1]+" watch"+(g[1]>1?"es":"")))})));
          })()),

        /* ‚îÄ‚îÄ WATCH PAIRING SUGGESTIONS ‚îÄ‚îÄ */
        actW.length>0&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"‚åö"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Watch Pairing Guide")),
          React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Best garment colors for each watch, based on your wardrobe:"),
          actW.slice(0,8).map(function(w){
            /* Find best matching garments from wardrobe */
            var scored=wd.filter(function(i){return i.color&&!i.needsEdit}).map(function(i){
              var ic=i.color.toLowerCase().trim();var s=0;
              for(var m of(w.mc||[])){if(m==="anything"||ic.includes(m)||m.includes(ic)){s+=3;break}}
              for(var a of(w.ac||[])){if(ic.includes(a)||a.includes(ic)){s-=3;break}}
              var wt=(CM[ic]||{}).t||"neutral";if(w.mt===wt)s+=1;
              return{g:i,s:s};
            }).filter(function(x){return x.s>0}).sort(function(a,b){return b.s-a.s}).slice(0,4);
            var missingColors=(w.mc||[]).filter(function(mc){return mc!=="anything"&&!wd.some(function(i){return i.color&&i.color.toLowerCase()===mc})}).slice(0,3);
            return React.createElement("div",{key:w.id,style:{background:"var(--bg)",borderRadius:10,padding:"10px 12px",marginBottom:6,border:"1px solid var(--border)"}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"18",fontSize:16,flexShrink:0}},w.i),
                React.createElement("div",{style:{flex:1,minWidth:0}},
                  React.createElement("span",{style:{fontSize:12,fontWeight:600}},w.n),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:6}},w.d+" ¬∑ "+(w.straps&&w.straps.length?w.straps.length+" strap"+(w.straps.length>1?"s":""):w.br?"Bracelet":"Strap")))),
              scored.length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:missingColors.length?6:0}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--good)",alignSelf:"center"}},"‚úì Best:"),
                scored.map(function(x){return React.createElement("div",{key:x.g.id,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(122,184,122,0.06)",borderRadius:6,padding:"3px 8px",border:"1px solid rgba(122,184,122,0.15)"}},
                  React.createElement(Dot,{color:x.g.color,size:5}),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--text)"}},x.g.name||x.g.color))})),
              missingColors.length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)",alignSelf:"center"}},"+ Need:"),
                missingColors.map(function(mc){return React.createElement("div",{key:mc,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(200,90,58,0.06)",borderRadius:6,padding:"3px 8px",border:"1px solid rgba(200,90,58,0.15)"}},
                  React.createElement(Dot,{color:mc,size:5}),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},mc))})));
          })),

        /* ‚îÄ‚îÄ GARMENT ROTATION STATS ‚îÄ‚îÄ */
        wd.some(function(i){return i.lastWorn})&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üëî"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Garment Rotation")),
          (function(){
            var now=Date.now();var tracked=wd.filter(function(i){return i.lastWorn&&i.color});
            if(!tracked.length)return null;
            /* Sort by stalest first */
            var sorted=tracked.map(function(i){return{g:i,d:Math.floor((now-new Date(i.lastWorn).getTime())/864e5)}}).sort(function(a,b){return b.d-a.d});
            var maxD=sorted[0].d||1;
            return React.createElement("div",null,
              React.createElement("div",{style:{display:"flex",gap:8,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:8}},
                React.createElement("span",null,"üìè "+tracked.length+" garments tracked"),
                React.createElement("span",null,"Avg "+Math.round(sorted.reduce(function(a,b){return a+b.d},0)/sorted.length)+"d between wears")),
              sorted.slice(0,8).map(function(e){
                var pct=Math.round(e.d/maxD*100);
                var col=e.d<=2?"var(--warn)":e.d<=7?"var(--gold)":e.d<=14?"var(--sub)":"var(--good)";
                return React.createElement("div",{key:e.g.id,style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                  e.g.photoUrl?React.createElement("img",{src:ph(e.g.photoUrl),alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}):React.createElement(Dot,{color:e.g.color,size:8}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},e.g.name||e.g.color),
                  React.createElement("div",{style:{flex:1,height:8,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                    React.createElement("div",{style:{height:"100%",width:pct+"%",background:col,borderRadius:4,minWidth:2}})),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:col,minWidth:32,textAlign:"right"}},e.d===0?"today":e.d+"d"))}),
              sorted.length>8&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",marginTop:4}},"+"+(sorted.length-8)+" more garments tracked"));
          })()),

        /* ‚îÄ‚îÄ WEAR STATS DASHBOARD ‚îÄ‚îÄ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"üìä"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Wear Stats")),
          (function(){
            if(!wearLog.length)return React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Start logging wear in the rotation tab to build stats.");
            /* Count wears per watch */
            var wearCounts={};var genWears=0;var repWears=0;
            wearLog.forEach(function(e){wearCounts[e.watchId]=(wearCounts[e.watchId]||0)+1;var wObj=W.find(function(w){return w.id===e.watchId});if(wObj){if(wObj.t==="genuine")genWears++;else repWears++}});
            var sorted=Object.entries(wearCounts).sort(function(a,b){return b[1]-a[1]});
            var maxWears=sorted.length?sorted[0][1]:1;
            /* Never-worn active watches */
            var neverWorn=actW.filter(function(w){return !wearCounts[w.id]&&w.status==="active"});
            /* Streak ‚Äî consecutive days logged */
            var dates=wearLog.map(function(e){return e.date}).sort().reverse();
            var uniqueDates=[...new Set(dates)];
            var streak=0;var checkDate=new Date();
            for(var si=0;si<90;si++){var ds=checkDate.toISOString().slice(0,10);if(uniqueDates.includes(ds)){streak++;checkDate.setDate(checkDate.getDate()-1)}else if(si===0){checkDate.setDate(checkDate.getDate()-1);continue}else break}
            return React.createElement("div",null,
              /* Summary row */
              React.createElement("div",{style:{display:"flex",gap:8,marginBottom:14}},
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--gold)"}},wearLog.length),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Total wears")),
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--good)"}},streak),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Day streak")),
                !IS_SHARED&&React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid "+(genWears>=repWears?"rgba(122,184,122,0.3)":"rgba(200,90,58,0.3)")}},
                  React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:genWears>=repWears?"var(--good)":"var(--warn)"}},genWears+"/"+repWears),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Gen / Rep"))),
              /* Frequency bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var wObj=W.find(function(w){return w.id===e[0]});if(!wObj)return null;
                  var pct=Math.round(e[1]/maxWears*100);
                  var barC=IS_SHARED?"var(--gold)":(wObj.t==="genuine"?"var(--good)":"#7ab8d8");
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                    React.createElement("span",{style:{fontSize:12,flexShrink:0,width:18,textAlign:"center"}},wObj.i),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},wObj.n),
                    React.createElement("div",{style:{flex:1,height:12,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:barC,borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:18,textAlign:"right"}},e[1]))})),
              /* 4-week wear calendar */
              React.createElement("div",{style:{marginTop:10,paddingTop:10,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WEAR CALENDAR"),
                React.createElement("div",{style:{display:"flex",gap:3,marginBottom:4}},["S","M","T","W","T","F","S"].map(function(d,i){return React.createElement("div",{key:i,style:{flex:1,textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},d)})),
                (function(){
                  var cells=[];var today=new Date();
                  for(var ci=27;ci>=0;ci--){var cd=new Date(today);cd.setDate(cd.getDate()-ci);cells.push({date:cd.toISOString().slice(0,10),dow:cd.getDay()})}
                  /* Pad start to align with day-of-week */
                  var padStart=cells[0]?cells[0].dow:0;var padded=[];for(var pi=0;pi<padStart;pi++)padded.push(null);padded=padded.concat(cells);
                  var rows=[];for(var ri=0;ri<padded.length;ri+=7)rows.push(padded.slice(ri,ri+7));
                  return React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:2}},
                    rows.map(function(row,ri2){return React.createElement("div",{key:ri2,style:{display:"flex",gap:3}},
                      row.concat(Array(7-row.length).fill(null)).slice(0,7).map(function(cell,ci2){
                        if(!cell)return React.createElement("div",{key:ci2,style:{flex:1,height:18,borderRadius:3}});
                        var entry=wearLog.find(function(e){return e.date===cell.date});var wObj=entry?W.find(function(w){return w.id===entry.watchId}):null;
                        var bg=wObj?wObj.c:"var(--card2)";
                        return React.createElement("div",{key:ci2,title:cell.date+(wObj?" ‚Äî "+wObj.n:""),style:{flex:1,height:18,borderRadius:3,background:bg,border:"1px solid "+(wObj?bg+"60":"var(--border)"),opacity:wObj?1:0.4}})}))}));
                })()),

              /* Never worn section */
              neverWorn.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"üí§ NEVER LOGGED ("+neverWorn.length+")"),
                React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
                  neverWorn.map(function(w){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(200,90,58,0.06)",border:"1px solid rgba(200,90,58,0.15)",borderRadius:6,padding:"3px 8px"}},
                    React.createElement("span",{style:{fontSize:10}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},w.n))}))));
          })())),

      /* ‚ïê‚ïê‚ïê WATCHES ‚ïê‚ïê‚ïê */
      view==="watches"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* Collection Stats */
        (function(){
          var gen=W.filter(function(w){return w.t==="genuine"&&w.active}).length;
          var rep=W.filter(function(w){return w.t==="replica"&&w.active}).length;
          var brC=W.filter(function(w){return w.br&&w.active}).length;
          var stC=W.filter(function(w){return!w.br&&w.active}).length;
          var incC=W.filter(function(w){return w.status==="incoming"}).length;
          var pendC=W.filter(function(w){return w.status==="pending-trade"}).length;
          var cats={};W.filter(function(w){return w.active}).forEach(function(w){(w.cx||[]).forEach(function(c){cats[c]=(cats[c]||0)+1})});
          var topCx=Object.entries(cats).sort(function(a,b){return b[1]-a[1]}).slice(0,3);
          return React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid var(--border)",borderRadius:12,padding:"12px 16px",marginBottom:12}},
            React.createElement("div",{style:{display:"flex",gap:16,flexWrap:"wrap",fontSize:10,fontFamily:"var(--f)"}},
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--gold)",fontWeight:700,fontSize:18}},gen+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"active")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"var(--good)"}},"‚úì "+gen),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"genuine")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"#7ab8d8"}},"‚óá "+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"replica")),
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--sub)"}},"‚õìÔ∏è"+brC+" üîó"+stC)),
              incC>0&&React.createElement("div",null,React.createElement("span",{style:{color:"#d4b82a"}},"üì¶ "+incC),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"incoming")),
              pendC>0&&React.createElement("div",null,React.createElement("span",{style:{color:"var(--warn)"}},"üîÑ "+pendC),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"pending"))),
            topCx.length>0&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:6}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Top contexts:"),
              topCx.map(function(e){return React.createElement("span",{key:e[0],style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},(CXI[e[0]]||"")+e[0]+" √ó"+e[1])})));
        })(),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:12}},
          (IS_SHARED?[{id:"all",l:"All "+W.length},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]:[{id:"all",l:"All "+W.length},{id:"genuine",l:"Gen"},{id:"replica",l:"Rep"},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]).map(function(f){return React.createElement(Pill,{key:f.id,on:wTab===f.id,onClick:function(){setWTab(f.id)}},f.l)}),
          React.createElement("input",{className:"inp",value:wSearch,onChange:function(e){setWSearch(e.target.value)},placeholder:"Search watches...",style:{flex:1,minWidth:80,fontSize:11,padding:"8px 12px",borderRadius:20,background:"var(--bg)",border:"1px solid var(--border)",color:"var(--text)",fontFamily:"var(--f)"}}),
          wSearch&&React.createElement("button",{onClick:function(){setWSearch("")},style:{background:"none",border:"1px solid var(--border)",borderRadius:20,padding:"8px 10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:36}},"‚úï"),
          React.createElement("button",{onClick:function(){wCamRef.current&&wCamRef.current.click()},style:{marginLeft:wSearch?"0":"auto",background:"none",border:"1px solid rgba(201,168,76,0.4)",borderRadius:20,padding:"8px 14px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"üì∏ Camera"),
          React.createElement("button",{onClick:function(){wPhotoRef.current&&wPhotoRef.current.click()},style:{background:"none",border:"1px solid rgba(201,168,76,0.4)",borderRadius:20,padding:"8px 14px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"üñºÔ∏è Gallery"),
          React.createElement("button",{onClick:function(){var nw={id:"c-"+Date.now(),n:"New Watch",t:"genuine",d:"",c:"#5a5a5a",br:true,sc:[],straps:[{type:"bracelet",color:"silver",material:"steel"}],mt:"neutral",i:"‚åö",mc:IS_SHARED?autoMatchColors(""):[],ac:[],cx:["casual"],wt:IS_SHARED?["light","mid","heavy"]:["mid"],sg:"",active:true,status:"active"};setW(function(p){var u=p.concat([nw]);ps("w_"+SK,u);return u});setEditW(nw)},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:20,padding:"8px 16px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"+ Add"),
          React.createElement("button",{onClick:function(){var d=findWatchDupes();setWDupeGroups(d);setShowWDupes(true)},style:{background:"none",border:"1px solid rgba(200,90,58,0.4)",borderRadius:20,padding:"8px 12px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:36}},"üîç Dupes")),
        /* Hidden file inputs for watch scan */
        React.createElement("input",{ref:wPhotoRef,type:"file",accept:"image/*",multiple:true,style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){scanWatch(e.target.files);e.target.value=""}}}),
        React.createElement("input",{ref:wCamRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){scanWatch(e.target.files[0]);e.target.value=""}}}),
        /* Watch scan loading */
        watchScanLoading&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.3)",borderRadius:12,padding:"16px",marginBottom:12,textAlign:"center"}},
          React.createElement("div",{className:"sp",style:{width:24,height:24,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),
          React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",color:"var(--gold)"}},scanProg?"Scanning "+scanProg.c+"/"+scanProg.t+"...":"Identifying watch..."),
          scanProg&&React.createElement("div",{style:{marginTop:8}},
            React.createElement("div",{style:{height:4,background:"var(--bg)",borderRadius:2,overflow:"hidden",marginBottom:8}},
              React.createElement("div",{style:{height:"100%",width:Math.round(scanProg.c/scanProg.t*100)+"%",background:"var(--gold)",borderRadius:2,transition:"width 0.3s"}})),
            React.createElement("button",{onClick:function(){scanCancelRef.current=true},className:"btn btn-ghost",style:{fontSize:9,padding:"4px 12px"}},"\u2715 Cancel"))),
        /* Watch scan result */
        watchScanResult&&!watchScanLoading&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:12}},
          watchScanResult.error?React.createElement("div",null,
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{fontSize:18}},"‚ö†Ô∏è"),
              React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"Could Not Identify Watch")),
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},watchScanResult.error),
            React.createElement("button",{onClick:function(){setWatchScanResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))
          :React.createElement("div",null,
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12}},
              React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:(watchScanResult.ai.dial_hex||"#5a5a5a")+"20",fontSize:24,border:"2px solid "+(watchScanResult.ai.dial_hex||"#5a5a5a")+"50"}},watchScanResult.ai.emoji||"‚åö"),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:16,fontWeight:600,color:"var(--gold)"}},watchScanResult.ai.brand+" "+watchScanResult.ai.model),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},(watchScanResult.ai.dial_color||"")+" dial"+(watchScanResult.ai.case_size?" ¬∑ "+watchScanResult.ai.case_size+"mm":"")+" ¬∑ "+(watchScanResult.ai.case_material||"steel")+(watchScanResult.ai.reference?" ¬∑ Ref "+watchScanResult.ai.reference:"")),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",marginTop:2}},(watchScanResult.ai.complications||[]).join(", "))),
              watchScanResult.ai.confidence&&React.createElement("div",{style:{width:36,height:36,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(watchScanResult.ai.confidence>=7?"var(--good)":watchScanResult.ai.confidence>=4?"var(--gold)":"var(--warn)"),fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:watchScanResult.ai.confidence>=7?"var(--good)":watchScanResult.ai.confidence>=4?"var(--gold)":"var(--warn)"}},watchScanResult.ai.confidence)),
            watchScanResult.ai.notes&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--sf)",fontStyle:"italic",color:"var(--sub)",marginBottom:10,lineHeight:1.5}},watchScanResult.ai.notes),
            React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:10}},(watchScanResult.ai.suggested_contexts||[]).map(function(cx){return React.createElement("span",{key:cx,className:"chip",style:{fontSize:8,padding:"2px 8px"}},(CXI[cx]||"")+" "+cx)})),
            watchScanResult.watch&&watchScanResult.watch.photoUrl&&React.createElement("img",{src:ph(watchScanResult.watch.photoUrl),alt:"Scanned watch",style:{width:"100%",maxHeight:180,objectFit:"cover",borderRadius:10,marginBottom:10,border:"1px solid var(--border)"}}),
            React.createElement("div",{style:{display:"flex",gap:8}},
              React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){
                var nw=watchScanResult.watch;
                setW(function(p){var u=p.concat([nw]);ps("w_"+SK,u);return u});
                setEditW(nw);setWatchScanResult(null);
              }},"‚úì Add to Collection"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setWatchScanResult(null)}},"‚úï")))),
        watchScanResult&&!watchScanLoading&&watchScanResult.batch&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid "+(watchScanResult.error?"rgba(200,90,58,0.3)":"rgba(122,184,122,0.3)"),borderRadius:14,padding:"16px",marginBottom:12}},
          watchScanResult.error?React.createElement("div",null,
            React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"‚ö†Ô∏è "+watchScanResult.error),
            watchScanResult.failed&&watchScanResult.failed.length>0&&React.createElement("div",{style:{marginTop:8}},watchScanResult.failed.map(function(e,i){return React.createElement("p",{key:i,style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",margin:"2px 0"}},"Image "+(e.fi+1)+": "+e.error)})),
            React.createElement("button",{onClick:function(){setWatchScanResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))
          :React.createElement("div",null,
            React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--good)",marginBottom:6}},"‚úÖ Added "+watchScanResult.count+" watch"+(watchScanResult.count>1?"es":"")+" to collection"),
            watchScanResult.watches&&watchScanResult.watches.map(function(s,i){return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"6px 0",borderTop:i?"1px solid var(--border)":"none"}},
              React.createElement("span",{style:{fontSize:16}},s.ai.emoji||"‚åö"),
              React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--text)"}},s.ai.brand+" "+s.ai.model),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},s.ai.dial_color||""))}),
            watchScanResult.failed&&watchScanResult.failed.length>0&&React.createElement("div",{style:{marginTop:8,padding:"6px 8px",background:"rgba(200,90,58,0.06)",borderRadius:6,border:"1px solid rgba(200,90,58,0.15)"}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},watchScanResult.failed.length+" failed"),
              watchScanResult.failed.map(function(e,i){return React.createElement("p",{key:i,style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",margin:"2px 0"}},"#"+(e.fi+1)+": "+e.error)})),
            React.createElement("button",{onClick:function(){setWatchScanResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))),
        filtW.length===0&&React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},"No watches match filter")),
        filtW.map(function(w){var st=STS.find(function(s){return s.id===w.status});return React.createElement("div",{key:w.id,className:"card-lift",style:{background:w.active?"var(--card)":"var(--bg)",border:"1px solid "+(w.active?"var(--border)":"var(--border)"),borderRadius:12,padding:"14px 16px",opacity:w.active?1:0.5,marginBottom:8}},
          React.createElement("div",{style:{display:"flex",gap:12,alignItems:"flex-start"}},
            React.createElement("div",{onClick:function(){toggleW(w.id)},style:{width:44,height:44,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.active?w.c+"20":"var(--card)",fontSize:20,flexShrink:0,cursor:"pointer",border:"2px solid "+(w.active?w.c+"60":"var(--border)"),overflow:"hidden"}},w.photoUrl?React.createElement("img",{src:ph(w.photoUrl),alt:"",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover"}}):w.i),
            React.createElement("div",{style:{flex:1,minWidth:0,cursor:"pointer"},onClick:function(){setEditW(w)}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:3}},
                React.createElement("span",{style:{fontSize:14,fontWeight:600,color:w.active?"var(--text)":"var(--dim)"}},w.n),
                !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px"}},"REP"),
                React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:w.c}}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:st?st.c:"var(--dim)"}},st?st.l:"")),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:4}},w.d+(w.size?" ¬∑ "+w.size:"")+(w.ref?" ¬∑ Ref "+w.ref:"")+" ¬∑ "+(w.straps&&w.straps.length?w.straps.map(function(s){var td=STRAP_TYPES.find(function(t){return t.id===s.type});return(td?td.icon:"")+s.type+(s.type!=="bracelet"&&s.color?" "+s.color:"")}).join(", "):w.br?"Bracelet":"Strap"+(w.sc&&w.sc.length?": "+w.sc.join(", "):""))+" ¬∑ "+w.mt+(w.movement?" ¬∑ "+w.movement:"")+(function(){var ds=daysSince(w.id);return ds<999?" ¬∑ "+(ds===0?"‚úî today":ds+"d ago"):""}())),
              React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},(w.cx||[]).map(function(c){return React.createElement("span",{key:c,style:{fontSize:8,fontFamily:"var(--f)",background:"var(--bg)",borderRadius:8,padding:"2px 6px",color:"var(--dim)"}},(CXI[c]||"")+c)}))),
            (function(){var isWorn=todayWorn&&todayWorn.watchId===w.id;return React.createElement("button",{onClick:function(e){e.stopPropagation();if(isWorn){undoWear(todayStr)}else{logWear(w.id,todayStr)}},style:{background:isWorn?"rgba(122,184,122,0.15)":"var(--bg)",border:"1px solid "+(isWorn?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:8,padding:"4px 8px",cursor:"pointer",color:isWorn?"var(--good)":"var(--dim)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,flexShrink:0,minHeight:26,marginRight:4}},isWorn?"‚úì Worn":"‚åö Wear")})(),
            React.createElement("button",{onClick:function(e){e.stopPropagation();toggleW(w.id)},style:{width:44,height:26,borderRadius:13,background:w.active?"var(--gold)":"var(--card2)",border:"none",cursor:"pointer",position:"relative",flexShrink:0,minHeight:26}},
              React.createElement("div",{style:{width:20,height:20,borderRadius:"50%",background:w.active?"var(--bg)":"var(--dim)",position:"absolute",top:3,left:w.active?21:3,transition:"left .2s"}}))))}),
        React.createElement("button",{onClick:function(){setConfirmDlg({msg:"Reset watches to defaults?",danger:true,onOk:function(){setW(DEFAULTS);ps("w_"+SK,DEFAULTS);setConfirmDlg(null)}})},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:40}},"Reset Defaults")),

      /* ‚ïê‚ïê‚ïê SAVED ‚ïê‚ïê‚ïê */
      view==="saved"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* List / Calendar toggle */
        saved.length>0&&React.createElement("div",{style:{display:"flex",gap:5,marginBottom:12}},
          React.createElement(Pill,{on:savedView==="list",onClick:function(){setSavedView("list")}},"üìã List"),
          React.createElement(Pill,{on:savedView==="calendar",onClick:function(){setSavedView("calendar")}},"üìÖ Calendar")),
        /* ‚ïê‚ïê CALENDAR VIEW ‚ïê‚ïê */
        savedView==="calendar"&&saved.length>0&&(function(){
          var now=new Date();var year=now.getFullYear();var month=now.getMonth();
          var firstDay=new Date(year,month,1).getDay();var daysInMonth=new Date(year,month+1,0).getDate();
          var monthName=now.toLocaleDateString(undefined,{month:"long",year:"numeric"});
          /* Build date ‚Üí outfits map */
          var dateMap={};saved.forEach(function(o){if(o.wearDate)dateMap[o.wearDate]=(dateMap[o.wearDate]||[]).concat([o])});
          var cells=[];for(var b=0;b<firstDay;b++)cells.push(null);
          for(var d=1;d<=daysInMonth;d++)cells.push(d);
          return React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"14px",marginBottom:16}},
            React.createElement("div",{style:{textAlign:"center",fontSize:14,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)",marginBottom:10}},monthName),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2,textAlign:"center",marginBottom:4}},
              ["S","M","T","W","T","F","S"].map(function(d2,i){return React.createElement("div",{key:i,style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",padding:4,fontWeight:600}},d2)})),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2}},
              cells.map(function(day,i){
                if(!day)return React.createElement("div",{key:"e"+i});
                var ds=year+"-"+String(month+1).padStart(2,"0")+"-"+String(day).padStart(2,"0");
                var outfits=dateMap[ds]||[];var isToday=ds===todayStr;
                return React.createElement("div",{key:i,style:{aspectRatio:"1",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",borderRadius:8,background:isToday?"rgba(201,168,76,0.12)":outfits.length?"rgba(122,184,122,0.08)":"transparent",border:"1px solid "+(isToday?"rgba(201,168,76,0.3)":outfits.length?"rgba(122,184,122,0.2)":"transparent"),cursor:outfits.length?"pointer":"default",position:"relative"},onClick:outfits.length?function(){setSavedView("list")}:undefined},
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:isToday?"var(--gold)":outfits.length?"var(--good)":"var(--dim)",fontWeight:isToday?700:400}},day),
                  outfits.length>0&&React.createElement("div",{style:{display:"flex",gap:1,marginTop:1}},
                    outfits.slice(0,3).map(function(o,j){
                      var w0=o.watches&&o.watches[0];
                      return React.createElement("span",{key:j,style:{fontSize:6}},w0?w0.i:"üëî")})))})));
        })(),
        /* ‚ïê‚ïê LIST VIEW ‚ïê‚ïê */
        !saved.length?React.createElement("div",{style:{textAlign:"center",padding:"50px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"üìã"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},"No saved outfits"))
        :savedView!=="calendar"&&function(){
      var todayISO=new Date().toISOString().slice(0,10);
      return saved.slice().sort(function(a,b){
        var aIsToday=a.wearDate===todayISO?1:0;
        var bIsToday=b.wearDate===todayISO?1:0;
        if(aIsToday!==bIsToday)return bIsToday-aIsToday;
        var aHasDate=a.wearDate?1:0;
        var bHasDate=b.wearDate?1:0;
        if(aHasDate!==bHasDate)return bHasDate-aHasDate;
        if(aHasDate&&bHasDate)return a.wearDate<b.wearDate?-1:a.wearDate>b.wearDate?1:0;
        return (b.ts||0)-(a.ts||0);
      });
    }().map(function(o){var oTop=o.items?o.items.find(function(i){return catOf(i.garmentType)==="tops"}):null;var oBot=o.items?o.items.find(function(i){return catOf(i.garmentType)==="bottoms"}):null;var oSh=o.items?o.items.find(function(i){return catOf(i.garmentType)==="shoes"}):null;return React.createElement("div",{key:o.id,className:"card-lift",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:10,marginBottom:8}},
            React.createElement(OutfitFigure,{topColor:oTop?oTop.color:"grey",botColor:oBot?oBot.color:"charcoal",shoeColor:oSh?oSh.color:"black",watchColor:o.watches&&o.watches[0]?o.watches[0].c:"#c9a84c",watchIcon:o.watches&&o.watches[0]?o.watches[0].i:"‚åö",watchName:"",size:60}),
            React.createElement("div",{style:{flex:1,minWidth:0}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}},
                React.createElement("div",null,React.createElement("h3",{style:{fontSize:14,fontWeight:500,margin:"0 0 2px"}},o.name),React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",margin:0}},(activeCxIcons[o.context]||"")+" "+o.context+" ¬∑ "+new Date(o.ts).toLocaleDateString()+(o.fs?" ¬∑ Score "+o.fs:"")),o.weather&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"1px 6px",border:"1px solid rgba(100,150,220,0.15)",marginTop:2,display:"inline-block"}},(o.weather.cond?o.weather.cond.i:"")+" "+o.weather.temp+"¬∞C")),
                React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end"}},
                  navigator.share&&React.createElement("button",{onClick:function(ev){ev.stopPropagation();var parts=[];if(o.watches&&o.watches.length)parts.push("‚åö "+o.watches.map(function(w){return w.n}).join(", "));(o.items||[]).forEach(function(item){parts.push(item.name||item.color)});var text=o.name+"\n"+(activeCxIcons[o.context]||"")+" "+o.context+(o.fs?" ¬∑ Score "+o.fs:"")+"\n\n"+parts.join("\n");navigator.share({title:o.name,text:text}).catch(function(){})},style:{background:"none",border:"1px solid rgba(122,184,216,0.3)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"#7ab8d8",fontFamily:"var(--f)",fontSize:10,minHeight:30}},"üì§"),
                  React.createElement("button",{onClick:function(){delSaved(o.id)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:10,minHeight:30}},"‚úï"),
                  /* ‚ïê‚ïê‚ïê WEAR DATE BUTTON ‚ïê‚ïê‚ïê */
                    o.wearDate&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",fontWeight:600,padding:"2px 7px",borderRadius:4,color:o.wearDate===new Date().toISOString().slice(0,10)?"var(--good)":"var(--gold)",background:o.wearDate===new Date().toISOString().slice(0,10)?"rgba(122,184,122,0.12)":"rgba(201,168,76,0.1)",border:"1px solid "+(o.wearDate===new Date().toISOString().slice(0,10)?"rgba(122,184,122,0.25)":"rgba(201,168,76,0.2)")}},o.wearDate===new Date().toISOString().slice(0,10)?"üëî Wearing Today":"üìå "+new Date(o.wearDate+"T12:00").toLocaleDateString(undefined,{month:"short",day:"numeric"})),
                    React.createElement("button",{onClick:function(ev){ev.stopPropagation();setWearPicker(wearPicker===o.id?null:o.id)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"5px 9px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:26}},o.wearDate?"‚úé Change":"üëî Wear"),
                    wearPicker===o.id&&React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,padding:"8px 10px",background:"var(--card)",border:"1px solid var(--gold)",borderRadius:8,marginTop:2,boxShadow:"0 4px 16px rgba(0,0,0,0.15)"}},
                      React.createElement("button",{onClick:function(){setOutfitWear(o.id,new Date().toISOString().slice(0,10))},style:{background:"rgba(122,184,122,0.12)",border:"1px solid rgba(122,184,122,0.25)",borderRadius:6,padding:"6px 12px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:10,fontWeight:600}},"üëî Today"),
                      React.createElement("label",{style:{display:"flex",alignItems:"center",gap:6}},React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},"Pick:"),React.createElement("input",{type:"date",defaultValue:o.wearDate||"",onChange:function(ev){if(ev.target.value)setOutfitWear(o.id,ev.target.value)},style:{fontSize:10,fontFamily:"var(--f)",background:"var(--bg)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:4,padding:"4px 6px"}})),
                      o.wearDate&&React.createElement("button",{onClick:function(){setOutfitWear(o.id,null)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:9}},"‚úï Clear date")),
                  /* Weather match badge */
                  weather&&o.weather&&(function(){var ct=weather.temp||18,ot=o.weather.temp||18,diff=Math.abs(ct-ot);var cRain=weather.cond&&weather.cond.rain,oRain=o.weather.cond&&o.weather.cond.rain;var match=diff<=5&&cRain===oRain?"great":diff<=10?"ok":"poor";return React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,color:match==="great"?"var(--good)":match==="ok"?"var(--gold)":"var(--warn)",background:match==="great"?"rgba(122,184,122,0.1)":match==="ok"?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",border:"1px solid "+(match==="great"?"rgba(122,184,122,0.2)":match==="ok"?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},match==="great"?"‚úì Today match":match==="ok"?"~ Similar wx":"‚úó Diff weather")})())))),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}},(o.items||[]).map(function(item,i){return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},item.photoUrl&&React.createElement("img",{src:ph(item.photoUrl),alt:"",decoding:"async",style:{width:20,height:20,objectFit:"cover",borderRadius:3}}),React.createElement(Dot,{color:item.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},item.name||item.color))})),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},(o.watches||[]).slice(0,3).map(function(w,i){return React.createElement("div",{key:w.id||i,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:i===0?"1px solid rgba(201,168,76,0.2)":"1px solid var(--border)"}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"var(--sub)"}},w.n))})))})))
  );
}
ReactDOM.render(React.createElement(ErrorBoundary,null,React.createElement(App)),document.getElementById("root"));
</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(function(e){console.warn('[WA] SW:',e)})}
</script>
</body>
</html>
