<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#c9a84c">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Watch Advisor</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#07060a;--card:#0d0c14;--card2:#12101a;--card3:#14121e;--border:#1c1828;--gold:#c9a84c;--text:#e0dcd4;--sub:#7a7484;--dim:#4a4458;--warn:#c85a3a;--good:#7ab87a;--f:'DM Sans',sans-serif;--sf:'Cormorant Garamond',Georgia,serif}
html,body{background:var(--bg);color:var(--text);font-family:var(--sf);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body.modal-open{overflow:hidden;position:fixed;width:100%;touch-action:none}
/* Safety: ensure modal class gets cleaned up */
body:not(.modal-open){position:static!important;touch-action:auto!important}
input,select,button,textarea{font-family:var(--f);outline:none}
input[type="file"]{display:none}
input,select,textarea{font-size:16px!important}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
.fu{animation:fadeUp .3s ease both}.sp{animation:spin 1s linear infinite}.pu{animation:pulse 1.5s ease infinite}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#2a2530;border-radius:4px}
.hscroll{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}.hscroll::-webkit-scrollbar{display:none}
.chip{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:12px;font-size:11px;font-family:var(--f);cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--sub);white-space:nowrap;transition:all .15s;min-height:32px;touch-action:manipulation;user-select:none}
.chip.on{background:rgba(201,168,76,0.1);border-color:rgba(201,168,76,0.3);color:var(--gold)}
.chip:active{transform:scale(0.95)}
.inp{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.inp:focus{border-color:rgba(201,168,76,0.4)}
.sel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.lbl{font-size:9px;font-family:var(--f);color:var(--dim);letter-spacing:0.1em;margin-bottom:4px;display:block;text-transform:uppercase}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;display:flex;flex-direction:column;justify-content:flex-end;animation:fadeIn .15s ease}
.modal-body{background:var(--card);border-radius:20px 20px 0 0;padding:20px 20px max(env(safe-area-inset-bottom,20px),20px);max-height:92vh;overflow-y:auto;animation:slideUp .25s ease}
.modal-handle{width:36px;height:4px;background:#2a2530;border-radius:4px;margin:0 auto 14px}
.swatch{width:34px;height:34px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;flex-shrink:0;touch-action:manipulation}
.swatch:active{transform:scale(0.9)}
.swatch.on{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,0.3)}
.btn{border:none;border-radius:10px;padding:14px;cursor:pointer;font-family:var(--f);font-size:14px;font-weight:600;width:100%;text-align:center;min-height:48px;touch-action:manipulation;user-select:none;transition:all .15s}
.btn:active{transform:scale(0.98)}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8882a);color:var(--bg)}
.btn-gold:hover:not(:disabled){background:linear-gradient(135deg,#d4b85c,#b8982a)}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--sub)}
.btn-ghost:hover:not(:disabled){background:rgba(201,168,76,0.05);border-color:rgba(201,168,76,0.3)}
.outfit-slot{background:var(--bg);border:2px dashed var(--border);border-radius:12px;padding:10px;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all .2s}
.outfit-slot.filled{border-style:solid;border-color:var(--border)}
.outfit-slot.active{border-color:var(--gold);background:#0a0918}
.score-bar{height:5px;border-radius:3px;background:#1a1828;overflow:hidden}
.score-fill{height:100%;border-radius:3px;transition:width .4s ease}
.card-lift{box-shadow:0 2px 8px rgba(0,0,0,0.25);transition:all .15s;touch-action:manipulation}
.card-lift:active{transform:scale(0.98);box-shadow:0 1px 4px rgba(0,0,0,0.2)}
.gcard{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;transition:all .15s;touch-action:manipulation}
.gcard:active{transform:scale(0.97)}
.gcard-overlay{position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,0.7));pointer-events:none}
.dots-row{display:flex;gap:3px;align-items:center}
.onboard{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
.onboard h1{font-size:32px;font-weight:300;letter-spacing:0.2em;color:var(--gold);margin-bottom:8px}
/* â”€â”€ DARK/LIGHT MODE â”€â”€ */
[data-theme="light"]{--bg:#f4f2ee;--card:#ffffff;--card2:#f8f6f2;--card3:#f0ede7;--border:#ddd8d0;--gold:#a8882a;--text:#1a1814;--sub:#6a6458;--dim:#9a9488;--warn:#c85a3a;--good:#4a8a4a}
[data-theme="light"] .swatch{border-color:#ddd8d0}
[data-theme="light"] ::-webkit-scrollbar-thumb{background:#d0c8b8}
/* â”€â”€ OFFLINE BANNER â”€â”€ */
.offline-banner{position:fixed;top:0;left:0;right:0;background:#c85a3a;color:white;text-align:center;padding:6px;font-family:var(--f);font-size:11px;font-weight:600;z-index:200;display:none;letter-spacing:0.05em}
/* â”€â”€ RADAR / STYLE DNA â”€â”€ */
.radar-wrap{display:flex;justify-content:center;padding:12px 0}
.dna-legend{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;font-size:11px;font-family:var(--f);color:var(--sub)}
.dna-legend span{display:flex;align-items:center;gap:4px}
.dna-legend .ldot{width:8px;height:8px;border-radius:50%;background:var(--gold)}
/* â”€â”€ COLOR PALETTE â”€â”€ */
.color-palette-row{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.color-swatch-sm{width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.1)}
.harmony-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;font-size:10px;font-family:var(--f);font-weight:600;background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.2)}
/* â”€â”€ BATCH UPLOAD â”€â”€ */
.batch-zone{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;margin:12px 0}
.batch-zone:hover,.batch-zone.dragover{border-color:var(--gold);background:rgba(201,168,76,0.05)}
.batch-prog{margin:8px 0;display:none}
.batch-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.batch-fill{height:100%;background:var(--gold);border-radius:2px;transition:width .3s}
/* â”€â”€ DUPLICATE DETECTION â”€â”€ */
.dup-group{background:var(--card2);border-radius:10px;padding:10px;margin-bottom:8px;border:1px solid rgba(200,90,58,0.2)}
.dup-badge{font-size:9px;font-family:var(--f);background:rgba(200,90,58,0.15);color:var(--warn);padding:2px 8px;border-radius:6px;font-weight:600}
/* â”€â”€ FAVORITES â”€â”€ */
.fav-btn{position:absolute;top:6px;right:6px;background:none;border:none;font-size:18px;cursor:pointer;opacity:0.4;transition:all .15s;z-index:2;touch-action:manipulation}
.fav-btn.active{opacity:1}
.fav-btn:active{transform:scale(1.2)}
/* â”€â”€ PROFILE â”€â”€ */
.profile-card{background:var(--card2);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;border:1px solid var(--border);margin-bottom:12px}
.profile-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#a8882a);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:var(--bg);flex-shrink:0}
/* â”€â”€ DAILY TIP â”€â”€ */
.tip-card{background:linear-gradient(135deg,rgba(201,168,76,0.08),rgba(201,168,76,0.03));border:1px solid rgba(201,168,76,0.15);border-radius:12px;padding:12px 14px;margin-bottom:12px;display:flex;gap:10px;align-items:flex-start}
.tip-icon{font-size:20px;flex-shrink:0;line-height:1}
.tip-text{font-family:var(--f);font-size:12px;color:var(--sub);line-height:1.5;font-style:italic}
/* â”€â”€ OOTD BANNER â”€â”€ */
.ootd-banner{background:linear-gradient(135deg,rgba(201,168,76,0.12),rgba(201,168,76,0.04));border:1px solid rgba(201,168,76,0.2);border-radius:14px;padding:14px 16px;margin-bottom:14px;cursor:pointer;transition:all .15s}
.ootd-banner:active{transform:scale(0.98)}
.ootd-label{font-size:9px;font-family:var(--f);letter-spacing:0.12em;color:var(--gold);text-transform:uppercase;margin-bottom:4px}
.ootd-name{font-size:15px;font-weight:600;margin-bottom:2px}
.ootd-items{font-size:11px;font-family:var(--f);color:var(--sub)}
/* â”€â”€ COMPOSITE â”€â”€ */
.composite-wrap{margin:10px 0;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.composite-wrap canvas{width:100%;display:block}
/* â”€â”€ LOCATION VIBES â”€â”€ */
.loc-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.loc-chip{padding:5px 10px;border-radius:8px;font-size:10px;font-family:var(--f);cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--sub);transition:all .15s;user-select:none}
.loc-chip.on{background:rgba(201,168,76,0.1);border-color:rgba(201,168,76,0.3);color:var(--gold)}
.loc-chip:active{transform:scale(0.95)}
</style>
</head>
<body>
<div class="offline-banner" id="offlineBanner">You're offline â€” changes saved locally</div>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useRef,useMemo,useEffect,useCallback,memo}=React;

/* â•â•â•â•â•â• CONFIG â•â•â•â•â•â• */
/* Set IS_SHARED=true to create a version for friends (empty collection, onboarding) */
const IS_SHARED=false;
const SK="v13"; /* storage key suffix â€” change to reset data */

/* â•â•â•â•â•â• DATA â•â•â•â•â•â• */
const CM={
"black":{h:"#1a1a1a",t:"cool"},"white":{h:"#f0f0ec",t:"neutral"},"cream":{h:"#f5f0e0",t:"warm"},
"ivory":{h:"#f8f4ea",t:"warm"},"grey":{h:"#8a8a8a",t:"cool"},"light grey":{h:"#c0c0c0",t:"cool"},
"charcoal":{h:"#3a3a3a",t:"cool"},"navy":{h:"#1a2a4a",t:"cool"},"blue":{h:"#2a5a9a",t:"cool"},
"light blue":{h:"#7ab0d8",t:"cool"},"cobalt":{h:"#0047AB",t:"cool"},"teal":{h:"#1a8a7a",t:"cool"},
"turquoise":{h:"#2ab8a8",t:"cool"},"green":{h:"#2a6a3a",t:"cool"},"forest green":{h:"#1a4a2a",t:"cool"},
"olive":{h:"#5a6a3a",t:"warm"},"sage":{h:"#8aaa7a",t:"cool"},"red":{h:"#b83a3a",t:"warm"},
"burgundy":{h:"#6a1a2a",t:"warm"},"wine":{h:"#5a1a2a",t:"warm"},"plum":{h:"#6a2a5a",t:"warm"},
"pink":{h:"#d88a9a",t:"warm"},"orange":{h:"#d87a2a",t:"warm"},"burnt orange":{h:"#b85a2a",t:"warm"},
"yellow":{h:"#d4b82a",t:"warm"},"brown":{h:"#6a4a2a",t:"warm"},"tan":{h:"#c8a878",t:"warm"},
"camel":{h:"#c8a060",t:"warm"},"chocolate":{h:"#3a2a1a",t:"warm"},"khaki":{h:"#b8a878",t:"warm"},
"beige":{h:"#d8c8a8",t:"warm"},"lavender":{h:"#9a8abc",t:"cool"},"purple":{h:"#5a2a7a",t:"cool"},
"denim":{h:"#4a6a8a",t:"cool"},"dark brown":{h:"#4a3020",t:"warm"},"rust":{h:"#a84a2a",t:"warm"},
"sand":{h:"#c8b898",t:"warm"},"mint":{h:"#7ac8a8",t:"cool"},"slate":{h:"#6a7a8a",t:"cool"},
"gold":{h:"#c9a84c",t:"warm"},"mauve":{h:"#a07888",t:"warm"},"silver":{h:"#b0b0b0",t:"cool"},
};
const AC=Object.keys(CM);
const CG=[
{l:"Neutrals",c:["black","charcoal","grey","light grey","silver","slate","white","cream","ivory","beige","sand"]},
{l:"Blues",c:["navy","cobalt","blue","light blue","denim","teal","turquoise","mint"]},
{l:"Greens",c:["forest green","green","olive","sage"]},
{l:"Reds",c:["burgundy","wine","red","rust","burnt orange","orange"]},
{l:"Warm",c:["brown","dark brown","chocolate","tan","camel","khaki","gold","yellow"]},
{l:"Others",c:["plum","purple","lavender","mauve","pink"]},
];
const PATTERNS=["solid","plaid","striped","checked","print","textured"];
const MATERIALS=["cotton","linen","wool","cashmere","silk","denim","chino","suede","leather","canvas","synthetic","knit","tweed","corduroy","fleece","nylon"];
function smartDefaults(ai){
  var d={};var gt=ai.garmentType;var nm=(ai.name||"").toLowerCase();
  /* Material inference */
  if(gt==="Jeans")d.material="denim";
  else if(gt==="Sweater/Knit")d.material="knit";
  else if(gt==="Chinos")d.material="chino";
  else if(nm.includes("suede"))d.material="suede";
  else if(nm.includes("linen"))d.material="linen";
  else if(nm.includes("leather"))d.material="leather";
  else if(nm.includes("canvas"))d.material="canvas";
  else if(nm.includes("corduroy"))d.material="corduroy";
  else if(nm.includes("tweed"))d.material="tweed";
  else if(nm.includes("silk"))d.material="silk";
  else if(nm.includes("wool"))d.material="wool";
  else if(nm.includes("cashmere"))d.material="cashmere";
  else if(nm.includes("fleece"))d.material="fleece";
  else if(nm.includes("denim"))d.material="denim";
  /* Seasons inference */
  if(gt==="Shorts")d.seasons=["spring","summer"];
  else if(gt==="Sweater/Knit"||gt==="Jacket/Blazer")d.seasons=["fall","winter"];
  else if(gt==="Jeans")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="Shoes"){d.seasons=["spring","summer","fall","winter"];if(nm.includes("sandal")||nm.includes("espadrille")||nm.includes("flip"))d.seasons=["spring","summer"];else if(nm.includes("boot"))d.seasons=["fall","winter"]}
  else if(gt==="Chinos"||gt==="Pants/Trousers")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="T-Shirt"||gt==="Polo")d.seasons=["spring","summer"];
  else d.seasons=["spring","summer","fall","winter"];
  /* Refine seasons based on inferred material */
  if(d.material==="wool"||d.material==="cashmere"||d.material==="fleece"||d.material==="tweed"||d.material==="corduroy")d.seasons=["fall","winter"];
  else if(d.material==="linen")d.seasons=["spring","summer"];
  return d;
}
const DEFAULT_CX=[
{id:"clinic",l:"Clinic",icon:"ðŸ¥"},{id:"smart-casual",l:"Smart Casual",icon:"ðŸ‘”"},{id:"formal",l:"Formal",icon:"ðŸŽ©"},
{id:"date",l:"Date",icon:"ðŸŒ¹"},{id:"riviera",l:"Riviera",icon:"ðŸŒŠ"},{id:"casual",l:"Casual",icon:"â˜€ï¸"},
{id:"weekend",l:"Weekend",icon:"ðŸ›’"},{id:"flex",l:"Flex",icon:"ðŸ’Ž"},{id:"travel",l:"Travel",icon:"âœˆï¸"},{id:"event",l:"Event",icon:"ðŸŽ­"}];
const SHARE_DEFAULT_CX=[
{id:"office",l:"Office",icon:"ðŸ’¼"},{id:"smart-casual",l:"Smart Casual",icon:"ðŸ‘”"},{id:"formal",l:"Formal",icon:"ðŸŽ©"},
{id:"date",l:"Date",icon:"ðŸŒ¹"},{id:"riviera",l:"Riviera",icon:"ðŸŒŠ"},{id:"casual",l:"Casual",icon:"â˜€ï¸"},
{id:"weekend",l:"Weekend",icon:"ðŸ›’"},{id:"flex",l:"Flex",icon:"ðŸ’Ž"},{id:"travel",l:"Travel",icon:"âœˆï¸"},{id:"event",l:"Event",icon:"ðŸŽ­"}];
var ALL_CX=DEFAULT_CX.map(function(c){return c.id});
var CXI={};DEFAULT_CX.forEach(function(c){CXI[c.id]=c.icon});
const CATS={tops:["Shirt","Polo","T-Shirt","Sweater/Knit","Jacket/Blazer"],bottoms:["Pants/Trousers","Chinos","Jeans","Shorts"],shoes:["Shoes"]};
const ALL_T=[...CATS.tops,...CATS.bottoms,...CATS.shoes];
const catOf=g=>CATS.tops.includes(g)?"tops":CATS.bottoms.includes(g)?"bottoms":CATS.shoes.includes(g)?"shoes":"other";

/* â•â•â• DAILY STYLE TIPS â•â•â• */
const DAILY_TIPS=[
"Fit is king â€” a $30 shirt that fits perfectly beats a $300 one that doesn't.",
"The 3-color rule: stick to max 3 main colors in any outfit for visual coherence.",
"Invest in shoe care â€” polished shoes elevate even a casual look.",
"Layer strategically: thin inner layers, medium mid layers, structured outer layers.",
"Your watch should match the occasion. Dress watch for formal, sport for active.",
"Monochrome outfits with texture variation look effortlessly sophisticated.",
"Balance proportions: slim top + wider bottom OR structured top + slim bottom.",
"Invest in quality basics â€” they're the foundation every great outfit is built on.",
"Check weather before dressing â€” layers you can remove beat being stuck overdressed.",
"Your strap must match your shoe leather. Brown to brown. Black to black. Always.",
"Dress for the occasion, not your mood. Context always beats comfort alone.",
"Declutter quarterly â€” if you haven't worn it in 6 months, it's dead weight.",
"Find a good tailor â€” alterations transform off-the-rack into bespoke-looking fits.",
"Understand your color season â€” warm or cool tones make a bigger difference than you think.",
"Photograph your outfits â€” you'll spot patterns and mistakes you'd never notice in a mirror.",
"Grooming is 50% of the outfit. Fresh haircut + clean nails multiply everything.",
"Build a capsule wardrobe: 30 versatile pieces beat 100 random ones every time.",
"Develop a signature piece â€” one item people associate with you creates lasting impression.",
"Dark colors are forgiving, but light colors in summer project confidence and ease.",
"Replicas fill statement-piece slots. Genuines build horological credibility. Deploy strategically.",
"A great watch on the wrong strap is like a tailored suit with cheap shoes."
];
const TIP_ICONS=['ðŸ’¡','ðŸ‘”','âœ¨','ðŸŽ¯','âŒš','ðŸ”¥','ðŸ“','ðŸ§±','ðŸŒ¤ï¸','ðŸ‘ž','ðŸŽª','ðŸ—‘ï¸','âœ‚ï¸','ðŸŽ¨','ðŸ“¸','ðŸ’‡','ðŸ“¦','ðŸ·ï¸','ðŸ–¤','âŒš','ðŸª¡'];

/* â•â•â• LOCATION VIBES â•â•â• */
const LOC_VIBES={
"ðŸ¥ Clinic":["clinic"],"ðŸ½ï¸ Restaurant":["smart-casual","date-night"],"ðŸ–ï¸ Beach":["weekend","casual"],
"ðŸŒ† City":["smart-casual"],"ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Family":["casual","weekend"],"ðŸ•Œ Religious":["formal","smart-casual"],
"ðŸ’¼ Meeting":["formal","clinic"],"âœˆï¸ Travel":["casual","weekend"]
};

/* â•â•â• STYLE DNA DIMENSIONS â•â•â• */
const DNA_DIMS=["Boldness","Versatility","Formality","Creativity","Consistency"];
const CX_DNA={
"clinic":{Boldness:3,Versatility:5,Formality:7,Creativity:2,Consistency:8},
"formal":{Boldness:5,Versatility:4,Formality:9,Creativity:3,Consistency:7},
"smart-casual":{Boldness:5,Versatility:7,Formality:5,Creativity:5,Consistency:6},
"casual":{Boldness:3,Versatility:7,Formality:2,Creativity:4,Consistency:5},
"weekend":{Boldness:4,Versatility:6,Formality:2,Creativity:5,Consistency:4},
"date-night":{Boldness:7,Versatility:5,Formality:6,Creativity:7,Consistency:5},
"riviera":{Boldness:7,Versatility:6,Formality:4,Creativity:8,Consistency:4},
"sporty":{Boldness:4,Versatility:6,Formality:1,Creativity:3,Consistency:6}
};

/* â•â•â• COLOR HARMONY â•â•â• */
function hexToHsl(hex){var m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!m)return null;var r=parseInt(m[1],16)/255,g=parseInt(m[2],16)/255,b=parseInt(m[3],16)/255;var mx=Math.max(r,g,b),mn=Math.min(r,g,b),h=0,s=0,l=(mx+mn)/2;if(mx!==mn){var d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);if(mx===r)h=((g-b)/d+(g<b?6:0))*60;else if(mx===g)h=((b-r)/d+2)*60;else h=((r-g)/d+4)*60}return{h:Math.round(h),s:Math.round(s*100),l:Math.round(l*100)}}
function classifyHarmony(colors){var hsls=colors.map(function(c){var e=Object.entries(CM).find(function(x){return c.toLowerCase().includes(x[0])});return e?hexToHsl(e[1].h):null}).filter(Boolean);if(hsls.length<2)return{type:"Neutral",icon:"âšª"};var hues=hsls.filter(function(h){return h.s>10}).map(function(h){return h.h});if(hues.length<2)return{type:"Neutral",icon:"âšª"};var maxD=0;for(var i=0;i<hues.length;i++)for(var j=i+1;j<hues.length;j++){var d=Math.abs(hues[i]-hues[j]);maxD=Math.max(maxD,Math.min(d,360-d))}if(maxD<30)return{type:"Monochrome",icon:"ðŸŽ¯"};if(maxD<60)return{type:"Analogous",icon:"ðŸŒŠ"};if(maxD>150&&maxD<210)return{type:"Complementary",icon:"âš¡"};if(hues.length>=3){var sorted=hues.slice().sort(function(a,b){return a-b});var avgGap=360/sorted.length;var triadic=sorted.every(function(h,i){var gap=(sorted[(i+1)%sorted.length]-h+360)%360;return Math.abs(gap-avgGap)<40});if(triadic)return{type:"Triadic",icon:"ðŸ”º"}}return{type:"Eclectic",icon:"ðŸŽ¨"}}

/* â•â•â• IndexedDB BACKUP â•â•â• */
var _idb=null;
function initIDB(){if(!window.indexedDB)return Promise.resolve();return new Promise(function(resolve){var req=indexedDB.open("WatchAdvisorDB",1);req.onupgradeneeded=function(e){var db=e.target.result;if(!db.objectStoreNames.contains("appData"))db.createObjectStore("appData",{keyPath:"key"})};req.onsuccess=function(e){_idb=e.target.result;resolve()};req.onerror=function(){resolve()}})}
function backupToIDB(data){if(!_idb)return;try{var tx=_idb.transaction("appData","readwrite");tx.objectStore("appData").put(Object.assign({key:"backup",timestamp:Date.now()},data))}catch(e){console.warn("IDB backup failed",e)}}
function restoreFromIDB(){if(!_idb)return Promise.resolve(null);return new Promise(function(resolve){try{var tx=_idb.transaction("appData","readonly");var req=tx.objectStore("appData").get("backup");req.onsuccess=function(){resolve(req.result||null)};req.onerror=function(){resolve(null)}}catch(e){resolve(null)}})}

/* â•â•â• DUPLICATE DETECTION â•â•â• */
function findDuplicates(wardrobe){var groups=[];var checked=new Set();for(var i=0;i<wardrobe.length;i++){if(checked.has(i))continue;var dupes=[i];for(var j=i+1;j<wardrobe.length;j++){if(checked.has(j))continue;if(isSimilarItem(wardrobe[i],wardrobe[j])){dupes.push(j);checked.add(j)}}if(dupes.length>1){groups.push(dupes);dupes.forEach(function(d){checked.add(d)})}}return groups}
function isSimilarItem(a,b){if(a.garmentType!==b.garmentType)return false;var na=(a.name||"").toLowerCase(),nb=(b.name||"").toLowerCase();if(na&&nb&&(na===nb||na.includes(nb)||nb.includes(na)))return true;if(a.color&&b.color&&a.color===b.color&&a.garmentType===b.garmentType){var wa=na.split(/\s+/),wb=nb.split(/\s+/);var overlap=wa.filter(function(w){return wb.includes(w)}).length;if(overlap>0)return true}return false}

const EMOJIS=["âŒš","â„ï¸","ðŸŒ¿","ðŸª·","ðŸ”·","ðŸŒ™","ðŸ’Ž","ðŸ‘‘","ðŸ”´","ðŸ","â­","ðŸŒ","âœˆï¸","ðŸ§­","ðŸ›©ï¸","ðŸ€","ðŸ”µ","ðŸŒŠ","ðŸ·","â—»ï¸","ðŸ”ï¸","ðŸŸ¢","â˜„ï¸","ðŸ’ ","ðŸŒ»","âš«","ðŸ”¥","ðŸ’œ"];
const STS=[{id:"active",l:"Active",c:"var(--good)"},{id:"incoming",l:"Incoming",c:"#7ab8d8"},{id:"pending-trade",l:"Pending",c:"var(--warn)"},{id:"sold",l:"Sold",c:"var(--dim)"},{id:"service",l:"Service",c:"#b87ab8"}];
const WT_TIERS=[
{max:5,label:"Freezing",icon:"ðŸ¥¶",weight:"heavy",advice:"Heavy layers. Leather straps stay warm."},
{max:12,label:"Cold",icon:"ðŸ§¥",weight:"heavy",advice:"Layer up: jacket + sweater."},
{max:18,label:"Cool",icon:"ðŸ§£",weight:"mid",advice:"Light jacket or sweater."},
{max:24,label:"Mild",icon:"ðŸ‘”",weight:"mid",advice:"Shirt sleeves or light knit."},
{max:30,label:"Warm",icon:"â˜€ï¸",weight:"light",advice:"Light fabrics. Bracelets > leather."},
{max:50,label:"Hot",icon:"ðŸ”¥",weight:"light",advice:"Steel bracelets only."},
];
const getWT=t=>WT_TIERS.find(x=>t<=x.max)||WT_TIERS[5];
/* WMO Weather Code decoder */
const WMO={0:{i:"â˜€ï¸",l:"Clear",rain:false},1:{i:"ðŸŒ¤ï¸",l:"Mostly Clear",rain:false},2:{i:"â›…",l:"Partly Cloudy",rain:false},3:{i:"â˜ï¸",l:"Overcast",rain:false},
45:{i:"ðŸŒ«ï¸",l:"Fog",rain:false},48:{i:"ðŸŒ«ï¸",l:"Rime Fog",rain:false},
51:{i:"ðŸŒ¦ï¸",l:"Light Drizzle",rain:true},53:{i:"ðŸŒ¦ï¸",l:"Drizzle",rain:true},55:{i:"ðŸŒ§ï¸",l:"Heavy Drizzle",rain:true},
56:{i:"ðŸŒ§ï¸",l:"Freezing Drizzle",rain:true},57:{i:"ðŸŒ§ï¸",l:"Heavy Frzg Drizzle",rain:true},
61:{i:"ðŸŒ¦ï¸",l:"Light Rain",rain:true},63:{i:"ðŸŒ§ï¸",l:"Rain",rain:true},65:{i:"ðŸŒ§ï¸",l:"Heavy Rain",rain:true},
66:{i:"ðŸ§Š",l:"Freezing Rain",rain:true},67:{i:"ðŸ§Š",l:"Heavy Frzg Rain",rain:true},
71:{i:"ðŸŒ¨ï¸",l:"Light Snow",rain:false},73:{i:"ðŸŒ¨ï¸",l:"Snow",rain:false},75:{i:"â„ï¸",l:"Heavy Snow",rain:false},
77:{i:"ðŸŒ¨ï¸",l:"Snow Grains",rain:false},
80:{i:"ðŸŒ¦ï¸",l:"Light Showers",rain:true},81:{i:"ðŸŒ§ï¸",l:"Showers",rain:true},82:{i:"â›ˆï¸",l:"Heavy Showers",rain:true},
85:{i:"ðŸŒ¨ï¸",l:"Snow Showers",rain:false},86:{i:"â„ï¸",l:"Heavy Snow Showers",rain:false},
95:{i:"â›ˆï¸",l:"Thunderstorm",rain:true},96:{i:"â›ˆï¸",l:"T-Storm + Hail",rain:true},99:{i:"â›ˆï¸",l:"T-Storm + Heavy Hail",rain:true}};
const getWMO=c=>WMO[c]||{i:"â“",l:"Unknown",rain:false};

/* â•â•â•â•â•â• SHARED MODE PRESETS â•â•â•â•â•â• */
const WATCH_PRESETS=[
{id:"p-aw",n:"Apple Watch",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"âŒš",mc:["black","grey","navy","white","charcoal"],ac:[],cx:["casual","weekend","clinic","travel"],wt:["light","mid","heavy"]},
{id:"p-gshock",n:"G-Shock",d:"Black",c:"#2a2a2a",br:true,sc:[],mt:"cool",i:"ðŸ’ª",mc:["black","olive","navy","grey","khaki"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
{id:"p-seiko5",n:"Seiko 5",d:"Blue",c:"#2a5a9a",br:true,sc:[],mt:"cool",i:"ðŸ”µ",mc:["navy","white","cream","grey","light blue"],ac:[],cx:["casual","smart-casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-sub",n:"Submariner-style",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"ðŸ¤¿",mc:["black","navy","white","grey","olive"],ac:[],cx:["casual","smart-casual","weekend","riviera","travel"],wt:["light","mid","heavy"]},
{id:"p-tank",n:"Tank-style",d:"White",c:"#f0f0ec",br:false,sc:["black"],mt:"cool",i:"ðŸ›ï¸",mc:["white","charcoal","navy","cream","black"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-chrono",n:"Chronograph",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"â±ï¸",mc:["black","navy","white","grey","charcoal"],ac:[],cx:["smart-casual","casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-dress",n:"Dress Watch",d:"White",c:"#f5f0e8",br:false,sc:["brown"],mt:"warm",i:"ðŸ‘”",mc:["cream","white","charcoal","navy","tan","burgundy"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-field",n:"Field Watch",d:"Green",c:"#3a5a3a",br:false,sc:["brown","olive"],mt:"cool",i:"ðŸ§­",mc:["olive","khaki","cream","brown","tan","navy"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
];
const GARMENT_PRESETS=[
{garmentType:"Shirt",name:"White Shirt",color:"white",pattern:"solid"},
{garmentType:"Shirt",name:"Light Blue Shirt",color:"light blue",pattern:"solid"},
{garmentType:"T-Shirt",name:"Black T-Shirt",color:"black",pattern:"solid"},
{garmentType:"T-Shirt",name:"Grey T-Shirt",color:"grey",pattern:"solid"},
{garmentType:"T-Shirt",name:"Navy T-Shirt",color:"navy",pattern:"solid"},
{garmentType:"T-Shirt",name:"White T-Shirt",color:"white",pattern:"solid"},
{garmentType:"Chinos",name:"Navy Chinos",color:"navy",pattern:"solid"},
{garmentType:"Chinos",name:"Khaki Chinos",color:"khaki",pattern:"solid"},
{garmentType:"Chinos",name:"Charcoal Chinos",color:"charcoal",pattern:"solid"},
{garmentType:"Jeans",name:"Blue Jeans",color:"denim",pattern:"solid"},
{garmentType:"Jeans",name:"Black Jeans",color:"black",pattern:"solid"},
{garmentType:"Shorts",name:"Navy Shorts",color:"navy",pattern:"solid"},
{garmentType:"Shorts",name:"Khaki Shorts",color:"khaki",pattern:"solid"},
{garmentType:"Shoes",name:"White Sneakers",color:"white",pattern:"solid"},
{garmentType:"Shoes",name:"Black Shoes",color:"black",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Shoes",color:"brown",pattern:"solid"},
{garmentType:"Polo",name:"Navy Polo",color:"navy",pattern:"solid"},
{garmentType:"Polo",name:"White Polo",color:"white",pattern:"solid"},
{garmentType:"Sweater/Knit",name:"Grey Sweater",color:"grey",pattern:"solid"},
{garmentType:"Jacket/Blazer",name:"Navy Blazer",color:"navy",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Loafers",color:"brown",pattern:"solid"},
];
function autoMatchColors(dialColor){
  var dc=(dialColor||"").toLowerCase().trim();
  var key=Object.keys(CP).find(function(k){return dc.includes(k)||k.includes(dc)});
  if(key)return CP[key].slice(0,8);
  return["white","cream","navy","charcoal","grey","black","tan","light blue"];
}

const _OWNER_DEFAULTS=[
{id:"snowflake",n:"GS Snowflake",t:"genuine",d:"Silver-White",c:"#c8d0d8",br:false,sc:["grey","navy"],mt:"cool",i:"â„ï¸",mc:["grey","navy","white","light blue","charcoal","silver","lavender","slate"],ac:["orange","red"],cx:["clinic","formal","smart-casual"],sg:"Greyâ†’dark shoes. Navyâ†’navy outfits.",wt:["light","mid","heavy"],active:true,status:"active"},
{id:"rikka",n:"GS Rikka",t:"genuine",d:"Green",c:"#5a8a6a",br:false,sc:["teal"],mt:"cool",i:"ðŸŒ¿",mc:["cream","ivory","sage","olive","teal","khaki","tan","forest green","white"],ac:["black","bright red"],cx:["smart-casual","date","weekend"],sg:"Tealâ†’brown shoes ONLY.",wt:["light","mid"],active:true,status:"active"},
{id:"sbgw267",n:"GS SBGW267",t:"genuine",d:"Ivory",c:"#f5f0e8",br:false,sc:["burgundy/purple"],mt:"warm",i:"ðŸª·",mc:["burgundy","plum","cream","mauve","ivory","charcoal","wine"],ac:["cobalt","neon"],cx:["formal","date","clinic"],sg:"Purple straps. Oxblood shoes.",wt:["mid","heavy"],active:true,status:"active"},
{id:"laureato",n:"GP Laureato",t:"genuine",d:"Blue",c:"#2a5a9a",br:true,sc:[],mt:"cool",i:"ðŸ”·",mc:["white","cream","light grey","navy","cobalt","light blue","silver"],ac:["brown","olive"],cx:["riviera","smart-casual","flex","date"],sg:"Integrated bracelet.",wt:["light","mid"],active:true,status:"active"},
{id:"reverso",n:"JLC Reverso",t:"genuine",d:"Navy",c:"#1a2a4a",br:false,sc:["navy"],mt:"cool",i:"ðŸŒ™",mc:["white","charcoal","navy","dark grey","silver"],ac:["casual"],cx:["formal","clinic","event"],sg:"Navyâ†’black/dark brown shoes.",wt:["mid","heavy"],active:true,status:"active"},
{id:"santos-lg",n:"Santos Large",t:"genuine",d:"White/Gold",c:"#d4af37",br:true,sc:[],mt:"mixed",i:"ðŸ’Ž",mc:["cream","white","light blue","tan","black","navy","gold"],ac:["neon"],cx:["clinic","smart-casual","date","riviera","flex"],sg:"Two-tone. Most versatile.",wt:["light","mid","heavy"],active:true,status:"active"},
{id:"santos-oct",n:"Santos Octagon YG",t:"genuine",d:"White",c:"#c5a03a",br:false,sc:["brown"],mt:"warm",i:"ðŸ‘‘",mc:["cream","tan","camel","chocolate","ivory","gold","brown"],ac:["grey","navy","silver"],cx:["formal","date","flex"],sg:"Brown shoes mandatory.",wt:["mid","heavy"],active:true,status:"active"},
{id:"bb41",n:"Tudor BB41",t:"genuine",d:"Black/Red",c:"#8b1a1a",br:true,sc:[],mt:"cool",i:"ðŸ”´",mc:["black","grey","white","charcoal","dark green","navy","olive"],ac:["pastel"],cx:["casual","weekend","smart-casual"],sg:"Steel + red bezel.",wt:["light","mid","heavy"],active:true,status:"active"},
{id:"monaco",n:"TAG Monaco",t:"genuine",d:"Black",c:"#1a1a1a",br:false,sc:["black"],mt:"cool",i:"ðŸ",mc:["black","charcoal","white","navy"],ac:["brown","warm"],cx:["smart-casual","date","weekend"],sg:"Black shoes ONLY.",wt:["mid","heavy"],active:true,status:"active"},
{id:"rolex-date",n:"Rolex Date",t:"genuine",d:"White/Gold",c:"#d4af37",br:true,sc:[],mt:"mixed",i:"â­",mc:["cream","light blue","white","tan","light grey"],ac:["all-black"],cx:["clinic","smart-casual","flex"],sg:"Jubilee. Leans warm.",wt:["light","mid"],active:true,status:"active"},
{id:"gmt",n:"Rolex GMT-II",t:"genuine",d:"Black",c:"#2a2a2a",br:true,sc:[],mt:"cool",i:"ðŸŒ",mc:["black","navy","grey","white","olive"],ac:[],cx:["casual","travel","smart-casual"],sg:"PENDING TRADEâ†’Alpine Eagle 8HF.",wt:["light","mid","heavy"],active:true,status:"pending-trade"},
{id:"hanhart",n:"Hanhart Pioneer",t:"genuine",d:"White/Teal",c:"#3a8a8a",br:false,sc:["teal"],mt:"cool",i:"âœˆï¸",mc:["teal","cream","sage","white","burnt orange","olive","khaki","tan"],ac:["formal"],cx:["casual","weekend","riviera"],sg:"Teal strap. Brown shoes.",wt:["light","mid"],active:true,status:"active"},
{id:"sinn613",n:"Sinn 613 UTC",t:"genuine",d:"Blue",c:"#2a4a7a",br:false,sc:["tan"],mt:"cool",i:"ðŸ§­",mc:["navy","light blue","white","grey","tan","khaki","denim"],ac:["all-black"],cx:["casual","weekend","clinic"],sg:"Tanâ†’brown shoes.",wt:["light","mid"],active:true,status:"active"},
{id:"laco",n:"Laco Flieger",t:"genuine",d:"Black",c:"#3a3a3a",br:false,sc:["distressed brown"],mt:"cool",i:"ðŸ›©ï¸",mc:["olive","brown","dark green","grey","khaki","tan"],ac:["silk","suits"],cx:["casual","weekend"],sg:"Rugged only.",wt:["mid","heavy"],active:true,status:"active"},
{id:"sugess",n:"Sugess Chrono",t:"genuine",d:"Green",c:"#2a6a3a",br:false,sc:["green"],mt:"cool",i:"ðŸ€",mc:["olive","cream","forest green","sage","khaki","white","tan"],ac:["blues"],cx:["casual","smart-casual"],sg:"Earth-tone shoes.",wt:["light","mid"],active:true,status:"active"},
{id:"seiko33",n:"Seiko SRPH33K1",t:"genuine",d:"Neutral",c:"#4a4a5a",br:true,sc:[],mt:"cool",i:"âŒš",mc:["anything"],ac:["formal"],cx:["casual","weekend"],sg:"Daily beater.",wt:["light","mid","heavy"],active:true,status:"active"},
{id:"iwc-perp",n:"IWC Perpetual",t:"replica",d:"Blue",c:"#1a3a7a",br:false,sc:["blue"],mt:"cool",i:"ðŸ”µ",mc:["navy","charcoal","white","silver"],ac:["casual"],cx:["formal","date","flex"],sg:"Dark shoes only.",wt:["mid","heavy"],active:true,status:"active"},
{id:"iwc-ing",n:"IWC Ingenieur",t:"replica",d:"Teal",c:"#1a8a7a",br:true,sc:[],mt:"cool",i:"ðŸŒŠ",mc:["teal","cream","white","sage","turquoise","mint"],ac:["dark heavy"],cx:["riviera","smart-casual","flex"],sg:"Summer coastal.",wt:["light"],active:true,status:"incoming"},
{id:"vc-perp",n:"VC Overseas Perp",t:"replica",d:"Burgundy",c:"#6a1a2a",br:true,sc:[],mt:"cool",i:"ðŸ·",mc:["burgundy","cream","plum","black","ivory","charcoal","wine"],ac:["cobalt"],cx:["date","formal","flex"],sg:"Fills burgundy gap.",wt:["mid","heavy"],active:true,status:"incoming"},
{id:"santos-rep",n:"Santos 35mm",t:"replica",d:"White",c:"#e0d8c8",br:true,sc:[],mt:"cool",i:"â—»ï¸",mc:["white","light blue","cream","grey"],ac:[],cx:["clinic","smart-casual"],sg:"Universal.",wt:["light","mid"],active:true,status:"active"},
{id:"alpine-red",n:"Chopard Alpine",t:"replica",d:"Red",c:"#b83a3a",br:true,sc:[],mt:"warm",i:"ðŸ”ï¸",mc:["black","cream","burgundy","charcoal","white"],ac:["cool blues"],cx:["date","flex","riviera"],sg:"Rose gold. Black anchors.",wt:["light","mid"],active:true,status:"active"},
{id:"ap-roc",n:"AP Royal Oak",t:"replica",d:"Green",c:"#1a5a2a",br:true,sc:[],mt:"cool",i:"ðŸŸ¢",mc:["dark green","cream","white","olive","black","navy"],ac:["close greens"],cx:["smart-casual","flex","date"],sg:"Dark makes green pop.",wt:["mid","heavy"],active:true,status:"active"},
{id:"gmt-met",n:"GMT Meteorite",t:"replica",d:"Meteorite",c:"#6a6a6a",br:true,sc:[],mt:"cool",i:"â˜„ï¸",mc:["grey","silver","charcoal","white","black"],ac:["warm earth"],cx:["flex","date"],sg:"Cool monochrome.",wt:["mid","heavy"],active:true,status:"active"},
{id:"dd-turq",n:"Day-Date Turq",t:"replica",d:"Turquoise",c:"#2ab8a8",br:true,sc:[],mt:"warm",i:"ðŸ’ ",mc:["white","cream","turquoise","tan","light blue","sand"],ac:["dark formal"],cx:["riviera","flex","date"],sg:"Pure summer.",wt:["light"],active:true,status:"active"},
{id:"op-yellow",n:"Rolex OP Yellow",t:"replica",d:"Yellow",c:"#d4b82a",br:true,sc:[],mt:"cool",i:"ðŸŒ»",mc:["navy","white","cream","light blue","olive","tan","denim"],ac:["formal"],cx:["casual","weekend","riviera"],sg:"Navy anchor.",wt:["light","mid"],active:true,status:"active"},
{id:"breguet",n:"Breguet Tradition",t:"replica",d:"Black",c:"#0a0a0a",br:false,sc:["black"],mt:"cool",i:"âš«",mc:["black","charcoal","white"],ac:["color","casual"],cx:["formal","date"],sg:"Black shoes only.",wt:["mid","heavy"],active:true,status:"active"},
];
const DEFAULTS=IS_SHARED?[]:_OWNER_DEFAULTS;

/* â•â•â•â•â•â• SCORING (null-safe) â•â•â•â•â•â• */
const CP={
"black":["white","grey","charcoal","light grey","red","navy","cream","silver","gold","burgundy","cobalt"],
"white":["navy","black","cobalt","teal","grey","cream","light blue","burnt orange","olive","burgundy","charcoal","forest green","red"],
"cream":["navy","olive","teal","burgundy","brown","tan","sage","burnt orange","forest green","charcoal","wine","plum","cobalt","dark brown"],
"ivory":["navy","olive","burgundy","brown","tan","sage","charcoal","wine","forest green","cobalt"],
"navy":["white","cream","light grey","tan","khaki","light blue","grey","gold","burnt orange","ivory","beige","sand","camel"],
"grey":["white","navy","black","charcoal","light blue","burgundy","teal","lavender","wine","cobalt","cream"],
"light grey":["navy","charcoal","cobalt","burgundy","teal","forest green","plum","white"],
"charcoal":["white","cream","light grey","light blue","lavender","burgundy","gold","teal","cobalt","ivory","beige"],
"light blue":["white","cream","navy","grey","tan","khaki","charcoal","brown","camel","beige"],
"teal":["cream","white","tan","khaki","burnt orange","sage","ivory","brown","beige","sand","camel"],
"turquoise":["white","cream","tan","navy","sand","beige","khaki"],
"olive":["cream","white","tan","khaki","brown","burnt orange","navy","ivory","beige","sand","rust"],
"sage":["cream","ivory","brown","tan","white","khaki","burnt orange","olive"],
"burgundy":["cream","ivory","charcoal","black","grey","white","light grey","beige","camel","gold"],
"wine":["cream","ivory","charcoal","grey","white","gold","beige"],
"brown":["cream","white","tan","olive","navy","khaki","sage","ivory","beige","light blue","burnt orange"],
"dark brown":["cream","ivory","tan","khaki","beige","white","camel","light blue"],
"tan":["navy","white","olive","brown","cream","teal","cobalt","light blue","charcoal","forest green","burgundy"],
"camel":["navy","white","charcoal","cobalt","cream","light blue","burgundy","forest green"],
"khaki":["navy","white","cobalt","teal","olive","brown","cream","burnt orange","charcoal","burgundy","forest green"],
"beige":["navy","charcoal","cobalt","forest green","burgundy","brown","teal","olive"],
"sand":["navy","cobalt","teal","olive","brown","charcoal","forest green","burgundy"],
"denim":["white","cream","tan","khaki","navy","grey","olive","brown","burnt orange","camel"],
"red":["black","charcoal","grey","white","navy","cream"],
"rust":["cream","olive","navy","tan","khaki","ivory","white","brown"],
"burnt orange":["cream","navy","olive","khaki","teal","tan","ivory","white","charcoal"],
"gold":["navy","charcoal","black","cream","burgundy","forest green","white"],
"lavender":["charcoal","grey","navy","white","cream","light grey"],
"plum":["cream","ivory","charcoal","grey","white","gold","light grey"],
"mauve":["cream","charcoal","grey","ivory","navy","white"],
"forest green":["cream","ivory","tan","khaki","white","beige","camel","brown","navy"],
"mint":["navy","charcoal","white","cream","grey"],
"silver":["black","charcoal","navy","white","grey","cobalt"],
"cobalt":["white","cream","light grey","tan","khaki","beige","gold","camel"],
"slate":["white","cream","light blue","navy","tan"],
};
function compat(c1,c2){
  if(!c1||!c2)return 0.1;
  const a=(c1||"").toLowerCase().trim(),b=(c2||"").toLowerCase().trim();
  if(!a||!b)return 0.1;
  if(a===b)return 0.3;
  if((CP[a]||[]).some(x=>b.includes(x)||x.includes(b)))return 1;
  if((CP[b]||[]).some(x=>a.includes(x)||x.includes(a)))return 1;
  const t1=Object.entries(CM).find(([k])=>a.includes(k)),t2=Object.entries(CM).find(([k])=>b.includes(k));
  if(t1&&t2&&t1[1].t===t2[1].t)return 0.5;
  return 0.2;
}

function scoreW(w,items,ctx,reps){
  if(!w.active||w.status==="sold"||w.status==="service")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0};
  if(!reps&&w.t==="replica")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0};
  let s=0;const bd={ctx:0,color:0,temp:0,strap:0,br:0};
  const ic=items.filter(i=>i.color).map(i=>i.color.toLowerCase().trim());
  const shoe=items.find(i=>i.garmentType==="Shoes");
  const sc=shoe&&shoe.color?shoe.color.toLowerCase().trim():null;
  if(ctx&&w.cx&&w.cx.includes(ctx)){s+=3;bd.ctx=3}
  for(const c of ic){
    if(!c)continue;
    let matched=false;
    for(const m of(w.mc||[])){if(m==="anything"||c.includes(m)||m.includes(c)){s+=2;bd.color+=2;matched=true;break}}
    if(!matched)for(const a of(w.ac||[])){if(c.includes(a)||a.includes(c)){s-=2;bd.color-=2;break}}
  }
  const temps=ic.map(c=>{const e=Object.entries(CM).find(([k])=>c.includes(k));return e?e[1].t:"neutral"});
  const wm=temps.filter(x=>x==="warm").length,co=temps.filter(x=>x==="cool").length;
  if(w.mt==="warm"&&wm>co){s+=2;bd.temp=2}if(w.mt==="cool"&&co>=wm){s+=1;bd.temp=1}if(w.mt==="warm"&&co>wm+1){s-=1;bd.temp=-1}
  if(!w.br&&sc&&w.sc&&w.sc.length){
    const sB=sc.includes("black"),sBr=sc.includes("brown")||sc.includes("tan")||sc.includes("cognac");
    const hB=w.sc.some(x=>x.includes("black")),hBr=w.sc.some(x=>x.includes("brown")||x.includes("tan")||x.includes("teal")||x.includes("green")||x.includes("burgundy")),hN=w.sc.some(x=>x.includes("navy")||x.includes("blue"));
    if(sB&&hB){s+=3;bd.strap=3}if(sB&&!hB&&!hN){s-=3;bd.strap=-3}if(sBr&&hBr){s+=3;bd.strap=3}if(sBr&&hB&&!hBr){s-=3;bd.strap=-3}if(sB&&hN){s+=1;bd.strap+=1}
  }
  if(w.br){s+=1;bd.br=1}
  /* Watch size Ã— context scoring */
  var sz=w.size?parseInt(w.size):0;
  if(sz>0){
    if((ctx==="formal"||ctx==="clinic")&&sz>=43){s-=1;bd.ctx-=1}
    if(ctx==="date"&&sz<=37){s+=0.5;bd.ctx+=0.5}
    if((ctx==="casual"||ctx==="weekend")&&sz>=44){s+=0.5;bd.ctx+=0.5}
  }
  return{total:s,...bd};
}
function strapRec(w,items){
  if(w.br)return{text:"Bracelet",type:"info"};
  if(!w.sc||!w.sc.length)return{text:"Default strap",type:"info"};
  const shoe=items.find(i=>i.garmentType==="Shoes");const sc=shoe&&shoe.color?shoe.color.toLowerCase():"";
  if(w.sc.length===1)return{text:w.sc[0]+" strap",type:"info"};
  for(const st of w.sc){
    if(sc.includes("black")&&(st.includes("black")||st.includes("navy")))return{text:"â†’ "+st,type:"good"};
    if((sc.includes("brown")||sc.includes("tan"))&&(st.includes("brown")||st.includes("tan")||st.includes("teal")||st.includes("burgundy")))return{text:"â†’ "+st,type:"good"};
  }
  return{text:w.sc.join(" / "),type:"info"};
}
function getWarns(w,items){
  const ws=[];const shoe=items.find(i=>i.garmentType==="Shoes");
  if(!w.br&&shoe&&shoe.color){const sc=shoe.color.toLowerCase();
    if(sc.includes("white"))ws.push("âš ï¸ Strap+white shoes");
    if(sc.includes("brown")&&w.sc&&w.sc.every(x=>x.includes("black")||x.includes("navy")))ws.push("ðŸš« Brown shoes+dark strap");
    if(sc.includes("black")&&w.sc&&w.sc.every(x=>x.includes("brown")||x.includes("tan")||x.includes("teal")))ws.push("ðŸš« Black shoes+warm strap");
  }
  return ws;
}
const CXR={
"clinic":{no:["Shorts","Jeans","T-Shirt"]},
"smart-casual":{no:["Shorts"]},
"formal":{no:["T-Shirt","Shorts","Jeans","Polo"]},
"date":{no:["Shorts","T-Shirt"]},
"riviera":{no:[]},
"casual":{no:[]},
"weekend":{no:[]},
"flex":{no:["Shorts"]},
"travel":{no:[]},
"event":{no:["T-Shirt","Shorts"]},
"office":{no:["Shorts","T-Shirt","Jeans"]},
};

function makeOutfit(items,watches,ctx,reps,wxOpts,tempVal){
  const top=items.find(i=>catOf(i.garmentType)==="tops"),bot=items.find(i=>catOf(i.garmentType)==="bottoms"),shoe=items.find(i=>catOf(i.garmentType)==="shoes");
  if(wxOpts&&tempVal!==undefined)wxOpts.temp=tempVal;
  let fs=0;
  /* Season penalty for off-season items */
  var _csn=(function(){var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
  items.forEach(function(it){var s=it.seasons;if(s&&s.length>0&&s.length<4&&!s.includes(_csn))fs-=1});
  /* Freshness penalty â€” discourage recently-worn garments for variety */
  var _now=Date.now();
  items.forEach(function(it){if(it.lastWorn){var daysAgo=Math.floor((_now-new Date(it.lastWorn).getTime())/(864e5));if(daysAgo<=1)fs-=2;else if(daysAgo<=3)fs-=0.8;else if(daysAgo<=5)fs-=0.3;else if(daysAgo>=14)fs+=0.3}});
  if(top&&bot)fs+=compat(top.color,bot.color)*3;
  if(top&&shoe)fs+=compat(top.color,shoe.color)*2;
  if(bot&&shoe)fs+=compat(bot.color,shoe.color)*2;
  /* Jeans daily preference bonus */
  if(bot&&bot.garmentType==="Jeans")fs+=0.8;
  /* Pattern bonus */
  if(top&&bot){
    var tp=(top.pattern||"solid"),bp=(bot.pattern||"solid");
    if(tp!=="solid"&&bp!=="solid")fs-=1.5;
    else if((tp==="textured"||bp==="textured")&&(tp==="solid"||bp==="solid"))fs+=0.8;
    else if(tp==="striped"&&bp==="solid")fs+=0.4;
  }
  /* Weather condition scoring */
  var isRainy=wxOpts&&wxOpts.rain;
  var isWindy=wxOpts&&wxOpts.wind&&wxOpts.wind>30;
  var uvHigh=wxOpts&&wxOpts.uv&&wxOpts.uv>=6;
  if(isRainy&&shoe){
    var sc2=(shoe.color||"").toLowerCase();
    var sn2=(shoe.name||"").toLowerCase();
    /* Penalize white/cream shoes in rain */
    if(sc2==="white"||sc2==="cream"||sc2==="beige"||sc2==="sand")fs-=2;
    /* Black shoes safest in rain */
    if(sc2==="black")fs+=1;
    /* Suede/canvas/material penalty in rain */
    var sm=(shoe.material||"").toLowerCase();
    if(sn2.includes("suede")||sm==="suede")fs-=2;
    else if(sn2.includes("canvas")||sm==="canvas")fs-=1;
  }
  /* Material-weather scoring for all items */
  if(wxOpts){
    var wxTemp=wxOpts.temp||18;
    items.forEach(function(it){
      var mat=(it.material||"").toLowerCase();
      if(!mat)return;
      if(isRainy&&mat==="suede")fs-=2;
      if(isRainy&&mat==="canvas")fs-=1;
      if((mat==="wool"||mat==="cashmere"||mat==="fleece")&&wxTemp>28)fs-=2;
      if(mat==="linen"&&wxTemp<10)fs-=1;
      if((mat==="linen"||mat==="cotton")&&wxTemp>25)fs+=1;
      if((mat==="wool"||mat==="cashmere"||mat==="tweed"||mat==="corduroy"||mat==="fleece")&&wxTemp<15)fs+=1;
    });
  }
  const wr=watches.map(w=>{
    var sc=scoreW(w,items,ctx,reps);
    /* Rain: penalize leather straps, boost bracelets */
    if(isRainy){
      if(w.br){sc.total+=2;sc.br+=2} /* bracelet bonus in rain */
      else{sc.total-=2;sc.strap-=2} /* leather strap penalty */
    }
    return{...w,score:sc.total,bd:sc,sr:strapRec(w,items),wn:getWarns(w,items)}
  }).filter(w=>w.score>-1).sort((a,b)=>b.score-a.score);
  if(wr[0])fs+=wr[0].score*0.5;
  /* Rain warning */
  var wxWarns=[];
  if(isRainy)wxWarns.push("ðŸŒ§ï¸ Rain expected â€” bracelets preferred over leather");
  if(isWindy)wxWarns.push("ðŸ’¨ High wind â€” secure light items");
  return{fs:Math.round(fs*10)/10,watches:wr.slice(0,3),allW:wr,top,bot,shoe,items,wxWarns:wxWarns};
}

function genFits(wardrobe,watches,ctx,reps,ww,count,opts){
  count=count||10;opts=opts||{};
  var wxOpts=opts.wx||null;
  const rules=CXR[ctx]||CXR["smart-casual"];
  var curSeason=(function(){var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
  var seasonFilter=function(i){var s=i.seasons;if(!s||!s.length||s.length>=4)return true;return s.includes(curSeason)};
  const valid=wardrobe.filter(function(i){return i.color&&!i.needsEdit});
  var tops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  var bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  /* Fallback: if season filtering empties a category, drop it */
  if(!tops.length)tops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)});
  if(!bots.length)bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)});
  var shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"&&seasonFilter(i)});
  if(!shoes.length)shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"});
  /* Top type filter */
  if(opts.topType&&opts.topType!=="all"){var ft=tops.filter(function(i){return i.garmentType===opts.topType});if(ft.length)tops=ft}
  /* Lock item */
  var lockItem=opts.lockItem||null;
  if(lockItem){
    var lcat=catOf(lockItem.garmentType);
    if(lcat==="tops"){tops=[lockItem]}
    else if(lcat==="bottoms"){bots=[lockItem]}
  }
  if(ww==="light"){const lt=tops.filter(function(i){return["Shirt","Polo","T-Shirt"].includes(i.garmentType)});const lb=bots.filter(function(i){return["Shorts","Chinos","Jeans"].includes(i.garmentType)});if(lt.length)tops=lt;if(lb.length)bots=lb}
  else if(ww==="mid"){var midTemp=opts.temp||18;if(midTemp<18){var cmt=tops.filter(function(i){return["Sweater/Knit","Jacket/Blazer","Shirt"].includes(i.garmentType)});var cmb=bots.filter(function(i){return["Pants/Trousers","Jeans","Chinos"].includes(i.garmentType)});if(cmt.length)tops=cmt;if(cmb.length)bots=cmb}else{var wmt=tops.filter(function(i){return["Shirt","Polo","T-Shirt"].includes(i.garmentType)});var wmb=bots.filter(function(i){return["Jeans","Chinos","Shorts"].includes(i.garmentType)});if(wmt.length)tops=wmt;if(wmb.length)bots=wmb}}
  else if(ww==="heavy"){const ht=tops.filter(function(i){return["Sweater/Knit","Jacket/Blazer","Shirt"].includes(i.garmentType)});const hb=bots.filter(function(i){return["Jeans","Pants/Trousers","Chinos"].includes(i.garmentType)});if(ht.length)tops=ht;if(hb.length)bots=hb}
  if(!tops.length||!bots.length)return[];
  const combos=[];
  for(const top of tops)for(const bot of bots){
    if(top.id===bot.id)continue;
    const tb=compat(top.color,bot.color);if(tb<0.2)continue;
    for(const shoe of(shoes.length?shoes:[null])){
      if(shoe&&(shoe.id===top.id||shoe.id===bot.id))continue;
      const items=[top,bot].concat(shoe?[shoe]:[]);
      const r=makeOutfit(items,watches,ctx,reps,wxOpts,opts.temp);
      combos.push({id:top.id+"-"+bot.id+"-"+(shoe?shoe.id:"x"),fs:r.fs,watches:r.watches,allW:r.allW,top:r.top,bot:r.bot,shoe:r.shoe,items:r.items,topType:top.garmentType,wxWarns:r.wxWarns});
    }
  }
  combos.sort(function(a,b){return b.fs-a.fs});
  const seen=new Set(),botUse={},uniq=[];
  for(const c of combos){
    const ck=c.top?.color+"-"+c.bot?.color;
    var bid=c.bot?c.bot.id:"x";
    if(seen.has(ck)&&uniq.length>2)continue;
    if((botUse[bid]||0)>=3&&uniq.length>4)continue;
    seen.add(ck);botUse[bid]=(botUse[bid]||0)+1;
    uniq.push(c);if(uniq.length>=count)break;
  }
  if(opts.shuffle){for(var si=uniq.length-1;si>0;si--){var sj=Math.floor(Math.random()*(si+1));var st=uniq[si];uniq[si]=uniq[sj];uniq[sj]=st}}
  return uniq;
}

function getSwaps(wd,fit,slot){
  const cat=slot==="top"?"tops":slot==="bot"?"bottoms":"shoes";
  const cur=slot==="top"?fit.top:slot==="bot"?fit.bot:fit.shoe;if(!cur)return[];
  return wd.filter(function(i){return i.color&&!i.needsEdit&&catOf(i.garmentType)===cat&&i.id!==cur.id}).map(function(alt){
    const o1=slot==="top"?fit.bot:fit.top;const o2=slot==="top"?fit.shoe:(slot==="bot"?fit.shoe:fit.bot);
    let sc=o1?compat(alt.color,o1.color)*3:0;if(o2)sc+=compat(alt.color,o2.color)*2;
    return Object.assign({},alt,{ss:Math.round(sc*10)/10})}).sort(function(a,b){return b.ss-a.ss}).slice(0,3);
}

/* â•â•â•â•â•â• IMAGE COMPRESSION â•â•â•â•â•â• */
function compressImage(dataUrl,maxDim,quality){
  maxDim=maxDim||800;quality=quality||0.7;
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.width,h=img.height;
      if(w>maxDim||h>maxDim){if(w>h){h=Math.round(h*(maxDim/w));w=maxDim}else{w=Math.round(w*(maxDim/h));h=maxDim}}
      var c=document.createElement("canvas");c.width=w;c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      resolve(c.toDataURL("image/jpeg",quality));
    };
    img.onerror=function(){resolve(dataUrl)};
    img.src=dataUrl;
  });
}

/* â•â•â•â•â•â• AI ERROR LOG (visible in UI) â•â•â•â•â•â• */
var _lastAiError="";
function getLastAiError(){return _lastAiError}

/* â•â•â•â•â•â• RETRY WRAPPER FOR API CALLS â•â•â•â•â•â• */
/* Reserved for future use - can be applied to aiID and aiVision calls for automatic retry on failure */
async function retryAsync(fn,retries,delay){
  for(var i=0;i<=retries;i++){
    try{
      var result=await fn();
      if(result!==null)return result;
      if(i<retries)await new Promise(function(r){setTimeout(r,delay)});
    }catch(e){
      if(i===retries)throw e;
      await new Promise(function(r){setTimeout(r,delay)});
    }
  }
  return null;
}

async function aiID(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:600,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"Identify ALL distinct clothing items visible in this photo for a wardrobe app.\n\nRules:\n1. If a FULL OUTFIT is shown (person wearing top+bottom+shoes), return EACH as a separate item.\n2. If photo shows a single garment laid flat or folded, return just one item.\n3. If multiple garments are stacked/folded together, identify each distinct one.\n4. For each item, note its position in the frame (e.g. 'top half','bottom half','left','right','center','full frame').\n5. Include shoes if visible.\n6. Maximum 4 items per photo.\n\nReturn ONLY a JSON ARRAY, no markdown:\n[{\"garmentType\":\"Shirt\"|\"Polo\"|\"T-Shirt\"|\"Sweater/Knit\"|\"Jacket/Blazer\"|\"Pants/Trousers\"|\"Chinos\"|\"Jeans\"|\"Shorts\"|\"Shoes\",\"name\":\"2-3 word description\",\"color\":\"one from: "+AC.join(",")+"\",\"pattern\":\"solid\"|\"plaid\"|\"striped\"|\"checked\"|\"print\"|\"textured\",\"position\":\"where in frame\"}]\nPick the single dominant color per item. If only ONE item is visible, still return an array with one element."}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    var p=JSON.parse(txt);
    /* Handle both array and single object responses */
    if(Array.isArray(p)){if(p.length&&p[0].garmentType&&p[0].color)return p;_lastAiError="AI returned empty array";return null}
    if(p.garmentType&&p.color)return[p];
    _lastAiError="AI returned incomplete: "+JSON.stringify(p).slice(0,80);return null;
  }catch(e){_lastAiError="Exception: "+String(e.message||e).slice(0,120);return null}
}

async function aiVision(fit,watch,ctx,apiKey){
  _lastAiError="";
  var top=fit.top,bot=fit.bot,shoe=fit.shoe;
  var prompt="You are a men's luxury style advisor. Analyze this outfit combination and give me a vivid, cinematic vision of how this looks.\n\n";
  prompt+="OUTFIT:\n";
  if(top)prompt+="- Top: "+top.color+" "+(top.pattern||"solid")+" "+(top.garmentType||"")+( top.name?" ("+top.name+")":"")+"\n";
  if(bot)prompt+="- Bottom: "+bot.color+" "+(bot.pattern||"solid")+" "+(bot.garmentType||"")+(bot.name?" ("+bot.name+")":"")+"\n";
  if(shoe)prompt+="- Shoes: "+shoe.color+" "+(shoe.name||shoe.garmentType||"shoes")+"\n";
  prompt+="- Watch: "+watch.n+" â€” "+watch.d+" dial, "+(watch.br?"steel bracelet":"leather strap"+(watch.sc?" ("+watch.sc.join("/")+")":""))+(IS_SHARED?"":", "+(watch.t==="replica"?"replica":"genuine"))+"\n";
  prompt+="- Context: "+ctx+"\n\n";
  prompt+="Return ONLY valid JSON, no markdown fences:\n";
  prompt+='{"vision":"A 2-3 sentence cinematic description of how this person looks walking into the room. Be specific about color interplay and watch presence. Write like a GQ editorial.",';
  prompt+='"impact":1-10,"impact_why":"One sentence why this score.",';
  prompt+='"works":"What color/texture combinations work best (1 sentence).",';
  prompt+='"risk":"Any clash, mismatch or execution risk (1 sentence, or null if flawless).",';
  prompt+='"strap_call":"If watch has strap options, which one for this outfit and why (1 sentence, or null if bracelet)."}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:500,
        messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Vision HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Vision error: "+String(e.message||e).slice(0,100);return null}
}

/* â•â•â•â•â•â• COMPONENTS (OUTSIDE App) â•â•â•â•â•â• */
const Dot=memo(function DotC(props){
  var color=props.color,size=props.size||10;
  return React.createElement("span",{style:{width:size,height:size,borderRadius:"50%",flexShrink:0,display:"inline-block",background:(CM[color?color.toLowerCase():""]||{}).h||"#5a5a5a",border:color&&color.toLowerCase()==="black"?"1px solid #444":"none"}});
});

const Pill=memo(function PillC(props){
  return React.createElement("button",{onClick:props.onClick,style:{background:props.on?"var(--gold)":"var(--card)",border:"1px solid "+(props.on?"var(--gold)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",color:props.on?"var(--bg)":"#6a6474",fontFamily:"var(--f)",fontSize:11,fontWeight:props.on?600:400,whiteSpace:"nowrap",minHeight:36}},props.children);
});

const ColorGrid=memo(function ColorGridC(props){
  return React.createElement("div",null,CG.map(function(g){
    return React.createElement("div",{key:g.l,style:{marginBottom:10}},
      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",textTransform:"uppercase"}},g.l),
      React.createElement("div",{style:{display:"flex",gap:7,flexWrap:"wrap",marginTop:5}},
        g.c.map(function(c){return React.createElement("div",{key:c,onClick:function(){props.onChange(c)},className:"swatch "+(props.value===c?"on":""),style:{background:(CM[c]||{}).h||"#5a5a5a"},title:c})})));
  }));
});

const OutfitFigure=memo(function OutfitFigureC(props){
  var tc=(CM[props.topColor]||{}).h||"#5a5a5a";
  var bc=(CM[props.botColor]||{}).h||"#3a3a3a";
  var sc=(CM[props.shoeColor]||{}).h||"#2a2a2a";
  var wc=props.watchColor||"#c9a84c";
  var wi=props.watchIcon||"âŒš";
  var skin="#c8a882";
  return React.createElement("div",{style:{width:props.size||120,margin:"0 auto",position:"relative"}},
    React.createElement("svg",{viewBox:"0 0 120 220",width:props.size||120,height:Math.round((props.size||120)*220/120),style:{filter:"drop-shadow(0 4px 12px rgba(0,0,0,0.4))"}},
      /* Head */
      React.createElement("ellipse",{cx:60,cy:22,rx:14,ry:16,fill:skin}),
      /* Neck */
      React.createElement("rect",{x:54,y:36,width:12,height:8,fill:skin,rx:2}),
      /* Torso / shirt */
      React.createElement("path",{d:"M 36 44 Q 34 44 32 48 L 18 52 L 20 62 L 36 58 L 36 110 Q 36 114 40 114 L 80 114 Q 84 114 84 110 L 84 58 L 100 62 L 102 52 L 88 48 Q 86 44 84 44 Z",fill:tc,stroke:"rgba(255,255,255,0.08)",strokeWidth:0.5}),
      /* Collar detail */
      React.createElement("path",{d:"M 50 44 L 60 56 L 70 44",fill:"none",stroke:"rgba(255,255,255,0.15)",strokeWidth:1.5}),
      /* Left arm */
      React.createElement("path",{d:"M 36 58 L 22 62 L 18 90 L 24 92 L 30 68 L 36 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right arm */
      React.createElement("path",{d:"M 84 58 L 98 62 L 102 90 L 96 92 L 90 68 L 84 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left hand */
      React.createElement("ellipse",{cx:21,cy:93,rx:5,ry:4,fill:skin}),
      /* Right hand */
      React.createElement("ellipse",{cx:99,cy:93,rx:5,ry:4,fill:skin}),
      /* Watch on left wrist */
      React.createElement("rect",{x:15,y:84,width:12,height:10,rx:2,fill:wc,stroke:"rgba(255,255,255,0.2)",strokeWidth:0.5}),
      React.createElement("circle",{cx:21,cy:89,r:3,fill:"rgba(255,255,255,0.15)"}),
      /* Belt */
      React.createElement("rect",{x:36,y:112,width:48,height:5,fill:"#1a1a1a",rx:1}),
      React.createElement("rect",{x:57,y:113,width:6,height:3,rx:1,fill:"#c9a84c"}),
      /* Left leg */
      React.createElement("path",{d:"M 38 117 L 36 185 L 32 186 L 32 190 Q 32 192 34 192 L 48 192 Q 50 192 50 190 L 50 186 L 48 185 L 50 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right leg */
      React.createElement("path",{d:"M 70 117 L 72 185 L 70 186 L 70 190 Q 70 192 72 192 L 86 192 Q 88 192 88 190 L 88 186 L 84 185 L 82 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left shoe */
      React.createElement("path",{d:"M 30 188 L 30 196 Q 30 200 34 200 L 50 200 Q 54 200 54 196 L 54 192 L 48 192 L 34 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Right shoe */
      React.createElement("path",{d:"M 68 188 L 68 196 Q 68 200 72 200 L 88 200 Q 92 200 92 196 L 92 192 L 86 192 L 72 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Subtle fabric texture lines on shirt */
      React.createElement("line",{x1:45,y1:60,x2:45,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:55,y1:55,x2:55,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:65,y1:55,x2:65,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:75,y1:60,x2:75,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5})),
    /* Watch label */
    React.createElement("div",{style:{position:"absolute",left:-2,top:"38%",background:"rgba(0,0,0,0.6)",borderRadius:4,padding:"2px 5px",border:"1px solid "+wc+"60",display:"flex",alignItems:"center",gap:2}},
      React.createElement("span",{style:{fontSize:10}},wi),
      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:wc,fontWeight:600}},props.watchName||"")));
});

const WCard=memo(function WCardC(props){
  var w=props.w,rank=props.rank,detail=props.detail;
  var maxS=15;var pct=Math.max(0,Math.min(100,(w.score/maxS)*100));
  var barC=pct>60?"var(--good)":pct>30?"var(--gold)":"var(--warn)";
  return(
    React.createElement("div",{className:"card-lift",style:{background:rank===0?"var(--card2)":"#0b0a10",border:rank===0?"1px solid rgba(201,168,76,0.25)":"1px solid #141220",borderRadius:12,padding:"14px"}},
      React.createElement("div",{style:{display:"flex",gap:10,alignItems:"flex-start"}},
        React.createElement("div",{style:{width:42,height:42,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"18",fontSize:20,flexShrink:0}},w.i),
        React.createElement("div",{style:{flex:1,minWidth:0}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{fontSize:14,fontWeight:600}},w.n),
            !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid #2a2520",borderRadius:3,padding:"1px 5px"}},"REP"),
            rank===0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700,background:"rgba(201,168,76,0.1)",padding:"2px 6px",borderRadius:4}},"BEST")),
          React.createElement("div",{className:"score-bar",style:{marginBottom:6,width:"100%"}},React.createElement("div",{className:"score-fill",style:{width:pct+"%",background:barC}})),
          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:3,background:w.sr&&w.sr.type==="good"?"#1a2a1a":"var(--card)",borderRadius:6,padding:"4px 8px",border:"1px solid "+(w.sr&&w.sr.type==="good"?"#2a4a2a":"var(--border)")}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:w.sr&&w.sr.type==="good"?"var(--good)":"var(--sub)"}},(w.br?"â›“ï¸":"ðŸ”—")+" "+(w.sr?w.sr.text:"")))),
          detail&&w.bd&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:4}},
            w.bd.ctx>0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"#0a1a0a",color:"var(--good)",borderRadius:4,padding:"2px 6px"}},"âœ“ ctx +"+w.bd.ctx),
            w.bd.color!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.color>0?"#0a1a0a":"#1a0a0a",color:w.bd.color>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.color>0?"âœ“":"âœ—")+" color "+(w.bd.color>0?"+":"")+w.bd.color),
            w.bd.strap!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.strap>0?"#0a1a0a":"#1a0a0a",color:w.bd.strap>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.strap>0?"âœ“":"âœ—")+" strap "+(w.bd.strap>0?"+":"")+w.bd.strap),
            w.bd.temp!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"#0a0a1a",color:"var(--sub)",borderRadius:4,padding:"2px 6px"}},"ðŸŒ¡ï¸"+(w.bd.temp>0?"+":"")+w.bd.temp)),
          w.wn&&w.wn.map(function(x,i){return React.createElement("p",{key:i,style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",marginTop:3}},x)}))))
  );
});

/* â•â•â•â•â•â• MODAL WRAPPER â•â•â•â•â•â• */
function Modal(props){
  useEffect(function(){var sy=window.scrollY;document.body.classList.add("modal-open");document.body.style.top="-"+sy+"px";return function(){document.body.classList.remove("modal-open");document.body.style.top="";window.scrollTo(0,sy)}},[]);
  return React.createElement("div",{className:"modal-backdrop",onClick:function(e){if(e.target===e.currentTarget)props.onClose()}},
    React.createElement("div",{className:"modal-body"},
      React.createElement("div",{className:"modal-handle"}),props.children));
}

function genWeekRotation(watches,forecast,weekCtx,wardrobe,reps,wearLog,rotLock){
  var DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var today=new Date().getDay();
  var plan=[];var used={};var lastId=null;
  var defCtx=["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"];
  /* Build days-since-worn map from log */
  var dsw={};var now=Date.now();
  if(wearLog&&wearLog.length){for(var e of wearLog){if(!dsw[e.watchId]||e.ts>dsw[e.watchId])dsw[e.watchId]=e.ts}}
  for(var d=0;d<7;d++){
    var dayIdx=(today+d)%7;var dayName=DAYS[dayIdx];
    var cx=(weekCtx&&weekCtx.length===7)?weekCtx[dayIdx]:defCtx[dayIdx];
    var fc=forecast&&forecast[d]?forecast[d]:null;
    var dayTier=fc?getWT(fc.feelsAvg):null;
    var dayWt=dayTier?dayTier.weight:"mid";
    /* Check if this day has a locked watch */
    var lockedId=rotLock&&rotLock[d]?rotLock[d]:null;
    var lockedWatch=lockedId?watches.find(function(w){return w.id===lockedId}):null;
    var pick;
    if(lockedWatch){
      pick=lockedWatch;
    }else{
      /* Score watches */
      var scored=watches.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"&&(reps||w.t!=="replica")}).map(function(w){
        var s=0;
        if(w.cx&&w.cx.includes(cx))s+=4;
        if(w.wt&&w.wt.includes(dayWt))s+=2;
        if(used[w.id])s-=8;
        if(w.id===lastId)s-=12;
        if(plan.length>1&&plan[plan.length-2]&&plan[plan.length-2].watch&&plan[plan.length-2].watch.id===w.id)s-=6;
        var types=plan.map(function(p){return p.watch?p.watch.t:""});
        var gc=types.filter(function(t){return t==="genuine"}).length;
        var rc=types.filter(function(t){return t==="replica"}).length;
        if(w.t==="genuine"&&rc>gc)s+=1;
        if(w.t==="replica"&&gc>rc)s+=1;
        var lastWorn=dsw[w.id];
        if(lastWorn){var daysAgo=Math.floor((now-lastWorn)/(24*60*60*1000));if(daysAgo<=1)s-=4;else if(daysAgo<=3)s-=1;else if(daysAgo>=7)s+=2;else if(daysAgo>=14)s+=3}
        else{s+=1}
        /* Weather condition scoring â€” rain favors bracelets */
        var dayRain=fc&&fc.cond&&fc.cond.rain;
        if(dayRain){
          if(w.br)s+=3; /* bracelet bonus in rain */
          else s-=2; /* leather penalty in rain */
        }
        return Object.assign({},w,{rotScore:s});
      }).sort(function(a,b){return b.rotScore-a.rotScore});
      pick=scored[0]||null;
    }
    if(pick){used[pick.id]=true;lastId=pick.id}
    /* Generate top outfit for this day's watch+context+weather */
    var dayFit=null;var altFits=[];
    var dayWxOpts=fc?{rain:fc.cond&&fc.cond.rain,wind:fc.wind||0,uv:fc.uv||0,rainPct:fc.rainPct||0}:null;
    if(pick&&wardrobe&&wardrobe.length>=2){
      var dayFits=genFits(wardrobe,[pick],cx,true,dayWt,4,{wx:dayWxOpts,temp:fc?fc.feelsAvg:18});
      if(dayFits.length)dayFit=dayFits[0];
      altFits=dayFits.slice(1,4);
    }
    plan.push({day:d,dayIdx:dayIdx,dayName:dayName,date:fc?fc.date:"",context:cx,tier:dayTier,weight:dayWt,watch:pick,forecast:fc,outfit:dayFit,altOutfits:altFits,locked:!!lockedWatch,
      strapPick:pick&&!pick.br&&pick.sc&&pick.sc.length>1&&dayFit?strapRec(pick,dayFit.items):pick&&!pick.br?{text:(pick.sc||[])[0]||"default",type:"info"}:null});
  }
  /* Cross-day dedup: if consecutive days share same top+bot, swap second day to alt */
  for(var dd=0;dd<plan.length-1;dd++){
    var a=plan[dd],b=plan[dd+1];
    if(a.outfit&&b.outfit&&a.outfit.top&&b.outfit.top&&a.outfit.bot&&b.outfit.bot&&a.outfit.top.id===b.outfit.top.id&&a.outfit.bot.id===b.outfit.bot.id){
      if(b.altOutfits&&b.altOutfits.length){var alt=b.altOutfits.find(function(af){return!af.top||!af.bot||af.top.id!==a.outfit.top.id||af.bot.id!==a.outfit.bot.id});if(alt){b.outfit=alt;b.altOutfits=b.altOutfits.filter(function(af){return af!==alt})}}
    }
  }
  return plan;
}

/* â•â•â•â•â•â• APP â•â•â•â•â•â• */
function App(){
  const[W,setW]=useState(DEFAULTS);
  const[wd,setWd]=useState([]);
  const[view,setView]=useState("wardrobe");
  const[ctx,setCtx]=useState("smart-casual");
  const[reps,setReps]=useState(true);
  const[proc,setProc]=useState([]);
  const[saved,setSaved]=useState([]);
  const[selFit,setSelFit]=useState(null);
  const[wFilt,setWFilt]=useState("all");
  const[wMatFilt,setWMatFilt]=useState("all");
  const[weather,setWx]=useState(null);
  const[loc,setLoc]=useState({lat:31.7683,lon:35.2137,name:"Jerusalem"});
  const[editG,setEditG]=useState(null);
  const[editW,setEditW]=useState(null);
  const[addG,setAddG]=useState(false);
  const[mode,setMode]=useState("auto");
  const[topType,setTopType]=useState("all");
  const[lockItem,setLockItem]=useState(null);
  const[shuffleKey,setShuffleKey]=useState(0);
  const[fitCount,setFitCount]=useState(12);
  const[buildSlot,setBuildSlot]=useState(null);
  const[bTop,setBTop]=useState(null);
  const[bBot,setBBot]=useState(null);
  const[bShoe,setBShoe]=useState(null);
  const[wTab,setWTab]=useState("all");
  const[aiErr,setAiErr]=useState("");
  const[apiKey,setApiKey]=useState("");
  const[showSettings,setShowSettings]=useState(false);
  const[forecast,setForecast]=useState([]);
  const[planDay,setPlanDay]=useState(0);
  const[onboarded,setOnboarded]=useState(!IS_SHARED);
  const[onboardStep,setOnboardStep]=useState(1);
  const[obWatches,setObWatches]=useState([]);
  const[obGarments,setObGarments]=useState([]);
  const[weekCtx,setWeekCtx]=useState(IS_SHARED?["casual","smart-casual","smart-casual","smart-casual","smart-casual","smart-casual","weekend"]:["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"]);
  const[editRotCtx,setEditRotCtx]=useState(false);
  const[wearLog,setWearLog]=useState([]);
  const[aiCritique,setAiCritique]=useState(null);
  const[aiLoading,setAiLoading]=useState(false);
  const[dailyPick,setDailyPick]=useState(null);
  const[rotLock,setRotLock]=useState([null,null,null,null,null,null,null]);
  const[editDayIdx,setEditDayIdx]=useState(null);
  const[editDayMode,setEditDayMode]=useState(null);
  const[undoStack,setUndoStack]=useState([]);
  const[expandDay,setExpandDay]=useState(null);
  const[dayAi,setDayAi]=useState({});
  const[dayAiLoading,setDayAiLoading]=useState(null);
  const[userCx,setUserCx]=useState(null);
  const[toast,setToast]=useState(null);
  /* â”€â”€ NEW FEATURE STATE â”€â”€ */
  const[darkMode,setDarkMode]=useState(false);
  const[profileName,setProfileName]=useState("");
  const[profileBio,setProfileBio]=useState("");
  const[favorites,setFavorites]=useState([]);
  const[locVibe,setLocVibe]=useState(null);
  const[showDupes,setShowDupes]=useState(false);
  const[showBatch,setShowBatch]=useState(false);
  const[batchResults,setBatchResults]=useState([]);
  const[batchProcessing,setBatchProcessing]=useState(false);
  const[compositeData,setCompositeData]=useState(null);
  const[showProfile,setShowProfile]=useState(false);
  const[aiInsights,setAiInsights]=useState(null);
  const[aiInsightsLoading,setAiInsightsLoading]=useState(false);
  const fRef=useRef();const cRef=useRef();
  const apiKeyRef=useRef("");
  const toastTimer=useRef(null);

  /* Toast notifications */
  const showToast=useCallback(function(msg,type){
    if(toastTimer.current)clearTimeout(toastTimer.current);
    setToast({msg:msg,type:type||"info"});
    toastTimer.current=setTimeout(function(){setToast(null)},3000);
  },[]);

  /* Storage: Claude.ai artifact has window.storage.set/get returning promises. Chrome's StorageManager is different. */
  const hasAS=(function(){try{return typeof window.storage==="object"&&typeof window.storage.set==="function"&&typeof window.storage.get==="function"&&window.storage!==navigator.storage}catch(e){return false}})();
  const ps=useCallback(async function(k,v){var j=JSON.stringify(v);try{if(hasAS){await window.storage.set(k,j)}else{localStorage.setItem(k,j)}return true}catch(e){try{localStorage.setItem(k,j);return true}catch(e2){console.error("Save failed:",e2);return false}}},[]);
  const loadKey=function(k){if(hasAS){return window.storage.get(k).then(function(r){return r&&r.value?JSON.parse(r.value):null}).catch(function(){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}})}try{var v=localStorage.getItem(k);return Promise.resolve(v?JSON.parse(v):null)}catch(e){return Promise.resolve(null)}};

  useEffect(function(){(async function(){
    var wLoaded=false,wdLoaded=false,ofLoaded=false;
    // Load current version
    try{var p=await loadKey("w_"+SK);if(p&&p.length){setW(p);wLoaded=true}}catch(e){}
    try{var p2=await loadKey("wd_"+SK);if(p2&&p2.length){setWd(p2);wdLoaded=true}}catch(e){}
    try{var p3=await loadKey("of_"+SK);if(p3&&p3.length){setSaved(p3);ofLoaded=true}}catch(e){}
    // Migrate from older versions (v12 first, then older)
    if(!wLoaded){for(var vk of["w_v12","w_v11","w_v9","watches_v8"]){try{var pm=await loadKey(vk);if(pm&&pm.length){var mw=pm.map(function(w){return Object.assign({size:null,photoUrl:null},w)});setW(mw);ps("w_"+SK,mw);wLoaded=true;break}}catch(e){}}}
    if(!wdLoaded){for(var vk2 of["wd_v12","wd_v11","wd_v9","wd_v8"]){try{var pm2=await loadKey(vk2);if(pm2&&pm2.length){var mg=pm2.map(function(g){return Object.assign({material:null,seasons:[],positionHint:null,lastWorn:null},g)});setWd(mg);ps("wd_"+SK,mg);wdLoaded=true;break}}catch(e){}}}
    if(!ofLoaded){for(var vk3 of["of_v12","of_v11","of_v9","of_v8"]){try{var pm3=await loadKey(vk3);if(pm3&&pm3.length){setSaved(pm3);ps("of_"+SK,pm3);ofLoaded=true;break}}catch(e){}}}
    // Load API key
    try{var ak=await loadKey("wa_apikey");if(ak){setApiKey(ak);apiKeyRef.current=ak}}catch(e){}
    try{var wc=await loadKey("wa_weekctx");if(wc&&wc.length===7)setWeekCtx(wc)}catch(e){}
    try{var ucx=await loadKey("wa_usercx_"+SK);if(ucx&&ucx.length)setUserCx(ucx)}catch(e){}
    try{var wl=await loadKey("wa_wearlog_"+SK);if(wl&&wl.length)setWearLog(wl);else{for(var wlk of["wa_wearlog_v12","wa_wearlog_v11"]){try{var wlm=await loadKey(wlk);if(wlm&&wlm.length){setWearLog(wlm);ps("wa_wearlog_"+SK,wlm);break}}catch(e){}}}}catch(e){}
    try{var rl=await loadKey("wa_rotlock_"+SK);if(rl&&rl.length===7)setRotLock(rl);else{for(var rlk of["wa_rotlock_v12","wa_rotlock_v11"]){try{var rlm=await loadKey(rlk);if(rlm&&rlm.length===7){setRotLock(rlm);ps("wa_rotlock_"+SK,rlm);break}}catch(e){}}}}catch(e){}
    // Auto-onboard if existing data found
    if(wLoaded||wdLoaded)setOnboarded(true);
    try{var ob=await loadKey("wa_onboarded");if(ob)setOnboarded(true)}catch(e){}
    // Load new feature data
    try{var dm=await loadKey("wa_darkmode");if(dm){setDarkMode(true);document.documentElement.setAttribute("data-theme","dark")}}catch(e){}
    try{var pn=await loadKey("wa_profilename");if(pn)setProfileName(pn)}catch(e){}
    try{var pb=await loadKey("wa_profilebio");if(pb)setProfileBio(pb)}catch(e){}
    try{var fv=await loadKey("wa_favorites_"+SK);if(fv&&fv.length)setFavorites(fv)}catch(e){}
    // Init IndexedDB backup
    initIDB().then(function(){restoreFromIDB().then(function(b){if(!b)return;if(!wLoaded&&b.watches&&b.watches.length){setW(b.watches);ps("w_"+SK,b.watches);console.log("Restored watches from IDB")}if(!wdLoaded&&b.wardrobe&&b.wardrobe.length){setWd(b.wardrobe);ps("wd_"+SK,b.wardrobe);console.log("Restored wardrobe from IDB")}})});
  })()},[]);

  useEffect(function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(function(p){setLoc({lat:p.coords.latitude,lon:p.coords.longitude,name:"Your Location"})},function(err){console.log("Location error:",err)},{timeout:5000})}catch(e){console.log("Geolocation not available:",e)}},[]);

  /* â”€â”€ OFFLINE DETECTION â”€â”€ */
  useEffect(function(){
    function goOnline(){document.getElementById("offlineBanner").style.display="none";backupToIDB({watches:W,wardrobe:wd,outfits:saved,favorites:favorites})}
    function goOffline(){document.getElementById("offlineBanner").style.display="block"}
    function onUnload(){backupToIDB({watches:W,wardrobe:wd,outfits:saved,favorites:favorites})}
    window.addEventListener("online",goOnline);window.addEventListener("offline",goOffline);window.addEventListener("beforeunload",onUnload);
    if(!navigator.onLine)document.getElementById("offlineBanner").style.display="block";
    return function(){window.removeEventListener("online",goOnline);window.removeEventListener("offline",goOffline);window.removeEventListener("beforeunload",onUnload)};
  },[W,wd,saved,favorites]);

  /* â”€â”€ KEYBOARD SHORTCUTS â”€â”€ */
  useEffect(function(){
    function handleKey(e){
      if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.tagName==="SELECT")return;
      if(e.key==="Escape"){setEditG(null);setEditW(null);setAddG(false);setShowSettings(false);setSelFit(null);setShowProfile(false);setShowDupes(false);setShowBatch(false);return}
      if((e.ctrlKey||e.metaKey)&&e.key==="s"){e.preventDefault();ps("w_"+SK,W);ps("wd_"+SK,wd);ps("of_"+SK,saved);showToast("âœ“ All data saved","success");return}
      var cxKeys={"1":0,"2":1,"3":2,"4":3,"5":4,"6":5,"7":6,"8":7};
      if(cxKeys[e.key]!==undefined){var cxArr=userCx||(IS_SHARED?SHARE_DEFAULT_CX:DEFAULT_CX);var ci=cxKeys[e.key];if(ci<cxArr.length){setCtx(cxArr[ci].id);setView("fits");setSelFit(null)}}
      if(e.key==="r"||e.key==="R"){setShuffleKey(function(k){return k+1});setSelFit(null)}
      if(e.key==="d"||e.key==="D"){setDarkMode(function(dm){var nv=!dm;document.documentElement.setAttribute("data-theme",nv?"dark":"");ps("wa_darkmode",nv?true:null);return nv})}
    }
    document.addEventListener("keydown",handleKey);
    return function(){document.removeEventListener("keydown",handleKey)};
  },[W,wd,saved,ps,showToast,userCx]);

  /* â”€â”€ PULL TO REFRESH â”€â”€ */
  useEffect(function(){
    var startY=0,pulling=false;
    function onStart(e){if(window.scrollY===0){startY=e.touches[0].clientY;pulling=true}}
    function onMove(e){if(!pulling)return;var delta=e.touches[0].clientY-startY;if(delta>80){pulling=false;setShuffleKey(function(k){return k+1});setSelFit(null);showToast("ðŸŽ² Shuffled!","success")}}
    function onEnd(){pulling=false}
    document.addEventListener("touchstart",onStart,{passive:true});document.addEventListener("touchmove",onMove,{passive:true});document.addEventListener("touchend",onEnd,{passive:true});
    return function(){document.removeEventListener("touchstart",onStart);document.removeEventListener("touchmove",onMove);document.removeEventListener("touchend",onEnd)};
  },[showToast]);
  useEffect(function(){(async function(){try{var r=await fetch("https://api.open-meteo.com/v1/forecast?latitude="+loc.lat+"&longitude="+loc.lon+"&current=temperature_2m,apparent_temperature,wind_speed_10m,relative_humidity_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,weather_code,precipitation_probability_max,uv_index_max,wind_speed_10m_max&timezone=auto&forecast_days=7",{signal:AbortSignal.timeout(10000)});if(!r.ok){console.error("Weather API error:",r.status);return}var d=await r.json();if(d.current){var cwmo=getWMO(d.current.weather_code);setWx({temp:Math.round(d.current.temperature_2m),feels:Math.round(d.current.apparent_temperature),wind:Math.round(d.current.wind_speed_10m),hum:d.current.relative_humidity_2m,code:d.current.weather_code,cond:cwmo})}if(d.daily&&d.daily.time)setForecast(d.daily.time.map(function(dt,i){var wmo=getWMO(d.daily.weather_code?d.daily.weather_code[i]:0);return{date:dt,high:Math.round(d.daily.temperature_2m_max[i]),low:Math.round(d.daily.temperature_2m_min[i]),feelsHigh:Math.round(d.daily.apparent_temperature_max[i]),feelsLow:Math.round(d.daily.apparent_temperature_min[i]),feelsAvg:Math.round((d.daily.apparent_temperature_max[i]+d.daily.apparent_temperature_min[i])/2),code:d.daily.weather_code?d.daily.weather_code[i]:0,cond:wmo,rainPct:d.daily.precipitation_probability_max?d.daily.precipitation_probability_max[i]:0,uv:d.daily.uv_index_max?Math.round(d.daily.uv_index_max[i]):0,wind:d.daily.wind_speed_10m_max?Math.round(d.daily.wind_speed_10m_max[i]):0}}))}catch(e){console.error("Weather fetch error:",e)}})()},[loc]);

  const tier=useMemo(function(){if(planDay===0&&weather)return getWT(weather.feels);if(planDay>0&&forecast[planDay])return getWT(forecast[planDay].feelsAvg);return weather?getWT(weather.feels):null},[weather,forecast,planDay]);
  const ww=tier?tier.weight:"mid";
  const planTemp=useMemo(function(){if(planDay===0&&weather)return{temp:weather.temp,feels:weather.feels};if(forecast[planDay])return{temp:Math.round((forecast[planDay].high+forecast[planDay].low)/2),feels:forecast[planDay].feelsAvg};return weather?{temp:weather.temp,feels:weather.feels}:null},[weather,forecast,planDay]);
  const planWx=useMemo(function(){
    if(planDay===0&&weather)return{rain:weather.cond&&weather.cond.rain,wind:weather.wind,uv:0,cond:weather.cond||null,rainPct:0};
    var fc=forecast[planDay];if(fc)return{rain:fc.cond&&fc.cond.rain,wind:fc.wind,uv:fc.uv,cond:fc.cond||null,rainPct:fc.rainPct||0};
    return null;
  },[weather,forecast,planDay]);
  const effectiveCtx=useMemo(function(){
    if(planDay>0){var dayIdx=(new Date().getDay()+planDay)%7;return weekCtx[dayIdx]||ctx}
    return ctx;
  },[planDay,weekCtx,ctx]);
  const activeCx=useMemo(function(){return userCx||(IS_SHARED?SHARE_DEFAULT_CX:DEFAULT_CX)},[userCx]);
  const activeCxIds=useMemo(function(){return activeCx.map(function(c){return c.id})},[activeCx]);
  const activeCxIcons=useMemo(function(){var m={};activeCx.forEach(function(c){m[c.id]=c.icon});return m},[activeCx]);
  const actW=useMemo(function(){return W.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"})},[W]);
  const byCat=useMemo(function(){return{tops:wd.filter(function(i){return catOf(i.garmentType)==="tops"}),bottoms:wd.filter(function(i){return catOf(i.garmentType)==="bottoms"}),shoes:wd.filter(function(i){return catOf(i.garmentType)==="shoes"})}},[wd]);
  const fits=useMemo(function(){return wd.length<2?[]:genFits(wd,actW,effectiveCtx,reps,ww,fitCount,{topType:topType,lockItem:lockItem,shuffle:shuffleKey>0,wx:planWx,temp:planTemp?planTemp.feels:18})},[wd,actW,effectiveCtx,reps,ww,topType,lockItem,shuffleKey,fitCount,planWx,planTemp]);
  const buildFit=useMemo(function(){var items=[bTop,bBot,bShoe].filter(Boolean);return items.length>=2?makeOutfit(items,actW,effectiveCtx,reps,planWx,planTemp?planTemp.feels:18):null},[bTop,bBot,bShoe,actW,effectiveCtx,reps,planWx,planTemp]);
  const needsFix=useMemo(function(){return wd.filter(function(i){return i.needsEdit||!i.color}).length},[wd]);

  const updateW=useCallback(async function(id,u){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,u):w});ps("w_"+SK,n).then(function(ok){if(ok)showToast("âœ“ Watch saved","success");else showToast("âš  Save failed","error")});return n})},[ps,showToast]);
  const toggleW=useCallback(function(id){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,{active:!w.active}):w});ps("w_"+SK,n);return n})},[ps]);
  const removeW=useCallback(function(id){if(!confirm("Delete this watch?"))return false;var deleted=W.find(function(w){return w.id===id});setW(function(p){var n=p.filter(function(w){return w.id!==id});ps("w_"+SK,n);return n});setUndoStack(function(s){return[{type:"watch",item:deleted,ts:Date.now()}].concat(s).slice(0,5)});showToast("âœ“ Deleted - Tap undo","success");return true},[ps,showToast,W]);

  const saveWd=useCallback(function(n){setWd(n);ps("wd_"+SK,n)},[ps]);
  const rmG=useCallback(function(id){if(!confirm("Delete this garment?"))return false;var deleted=wd.find(function(i){return i.id===id});setWd(function(p){var n=p.filter(function(i){return i.id!==id});ps("wd_"+SK,n);return n});setUndoStack(function(s){return[{type:"garment",item:deleted,ts:Date.now()}].concat(s).slice(0,5)});showToast("âœ“ Deleted - Tap undo","success");return true},[ps,showToast,wd]);
  const updG=useCallback(async function(id,u){setWd(function(p){var n=p.map(function(i){return i.id===id?Object.assign({},i,u,{needsEdit:false}):i});ps("wd_"+SK,n).then(function(ok){if(ok)showToast("âœ“ Garment saved","success");else showToast("âš  Save failed","error")});return n})},[ps,showToast]);
  const addGarment=useCallback(function(item){setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n})},[ps]);

  const undoDelete=useCallback(function(){
    if(!undoStack.length)return;
    var last=undoStack[0];
    if(last.type==="watch"){setW(function(p){var n=p.concat([last.item]);ps("w_"+SK,n);return n});showToast("âœ“ Watch restored","success")}
    else if(last.type==="garment"){setWd(function(p){var n=p.concat([last.item]);ps("wd_"+SK,n);return n});showToast("âœ“ Garment restored","success")}
    setUndoStack(function(s){return s.slice(1)});
  },[undoStack,ps,showToast]);

  const logWear=useCallback(function(watchId,dateStr){
    setWearLog(function(p){
      /* Remove existing entry for same date, then add new */
      var n=p.filter(function(e){return e.date!==dateStr}).concat([{date:dateStr,watchId:watchId,ts:Date.now()}]);
      /* Keep last 90 days only */
      var cutoff=Date.now()-90*24*60*60*1000;
      n=n.filter(function(e){return e.ts>cutoff});
      ps("wa_wearlog_"+SK,n);return n;
    });
  },[ps]);
  const undoWear=useCallback(function(dateStr){
    setWearLog(function(p){var n=p.filter(function(e){return e.date!==dateStr});ps("wa_wearlog_"+SK,n);return n});
  },[ps]);
  const daysSince=useCallback(function(watchId){
    var now=Date.now();var last=null;
    for(var e of wearLog){if(e.watchId===watchId&&(!last||e.ts>last))last=e.ts}
    if(!last)return 999;
    return Math.floor((now-last)/(24*60*60*1000));
  },[wearLog]);
  const todayStr=new Date().toISOString().slice(0,10);
  const todayWorn=wearLog.find(function(e){return e.date===todayStr});

  const processFiles=useCallback(async function(files){
    var arr=Array.from(files);var pids=arr.map(function(_,i){return Date.now()+i});
    setProc(function(p){return p.concat(pids)});
    showToast("ðŸ“¸ Processing "+arr.length+" photo"+(arr.length>1?"s":"")+"...","info");
    for(var i=0;i<arr.length;i++){
      var f=arr[i],pid=pids[i];
      try{
        var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(f)});
        // Compress for AI (600px) and storage thumbnail (400px)
        var compressed=await compressImage(rawUrl,600,0.6);
        var thumb=await compressImage(rawUrl,400,0.5);
        var b64=compressed.split(",")[1];
        var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
        if(aiResult&&Array.isArray(aiResult)&&aiResult.length>0){
          var newItems=aiResult.map(function(ai,idx){var sd=smartDefaults(ai);return Object.assign({},sd,ai,{photoUrl:thumb,id:pid+idx,ts:Date.now(),positionHint:aiResult.length>1?(ai.position||null):null})});
          setWd(function(p){var n=p.concat(newItems);ps("wd_"+SK,n);return n});
          if(aiResult.length>1){showToast("âœ“ Found "+aiResult.length+" items","success")}
          else showToast("âœ“ Item added","success");
        }else{
          var item={garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb,id:pid,needsEdit:true,ts:Date.now(),aiError:getLastAiError()};
          setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n});
          setAiErr(getLastAiError());
          showToast("âš  Needs manual classification","error");
        }
      }catch(e){
        try{var thumb2=await compressImage(await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(f)}),400,0.5);
        setWd(function(p){var n=p.concat([{garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb2,id:pid,needsEdit:true,ts:Date.now(),aiError:"FileReader: "+String(e)}]);ps("wd_"+SK,n);return n})}catch(e2){}
        setAiErr("File error: "+String(e));
        showToast("âœ— Upload failed","error");
      }
      setProc(function(p){return p.filter(function(x){return x!==pid})});
      // Delay between items to avoid rate limit
      if(i<arr.length-1)await new Promise(function(r){setTimeout(r,600)});
    }
  },[ps,showToast]);

  const saveFit=useCallback(function(fit){var wxSnap=planTemp&&planWx?{temp:planTemp.temp,cond:planWx.cond,rain:planWx.rain}:null;var o={id:Date.now(),name:(fit.top?fit.top.name||fit.top.color:"?")+" + "+(fit.bot?fit.bot.name||fit.bot.color:"?"),items:fit.items,context:effectiveCtx,watches:fit.watches,fs:fit.fs,ts:Date.now(),weather:wxSnap};setSaved(function(p){var n=p.concat([o]);ps("of_"+SK,n).then(function(){showToast("âœ“ Outfit saved","success")});return n});/* Auto-update lastWorn on garments */var todayISO=new Date().toISOString().slice(0,10);var itemIds=new Set((fit.items||[]).map(function(it){return it.id}));setWd(function(prev){var changed=false;var nw=prev.map(function(g){if(itemIds.has(g.id)){changed=true;return Object.assign({},g,{lastWorn:todayISO})}return g});if(changed)ps("wd_"+SK,nw);return changed?nw:prev})},[effectiveCtx,ps,planTemp,planWx,showToast]);
  const delSaved=useCallback(function(id){if(!confirm("Delete this saved outfit?"))return;setSaved(function(p){var n=p.filter(function(o){return o.id!==id});ps("of_"+SK,n).then(function(){showToast("âœ“ Outfit deleted","success")});return n})},[ps,showToast]);

  const CTXS=useMemo(function(){return activeCx.slice(0,8).map(function(c){return{id:c.id,l:c.icon+" "+c.l}})},[activeCx]);
  const filtW=wTab==="all"?W:wTab==="genuine"?W.filter(function(w){return w.t==="genuine"}):wTab==="replica"?W.filter(function(w){return w.t==="replica"}):W.filter(function(w){return w.status===wTab});

  /* â•â•â• DAILY TIP â•â•â• */
  const dailyTip=useMemo(function(){var doy=Math.floor((Date.now()-new Date(new Date().getFullYear(),0,0))/86400000);return{text:DAILY_TIPS[doy%DAILY_TIPS.length],icon:TIP_ICONS[doy%TIP_ICONS.length]}},[]);

  /* â•â•â• OOTD GENERATOR â•â•â• */
  const ootd=useMemo(function(){if(wd.length<2||actW.length<1)return null;var today=new Date().toDateString();var seed=0;for(var i=0;i<today.length;i++)seed+=today.charCodeAt(i);var allFits=genFits(wd,actW,effectiveCtx,reps,"mid",30,{topType:"all",lockItem:null,shuffle:false,wx:planWx,temp:planTemp?planTemp.feels:18});if(!allFits.length)return null;return allFits[seed%allFits.length]},[wd,actW,effectiveCtx,reps,planWx,planTemp]);

  /* â•â•â• STYLE DNA SCORES â•â•â• */
  const dnaScores=useMemo(function(){var scores={};DNA_DIMS.forEach(function(d){scores[d]=5});if(saved.length>0){var recent=saved.slice(-15);DNA_DIMS.forEach(function(d){scores[d]=0});recent.forEach(function(o){var vs=CX_DNA[o.context]||CX_DNA["casual"];DNA_DIMS.forEach(function(d){scores[d]+=vs[d]||5})});DNA_DIMS.forEach(function(d){scores[d]=Math.round(scores[d]/recent.length)})}return scores},[saved]);

  /* â•â•â• FAVORITES â•â•â• */
  const toggleFav=useCallback(function(fitId){setFavorites(function(prev){var exists=prev.findIndex(function(f){return f.id===fitId});var next;if(exists>=0){next=prev.filter(function(_,i){return i!==exists});showToast("Removed from favorites","info")}else{var fit=fits.find(function(f){return f.id===fitId})||saved.find(function(o){return o.id===fitId});if(fit){next=prev.concat([Object.assign({},fit,{favTs:Date.now()})]);showToast("â­ Added to favorites","success")}else{next=prev}}ps("wa_favorites_"+SK,next);return next})},[fits,saved,ps,showToast]);
  const isFav=useCallback(function(fitId){return favorites.some(function(f){return f.id===fitId})},[favorites]);

  /* â•â•â• DARK MODE TOGGLE â•â•â• */
  const toggleDark=useCallback(function(){setDarkMode(function(dm){var nv=!dm;document.documentElement.setAttribute("data-theme",nv?"dark":"");ps("wa_darkmode",nv?true:null);return nv})},[ps]);

  /* â•â•â• SURPRISE ME â•â•â• */
  const surpriseMe=useCallback(function(){setShuffleKey(function(k){return k+1});setSelFit(null);setView("fits");showToast("ðŸŽ² Surprise!","success")},[showToast]);

  /* â•â•â• PROFILE â•â•â• */
  const saveProfile=useCallback(function(name,bio){setProfileName(name);setProfileBio(bio);ps("wa_profilename",name);ps("wa_profilebio",bio);showToast("âœ“ Profile saved","success")},[ps,showToast]);

  /* â•â•â• COMPOSITE IMAGE â•â•â• */
  const drawComposite=useCallback(function(fit){if(!fit)return;var canvas=document.createElement("canvas");var S=300;canvas.width=S;canvas.height=S;var cx=canvas.getContext("2d");var dk=darkMode;cx.fillStyle=dk?"#12101a":"#f6f6f9";cx.fillRect(0,0,S,S);cx.fillStyle=dk?"#e0dcd4":"#1a1814";cx.font="bold 14px DM Sans, sans-serif";cx.textAlign="center";var name=(fit.top?fit.top.name||fit.top.color:"")+" + "+(fit.bot?fit.bot.name||fit.bot.color:"");cx.fillText(name.length>30?name.slice(0,28)+"â€¦":name,S/2,24);var items=(fit.items||[]).filter(Boolean);var cols=Math.min(items.length,3);var rows=Math.ceil(items.length/cols);var cw=(S-40)/cols,ch=(S-50)/rows;items.forEach(function(item,i){var col=i%cols,row=Math.floor(i/cols);var x=20+col*cw,y=40+row*ch;var ce=Object.entries(CM).find(function(e){return(item.color||"").toLowerCase().includes(e[0])});var hex=ce?ce[1].h:"#888";cx.fillStyle=hex+"33";cx.beginPath();cx.roundRect(x+3,y+3,cw-6,ch-6,10);cx.fill();cx.fillStyle=dk?"#e0dcd4":"#1a1814";cx.font="bold 11px DM Sans";cx.fillText(item.garmentType||"",x+cw/2,y+ch/2-6);cx.font="10px DM Sans";cx.fillText((item.color||"").slice(0,12),x+cw/2,y+ch/2+10)});setCompositeData(canvas.toDataURL("image/png"))},[darkMode]);

  /* â•â•â• STYLE DNA RADAR DRAW â•â•â• */
  const drawRadar=useCallback(function(canvasId){var canvas=document.getElementById(canvasId);if(!canvas)return;var cx=canvas.getContext("2d");var W2=canvas.width,H=canvas.height;var cxr=W2/2,cy=H/2,R=Math.min(W2,H)/2-28;var dims=DNA_DIMS;var vals=dims.map(function(d){return dnaScores[d]||5});cx.clearRect(0,0,W2,H);for(var r=2;r<=10;r+=2){cx.beginPath();dims.forEach(function(_,i){var angle=(Math.PI*2*i)/dims.length-Math.PI/2;var x=cxr+Math.cos(angle)*(R*r/10);var y=cy+Math.sin(angle)*(R*r/10);i===0?cx.moveTo(x,y):cx.lineTo(x,y)});cx.closePath();cx.strokeStyle=darkMode?"#2a2530":"#ddd8d0";cx.stroke()}dims.forEach(function(d,i){var angle=(Math.PI*2*i)/dims.length-Math.PI/2;cx.beginPath();cx.moveTo(cxr,cy);cx.lineTo(cxr+Math.cos(angle)*R,cy+Math.sin(angle)*R);cx.strokeStyle=darkMode?"#2a2530":"#ddd8d0";cx.stroke();var lx=cxr+Math.cos(angle)*(R+16);var ly=cy+Math.sin(angle)*(R+16);cx.fillStyle=darkMode?"#7a7484":"#6a6458";cx.font="9px DM Sans, sans-serif";cx.textAlign="center";cx.textBaseline="middle";cx.fillText(d,lx,ly)});cx.beginPath();dims.forEach(function(_,i){var angle=(Math.PI*2*i)/dims.length-Math.PI/2;var v=(vals[i]/10)*R;var x=cxr+Math.cos(angle)*v,y=cy+Math.sin(angle)*v;i===0?cx.moveTo(x,y):cx.lineTo(x,y)});cx.closePath();cx.fillStyle="rgba(201,168,76,0.15)";cx.fill();cx.strokeStyle="var(--gold)";cx.strokeStyle="#c9a84c";cx.lineWidth=2;cx.stroke();dims.forEach(function(_,i){var angle=(Math.PI*2*i)/dims.length-Math.PI/2;var v=(vals[i]/10)*R;cx.beginPath();cx.arc(cxr+Math.cos(angle)*v,cy+Math.sin(angle)*v,4,0,Math.PI*2);cx.fillStyle="#c9a84c";cx.fill()})},[dnaScores,darkMode]);

  /* â•â•â• AI INSIGHTS â•â•â• */
  const fetchAiInsights=useCallback(async function(){if(aiInsightsLoading)return;var ak=apiKeyRef.current;if(!ak||ak.trim().length<5){showToast("Set API key in Settings","error");return}setAiInsightsLoading(true);setAiInsights(null);try{var hist=saved.slice(-20).map(function(o){return(o.name||"outfit")+" ("+o.context+")"}).join(", ");var ward=wd.slice(0,30).map(function(i){return(i.name||i.garmentType)+" ("+i.color+")"}).join(", ");var wList=W.filter(function(w){return w.active}).map(function(w){return w.n+" ("+w.t+")"}).join(", ");var resp=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":ak.trim(),"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:600,messages:[{role:"user",content:"Style analyst for a watch enthusiast. Watches: "+wList+". Wardrobe: "+(ward||"not populated")+". Recent outfits: "+(hist||"none")+".\nGive 4 insights as JSON: [{\"icon\":\"emoji\",\"title\":\"short\",\"insight\":\"2-3 sentences\",\"action\":\"suggestion\"}]\nFocus: watch-outfit pairing gaps, color balance, versatility, genuine vs replica deployment strategy."}]})});if(!resp.ok)throw new Error("API "+resp.status);var data=await resp.json();var m=data.content[0].text.match(/\[[\s\S]*\]/);if(!m)throw new Error("No JSON");setAiInsights(JSON.parse(m[0]))}catch(err){showToast("AI insights failed: "+err.message,"error")}finally{setAiInsightsLoading(false)}},[saved,wd,W,showToast]);

  /* â•â•â• BATCH IMAGE UPLOAD â•â•â• */
  const processBatch=useCallback(async function(files){if(batchProcessing)return;var ak=apiKeyRef.current;if(!ak){showToast("Set API key in Settings","error");return}setBatchProcessing(true);setBatchResults([]);var total=Math.min(files.length,10);var results=[];for(var i=0;i<total;i++){try{var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(files[i])});var compressed=await compressImage(rawUrl,600,0.6);var b64=compressed.split(",")[1];var resp=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":ak.trim(),"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:200,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:"image/jpeg",data:b64}},{type:"text",text:"Identify this clothing item. Return ONLY JSON: {\"garmentType\":\"Shirt|Polo|T-Shirt|Sweater/Knit|Jacket/Blazer|Pants/Trousers|Chinos|Jeans|Shorts|Shoes\",\"name\":\"2-3 words\",\"color\":\"one from: "+AC.join(",")+"\",\"pattern\":\"solid|plaid|striped|checked|print|textured\"}"}]}]})});if(!resp.ok)throw new Error("API "+resp.status);var data=await resp.json();var m=data.content[0].text.match(/\{[\s\S]*\}/);if(m){var r2=JSON.parse(m[0]);results.push(Object.assign({},r2,{selected:true,thumb:await compressImage(rawUrl,200,0.4)}))}if(i<total-1)await new Promise(function(r){setTimeout(r,600)})}catch(err){console.error("Batch item:",err)}}setBatchResults(results);setBatchProcessing(false);showToast("âœ“ Found "+results.length+" items","success")},[showToast]);
  const confirmBatch=useCallback(function(){var added=0;var newItems=batchResults.filter(function(r){return r.selected}).map(function(r,i){var sd=smartDefaults(r);return Object.assign({},sd,r,{photoUrl:r.thumb||null,id:Date.now()+i,ts:Date.now()})});setWd(function(p){var n=p.concat(newItems);ps("wd_"+SK,n);return n});added=newItems.length;setBatchResults([]);setShowBatch(false);showToast("âœ“ Added "+added+" items","success")},[batchResults,ps,showToast]);

  /* â•â•â• LOCATION VIBE FILTER â•â•â• */
  const selectLocVibe=useCallback(function(loc){if(locVibe===loc){setLocVibe(null);return}setLocVibe(loc);var vibes=LOC_VIBES[loc];if(vibes&&vibes.length){setCtx(vibes[0]);showToast("ðŸ“ "+loc+" mode","info")}},[locVibe,showToast]);

  /* â•â•â• GARMENT EDIT (rendered in modal) â•â•â• */
  function renderGarmentEdit(item){
    var GE=function(){
      const[f,setF]=useState(Object.assign({},item));
      const[retrying,setRetrying]=useState(false);
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      var retry=async function(){
        if(!item.photoUrl)return;setRetrying(true);
        try{var compressed=await compressImage(item.photoUrl,600,0.6);var b64=compressed.split(",")[1];
          var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
          if(aiResult&&aiResult.length){var first=aiResult[0];setF(function(p){return Object.assign({},p,first)})}
          else alert(getLastAiError()||"AI couldn't identify. Classify manually.")}catch(e){alert("Retry error: "+e)}
        setRetrying(false);
      };
      return React.createElement(Modal,{onClose:function(){setEditG(null)}},
        React.createElement("div",{style:{display:"flex",gap:14,marginBottom:16}},
          f.photoUrl&&React.createElement("img",{src:f.photoUrl,alt:"",style:{width:80,height:80,objectFit:"cover",borderRadius:12,flexShrink:0}}),
          React.createElement("div",{style:{flex:1}},
            React.createElement("label",{className:"lbl"},"Name"),
            React.createElement("input",{className:"inp",value:f.name||"",onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy plaid flannel"}))),
        React.createElement("label",{className:"lbl"},"Garment Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},
          f.color&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:8}},React.createElement(Dot,{color:f.color,size:14}),React.createElement("span",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:500}},f.color)),
          React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:14}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){set("material",f.material===m?null:m)},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("label",{className:"lbl"},"Seasons"),
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:16}},
          ["spring","summer","fall","winter"].map(function(s){var icons={spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"};var arr=f.seasons||[];var on=arr.includes(s);return React.createElement("span",{key:s,className:"chip "+(on?"on":""),onClick:function(){set("seasons",on?arr.filter(function(x){return x!==s}):arr.concat([s]))},style:{flex:1,justifyContent:"center",padding:"6px 4px",fontSize:10}},icons[s]+" "+s)})),
        React.createElement("label",{className:"lbl"},"Last Worn"),
        React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:14}},
          React.createElement("input",{className:"inp",type:"date",value:f.lastWorn||"",onChange:function(e){set("lastWorn",e.target.value)},style:{marginBottom:0,maxWidth:180,fontSize:11,flex:1}}),
          React.createElement("button",{onClick:function(){set("lastWorn",new Date().toISOString().slice(0,10))},style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28,whiteSpace:"nowrap"}},"ðŸ‘• Today"),
          f.lastWorn&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d<=2?"var(--warn)":d<=7?"var(--gold)":"var(--good)"})()}},(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d===0?"today":d===1?"yesterday":d+"d ago"})())),
        item.ts&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:8,display:"flex",gap:12,flexWrap:"wrap"}},
          React.createElement("span",null,"Added: "+new Date(item.ts).toLocaleDateString()),
          f.lastWorn&&React.createElement("span",null,"Last worn: "+new Date(f.lastWorn).toLocaleDateString()),
          saved.some(function(o){return(o.items||[]).some(function(it){return it.id===item.id})})&&React.createElement("span",{style:{color:"var(--good)"}},"âœ“ Used in "+saved.filter(function(o){return(o.items||[]).some(function(it){return it.id===item.id})}).length+" saved outfit(s)")),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){if(!f.color){alert("Pick a color");return}updG(item.id,f);setEditG(null)}},"âœ“ Save"),
          f.color&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){if(!f.color){alert("Pick a color");return}updG(item.id,f);setLockItem(Object.assign({},item,f));setEditG(null);setView("fits");setMode("auto")},title:"Lock for fits"},"ðŸ”’"),
          item.photoUrl&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:retry,disabled:retrying},retrying?"â³":"ðŸ”„"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){var dup=Object.assign({},f,{id:Date.now(),ts:Date.now(),name:(f.name||"")+" copy"});addGarment(dup);setEditG(null)},title:"Duplicate"},"ðŸ“‹"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){if(rmG(item.id))setEditG(null)}},"ðŸ—‘ï¸")));
    };
    return React.createElement(GE,{key:item.id});
  }

  /* â•â•â• QUICK ADD â•â•â• */
  function renderQuickAdd(){
    var QA=function(){
      const[f,setF]=useState({garmentType:"Shirt",name:"",color:"",pattern:"solid"});
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      return React.createElement(Modal,{onClose:function(){setAddG(false)}},
        React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:14}},"Quick Add"),
        React.createElement("label",{className:"lbl"},"Name"),
        React.createElement("input",{className:"inp",value:f.name,onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy chinos",style:{marginBottom:12}}),
        React.createElement("label",{className:"lbl"},"Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:16}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:16}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){setF(function(p){return Object.assign({},p,{material:p.material===m?null:m})})},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){if(!f.color||!f.name){alert("Need name + color");return}var sd=smartDefaults(f);addGarment(Object.assign({},sd,f,{id:Date.now(),ts:Date.now()}));setAddG(false)}},
          "+ Add to Wardrobe"));
    };
    return React.createElement(QA,null);
  }

  /* â•â•â• WATCH EDIT â•â•â• */
  function renderWatchEdit(w){
    var WE=function(){
      const[f,setF]=useState(Object.assign({},w));
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      var togArr=function(k,v){setF(function(p){var arr=p[k]||[];var o={};o[k]=arr.includes(v)?arr.filter(function(x){return x!==v}):arr.concat([v]);return Object.assign({},p,o)})};
      var wPhotoRef=useRef();
      var handleWPhoto=async function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=async function(e){var fl=e.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,300,0.6);set("photoUrl",compressed)};inp.click()};
      return React.createElement(Modal,{onClose:function(){setEditW(null)}},
        React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:14}},
          React.createElement("div",{onClick:handleWPhoto,style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",overflow:"hidden",flexShrink:0,border:"2px solid "+(f.photoUrl?"var(--gold)":"var(--border)"),background:f.photoUrl?"none":f.c+"20"}},
            f.photoUrl?React.createElement("img",{src:f.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("span",{style:{fontSize:28}},f.i)),
          React.createElement("div",{style:{flex:1}},React.createElement("input",{className:"inp",value:f.n,onChange:function(e){set("n",e.target.value)},style:{fontWeight:600,border:"none",padding:0,background:"transparent"}})),
          f.photoUrl&&React.createElement("button",{onClick:function(){set("photoUrl",null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--dim)",fontSize:9,fontFamily:"var(--f)"}},"\u2715")),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:12}},
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Dial Color"),React.createElement("input",{className:"inp",value:f.d,onChange:function(e){set("d",e.target.value);if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:e.target.value,mc:autoMatchColors(e.target.value)})})}},style:{marginBottom:4}}),
            React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},["Black","White","Blue","Green","Silver","Grey","Champagne","Ivory"].map(function(dc){return React.createElement("span",{key:dc,onClick:function(){set("d",dc);set("c",(CM[dc.toLowerCase()]||{}).h||"#5a5a5a");if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:dc,c:(CM[dc.toLowerCase()]||{}).h||"#5a5a5a",mc:autoMatchColors(dc)})})}},style:{fontSize:8,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,cursor:"pointer",background:f.d===dc?"rgba(201,168,76,0.2)":"var(--bg)",border:"1px solid "+(f.d===dc?"rgba(201,168,76,0.3)":"var(--border)"),color:f.d===dc?"var(--gold)":"var(--dim)"}},dc)}))),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Type"),React.createElement("select",{className:"sel",value:f.t,onChange:function(e){set("t",e.target.value)}},React.createElement("option",{value:"genuine"},"Genuine"),React.createElement("option",{value:"replica"},"Replica"))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Status"),React.createElement("select",{className:"sel",value:f.status,onChange:function(e){set("status",e.target.value)}},STS.map(function(s){return React.createElement("option",{key:s.id,value:s.id},s.l)}))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Case Size"),React.createElement("input",{className:"inp",value:f.size||"",onChange:function(e){set("size",e.target.value)},placeholder:"e.g. 40mm"})),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Temp"),React.createElement("select",{className:"sel",value:f.mt,onChange:function(e){set("mt",e.target.value)}},React.createElement("option",{value:"cool"},"Cool"),React.createElement("option",{value:"warm"},"Warm"),React.createElement("option",{value:"mixed"},"Mixed")))),
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:12}},
          React.createElement("button",{onClick:function(){set("br",!f.br)},style:{flex:1,background:f.br?"rgba(201,168,76,0.1)":"var(--bg)",border:"1px solid "+(f.br?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:8,padding:12,color:f.br?"var(--gold)":"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44}},f.br?"â›“ï¸ Bracelet":"ðŸ”— Strap"),
          !f.br&&React.createElement("input",{className:"inp",value:(f.sc||[]).join(", "),onChange:function(e){set("sc",e.target.value.split(",").map(function(x){return x.trim()}).filter(Boolean))},placeholder:"grey, navy...",style:{flex:2}})),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Match Colors"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,maxHeight:100,overflowY:"auto",marginBottom:12}},AC.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.mc||[]).includes(c)?"on":""),onClick:function(){togArr("mc",c)}},React.createElement(Dot,{color:c,size:6}),c)})),
        React.createElement("label",{className:"lbl"},"Contexts"),
        React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,marginBottom:12}},activeCxIds.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.cx||[]).includes(c)?"on":""),onClick:function(){togArr("cx",c)}},(activeCxIcons[c]||"")+" "+c)})),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Weather"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",gap:6,marginBottom:12}},"light,mid,heavy".split(",").map(function(x){return React.createElement("span",{key:x,className:"chip "+((f.wt||[]).includes(x)?"on":""),onClick:function(){togArr("wt",x)},style:{flex:1,justifyContent:"center"}},(x==="light"?"â˜€ï¸":x==="mid"?"ðŸŒ¤ï¸":"ðŸ§¥")+" "+x)})),
        React.createElement("label",{className:"lbl"},"Emoji"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:14}},EMOJIS.map(function(e){return React.createElement("span",{key:e,onClick:function(){set("i",e)},style:{fontSize:22,cursor:"pointer",opacity:f.i===e?1:0.25,padding:3,minWidth:30,textAlign:"center"}},e)})),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){var sv=IS_SHARED&&(!f.mc||!f.mc.length)?Object.assign({},f,{mc:autoMatchColors(f.d)}):f;updateW(w.id,sv);setEditW(null)}},"Save"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 20px"},onClick:function(){if(removeW(w.id))setEditW(null)}},"ðŸ—‘ï¸")));
    };
    return React.createElement(WE,{key:w.id});
  }

  /* â•â•â• ONBOARDING (shared version only) â•â•â• */
  if(!onboarded){
    var obDotStyle=function(s){return{width:8,height:8,borderRadius:"50%",background:onboardStep>=s?"var(--gold)":"var(--border)"}};
    var obFinish=function(){
      var nw=obWatches.map(function(pw){return Object.assign({},pw,{id:pw.id+"-"+Date.now()+Math.random().toString(36).slice(2,5),active:true,status:"active",t:"genuine"})});
      var ng=obGarments.map(function(pg){var sd=smartDefaults(pg);return Object.assign({},sd,pg,{id:"g-"+Date.now()+Math.random().toString(36).slice(2,5),ts:Date.now()})});
      if(nw.length){setW(nw);ps("w_"+SK,nw)}
      if(ng.length){setWd(ng);ps("wd_"+SK,ng)}
      setOnboarded(true);ps("wa_onboarded",true);
    };
    /* Step 1: Watches */
    if(onboardStep===1){
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"âŒš"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Watches"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap to add watches you own. You can customize later."),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,width:"100%",maxWidth:340,marginBottom:16}},
          WATCH_PRESETS.map(function(wp){
            var sel=obWatches.some(function(o){return o.id===wp.id});
            return React.createElement("button",{key:wp.id,onClick:function(){setObWatches(function(prev){return sel?prev.filter(function(o){return o.id!==wp.id}):prev.concat([wp])})},
              style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",borderRadius:10,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",textAlign:"left"}},
              React.createElement("span",{style:{fontSize:20}},wp.i),
              React.createElement("div",null,
                React.createElement("div",{style:{fontSize:12,fontWeight:600,color:"var(--tx)"}},wp.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},wp.d+" dial")))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(2)}},obWatches.length?"Next ("+obWatches.length+" selected)":"Skip"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px",fontSize:11},onClick:function(){
            var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){
              var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){
                try{var d=JSON.parse(r.result);if(d.watches){setW(d.watches);ps("w_"+SK,d.watches)}if(d.wardrobe){setWd(d.wardrobe);ps("wd_"+SK,d.wardrobe)}if(d.outfits){setSaved(d.outfits);ps("of_"+SK,d.outfits)}if(d.wearLog){setWearLog(d.wearLog);ps("wa_wearlog_"+SK,d.wearLog)}if(d.weekCtx&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.favorites&&d.favorites.length){setFavorites(d.favorites);ps("wa_favorites_"+SK,d.favorites)}setOnboarded(true);ps("wa_onboarded",true)}catch(ex){alert("Invalid file")}};r.readAsText(f)};inp.click()
          }},"ðŸ“¥ Import")));
    }
    /* Step 2: Closet */
    if(onboardStep===2){
      var gTypes=["Tops","Bottoms","Shoes"];
      var gGroups={Tops:GARMENT_PRESETS.filter(function(g){return["Shirt","T-Shirt","Polo","Sweater/Knit"].includes(g.garmentType)}),Bottoms:GARMENT_PRESETS.filter(function(g){return["Chinos","Jeans","Shorts","Pants/Trousers"].includes(g.garmentType)}),Shoes:GARMENT_PRESETS.filter(function(g){return g.garmentType==="Shoes"})};
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"ðŸ‘”"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Closet"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap garments you own. You can add photos and more items later."),
        gTypes.map(function(gt){return React.createElement("div",{key:gt,style:{width:"100%",maxWidth:340,marginBottom:12}},
          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)",marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}},gt),
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:6}},
            gGroups[gt].map(function(gp){
              var gKey=gp.garmentType+"-"+gp.color;
              var sel=obGarments.some(function(o){return o.garmentType===gp.garmentType&&o.color===gp.color});
              return React.createElement("button",{key:gKey,onClick:function(){setObGarments(function(prev){return sel?prev.filter(function(o){return!(o.garmentType===gp.garmentType&&o.color===gp.color)}):prev.concat([gp])})},
                style:{padding:"6px 12px",borderRadius:20,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",fontSize:11,fontFamily:"var(--f)",color:sel?"var(--gold)":"var(--tx)"}},gp.name)
            })))}),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:8}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(1)}},"â† Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(3)}},obGarments.length?"Next ("+obGarments.length+" items)":"Skip")));
    }
    /* Step 3: Week context */
    if(onboardStep===3){
      var ctxNames=activeCxIds.length?activeCxIds:["casual","clinic","smart-casual","formal","weekend","travel","date","riviera"];
      var dayNames=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"ðŸ“…"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Week"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Set the vibe for each day. This helps match outfits to your schedule."),
        React.createElement("div",{style:{width:"100%",maxWidth:340}},
          dayNames.map(function(dn,di){
            return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{width:32,fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)"}},dn),
              React.createElement("select",{value:weekCtx[di],onChange:function(e){setWeekCtx(function(p){var n=p.slice();n[di]=e.target.value;return n})},
                style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border)",background:"var(--card)",color:"var(--tx)",fontFamily:"var(--f)",fontSize:12}},
                ctxNames.map(function(cx){return React.createElement("option",{key:cx,value:cx},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:12}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(2)}},"â† Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_weekctx",weekCtx);obFinish()}},"âœ¨ Start Pairing")));
    }
  }

  /* â•â•â• RENDER â•â•â• */
  return React.createElement("div",{style:{minHeight:"100vh"},onDragOver:function(e){e.preventDefault()},onDrop:function(e){e.preventDefault();if(view==="wardrobe")processFiles(e.dataTransfer.files)}},
    editG&&renderGarmentEdit(editG),
    editW&&renderWatchEdit(editW),
    addG&&renderQuickAdd(),
    showSettings&&React.createElement(Modal,{onClose:function(){setShowSettings(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"âš™ï¸ Settings"),
      React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:16}},"AI photo classification works automatically inside Claude.ai. To use it in a standalone browser, add your Anthropic API key below."),
      React.createElement("label",{className:"lbl"},"Anthropic API Key"),
      React.createElement("input",{className:"inp",type:"password",value:apiKey,onChange:function(e){setApiKey(e.target.value);apiKeyRef.current=e.target.value},placeholder:"sk-ant-...",style:{marginBottom:12,fontFamily:"monospace"}}),
      React.createElement("div",{style:{display:"flex",gap:8,marginBottom:16}},
        React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_apikey",apiKey).then(function(){showToast("âœ“ API key saved","success")});apiKeyRef.current=apiKey;setShowSettings(false)}},"ðŸ’¾ Save Key"),
        apiKey&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setApiKey("");apiKeyRef.current="";ps("wa_apikey","").then(function(){showToast("âœ“ API key cleared","success")})}},"Clear")),
      React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",border:"1px solid var(--border)"}},
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"â„¹ï¸ Get your key at console.anthropic.com â†’ API Keys"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"Cost: ~$0.01 per photo (Sonnet vision)"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:apiKey?"var(--good)":"var(--warn)",margin:0,fontWeight:500}},apiKey?"âœ“ Key configured â€” AI classification active":"âœ— No key â€” manual classification only outside Claude.ai")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Context Categories"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:6,marginBottom:8}},
          activeCx.map(function(c){return React.createElement("span",{key:c.id,className:"chip on",style:{gap:6}},c.icon+" "+c.l,
            React.createElement("span",{onClick:function(e){e.stopPropagation();var n=activeCx.filter(function(x){return x.id!==c.id});if(n.length<2)return;setUserCx(n);ps("wa_usercx_"+SK,n)},style:{cursor:"pointer",color:"var(--warn)",fontSize:10,marginLeft:2}},"âœ•"))})),
        React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8}},
          React.createElement("input",{id:"newCxName",className:"inp",placeholder:"New context name",style:{flex:1,fontSize:11,padding:"6px 10px"}}),
          React.createElement("input",{id:"newCxIcon",className:"inp",placeholder:"Emoji",style:{width:50,fontSize:14,textAlign:"center",padding:"6px"}}),
          React.createElement("button",{onClick:function(){var nameEl=document.getElementById("newCxName");var iconEl=document.getElementById("newCxIcon");var nm=(nameEl?nameEl.value:"").trim();var ic=(iconEl?iconEl.value:"").trim()||"ðŸ“Œ";if(!nm)return;var nid=nm.toLowerCase().replace(/\s+/g,"-");var n=(userCx||activeCx).concat([{id:nid,l:nm,icon:ic}]);setUserCx(n);ps("wa_usercx_"+SK,n);if(nameEl)nameEl.value="";if(iconEl)iconEl.value=""},style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontFamily:"var(--f)",fontSize:11,fontWeight:600}},"+Add")),
        React.createElement("button",{onClick:function(){setUserCx(null);ps("wa_usercx_"+SK,null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"6px 12px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,marginBottom:8}},"Reset to Defaults")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Data Management"),
        React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:6}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var data=JSON.stringify({watches:W,wardrobe:wd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,favorites:favorites});var blob=new Blob([data],{type:"application/json"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="watch-advisor-backup.json";a.click();showToast("âœ“ Data exported","success")}},"ðŸ“¤ Export"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){if(!confirm("Import will replace all current data. Export a backup first?"))return;var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{var d=JSON.parse(r.result);var valid=true;if(!d||typeof d!=="object"){valid=false}if(d.watches&&!Array.isArray(d.watches)){valid=false}if(d.wardrobe&&!Array.isArray(d.wardrobe)){valid=false}if(d.outfits&&!Array.isArray(d.outfits)){valid=false}if(!valid){showToast("âœ— Invalid backup file format","error");return}if(d.watches){setW(d.watches);ps("w_"+SK,d.watches)}if(d.wardrobe){setWd(d.wardrobe);ps("wd_"+SK,d.wardrobe)}if(d.outfits){setSaved(d.outfits);ps("of_"+SK,d.outfits)}if(d.wearLog){setWearLog(d.wearLog);ps("wa_wearlog_"+SK,d.wearLog)}if(d.weekCtx&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.favorites&&d.favorites.length){setFavorites(d.favorites);ps("wa_favorites_"+SK,d.favorites)}var imported=[];if(d.watches)imported.push(d.watches.length+" watches");if(d.wardrobe)imported.push(d.wardrobe.length+" garments");if(d.outfits)imported.push(d.outfits.length+" outfits");showToast("âœ“ Imported: "+imported.join(", "),"success")}catch(e){showToast("âœ— Import failed: "+String(e.message||"Invalid JSON"),"error")}};r.readAsText(f)};inp.click()}},"ðŸ“¥ Import")))),

    /* TOAST NOTIFICATION */
    toast&&React.createElement("div",{onClick:function(){if(toast.msg.includes("undo")&&undoStack.length>0){undoDelete()}else{setToast(null)}},style:{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",zIndex:999,background:toast.type==="success"?"rgba(122,184,122,0.95)":toast.type==="error"?"rgba(200,90,58,0.95)":"rgba(201,168,76,0.95)",color:"#fff",padding:"12px 20px",borderRadius:10,fontSize:13,fontFamily:"var(--f)",fontWeight:600,boxShadow:"0 4px 12px rgba(0,0,0,0.3)",animation:"slideDown .3s ease",maxWidth:"90vw",textAlign:"center",cursor:toast.msg.includes("undo")?"pointer":"default"}},toast.msg,toast.msg.includes("undo")&&React.createElement("span",{style:{marginLeft:8,textDecoration:"underline"}},"UNDO")),

    /* HEADER */
    React.createElement("div",{style:{background:"linear-gradient(180deg,#110f1a,var(--bg))",borderBottom:"1px solid var(--border)",padding:"max(env(safe-area-inset-top,12px),12px) 16px 0"}},
      React.createElement("div",{style:{maxWidth:860,margin:"0 auto"}},
        React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},
          React.createElement("h1",{style:{fontSize:20,fontWeight:300,letterSpacing:"0.14em",color:"var(--gold)"}},"WATCH ADVISOR"),
          React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center"}},
            React.createElement("button",{onClick:surpriseMe,style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--sub)",fontSize:14,minHeight:32},title:"Surprise Me (R)"},"ðŸŽ²"),
            React.createElement("button",{onClick:toggleDark,style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--sub)",fontSize:14,minHeight:32},title:"Dark/Light Mode (D)"},darkMode?"â˜€ï¸":"ðŸŒ™"),
            React.createElement("button",{onClick:function(){setShowProfile(true)},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--sub)",fontSize:14,minHeight:32},title:"Profile"},profileName?profileName.charAt(0).toUpperCase():"ðŸ‘¤"),
            React.createElement("button",{onClick:function(){setShowSettings(true)},style:{background:"none",border:"1px solid "+(apiKey?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:8,padding:"6px 10px",cursor:"pointer",color:apiKey?"var(--good)":"var(--dim)",fontSize:14,minHeight:32}},apiKey?"ðŸ”‘":"âš™ï¸"))),
        React.createElement("div",{style:{display:"flex",gap:0,marginTop:6},className:"hscroll"},
          [{id:"wardrobe",l:"ðŸ‘• CLOSET",c:wd.length},{id:"fits",l:"âœ¨ FITS",c:0},{id:"insights",l:"ðŸ”® INSIGHTS",c:0},{id:"watches",l:"âŒš WATCHES",c:actW.length},{id:"saved",l:"ðŸ’¾ SAVED",c:saved.length},{id:"favs",l:"â­ FAVS",c:favorites.length}].map(function(t){
            return React.createElement("button",{key:t.id,onClick:function(){setView(t.id);setSelFit(null)},style:{background:"none",border:"none",borderBottom:view===t.id?"2px solid var(--gold)":"2px solid transparent",color:view===t.id?"var(--gold)":"#5a5464",padding:"10px 14px",fontFamily:"var(--f)",fontSize:10,fontWeight:500,letterSpacing:"0.1em",cursor:"pointer",whiteSpace:"nowrap",flexShrink:0,minHeight:40}},
              t.l+(t.c>0?" "+t.c:""))})))),

    React.createElement("div",{style:{maxWidth:860,margin:"0 auto",padding:"0 16px"}},

      /* â•â•â• WARDROBE â•â•â• */
      view==="wardrobe"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* Daily Tip */
        React.createElement("div",{className:"tip-card"},
          React.createElement("span",{className:"tip-icon"},dailyTip.icon),
          React.createElement("span",{className:"tip-text"},dailyTip.text)),

        /* Batch Upload Zone */
        React.createElement("div",{className:"batch-zone"+(showBatch?" dragover":""),onClick:function(){if(!showBatch){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.multiple=true;inp.onchange=function(e){var files=Array.from(e.target.files||[]).filter(function(f){return f.type.startsWith("image/")});if(files.length){setShowBatch(true);processBatch(files)}};inp.click()}},onDragOver:function(e){e.preventDefault()},onDrop:function(e){e.preventDefault();var files=Array.from(e.dataTransfer.files).filter(function(f){return f.type.startsWith("image/")});if(files.length){setShowBatch(true);processBatch(files)}}},
          !showBatch&&React.createElement(React.Fragment,null,
            React.createElement("div",{style:{fontSize:24,marginBottom:4}},"ðŸ“¸"),
            React.createElement("div",{style:{fontFamily:"var(--f)",fontSize:11,color:"var(--sub)"}},"Batch Upload â€” Drop photos or tap to select multiple")),
          showBatch&&batchProcessing&&React.createElement("div",{style:{fontFamily:"var(--f)",fontSize:12,color:"var(--gold)"}},"â³ Processing "+batchResults.length+" items..."),
          showBatch&&!batchProcessing&&batchResults.length>0&&React.createElement("div",{style:{textAlign:"left"}},
            batchResults.map(function(r,i){return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"6px 0",borderBottom:"1px solid var(--border)"}},
              React.createElement("input",{type:"checkbox",checked:r.selected,onChange:function(){setBatchResults(function(prev){var n=prev.slice();n[i]=Object.assign({},n[i],{selected:!n[i].selected});return n})}}),
              React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600}},r.name||"Item"),
              React.createElement("span",{style:{fontSize:10,color:"var(--sub)",fontFamily:"var(--f)"}},r.garmentType),
              r.color&&React.createElement("span",{style:{width:14,height:14,borderRadius:4,background:CM[r.color]?CM[r.color].h:"#888",flexShrink:0}}))}),
            React.createElement("div",{style:{display:"flex",gap:8,marginTop:8}},
              React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:confirmBatch},"âœ… Add "+batchResults.filter(function(r){return r.selected}).length+" Items"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setBatchResults([]);setShowBatch(false)}},"âœ•")))),

        /* Duplicate Detection */
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:12}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"10px 14px",fontSize:10,minHeight:36},onClick:function(){var dupes=findDuplicates(wd);if(dupes.length){setShowDupes(true);showToast("âš ï¸ Found "+dupes.length+" duplicate group(s)","error")}else{showToast("âœ“ No duplicates found","success")}}},"ðŸ” Find Dupes")),

        showDupes&&(function(){var dupes=findDuplicates(wd);return dupes.length?React.createElement("div",{style:{marginBottom:12}},
          React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"âš ï¸ Possible Duplicates"),
          dupes.map(function(group,gi){return React.createElement("div",{key:gi,className:"dup-group"},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
              React.createElement("span",{className:"dup-badge"},group.length+" similar"),
              React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600}},wd[group[0]]?wd[group[0]].garmentType:"")),
            group.map(function(idx){return wd[idx]?React.createElement("div",{key:idx,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0",fontSize:12,fontFamily:"var(--f)"}},
              React.createElement("span",null,(wd[idx].name||"Unnamed")+" Â· "+(wd[idx].color||"?")),
              React.createElement("button",{style:{background:"none",border:"none",color:"var(--warn)",cursor:"pointer",fontSize:12},onClick:function(){rmG(wd[idx].id)}},"âœ•")):null}))}),
          React.createElement("button",{className:"btn btn-ghost",style:{marginTop:6,fontSize:10,minHeight:36},onClick:function(){setShowDupes(false)}},"Close")):null})(),
        weather&&React.createElement("div",{style:{background:"linear-gradient(135deg,#0d1018,#0a0914)",border:"1px solid "+(planWx&&planWx.rain?"rgba(100,150,220,0.4)":"var(--border)"),borderRadius:12,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"}},
          React.createElement("span",{style:{fontSize:22}},planWx&&planWx.cond?planWx.cond.i:tier?tier.icon:""),
          React.createElement("div",null,React.createElement("div",{style:{fontSize:18,fontWeight:600,fontFamily:"var(--f)"}},planTemp?planTemp.temp+"Â°C":weather.temp+"Â°C"),React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Feels "+(planTemp?planTemp.feels:weather.feels)+"Â°C Â· "+loc.name+(planDay>0&&forecast[planDay]?" Â· "+forecast[planDay].date:""))),
          React.createElement("div",{style:{flex:1,minWidth:100}},
            React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},planWx&&planWx.cond?planWx.cond.l:tier?tier.label:""),
            React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},tier?tier.advice:"")),
          planWx&&React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
            planWx.rainPct>0&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.rainPct>=50?"#7ab8d8":"var(--sub)",background:planWx.rainPct>=50?"rgba(100,150,220,0.1)":"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid "+(planWx.rainPct>=50?"rgba(100,150,220,0.25)":"var(--border)")}},"ðŸŒ§ï¸ "+planWx.rainPct+"%"),
            planWx.uv>=4&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.uv>=8?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"â˜€ï¸ UV "+planWx.uv),
            planWx.wind>=20&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.wind>=40?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"ðŸ’¨ "+planWx.wind+"km/h"))),

        React.createElement("input",{ref:fRef,type:"file",accept:"image/*",multiple:true,style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("input",{ref:cRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("div",{style:{border:"2px dashed #2a2530",borderRadius:14,padding:"18px 16px",textAlign:"center",background:"#0a0914",marginBottom:14}},
          React.createElement("p",{style:{fontSize:18,margin:"0 0 4px"}},"ðŸ“¸"),
          React.createElement("p",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:500,margin:"0 0 10px"}},"Upload photos or add manually"),
          React.createElement("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}},
            React.createElement("button",{onClick:function(){if(fRef.current)fRef.current.click()},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",borderRadius:8,padding:"12px 18px",color:"var(--bg)",fontFamily:"var(--f)",fontSize:12,fontWeight:600,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center",border:"none"}},"ðŸ“ Upload"),
            React.createElement("button",{onClick:function(){if(cRef.current)cRef.current.click()},style:{background:"#1a1828",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center"}},"ðŸ“· Camera"),
            React.createElement("button",{onClick:function(){setAddG(true)},style:{background:"#1a1828",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44}},"âœï¸ Manual"))),

        proc.length>0&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginBottom:12}},proc.map(function(p){return React.createElement("div",{key:p,style:{background:"#0a0914",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",display:"flex",alignItems:"center",gap:8}},React.createElement("div",{className:"sp",style:{width:14,height:14,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Identifying..."))})),

        wd.length>0&&React.createElement(React.Fragment,null,
          needsFix>0&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",margin:0,fontWeight:500,flex:1}},"âš ï¸ "+needsFix+" items need classification â€” tap to set type & color"),
              React.createElement("button",{onClick:async function(){
                var broken=wd.filter(function(i){return(i.needsEdit||!i.color)&&i.photoUrl});
                if(!broken.length)return;
                for(var k=0;k<broken.length;k++){
                  var it=broken[k];
                  try{var compressed=await compressImage(it.photoUrl,600,0.6);var b64=compressed.split(",")[1];
                    var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
                    if(aiResult&&aiResult.length)updG(it.id,aiResult[0]);else setAiErr(getLastAiError());
                  }catch(e){}
                  if(k<broken.length-1)await new Promise(function(r){setTimeout(r,800)});
                }
              },style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"8px 14px",fontFamily:"var(--f)",fontSize:11,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",minHeight:36}},"ðŸ”„ Retry AI"))),
          aiErr&&React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"flex-start",gap:8}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",margin:0,flex:1,wordBreak:"break-all"}},"ðŸš¨ AI Error: "+aiErr),
              React.createElement("button",{onClick:function(){setAiErr("")},style:{background:"none",border:"none",color:"var(--warn)",cursor:"pointer",fontSize:14}},"âœ•"))),

          React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:10}},
            [{id:"all",l:"All "+wd.length},{id:"tops",l:"Tops "+byCat.tops.length},{id:"bottoms",l:"Btms "+byCat.bottoms.length},{id:"shoes",l:"Shoes "+byCat.shoes.length}].map(function(f){return React.createElement(Pill,{key:f.id,on:wFilt===f.id,onClick:function(){setWFilt(f.id)}},f.l)}),
            React.createElement("button",{onClick:function(){if(confirm("Clear all garments? This cannot be undone.")){saveWd([]);setWFilt("all");showToast("âœ“ All garments cleared","success")}},style:{marginLeft:"auto",background:"none",border:"1px solid #2a1a1a",borderRadius:20,padding:"8px 14px",color:"#5a3a3a",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",minHeight:36}},"Clear")),
          /* Material quick-filter */
          (function(){var mc={};wd.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var mats=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,6);return mats.length>=2?React.createElement("div",{className:"hscroll",style:{display:"flex",gap:4,marginBottom:8,paddingBottom:2}},React.createElement(Pill,{on:wMatFilt==="all",onClick:function(){setWMatFilt("all")}},"All Materials"),mats.map(function(m){return React.createElement(Pill,{key:m[0],on:wMatFilt===m[0],onClick:function(){setWMatFilt(m[0])}},m[0]+" Ã—"+m[1])})):null})(),

          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(105px,1fr))",gap:8}},
            (function(){var arr=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});if(wMatFilt!=="all")arr=arr.filter(function(i){return i.material===wMatFilt});return arr})().slice().sort(function(a,b){return(b.ts||0)-(a.ts||0)}).map(function(item){
              return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setEditG(item)},style:{background:item.needsEdit||!item.color?"#14100a":"var(--card)",border:"1px solid "+(item.needsEdit||!item.color?"rgba(201,168,76,0.3)":"var(--border)")}},
                item.photoUrl?React.createElement(React.Fragment,null,React.createElement("img",{src:item.photoUrl,alt:"",style:{width:"100%",height:90,objectFit:"cover",display:"block"}}),React.createElement("div",{className:"gcard-overlay"})):React.createElement("div",{style:{width:"100%",height:60,background:(CM[item.color]||{}).h||"#2a2a2a",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"#fff8",textShadow:"0 1px 3px #000"}},item.color)),
                React.createElement("div",{style:{padding:"6px 8px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                    item.color&&React.createElement(Dot,{color:item.color,size:6}),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}},item.name||item.color||"Tap to classify")),
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" Â· "+item.pattern:""))),
                (item.needsEdit||!item.color)&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(201,168,76,0.9)",borderRadius:4,padding:"2px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--bg)",fontWeight:700}},"FIX")),
                item.positionHint&&React.createElement("div",{style:{position:"absolute",top:4,left:4,background:"rgba(0,0,0,0.7)",borderRadius:4,padding:"1px 5px"}},React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#9a9aaa"}},"ðŸ“¸ "+item.positionHint)),
                item.material&&React.createElement("div",{style:{position:"absolute",bottom:28,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:"#aaa"}},item.material)),
                item.lastWorn&&React.createElement("div",{style:{position:"absolute",bottom:28,left:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d<=2?"#e8a87c":d<=7?"#aaa":"#7a7"})()}},(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d===0?"worn today":d===1?"1d ago":d+"d ago"})())),
                item.seasons&&item.seasons.length>0&&item.seasons.length<4&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 3px"}},React.createElement("span",{style:{fontSize:6}},item.seasons.map(function(s){return{spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"}[s]||""}).join(""))))})),

          React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 14px",marginTop:12}},
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",margin:0}},byCat.tops.length+" tops Â· "+byCat.bottoms.length+" bottoms Â· "+byCat.shoes.length+" shoes"+(function(){var mc={};wd.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var ms=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,3);return ms.length?" Â· "+ms.map(function(e){return e[0]+" Ã—"+e[1]}).join(", "):""})()),
            (function(){var nfIds=new Set();saved.forEach(function(o){(o.items||[]).forEach(function(it){nfIds.add(it.id)})});var unused=wd.filter(function(i){return i.color&&!i.needsEdit&&!nfIds.has(i.id)}).length;return unused>0?React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",margin:"4px 0 0"}},"ðŸ’¤ "+unused+" item"+(unused!==1?"s":"")+" never saved in an outfit"):null})(),
            /* Freshness bar */
            (function(){var worn=wd.filter(function(i){return i.lastWorn});if(!worn.length)return null;var now=Date.now();var fresh=0,mid=0,stale=0;worn.forEach(function(i){var d=Math.floor((now-new Date(i.lastWorn).getTime())/864e5);if(d<=3)fresh++;else if(d<=14)mid++;else stale++});var total=fresh+mid+stale;return React.createElement("div",{style:{marginTop:6}},React.createElement("div",{style:{display:"flex",gap:8,fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:3}},React.createElement("span",null,"Rotation freshness:"),fresh>0&&React.createElement("span",{style:{color:"var(--good)"}},"ðŸŸ¢ "+fresh+" fresh"),mid>0&&React.createElement("span",{style:{color:"var(--gold)"}},"ðŸŸ¡ "+mid+" ok"),stale>0&&React.createElement("span",{style:{color:"var(--warn)"}},"ðŸ”´ "+stale+" stale")),React.createElement("div",{style:{height:3,borderRadius:2,background:"var(--bg)",overflow:"hidden",display:"flex"}},fresh>0&&React.createElement("div",{style:{width:fresh/total*100+"%",background:"var(--good)"}}),mid>0&&React.createElement("div",{style:{width:mid/total*100+"%",background:"var(--gold)"}}),stale>0&&React.createElement("div",{style:{width:stale/total*100+"%",background:"var(--warn)"}})))})()))),

      /* â•â•â• FITS â•â•â• */
      view==="fits"&&!selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},

        /* OOTD BANNER */
        ootd&&React.createElement("div",{className:"ootd-banner",onClick:function(){setSelFit(ootd)}},
          React.createElement("div",{className:"ootd-label"},"âœ¨ Outfit of the Day"),
          React.createElement("div",{className:"ootd-name"},(ootd.top?ootd.top.name||ootd.top.color:"")+" + "+(ootd.bot?ootd.bot.name||ootd.bot.color:"")),
          React.createElement("div",{className:"ootd-items"},(ootd.watches||[]).slice(0,2).map(function(w){return w.i+" "+w.n}).join(" Â· ")+(ootd.fs?" Â· Score "+ootd.fs:""))),

        /* LOCATION VIBES */
        React.createElement("div",{className:"loc-chips"},
          Object.keys(LOC_VIBES).map(function(loc){return React.createElement("button",{key:loc,className:"loc-chip"+(locVibe===loc?" on":""),onClick:function(){selectLocVibe(loc)}},loc)})),

        /* MODE CARDS */
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:12}},
          [{id:"auto",icon:"âœ¨",l:"Smart",d:"AI-scored"},{id:"build",icon:"ðŸ§©",l:"Build",d:"Pick items"},{id:"rotation",icon:"ðŸ“…",l:"Week",d:"7-day plan"}].map(function(m){
            var on=mode===m.id;
            return React.createElement("button",{key:m.id,onClick:function(){setMode(m.id);if(m.id!=="auto"){setLockItem(null);setTopType("all")}},style:{background:on?"rgba(201,168,76,0.1)":"var(--card)",border:"1px solid "+(on?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:12,padding:"12px 8px",cursor:"pointer",textAlign:"center",transition:"all .15s"}},
              React.createElement("div",{style:{fontSize:20,marginBottom:2}},m.icon),
              React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:on?700:500,color:on?"var(--gold)":"var(--text)"}},m.l),
              React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:on?"var(--gold)":"var(--dim)",opacity:0.7}},m.d))})),

        /* DAY SELECTOR for Auto/Build */
        mode!=="rotation"&&forecast.length>0&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              var t=getWT(fc.feelsAvg);var hasRain=fc.cond&&fc.cond.rain;
              return React.createElement("button",{key:i,onClick:function(){setPlanDay(i)},style:{flex:"0 0 auto",background:planDay===i?"rgba(201,168,76,0.15)":hasRain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(planDay===i?"rgba(201,168,76,0.4)":hasRain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"8px 10px",cursor:"pointer",minWidth:68,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--gold)":"var(--sub)",fontWeight:planDay===i?700:400}},i===0?"Today":i===1?"Tmrw":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:t?t.icon:""),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--text)":"var(--dim)",fontWeight:600}},fc.high+"Â°/"+fc.low+"Â°"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)",fontWeight:fc.rainPct>=50?600:400}},"ðŸ’§"+fc.rainPct+"%"),
                fc.wind>=25&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},"ðŸ’¨"+fc.wind))}))),

        /* CONTEXT + CONTROLS ROW */
        mode!=="rotation"&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:5,marginBottom:8}},
            planDay>0&&effectiveCtx!==ctx&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",alignSelf:"center",marginRight:4}},"ðŸ“… "+(CXI[effectiveCtx]||"")+effectiveCtx),
            CTXS.map(function(c){return React.createElement(Pill,{key:c.id,on:(planDay>0?effectiveCtx:ctx)===c.id,onClick:function(){setCtx(c.id);setPlanDay(0)}},c.l)}),
            !IS_SHARED&&React.createElement("button",{onClick:function(){setReps(!reps)},style:{background:reps?"rgba(201,168,76,0.08)":"var(--card)",border:"1px solid "+(reps?"rgba(201,168,76,0.25)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",marginLeft:"auto",color:reps?"var(--gold)":"var(--dim)",fontFamily:"var(--f)",fontSize:11,minHeight:36}},reps?"Rep ON":"Rep OFF"))),

        /* AUTO-SPECIFIC FILTERS */
        mode==="auto"&&React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center",marginBottom:10}},
          /* Top type filter */
          [{id:"all",l:"All Tops"},{id:"Shirt",l:"ðŸ‘” Shirts"},{id:"Polo",l:"ðŸ‡ Polos"},{id:"T-Shirt",l:"ðŸ‘• Tees"},{id:"Sweater/Knit",l:"ðŸ§¶ Knits"},{id:"Jacket/Blazer",l:"ðŸ§¥ Jackets"}].map(function(tf){
            return React.createElement("span",{key:tf.id,className:"chip "+(topType===tf.id?"on":""),onClick:function(){setTopType(tf.id)}},tf.l)}),
          /* Shuffle */
          React.createElement("button",{onClick:function(){setShuffleKey(shuffleKey+1)},style:{background:"none",border:"1px solid var(--border)",borderRadius:20,padding:"6px 12px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,marginLeft:"auto",minHeight:32}},"ðŸŽ² Shuffle"),
          /* Count */
          React.createElement("select",{className:"sel",value:fitCount,onChange:function(e){setFitCount(parseInt(e.target.value))},style:{width:52,padding:"6px 4px",fontSize:10,textAlign:"center",borderRadius:8}},
            [6,10,15,20].map(function(n){return React.createElement("option",{key:n,value:n},n)}))),

        /* Lock item banner */
        mode==="auto"&&lockItem&&React.createElement("div",{className:"fu",style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:10}},
          lockItem.photoUrl&&React.createElement("img",{src:lockItem.photoUrl,alt:"",style:{width:32,height:32,objectFit:"cover",borderRadius:6}}),
          React.createElement(Dot,{color:lockItem.color,size:8}),
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"ðŸ”’ Locked: "+( lockItem.name||lockItem.color)+" â€” showing fits around this piece"),
          React.createElement("button",{onClick:function(){setLockItem(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"âœ• Unlock")),

        /* BUILD */
        mode==="build"&&React.createElement("div",null,
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:16}},
            [{slot:"top",l:"TOP",val:bTop,set:setBTop},{slot:"bot",l:"BOTTOM",val:bBot,set:setBBot},{slot:"shoe",l:"SHOES",val:bShoe,set:setBShoe}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:o.val.photoUrl,alt:"",style:{width:"100%",height:50,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:18}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"âœ• clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:18,color:"var(--dim)"}},"+"),
                  /* Context-aware suggestion */
                  (function(){var cat=o.slot==="top"?"tops":o.slot==="bot"?"bottoms":"shoes";var pool=byCat[cat].filter(function(i){return i.color&&!i.needsEdit});if(!pool.length)return null;var ref=o.slot==="top"?bBot:o.slot==="bot"?bTop:bTop;if(!ref)return null;var best=pool.map(function(c){return{g:c,s:compat(c.color,ref.color)}}).sort(function(a,b){return b.s-a.s})[0];return best&&best.s>0.3?React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--gold)",opacity:0.7,marginTop:2}},"try "+(best.g.name||best.g.color)):null})()))})),

          buildSlot&&(function(){
            var cat=buildSlot==="top"?"tops":buildSlot==="bot"?"bottoms":"shoes";
            var items=byCat[cat].filter(function(i){return i.color&&!i.needsEdit});
            var setter=buildSlot==="top"?setBTop:buildSlot==="bot"?setBBot:setBShoe;
            return React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:16}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8}},"Pick "+(buildSlot==="top"?"a top":buildSlot==="bot"?"bottoms":"shoes")),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(80px,1fr))",gap:8}},
                items.map(function(item){return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setter(item);setBuildSlot(null)},style:{background:"var(--bg)",border:"2px solid transparent",textAlign:"center"}},
                  item.photoUrl?React.createElement("img",{src:item.photoUrl,alt:"",style:{width:"100%",height:60,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{height:40,display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement(Dot,{color:item.color,size:14})),
                  React.createElement("div",{style:{padding:"4px 4px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",fontWeight:500}},item.name||item.color)))}),
                !items.length&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",gridColumn:"1/-1",padding:10}},"No classified items")));
          })(),

          buildFit?React.createElement("div",{className:"fu",style:{background:"var(--card2)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"16px"}},
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}},
              React.createElement("span",{style:{fontSize:15,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"Score: "+buildFit.fs),
              React.createElement("button",{className:"btn btn-gold",style:{width:"auto",padding:"10px 18px",fontSize:11},onClick:function(){saveFit(buildFit)}},"ðŸ’¾ Save")),
            buildFit.wxWarns&&buildFit.wxWarns.length>0&&React.createElement("div",{style:{marginBottom:10,display:"flex",gap:4,flexWrap:"wrap"}},
              buildFit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
            React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},
              buildFit.allW.slice(0,6).map(function(w,i){return React.createElement(WCard,{key:w.id,w:w,rank:i,detail:true})})))
          :!buildSlot&&React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:20}},"Tap the slots above to pick items")),

        /* ROTATION */
        mode==="rotation"&&(function(){
          var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock);
          var DAYS7=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          var genC=rotation.filter(function(d){return d.watch&&d.watch.t==="genuine"}).length;
          var repC=rotation.filter(function(d){return d.watch&&d.watch.t==="replica"}).length;
          var uniqueW={};rotation.forEach(function(d){if(d.watch)uniqueW[d.watch.id]=true});
          return React.createElement("div",null,
            /* Header + stats */
            React.createElement("div",{style:{background:"linear-gradient(135deg,#0d1018,#0a0914)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"14px 16px",marginBottom:10}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                React.createElement("span",{style:{fontSize:18}},"ðŸ“…"),
                React.createElement("span",{style:{fontSize:15,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"7-Day Rotation"),
                React.createElement("button",{onClick:function(){setEditRotCtx(!editRotCtx)},style:{marginLeft:"auto",background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},editRotCtx?"Done":"âš™ï¸ Edit Days"),
                React.createElement("button",{onClick:function(){
                  var nl=rotation.map(function(d){return d.watch?d.watch.id:null});
                  setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                },style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"ðŸ’¾ Save"),
                rotLock.some(function(x){return x!==null})&&React.createElement("button",{onClick:function(){
                  setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);
                },style:{background:"none",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"ðŸ”“ Clear")),
              React.createElement("div",{style:{display:"flex",gap:12,fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},
                React.createElement("span",null,"ðŸ”¢ "+Object.keys(uniqueW).length+" unique"),
                !IS_SHARED&&React.createElement("span",null,"âœ“ "+genC+" genuine"),
                !IS_SHARED&&React.createElement("span",null,"â—‡ "+repC+" replica"),
                rotLock.filter(function(x){return x}).length>0&&React.createElement("span",{style:{color:"var(--good)"}},"ðŸ”’ "+rotLock.filter(function(x){return x}).length+" locked"))),

            /* Rotation weather summary */
            (function(){
              var clearD=0,rainD=0,windyD=0,snowD=0;
              rotation.forEach(function(d){if(!d.forecast)return;var c=d.forecast.cond;if(c&&c.rain)rainD++;else if(d.forecast.code>=71&&d.forecast.code<=86)snowD++;else clearD++;if(d.forecast.wind>=30)windyD++});
              var parts=[];if(clearD)parts.push("â˜€ï¸ "+clearD+" clear");if(rainD)parts.push("ðŸŒ§ï¸ "+rainD+" rain");if(snowD)parts.push("â„ï¸ "+snowD+" snow");if(windyD)parts.push("ðŸ’¨ "+windyD+" windy");
              return parts.length?React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",background:"var(--bg)",borderRadius:8,padding:"6px 12px",marginBottom:8,border:"1px solid var(--border)",textAlign:"center"}},parts.join(" Â· ")):null;
            })(),

            /* Smart rotation alerts */
            (function(){
              var alerts=[];
              /* Rep-heavy week */
              if(!IS_SHARED&&repC>=5)alerts.push({icon:"âš ",text:"Rep-heavy week: "+repC+"/7 days are replicas. Consider swapping 1-2 for genuine.",c:"var(--warn)"});
              /* Back-to-back same watch */
              for(var ai=0;ai<rotation.length-1;ai++){if(rotation[ai].watch&&rotation[ai+1].watch&&rotation[ai].watch.id===rotation[ai+1].watch.id)alerts.push({icon:"ðŸ”",text:rotation[ai].watch.n+" repeats "+rotation[ai].dayName+"â†’"+rotation[ai+1].dayName+". Variety matters.",c:"var(--warn)"})}
              /* Neglected watches â€” active watches not in rotation and not worn in 14+ days */
              var rotIds={};rotation.forEach(function(d){if(d.watch)rotIds[d.watch.id]=true});
              var neglected=actW.filter(function(w){return !rotIds[w.id]&&daysSince(w.id)>=14&&w.status==="active"});
              if(neglected.length>=3)alerts.push({icon:"ðŸ’¤",text:neglected.length+" watches haven't been worn in 14+ days: "+neglected.slice(0,3).map(function(w){return w.i+" "+w.n}).join(", "),c:"#7ab8d8"});
              /* Strap mismatch warnings */
              rotation.forEach(function(d){if(d.watch&&d.outfit&&d.outfit.shoe&&!d.watch.br){var sc=d.outfit.shoe.color?d.outfit.shoe.color.toLowerCase():"";var wsc=(d.watch.sc||[]).join(" ").toLowerCase();if(sc.includes("brown")&&wsc.includes("black")&&!wsc.includes("brown"))alerts.push({icon:"ðŸš«",text:d.dayName+": "+d.watch.n+" has black strap but brown shoes. Mismatch.",c:"var(--warn)"});if(sc.includes("black")&&!wsc.includes("black")&&!wsc.includes("navy")&&wsc.length>0)alerts.push({icon:"ðŸš«",text:d.dayName+": "+d.watch.n+" has warm strap but black shoes.",c:"var(--warn)"})}});
              /* Rain + leather strap warnings */
              rotation.forEach(function(d){if(d.forecast&&d.forecast.cond&&d.forecast.cond.rain&&d.watch&&!d.watch.br){alerts.push({icon:"â˜‚ï¸",text:d.dayName+": Rain forecast ("+d.forecast.rainPct+"%) but "+d.watch.n+" has leather strap. Consider bracelet watch or waterproof precautions.",c:"#7ab8d8"})}});
              /* Rainy days count */
              var rainyDays=rotation.filter(function(d){return d.forecast&&d.forecast.cond&&d.forecast.cond.rain}).length;
              if(rainyDays>=3)alerts.push({icon:"ðŸŒ§ï¸",text:"Rain-heavy week: "+rainyDays+" of 7 days have precipitation. Bracelet watches prioritized.",c:"#7ab8d8"});
              if(!alerts.length)return null;
              return React.createElement("div",{style:{marginBottom:10}},alerts.map(function(a,idx){
                var isRainAlert=a.c==="#7ab8d8";
                return React.createElement("div",{key:idx,style:{display:"flex",alignItems:"flex-start",gap:8,background:isRainAlert?"rgba(100,150,220,0.04)":"rgba(200,90,58,0.04)",border:"1px solid "+(isRainAlert?"rgba(100,150,220,0.15)":"rgba(200,90,58,0.15)"),borderRadius:8,padding:"8px 12px",marginBottom:4}},
                  React.createElement("span",{style:{fontSize:14,flexShrink:0}},a.icon),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:a.c,lineHeight:1.4}},a.text))}));
            })(),

            /* Context editor */
            editRotCtx&&React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:10}},
              React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8,letterSpacing:"0.1em"}},"SET CONTEXT PER DAY"),
              DAYS7.map(function(dn,di){
                return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:32,fontWeight:600}},dn),
                  React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap",flex:1},className:"hscroll"},
                    activeCxIds.slice(0,8).map(function(cx){
                      return React.createElement("span",{key:cx,className:"chip "+(weekCtx[di]===cx?"on":""),onClick:function(){
                        var nwc=weekCtx.slice();nwc[di]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      },style:{padding:"3px 8px",fontSize:9,minHeight:24}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})));
              })),

            /* Day cards */
            rotation.map(function(day,i){
              if(!day.watch)return null;
              var w=day.watch;var isToday=i===0;
              var of=day.outfit;var sp=day.strapPick;
              var ds=daysSince(w.id);
              var dayDate=day.date||todayStr;
              var worn=wearLog.find(function(e){return e.date===dayDate&&e.watchId===w.id});
              var isEditing=editDayIdx===i;
              return React.createElement("div",{key:i,className:"card-lift",style:{background:isToday?"var(--card2)":"var(--card)",border:"1px solid "+(isToday?"rgba(201,168,76,0.3)":day.locked?"rgba(122,184,122,0.2)":"var(--border)"),borderRadius:12,padding:"12px 14px",marginBottom:8}},
                React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center"}},
                  /* Day + weather */
                  React.createElement("div",{style:{minWidth:48,textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:isToday?"var(--gold)":"var(--sub)",fontWeight:700}},isToday?"TODAY":day.dayName.toUpperCase()),
                    day.forecast&&React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},day.forecast.cond?day.forecast.cond.i:day.tier?day.tier.icon:""),
                    day.forecast&&React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},day.forecast.high+"Â°/"+day.forecast.low+"Â°"),
                    day.forecast&&day.forecast.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:day.forecast.rainPct>=50?"#7ab8d8":"var(--dim)"}},day.forecast.rainPct>=50?"ðŸ’§"+day.forecast.rainPct+"%":day.forecast.rainPct+"%")),
                  /* Watch â€” tap to swap */
                  React.createElement("div",{onClick:function(){setEditDayIdx(isEditing?null:i);setEditDayMode(isEditing?null:"watch")},style:{width:40,height:40,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:18,flexShrink:0,border:"2px solid "+(isEditing?"var(--gold)":w.c+"40"),cursor:"pointer"}},w.i),
                  React.createElement("div",{style:{flex:1,minWidth:0}},
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:5,flexWrap:"wrap",marginBottom:2}},
                      React.createElement("span",{style:{fontSize:13,fontWeight:600}},w.n),
                      !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid #2a2520",borderRadius:3,padding:"1px 4px"}},"REP"),
                      /* Context badge â€” tap to cycle */
                      React.createElement("span",{onClick:function(e){e.stopPropagation();setEditDayIdx(isEditing&&editDayMode==="ctx"?null:i);setEditDayMode("ctx")},style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",background:"var(--bg)",borderRadius:4,padding:"1px 6px",cursor:"pointer",border:"1px solid "+(isEditing&&editDayMode==="ctx"?"var(--gold)":"transparent")}},(CXI[day.context]||"")+" "+day.context),
                      day.locked&&React.createElement("span",{style:{fontSize:7,color:"var(--good)"}},"ðŸ”’"),
                      ds<999&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:ds<=2?"var(--warn)":ds>=7?"var(--good)":"var(--sub)",background:"var(--bg)",borderRadius:4,padding:"1px 5px"}},ds===0?"today":ds+"d ago"),
                      of&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:of.fs>=8?"var(--good)":of.fs>=5?"var(--gold)":"var(--warn)",background:of.fs>=8?"rgba(122,184,122,0.1)":of.fs>=5?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",borderRadius:4,padding:"1px 5px",border:"1px solid "+(of.fs>=8?"rgba(122,184,122,0.2)":of.fs>=5?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},of.fs>=8?"ðŸ”¥":"ðŸ‘”"," "+of.fs)),
                    /* Strap + bracelet line */
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},
                      w.br?React.createElement("span",{style:{color:day.forecast&&day.forecast.cond&&day.forecast.cond.rain?"var(--good)":"var(--sub)"}},"â›“ï¸ Bracelet"+(day.forecast&&day.forecast.cond&&day.forecast.cond.rain?" âœ“":""))
                      :sp?React.createElement("span",{style:{color:day.forecast&&day.forecast.cond&&day.forecast.cond.rain?"var(--warn)":sp.type==="good"?"var(--good)":"var(--sub)"}},(day.forecast&&day.forecast.cond&&day.forecast.cond.rain?"âš ï¸ ":"")+"ðŸ”— "+sp.text+(day.forecast&&day.forecast.cond&&day.forecast.cond.rain?" â€” rain risk":""))
                      :React.createElement("span",null,"ðŸ”— "+(w.sc||[]).join(" / ")))),
                  /* Lock/unlock button */
                  React.createElement("button",{onClick:function(){var nl=rotLock.slice();nl[i]=nl[i]?null:w.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl)},style:{background:"none",border:"1px solid "+(day.locked?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:6,padding:"4px 8px",cursor:"pointer",color:day.locked?"var(--good)":"var(--dim)",fontSize:12,flexShrink:0,minWidth:32,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center"}},day.locked?"ðŸ”’":"ðŸ”“")),

                /* Inline context picker */
                isEditing&&editDayMode==="ctx"&&React.createElement("div",{className:"fu",style:{display:"flex",gap:3,flexWrap:"wrap",marginTop:8,paddingTop:8,borderTop:"1px solid #141220"}},
                  activeCxIds.slice(0,8).map(function(cx){
                    return React.createElement("span",{key:cx,className:"chip "+(weekCtx[day.dayIdx]===cx?"on":""),onClick:function(){
                      var nwc=weekCtx.slice();nwc[day.dayIdx]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      /* Also unlock this day so rotation recalculates */
                      var nl=rotLock.slice();nl[i]=null;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                      setEditDayIdx(null);setEditDayMode(null);
                    },style:{padding:"4px 10px",fontSize:9,minHeight:28}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})),

                /* Inline watch picker */
                isEditing&&editDayMode==="watch"&&React.createElement("div",{className:"fu",style:{marginTop:8,paddingTop:8,borderTop:"1px solid #141220"}},
                  React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"SWAP WATCH FOR "+day.dayName.toUpperCase()),
                  React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(100px,1fr))",gap:6,maxHeight:200,overflowY:"auto"}},
                    actW.filter(function(aw){return reps||aw.t!=="replica"}).map(function(aw){
                      var isActive=aw.id===w.id;
                      return React.createElement("div",{key:aw.id,onClick:function(){
                        var nl=rotLock.slice();nl[i]=aw.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                        setEditDayIdx(null);setEditDayMode(null);
                      },style:{display:"flex",alignItems:"center",gap:6,background:isActive?"rgba(201,168,76,0.1)":"var(--bg)",border:"1px solid "+(isActive?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:8,padding:"6px 8px",cursor:"pointer"}},
                        React.createElement("span",{style:{fontSize:16}},aw.i),
                        React.createElement("div",{style:{flex:1,minWidth:0}},
                          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},aw.n),
                          React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},aw.d+(!IS_SHARED&&aw.t==="replica"?" Â· rep":""))))}))),

                /* Confirm wear / undo for today */
                isToday&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:8,paddingTop:8,borderTop:"1px solid #141220",alignItems:"center"}},
                  !worn?React.createElement("button",{onClick:function(){logWear(w.id,todayStr)},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:8,padding:"8px 14px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,flex:1,minHeight:36}},"âœ“ Wearing this today")
                  :React.createElement(React.Fragment,null,
                    React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--good)",flex:1}},"âœ“ Logged for today"),
                    React.createElement("button",{onClick:function(){undoWear(todayStr)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"Undo"))),
                /* Outfit pairing row â€” tappable for alternatives */
                of&&React.createElement("div",{style:{marginTop:isToday?6:8,paddingTop:isToday?0:8,borderTop:isToday?"none":"1px solid #141220"}},
                  React.createElement("div",{onClick:function(){setExpandDay(expandDay===i?null:i)},style:{display:"flex",gap:6,cursor:"pointer"}},
                    [{l:"TOP",item:of.top},{l:"BTM",item:of.bot},{l:"SHOE",item:of.shoe}].map(function(o){
                      if(!o.item)return null;
                      return React.createElement("div",{key:o.l,style:{flex:1,background:"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid #1a1828",minWidth:0}},
                        o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:"100%",height:56,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:56,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                        React.createElement("div",{style:{padding:"4px 6px",display:"flex",alignItems:"center",gap:3}},
                          React.createElement(Dot,{color:o.item.color,size:5}),
                          React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#a8a098",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color)))}),
                    React.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4,flexShrink:0,minWidth:28}},
                      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},expandDay===i?"â–²":"â–¼"),
                      /* Per-day AI critique button */
                      React.createElement("button",{onClick:function(e){e.stopPropagation();
                        if(dayAi[i]){setDayAi(function(p){var n=Object.assign({},p);delete n[i];return n});return}
                        setDayAiLoading(i);
                        aiVision({top:of.top,bot:of.bot,shoe:of.shoe},w,day.context,apiKeyRef.current).then(function(result){
                          setDayAi(function(p){var n=Object.assign({},p);n[i]=result||{vision:"AI unavailable",impact:0};return n});
                          setDayAiLoading(null);
                        });
                      },style:{background:"none",border:"1px solid "+(dayAi[i]?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:6,padding:"3px 8px",cursor:"pointer",color:dayAiLoading===i?"var(--gold)":dayAi[i]?"var(--gold)":"var(--dim)",fontSize:10,minHeight:24}},dayAiLoading===i?"â³":dayAi[i]?"âœ¨ "+dayAi[i].impact:"âœ¨"))),

                  /* Expanded: AI critique result */
                  dayAi[i]&&React.createElement("div",{className:"fu",style:{marginTop:6,background:"rgba(201,168,76,0.04)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(201,168,76,0.15)"}},
                    dayAi[i].vision&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.5,color:"var(--text)",marginBottom:4}},dayAi[i].vision),
                    React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",fontSize:8,fontFamily:"var(--f)"}},
                      dayAi[i].impact>0&&React.createElement("span",{style:{color:dayAi[i].impact>=7?"var(--good)":dayAi[i].impact>=4?"var(--gold)":"var(--warn)",fontWeight:700}},"Impact: "+dayAi[i].impact+"/10"),
                      dayAi[i].works&&React.createElement("span",{style:{color:"var(--good)"}},"âœ“ "+dayAi[i].works),
                      dayAi[i].risk&&React.createElement("span",{style:{color:"var(--warn)"}},"âš  "+dayAi[i].risk))),

                  /* Expanded: outfit mannequin */
                  expandDay===i&&React.createElement("div",{className:"fu",style:{marginTop:8,display:"flex",gap:12,alignItems:"flex-start",justifyContent:"center"}},
                    React.createElement(OutfitFigure,{topColor:of.top?of.top.color:"grey",botColor:of.bot?of.bot.color:"charcoal",shoeColor:of.shoe?of.shoe.color:"black",watchColor:w.c,watchIcon:w.i,watchName:w.n,size:100}),
                    React.createElement("div",{style:{flex:1,minWidth:0}},
                      [{l:"TOP",item:of.top},{l:"BOTTOM",item:of.bot},{l:"SHOES",item:of.shoe}].map(function(o){
                        if(!o.item)return null;
                        return React.createElement("div",{key:o.l,style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,background:"var(--bg)",borderRadius:8,padding:"6px 8px",border:"1px solid #1a1828"}},
                          o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:44,height:44,objectFit:"cover",borderRadius:6,flexShrink:0}}):React.createElement("div",{style:{width:44,height:44,borderRadius:6,background:(CM[o.item.color]||{}).h||"#3a3a3a",flexShrink:0}}),
                          React.createElement("div",{style:{flex:1,minWidth:0}},
                            React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em"}},o.l),
                            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                              React.createElement(Dot,{color:o.item.color,size:6}),
                              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500}},o.item.name||o.item.color)),
                            React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" Â· "+o.item.pattern:""))))}),
                      React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"6px 8px"}},
                        React.createElement("span",{style:{fontSize:16}},w.i),
                        React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},w.n),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},w.d+" Â· "+(w.br?"Bracelet":(w.sc||[]).join("/")))))),

                  /* Expanded: alternative outfits */
                  expandDay===i&&day.altOutfits&&day.altOutfits.length>0&&React.createElement("div",{className:"fu",style:{marginTop:6}},
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:4,letterSpacing:"0.08em"}},"ALTERNATIVES"),
                    day.altOutfits.map(function(alt,ai2){
                      return React.createElement("div",{key:ai2,style:{display:"flex",gap:6,marginBottom:4,padding:"4px 0",borderBottom:ai2<day.altOutfits.length-1?"1px solid #141220":"none"}},
                        [{item:alt.top},{item:alt.bot},{item:alt.shoe}].map(function(o,oi){
                          if(!o.item)return null;
                          return React.createElement("div",{key:oi,style:{display:"flex",alignItems:"center",gap:3,flex:"1 1 0",minWidth:0}},
                            o.item.photoUrl&&React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}),
                            React.createElement(Dot,{color:o.item.color,size:4}),
                            React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#8a8498",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))}),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",flexShrink:0}},alt.fs))})),
                  expandDay===i&&(!day.altOutfits||!day.altOutfits.length)&&React.createElement("div",{style:{marginTop:6,fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:6}},"No alternative combos for this context")));
            }),
            React.createElement("button",{onClick:function(){setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);setMode("auto");setTimeout(function(){setMode("rotation")},50)},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,minHeight:40}},"ðŸ”„ Shuffle Rotation"));
        })(),

        /* AUTO */
        mode==="auto"&&React.createElement(React.Fragment,null,
          tier&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 8px"}},"ðŸŒ¡ï¸ ",React.createElement("strong",{style:{color:"var(--gold)"}},tier.label+(planDay>0?" ("+forecast[planDay].date+")":"")),
            " Â· "+ww+" Â· "+actW.length+" watches Â· "+fits.length+" fits",
            planWx&&planWx.cond?React.createElement("span",{style:{color:planWx.rain?"#7ab8d8":"var(--sub)",marginLeft:6}},planWx.cond.i+" "+planWx.cond.l):null),
          /* Weather-specific advice banner */
          planWx&&(planWx.rain||planWx.uv>=8||(planWx.wind&&planWx.wind>=35))&&React.createElement("div",{style:{background:planWx.rain?"rgba(100,150,220,0.06)":"rgba(200,90,58,0.06)",border:"1px solid "+(planWx.rain?"rgba(100,150,220,0.2)":"rgba(200,90,58,0.2)"),borderRadius:10,padding:"8px 12px",marginBottom:10,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},
            React.createElement("span",{style:{fontSize:14}},planWx.rain?"â˜‚ï¸":planWx.uv>=8?"ðŸ•¶ï¸":"ðŸ’¨"),
            React.createElement("div",{style:{flex:1,minWidth:120}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:planWx.rain?"#7ab8d8":"var(--warn)"}},planWx.rain?"Rain Day â€” Bracelet Watches Boosted":planWx.uv>=8?"High UV â€” Light Fabrics":"High Wind â€” Secure Layers"),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},planWx.rain?"Leather straps penalized. White/cream shoes downranked."+(planWx.rainPct?" "+planWx.rainPct+"% chance.":""):planWx.uv>=8?"UV "+planWx.uv+" â€” light colors preferred":"Wind "+planWx.wind+"km/h"))),
          !fits.length?React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"ðŸ‘•"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"#5a5464"}},wd.length<2?"Add wardrobe items":needsFix>0?"Classify items first":"No valid combos"))
          :fits.map(function(fit,idx){
            return React.createElement("div",{key:fit.id,className:"card-lift",onClick:function(){setSelFit(fit)},style:{background:idx===0?"var(--card2)":"var(--card)",border:idx===0?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10,cursor:"pointer",position:"relative"}},
              idx===0&&React.createElement("div",{style:{position:"absolute",top:8,right:38,fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700}},"TOP"),
              React.createElement("div",{style:{position:"absolute",top:6,right:10,zIndex:2},onClick:function(e){e.stopPropagation();toggleFav(fit.id)}},React.createElement("span",{style:{fontSize:16,cursor:"pointer",filter:isFav(fit.id)?"drop-shadow(0 0 4px rgba(201,168,76,0.5))":"none"}},isFav(fit.id)?"â­":"â˜†")),
              React.createElement("div",{className:"dots-row",style:{marginBottom:8}},
                [fit.top,fit.bot,fit.shoe].filter(Boolean).map(function(item,i){return React.createElement(Dot,{key:i,color:item.color,size:8})}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:fit.fs>=8?"var(--good)":fit.fs>=5?"var(--gold)":"var(--warn)",marginLeft:4,fontWeight:600}},(fit.fs>=8?"ðŸ”¥ ":fit.fs>=5?"":"âš  ")+fit.fs),
                fit.topType&&fit.topType!=="Shirt"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:2}},fit.topType==="Sweater/Knit"?"ðŸ§¶":fit.topType==="Jacket/Blazer"?"ðŸ§¥":fit.topType==="Polo"?"ðŸ‡":fit.topType==="T-Shirt"?"ðŸ‘•":"")),
              React.createElement("div",{style:{display:"flex",gap:6,marginBottom:10}},
                [{l:"TOP",item:fit.top},{l:"BTM",item:fit.bot},{l:"SHOE",item:fit.shoe}].map(function(o){
                  if(!o.item)return null;
                  return React.createElement("div",{key:o.l,style:{flex:1,background:"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid #141220",minWidth:0}},
                    o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:"100%",height:52,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:36,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{padding:"4px 6px"}},React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},React.createElement(Dot,{color:o.item.color,size:5}),React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#c0bab0",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))))})),
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                fit.watches.map(function(w,i){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"#a8a098",fontWeight:i===0?600:400}},w.n))})),
              fit.wxWarns&&fit.wxWarns.length>0&&React.createElement("div",{style:{marginTop:6,display:"flex",gap:4,flexWrap:"wrap"}},
                fit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
              /* Recently worn warning */
              (function(){var rw=fit.items.filter(function(it){if(!it.lastWorn)return false;return Math.floor((Date.now()-new Date(it.lastWorn).getTime())/864e5)<=2});return rw.length?React.createElement("div",{style:{marginTop:4,fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},
                "ðŸ”„ "+(rw.length===1?(rw[0].name||rw[0].color)+" worn recently":rw.length+" items worn recently")):null})())}))),

      /* â•â•â• FIT DETAIL â•â•â• */
      view==="fits"&&selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        React.createElement("button",{onClick:function(){setSelFit(null)},style:{background:"none",border:"none",color:"var(--gold)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",padding:0,marginBottom:12,minHeight:44}},"â† Back"),
        /* Outfit mannequin preview */
        React.createElement("div",{style:{display:"flex",justifyContent:"center",marginBottom:16,background:"linear-gradient(145deg,#0a0914,#12101a)",borderRadius:14,padding:"16px",border:"1px solid rgba(201,168,76,0.15)"}},
          React.createElement(OutfitFigure,{topColor:selFit.top?selFit.top.color:"grey",botColor:selFit.bot?selFit.bot.color:"charcoal",shoeColor:selFit.shoe?selFit.shoe.color:"black",watchColor:selFit.watches&&selFit.watches[0]?selFit.watches[0].c:"#c9a84c",watchIcon:selFit.watches&&selFit.watches[0]?selFit.watches[0].i:"âŒš",watchName:selFit.watches&&selFit.watches[0]?selFit.watches[0].n:"",size:130})),
        [{slot:"top",l:"TOP",item:selFit.top},{slot:"bot",l:"BOTTOM",item:selFit.bot},{slot:"shoes",l:"SHOES",item:selFit.shoe}].map(function(o){
          if(!o.item)return null;
          var swaps=getSwaps(wd,selFit,o.slot);
          return React.createElement("div",{key:o.slot,style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px 14px",marginBottom:8}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10}},
              o.item.photoUrl&&React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:64,height:64,objectFit:"cover",borderRadius:10}}),
              React.createElement("div",{style:{flex:1}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.l),React.createElement("div",{style:{display:"flex",alignItems:"center",gap:4}},React.createElement(Dot,{color:o.item.color}),React.createElement("span",{style:{fontSize:14,fontWeight:500}},o.item.name||(o.item.color+" "+o.item.garmentType))),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" Â· "+o.item.pattern:""))),
              React.createElement("button",{onClick:function(e){e.stopPropagation();setLockItem(o.item);setSelFit(null);setMode("auto")},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,flexShrink:0,minHeight:32}},"ðŸ”’ Lock")),
            swaps.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
              React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em",textTransform:"uppercase"}},"SWAP WITH"),
              React.createElement("div",{style:{display:"flex",gap:6,marginTop:4},className:"hscroll"},
                swaps.map(function(s){return React.createElement("div",{key:s.id,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:8,padding:"6px 10px",border:"1px solid var(--border)",flexShrink:0}},
                  s.photoUrl&&React.createElement("img",{src:s.photoUrl,alt:"",style:{width:24,height:24,objectFit:"cover",borderRadius:4}}),
                  React.createElement(Dot,{color:s.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},s.name||s.color),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)"}},s.ss))}))))}),
        React.createElement("h2",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,letterSpacing:"0.14em",color:"var(--gold)",margin:"16px 0 10px",textTransform:"uppercase"}},"Watch Pairings"),
        React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:16}},(selFit.allW||selFit.watches).slice(0,6).map(function(w,i){return React.createElement(WCard,{key:w.id,w:w,rank:i,detail:true})})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){saveFit(selFit)}},"ðŸ’¾ Save Outfit"),
        React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8},onClick:function(){toggleFav(selFit.id)}},isFav(selFit.id)?"â­ Favorited":"â˜† Add to Favorites"),

        /* Color Palette Analysis */
        (function(){var colors=(selFit.items||[]).map(function(i){return i.color}).filter(Boolean);if(colors.length<2)return null;var harmony=classifyHarmony(colors);return React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"14px",marginTop:12}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:14}},harmony.icon),
            React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},harmony.type+" Palette")),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},colors.map(function(c,i){var ce=Object.entries(CM).find(function(e){return c.toLowerCase().includes(e[0])});var hex=ce?ce[1].h:"#888";return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:8,padding:"6px 10px",border:"1px solid var(--border)"}},React.createElement("div",{style:{width:16,height:16,borderRadius:"50%",background:hex,border:"1px solid rgba(255,255,255,0.1)"}}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",textTransform:"capitalize"}},c))})))})(),

        /* Composite Image Button */
        React.createElement("div",{style:{marginTop:12,display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1},onClick:function(){drawComposite(selFit)}},"ðŸ–¼ï¸ Composite"),
          compositeData&&React.createElement("a",{href:compositeData,download:"outfit-composite.png",className:"btn btn-ghost",style:{flex:1}},"ðŸ’¾ Save Image")),
        compositeData&&React.createElement("img",{src:compositeData,alt:"Composite",style:{width:"100%",maxWidth:300,borderRadius:10,marginTop:8,border:"1px solid var(--border)",display:"block",margin:"8px auto 0"}})),

      /* â•â•â• INSIGHTS â•â•â• */
      view==="insights"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},

        /* 7-day weather strip */
        forecast.length>0&&React.createElement("div",{style:{marginBottom:14}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              return React.createElement("div",{key:i,style:{flex:"0 0 auto",background:fc.cond&&fc.cond.rain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(fc.cond&&fc.cond.rain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"6px 10px",minWidth:62,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",fontWeight:500}},i===0?"Today":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:""),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",fontWeight:600}},fc.high+"Â°/"+fc.low+"Â°"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)"}},"ðŸ’§"+fc.rainPct+"%"))}))),

        /* â”€â”€ ONE-TAP DAILY PICK â”€â”€ */
        React.createElement("div",{style:{background:"linear-gradient(135deg,#0d1018,#0a0914)",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"âš¡"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"Today's Pick")),
          !dailyPick?React.createElement("button",{className:"btn btn-gold",onClick:function(){
            var cx0=weekCtx[new Date().getDay()]||"smart-casual";
            var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock);
            var today=rotation[0];
            if(today&&today.watch){
              var sp=today.strapPick;
              setDailyPick({watch:today.watch,outfit:today.outfit,strap:sp,context:cx0,tier:tier});
            }
          }},"âš¡ What Should I Wear?")
          :React.createElement("div",{className:"fu"},
            /* Watch */
            React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:12}},
              React.createElement("div",{style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:dailyPick.watch.c+"25",fontSize:26,border:"3px solid "+dailyPick.watch.c+"50"}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:18,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},dailyPick.watch.d+" Â· "+(dailyPick.watch.br?"Bracelet":dailyPick.strap?dailyPick.strap.text:"Strap")+" Â· "+(CXI[dailyPick.context]||"")+dailyPick.context),
                !IS_SHARED&&dailyPick.watch.t==="replica"&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid #2a2520",borderRadius:3,padding:"1px 5px",marginTop:2,display:"inline-block"}},"REP"))),
            /* Outfit with mannequin */
            dailyPick.outfit&&React.createElement("div",{style:{display:"flex",gap:12,marginBottom:12,alignItems:"flex-start"}},
              React.createElement(OutfitFigure,{topColor:dailyPick.outfit.top?dailyPick.outfit.top.color:"grey",botColor:dailyPick.outfit.bot?dailyPick.outfit.bot.color:"charcoal",shoeColor:dailyPick.outfit.shoe?dailyPick.outfit.shoe.color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:dailyPick.watch.n,size:110}),
              React.createElement("div",{style:{flex:1,display:"flex",flexDirection:"column",gap:6}},
                [{l:"TOP",item:dailyPick.outfit.top},{l:"BTM",item:dailyPick.outfit.bot},{l:"SHOE",item:dailyPick.outfit.shoe}].map(function(o){
                  if(!o.item)return null;
                  return React.createElement("div",{key:o.l,style:{background:"var(--bg)",borderRadius:10,overflow:"hidden",border:"1px solid var(--border)"}},
                    o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:"100%",height:64,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:40,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{padding:"5px 8px",display:"flex",alignItems:"center",gap:4}},
                      React.createElement(Dot,{color:o.item.color,size:6}),
                      React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500}},o.item.name||o.item.color),
                      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:"auto"}},o.l)))}))),
            /* Actions */
            React.createElement("div",{style:{display:"flex",gap:8}},
              !todayWorn&&React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){logWear(dailyPick.watch.id,todayStr)}},"âœ“ Wearing This"),
              todayWorn&&React.createElement("span",{style:{flex:1,textAlign:"center",fontSize:12,fontFamily:"var(--f)",color:"var(--good)",padding:14}},"âœ“ Logged"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setDailyPick(null);setAiCritique(null)}},"â†»")))),

        /* â”€â”€ AI OUTFIT CRITIQUE â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ§ "),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Critique")),
          dailyPick&&dailyPick.outfit&&dailyPick.watch?React.createElement("div",null,
            !aiCritique&&!aiLoading&&React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiLoading(true);
              var result=await aiVision(dailyPick.outfit,dailyPick.watch,dailyPick.context,apiKeyRef.current);
              if(result)setAiCritique(result);else setAiCritique({vision:"AI unavailable. Check your API key in settings.",impact:0,impact_why:"",works:"",risk:"",strap_call:""});
              setAiLoading(false);
            }},"ðŸ§  Critique Today's Pick"),
            aiLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing...")),
            aiCritique&&React.createElement("div",{className:"fu"},
              /* Vision */
              aiCritique.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,borderLeft:"3px solid var(--gold)"}},
                React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiCritique.vision)),
              /* Impact score */
              aiCritique.impact>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:10}},
                React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiCritique.impact>=7?"rgba(122,184,122,0.15)":aiCritique.impact>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact>=8?"Commanding":aiCritique.impact>=6?"Solid":aiCritique.impact>=4?"Acceptable":"Needs Work"),
                  aiCritique.impact_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},aiCritique.impact_why))),
              /* Details */
              [aiCritique.works&&{l:"âœ“ What Works",t:aiCritique.works,c:"var(--good)"},aiCritique.risk&&{l:"âš  Risk",t:aiCritique.risk,c:"var(--warn)"},aiCritique.strap_call&&{l:"ðŸ”— Strap Call",t:aiCritique.strap_call,c:"var(--sub)"}].filter(Boolean).map(function(item,i){
                return React.createElement("div",{key:i,style:{display:"flex",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:item.c,fontWeight:600,minWidth:70}},item.l),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},item.t))}),
              React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8,fontSize:11},onClick:function(){setAiCritique(null)}},"â†» Re-critique")))
          :React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Generate Today's Pick first â†‘")),

        /* â”€â”€ VISUAL OUTFIT CARD â”€â”€ */
        dailyPick&&dailyPick.outfit&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ´"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Outfit Card")),
          /* The card itself */
          React.createElement("div",{id:"outfit-card",style:{background:"linear-gradient(145deg,#0a0914,#12101a)",borderRadius:16,padding:"20px",border:"1px solid rgba(201,168,76,0.2)",maxWidth:340,margin:"0 auto"}},
            /* Date + context header */
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.12em"}},new Date().toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}).toUpperCase()),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},(CXI[dailyPick.context]||"")+" "+dailyPick.context)),
            /* Mannequin + Color blocks */
            React.createElement("div",{style:{display:"flex",gap:12,marginBottom:16,alignItems:"center"}},
              React.createElement(OutfitFigure,{topColor:dailyPick.outfit.top?dailyPick.outfit.top.color:"grey",botColor:dailyPick.outfit.bot?dailyPick.outfit.bot.color:"charcoal",shoeColor:dailyPick.outfit.shoe?dailyPick.outfit.shoe.color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:"",size:90}),
              React.createElement("div",{style:{flex:1,display:"flex",gap:4,height:120}},
                [dailyPick.outfit.top,dailyPick.outfit.bot,dailyPick.outfit.shoe].filter(Boolean).map(function(item,i){
                  return React.createElement("div",{key:i,style:{flex:1,borderRadius:10,overflow:"hidden",position:"relative"}},
                    item.photoUrl?React.createElement("img",{src:item.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("div",{style:{width:"100%",height:"100%",background:(CM[item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent,rgba(0,0,0,0.7))",padding:"4px 6px"}},
                      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#fff"}},["TOP","BTM","SHOE"][i])))}))),
            /* Watch row */
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,background:"rgba(201,168,76,0.06)",borderRadius:10,padding:"10px 12px"}},
              React.createElement("span",{style:{fontSize:24}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},dailyPick.watch.d+" Â· "+(dailyPick.watch.br?"Bracelet":dailyPick.strap?dailyPick.strap.text:"Strap"))),
              aiCritique&&aiCritique.impact>0&&React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact)),
            React.createElement("div",{style:{textAlign:"center",marginTop:12}},
              React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#2a2530",letterSpacing:"0.2em"}},"WATCH ADVISOR")))),

        /* â”€â”€ COLLECTION HEATMAP â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ—ºï¸"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Context Coverage")),
          React.createElement("div",{style:{overflowX:"auto"},className:"hscroll"},
            React.createElement("div",{style:{minWidth:Math.max(500,activeCxIds.slice(0,8).length*60+120)}},
              /* Header row */
              React.createElement("div",{style:{display:"flex",gap:2,marginBottom:4,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.05em"}},(activeCxIcons[cx]||CXI[cx]||"")+"\n"+cx)})),
              /* Watch rows */
              actW.slice(0,20).map(function(w){
                return React.createElement("div",{key:w.id,style:{display:"flex",gap:2,marginBottom:2,alignItems:"center"}},
                  React.createElement("div",{style:{flex:"0 0 108px",display:"flex",alignItems:"center",gap:4,overflow:"hidden"}},
                    React.createElement("span",{style:{fontSize:12}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},w.n)),
                  activeCxIds.slice(0,8).map(function(cx){
                    var inCtx=(w.cx||[]).includes(cx);
                    var colorScore=0;
                    (w.mc||[]).forEach(function(mc){if(["navy","charcoal","white","cream","black","grey"].includes(mc))colorScore++});
                    var heat=inCtx?(colorScore>4?3:colorScore>2?2:1):0;
                    var bg=heat===3?"rgba(122,184,122,0.4)":heat===2?"rgba(122,184,122,0.2)":heat===1?"rgba(201,168,76,0.15)":"#0a0910";
                    return React.createElement("div",{key:cx,style:{flex:"0 0 52px",height:20,borderRadius:3,background:bg,border:"1px solid "+(inCtx?"rgba(122,184,122,0.15)":"#0f0e14")}})}))}),
              /* Coverage summary */
              React.createElement("div",{style:{display:"flex",gap:2,marginTop:8,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){
                  var count=actW.filter(function(w){return(w.cx||[]).includes(cx)}).length;
                  var pct=actW.length?Math.round(count/actW.length*100):0;
                  return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:700,color:count>=5?"var(--good)":count>=3?"var(--gold)":"var(--warn)"}},count),
                    React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},pct+"%"))})),
              /* Legend */
              React.createElement("div",{style:{display:"flex",gap:12,marginTop:10,paddingLeft:110}},
                [{c:"rgba(122,184,122,0.4)",l:"Strong"},{c:"rgba(122,184,122,0.2)",l:"Good"},{c:"rgba(201,168,76,0.15)",l:"Basic"},{c:"#0a0910",l:"None"}].map(function(lg){
                  return React.createElement("div",{key:lg.l,style:{display:"flex",alignItems:"center",gap:4}},
                    React.createElement("div",{style:{width:12,height:12,borderRadius:2,background:lg.c,border:"1px solid #1a1828"}}),
                    React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},lg.l))})))),

        /* â”€â”€ WARDROBE COLOR WHEEL â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ¨"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Color Distribution")),
          (function(){
            /* Count colors across wardrobe */
            var colorCounts={};
            wd.filter(function(i){return i.color}).forEach(function(i){var c=i.color.toLowerCase();colorCounts[c]=(colorCounts[c]||0)+1});
            var sorted=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]});
            var total=wd.filter(function(i){return i.color}).length||1;
            /* Watch dial colors */
            var watchColors={};
            actW.forEach(function(w){var d=(w.d||"").toLowerCase();watchColors[d]=(watchColors[d]||0)+1});
            var wSorted=Object.entries(watchColors).sort(function(a,b){return b[1]-a[1]});
            /* Temperature balance */
            var warm=0,cool=0,neutral=0;
            sorted.forEach(function(e){var t=(CM[e[0]]||{}).t;if(t==="warm")warm+=e[1];else if(t==="cool")cool+=e[1];else neutral+=e[1]});
            return React.createElement("div",null,
              /* Color bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var pct=Math.round(e[1]/total*100);
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
                    React.createElement(Dot,{color:e[0],size:12}),
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:70}},e[0]),
                    React.createElement("div",{style:{flex:1,height:14,background:"#0a0910",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:(CM[e[0]]||{}).h||"#5a5a5a",borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:24,textAlign:"right"}},e[1]))})),
              /* Temp balance */
              React.createElement("div",{style:{display:"flex",gap:4,marginBottom:14}},
                [{l:"Warm",v:warm,c:"#d87a2a"},{l:"Cool",v:cool,c:"#2a5a9a"},{l:"Neutral",v:neutral,c:"#8a8a8a"}].map(function(t){
                  var pct=Math.round(t.v/total*100);
                  return React.createElement("div",{key:t.l,style:{flex:t.v||1,background:t.c+"30",borderRadius:8,padding:"8px 10px",textAlign:"center",border:"1px solid "+t.c+"20"}},
                    React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:t.c}},pct+"%"),
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},t.l))})),
              /* Watch dials */
              wSorted.length>0&&React.createElement("div",null,
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WATCH DIAL COLORS"),
                React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                  wSorted.map(function(e){return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},e[0]),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"Ã—"+e[1]))}))));
          })())),

        /* â”€â”€ SEASONAL CLOSET GAPS â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ“…"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Seasonal Readiness")),
          (function(){
            var seasons=["spring","summer","fall","winter"];var icons={spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"};
            var cats=["tops","bottoms","shoes"];
            var data=seasons.map(function(s){
              var counts={};cats.forEach(function(cat){
                counts[cat]=wd.filter(function(i){return catOf(i.garmentType)===cat&&i.color&&(!i.seasons||!i.seasons.length||i.seasons.length>=4||i.seasons.includes(s))}).length;
              });
              var total=counts.tops+counts.bottoms+counts.shoes;
              var ready=counts.tops>=2&&counts.bottoms>=2&&counts.shoes>=1;
              return{s:s,icon:icons[s],counts:counts,total:total,ready:ready};
            });
            var curSn=(function(){var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
            return React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
              data.map(function(d){
                return React.createElement("div",{key:d.s,style:{background:d.s===curSn?"rgba(201,168,76,0.06)":"var(--bg)",border:"1px solid "+(d.s===curSn?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:10,padding:"10px 12px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:6}},
                    React.createElement("span",{style:{fontSize:16}},d.icon),
                    React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:d.s===curSn?"var(--gold)":"var(--text)",textTransform:"capitalize"}},d.s),
                    d.s===curSn&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--gold)",background:"rgba(201,168,76,0.15)",borderRadius:3,padding:"1px 5px"}},"NOW"),
                    React.createElement("span",{style:{marginLeft:"auto",fontSize:10,color:d.ready?"var(--good)":"var(--warn)"}},d.ready?"âœ“":"âš ")),
                  React.createElement("div",{style:{display:"flex",gap:4}},
                    [{l:"ðŸ‘•",v:d.counts.tops,min:2},{l:"ðŸ‘–",v:d.counts.bottoms,min:2},{l:"ðŸ‘ž",v:d.counts.shoes,min:1}].map(function(c,ci){
                      return React.createElement("div",{key:ci,style:{flex:1,textAlign:"center",borderRadius:6,padding:"4px 2px",background:c.v>=c.min?"rgba(122,184,122,0.1)":"rgba(200,90,58,0.08)",border:"1px solid "+(c.v>=c.min?"rgba(122,184,122,0.15)":"rgba(200,90,58,0.15)")}},
                        React.createElement("div",{style:{fontSize:10}},c.l),
                        React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:c.v>=c.min?"var(--good)":"var(--warn)"}},c.v))})));
              }));
          })()),

        /* â”€â”€ GARMENT ROTATION STATS â”€â”€ */
        wd.some(function(i){return i.lastWorn})&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ‘”"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Garment Rotation")),
          (function(){
            var now=Date.now();var tracked=wd.filter(function(i){return i.lastWorn&&i.color});
            if(!tracked.length)return null;
            /* Sort by stalest first */
            var sorted=tracked.map(function(i){return{g:i,d:Math.floor((now-new Date(i.lastWorn).getTime())/864e5)}}).sort(function(a,b){return b.d-a.d});
            var maxD=sorted[0].d||1;
            return React.createElement("div",null,
              React.createElement("div",{style:{display:"flex",gap:8,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:8}},
                React.createElement("span",null,"ðŸ“ "+tracked.length+" garments tracked"),
                React.createElement("span",null,"Avg "+Math.round(sorted.reduce(function(a,b){return a+b.d},0)/sorted.length)+"d between wears")),
              sorted.slice(0,8).map(function(e){
                var pct=Math.round(e.d/maxD*100);
                var col=e.d<=2?"var(--warn)":e.d<=7?"var(--gold)":e.d<=14?"var(--sub)":"var(--good)";
                return React.createElement("div",{key:e.g.id,style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                  e.g.photoUrl?React.createElement("img",{src:e.g.photoUrl,alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}):React.createElement(Dot,{color:e.g.color,size:8}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},e.g.name||e.g.color),
                  React.createElement("div",{style:{flex:1,height:8,background:"#0a0910",borderRadius:4,overflow:"hidden"}},
                    React.createElement("div",{style:{height:"100%",width:pct+"%",background:col,borderRadius:4,minWidth:2}})),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:col,minWidth:32,textAlign:"right"}},e.d===0?"today":e.d+"d"))}),
              sorted.length>8&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",marginTop:4}},"+"+(sorted.length-8)+" more garments tracked"));
          })()),

        /* â”€â”€ WEAR STATS DASHBOARD â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ“Š"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Wear Stats")),
          (function(){
            if(!wearLog.length)return React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Start logging wear in the rotation tab to build stats.");
            /* Count wears per watch */
            var wearCounts={};var genWears=0;var repWears=0;
            wearLog.forEach(function(e){wearCounts[e.watchId]=(wearCounts[e.watchId]||0)+1;var wObj=W.find(function(w){return w.id===e.watchId});if(wObj){if(wObj.t==="genuine")genWears++;else repWears++}});
            var sorted=Object.entries(wearCounts).sort(function(a,b){return b[1]-a[1]});
            var maxWears=sorted.length?sorted[0][1]:1;
            /* Never-worn active watches */
            var neverWorn=actW.filter(function(w){return !wearCounts[w.id]&&w.status==="active"});
            /* Streak â€” consecutive days logged */
            var dates=wearLog.map(function(e){return e.date}).sort().reverse();
            var uniqueDates=[...new Set(dates)];
            var streak=0;var checkDate=new Date();
            for(var si=0;si<90;si++){var ds=checkDate.toISOString().slice(0,10);if(uniqueDates.includes(ds)){streak++;checkDate.setDate(checkDate.getDate()-1)}else if(si===0){checkDate.setDate(checkDate.getDate()-1);continue}else break}
            return React.createElement("div",null,
              /* Summary row */
              React.createElement("div",{style:{display:"flex",gap:8,marginBottom:14}},
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--gold)"}},wearLog.length),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Total wears")),
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--good)"}},streak),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Day streak")),
                !IS_SHARED&&React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid "+(genWears>=repWears?"rgba(122,184,122,0.3)":"rgba(200,90,58,0.3)")}},
                  React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:genWears>=repWears?"var(--good)":"var(--warn)"}},genWears+"/"+repWears),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Gen / Rep"))),
              /* Frequency bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var wObj=W.find(function(w){return w.id===e[0]});if(!wObj)return null;
                  var pct=Math.round(e[1]/maxWears*100);
                  var barC=IS_SHARED?"var(--gold)":(wObj.t==="genuine"?"var(--good)":"#7ab8d8");
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                    React.createElement("span",{style:{fontSize:12,flexShrink:0,width:18,textAlign:"center"}},wObj.i),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},wObj.n),
                    React.createElement("div",{style:{flex:1,height:12,background:"#0a0910",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:barC,borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:18,textAlign:"right"}},e[1]))})),
              /* 4-week wear calendar */
              React.createElement("div",{style:{marginTop:10,paddingTop:10,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WEAR CALENDAR"),
                React.createElement("div",{style:{display:"flex",gap:3,marginBottom:4}},["S","M","T","W","T","F","S"].map(function(d,i){return React.createElement("div",{key:i,style:{flex:1,textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},d)})),
                (function(){
                  var cells=[];var today=new Date();
                  for(var ci=27;ci>=0;ci--){var cd=new Date(today);cd.setDate(cd.getDate()-ci);cells.push({date:cd.toISOString().slice(0,10),dow:cd.getDay()})}
                  /* Pad start to align with day-of-week */
                  var padStart=cells[0]?cells[0].dow:0;var padded=[];for(var pi=0;pi<padStart;pi++)padded.push(null);padded=padded.concat(cells);
                  var rows=[];for(var ri=0;ri<padded.length;ri+=7)rows.push(padded.slice(ri,ri+7));
                  return React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:2}},
                    rows.map(function(row,ri2){return React.createElement("div",{key:ri2,style:{display:"flex",gap:3}},
                      row.concat(Array(7-row.length).fill(null)).slice(0,7).map(function(cell,ci2){
                        if(!cell)return React.createElement("div",{key:ci2,style:{flex:1,height:18,borderRadius:3}});
                        var entry=wearLog.find(function(e){return e.date===cell.date});var wObj=entry?W.find(function(w){return w.id===entry.watchId}):null;
                        var bg=wObj?wObj.c:"#1a1828";
                        return React.createElement("div",{key:ci2,title:cell.date+(wObj?" â€” "+wObj.n:""),style:{flex:1,height:18,borderRadius:3,background:bg,border:"1px solid "+(wObj?bg+"60":"#0f0e14"),opacity:wObj?1:0.4}})}))}));
                })()),

              /* Never worn section */
              neverWorn.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"ðŸ’¤ NEVER LOGGED ("+neverWorn.length+")"),
                React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
                  neverWorn.map(function(w){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(200,90,58,0.06)",border:"1px solid rgba(200,90,58,0.15)",borderRadius:6,padding:"3px 8px"}},
                    React.createElement("span",{style:{fontSize:10}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},w.n))}))));
          })())),

        /* â”€â”€ STYLE DNA RADAR â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ§¬"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Style DNA")),
          saved.length<3?React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Save 3+ outfits to generate your Style DNA")
          :React.createElement("div",null,
            React.createElement("div",{style:{display:"flex",justifyContent:"center",marginBottom:12}},
              React.createElement("canvas",{id:"radarCanvas",width:260,height:260,ref:function(el){if(el)setTimeout(function(){drawRadar("radarCanvas")},100)}})),
            React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",justifyContent:"center"}},
              DNA_DIMS.map(function(d){var v=dnaScores[d]||5;return React.createElement("div",{key:d,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:8,padding:"5px 10px",border:"1px solid var(--border)"}},
                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700}},v.toFixed(1)),
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},d))})))),

        /* â”€â”€ AI STYLE INSIGHTS â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ’¡"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Style Insights")),
          !aiInsights&&!aiInsightsLoading&&React.createElement("button",{className:"btn btn-gold",onClick:fetchAiInsights},"ðŸ’¡ Analyze My Style"),
          aiInsightsLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing patterns...")),
          aiInsights&&React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:10}},
            aiInsights.map(function(ins,i){return React.createElement("div",{key:i,style:{background:"var(--bg)",borderRadius:10,padding:"12px",border:"1px solid var(--border)",borderLeft:"3px solid var(--gold)"}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:6}},
                React.createElement("span",{style:{fontSize:16}},ins.icon||"ðŸ’Ž"),
                React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},ins.title)),
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--text)",lineHeight:1.5,margin:"0 0 6px"}},ins.insight),
              ins.action&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--good)",fontStyle:"italic"}},"â†’ "+ins.action))}),
            React.createElement("button",{className:"btn btn-ghost",style:{marginTop:4,fontSize:10},onClick:function(){setAiInsights(null)}},"â†» Re-analyze"))),

      /* â•â•â• WATCHES â•â•â• */
      view==="watches"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* Collection Stats */
        (function(){
          var gen=W.filter(function(w){return w.t==="genuine"&&w.active}).length;
          var rep=W.filter(function(w){return w.t==="replica"&&w.active}).length;
          var brC=W.filter(function(w){return w.br&&w.active}).length;
          var stC=W.filter(function(w){return!w.br&&w.active}).length;
          var cats={};W.filter(function(w){return w.active}).forEach(function(w){(w.cx||[]).forEach(function(c){cats[c]=(cats[c]||0)+1})});
          var topCx=Object.entries(cats).sort(function(a,b){return b[1]-a[1]}).slice(0,3);
          return React.createElement("div",{style:{background:"linear-gradient(135deg,#0d1018,#0a0914)",border:"1px solid var(--border)",borderRadius:12,padding:"12px 16px",marginBottom:12}},
            React.createElement("div",{style:{display:"flex",gap:16,flexWrap:"wrap",fontSize:10,fontFamily:"var(--f)"}},
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--gold)",fontWeight:700,fontSize:18}},gen+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"active")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"var(--good)"}},"âœ“ "+gen),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"genuine")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"#7ab8d8"}},"â—‡ "+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"replica")),
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--sub)"}},"â›“ï¸"+brC+" ðŸ”—"+stC))),
            topCx.length>0&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:6}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Top contexts:"),
              topCx.map(function(e){return React.createElement("span",{key:e[0],style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},(CXI[e[0]]||"")+e[0]+" Ã—"+e[1])})));
        })(),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:12}},
          (IS_SHARED?[{id:"all",l:"All "+W.length},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]:[{id:"all",l:"All "+W.length},{id:"genuine",l:"Gen"},{id:"replica",l:"Rep"},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]).map(function(f){return React.createElement(Pill,{key:f.id,on:wTab===f.id,onClick:function(){setWTab(f.id)}},f.l)}),
          React.createElement("button",{onClick:function(){var nw={id:"c-"+Date.now(),n:"New Watch",t:"genuine",d:"",c:"#5a5a5a",br:true,sc:[],mt:"cool",i:"âŒš",mc:IS_SHARED?autoMatchColors(""):[],ac:[],cx:["casual"],wt:IS_SHARED?["light","mid","heavy"]:["mid"],sg:"",active:true,status:"active"};setW(function(p){var u=p.concat([nw]);ps("w_"+SK,u);return u});setEditW(nw)},style:{marginLeft:"auto",background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:20,padding:"8px 16px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"+ Add")),
        filtW.length===0&&React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},"No watches match filter")),
        filtW.map(function(w){var st=STS.find(function(s){return s.id===w.status});return React.createElement("div",{key:w.id,className:"card-lift",style:{background:w.active?"var(--card)":"#08070c",border:"1px solid "+(w.active?"var(--border)":"#121018"),borderRadius:12,padding:"14px 16px",opacity:w.active?1:0.5,marginBottom:8}},
          React.createElement("div",{style:{display:"flex",gap:12,alignItems:"flex-start"}},
            React.createElement("div",{onClick:function(){toggleW(w.id)},style:{width:44,height:44,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.active?w.c+"20":"#0a0910",fontSize:20,flexShrink:0,cursor:"pointer",border:"2px solid "+(w.active?w.c+"60":"#1a1820"),overflow:"hidden"}},w.photoUrl?React.createElement("img",{src:w.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):w.i),
            React.createElement("div",{style:{flex:1,minWidth:0,cursor:"pointer"},onClick:function(){setEditW(w)}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:3}},
                React.createElement("span",{style:{fontSize:14,fontWeight:600,color:w.active?"var(--text)":"var(--dim)"}},w.n),
                !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid #2a2520",borderRadius:3,padding:"1px 5px"}},"REP"),
                React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:w.c}}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:st?st.c:"var(--dim)"}},st?st.l:"")),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:4}},w.d+(w.size?" Â· "+w.size:"")+" Â· "+(w.br?"Bracelet":"Strap"+(w.sc&&w.sc.length?": "+w.sc.join(", "):""))+" Â· "+w.mt),
              React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},(w.cx||[]).map(function(c){return React.createElement("span",{key:c,style:{fontSize:8,fontFamily:"var(--f)",background:"var(--bg)",borderRadius:8,padding:"2px 6px",color:"var(--dim)"}},(CXI[c]||"")+c)}))),
            React.createElement("button",{onClick:function(e){e.stopPropagation();toggleW(w.id)},style:{width:44,height:26,borderRadius:13,background:w.active?"var(--gold)":"#1a1820",border:"none",cursor:"pointer",position:"relative",flexShrink:0,minHeight:26}},
              React.createElement("div",{style:{width:20,height:20,borderRadius:"50%",background:w.active?"var(--bg)":"#2a2830",position:"absolute",top:3,left:w.active?21:3,transition:"left .2s"}}))))}),
        React.createElement("button",{onClick:function(){if(confirm("Reset to defaults?")){setW(DEFAULTS);ps("w_"+SK,DEFAULTS)}},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:40}},"Reset Defaults")),

      /* â•â•â• SAVED â•â•â• */
      view==="saved"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        !saved.length?React.createElement("div",{style:{textAlign:"center",padding:"50px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"ðŸ“‹"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"#5a5464"}},"No saved outfits"))
        :saved.map(function(o){var oTop=o.items?o.items.find(function(i){return catOf(i.garmentType)==="tops"}):null;var oBot=o.items?o.items.find(function(i){return catOf(i.garmentType)==="bottoms"}):null;var oSh=o.items?o.items.find(function(i){return catOf(i.garmentType)==="shoes"}):null;return React.createElement("div",{key:o.id,className:"card-lift",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:10,marginBottom:8}},
            React.createElement(OutfitFigure,{topColor:oTop?oTop.color:"grey",botColor:oBot?oBot.color:"charcoal",shoeColor:oSh?oSh.color:"black",watchColor:o.watches&&o.watches[0]?o.watches[0].c:"#c9a84c",watchIcon:o.watches&&o.watches[0]?o.watches[0].i:"âŒš",watchName:"",size:60}),
            React.createElement("div",{style:{flex:1,minWidth:0}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}},
                React.createElement("div",null,React.createElement("h3",{style:{fontSize:14,fontWeight:500,margin:"0 0 2px"}},o.name),React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",margin:0}},(activeCxIcons[o.context]||"")+" "+o.context+" Â· "+new Date(o.ts).toLocaleDateString()+(o.fs?" Â· Score "+o.fs:"")),o.weather&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"1px 6px",border:"1px solid rgba(100,150,220,0.15)",marginTop:2,display:"inline-block"}},(o.weather.cond?o.weather.cond.i:"")+" "+o.weather.temp+"Â°C")),
                React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end"}},
                  React.createElement("button",{onClick:function(){delSaved(o.id)},style:{background:"none",border:"1px solid #2a1a1a",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"#6a3a3a",fontFamily:"var(--f)",fontSize:10,minHeight:30}},"âœ•"),
                  /* Weather match badge */
                  weather&&o.weather&&(function(){var ct=weather.temp||18,ot=o.weather.temp||18,diff=Math.abs(ct-ot);var cRain=weather.cond&&weather.cond.rain,oRain=o.weather.cond&&o.weather.cond.rain;var match=diff<=5&&cRain===oRain?"great":diff<=10?"ok":"poor";return React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,color:match==="great"?"var(--good)":match==="ok"?"var(--gold)":"var(--warn)",background:match==="great"?"rgba(122,184,122,0.1)":match==="ok"?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",border:"1px solid "+(match==="great"?"rgba(122,184,122,0.2)":match==="ok"?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},match==="great"?"âœ“ Today match":match==="ok"?"~ Similar wx":"âœ— Diff weather")})())))),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}},(o.items||[]).map(function(item,i){return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid #141220"}},item.photoUrl&&React.createElement("img",{src:item.photoUrl,alt:"",style:{width:20,height:20,objectFit:"cover",borderRadius:3}}),React.createElement(Dot,{color:item.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"#a8a098"}},item.name||item.color))})),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},(o.watches||[]).slice(0,3).map(function(w,i){return React.createElement("div",{key:w.id||i,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:i===0?"1px solid rgba(201,168,76,0.2)":"1px solid #141220"}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"#a8a098"}},w.n))})))})))
  ,

      /* â•â•â• FAVORITES â•â•â• */
      view==="favs"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        !favorites.length?React.createElement("div",{style:{textAlign:"center",padding:"50px 16px"}},
          React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"â­"),
          React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"#5a5464"}},"No favorites yet"),
          React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},"Tap â˜† on any outfit in FITS to add it"))
        :React.createElement("div",null,
          React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:12}},favorites.length+" favorite"+(favorites.length!==1?"s":"")),
          favorites.slice().sort(function(a,b){return(b.favTs||0)-(a.favTs||0)}).map(function(fav){
            var fTop=fav.top||(fav.items?fav.items.find(function(i){return catOf(i.garmentType)==="tops"}):null);
            var fBot=fav.bot||(fav.items?fav.items.find(function(i){return catOf(i.garmentType)==="bottoms"}):null);
            var fSh=fav.shoe||(fav.items?fav.items.find(function(i){return catOf(i.garmentType)==="shoes"}):null);
            return React.createElement("div",{key:fav.id,className:"card-lift",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10,position:"relative"}},
              React.createElement("div",{style:{position:"absolute",top:8,right:10,cursor:"pointer"},onClick:function(){toggleFav(fav.id)}},React.createElement("span",{style:{fontSize:16}},"â­")),
              React.createElement("div",{style:{display:"flex",gap:10,marginBottom:8}},
                React.createElement(OutfitFigure,{topColor:fTop?fTop.color:"grey",botColor:fBot?fBot.color:"charcoal",shoeColor:fSh?fSh.color:"black",watchColor:fav.watches&&fav.watches[0]?fav.watches[0].c:"#c9a84c",watchIcon:fav.watches&&fav.watches[0]?fav.watches[0].i:"âŒš",watchName:"",size:60}),
                React.createElement("div",{style:{flex:1,minWidth:0}},
                  React.createElement("div",{style:{fontSize:13,fontWeight:500,marginBottom:2}},fav.name||"Outfit"),
                  React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},(fav.context||"")+" Â· Score "+(fav.fs||"?")),
                  fav.favTs&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginTop:2}},"Fav'd "+new Date(fav.favTs).toLocaleDateString()))),
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},(fav.watches||[]).slice(0,3).map(function(w,i){return React.createElement("div",{key:w.id||i,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:i===0?"1px solid rgba(201,168,76,0.2)":"1px solid #141220"}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"#a8a098"}},w.n))})))})})))),

      /* â•â•â• PROFILE MODAL â•â•â• */
      showProfile&&React.createElement("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.7)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setShowProfile(false)}},
        React.createElement("div",{style:{background:"var(--card)",borderRadius:16,padding:"24px",maxWidth:340,width:"100%",border:"1px solid var(--border)"},onClick:function(e){e.stopPropagation()}},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}},
            React.createElement("h2",{style:{fontSize:18,fontWeight:600,margin:0}},"ðŸ‘¤ Profile"),
            React.createElement("button",{onClick:function(){setShowProfile(false)},style:{background:"none",border:"none",color:"var(--dim)",fontSize:20,cursor:"pointer",padding:4,minHeight:30}},"âœ•")),
          React.createElement("div",{style:{display:"flex",justifyContent:"center",marginBottom:20}},
            React.createElement("div",{style:{width:64,height:64,borderRadius:"50%",background:"linear-gradient(135deg,rgba(201,168,76,0.2),rgba(201,168,76,0.05))",border:"2px solid var(--gold)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:28,color:"var(--gold)"}},profileName?profileName.charAt(0).toUpperCase():"ðŸ‘¤")),
          React.createElement("div",{style:{marginBottom:14}},
            React.createElement("label",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",display:"block",marginBottom:4}},"NAME"),
            React.createElement("input",{type:"text",value:profileName,onChange:function(e){setProfileName(e.target.value)},placeholder:"Your name",style:{width:"100%",background:"var(--bg)",border:"1px solid var(--border)",borderRadius:8,padding:"10px 12px",color:"var(--text)",fontFamily:"var(--f)",fontSize:13,boxSizing:"border-box"}})),
          React.createElement("div",{style:{marginBottom:20}},
            React.createElement("label",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",display:"block",marginBottom:4}},"BIO"),
            React.createElement("textarea",{value:profileBio,onChange:function(e){setProfileBio(e.target.value)},placeholder:"Watch enthusiast...",rows:3,style:{width:"100%",background:"var(--bg)",border:"1px solid var(--border)",borderRadius:8,padding:"10px 12px",color:"var(--text)",fontFamily:"var(--f)",fontSize:12,resize:"vertical",boxSizing:"border-box"}})),
          React.createElement("button",{className:"btn btn-gold",style:{width:"100%"},onClick:function(){saveProfile()}},"ðŸ’¾ Save Profile")))

  );
}
ReactDOM.render(React.createElement(App),document.getElementById("root"));

// PWA Service Worker Registration
if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('./sw.js').then(function(r){
      console.log('SW registered:',r.scope);
    }).catch(function(e){console.log('SW failed:',e)});
  });
}
</script>
</body>
</html>
