<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#12101a">
<link rel="manifest" href="./manifest.json">
<title>Watch Advisor v22</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#07060a;--card:#0d0c14;--card2:#12101a;--card3:#14121e;--border:#1c1828;--gold:#c9a84c;--text:#e0dcd4;--sub:#7a7484;--dim:#4a4458;--warn:#c85a3a;--good:#7ab87a;--badge-good:#0a1a0a;--badge-warn:#1a0a0a;--badge-neutral:#0a0a1a;--del-text:#6a3a3a;--del-border:#2a1a1a;--rep-border:#2a2520;--f:'DM Sans',sans-serif;--sf:'Cormorant Garamond',Georgia,serif}
html,body{background:var(--bg);color:var(--text);font-family:var(--sf);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body.modal-open{overflow:hidden;position:fixed;width:100%;touch-action:none}
/* Safety: ensure modal class gets cleaned up */
body:not(.modal-open){position:static!important;touch-action:auto!important}
input,select,button,textarea{font-family:var(--f);outline:none}
input[type="file"]{display:none}
input,select,textarea{font-size:16px!important}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.fu{animation:fadeUp .3s ease both}.sp{animation:spin 1s linear infinite}.pu{animation:pulse 1.5s ease infinite}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.hscroll{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}.hscroll::-webkit-scrollbar{display:none}
.chip{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:12px;font-size:11px;font-family:var(--f);cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--sub);white-space:nowrap;transition:all .15s;min-height:32px;touch-action:manipulation;user-select:none}
.chip.on{background:rgba(201,168,76,0.1);border-color:rgba(201,168,76,0.3);color:var(--gold)}
.chip:active{transform:scale(0.95)}
.inp{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.inp:focus{border-color:rgba(201,168,76,0.4)}
.sel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);width:100%}
.lbl{font-size:9px;font-family:var(--f);color:var(--dim);letter-spacing:0.1em;margin-bottom:4px;display:block;text-transform:uppercase}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;display:flex;flex-direction:column;justify-content:flex-end;animation:fadeIn .15s ease}
.modal-body{background:var(--card);border-radius:20px 20px 0 0;padding:20px 20px max(env(safe-area-inset-bottom,20px),20px);max-height:92vh;overflow-y:auto;animation:slideUp .25s ease}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 14px}
.swatch{width:34px;height:34px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;flex-shrink:0;touch-action:manipulation}
.swatch:active{transform:scale(0.9)}
.swatch.on{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,0.3)}
.btn{border:none;border-radius:10px;padding:14px;cursor:pointer;font-family:var(--f);font-size:14px;font-weight:600;width:100%;text-align:center;min-height:48px;touch-action:manipulation;user-select:none}
.btn:active{transform:scale(0.98)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8882a);color:var(--bg)}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--sub)}
.outfit-slot{background:var(--bg);border:2px dashed var(--border);border-radius:12px;padding:10px;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all .2s}
.outfit-slot.filled{border-style:solid;border-color:var(--border)}
.outfit-slot.active{border-color:var(--gold);background:var(--card)}
.score-bar{height:5px;border-radius:3px;background:var(--border);overflow:hidden}
.score-fill{height:100%;border-radius:3px;transition:width .4s ease}
.card-lift{box-shadow:0 2px 8px rgba(0,0,0,0.25);transition:all .15s;touch-action:manipulation}
.card-lift:active{transform:scale(0.98);box-shadow:0 1px 4px rgba(0,0,0,0.2)}
.gcard{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;transition:all .15s;touch-action:manipulation}
.gcard:active{transform:scale(0.97)}
.gcard-overlay{position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,0.7));pointer-events:none}
.dots-row{display:flex;gap:3px;align-items:center}
.onboard{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
.onboard h1{font-size:32px;font-weight:300;letter-spacing:0.2em;color:var(--gold);margin-bottom:8px}
body.light{--bg:#f5f4f0;--card:#ffffff;--card2:#fafaf8;--card3:#f0efe8;--border:#e0dcd4;--gold:#b8962a;--text:#1a1a1a;--sub:#6a6464;--dim:#9a9494;--warn:#c85a3a;--good:#2a8a2a;--badge-good:#e6f4e6;--badge-warn:#f4e6e6;--badge-neutral:#eaeaf2;--del-text:#c85a3a;--del-border:#e0c8c8;--rep-border:#d0ccc4}
body.light .chip{background:#f0efe8;color:#6a6464;border-color:#e0dcd4}
body.light .chip.on{background:rgba(184,150,42,0.12);border-color:rgba(184,150,42,0.35);color:#b8962a}
body.light .inp,body.light .sel{background:#f5f4f0;border-color:#e0dcd4;color:#1a1a1a}
body.light .modal-backdrop{background:rgba(0,0,0,0.5)}
body.light .modal-body{background:#ffffff}
body.light .modal-handle{background:var(--border)}
body.light .score-bar{background:var(--border)}
body.light .card-lift{box-shadow:0 2px 8px rgba(0,0,0,0.08)}
body.light .btn-gold{background:linear-gradient(135deg,#b8962a,#9a7a1a);color:#fff}
body.light .btn-ghost{border-color:#e0dcd4;color:#6a6464}
body.light .gcard{border-color:#e0dcd4}
body.light .swatch.on{border-color:#b8962a;box-shadow:0 0 0 3px rgba(184,150,42,0.3)}
body.light .gcard-overlay{background:linear-gradient(transparent,rgba(255,255,255,0.6))}
body.light input,body.light select,body.light textarea{color:#1a1a1a}
body.light .outfit-slot.active{background:rgba(184,150,42,0.06)}
.theme-toggle{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;color:var(--dim);font-size:14px;min-height:32px;transition:all .2s}
.theme-toggle:hover{border-color:var(--gold);color:var(--gold)}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useRef,useMemo,useEffect,useCallback,memo}=React;

/* â•â•â•â•â•â• CONFIG â•â•â•â•â•â• */
/* Set IS_SHARED=true to create a version for friends (empty collection, onboarding) */
const IS_SHARED=false;

/* â•â•â• ENCRYPTED BACKUP / RECOVERY â•â•â• */
async function deriveKey(password,salt){
  var enc=new TextEncoder();
  var keyMaterial=await crypto.subtle.importKey("raw",enc.encode(password),"PBKDF2",false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:310000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encryptData(plaintext,password){
  var salt=crypto.getRandomValues(new Uint8Array(16));
  var iv=crypto.getRandomValues(new Uint8Array(12));
  var key=await deriveKey(password,salt);
  var enc=new TextEncoder();
  var ct=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc.encode(plaintext));
  /* Pack: 16 salt + 12 iv + ciphertext */
  var buf=new Uint8Array(16+12+ct.byteLength);
  buf.set(salt,0);buf.set(iv,16);buf.set(new Uint8Array(ct),28);
  return buf;
}
async function decryptData(packed,password){
  var salt=packed.slice(0,16);
  var iv=packed.slice(16,28);
  var ct=packed.slice(28);
  var key=await deriveKey(password,salt);
  var pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,ct);
  return new TextDecoder().decode(pt);
}
const SK="v14"; /* storage key suffix â€” change to reset data */

/* â•â•â•â•â•â• DATA â•â•â•â•â•â• */
const CM={
"black":{h:"#1a1a1a",t:"cool"},"white":{h:"#f0f0ec",t:"neutral"},"cream":{h:"#f5f0e0",t:"warm"},
"ivory":{h:"#f8f4ea",t:"warm"},"grey":{h:"#8a8a8a",t:"cool"},"light grey":{h:"#c0c0c0",t:"cool"},
"charcoal":{h:"#3a3a3a",t:"cool"},"navy":{h:"#1a2a4a",t:"cool"},"blue":{h:"#2a5a9a",t:"cool"},
"light blue":{h:"#7ab0d8",t:"cool"},"cobalt":{h:"#0047AB",t:"cool"},"teal":{h:"#1a8a7a",t:"cool"},
"turquoise":{h:"#2ab8a8",t:"cool"},"green":{h:"#2a6a3a",t:"cool"},"forest green":{h:"#1a4a2a",t:"cool"},
"olive":{h:"#5a6a3a",t:"warm"},"sage":{h:"#8aaa7a",t:"cool"},"red":{h:"#b83a3a",t:"warm"},
"burgundy":{h:"#6a1a2a",t:"warm"},"wine":{h:"#5a1a2a",t:"warm"},"plum":{h:"#6a2a5a",t:"warm"},
"pink":{h:"#d88a9a",t:"warm"},"orange":{h:"#d87a2a",t:"warm"},"burnt orange":{h:"#b85a2a",t:"warm"},
"yellow":{h:"#d4b82a",t:"warm"},"brown":{h:"#6a4a2a",t:"warm"},"tan":{h:"#c8a878",t:"warm"},
"camel":{h:"#c8a060",t:"warm"},"chocolate":{h:"#3a2a1a",t:"warm"},"khaki":{h:"#b8a878",t:"warm"},
"beige":{h:"#d8c8a8",t:"warm"},"lavender":{h:"#9a8abc",t:"cool"},"purple":{h:"#5a2a7a",t:"cool"},
"denim":{h:"#4a6a8a",t:"cool"},"dark brown":{h:"#4a3020",t:"warm"},"rust":{h:"#a84a2a",t:"warm"},
"sand":{h:"#c8b898",t:"warm"},"mint":{h:"#7ac8a8",t:"cool"},"slate":{h:"#6a7a8a",t:"cool"},
"gold":{h:"#c9a84c",t:"warm"},"mauve":{h:"#a07888",t:"warm"},"silver":{h:"#b0b0b0",t:"cool"},
"coral":{h:"#e87461",t:"warm"},"dusty rose":{h:"#c4867a",t:"warm"},"pewter":{h:"#8e9196",t:"cool"},
"mushroom":{h:"#b5a99a",t:"warm"},"charcoal blue":{h:"#36454f",t:"cool"},"stone":{h:"#bab5a8",t:"warm"},
"steel blue":{h:"#4682b4",t:"cool"},"taupe":{h:"#8b7d6b",t:"warm"},"indigo":{h:"#3f4fa1",t:"cool"},
"cognac":{h:"#9a4a2a",t:"warm"},"ecru":{h:"#c8b88a",t:"warm"},"powder blue":{h:"#a8c8e0",t:"cool"},
"emerald":{h:"#1a7a4a",t:"cool"},"copper":{h:"#b87333",t:"warm"},"graphite":{h:"#4a4a52",t:"cool"},
};
const AC=Object.keys(CM);
const CG=[
{l:"Neutrals",c:["black","charcoal","graphite","grey","light grey","pewter","silver","slate","white","cream","ivory","ecru","beige","sand","stone","mushroom","taupe"]},
{l:"Blues",c:["navy","indigo","cobalt","blue","steel blue","charcoal blue","light blue","powder blue","denim","teal","turquoise","mint"]},
{l:"Greens",c:["forest green","emerald","green","olive","sage"]},
{l:"Reds",c:["burgundy","wine","red","coral","dusty rose","rust","burnt orange","orange","copper"]},
{l:"Warm",c:["brown","dark brown","chocolate","cognac","tan","camel","khaki","gold","yellow"]},
{l:"Others",c:["plum","purple","lavender","mauve","pink"]},
];
const PATTERNS=["solid","plaid","striped","checked","print","textured"];
const MATERIALS=["cotton","linen","wool","cashmere","silk","denim","chino","suede","leather","canvas","synthetic","knit","tweed","corduroy","fleece","nylon"];
function smartDefaults(ai){
  var d={};var gt=ai.garmentType;var nm=(ai.name||"").toLowerCase();
  /* Material inference */
  if(gt==="Jeans")d.material="denim";
  else if(gt==="Sweater/Knit")d.material="knit";
  else if(gt==="Chinos")d.material="chino";
  else if(nm.includes("suede"))d.material="suede";
  else if(nm.includes("linen"))d.material="linen";
  else if(nm.includes("leather"))d.material="leather";
  else if(nm.includes("canvas"))d.material="canvas";
  else if(nm.includes("corduroy"))d.material="corduroy";
  else if(nm.includes("tweed"))d.material="tweed";
  else if(nm.includes("silk"))d.material="silk";
  else if(nm.includes("wool"))d.material="wool";
  else if(nm.includes("cashmere"))d.material="cashmere";
  else if(nm.includes("fleece"))d.material="fleece";
  else if(nm.includes("denim"))d.material="denim";
  /* Seasons inference */
  if(gt==="Shorts")d.seasons=["spring","summer"];
  else if(gt==="Sweater/Knit"||gt==="Jacket/Blazer")d.seasons=["fall","winter"];
  else if(gt==="Jeans")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="Shoes"){d.seasons=["spring","summer","fall","winter"];if(nm.includes("sandal")||nm.includes("espadrille")||nm.includes("flip"))d.seasons=["spring","summer"];else if(nm.includes("boot"))d.seasons=["fall","winter"]}
  else if(gt==="Chinos"||gt==="Pants/Trousers")d.seasons=["spring","summer","fall","winter"];
  else if(gt==="T-Shirt"||gt==="Polo")d.seasons=["spring","summer"];
  else d.seasons=["spring","summer","fall","winter"];
  /* Refine seasons based on inferred material */
  if(d.material==="wool"||d.material==="cashmere"||d.material==="fleece"||d.material==="tweed"||d.material==="corduroy")d.seasons=["fall","winter"];
  else if(d.material==="linen")d.seasons=["spring","summer"];
  return d;
}
const DEFAULT_CX=[
{id:"clinic",l:"Clinic",icon:"ðŸ¥"},{id:"smart-casual",l:"Smart Casual",icon:"ðŸ‘”"},{id:"formal",l:"Formal",icon:"ðŸŽ©"},
{id:"date",l:"Date",icon:"ðŸŒ¹"},{id:"riviera",l:"Riviera",icon:"ðŸŒŠ"},{id:"casual",l:"Casual",icon:"â˜€ï¸"},
{id:"weekend",l:"Weekend",icon:"ðŸ›’"},{id:"flex",l:"Flex",icon:"ðŸ’Ž"},{id:"travel",l:"Travel",icon:"âœˆï¸"},{id:"event",l:"Event",icon:"ðŸŽ­"}];
const SHARE_DEFAULT_CX=[
{id:"office",l:"Office",icon:"ðŸ’¼"},{id:"smart-casual",l:"Smart Casual",icon:"ðŸ‘”"},{id:"formal",l:"Formal",icon:"ðŸŽ©"},
{id:"date",l:"Date",icon:"ðŸŒ¹"},{id:"riviera",l:"Riviera",icon:"ðŸŒŠ"},{id:"casual",l:"Casual",icon:"â˜€ï¸"},
{id:"weekend",l:"Weekend",icon:"ðŸ›’"},{id:"flex",l:"Flex",icon:"ðŸ’Ž"},{id:"travel",l:"Travel",icon:"âœˆï¸"},{id:"event",l:"Event",icon:"ðŸŽ­"}];
var ALL_CX=DEFAULT_CX.map(function(c){return c.id});
var CXI={};DEFAULT_CX.forEach(function(c){CXI[c.id]=c.icon});
const CATS={tops:["Shirt","Polo","T-Shirt","Sweater/Knit","Jacket/Blazer"],bottoms:["Pants/Trousers","Chinos","Jeans","Shorts"],shoes:["Shoes"],accessories:["Hat","Scarf","Belt","Bag","Sunglasses","Accessory"]};
const ALL_T=[...CATS.tops,...CATS.bottoms,...CATS.shoes,...CATS.accessories];
const catOf=g=>CATS.tops.includes(g)?"tops":CATS.bottoms.includes(g)?"bottoms":CATS.shoes.includes(g)?"shoes":CATS.accessories.includes(g)?"accessories":"other";
const EMOJIS=["âŒš","â„ï¸","ðŸŒ¿","ðŸª·","ðŸ”·","ðŸŒ™","ðŸ’Ž","ðŸ‘‘","ðŸ”´","ðŸ","â­","ðŸŒ","âœˆï¸","ðŸ§­","ðŸ›©ï¸","ðŸ€","ðŸ”µ","ðŸŒŠ","ðŸ·","â—»ï¸","ðŸ”ï¸","ðŸŸ¢","â˜„ï¸","ðŸ’ ","ðŸŒ»","âš«","ðŸ”¥","ðŸ’œ"];
const STRAP_TYPES=[
{id:"bracelet",l:"Bracelet",icon:"â›“ï¸",mats:["steel","titanium","gold","rose gold","ceramic"]},
{id:"leather",l:"Leather",icon:"ðŸ”—",mats:["calf leather","alligator","cordovan","suede","shell cordovan","nubuck"]},
{id:"rubber",l:"Rubber",icon:"â¬›",mats:["rubber","FKM rubber","silicone"]},
{id:"nato",l:"NATO",icon:"ðŸŽ—ï¸",mats:["nylon"]},
{id:"mesh",l:"Mesh",icon:"ðŸ”˜",mats:["steel","titanium"]},
{id:"canvas",l:"Canvas",icon:"ðŸ“",mats:["canvas","sailcloth"]},
{id:"perlon",l:"Perlon",icon:"ðŸ§µ",mats:["perlon"]}];
const STRAP_COLORS=["black","brown","tan","navy","grey","green","teal","burgundy","blue","white","olive","orange","red","beige"];
const STRAP_CTX={
"formal":{bracelet:1,leather:3,rubber:-2,nato:-2,mesh:1,canvas:-2,perlon:-1},
"clinic":{bracelet:2,leather:2,rubber:1,nato:0,mesh:1,canvas:0,perlon:0},
"smart-casual":{bracelet:2,leather:2,rubber:0,nato:0,mesh:1,canvas:0,perlon:0},
"date":{bracelet:1,leather:3,rubber:-1,nato:-1,mesh:1,canvas:-1,perlon:0},
"casual":{bracelet:1,leather:1,rubber:1,nato:1,mesh:1,canvas:1,perlon:1},
"weekend":{bracelet:1,leather:0,rubber:1,nato:2,mesh:0,canvas:1,perlon:1},
"riviera":{bracelet:2,leather:-1,rubber:3,nato:2,mesh:1,canvas:1,perlon:1},
"travel":{bracelet:1,leather:0,rubber:2,nato:2,mesh:0,canvas:1,perlon:1},
"event":{bracelet:1,leather:3,rubber:-2,nato:-2,mesh:1,canvas:-2,perlon:0},
"flex":{bracelet:2,leather:1,rubber:0,nato:0,mesh:1,canvas:0,perlon:0},
"office":{bracelet:1,leather:2,rubber:-1,nato:-1,mesh:1,canvas:-1,perlon:0}
};
const STS=[{id:"active",l:"Active",c:"var(--good)"},{id:"incoming",l:"Incoming",c:"#7ab8d8"},{id:"pending-trade",l:"Pending",c:"var(--warn)"},{id:"sold",l:"Sold",c:"var(--dim)"},{id:"service",l:"Service",c:"#b87ab8"}];
const WT_TIERS=[
{max:5,label:"Freezing",icon:"ðŸ¥¶",weight:"heavy",advice:"Heavy layers. Leather straps stay warm."},
{max:12,label:"Cold",icon:"ðŸ§¥",weight:"heavy",advice:"Layer up: jacket + sweater."},
{max:18,label:"Cool",icon:"ðŸ§£",weight:"mid",advice:"Light jacket or sweater."},
{max:24,label:"Mild",icon:"ðŸ‘”",weight:"mid",advice:"Shirt sleeves or light knit."},
{max:30,label:"Warm",icon:"â˜€ï¸",weight:"light",advice:"Light fabrics. Bracelets/rubber > leather."},
{max:50,label:"Hot",icon:"ðŸ”¥",weight:"light",advice:"Steel bracelets or rubber only."},
];
const getWT=t=>WT_TIERS.find(x=>t<=x.max)||WT_TIERS[5];
/* WMO Weather Code decoder */
const WMO={0:{i:"â˜€ï¸",l:"Clear",rain:false},1:{i:"ðŸŒ¤ï¸",l:"Mostly Clear",rain:false},2:{i:"â›…",l:"Partly Cloudy",rain:false},3:{i:"â˜ï¸",l:"Overcast",rain:false},
45:{i:"ðŸŒ«ï¸",l:"Fog",rain:false},48:{i:"ðŸŒ«ï¸",l:"Rime Fog",rain:false},
51:{i:"ðŸŒ¦ï¸",l:"Light Drizzle",rain:true},53:{i:"ðŸŒ¦ï¸",l:"Drizzle",rain:true},55:{i:"ðŸŒ§ï¸",l:"Heavy Drizzle",rain:true},
56:{i:"ðŸŒ§ï¸",l:"Freezing Drizzle",rain:true},57:{i:"ðŸŒ§ï¸",l:"Heavy Frzg Drizzle",rain:true},
61:{i:"ðŸŒ¦ï¸",l:"Light Rain",rain:true},63:{i:"ðŸŒ§ï¸",l:"Rain",rain:true},65:{i:"ðŸŒ§ï¸",l:"Heavy Rain",rain:true},
66:{i:"ðŸ§Š",l:"Freezing Rain",rain:true},67:{i:"ðŸ§Š",l:"Heavy Frzg Rain",rain:true},
71:{i:"ðŸŒ¨ï¸",l:"Light Snow",rain:false},73:{i:"ðŸŒ¨ï¸",l:"Snow",rain:false},75:{i:"â„ï¸",l:"Heavy Snow",rain:false},
77:{i:"ðŸŒ¨ï¸",l:"Snow Grains",rain:false},
80:{i:"ðŸŒ¦ï¸",l:"Light Showers",rain:true},81:{i:"ðŸŒ§ï¸",l:"Showers",rain:true},82:{i:"â›ˆï¸",l:"Heavy Showers",rain:true},
85:{i:"ðŸŒ¨ï¸",l:"Snow Showers",rain:false},86:{i:"â„ï¸",l:"Heavy Snow Showers",rain:false},
95:{i:"â›ˆï¸",l:"Thunderstorm",rain:true},96:{i:"â›ˆï¸",l:"T-Storm + Hail",rain:true},99:{i:"â›ˆï¸",l:"T-Storm + Heavy Hail",rain:true}};
const getWMO=c=>WMO[c]||{i:"â“",l:"Unknown",rain:false};

/* â•â•â•â•â•â• SHARED MODE PRESETS â•â•â•â•â•â• */
const WATCH_PRESETS=[
{id:"p-aw",n:"Apple Watch",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"âŒš",mc:["black","grey","navy","white","charcoal"],ac:[],cx:["casual","weekend","clinic","travel"],wt:["light","mid","heavy"]},
{id:"p-gshock",n:"G-Shock",d:"Black",c:"#2a2a2a",br:true,sc:[],mt:"cool",i:"ðŸ’ª",mc:["black","olive","navy","grey","khaki"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
{id:"p-seiko5",n:"Seiko 5",d:"Blue",c:"#2a5a9a",br:true,sc:[],mt:"cool",i:"ðŸ”µ",mc:["navy","white","cream","grey","light blue"],ac:[],cx:["casual","smart-casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-sub",n:"Submariner-style",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"ðŸ¤¿",mc:["black","navy","white","grey","olive"],ac:[],cx:["casual","smart-casual","weekend","riviera","travel"],wt:["light","mid","heavy"]},
{id:"p-tank",n:"Tank-style",d:"White",c:"#f0f0ec",br:false,sc:["black"],mt:"cool",i:"ðŸ›ï¸",mc:["white","charcoal","navy","cream","black"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-chrono",n:"Chronograph",d:"Black",c:"#1a1a1a",br:true,sc:[],mt:"cool",i:"â±ï¸",mc:["black","navy","white","grey","charcoal"],ac:[],cx:["smart-casual","casual","weekend"],wt:["light","mid","heavy"]},
{id:"p-dress",n:"Dress Watch",d:"White",c:"#f5f0e8",br:false,sc:["brown"],mt:"warm",i:"ðŸ‘”",mc:["cream","white","charcoal","navy","tan","burgundy"],ac:["casual"],cx:["formal","date","smart-casual","clinic"],wt:["mid","heavy"]},
{id:"p-field",n:"Field Watch",d:"Green",c:"#3a5a3a",br:false,sc:["brown","olive"],mt:"cool",i:"ðŸ§­",mc:["olive","khaki","cream","brown","tan","navy"],ac:["formal"],cx:["casual","weekend","travel"],wt:["light","mid","heavy"]},
];
const GARMENT_PRESETS=[
{garmentType:"Shirt",name:"White Shirt",color:"white",pattern:"solid"},
{garmentType:"Shirt",name:"Light Blue Shirt",color:"light blue",pattern:"solid"},
{garmentType:"T-Shirt",name:"Black T-Shirt",color:"black",pattern:"solid"},
{garmentType:"T-Shirt",name:"Grey T-Shirt",color:"grey",pattern:"solid"},
{garmentType:"T-Shirt",name:"Navy T-Shirt",color:"navy",pattern:"solid"},
{garmentType:"T-Shirt",name:"White T-Shirt",color:"white",pattern:"solid"},
{garmentType:"Chinos",name:"Navy Chinos",color:"navy",pattern:"solid"},
{garmentType:"Chinos",name:"Khaki Chinos",color:"khaki",pattern:"solid"},
{garmentType:"Chinos",name:"Charcoal Chinos",color:"charcoal",pattern:"solid"},
{garmentType:"Jeans",name:"Blue Jeans",color:"denim",pattern:"solid"},
{garmentType:"Jeans",name:"Black Jeans",color:"black",pattern:"solid"},
{garmentType:"Shorts",name:"Navy Shorts",color:"navy",pattern:"solid"},
{garmentType:"Shorts",name:"Khaki Shorts",color:"khaki",pattern:"solid"},
{garmentType:"Shoes",name:"White Sneakers",color:"white",pattern:"solid"},
{garmentType:"Shoes",name:"Black Shoes",color:"black",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Shoes",color:"brown",pattern:"solid"},
{garmentType:"Polo",name:"Navy Polo",color:"navy",pattern:"solid"},
{garmentType:"Polo",name:"White Polo",color:"white",pattern:"solid"},
{garmentType:"Sweater/Knit",name:"Grey Sweater",color:"grey",pattern:"solid"},
{garmentType:"Jacket/Blazer",name:"Navy Blazer",color:"navy",pattern:"solid"},
{garmentType:"Shoes",name:"Brown Loafers",color:"brown",pattern:"solid"},
];
function autoMatchColors(dialColor){
  var dc=(dialColor||"").toLowerCase().trim();
  var key=Object.keys(CP).find(function(k){return dc.includes(k)||k.includes(dc)});
  if(key)return CP[key].slice(0,8);
  return["white","cream","navy","charcoal","grey","black","tan","light blue"];
}

const _OWNER_DEFAULTS=[
{id:"snowflake",n:"GS Snowflake",t:"genuine",d:"Silver-White",c:"#c8d0d8",straps:[
  {type:"leather",color:"grey",material:"alligator",source:"Gentry Tao",buckle:"GS script pin"},
  {type:"leather",color:"navy",material:"alligator",source:"DayDayWatchband",buckle:"deployant",notes:"Blue contrast stitch, 19â†’18mm taper"}
],mt:"cool",i:"â„ï¸",mc:["grey","navy","white","light blue","charcoal","silver","lavender","slate"],ac:["orange","red"],cx:["clinic","formal","smart-casual"],sg:"Greyâ†’dark shoes. Navyâ†’navy outfits.",wt:["light","mid","heavy"],active:true,status:"active",ref:"SBGA211",size:41,lug:19,mvmt:"Spring Drive 9R65"},
{id:"rikka",n:"GS Rikka",t:"genuine",d:"Green",c:"#5a8a6a",straps:[
  {type:"leather",color:"teal",material:"alligator",source:"Gentry Tao",buckle:"Seiko script pin"},
  {type:"leather",color:"brown",material:"calf leather",buckle:"pin"}
],mt:"cool",i:"ðŸŒ¿",mc:["cream","ivory","sage","olive","teal","khaki","tan","forest green","white"],ac:["black","bright red"],cx:["smart-casual","date","weekend"],sg:"Tealâ†’brown shoes. Brown leatherâ†’smart casual.",wt:["light","mid"],active:true,status:"active",ref:"SBGH351",size:40,lug:21,mvmt:"Hi-Beat 36000 9S85"},
{id:"sbgw267",n:"GS SBGW267",t:"genuine",d:"Ivory",c:"#f5f0e8",straps:[
  {type:"leather",color:"burgundy",material:"alligator",source:"Gentry Tao",buckle:"GS script pin",notes:"Reads purple/magenta, not true oxblood"},
  {type:"leather",color:"burgundy",material:"alligator",source:"DayDayWatchband",buckle:"pin",notes:"Redundant with Gentry Tao â€” both read purple"},
  {type:"leather",color:"tan",material:"calf leather",buckle:"pin",notes:"Honey tone, white contrast stitch"}
],mt:"warm",i:"ðŸª·",mc:["burgundy","plum","cream","mauve","ivory","charcoal","wine","tan","honey"],ac:["cobalt","neon"],cx:["formal","date","clinic","smart-casual"],sg:"Purple strapsâ†’oxblood shoes. Tanâ†’brown Ecco lace-ups.",wt:["mid","heavy"],active:true,status:"active",ref:"SBGW267",size:37.3,lug:19,mvmt:"Manual 9S64"},
{id:"laureato",n:"GP Laureato",t:"genuine",d:"Blue",c:"#2a5a9a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"ðŸ”·",mc:["white","cream","light grey","navy","cobalt","light blue","silver"],ac:["brown","olive"],cx:["riviera","smart-casual","flex","date"],sg:"Integrated bracelet only.",wt:["light","mid"],active:true,status:"active",ref:"81010",size:42,mvmt:"GP03300"},
{id:"reverso",n:"JLC Reverso",t:"genuine",d:"Navy",c:"#1a2a4a",straps:[
  {type:"leather",color:"navy",material:"alligator",buckle:"deployant"}
],mt:"cool",i:"ðŸŒ™",mc:["white","charcoal","navy","dark grey","silver"],ac:["casual"],cx:["formal","clinic","event"],sg:"Navyâ†’black/dark brown shoes.",wt:["mid","heavy"],active:true,status:"active",ref:"216.8.D3",size:42,mvmt:"Cal 986"},
{id:"santos-lg",n:"Santos Large",t:"genuine",d:"White/Gold",c:"#d4af37",straps:[
  {type:"bracelet",color:"silver",material:"steel",notes:"QuickSwitch"},
  {type:"leather",color:"brown",material:"calfskin",source:"Cartier OEM",buckle:"QuickSwitch deployant"}
],mt:"mixed",i:"ðŸ’Ž",mc:["cream","white","light blue","tan","black","navy","gold"],ac:["neon"],cx:["clinic","smart-casual","date","riviera","flex"],sg:"Two-tone. QuickSwitch bracelet + brown calfskin. Most versatile.",wt:["light","mid","heavy"],active:true,status:"active",ref:"W2SA0009",size:39.8,mvmt:"1847MC"},
{id:"santos-oct",n:"Santos Octagon YG",t:"genuine",d:"White",c:"#c5a03a",straps:[
  {type:"leather",color:"brown",material:"alligator",buckle:"deployant",notes:"Brown alligator, stainless deployant, cream lining"}
],mt:"warm",i:"ðŸ‘‘",mc:["cream","tan","camel","chocolate","ivory","gold","brown"],ac:["grey","navy","silver"],cx:["formal","date","flex"],sg:"Brown shoes mandatory.",wt:["mid","heavy"],active:true,status:"active",ref:"Vintage 1980s",size:29,mvmt:"Quartz"},
{id:"bb41",n:"Tudor BB41",t:"genuine",d:"Black/Red",c:"#8b1a1a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Tudor OEM",notes:"Five-link"},
  {type:"leather",color:"brown",material:"distressed leather",source:"Tudor OEM",buckle:"Tudor deployant",notes:"Rough-out finish, ecru stitching. Via Speedmaster trade."},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin",notes:"White stitch, 22/22mm straight. Dressy/clinic."}
],mt:"cool",i:"ðŸ”´",mc:["black","grey","white","charcoal","dark green","navy","olive","rust","brown","tan"],ac:["pastel"],cx:["casual","weekend","smart-casual"],sg:"Bracelet default. Brown strapâ†’brown shoes, warm tones. Black strapâ†’clinic/dressy.",wt:["light","mid","heavy"],active:true,status:"active",ref:"7941A1A0RU",size:41,lug:22,mvmt:"MT5400 METAS"},
{id:"monaco",n:"TAG Monaco",t:"genuine",d:"Black",c:"#1a1a1a",straps:[
  {type:"leather",color:"black",material:"calf leather",buckle:"pin"}
],mt:"cool",i:"ðŸ",mc:["black","charcoal","white","navy"],ac:["brown","warm"],cx:["smart-casual","date","weekend"],sg:"Black shoes ONLY.",wt:["mid","heavy"],active:true,status:"active",ref:"CW2111",size:39,mvmt:"ETA 2894-2"},
{id:"gmt",n:"Rolex GMT-II",t:"genuine",d:"Black",c:"#2a2a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Rolex OEM"}
],mt:"cool",i:"ðŸŒ",mc:["black","navy","grey","white","olive"],ac:[],cx:["casual","travel","smart-casual"],sg:"PENDING TRADEâ†’Alpine Eagle 8HF.",wt:["light","mid","heavy"],active:true,status:"pending-trade",ref:"116710LN",size:40,mvmt:"Cal 3186"},
{id:"alpine-8hf",n:"Chopard Alpine Eagle 8HF",t:"genuine",d:"Blue-Grey",c:"#5a6a7a",straps:[
  {type:"bracelet",color:"silver",material:"titanium"}
],mt:"cool",i:"ðŸ”ï¸",mc:["grey","navy","white","light blue","charcoal","silver","cream","slate"],ac:["orange","bright red"],cx:["clinic","smart-casual","date","flex","riviera"],sg:"GPHG Sports Watch. 8Hz movement. Replaces GMT-II.",wt:["light","mid","heavy"],active:false,status:"incoming",ref:"298600-3005",size:41,mvmt:"L.U.C 01.12-C 8Hz"},
{id:"hanhart",n:"Hanhart Pioneer",t:"genuine",d:"White/Teal",c:"#3a8a8a",straps:[
  {type:"leather",color:"teal",material:"leather",source:"Hanhart OEM",notes:"Yellow lining, statement"},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin"},
  {type:"leather",color:"light brown",material:"calf leather",buckle:"pin"},
  {type:"leather",color:"green",material:"suede",buckle:"pin",notes:"Dark green rough-out, tan lining. Textured casual."},
  {type:"leather",color:"olive",material:"full grain leather",buckle:"pin",notes:"Sage/olive chunky, cream stitch. Field/military."},
  {type:"canvas",color:"grey",material:"canvas",buckle:"bronze pin",notes:"Grey woven canvas. Vintage tool watch vibe."}
],mt:"cool",i:"âœˆï¸",mc:["teal","cream","sage","white","burnt orange","olive","khaki","tan","black","grey"],ac:["formal"],cx:["casual","weekend","riviera","smart-casual"],sg:"Tealâ†’statement. Blackâ†’versatile. Light brownâ†’brown Eccos. Green suedeâ†’field. Oliveâ†’military. Canvasâ†’vintage.",wt:["light","mid"],active:true,status:"active",ref:"417 ES",size:39,mvmt:"Flyback chronograph"},
{id:"laco",n:"Laco Flieger",t:"genuine",d:"Black",c:"#3a3a3a",straps:[
  {type:"leather",color:"brown",material:"distressed leather",buckle:"pin",notes:"Pilot style, aged"}
],mt:"cool",i:"ðŸ›©ï¸",mc:["olive","brown","dark green","grey","khaki","tan"],ac:["silk","suits"],cx:["casual","weekend"],sg:"Rugged only.",wt:["mid","heavy"],active:true,status:"active",ref:"Type B",size:42,mvmt:"Manual wind"},
{id:"speedy",n:"Omega Speedmaster 3861",t:"genuine",d:"Black",c:"#1a1a1a",straps:[
  {type:"bracelet",color:"silver",material:"steel",source:"Omega OEM"},
  {type:"leather",color:"teal",material:"Buttero Italian veg-tanned",buckle:"pin",notes:"Dark teal, cream stitch. Statement."},
  {type:"leather",color:"black",material:"calf leather",buckle:"pin",notes:"Orange lining, white stitch. NASA heritage nod."},
  {type:"rubber",color:"navy",material:"leather/rubber hybrid",buckle:"pin",notes:"White stitch. Clinic/smart casual."},
  {type:"rubber",color:"white",material:"rubber",buckle:"pin",notes:"Perforated rally-style. Summer statement."},
  {type:"canvas",color:"navy",material:"canvas",buckle:"gold pin",notes:"Dark navy, gold stitch/buckle. Unconventional warm accent."},
  {type:"leather",color:"black",material:"grained leather",buckle:"gold butterfly deployant",notes:"Gold hardware on steel â€” intentional warm accent."},
  {type:"leather",color:"tan",material:"calf leather",buckle:"pin",notes:"Tan/honey, 20â†’18mm taper. Brown shoe pairing."},
  {type:"nato",color:"navy",material:"nylon",notes:"Navy/white/orange striped. Regatta casual."}
],mt:"neutral",i:"ðŸŒ‘",mc:["black","navy","white","grey","charcoal","cream","olive","denim","burgundy"],ac:[],cx:["clinic","smart-casual","casual","date","flex","weekend","travel","event"],sg:"Moonwatch. 9 strap options. Most versatile watch in collection.",wt:["mid","heavy"],active:true,status:"active",ref:"310.30.42.50.01.001",size:42,lug:20,mvmt:"Cal 3861 manual"},
{id:"iwc-perp",n:"IWC Perpetual",t:"replica",d:"Blue",c:"#1a3a7a",straps:[
  {type:"leather",color:"blue",material:"alligator",buckle:"deployant"}
],mt:"cool",i:"ðŸ”µ",mc:["navy","charcoal","white","silver"],ac:["casual"],cx:["formal","date","flex"],sg:"Dark shoes only.",wt:["mid","heavy"],active:true,status:"active",size:42},
{id:"iwc-ing",n:"IWC Ingenieur",t:"replica",d:"Teal",c:"#1a8a7a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"ðŸŒŠ",mc:["teal","cream","white","sage","turquoise","mint"],ac:["dark heavy"],cx:["riviera","smart-casual","flex"],sg:"Summer coastal.",wt:["light"],active:true,status:"active",size:40},
{id:"vc-perp",n:"VC Overseas Perp",t:"replica",d:"Burgundy",c:"#6a1a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"ðŸ·",mc:["burgundy","cream","plum","black","ivory","charcoal","wine"],ac:["cobalt"],cx:["date","formal","flex"],sg:"Fills burgundy gap.",wt:["mid","heavy"],active:true,status:"active",size:41.5},
{id:"santos-rep",n:"Santos 35mm",t:"replica",d:"White",c:"#e0d8c8",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"â—»ï¸",mc:["white","light blue","cream","grey"],ac:[],cx:["clinic","smart-casual"],sg:"Universal.",wt:["light","mid"],active:true,status:"active",size:35},
{id:"alpine-red",n:"Chopard Alpine",t:"replica",d:"Red",c:"#b83a3a",straps:[
  {type:"bracelet",color:"rose gold",material:"steel"}
],mt:"warm",i:"ðŸ”ï¸",mc:["black","cream","burgundy","charcoal","white"],ac:["cool blues"],cx:["date","flex","riviera"],sg:"Rose gold. Black anchors.",wt:["light","mid"],active:true,status:"active",size:41},
{id:"ap-roc",n:"AP Royal Oak",t:"replica",d:"Green",c:"#1a5a2a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"ðŸŸ¢",mc:["dark green","cream","white","olive","black","navy"],ac:["close greens"],cx:["smart-casual","flex","date"],sg:"Dark makes green pop.",wt:["mid","heavy"],active:true,status:"active",size:41},
{id:"gmt-met",n:"GMT Meteorite",t:"replica",d:"Meteorite",c:"#6a6a6a",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"â˜„ï¸",mc:["grey","silver","charcoal","white","black"],ac:["warm earth"],cx:["flex","date"],sg:"Cool monochrome.",wt:["mid","heavy"],active:true,status:"active",size:40},
{id:"dd-turq",n:"Day-Date Turq",t:"replica",d:"Turquoise",c:"#2ab8a8",straps:[
  {type:"bracelet",color:"gold",material:"steel"}
],mt:"warm",i:"ðŸ’ ",mc:["white","cream","turquoise","tan","light blue","sand"],ac:["dark formal"],cx:["riviera","flex","date"],sg:"Pure summer.",wt:["light"],active:true,status:"active",size:36},
{id:"op-grape",n:"Rolex OP Grape",t:"replica",d:"Purple",c:"#6a3d7d",straps:[
  {type:"bracelet",color:"silver",material:"steel"}
],mt:"cool",i:"ðŸ‡",mc:["navy","white","cream","grey","charcoal","light blue","olive","tan","lavender"],ac:["orange","bright red"],cx:["casual","weekend","smart-casual","date","riviera"],sg:"Purple/grape dial. Bold statement.",wt:["light","mid"],active:true,status:"active",size:36},
{id:"breguet",n:"Breguet Tradition",t:"replica",d:"Black",c:"#0a0a0a",straps:[
  {type:"leather",color:"black",material:"alligator",buckle:"pin"}
],mt:"cool",i:"âš«",mc:["black","charcoal","white"],ac:["color","casual"],cx:["formal","date"],sg:"Black shoes only.",wt:["mid","heavy"],active:true,status:"active",size:40},
];
function migrateStraps(w){
  if(w.straps&&w.straps.length){
    var o=Object.assign({},w);
    o.br=o.straps.some(function(s){return s.type==="bracelet"});
    o.sc=o.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color});
    return o;
  }
  var straps=[];
  if(w.br)straps.push({type:"bracelet",color:"silver",material:"steel"});
  if(w.sc&&w.sc.length)w.sc.forEach(function(c){straps.push({type:"leather",color:c,material:"calf leather"})});
  if(!straps.length)straps.push({type:"bracelet",color:"silver",material:"steel"});
  return Object.assign({},w,{straps:straps});
}
const DEFAULTS=IS_SHARED?[]:_OWNER_DEFAULTS.map(migrateStraps);

/* â•â•â• MARKDOWN WATCH LOG PARSER â•â•â• */
function parseWatchLog(mdText, existingWatches){
  var lines=mdText.split("\n");
  var watches=[];
  var strapMap={};/* watchName -> straps[] */
  var section="";var subSection="";
  
  /* --- Phase 1: Parse watch tables --- */
  var genuineSection=false,replicaSection=false,strapSection=false,pendingSection=false;
  var currentStrapWatch="";
  
  for(var li=0;li<lines.length;li++){
    var line=lines[li].trim();
    
    /* Detect sections */
    if(line.match(/^###?\s+Genuine/i)){genuineSection=true;replicaSection=false;strapSection=false;pendingSection=false;continue}
    if(line.match(/^###?\s+Replica/i)){genuineSection=false;replicaSection=true;strapSection=false;pendingSection=false;continue}
    if(line.match(/^###?\s+Pending/i)){genuineSection=false;replicaSection=false;strapSection=false;pendingSection=true;continue}
    if(line.match(/^##\s+Strap Inventory/i)){genuineSection=false;replicaSection=false;strapSection=true;pendingSection=false;continue}
    if(line.match(/^##\s+(Wishlist|Passed|Traded|Collection by|Dial Color|Trade Summary|Watch Pref|Collection Gap|Strap Sizing|Strap Orders)/i)){strapSection=false;genuineSection=false;replicaSection=false;pendingSection=false;continue}
    
    /* Parse strap sub-sections */
    if(strapSection&&line.match(/^###\s+/)){
      currentStrapWatch=line.replace(/^###\s+/,"").replace(/\s*\([^)]*\)/g,"").trim();
      continue;
    }
    
    /* Parse table rows */
    if(!line.startsWith("|")||line.match(/^\|[-\s|]+$/)||line.match(/^\|\s*Watch\s*\|/i)||line.match(/^\|\s*Strap\s*\|/i)||line.match(/^\|\s*Specification/i)||line.match(/^\|\s*Gap/i)||line.match(/^\|\s*Color/i))continue;
    
    var cells=line.split("|").map(function(c){return c.trim()}).filter(Boolean);
    if(cells.length<2)continue;
    
    /* Genuine watches */
    if(genuineSection&&cells.length>=2){
      var name=cells[0];var details=cells[1]||"";
      var status="active";
      if(details.match(/PENDING TRADE|TRADING TOMORROW/i))status="pending-trade";
      if(details.match(/INCOMING/i))status="incoming";
      var dial=inferDial(name,details);
      var w={id:"md-"+slugify(name),n:name,t:"genuine",d:dial.color,c:dial.hex,br:false,sc:[],mt:dial.temp,i:dial.emoji,mc:autoMatchColors(dial.color),ac:[],cx:inferContexts(name,details),wt:[],sg:[],active:status!=="pending-trade",status:status,size:inferSize(details),ref:inferRef(details)};
      watches.push(w);
    }
    
    /* Replica watches */
    if(replicaSection&&cells.length>=2){
      var rName=cells[0];var rDetails=cells[1]||"";var rStatus=cells[2]||"";
      var st="active";
      if(rStatus.match(/INCOMING/i))st="incoming";
      var rd=inferDial(rName,rDetails);
      var rw={id:"md-"+slugify(rName),n:rName,t:"replica",d:rd.color,c:rd.hex,br:true,sc:[],mt:rd.temp,i:rd.emoji,mc:autoMatchColors(rd.color),ac:[],cx:inferContexts(rName,rDetails),wt:[],sg:[],active:true,status:st,size:inferSize(rDetails)};
      /* Detect bracelet vs strap from details */
      if(rDetails.match(/integrated|bracelet|steel/i))rw.br=true;
      watches.push(rw);
    }
    
    /* Pending acquisitions */
    if(pendingSection&&cells.length>=2){
      var pName=cells[0];var pStatus=cells[1]||"";var pDetails=cells[2]||"";
      var pd=inferDial(pName,pDetails);
      var pw={id:"md-"+slugify(pName),n:pName,t:"genuine",d:pd.color,c:pd.hex,br:true,sc:[],mt:pd.temp,i:pd.emoji,mc:autoMatchColors(pd.color),ac:[],cx:inferContexts(pName,pDetails),wt:[],sg:[],active:false,status:pStatus.match(/INCOMING/i)?"incoming":"pending-trade",size:inferSize(pDetails)};
      watches.push(pw);
    }
    
    /* Strap inventory rows */
    if(strapSection&&currentStrapWatch&&cells.length>=4){
      var strapDesc=cells[0];var source=cells[1]||"";var buckle=cells[2]||"";var useCase=cells[3]||"";
      var strap=parseStrapDesc(strapDesc,source);
      if(!strapMap[currentStrapWatch])strapMap[currentStrapWatch]=[];
      strapMap[currentStrapWatch].push(strap);
    }
  }
  
  /* --- Phase 2: Merge straps into watches --- */
  Object.keys(strapMap).forEach(function(strapWatchName){
    var straps=strapMap[strapWatchName];
    /* Try exact name match first, then best substring, then fuzzy */
    var matchW=watches.find(function(w){return w.n.toLowerCase()===strapWatchName.toLowerCase()});
    if(!matchW){var subs=watches.filter(function(w){var wl=w.n.toLowerCase(),sl=strapWatchName.toLowerCase();var isSubstr=sl.includes(wl)||wl.includes(sl);if(!isSubstr)return false;var shorter=Math.min(wl.length,sl.length),longer=Math.max(wl.length,sl.length);return shorter/longer>=0.5});if(subs.length)matchW=subs.reduce(function(a,b){return a.n.length>b.n.length?a:b})}
    if(!matchW)matchW=watches.find(function(w){return fuzzyMatch(w.n,strapWatchName)});
    if(matchW){
      matchW.straps=straps;
      matchW.br=straps.some(function(s){return s.type==="bracelet"});
      matchW.sc=straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color});
    }
  });
  
  /* --- Phase 3: Detect bracelet watches without explicit straps --- */
  watches.forEach(function(w){
    if(!w.straps||!w.straps.length){
      if(w.br)w.straps=[{type:"bracelet",color:"silver",material:"steel"}];
      else if(w.sc&&w.sc.length)w.straps=w.sc.map(function(c){return{type:"leather",color:c,material:"calf leather"}});
      else w.straps=[{type:"bracelet",color:"silver",material:"steel"}];
    }
  });
  
  /* --- Phase 4: Merge with existing watches --- */
  if(existingWatches&&existingWatches.length){
    watches=watches.map(function(nw){
      var existing=existingWatches.find(function(ew){return fuzzyMatch(ew.n,nw.n)||ew.id===nw.id});
      if(existing){
        /* Preserve user customizations, update from markdown */
        return Object.assign({},existing,{
          status:nw.status,active:nw.active,
          straps:nw.straps&&nw.straps.length>1?nw.straps:existing.straps,
          br:nw.straps?nw.straps.some(function(s){return s.type==="bracelet"}):existing.br,
          sc:nw.straps?nw.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color}):existing.sc
        });
      }
      return nw;
    });
    /* Add existing watches not in markdown */
    existingWatches.forEach(function(ew){
      if(!watches.find(function(w){return fuzzyMatch(w.n,ew.n)||w.id===ew.id})){
        watches.push(ew);
      }
    });
  }
  
  return watches.map(migrateStraps);
}

/* Helper: slugify name to ID */
function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").slice(0,40)}

/* Helper: fuzzy match watch names */
function fuzzyMatch(a,b){
  if(!a||!b)return false;
  var na=a.toLowerCase().replace(/[^a-z0-9]/g,"");
  var nb=b.toLowerCase().replace(/[^a-z0-9]/g,"");
  if(na===nb)return true;
  if(na.includes(nb)||nb.includes(na))return true;
  /* Token overlap */
  var ta=a.toLowerCase().split(/[\s-]+/).filter(function(t){return t.length>2});
  var tb=b.toLowerCase().split(/[\s-]+/).filter(function(t){return t.length>2});
  var overlap=ta.filter(function(t){return tb.some(function(u){return u.includes(t)||t.includes(u)})}).length;
  return(overlap>=2&&overlap/Math.max(ta.length,tb.length)>=0.6)||(overlap>=1&&Math.min(ta.length,tb.length)<=2&&Math.max(ta.length,tb.length)<=3);
}

/* Helper: infer dial color from name/details */
function inferDial(name,details){
  var text=(name+" "+details).toLowerCase();
  var dialMap=[
    {k:["snowflake","silver-white","silvery"],color:"Silver-White",hex:"#c8d0d8",temp:"cool",emoji:"â„ï¸"},
    {k:["rikka","lighter green"],color:"Green",hex:"#5a8a6a",temp:"cool",emoji:"ðŸŒ¿"},
    {k:["ivory","sbgw267"],color:"Ivory",hex:"#f5f0e8",temp:"warm",emoji:"ðŸª·"},
    {k:["blue hobnail","laureato"],color:"Blue",hex:"#2a5a9a",temp:"cool",emoji:"ðŸ”·"},
    {k:["reverso","navy blue"],color:"Navy",hex:"#1a2a4a",temp:"cool",emoji:"ðŸŒ™"},
    {k:["meteorite"],color:"Meteorite",hex:"#6a6a7a",temp:"cool",emoji:"â˜„ï¸"},
    {k:["turquoise","teal"],color:"Turquoise",hex:"#1a8a7a",temp:"cool",emoji:"ðŸ’Ž"},
    {k:["burgundy","oxblood","wine","red dial"],color:"Burgundy",hex:"#6a1a2a",temp:"warm",emoji:"ðŸ·"},
    {k:["purple","grape"],color:"Purple",hex:"#6a3a7a",temp:"cool",emoji:"ðŸ‡"},
    {k:["anthracite","grey dial"],color:"Anthracite",hex:"#5a6a7a",temp:"cool",emoji:"ðŸ”ï¸"},
    {k:["rose gold","red dial","rose"],color:"Red/Rose",hex:"#b04040",temp:"warm",emoji:"ðŸŒ¹"},
    {k:["green dial"],color:"Green",hex:"#2a5a3a",temp:"cool",emoji:"ðŸ€"},
    {k:["black dial","black chronograph","black,"],color:"Black",hex:"#1a1a1a",temp:"cool",emoji:"âš«"},
    {k:["white dial","white,"],color:"White",hex:"#f0f0ec",temp:"neutral",emoji:"âšª"},
    {k:["blue dial","blue chronograph"],color:"Blue",hex:"#2a5a9a",temp:"cool",emoji:"ðŸ”µ"},
    {k:["yellow gold","gold,"],color:"White/Gold",hex:"#d4af37",temp:"mixed",emoji:"ðŸ’Ž"},
    {k:["champagne"],color:"Champagne",hex:"#d4c090",temp:"warm",emoji:"ðŸ¥‚"},
    {k:["speedmaster","moonwatch"],color:"Black",hex:"#1a1a1a",temp:"cool",emoji:"ðŸŒ‘"},
    {k:["flieger","laco","pilot"],color:"Black",hex:"#2a2a2a",temp:"cool",emoji:"âœˆï¸"},
  ];
  for(var i=0;i<dialMap.length;i++){
    for(var j=0;j<dialMap[i].k.length;j++){
      if(text.includes(dialMap[i].k[j]))return dialMap[i];
    }
  }
  return{color:"",hex:"#5a5a5a",temp:"cool",emoji:"âŒš"};
}

/* Helper: infer contexts from name/details */
function inferContexts(name,details){
  var text=(name+" "+details).toLowerCase();
  var cx=[];
  if(text.match(/dress|elegance|reverso|santos octagon|tank/))cx.push("formal","date","event");
  if(text.match(/sport|gmt|diver|sea|aqua|tudor|omega|speedmaster/))cx.push("casual","smart-casual","travel");
  if(text.match(/chrono|monaco|flyback|pioneer/))cx.push("smart-casual","casual");
  if(text.match(/flieger|pilot|laco/))cx.push("casual","weekend");
  if(text.match(/perpetual|complication|moon|tourbillon/))cx.push("formal","date");
  if(text.match(/royal oak|overseas|laureato|ingenieur|alpine/))cx.push("smart-casual","flex","casual");
  if(text.match(/santos large|cartier/))cx.push("clinic","smart-casual","date");
  if(text.match(/grand seiko/))cx.push("clinic","smart-casual");
  if(text.match(/day-date|datejust|date /))cx.push("clinic","smart-casual","flex");
  if(!cx.length)cx.push("casual","smart-casual");
  return[...new Set(cx)];
}

/* Helper: infer size from details */
function inferSize(details){
  var m=details.match(/(\d{2})mm(?!\s*lug)/);
  return m?m[1]+"mm":null;
}

/* Helper: infer reference from details */
function inferRef(details){
  var m=details.match(/Ref\s+([A-Z0-9./-]+)/i);
  return m?m[1]:null;
}

/* Helper: parse strap description into {type, color, material} */
function parseStrapDesc(desc,source){
  var text=desc.toLowerCase();
  /* Detect type */
  var type="leather";
  if(text.match(/bracelet|steel|titanium|metal/))type="bracelet";
  else if(text.match(/nato/))type="nato";
  else if(text.match(/rubber|fkm|silicone/))type="rubber";
  else if(text.match(/canvas|sailcloth/))type="canvas";
  else if(text.match(/perlon/))type="perlon";
  else if(text.match(/mesh/))type="mesh";
  
  /* Detect material */
  var material="calf leather";
  if(text.includes("alligator"))material="alligator";
  else if(text.includes("cordovan"))material="cordovan";
  else if(text.includes("suede"))material="suede";
  else if(text.includes("nubuck"))material="nubuck";
  else if(text.includes("calfskin"))material="calf leather";
  else if(type==="bracelet")material="steel";
  else if(type==="nato")material="nylon";
  else if(type==="rubber")material="rubber";
  
  /* Detect color */
  var color="black";
  var colorMap=["grey","navy","brown","tan","honey","teal","burgundy","black","dark brown","light brown","green","olive","blue","white","beige","orange","red","purple","magenta"];
  for(var i=0;i<colorMap.length;i++){
    if(text.includes(colorMap[i])){
      color=colorMap[i];
      if(color==="honey")color="tan";
      if(color==="dark brown")color="brown";
      if(color==="light brown")color="tan";
      if(color==="magenta")color="burgundy";
      break;
    }
  }
  if(type==="bracelet")color="silver";
  
  return{type:type,color:color,material:material};
}


/* â•â•â•â•â•â• SCORING (null-safe) â•â•â•â•â•â• */
const CP={
"black":["white","grey","charcoal","light grey","red","navy","cream","silver","gold","burgundy","cobalt","coral","pewter","graphite","powder blue"],
"white":["navy","black","cobalt","teal","grey","cream","light blue","burnt orange","olive","burgundy","charcoal","forest green","red","coral","indigo","emerald","steel blue"],
"cream":["navy","olive","teal","burgundy","brown","tan","sage","burnt orange","forest green","charcoal","wine","plum","cobalt","dark brown","cognac","dusty rose","copper","emerald","indigo"],
"ivory":["navy","olive","burgundy","brown","tan","sage","charcoal","wine","forest green","cobalt","cognac","copper","emerald","dusty rose","teal"],
"navy":["white","cream","light grey","tan","khaki","light blue","grey","gold","burnt orange","ivory","beige","sand","camel","coral","dusty rose","copper","cognac","ecru","stone","powder blue"],
"grey":["white","navy","black","charcoal","light blue","burgundy","teal","lavender","wine","cobalt","cream","dusty rose","coral","pewter","steel blue","powder blue"],
"light grey":["navy","charcoal","cobalt","burgundy","teal","forest green","plum","white","coral","dusty rose","steel blue","indigo"],
"charcoal":["white","cream","light grey","light blue","lavender","burgundy","gold","teal","cobalt","ivory","beige","coral","dusty rose","pewter","powder blue","emerald","copper"],
"light blue":["white","cream","navy","grey","tan","khaki","charcoal","brown","camel","beige","cognac","taupe","stone"],
"teal":["cream","white","tan","khaki","burnt orange","sage","ivory","brown","beige","sand","camel","coral","copper","cognac","mushroom"],
"turquoise":["white","cream","tan","navy","sand","beige","khaki","coral","copper"],
"olive":["cream","white","tan","khaki","brown","burnt orange","navy","ivory","beige","sand","rust","cognac","mushroom","ecru","copper"],
"sage":["cream","ivory","brown","tan","white","khaki","burnt orange","olive","dusty rose","mushroom","stone","taupe"],
"burgundy":["cream","ivory","charcoal","black","grey","white","light grey","beige","camel","gold","stone","mushroom","ecru","taupe"],
"wine":["cream","ivory","charcoal","grey","white","gold","beige","stone","mushroom","taupe"],
"brown":["cream","white","tan","olive","navy","khaki","sage","ivory","beige","light blue","burnt orange","ecru","stone","mushroom","powder blue"],
"dark brown":["cream","ivory","tan","khaki","beige","white","camel","light blue","ecru","stone","mushroom","powder blue"],
"tan":["navy","white","olive","brown","cream","teal","cobalt","light blue","charcoal","forest green","burgundy","indigo","steel blue","emerald"],
"camel":["navy","white","charcoal","cobalt","cream","light blue","burgundy","forest green","indigo","steel blue","teal","emerald"],
"khaki":["navy","white","cobalt","teal","olive","brown","cream","burnt orange","charcoal","burgundy","forest green","indigo","steel blue","emerald"],
"beige":["navy","charcoal","cobalt","forest green","burgundy","brown","teal","olive","indigo","steel blue","emerald"],
"sand":["navy","cobalt","teal","olive","brown","charcoal","forest green","burgundy","indigo","steel blue","emerald"],
"denim":["white","cream","tan","khaki","navy","grey","olive","brown","burnt orange","camel","cognac","coral"],
"red":["black","charcoal","grey","white","navy","cream","graphite"],
"rust":["cream","olive","navy","tan","khaki","ivory","white","brown","teal","sage","mushroom","ecru"],
"burnt orange":["cream","navy","olive","khaki","teal","tan","ivory","white","charcoal","brown","sage","mushroom"],
"gold":["navy","charcoal","black","cream","burgundy","forest green","white","emerald","indigo","wine"],
"lavender":["charcoal","grey","navy","white","cream","light grey","pewter","graphite","slate"],
"plum":["cream","ivory","charcoal","grey","white","gold","light grey","stone","mushroom","taupe"],
"mauve":["cream","charcoal","grey","ivory","navy","white","mushroom","stone","taupe"],
"forest green":["cream","ivory","tan","khaki","white","beige","camel","brown","navy","cognac","copper","stone","mushroom","ecru"],
"mint":["navy","charcoal","white","cream","grey","chocolate","slate"],
"silver":["black","charcoal","navy","white","grey","cobalt","indigo","graphite"],
"cobalt":["white","cream","light grey","tan","khaki","beige","gold","camel","coral","copper"],
"slate":["white","cream","light blue","navy","tan","coral","dusty rose","powder blue"],
"blue":["white","cream","navy","grey","tan","khaki","charcoal","brown","camel","beige","light grey","coral","copper","cognac"],
"green":["cream","ivory","tan","khaki","white","beige","camel","brown","navy","olive","burnt orange","cognac","copper"],
"pink":["navy","charcoal","grey","white","cream","light grey","black","slate","pewter"],
"orange":["navy","white","cream","charcoal","teal","olive","brown","khaki","indigo"],
"yellow":["navy","charcoal","grey","white","cobalt","denim","olive","indigo"],
"purple":["cream","ivory","charcoal","grey","white","gold","light grey","silver","stone","mushroom"],
"chocolate":["cream","ivory","tan","khaki","beige","white","camel","light blue","navy","ecru","stone","mushroom","powder blue"],
"coral":["navy","white","cream","charcoal","teal","light grey","grey","pewter","slate","powder blue","denim","turquoise"],
"dusty rose":["navy","charcoal","grey","cream","white","light grey","olive","sage","pewter","slate","taupe","mushroom"],
"pewter":["white","navy","cream","burgundy","charcoal","black","cobalt","dusty rose","coral","teal","forest green"],
"mushroom":["navy","charcoal","burgundy","forest green","teal","cobalt","cream","white","olive","sage","plum","wine","indigo"],
"charcoal blue":["white","cream","tan","light grey","coral","dusty rose","beige","khaki","gold","ivory","sand"],
"stone":["navy","charcoal","burgundy","forest green","teal","cobalt","olive","brown","wine","plum","indigo","emerald"],
"steel blue":["white","cream","tan","khaki","beige","camel","coral","sand","ivory","brown","cognac"],
"taupe":["navy","cream","white","charcoal","burgundy","forest green","teal","cobalt","light blue","dusty rose","indigo"],
"indigo":["white","cream","tan","khaki","beige","gold","sand","camel","coral","ivory","light grey","copper","cognac"],
"cognac":["navy","cream","white","charcoal","ivory","light blue","olive","forest green","beige","teal","indigo","powder blue"],
"ecru":["navy","burgundy","charcoal","forest green","cobalt","olive","brown","teal","wine","plum","indigo","emerald"],
"powder blue":["navy","charcoal","tan","brown","cream","white","cognac","taupe","chocolate","dark brown","grey","khaki"],
"emerald":["cream","ivory","tan","white","khaki","gold","beige","camel","navy","charcoal","cognac","copper","sand"],
"copper":["navy","cream","white","teal","charcoal","olive","ivory","beige","forest green","cobalt","indigo","emerald"],
"graphite":["white","cream","light grey","light blue","coral","gold","powder blue","lavender","dusty rose","cobalt","teal"],
};
/* Color family mapping for smarter matching */
const COLOR_FAMILIES={
  "blacks":["black","charcoal","graphite"],
  "whites":["white","cream","ivory","ecru"],
  "greys":["grey","light grey","pewter","silver","slate","stone"],
  "blues":["navy","blue","cobalt","light blue","steel blue","powder blue","charcoal blue","indigo","denim"],
  "greens":["green","forest green","emerald","olive","sage","teal","mint"],
  "browns":["brown","dark brown","tan","camel","chocolate","cognac","taupe","mushroom","khaki"],
  "reds":["red","burgundy","wine","rust","coral","dusty rose","copper","burnt orange"],
  "purples":["purple","plum","lavender","mauve"],
};
function getColorFamily(c){for(var fam in COLOR_FAMILIES){if(COLOR_FAMILIES[fam].includes(c))return fam}return null}
function compat(c1,c2){
  if(!c1||!c2)return 0.1;
  const a=(c1||"").toLowerCase().trim(),b=(c2||"").toLowerCase().trim();
  if(!a||!b)return 0.1;
  if(a===b)return 0.6; /* monochrome â€” intentional pairing */
  /* Exact match in compatibility matrix */
  if((CP[a]||[]).includes(b)||(CP[b]||[]).includes(a))return 1;
  /* Substring fallback for compound colors like "light blue" */
  if((CP[a]||[]).some(x=>b.includes(x)||x.includes(b)))return 0.85;
  if((CP[b]||[]).some(x=>a.includes(x)||x.includes(a)))return 0.85;
  /* Color family: same family = decent pairing (tonal dressing) */
  var famA=getColorFamily(a),famB=getColorFamily(b);
  if(famA&&famB&&famA===famB)return 0.65;
  /* Neutral + anything = safe */
  var neutralFams=["blacks","whites","greys"];
  if((neutralFams.includes(famA)&&famB)||(neutralFams.includes(famB)&&famA))return 0.55;
  /* Temperature harmony */
  const t1=Object.entries(CM).find(([k])=>a.includes(k)),t2=Object.entries(CM).find(([k])=>b.includes(k));
  if(t1&&t2){
    var ta=t1[1].t,tb=t2[1].t;
    if(ta===tb&&ta!=="neutral")return 0.5;
    if(ta==="neutral"||tb==="neutral")return 0.4;
    if(ta==="mixed"||tb==="mixed")return 0.45;
  }
  return 0.2;
}

function scoreW(w,items,ctx,reps,opts){
  if(!w.active||w.status==="sold"||w.status==="service")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  if(!reps&&w.t==="replica")return{total:-1,ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  /* Multi-ctx support: ctx can be string or array */
  var _ctxArr=Array.isArray(ctx)?ctx:[ctx];var _ctxPri=_ctxArr[0]||"smart-casual";var _ctxSet=new Set(_ctxArr);
  var _o=opts||{};var wearLog=_o.wearLog||[];
  let s=0;const bd={ctx:0,color:0,temp:0,strap:0,br:0,fresh:0,auth:0};
  const ic=items.filter(i=>i.color).map(i=>i.color.toLowerCase().trim());
  const shoe=items.find(i=>i.garmentType==="Shoes");
  const sc=shoe&&shoe.color?shoe.color.toLowerCase().trim():null;
  /* â•â• UPGRADE: Formality tier scoring (gradient, not binary) â•â• */
  var FORM_TIERS={formal:["reverso","sbgw267","santos-lg","santos-oct","santos-rep"],event:["reverso","sbgw267","santos-lg","santos-oct","santos-rep","laureato","speedy","monaco","gmt"],clinic:["snowflake","rikka","sbgw267","santos-lg","reverso","bb41","speedy"],date:["santos-lg","reverso","laureato","rikka","snowflake","monaco","speedy"]};
  /* Score against ALL selected contexts, take best match */
  var _bestCxScore=0;
  _ctxArr.forEach(function(_cx){
    var tierList=FORM_TIERS[_cx];
    var _cxS=0;
    if(_cx&&w.cx&&w.cx.includes(_cx)){
      if(tierList&&tierList.includes(w.id)){_cxS=5}
      else{_cxS=3}
    }else if(tierList&&tierList.includes(w.id)){_cxS=2}
    if(_cxS>_bestCxScore)_bestCxScore=_cxS;
  });
  s+=_bestCxScore;bd.ctx=_bestCxScore;
  for(const c of ic){
    if(!c)continue;
    let matched=false;
    for(const m of(w.mc||[])){if(m==="anything"||c.includes(m)||m.includes(c)){s+=2;bd.color+=2;matched=true;break}}
    if(!matched)for(const a of(w.ac||[])){if(c.includes(a)||a.includes(c)){s-=2;bd.color-=2;break}}
  }
  const temps=ic.map(c=>{const e=Object.entries(CM).find(([k])=>c.includes(k));return e?e[1].t:"neutral"});
  const wm=temps.filter(x=>x==="warm").length,co=temps.filter(x=>x==="cool").length;
  if(w.mt==="warm"&&wm>co){s+=2;bd.temp=2}if(w.mt==="cool"&&co>=wm){s+=1;bd.temp=1}if(w.mt==="warm"&&co>wm+1){s-=1;bd.temp=-1}
  /* â•â• UPGRADE: Hard strap-shoe enforcement (non-negotiable leather rule) â•â• */
  if(!w.br&&sc&&w.sc&&w.sc.length){
    const sB=sc.includes("black"),sBr=sc.includes("brown")||sc.includes("tan")||sc.includes("cognac");
    const hB=w.sc.some(x=>x.includes("black")),hBr=w.sc.some(x=>x.includes("brown")||x.includes("tan")||x.includes("teal")||x.includes("green")||x.includes("burgundy")),hN=w.sc.some(x=>x.includes("navy")||x.includes("blue"));
    if(sB&&hB){s+=3;bd.strap=3}
    if(sB&&!hB&&!hN){s-=5;bd.strap=-5}
    if(sBr&&hBr){s+=3;bd.strap=3}
    if(sBr&&hB&&!hBr){s-=5;bd.strap=-5}
    if(sB&&hN){s+=1;bd.strap+=1}
  }
  /* New strap system: hard enforcement too */
  if(!w.br&&sc&&w.straps&&w.straps.length){
    var _sB2=sc.includes("black"),_sBr2=sc.includes("brown")||sc.includes("tan")||sc.includes("cognac");
    var _anyMatch=w.straps.some(function(st){
      if(st.type==="bracelet"||st.type==="rubber"||st.type==="mesh"||st.type==="nato")return true;
      var stc=(st.color||"").toLowerCase();
      if(_sB2&&(stc.includes("black")||stc.includes("navy")))return true;
      if(_sBr2&&(stc.includes("brown")||stc.includes("tan")||stc.includes("burgundy")||stc.includes("teal")||stc.includes("green")||stc.includes("cognac")))return true;
      return false;
    });
    if(!_anyMatch){s-=5;bd.strap-=5}
  }
  if(w.br){s+=1;bd.br=1}
  /* Strap type Ã— context fitness */
  if(_ctxPri&&w.straps&&w.straps.length){
    var ctxMap=STRAP_CTX[_ctxPri]||{};
    var bestStrapFit=Math.max.apply(null,w.straps.map(function(st){return ctxMap[st.type]||0}));
    if(bestStrapFit>0){s+=Math.min(bestStrapFit,2);bd.strap+=Math.min(bestStrapFit,2)}
    else if(bestStrapFit<0&&w.straps.length===1){s+=bestStrapFit;bd.strap+=bestStrapFit}
  }
  /* Watch size Ã— context scoring */
  var sz=w.size?parseInt(w.size):0;
  if(sz>0){
    if((_ctxSet.has("formal")||_ctxSet.has("clinic"))&&sz>=43){s-=1;bd.ctx-=1}
    if((_ctxSet.has("formal")||_ctxSet.has("clinic"))&&sz<=39){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("date")&&sz<=37){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("date")&&sz>=44){s-=0.5;bd.ctx-=0.5}
    if((_ctxSet.has("casual")||_ctxSet.has("weekend"))&&sz>=44){s+=0.5;bd.ctx+=0.5}
    if(_ctxSet.has("riviera")&&sz>=40&&sz<=42){s+=0.5;bd.ctx+=0.5}
  }
  /* Material harmony */
  if(!w.br&&shoe){
    var sm=(shoe.material||shoe.name||"").toLowerCase();
    if(sm.includes("leather")&&w.sc&&w.sc.some(function(x){return x.includes("leather")||x.includes("croc")||x.includes("alligator")})){s+=1;bd.strap+=1}
    if(sm.includes("suede")&&w.sc&&w.sc.some(function(x){return x.includes("suede")})){s+=1;bd.strap+=1}
  }
  /* Formality: penalize dressy watches with very casual items */
  var hasCasualItem=items.some(function(it){return it.garmentType==="T-Shirt"||it.garmentType==="Shorts"});
  var isFormalCtx=_ctxSet.has("formal")||_ctxSet.has("event");
  if(isFormalCtx&&hasCasualItem){s-=2;bd.ctx-=2}
  /* â•â• UPGRADE: Rotation freshness â€” recently worn = score penalty â•â• */
  if(wearLog&&wearLog.length){
    var _now2=Date.now();var _last=null;
    for(var _e of wearLog){if(_e.watchId===w.id&&(!_last||_e.ts>_last))_last=_e.ts}
    if(_last){
      var _daysAgo=Math.floor((_now2-_last)/(864e5));
      if(_daysAgo<=1){s-=3;bd.fresh=-3}
      else if(_daysAgo<=3){s-=1.5;bd.fresh=-1.5}
      else if(_daysAgo>=14){s+=2;bd.fresh=2}
      else if(_daysAgo>=7){s+=1;bd.fresh=1}
    }else{s+=1;bd.fresh=1}
  }
  /* â•â• UPGRADE: Genuine/replica context bonus â•â• */
  var _authCtx=["formal","event","clinic","date"];
  if(w.t==="genuine"&&_authCtx.some(function(a){return _ctxSet.has(a)})){s+=1.5;bd.auth=1.5}
  if(w.t==="replica"&&(_ctxSet.has("casual")||_ctxSet.has("weekend")||_ctxSet.has("riviera"))){s+=0.5;bd.auth=0.5}
  return{total:s,...bd};
}
function strapRec(w,items,ctx,wxOpts){
  /* Weather + straps-aware recommendation â€” UPGRADED */
  var _rain=wxOpts&&wxOpts.rain;
  if(w.straps&&w.straps.length){
    if(w.straps.length===1){
      var s0=w.straps[0];var st0=STRAP_TYPES.find(function(t){return t.id===s0.type})||STRAP_TYPES[0];
      var _warn="";
      if(_rain&&s0.type==="leather")_warn=" âš ï¸ rain";
      return{text:s0.type==="bracelet"?(st0.icon+" Bracelet ("+s0.material+")"+_warn):(st0.icon+" "+s0.color+" "+s0.type+_warn),type:_rain&&s0.type==="leather"?"warn":"info",strap:s0};
    }
    var shoe=items.find(function(i){return i.garmentType==="Shoes"});
    var sc=shoe&&shoe.color?shoe.color.toLowerCase():"";
    var sm=(shoe&&(shoe.material||shoe.name)||"").toLowerCase();
    var _ctxPri2=Array.isArray(ctx)?ctx[0]||"smart-casual":ctx;var ctxMap=STRAP_CTX[_ctxPri2]||{};
    var scored=w.straps.map(function(st){
      var pts=ctxMap[st.type]||0;
      var stc=st.color?st.color.toLowerCase():"";
      /* Shoe-strap color matching */
      if(st.type!=="bracelet"&&sc){
        if(sc.includes("black")&&(stc.includes("black")||stc.includes("navy")))pts+=3;
        if((sc.includes("brown")||sc.includes("tan")||sc.includes("cognac"))&&(stc.includes("brown")||stc.includes("tan")||stc.includes("burgundy")||stc.includes("teal")))pts+=3;
        if(sc.includes("black")&&(stc.includes("brown")||stc.includes("tan")))pts-=2;
        if((sc.includes("brown")||sc.includes("tan"))&&stc.includes("black"))pts-=2;
      }
      /* Material harmony */
      if(sm.includes("leather")&&(st.material||"").toLowerCase().match(/leather|alligator|cordovan|nubuck/))pts+=1;
      if(sm.includes("suede")&&(st.material||"").toLowerCase().includes("suede"))pts+=1;
      /* â•â• UPGRADE: Weather-aware strap scoring â•â• */
      if(_rain){
        if(st.type==="bracelet"||st.type==="rubber"||st.type==="mesh")pts+=4;
        if(st.type==="leather")pts-=4;
        if(st.type==="nato"||st.type==="canvas")pts+=1;
      }
      return{strap:st,score:pts};
    }).sort(function(a,b){return b.score-a.score});
    var best=scored[0];var stDef=STRAP_TYPES.find(function(t){return t.id===best.strap.type})||STRAP_TYPES[0];
    var label=best.strap.type==="bracelet"?"Bracelet ("+best.strap.material+")":best.strap.color+" "+best.strap.type;
    var _rainNote=_rain&&best.strap.type==="leather"?" âš ï¸ rain":"";
    return{text:"â†’ "+stDef.icon+" "+label+_rainNote,type:_rain&&best.strap.type==="leather"?"warn":"good",strap:best.strap,all:scored};
  }
  /* Legacy fallback */
  if(w.br)return{text:"â›“ï¸ Bracelet"+(_rain?" âœ“ rain-safe":""),type:"info"};
  if(!w.sc||!w.sc.length)return{text:"Default strap",type:"info"};
  const shoe2=items.find(i=>i.garmentType==="Shoes");const sc2=shoe2&&shoe2.color?shoe2.color.toLowerCase():"";
  if(w.sc.length===1)return{text:w.sc[0]+" strap",type:"info"};
  for(const st of w.sc){
    if(sc2.includes("black")&&(st.includes("black")||st.includes("navy")))return{text:"â†’ "+st,type:"good"};
    if((sc2.includes("brown")||sc2.includes("tan"))&&(st.includes("brown")||st.includes("tan")||st.includes("teal")||st.includes("burgundy")))return{text:"â†’ "+st,type:"good"};
  }
  return{text:w.sc.join(" / "),type:"info"};
}
function getWarns(w,items){
  const ws=[];const shoe=items.find(i=>i.garmentType==="Shoes");
  var hasLeather=w.straps?w.straps.some(function(s){return s.type==="leather"}):!w.br;
  var nonBrStraps=w.straps?w.straps.filter(function(s){return s.type!=="bracelet"}):[];
  if(hasLeather&&shoe&&shoe.color){const sc=shoe.color.toLowerCase();
    if(sc.includes("white"))ws.push("âš ï¸ Leather strap+white shoes");
    var strapColors=nonBrStraps.length?nonBrStraps.map(function(s){return s.color.toLowerCase()}):w.sc||[];
    if(sc.includes("brown")&&strapColors.length&&strapColors.every(function(x){return x.includes("black")||x.includes("navy")}))ws.push("ðŸš« Brown shoes+dark strap");
    if(sc.includes("black")&&strapColors.length&&strapColors.every(function(x){return x.includes("brown")||x.includes("tan")||x.includes("teal")}))ws.push("ðŸš« Black shoes+warm strap");
  }
  /* Strap type formality warnings */
  if(w.straps&&w.straps.length===1){
    var onlyType=w.straps[0].type;
    if((onlyType==="nato"||onlyType==="rubber"||onlyType==="canvas")&&w.cx&&(w.cx.includes("formal")||w.cx.includes("date")))ws.push("âš ï¸ "+onlyType+" strap may be too casual â€” consider adding a leather option");
  }
  /* Formality warnings */
  var hasShorts=items.some(function(it){return it.garmentType==="Shorts"});
  var hasTee=items.some(function(it){return it.garmentType==="T-Shirt"});
  if(hasShorts&&w.cx&&!w.cx.includes("casual")&&!w.cx.includes("weekend")&&!w.cx.includes("riviera"))ws.push("âš ï¸ Shorts may clash with this watch's formality");
  if(hasTee&&w.cx&&w.cx.includes("formal")&&!w.cx.includes("casual"))ws.push("âš ï¸ T-shirt may be too casual for this watch");
  return ws;
}
const CXR={
"clinic":{no:["Shorts","Jeans","T-Shirt"]},
"smart-casual":{no:["Shorts"]},
"formal":{no:["T-Shirt","Shorts","Jeans","Polo"]},
"date":{no:["Shorts","T-Shirt"]},
"riviera":{no:[]},
"casual":{no:[]},
"weekend":{no:[]},
"flex":{no:["Shorts"]},
"travel":{no:[]},
"event":{no:["T-Shirt","Shorts"]},
"office":{no:["Shorts","T-Shirt","Jeans"]},
};

function makeOutfit(items,watches,ctx,reps,wxOpts,tempVal,extraOpts){
  var _wl=extraOpts&&extraOpts.wearLog||[];
  var tops=items.filter(i=>catOf(i.garmentType)==="tops");
  const top=tops[0]||null,bot=items.find(i=>catOf(i.garmentType)==="bottoms"),shoe=items.find(i=>catOf(i.garmentType)==="shoes");
  /* outermost top layer is what's visible â€” used for primary color scoring */
  var outerTop=tops.length>0?tops[tops.length-1]:null;
  if(wxOpts&&tempVal!==undefined)wxOpts.temp=tempVal;
  let fs=0;
  /* Layering bonus â€” reward multi-layer outfits */
  if(tops.length>=2)fs+=0.5;
  if(tops.length>=3)fs+=0.5;
  /* Season penalty for off-season items */
  /* Season â€” temperature-based when weather available, month-based fallback */
  var _csn=(function(){
    if(wxOpts&&wxOpts.temp!==undefined){
      var t=wxOpts.temp;
      if(t>=28)return"summer";if(t>=20)return"spring";if(t>=12)return"fall";return"winter";
    }
    var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
  items.forEach(function(it){var s=it.seasons;if(s&&s.length>0&&s.length<4&&!s.includes(_csn))fs-=1});
  /* Freshness penalty â€” discourage recently-worn garments for variety */
  var _now=Date.now();
  items.forEach(function(it){if(it.lastWorn){var daysAgo=Math.floor((_now-new Date(it.lastWorn).getTime())/(864e5));if(daysAgo<=1)fs-=2;else if(daysAgo<=3)fs-=0.8;else if(daysAgo<=5)fs-=0.3;else if(daysAgo>=14)fs+=0.3}});
  /* Color compat â€” use outermost visible layer for primary scoring */
  if(outerTop&&bot)fs+=compat(outerTop.color,bot.color)*3;
  if(outerTop&&shoe)fs+=compat(outerTop.color,shoe.color)*2;
  if(bot&&shoe)fs+=compat(bot.color,shoe.color)*2;
  /* Layer-to-layer color harmony */
  for(var li=0;li<tops.length-1;li++){fs+=compat(tops[li].color,tops[li+1].color)*1.5}
  /* Jeans daily preference bonus */
  if(bot&&bot.garmentType==="Jeans")fs+=0.8;
  /* Pattern bonus â€” check outermost top vs bottom */
  if(outerTop&&bot){
    var tp=(outerTop.pattern||"solid"),bp=(bot.pattern||"solid");
    if(tp!=="solid"&&bp!=="solid")fs-=1.5;
    else if((tp==="textured"||bp==="textured")&&(tp==="solid"||bp==="solid"))fs+=0.8;
    else if(tp==="striped"&&bp==="solid")fs+=0.4;
  }
  /* Weather condition scoring */
  var isRainy=wxOpts&&wxOpts.rain;
  var isWindy=wxOpts&&wxOpts.wind&&wxOpts.wind>30;
  var uvHigh=wxOpts&&wxOpts.uv&&wxOpts.uv>=6;
  if(isRainy&&shoe){
    var sc2=(shoe.color||"").toLowerCase();
    var sn2=(shoe.name||"").toLowerCase();
    /* Penalize white/cream shoes in rain */
    if(sc2==="white"||sc2==="cream"||sc2==="beige"||sc2==="sand")fs-=2;
    /* Black shoes safest in rain */
    if(sc2==="black")fs+=1;
    /* Suede/canvas/material penalty in rain */
    var sm=(shoe.material||"").toLowerCase();
    if(sn2.includes("suede")||sm==="suede")fs-=2;
    else if(sn2.includes("canvas")||sm==="canvas")fs-=1;
  }
  /* Material-weather scoring for all items */
  if(wxOpts){
    var wxTemp=wxOpts.temp||18;
    items.forEach(function(it){
      var mat=(it.material||"").toLowerCase();
      if(!mat)return;
      if(isRainy&&mat==="suede")fs-=2;
      if(isRainy&&mat==="canvas")fs-=1;
      if((mat==="wool"||mat==="cashmere"||mat==="fleece")&&wxTemp>28)fs-=2;
      if(mat==="linen"&&wxTemp<10)fs-=1;
      if((mat==="linen"||mat==="cotton")&&wxTemp>25)fs+=1;
      if((mat==="wool"||mat==="cashmere"||mat==="tweed"||mat==="corduroy"||mat==="fleece")&&wxTemp<15)fs+=1;
    });
  }
  const wr=watches.map(w=>{
    var sc=scoreW(w,items,ctx,reps,{wearLog:_wl});
    /* Rain: penalize leather/suede, boost bracelets & rubber */
    if(isRainy){
      if(w.straps&&w.straps.length){
        var hasWR=w.straps.some(function(s){return s.type==="bracelet"||s.type==="rubber"||s.type==="mesh"});
        var onlyLeather=w.straps.every(function(s){return s.type==="leather"});
        if(hasWR){sc.total+=2;sc.br+=2}
        if(onlyLeather){sc.total-=2;sc.strap-=2}
      }else{
        if(w.br){sc.total+=2;sc.br+=2}else{sc.total-=2;sc.strap-=2}
      }
    }
    return{...w,score:sc.total,bd:sc,sr:strapRec(w,items,ctx,{rain:isRainy}),wn:getWarns(w,items)}
  }).filter(w=>w.score>-1).sort((a,b)=>b.score-a.score);
  if(wr[0])fs+=wr[0].score*0.5;
  /* Rain warning */
  var wxWarns=[];
  if(isRainy)wxWarns.push("ðŸŒ§ï¸ Rain expected â€” bracelets/rubber preferred over leather");
  if(isWindy)wxWarns.push("ðŸ’¨ High wind â€” secure light items");
  return{fs:Math.round(fs*10)/10,watches:wr.slice(0,3),allW:wr,top,bot,shoe,outerTop:outerTop,tops:tops,items,wxWarns:wxWarns};
}

function genFits(wardrobe,watches,ctx,reps,ww,count,opts){
  count=count||10;opts=opts||{};
  var wxOpts=opts.wx||null;
  const rules=CXR[ctx]||CXR["smart-casual"];
  var curSeason=(function(){if(opts.temp!==undefined){var t=opts.temp;if(t>=28)return"summer";if(t>=20)return"spring";if(t>=12)return"fall";return"winter"}var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
  var seasonFilter=function(i){var s=i.seasons;if(!s||!s.length||s.length>=4)return true;return s.includes(curSeason)};
  const valid=wardrobe.filter(function(i){return i.color&&!i.needsEdit});
  var tops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  var bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)&&seasonFilter(i)});
  /* Fallback: if season filtering empties a category, drop it */
  if(!tops.length)tops=valid.filter(function(i){return catOf(i.garmentType)==="tops"&&!(rules.no||[]).includes(i.garmentType)});
  if(!bots.length)bots=valid.filter(function(i){return catOf(i.garmentType)==="bottoms"&&!(rules.no||[]).includes(i.garmentType)});
  var shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"&&seasonFilter(i)});
  if(!shoes.length)shoes=valid.filter(function(i){return catOf(i.garmentType)==="shoes"});
  /* Top type filter */
  if(opts.topType&&opts.topType!=="all"){var ft=tops.filter(function(i){return i.garmentType===opts.topType});if(ft.length)tops=ft}
  /* Lock item */
  var lockItem=opts.lockItem||null;
  if(lockItem){
    var lcat=catOf(lockItem.garmentType);
    if(lcat==="tops"){tops=[lockItem]}
    else if(lcat==="bottoms"){bots=[lockItem]}
  }
  if(ww==="light"){const lt=tops.filter(function(i){return["Shirt","Polo","T-Shirt"].includes(i.garmentType)});const lb=bots.filter(function(i){return["Shorts","Chinos","Jeans"].includes(i.garmentType)});if(lt.length)tops=lt;if(lb.length)bots=lb}
  else if(ww==="mid"){var midTemp=opts.temp||18;if(midTemp<18){var cmt=tops.filter(function(i){return["Sweater/Knit","Jacket/Blazer","Shirt"].includes(i.garmentType)});var cmb=bots.filter(function(i){return["Pants/Trousers","Jeans","Chinos"].includes(i.garmentType)});if(cmt.length)tops=cmt;if(cmb.length)bots=cmb}else{var wmt=tops.filter(function(i){return["Shirt","Polo","T-Shirt"].includes(i.garmentType)});var wmb=bots.filter(function(i){return["Jeans","Chinos","Shorts"].includes(i.garmentType)});if(wmt.length)tops=wmt;if(wmb.length)bots=wmb}}
  else if(ww==="heavy"){const ht=tops.filter(function(i){return["Sweater/Knit","Jacket/Blazer","Shirt"].includes(i.garmentType)});const hb=bots.filter(function(i){return["Jeans","Pants/Trousers","Chinos"].includes(i.garmentType)});if(ht.length)tops=ht;if(hb.length)bots=hb}
  if(!tops.length||!bots.length)return[];
  const combos=[];
  for(const top of tops)for(const bot of bots){
    if(top.id===bot.id)continue;
    const tb=compat(top.color,bot.color);if(tb<0.2)continue;
    for(const shoe of(shoes.length?shoes:[null])){
      if(shoe&&(shoe.id===top.id||shoe.id===bot.id))continue;
      const items=[top,bot].concat(shoe?[shoe]:[]);
      const r=makeOutfit(items,watches,ctx,reps,wxOpts,opts.temp,{wearLog:opts.wearLog||[]});
      combos.push({id:top.id+"-"+bot.id+"-"+(shoe?shoe.id:"x"),fs:r.fs,watches:r.watches,allW:r.allW,top:r.top,bot:r.bot,shoe:r.shoe,items:r.items,topType:top.garmentType,wxWarns:r.wxWarns});
    }
  }
  combos.sort(function(a,b){return b.fs-a.fs});
  const seen=new Set(),botUse={},uniq=[];
  for(const c of combos){
    const ck=c.top?.color+"-"+c.bot?.color;
    var bid=c.bot?c.bot.id:"x";
    if(seen.has(ck)&&uniq.length>2)continue;
    if((botUse[bid]||0)>=3&&uniq.length>4)continue;
    seen.add(ck);botUse[bid]=(botUse[bid]||0)+1;
    uniq.push(c);if(uniq.length>=count)break;
  }
  if(opts.shuffle){for(var si=uniq.length-1;si>0;si--){var sj=Math.floor(Math.random()*(si+1));var st=uniq[si];uniq[si]=uniq[sj];uniq[sj]=st}}
  return uniq;
}

function getSwaps(wd,fit,slot){
  const cat=slot==="top"?"tops":slot==="bot"?"bottoms":"shoes";
  const cur=slot==="top"?fit.top:slot==="bot"?fit.bot:fit.shoe;if(!cur)return[];
  return wd.filter(function(i){return i.color&&!i.needsEdit&&catOf(i.garmentType)===cat&&i.id!==cur.id}).map(function(alt){
    const o1=slot==="top"?fit.bot:fit.top;const o2=slot==="top"?fit.shoe:(slot==="bot"?fit.shoe:fit.bot);
    let sc=o1?compat(alt.color,o1.color)*3:0;if(o2)sc+=compat(alt.color,o2.color)*2;
    return Object.assign({},alt,{ss:Math.round(sc*10)/10})}).sort(function(a,b){return b.ss-a.ss}).slice(0,3);
}

/* â•â•â•â•â•â• IMAGE COMPRESSION â•â•â•â•â•â• */
function compressImage(dataUrl,maxDim,quality){
  maxDim=maxDim||800;quality=quality||0.7;
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.width,h=img.height;
      if(w>maxDim||h>maxDim){if(w>h){h=Math.round(h*(maxDim/w));w=maxDim}else{w=Math.round(w*(maxDim/h));h=maxDim}}
      var c=document.createElement("canvas");c.width=w;c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      resolve(c.toDataURL("image/jpeg",quality));
    };
    img.onerror=function(){resolve(dataUrl)};
    img.src=dataUrl;
  });
}

/* â•â•â•â•â•â• AI ERROR LOG (visible in UI) â•â•â•â•â•â• */
var _lastAiError="";
function getLastAiError(){return _lastAiError}

async function aiID(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:700,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"Identify ALL distinct clothing items visible in this photo for a luxury wardrobe management app.\n\nRules:\n1. If a FULL OUTFIT is shown (person wearing top+bottom+shoes), return EACH as a separate item.\n2. If photo shows a single garment laid flat or folded, return just one item.\n3. If multiple garments are layered (e.g. blazer over shirt), identify each distinct layer.\n4. If multiple garments are stacked/folded together, identify each distinct one.\n5. For each item, note its position in the frame (e.g. 'top half','bottom half','left','right','center','full frame','layered front','layered back').\n6. Include shoes if visible.\n7. Maximum 5 items per photo.\n8. Detect fabric/material where possible (cotton, wool, linen, denim, leather, silk, cashmere, knit, corduroy, tweed, fleece, suede, canvas, nylon, chino, synthetic).\n9. COLOR ACCURACY IS CRITICAL: Look carefully at the actual garment color. Distinguish between navy vs black, charcoal vs grey, cream vs white, olive vs sage, burgundy vs brown, tan vs beige vs camel, etc. If a color is between two options, pick the closest match.\n10. For patterns: 'textured' means visible weave/knit texture but no distinct pattern. 'print' means graphic/floral/abstract. Be specific.\n\nReturn ONLY a JSON ARRAY, no markdown:\n[{\"garmentType\":\"Shirt\"|\"Polo\"|\"T-Shirt\"|\"Sweater/Knit\"|\"Jacket/Blazer\"|\"Pants/Trousers\"|\"Chinos\"|\"Jeans\"|\"Shorts\"|\"Shoes\"|\"Hat\"|\"Scarf\"|\"Belt\"|\"Bag\"|\"Sunglasses\"|\"Accessory\",\"name\":\"2-4 word descriptive name (e.g. 'Navy Wool Blazer', 'White Oxford Shirt')\",\"color\":\"one from: "+AC.join(",")+"\",\"pattern\":\"solid\"|\"plaid\"|\"striped\"|\"checked\"|\"print\"|\"textured\",\"material\":\"detected fabric type or null\",\"position\":\"where in frame\",\"season_hint\":\"all-season\"|\"warm-weather\"|\"cold-weather\"|\"transitional\"}]\nPick the single dominant color per item. If only ONE item is visible, still return an array with one element."}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    var p=JSON.parse(txt);
    /* Handle both array and single object responses */
    if(Array.isArray(p)){if(p.length&&p[0].garmentType&&p[0].color)return p;_lastAiError="AI returned empty array";return null}
    if(p.garmentType&&p.color)return[p];
    _lastAiError="AI returned incomplete: "+JSON.stringify(p).slice(0,80);return null;
  }catch(e){_lastAiError="Exception: "+String(e.message||e).slice(0,120);return null}
}

async function aiVision(fit,watch,ctx,apiKey){
  _lastAiError="";
  var top=fit.top,bot=fit.bot,shoe=fit.shoe;
  var layers=fit.layers||fit.tops||[];
  var prompt="You are an elite men's luxury style advisor for high-net-worth clients. Analyze this outfit with the precision of a GQ editor and Savile Row tailor combined.\n\n";
  prompt+="OUTFIT DETAILS:\n";
  if(layers&&layers.length>1){
    layers.forEach(function(l,i){prompt+="- Layer "+(i+1)+": "+l.color+" "+(l.pattern||"solid")+" "+l.garmentType+(l.name?" ("+l.name+")":"")+(l.material?" ["+l.material+"]":"")+"\n"});
  }else if(top){prompt+="- Top: "+top.color+" "+(top.pattern||"solid")+" "+(top.garmentType||"")+(top.name?" ("+top.name+")":"")+(top.material?" ["+top.material+"]":"")+"\n"}
  if(bot)prompt+="- Bottom: "+bot.color+" "+(bot.pattern||"solid")+" "+(bot.garmentType||"")+(bot.name?" ("+bot.name+")":"")+(bot.material?" ["+bot.material+"]":"")+"\n";
  if(shoe)prompt+="- Shoes: "+shoe.color+" "+(shoe.name||shoe.garmentType||"shoes")+(shoe.material?" ["+shoe.material+"]":"")+"\n";
  prompt+="- Watch: "+watch.n+" â€” "+watch.d+" dial, "+(watch.straps&&watch.straps.length?watch.straps.map(function(s){return s.type+(s.material?" ("+s.material+")":"")+(s.color&&s.type!=="bracelet"?" in "+s.color:"")}).join(" + "):watch.br?"steel bracelet":"leather strap"+(watch.sc?" ("+watch.sc.join("/")+")":""))+(IS_SHARED?"":", "+(watch.t==="replica"?"replica":"genuine"))+"\n";
  prompt+="- Context: "+(Array.isArray(ctx)?ctx.join(" + "):ctx)+"\n\n";
  prompt+="Return ONLY valid JSON, no markdown fences:\n";
  prompt+='{"vision":"A 3-4 sentence cinematic, editorial description. Describe the man walking into the room â€” how fabrics drape, colors interact, and the watch catches light. Write like a luxury editorial spread.",';
  prompt+='"impact":1-10,"impact_why":"One sentence explaining the psychological impact on observers.",';
  prompt+='"color_story":"Analyze the color palette â€” is it monochrome, complementary, analogous, or triadic? Does the warm/cool balance work? (1-2 sentences).",';
  prompt+='"works":"What color/texture/material combinations create the strongest visual effect (1-2 sentences).",';
  prompt+='"risk":"Any clash, proportion issue, formality mismatch, color temperature conflict, or execution risk (1-2 sentences, or null if flawless).",';
  prompt+='"upgrade":"One specific change that would elevate this outfit even further (1 sentence).",';
  prompt+='"strap_call":"If watch has strap options, which one for this outfit and why (1 sentence, or null if bracelet)."}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:500,
        messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Vision HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Vision error: "+String(e.message||e).slice(0,100);return null}
}

async function aiStyleCoach(wardrobe,watches,ctx,apiKey){
  _lastAiError="";
  var colorCounts={};wardrobe.filter(function(i){return i.color}).forEach(function(i){colorCounts[i.color]=(colorCounts[i.color]||0)+1});
  var colors=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]}).slice(0,10).map(function(e){return e[0]+" (Ã—"+e[1]+")"}).join(", ");
  var types={};wardrobe.forEach(function(i){if(i.garmentType)types[i.garmentType]=(types[i.garmentType]||0)+1});
  var typeStr=Object.entries(types).sort(function(a,b){return b[1]-a[1]}).map(function(e){return e[0]+" Ã—"+e[1]}).join(", ");
  var watchStr=watches.map(function(w){return w.n+" ("+w.d+" dial, "+(w.straps&&w.straps.length?w.straps.map(function(s){return s.type}).join("+"):w.br?"bracelet":"strap")+")"}).join(", ");
  var prompt="You are an expert luxury men's style advisor. Analyze this wardrobe and give specific actionable advice.\n\n";
  prompt+="WARDROBE ("+wardrobe.length+" items):\n- Types: "+typeStr+"\n- Colors: "+colors+"\n";
  prompt+="WATCHES: "+watchStr+"\n";
  prompt+="Primary context: "+ctx+"\n\n";
  prompt+='Return ONLY valid JSON:\n{"summary":"2-3 sentence overall assessment â€” be specific about style identity and trajectory","strengths":["4-5 specific strengths with examples from the wardrobe"],"gaps":["4-5 specific gaps with recommended colors and pieces"],"next_buys":["5 specific items to buy next with exact color and brand tier suggestions"],"style_tip":"One expert styling tip personalized to this exact collection â€” reference specific pieces","seasonal_weak":"Which season needs most work and why (1 sentence)","signature_combos":["3 killer outfit combinations possible from the current wardrobe â€” use exact item names/colors"],"versatility":1-10}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Coach HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Coach error: "+String(e.message||e).slice(0,100);return null}
}

async function aiOccasionPlan(occasion,wardrobe,watches,apiKey){
  _lastAiError="";
  var items=wardrobe.filter(function(i){return i.color&&!i.needsEdit}).map(function(i){return{type:i.garmentType,name:i.name||i.color,color:i.color,pattern:i.pattern||"solid",material:i.material||""}});
  var watchList=watches.map(function(w){return{name:w.n,ref:w.ref||null,size_mm:w.size||null,movement:w.mvmt||null,type:w.t==="replica"?"REP":"GEN",dial:w.d,bracelet:w.br,strap_colors:w.sc||[],straps:w.straps?w.straps.map(function(s){return{type:s.type,color:s.color,material:s.material}}):[]}}); 
  var prompt="You are a luxury men's style advisor. A client needs outfit recommendations for a specific occasion.\n\n";
  prompt+="OCCASION: "+occasion+"\n\n";
  prompt+="AVAILABLE WARDROBE ("+items.length+" items):\n"+JSON.stringify(items.slice(0,30))+"\n\n";
  prompt+="AVAILABLE WATCHES:\n"+JSON.stringify(watchList)+"\n\n";
  prompt+='Create 2 outfit recommendations from the available pieces. Return ONLY valid JSON:\n{"occasion_tips":"3-4 sentences of detailed advice for this specific occasion â€” dress code nuances, common mistakes, and power moves","outfits":[{"name":"Creative editorial outfit name","top":"exact item name/color from wardrobe","bottom":"exact item name/color","shoes":"exact item name/color or suggestion","watch":"exact watch name","layers":"optional mid/outer layer from wardrobe if weather warrants","why":"2 sentences explaining the color story and why this combination works","confidence":1-10},{"name":"...","top":"...","bottom":"...","shoes":"...","watch":"...","layers":"...","why":"...","confidence":1-10}],"avoid":"2 sentences on what to avoid for this occasion with specific examples","power_move":"One unexpected styling choice that would make a statement (1 sentence)"}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Occasion HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Occasion error: "+String(e.message||e).slice(0,100);return null}
}

async function aiWardrobeAudit(wardrobe,watches,saved,wearLog,apiKey){
  _lastAiError="";
  var colorCounts={};wardrobe.filter(function(i){return i.color}).forEach(function(i){colorCounts[i.color]=(colorCounts[i.color]||0)+1});
  var colors=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]}).map(function(e){return e[0]+" Ã—"+e[1]}).join(", ");
  var types={};wardrobe.forEach(function(i){if(i.garmentType)types[i.garmentType]=(types[i.garmentType]||0)+1});
  var mats={};wardrobe.forEach(function(i){if(i.material)mats[i.material]=(mats[i.material]||0)+1});
  var prompt="You are a luxury men's wardrobe consultant performing a comprehensive audit.\n\n";
  prompt+="WARDROBE ("+wardrobe.length+" items):\n";
  prompt+="Types: "+Object.entries(types).map(function(e){return e[0]+" Ã—"+e[1]}).join(", ")+"\n";
  prompt+="Colors: "+colors+"\n";
  prompt+="Materials: "+Object.entries(mats).map(function(e){return e[0]+" Ã—"+e[1]}).join(", ")+"\n";
  prompt+="Watches: "+watches.length+" ("+watches.map(function(w){return w.n}).join(", ")+")\n";
  prompt+="Saved outfits: "+saved.length+"\n";
  prompt+="Wear log entries: "+wearLog.length+"\n\n";
  prompt+='Provide a comprehensive wardrobe audit. Return ONLY valid JSON:\n{"grade":"A+/A/B+/B/C+/C/D/F overall wardrobe grade","grade_why":"2 sentence detailed explanation of the grade","color_harmony":"Assessment of color palette balance â€” warm/cool ratio, missing neutrals, dominant tones (2-3 sentences)","versatility":"How many distinct looks possible, cross-functionality of pieces (2 sentences)","cost_efficiency":"Whether the wardrobe is well-optimized for max outfits per piece (1-2 sentences)","declutter":["Up to 5 specific items/categories that are redundant with reasoning"],"invest":["Up to 5 specific items worth investing in with price tier and color"],"seasonal_score":{"spring":1-10,"summer":1-10,"fall":1-10,"winter":1-10},"watch_wardrobe_synergy":"How well watches complement the wardrobe â€” specific matches and gaps (2-3 sentences)","style_identity":"What style archetype this wardrobe represents (1-2 sentences)","pro_tip":"One advanced styling insight specific to this collection (1-2 sentences)"}';
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1200,messages:[{role:"user",content:prompt}]})});
    if(!r.ok){_lastAiError="Audit HTTP "+r.status;return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Audit error: "+String(e.message||e).slice(0,100);return null}
}

/* â•â•â•â•â•â• AI WATCH IDENTIFICATION â•â•â•â•â•â• */
async function aiWatchID(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:800,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"You are an expert watch identifier for a luxury watch collection app. Analyze this watch photo and identify it.\n\nReturn ONLY valid JSON, no markdown:\n{\"brand\":\"Full brand name\",\"model\":\"Model name\",\"reference\":\"Reference number if identifiable or null\",\"dial_color\":\"Primary dial color description (e.g. Silver-White, Blue, Black, Teal, Burgundy, Green, White, Meteorite, Turquoise, Ivory, Purple)\",\"dial_hex\":\"Hex color code for the dial\",\"case_material\":\"steel/titanium/gold/rose gold/two-tone\",\"case_size\":\"Estimated size in mm or null\",\"movement_type\":\"automatic/manual/quartz/spring drive\",\"has_bracelet\":true/false,\"strap_type\":\"bracelet/leather/rubber/nato/canvas or null\",\"strap_color\":\"strap color or null\",\"complications\":[\"list of complications like chronograph, GMT, moon phase, perpetual calendar, date, day-date\"],\"style_category\":\"dress/sport/diver/pilot/chronograph/field/integrated\",\"suggested_contexts\":[\"formal\",\"clinic\",\"smart-casual\",\"casual\",\"date\",\"weekend\",\"riviera\",\"flex\",\"event\",\"travel\"],\"temperature\":\"warm/cool/neutral/mixed\",\"confidence\":1-10,\"emoji\":\"Single emoji that best represents this watch\",\"notes\":\"Any additional identification notes (1 sentence)\"}"}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="WatchID HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="WatchID error: "+String(e.message||e).slice(0,120);return null}
}

/* â•â•â•â•â•â• AI SELFIE CHECK â•â•â•â•â•â• */
async function aiSelfieCheck(b64,mime,apiKey){
  _lastAiError="";
  try{
    var headers={"Content-Type":"application/json"};
    if(apiKey){headers["x-api-key"]=apiKey;headers["anthropic-version"]="2023-06-01";headers["anthropic-dangerous-direct-browser-access"]="true"}
    var r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:headers,
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:800,
        messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mime,data:b64}},{type:"text",text:"You are an elite men's luxury style advisor with encyclopedic horological knowledge.\n\nOWNER'S COLLECTION (ref numbers, sizes, movements for watch identification):\n"+JSON.stringify(watchList,null,0)+"\n\n"+(selWatch?"CONFIRMED: "+selWatch.n+(selWatch.ref?" (Ref "+selWatch.ref+")":"")+(selWatch.size?" "+selWatch.size+"mm":"")+"\n":"")+"Context: "+(selCtx||(Array.isArray(ctx)?ctx.join(" + "):ctx))+"\n\nAnalyze:\n1. Every visible garment â€” color, material, fit, proportion\n2. WATCH DETECTION â€” examine wrist for: case shape, dial color/texture, bezel, bracelet/strap, size. Match against collection using ref numbers.\n3. Color harmony, formality coherence\n4. CRITICAL: brown strap MUST match brown shoes, black strap MUST match black shoes\n5. Overall impression\n\nReturn ONLY valid JSON, no markdown:\n{\"impact\":1-10,\"impact_why\":\"One sentence on the psychological impression this look makes\",\"vision\":\"3-4 sentence cinematic editorial description of the look\",\"color_story\":\"Analysis of color palette â€” monochrome/complementary/analogous? Warm/cool balance? (2 sentences)\",\"fit_assessment\":\"How well do the clothes fit? Proportions correct? (1-2 sentences)\",\"works\":\"What specific elements create the strongest visual effect (1-2 sentences)\",\"risk\":\"Any clash, proportion issue, formality mismatch, or execution risk (1-2 sentences, or null if flawless)\",\"upgrade\":\"One specific change to elevate this look (1 sentence)\",\"strap_call\":\"Strap recommendation for the watch, or null if current is optimal (1 sentence)\",\"better_watch\":\"If a different watch from the collection would score higher, name it with ref and why (1 sentence, or null)\",\"watch_confidence\":1-10,\"watch_details\":\"What watch is visible and how it fits the outfit, or 'No watch visible' (1-2 sentences)\",\"items_detected\":[{\"type\":\"Top/Bottom/Shoes/Watch/Accessory\",\"color\":\"detected color\",\"description\":\"brief description\"}]}"}]}]})});
    if(!r.ok){var errTxt=await r.text().catch(function(){return "(no body)"});_lastAiError="Selfie HTTP "+r.status+": "+errTxt.slice(0,120);return null}
    var d=await r.json();var txt=(d.content||[]).map(function(b){return b.text||""}).join("").replace(/```json|```/g,"").trim();
    return JSON.parse(txt);
  }catch(e){_lastAiError="Selfie error: "+String(e.message||e).slice(0,120);return null}
}

/* â•â•â•â•â•â• COMPONENTS (OUTSIDE App) â•â•â•â•â•â• */
const Dot=memo(function DotC(props){
  var color=props.color,size=props.size||10;
  return React.createElement("span",{style:{width:size,height:size,borderRadius:"50%",flexShrink:0,display:"inline-block",background:(CM[color?color.toLowerCase():""]||{}).h||"#5a5a5a",border:color&&color.toLowerCase()==="black"?"1px solid #444":"none"}});
});

const Pill=memo(function PillC(props){
  return React.createElement("button",{onClick:props.onClick,style:{background:props.on?"var(--gold)":"var(--card)",border:"1px solid "+(props.on?"var(--gold)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",color:props.on?"var(--bg)":"#6a6474",fontFamily:"var(--f)",fontSize:11,fontWeight:props.on?600:400,whiteSpace:"nowrap",minHeight:36}},props.children);
});

const ColorGrid=memo(function ColorGridC(props){
  return React.createElement("div",null,CG.map(function(g){
    return React.createElement("div",{key:g.l,style:{marginBottom:10}},
      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em",textTransform:"uppercase"}},g.l),
      React.createElement("div",{style:{display:"flex",gap:7,flexWrap:"wrap",marginTop:5}},
        g.c.map(function(c){return React.createElement("div",{key:c,onClick:function(){props.onChange(c)},className:"swatch "+(props.value===c?"on":""),style:{background:(CM[c]||{}).h||"#5a5a5a"},title:c})})));
  }));
});

const OutfitFigure=memo(function OutfitFigureC(props){
  var tc=(CM[props.topColor]||{}).h||"#5a5a5a";
  var bc=(CM[props.botColor]||{}).h||"#3a3a3a";
  var sc=(CM[props.shoeColor]||{}).h||"#2a2a2a";
  var wc=props.watchColor||"#c9a84c";
  var wi=props.watchIcon||"âŒš";
  var skin="#c8a882";
  return React.createElement("div",{style:{width:props.size||120,margin:"0 auto",position:"relative"}},
    React.createElement("svg",{viewBox:"0 0 120 220",width:props.size||120,height:Math.round((props.size||120)*220/120),style:{filter:"drop-shadow(0 4px 12px rgba(0,0,0,0.4))"}},
      /* Head */
      React.createElement("ellipse",{cx:60,cy:22,rx:14,ry:16,fill:skin}),
      /* Neck */
      React.createElement("rect",{x:54,y:36,width:12,height:8,fill:skin,rx:2}),
      /* Torso / shirt */
      React.createElement("path",{d:"M 36 44 Q 34 44 32 48 L 18 52 L 20 62 L 36 58 L 36 110 Q 36 114 40 114 L 80 114 Q 84 114 84 110 L 84 58 L 100 62 L 102 52 L 88 48 Q 86 44 84 44 Z",fill:tc,stroke:"rgba(255,255,255,0.08)",strokeWidth:0.5}),
      /* Collar detail */
      React.createElement("path",{d:"M 50 44 L 60 56 L 70 44",fill:"none",stroke:"rgba(255,255,255,0.15)",strokeWidth:1.5}),
      /* Left arm */
      React.createElement("path",{d:"M 36 58 L 22 62 L 18 90 L 24 92 L 30 68 L 36 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right arm */
      React.createElement("path",{d:"M 84 58 L 98 62 L 102 90 L 96 92 L 90 68 L 84 66",fill:tc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left hand */
      React.createElement("ellipse",{cx:21,cy:93,rx:5,ry:4,fill:skin}),
      /* Right hand */
      React.createElement("ellipse",{cx:99,cy:93,rx:5,ry:4,fill:skin}),
      /* Watch on left wrist */
      React.createElement("rect",{x:15,y:84,width:12,height:10,rx:2,fill:wc,stroke:"rgba(255,255,255,0.2)",strokeWidth:0.5}),
      React.createElement("circle",{cx:21,cy:89,r:3,fill:"rgba(255,255,255,0.15)"}),
      /* Belt */
      React.createElement("rect",{x:36,y:112,width:48,height:5,fill:"#1a1a1a",rx:1}),
      React.createElement("rect",{x:57,y:113,width:6,height:3,rx:1,fill:"#c9a84c"}),
      /* Left leg */
      React.createElement("path",{d:"M 38 117 L 36 185 L 32 186 L 32 190 Q 32 192 34 192 L 48 192 Q 50 192 50 190 L 50 186 L 48 185 L 50 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Right leg */
      React.createElement("path",{d:"M 70 117 L 72 185 L 70 186 L 70 190 Q 70 192 72 192 L 86 192 Q 88 192 88 190 L 88 186 L 84 185 L 82 117 Z",fill:bc,stroke:"rgba(255,255,255,0.05)",strokeWidth:0.5}),
      /* Left shoe */
      React.createElement("path",{d:"M 30 188 L 30 196 Q 30 200 34 200 L 50 200 Q 54 200 54 196 L 54 192 L 48 192 L 34 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Right shoe */
      React.createElement("path",{d:"M 68 188 L 68 196 Q 68 200 72 200 L 88 200 Q 92 200 92 196 L 92 192 L 86 192 L 72 192 Z",fill:sc,stroke:"rgba(255,255,255,0.1)",strokeWidth:0.5}),
      /* Subtle fabric texture lines on shirt */
      React.createElement("line",{x1:45,y1:60,x2:45,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:55,y1:55,x2:55,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:65,y1:55,x2:65,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5}),
      React.createElement("line",{x1:75,y1:60,x2:75,y2:110,stroke:"rgba(255,255,255,0.03)",strokeWidth:0.5})),
    /* Watch label */
    React.createElement("div",{style:{position:"absolute",left:-2,top:"38%",background:"rgba(0,0,0,0.6)",borderRadius:4,padding:"2px 5px",border:"1px solid "+wc+"60",display:"flex",alignItems:"center",gap:2}},
      React.createElement("span",{style:{fontSize:10}},wi),
      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:wc,fontWeight:600}},props.watchName||"")));
});

const WCard=memo(function WCardC(props){
  var w=props.w,rank=props.rank,detail=props.detail;
  var maxS=15;var pct=Math.max(0,Math.min(100,(w.score/maxS)*100));
  var barC=pct>60?"var(--good)":pct>30?"var(--gold)":"var(--warn)";
  return(
    React.createElement("div",{className:"card-lift",style:{background:rank===0?"var(--card2)":"var(--bg)",border:rank===0?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",borderRadius:12,padding:"14px"}},
      React.createElement("div",{style:{display:"flex",gap:10,alignItems:"flex-start"}},
        React.createElement("div",{style:{width:42,height:42,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"18",fontSize:20,flexShrink:0}},w.i),
        React.createElement("div",{style:{flex:1,minWidth:0}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{fontSize:14,fontWeight:600}},w.n),
            !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px"}},"REP"),
            rank===0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700,background:"rgba(201,168,76,0.1)",padding:"2px 6px",borderRadius:4}},"BEST")),
          (w.ref||w.size)&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:3,display:"flex",gap:6,flexWrap:"wrap"}},
            w.ref&&React.createElement("span",null,"Ref "+w.ref),
            w.size&&React.createElement("span",null,w.size+"mm"),
            w.mvmt&&React.createElement("span",null,w.mvmt)),
          React.createElement("div",{className:"score-bar",style:{marginBottom:6,width:"100%"}},React.createElement("div",{className:"score-fill",style:{width:pct+"%",background:barC}})),
          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:4}},
            React.createElement("span",{style:{display:"inline-flex",alignItems:"center",gap:3,background:w.sr&&w.sr.type==="good"?"#1a2a1a":"var(--card)",borderRadius:6,padding:"4px 8px",border:"1px solid "+(w.sr&&w.sr.type==="good"?"#2a4a2a":"var(--border)")}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:w.sr&&w.sr.type==="good"?"var(--good)":"var(--sub)"}},w.sr?w.sr.text:(w.br?"â›“ï¸ Bracelet":"ðŸ”— Strap"))),
            w.sr&&w.sr.strap&&w.sr.strap.material&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",background:"var(--bg)",borderRadius:4,padding:"2px 6px",border:"1px solid var(--border)"}},w.sr.strap.material)),
          detail&&w.bd&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:4}},
            w.bd.ctx>0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"var(--badge-good)",color:"var(--good)",borderRadius:4,padding:"2px 6px"}},"âœ“ ctx +"+w.bd.ctx),
            w.bd.color!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.color>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.color>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.color>0?"âœ“":"âœ—")+" color "+(w.bd.color>0?"+":"")+w.bd.color),
            w.bd.strap!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:w.bd.strap>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.strap>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},(w.bd.strap>0?"âœ“":"âœ—")+" strap "+(w.bd.strap>0?"+":"")+w.bd.strap),
            w.bd.temp!==0&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",background:"var(--badge-neutral)",color:"var(--sub)",borderRadius:4,padding:"2px 6px"}},"ðŸŒ¡ï¸"+(w.bd.temp>0?"+":"")+w.bd.temp),
            w.bd.fresh&&w.bd.fresh!==0&&React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",background:w.bd.fresh>0?"var(--badge-good)":"var(--badge-warn)",color:w.bd.fresh>0?"var(--good)":"var(--warn)",borderRadius:4,padding:"2px 6px"}},"ðŸ”„"+(w.bd.fresh>0?"+":"")+w.bd.fresh),
            w.bd.auth&&w.bd.auth>0&&React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",background:"var(--badge-good)",color:"var(--good)",borderRadius:4,padding:"2px 6px"}},"âœ¦ genuine +"+w.bd.auth)),
          w.wn&&w.wn.map(function(x,i){return React.createElement("p",{key:i,style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",marginTop:3}},x)}))))
  );
});

/* â•â•â•â•â•â• MODAL WRAPPER â•â•â•â•â•â• */
function Modal(props){
  useEffect(function(){var sy=window.scrollY;document.body.classList.add("modal-open");document.body.style.top="-"+sy+"px";return function(){document.body.classList.remove("modal-open");document.body.style.top="";window.scrollTo(0,sy)}},[]);
  return React.createElement("div",{className:"modal-backdrop",onClick:function(e){if(e.target===e.currentTarget)props.onClose()}},
    React.createElement("div",{className:"modal-body"},
      React.createElement("div",{className:"modal-handle"}),props.children));
}

function genWeekRotation(watches,forecast,weekCtx,wardrobe,reps,wearLog,rotLock){
  var DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var today=new Date().getDay();
  var plan=[];var used={};var lastId=null;
  var defCtx=["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"];
  /* Build days-since-worn map from log */
  var dsw={};var now=Date.now();
  if(wearLog&&wearLog.length){for(var e of wearLog){if(!dsw[e.watchId]||e.ts>dsw[e.watchId])dsw[e.watchId]=e.ts}}
  for(var d=0;d<7;d++){
    var dayIdx=(today+d)%7;var dayName=DAYS[dayIdx];
    var cx=(weekCtx&&weekCtx.length===7)?weekCtx[dayIdx]:defCtx[dayIdx];
    var fc=forecast&&forecast[d]?forecast[d]:null;
    var dayTier=fc?getWT(fc.feelsAvg):null;
    var dayWt=dayTier?dayTier.weight:"mid";
    /* Check if this day has a locked watch */
    var lockedId=rotLock&&rotLock[d]?rotLock[d]:null;
    var lockedWatch=lockedId?watches.find(function(w){return w.id===lockedId}):null;
    var pick;
    if(lockedWatch){
      pick=lockedWatch;
    }else{
      /* Score watches */
      var scored=watches.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"&&(reps||w.t!=="replica")}).map(function(w){
        var s=0;
        if(w.cx&&w.cx.includes(cx))s+=4;
        if(w.wt&&w.wt.includes(dayWt))s+=2;
        if(used[w.id])s-=8;
        if(w.id===lastId)s-=15; /* hard block consecutive same watch */
        if(plan.length>1&&plan[plan.length-2]&&plan[plan.length-2].watch&&plan[plan.length-2].watch.id===w.id)s-=10; /* 2-day minimum gap */
        /* â•â• UPGRADE: Dial color variety â€” penalize consecutive same dial color â•â• */
        if(plan.length>0){var _prevW=plan[plan.length-1].watch;if(_prevW&&_prevW.d&&w.d&&_prevW.d.toLowerCase()===w.d.toLowerCase())s-=4}
        if(plan.length>1){var _prev2W=plan[plan.length-2]&&plan[plan.length-2].watch;if(_prev2W&&_prev2W.d&&w.d&&_prev2W.d.toLowerCase()===w.d.toLowerCase())s-=2}
        var types=plan.map(function(p){return p.watch?p.watch.t:""});
        var gc=types.filter(function(t){return t==="genuine"}).length;
        var rc=types.filter(function(t){return t==="replica"}).length;
        if(w.t==="genuine"&&rc>gc)s+=1;
        if(w.t==="replica"&&gc>rc)s+=1;
        var lastWorn=dsw[w.id];
        if(lastWorn){var daysAgo=Math.floor((now-lastWorn)/(24*60*60*1000));if(daysAgo<=1)s-=4;else if(daysAgo<=3)s-=1;else if(daysAgo>=7)s+=2;else if(daysAgo>=14)s+=3}
        else{s+=1}
        /* Weather condition scoring â€” rain favors bracelets & rubber */
        var dayRain=fc&&fc.cond&&fc.cond.rain;
        if(dayRain){
          if(w.straps&&w.straps.length){
            var _hasWR=w.straps.some(function(s2){return s2.type==="bracelet"||s2.type==="rubber"||s2.type==="mesh"});
            var _onlyL=w.straps.every(function(s2){return s2.type==="leather"});
            if(_hasWR)s+=3;if(_onlyL)s-=2;
          }else{if(w.br)s+=3;else s-=2}
        }
        return Object.assign({},w,{rotScore:s});
      }).sort(function(a,b){return b.rotScore-a.rotScore});
      pick=scored[0]||null;
    }
    if(pick){used[pick.id]=true;lastId=pick.id}
    /* Generate top outfit for this day's watch+context+weather */
    var dayFit=null;var altFits=[];
    var dayWxOpts=fc?{rain:fc.cond&&fc.cond.rain,wind:fc.wind||0,uv:fc.uv||0,rainPct:fc.rainPct||0}:null;
    if(pick&&wardrobe&&wardrobe.length>=2){
      var dayFits=genFits(wardrobe,[pick],cx,true,dayWt,4,{wx:dayWxOpts,temp:fc?fc.feelsAvg:18,wearLog:wearLog});
      if(dayFits.length)dayFit=dayFits[0];
      altFits=dayFits.slice(1,4);
    }
    plan.push({day:d,dayIdx:dayIdx,dayName:dayName,date:fc?fc.date:"",context:cx,tier:dayTier,weight:dayWt,watch:pick,forecast:fc,outfit:dayFit,altOutfits:altFits,locked:!!lockedWatch,
      strapPick:(function(){if(!pick)return null;var pw=pick.straps&&pick.straps.length?pick:migrateStraps(pick);if(pw.straps&&pw.straps.length>1&&dayFit)return strapRec(pw,dayFit.items,cx,dayWxOpts);if(pw.straps&&pw.straps.length===1)return{text:pw.straps[0].type==="bracelet"?"â›“ï¸ Bracelet"+(pw.straps[0].material?" ("+pw.straps[0].material+")":""):pw.straps[0].color+" "+pw.straps[0].type,type:"info",strap:pw.straps[0]};return null})()});
  }
  /* Cross-day dedup: if consecutive days share same top+bot, swap second day to alt */
  for(var dd=0;dd<plan.length-1;dd++){
    var a=plan[dd],b=plan[dd+1];
    if(a.outfit&&b.outfit&&a.outfit.top&&b.outfit.top&&a.outfit.bot&&b.outfit.bot&&a.outfit.top.id===b.outfit.top.id&&a.outfit.bot.id===b.outfit.bot.id){
      if(b.altOutfits&&b.altOutfits.length){var alt=b.altOutfits.find(function(af){return!af.top||!af.bot||af.top.id!==a.outfit.top.id||af.bot.id!==a.outfit.bot.id});if(alt){b.outfit=alt;b.altOutfits=b.altOutfits.filter(function(af){return af!==alt})}}
    }
  }
  return plan;
}

/* â•â•â•â•â•â• APP â•â•â•â•â•â• */
function App(){
  const[W,setW]=useState(DEFAULTS);
  const[wd,setWd]=useState([]);
  const[view,setView]=useState("wardrobe");
  const[ctx,setCtx]=useState(["smart-casual"]);
  const[reps,setReps]=useState(true);
  const[proc,setProc]=useState([]);
  const[saved,setSaved]=useState([]);
  const[selFit,setSelFit]=useState(null);
  const[fitWatch,setFitWatch]=useState(null);
  const[wFilt,setWFilt]=useState("all");
  const[wMatFilt,setWMatFilt]=useState("all");
  const[weather,setWx]=useState(null);
  const[wxErr,setWxErr]=useState(false);
  const[loc,setLoc]=useState({lat:31.7683,lon:35.2137,name:"Jerusalem"});
  const[editG,setEditG]=useState(null);
  const[editW,setEditW]=useState(null);
  const[addG,setAddG]=useState(false);
  const[mode,setMode]=useState("auto");
  const[topType,setTopType]=useState("all");
  const[lockItem,setLockItem]=useState(null);
  const[shuffleKey,setShuffleKey]=useState(0);
  const[fitCount,setFitCount]=useState(12);
  const[buildSlot,setBuildSlot]=useState(null);
  const[bTop,setBTop]=useState(null);
  const[bMid,setBMid]=useState(null);
  const[bOuter,setBOuter]=useState(null);
  const[bBot,setBBot]=useState(null);
  const[bShoe,setBShoe]=useState(null);
  const[bAcc,setBAcc]=useState(null);
  const[wTab,setWTab]=useState("all");
  const[aiErr,setAiErr]=useState("");
  const[apiKey,setApiKey]=useState("");
  const[recUser,setRecUser]=useState(function(){try{return localStorage.getItem("wa_rec_user")||""}catch(e){return""}});
  const[recPass,setRecPass]=useState(function(){try{return localStorage.getItem("wa_rec_pass")||""}catch(e){return""}});
  const[recStatus,setRecStatus]=useState("");
  const[showSettings,setShowSettings]=useState(false);
  const[forecast,setForecast]=useState([]);
  const[planDay,setPlanDay]=useState(0);
  const[onboarded,setOnboarded]=useState(!IS_SHARED);
  const[onboardStep,setOnboardStep]=useState(1);
  const[obWatches,setObWatches]=useState([]);
  const[obGarments,setObGarments]=useState([]);
  const[weekCtx,setWeekCtx]=useState(IS_SHARED?["casual","smart-casual","smart-casual","smart-casual","smart-casual","smart-casual","weekend"]:["casual","clinic","clinic","clinic","clinic","smart-casual","weekend"]);
  const[editRotCtx,setEditRotCtx]=useState(false);
  const[wearLog,setWearLog]=useState([]);
  const[aiCritique,setAiCritique]=useState(null);
  const[aiLoading,setAiLoading]=useState(false);
  const[dailyPick,setDailyPick]=useState(null);
  const[rotLock,setRotLock]=useState([null,null,null,null,null,null,null]);
  const[editDayIdx,setEditDayIdx]=useState(null);
  const[editDayMode,setEditDayMode]=useState(null);
  const[expandDay,setExpandDay]=useState(null);
  const[altSwap,setAltSwap]=useState({});
  const[wearPicker,setWearPicker]=useState(null);
  const[pieceSwap,setPieceSwap]=useState({});
  const[piecePicker,setPiecePicker]=useState(null);
  const[pieceFilter,setPieceFilter]=useState(null);
  const[dayAi,setDayAi]=useState({});
  const[dayAiLoading,setDayAiLoading]=useState(null);
  const[userCx,setUserCx]=useState(null);
  const[theme,setTheme]=useState("dark");
  const[buildName,setBuildName]=useState("");
  const[buildAiCritique,setBuildAiCritique]=useState(null);
  const[buildAiLoading,setBuildAiLoading]=useState(false);
  const[buildWatch,setBuildWatch]=useState(null);
  const[showDupes,setShowDupes]=useState(false);
  const[dupeGroups,setDupeGroups]=useState([]);
  const[wDupeGroups,setWDupeGroups]=useState([]);
  const[showWDupes,setShowWDupes]=useState(false);
  const[aiCoach,setAiCoach]=useState(null);
  const[aiCoachLoading,setAiCoachLoading]=useState(false);
  const[aiOccasion,setAiOccasion]=useState(null);
  const[aiOccasionLoading,setAiOccasionLoading]=useState(false);
  const[aiOccasionInput,setAiOccasionInput]=useState("");
  const[aiAudit,setAiAudit]=useState(null);
  const[aiAuditLoading,setAiAuditLoading]=useState(false);
  const[lightboxSrc,setLightboxSrc]=useState(null);
  const[lightboxItems,setLightboxItems]=useState([]);
  const[showSaveToast,setShowSaveToast]=useState(false);
  const[watchScanLoading,setWatchScanLoading]=useState(false);
  const[watchScanResult,setWatchScanResult]=useState(null);
  const[selfieHistory,setSelfieHistory]=useState([]);
  const[selfieLoading,setSelfieLoading]=useState(false);
  const[selfieResult,setSelfieResult]=useState(null);
  const fRef=useRef();const cRef=useRef();const wPhotoRef=useRef();const wCamRef=useRef();
  const selfieRef=useRef();const selfieRearRef=useRef();const selfieGalRef=useRef();
  const apiKeyRef=useRef("");

  /* Storage: Claude.ai artifact has window.storage.set/get returning promises. Chrome's StorageManager is different. */
  const hasAS=(function(){try{return typeof window.storage==="object"&&typeof window.storage.set==="function"&&typeof window.storage.get==="function"&&window.storage!==navigator.storage}catch(e){return false}})();
  const ps=useCallback(async function(k,v){var j=JSON.stringify(v);try{if(hasAS){await window.storage.set(k,j)}else{localStorage.setItem(k,j)}}catch(e){try{localStorage.setItem(k,j)}catch(e2){if(e2.name==="QuotaExceededError")console.warn("Storage quota exceeded for key:",k)}}},[]);
  const loadKey=function(k){if(hasAS){return window.storage.get(k).then(function(r){return r&&r.value?JSON.parse(r.value):null}).catch(function(){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}})}try{var v=localStorage.getItem(k);return Promise.resolve(v?JSON.parse(v):null)}catch(e){return Promise.resolve(null)}};

  useEffect(function(){(async function(){
    var wLoaded=false,wdLoaded=false,ofLoaded=false;
    // Load current version
    try{var p=await loadKey("w_"+SK);if(p&&p.length){setW(p.map(migrateStraps));wLoaded=true}}catch(e){}
    try{var p2=await loadKey("wd_"+SK);if(p2&&p2.length){setWd(p2);wdLoaded=true}}catch(e){}
    try{var p3=await loadKey("of_"+SK);if(p3&&p3.length){setSaved(p3);ofLoaded=true}}catch(e){}
    // Migrate from older versions (v12 first, then older)
    if(!wLoaded){for(var vk of["w_v12","w_v11","w_v9","watches_v8"]){try{var pm=await loadKey(vk);if(pm&&pm.length){var mw=pm.map(function(w){return migrateStraps(Object.assign({size:null,photoUrl:null},w))});setW(mw);ps("w_"+SK,mw);wLoaded=true;break}}catch(e){}}}
    if(!wdLoaded){for(var vk2 of["wd_v12","wd_v11","wd_v9","wd_v8"]){try{var pm2=await loadKey(vk2);if(pm2&&pm2.length){var mg=pm2.map(function(g){return Object.assign({material:null,seasons:[],positionHint:null,lastWorn:null},g)});setWd(mg);ps("wd_"+SK,mg);wdLoaded=true;break}}catch(e){}}}
    if(!ofLoaded){for(var vk3 of["of_v12","of_v11","of_v9","of_v8"]){try{var pm3=await loadKey(vk3);if(pm3&&pm3.length){setSaved(pm3);ps("of_"+SK,pm3);ofLoaded=true;break}}catch(e){}}}
    // Load API key
    try{var ak=await loadKey("wa_apikey");if(ak){setApiKey(ak);apiKeyRef.current=ak}}catch(e){}
    try{var wc=await loadKey("wa_weekctx");if(wc&&wc.length===7)setWeekCtx(wc)}catch(e){}
    try{var ucx=await loadKey("wa_usercx_"+SK);if(ucx&&ucx.length)setUserCx(ucx)}catch(e){}
    try{var wl=await loadKey("wa_wearlog_"+SK);if(wl&&wl.length)setWearLog(wl);else{for(var wlk of["wa_wearlog_v12","wa_wearlog_v11"]){try{var wlm=await loadKey(wlk);if(wlm&&wlm.length){setWearLog(wlm);ps("wa_wearlog_"+SK,wlm);break}}catch(e){}}}}catch(e){}
    try{var rl=await loadKey("wa_rotlock_"+SK);if(rl&&rl.length===7)setRotLock(rl);else{for(var rlk of["wa_rotlock_v12","wa_rotlock_v11"]){try{var rlm=await loadKey(rlk);if(rlm&&rlm.length===7){setRotLock(rlm);ps("wa_rotlock_"+SK,rlm);break}}catch(e){}}}}catch(e){}
    // Auto-onboard if existing data found
    if(wLoaded||wdLoaded)setOnboarded(true);
    try{var ob=await loadKey("wa_onboarded");if(ob)setOnboarded(true)}catch(e){}
    try{var th=await loadKey("wa_theme");if(th)setTheme(th)}catch(e){}
    try{var sh=await loadKey("wa_selfie_"+SK);if(sh&&sh.length)setSelfieHistory(sh)}catch(e){}
    // Cleanup old storage keys after successful migration
    var oldKeys=["w_v12","w_v11","w_v9","watches_v8","wd_v12","wd_v11","wd_v9","wd_v8","of_v12","of_v11","of_v9","of_v8","wa_wearlog_v12","wa_wearlog_v11","wa_rotlock_v12","wa_rotlock_v11","w_v13","wd_v13","of_v13","wa_wearlog_v13","wa_rotlock_v13"];
    setTimeout(function(){oldKeys.forEach(function(k){try{localStorage.removeItem(k)}catch(e){}})},3000);
  })()},[]);

  useEffect(function(){if(theme==="light")document.body.classList.add("light");else document.body.classList.remove("light");return function(){document.body.classList.remove("light")}},[theme]);
  useEffect(function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(function(p){setLoc({lat:p.coords.latitude,lon:p.coords.longitude,name:"Your Location"})},function(err){console.log("Geolocation denied/unavailable, using default location");setLoc({lat:31.7683,lon:35.2137,name:"Jerusalem (default)"})},{timeout:8000,maximumAge:300000})}catch(e){console.log("Geolocation error:",e)}},[]);
  useEffect(function(){(async function(){try{var r=await fetch("https://api.open-meteo.com/v1/forecast?latitude="+loc.lat+"&longitude="+loc.lon+"&current=temperature_2m,apparent_temperature,wind_speed_10m,relative_humidity_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,weather_code,precipitation_probability_max,uv_index_max,wind_speed_10m_max&timezone=auto&forecast_days=7");var d=await r.json();if(d.current){var cwmo=getWMO(d.current.weather_code);setWx({temp:Math.round(d.current.temperature_2m),feels:Math.round(d.current.apparent_temperature),wind:Math.round(d.current.wind_speed_10m),hum:d.current.relative_humidity_2m,code:d.current.weather_code,cond:cwmo})}if(d.daily&&d.daily.time)setForecast(d.daily.time.map(function(dt,i){var wmo=getWMO(d.daily.weather_code?d.daily.weather_code[i]:0);return{date:dt,high:Math.round(d.daily.temperature_2m_max[i]),low:Math.round(d.daily.temperature_2m_min[i]),feelsHigh:Math.round(d.daily.apparent_temperature_max[i]),feelsLow:Math.round(d.daily.apparent_temperature_min[i]),feelsAvg:Math.round((d.daily.apparent_temperature_max[i]+d.daily.apparent_temperature_min[i])/2),code:d.daily.weather_code?d.daily.weather_code[i]:0,cond:wmo,rainPct:d.daily.precipitation_probability_max?d.daily.precipitation_probability_max[i]:0,uv:d.daily.uv_index_max?Math.round(d.daily.uv_index_max[i]):0,wind:d.daily.wind_speed_10m_max?Math.round(d.daily.wind_speed_10m_max[i]):0}}))}catch(e){console.error("Weather fetch failed:",e);setWxErr(true)}})()},[loc]);

  const tier=useMemo(function(){if(planDay===0&&weather)return getWT(weather.feels);if(planDay>0&&forecast[planDay])return getWT(forecast[planDay].feelsAvg);return weather?getWT(weather.feels):null},[weather,forecast,planDay]);
  const ww=tier?tier.weight:"mid";
  const planTemp=useMemo(function(){if(planDay===0&&weather)return{temp:weather.temp,feels:weather.feels};if(forecast[planDay])return{temp:Math.round((forecast[planDay].high+forecast[planDay].low)/2),feels:forecast[planDay].feelsAvg};return weather?{temp:weather.temp,feels:weather.feels}:null},[weather,forecast,planDay]);
  const planWx=useMemo(function(){
    if(planDay===0&&weather)return{rain:weather.cond&&weather.cond.rain,wind:weather.wind,uv:0,cond:weather.cond||null,rainPct:0};
    var fc=forecast[planDay];if(fc)return{rain:fc.cond&&fc.cond.rain,wind:fc.wind,uv:fc.uv,cond:fc.cond||null,rainPct:fc.rainPct||0};
    return null;
  },[weather,forecast,planDay]);
  const effectiveCtx=useMemo(function(){
    if(planDay>0){var dayIdx=(new Date().getDay()+planDay)%7;var wc=weekCtx[dayIdx];return wc?[wc]:ctx}
    return ctx;
  },[planDay,weekCtx,ctx]);
  const primaryCtx=useMemo(function(){return Array.isArray(effectiveCtx)?effectiveCtx[0]||"smart-casual":effectiveCtx},[effectiveCtx]);
  const ctxSet=useMemo(function(){return new Set(Array.isArray(effectiveCtx)?effectiveCtx:[effectiveCtx])},[effectiveCtx]);
  const activeCx=useMemo(function(){return userCx||(IS_SHARED?SHARE_DEFAULT_CX:DEFAULT_CX)},[userCx]);
  const activeCxIds=useMemo(function(){return activeCx.map(function(c){return c.id})},[activeCx]);
  const activeCxIcons=useMemo(function(){var m={};activeCx.forEach(function(c){m[c.id]=c.icon});return m},[activeCx]);
  const actW=useMemo(function(){return W.filter(function(w){return w.active&&w.status!=="sold"&&w.status!=="service"})},[W]);
  const byCat=useMemo(function(){return{tops:wd.filter(function(i){return catOf(i.garmentType)==="tops"}),bottoms:wd.filter(function(i){return catOf(i.garmentType)==="bottoms"}),shoes:wd.filter(function(i){return catOf(i.garmentType)==="shoes"}),accessories:wd.filter(function(i){return catOf(i.garmentType)==="accessories"||catOf(i.garmentType)==="other"})}},[wd]);
  const fits=useMemo(function(){return wd.length<2?[]:genFits(wd,actW,effectiveCtx,reps,ww,fitCount,{topType:topType,lockItem:lockItem,shuffle:shuffleKey>0,wx:planWx,temp:planTemp?planTemp.feels:18,wearLog:wearLog})},[wd,actW,effectiveCtx,reps,ww,topType,lockItem,shuffleKey,fitCount,planWx,planTemp]);
  const buildFit=useMemo(function(){var items=[bTop,bMid,bOuter,bBot,bShoe,bAcc].filter(Boolean);return items.length>=2?makeOutfit(items,actW,effectiveCtx,reps,planWx,planTemp?planTemp.feels:18):null},[bTop,bMid,bOuter,bBot,bShoe,bAcc,actW,effectiveCtx,reps,planWx,planTemp]);
  const needsFix=useMemo(function(){return wd.filter(function(i){return i.needsEdit||!i.color}).length},[wd]);

  const findDuplicates=useCallback(function(){
    var classified=wd.filter(function(i){return i.color&&!i.needsEdit});
    var groups={};
    classified.forEach(function(item){
      var key=item.garmentType+"_"+item.color.toLowerCase()+(item.pattern&&item.pattern!=="solid"?"_"+item.pattern:"");
      if(!groups[key])groups[key]=[];
      groups[key].push(item);
    });
    /* Also check items with same name */
    classified.forEach(function(item){
      if(!item.name)return;
      var nameKey="name_"+item.name.toLowerCase().trim();
      if(!groups[nameKey])groups[nameKey]=[];
      var already=groups[nameKey].some(function(g){return g.id===item.id});
      if(!already)groups[nameKey].push(item);
    });
    /* Color family grouping: catch "navy chinos" vs "navy pants" */
    var catGroups={};
    classified.forEach(function(item){
      var cat=catOf(item.garmentType);
      var colorFam=getColorFamily((item.color||"").toLowerCase())||item.color;
      var famKey="fam_"+cat+"_"+colorFam+(item.pattern&&item.pattern!=="solid"?"_"+item.pattern:"");
      if(!catGroups[famKey])catGroups[famKey]=[];
      catGroups[famKey].push(item);
    });
    Object.keys(catGroups).forEach(function(k){if(catGroups[k].length>=2&&!groups[k])groups[k]=catGroups[k]});
    /* Deduplicate: remove groups where all items already appear in another group */
    var allGroups=Object.values(groups).filter(function(g){return g.length>=2});
    var seen={};var unique=[];
    allGroups.forEach(function(g){
      var ids=g.map(function(i){return i.id}).sort().join(",");
      if(!seen[ids]){seen[ids]=true;unique.push(g)}
    });
    return unique;
  },[wd]);

  /* Watch duplicate detection */
  const findWatchDupes=useCallback(function(){
    var groups={};
    /* Group by normalized name */
    W.forEach(function(w){
      var normName=w.n.toLowerCase().replace(/[^a-z0-9]/g,"");
      var key="name_"+normName;
      if(!groups[key])groups[key]=[];
      groups[key].push(w);
    });
    /* Group by dial color + type */
    W.forEach(function(w){
      var key2="dial_"+w.t+"_"+(w.d||"").toLowerCase().replace(/[^a-z0-9]/g,"");
      if(!groups[key2])groups[key2]=[];
      var already=groups[key2].some(function(g){return g.id===w.id});
      if(!already)groups[key2].push(w);
    });
    /* Group by fuzzy name similarity (contains check) */
    for(var i=0;i<W.length;i++){
      for(var j=i+1;j<W.length;j++){
        var a=W[i].n.toLowerCase(),b=W[j].n.toLowerCase();
        if(a.length>4&&b.length>4&&(a.includes(b.substring(0,5))||b.includes(a.substring(0,5)))){
          var fk="fuzzy_"+[W[i].id,W[j].id].sort().join("_");
          if(!groups[fk])groups[fk]=[W[i],W[j]];
        }
      }
    }
    /* Filter to groups with 2+ items, dedup */
    var allGroups=Object.values(groups).filter(function(g){return g.length>=2});
    var seen={};var unique=[];
    allGroups.forEach(function(g){
      var ids=g.map(function(w){return w.id}).sort().join(",");
      if(!seen[ids]){seen[ids]=true;unique.push(g)}
    });
    return unique;
  },[W]);

  const saveAll=useCallback(function(){
    ps("w_"+SK,W);ps("wd_"+SK,wd);ps("of_"+SK,saved);
    ps("wa_wearlog_"+SK,wearLog);ps("wa_weekctx",weekCtx);
    if(userCx)ps("wa_usercx_"+SK,userCx);
    ps("wa_theme",theme);
    ps("wa_selfie_"+SK,selfieHistory);
    ps("wa_rotlock_"+SK,rotLock);
    setShowSaveToast(true);
    setTimeout(function(){setShowSaveToast(false)},2000);
  },[W,wd,saved,wearLog,weekCtx,userCx,theme,selfieHistory,rotLock,ps]);

  const openLightbox=useCallback(function(src,itemId){
    if(!src)return;
    setLightboxSrc(src);
    var items=wd.filter(function(i){return i.photoUrl===src});
    setLightboxItems(items.length>1?items:itemId?wd.filter(function(i){return i.id===itemId}):[]);
  },[wd]);

  const updateW=useCallback(function(id,u){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,u):w});ps("w_"+SK,n);return n})},[ps]);
  const toggleW=useCallback(function(id){setW(function(p){var n=p.map(function(w){return w.id===id?Object.assign({},w,{active:!w.active}):w});ps("w_"+SK,n);return n})},[ps]);
  const removeW=useCallback(function(id){setW(function(p){var n=p.filter(function(w){return w.id!==id});ps("w_"+SK,n);return n})},[ps]);

  const saveWd=useCallback(function(n){setWd(n);ps("wd_"+SK,n)},[ps]);
  const rmG=useCallback(function(id){setWd(function(p){var n=p.filter(function(i){return i.id!==id});ps("wd_"+SK,n);return n})},[ps]);
  const updG=useCallback(function(id,u){setWd(function(p){var n=p.map(function(i){return i.id===id?Object.assign({},i,u,{needsEdit:false}):i});ps("wd_"+SK,n);return n})},[ps]);
  const addGarment=useCallback(function(item){setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n})},[ps]);

  const logWear=useCallback(function(watchId,dateStr){
    setWearLog(function(p){
      /* Remove existing entry for same date, then add new */
      var n=p.filter(function(e){return e.date!==dateStr}).concat([{date:dateStr,watchId:watchId,ts:Date.now()}]);
      /* Keep last 90 days only */
      var cutoff=Date.now()-90*24*60*60*1000;
      n=n.filter(function(e){return e.ts>cutoff});
      ps("wa_wearlog_"+SK,n);return n;
    });
  },[ps]);
  const undoWear=useCallback(function(dateStr){
    setWearLog(function(p){var n=p.filter(function(e){return e.date!==dateStr});ps("wa_wearlog_"+SK,n);return n});
  },[ps]);
  const daysSince=useCallback(function(watchId){
    var now=Date.now();var last=null;
    for(var e of wearLog){if(e.watchId===watchId&&(!last||e.ts>last))last=e.ts}
    if(!last)return 999;
    return Math.floor((now-last)/(24*60*60*1000));
  },[wearLog]);
  const todayStr=new Date().toISOString().slice(0,10);
  const todayWorn=wearLog.find(function(e){return e.date===todayStr});

  const _processingRef=useRef(false);
  const processFiles=useCallback(async function(files){
    if(_processingRef.current){setAiErr("Already processing files, please wait...");return}
    _processingRef.current=true;
    var arr=Array.from(files);var pids=arr.map(function(_,i){return Date.now()+i});
    setProc(function(p){return p.concat(pids)});
    for(var i=0;i<arr.length;i++){
      var f=arr[i],pid=pids[i];
      try{
        var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(f)});
        // Compress for AI (600px) and storage thumbnail (400px)
        var compressed=await compressImage(rawUrl,600,0.6);
        var thumb=await compressImage(rawUrl,400,0.5);
        var b64=compressed.split(",")[1];
        var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
        if(aiResult&&Array.isArray(aiResult)&&aiResult.length>0){
          var newItems=aiResult.map(function(ai,idx){var sd=smartDefaults(ai);return Object.assign({},sd,ai,{photoUrl:thumb,id:pid+idx,ts:Date.now(),positionHint:aiResult.length>1?(ai.position||null):null,material:ai.material||null})});
          setWd(function(p){var n=p.concat(newItems);ps("wd_"+SK,n);return n});
          if(aiResult.length>1)setAiErr("ðŸ“¸ Found "+aiResult.length+" items in photo");
        }else{
          var item={garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb,id:pid,needsEdit:true,ts:Date.now(),aiError:getLastAiError()};
          setWd(function(p){var n=p.concat([item]);ps("wd_"+SK,n);return n});
          setAiErr(getLastAiError());
        }
      }catch(e){
        try{var thumb2=await compressImage(await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(f)}),400,0.5);
        setWd(function(p){var n=p.concat([{garmentType:"Shirt",name:"",color:"",pattern:"solid",photoUrl:thumb2,id:pid,needsEdit:true,ts:Date.now(),aiError:"FileReader: "+String(e)}]);ps("wd_"+SK,n);return n})}catch(e2){}
        setAiErr("File error: "+String(e));
      }
      setProc(function(p){return p.filter(function(x){return x!==pid})});
      // Delay between items to avoid rate limit
      if(i<arr.length-1)await new Promise(function(r){setTimeout(r,600)});
    }
    _processingRef.current=false;
  },[ps]);

  const scanWatch=useCallback(async function(file){
    setWatchScanLoading(true);setWatchScanResult(null);
    try{
      var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(file)});
      var compressed=await compressImage(rawUrl,600,0.6);
      var thumb=await compressImage(rawUrl,400,0.5);
      var b64=compressed.split(",")[1];
      var result=await aiWatchID(b64,"image/jpeg",apiKeyRef.current);
      if(result&&result.brand){
        var id="scan-"+Date.now();
        var dialInfo=inferDial(result.brand+" "+result.model,result.dial_color||"");
        var mc=autoMatchColors(result.dial_color||dialInfo.color);
        var straps=[];
        if(result.has_bracelet||result.strap_type==="bracelet"){straps.push({type:"bracelet",color:"silver",material:result.case_material||"steel"})}
        if(result.strap_type&&result.strap_type!=="bracelet"){straps.push({type:result.strap_type==="nato"?"nato":result.strap_type==="rubber"?"rubber":result.strap_type==="canvas"?"canvas":"leather",color:result.strap_color||"black",material:result.strap_type||"calf leather"})}
        if(!straps.length)straps.push({type:"bracelet",color:"silver",material:"steel"});
        var nw={id:id,n:(result.brand||"")+" "+(result.model||""),t:"genuine",d:result.dial_color||dialInfo.color||"",c:result.dial_hex||dialInfo.hex||"#5a5a5a",straps:straps,br:straps.some(function(s){return s.type==="bracelet"}),sc:straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color}),mt:result.temperature||"neutral",i:result.emoji||dialInfo.emoji||"âŒš",mc:mc,ac:[],cx:result.suggested_contexts||inferContexts(result.brand+" "+result.model,""),wt:["light","mid","heavy"],sg:result.notes||"",active:true,status:"active",photoUrl:thumb,size:result.case_size?result.case_size+"mm":null,ref:result.reference||null,scanData:result};
        setWatchScanResult({watch:nw,ai:result});
      }else{
        setWatchScanResult({error:getLastAiError()||"Could not identify watch"});
        setAiErr(getLastAiError()||"Watch identification failed");
      }
    }catch(e){
      setWatchScanResult({error:"Error: "+String(e.message||e)});
      setAiErr("Watch scan error: "+String(e));
    }
    setWatchScanLoading(false);
  },[ps]);

  const checkSelfie=useCallback(async function(file){
    setSelfieLoading(true);setSelfieResult(null);
    try{
      var rawUrl=await new Promise(function(r,j){var x=new FileReader();x.onload=function(){r(x.result)};x.onerror=j;x.readAsDataURL(file)});
      var compressed=await compressImage(rawUrl,600,0.6);
      var thumb=await compressImage(rawUrl,300,0.5);
      var b64=compressed.split(",")[1];
      var result=await aiSelfieCheck(b64,"image/jpeg",apiKeyRef.current);
      if(result&&result.impact){
        var entry={id:Date.now(),ts:Date.now(),thumb:thumb,result:result,impact:result.impact};
        setSelfieResult(entry);
        setSelfieHistory(function(p){var n=[entry].concat(p).slice(0,20);ps("wa_selfie_"+SK,n);return n});
      }else{
        setSelfieResult({error:getLastAiError()||"Could not analyze photo"});
        setAiErr(getLastAiError()||"Selfie analysis failed");
      }
    }catch(e){
      setSelfieResult({error:"Error: "+String(e.message||e)});
      setAiErr("Selfie error: "+String(e));
    }
    setSelfieLoading(false);
  },[ps]);

  const delSelfie=useCallback(function(id){
    setSelfieHistory(function(p){var n=p.filter(function(e){return e.id!==id});ps("wa_selfie_"+SK,n);return n});
  },[ps]);

  const saveFit=useCallback(function(fit){var wxSnap=planTemp&&planWx?{temp:planTemp.temp,cond:planWx.cond,rain:planWx.rain}:null;var o={id:Date.now(),name:(fit.top?fit.top.name||fit.top.color:"?")+" + "+(fit.bot?fit.bot.name||fit.bot.color:"?"),items:fit.items,context:Array.isArray(effectiveCtx)?effectiveCtx.join(" + "):effectiveCtx,watches:fit.watches,fs:fit.fs,ts:Date.now(),weather:wxSnap};setSaved(function(p){var n=p.concat([o]);ps("of_"+SK,n);return n});/* Auto-update lastWorn on garments */var todayISO=new Date().toISOString().slice(0,10);var itemIds=new Set((fit.items||[]).map(function(it){return it.id}));setWd(function(prev){var changed=false;var nw=prev.map(function(g){if(itemIds.has(g.id)){changed=true;return Object.assign({},g,{lastWorn:todayISO})}return g});if(changed)ps("wd_"+SK,nw);return changed?nw:prev})},[effectiveCtx,ps,planTemp,planWx]);
  const delSaved=useCallback(function(id){setSaved(function(p){var n=p.filter(function(o){return o.id!==id});ps("of_"+SK,n);return n})},[ps]);

  const setOutfitWear=useCallback(function(id,dateStr){
    setSaved(function(p){
      var n=p.map(function(o){
        if(o.id!==id)return o;
        var u=Object.assign({},o);
        if(dateStr){u.wearDate=dateStr}else{delete u.wearDate}
        return u;
      });
      ps("of_"+SK,n);
      /* If wearing today, also log watch to wearLog */
      var todayISO=new Date().toISOString().slice(0,10);
      if(dateStr===todayISO){
        var outfit=p.find(function(o){return o.id===id});
        if(outfit&&outfit.watches&&outfit.watches.length){
          var wId=outfit.watches[0].id;
          if(wId){setWearLog(function(prev){
            var already=prev.find(function(e){return e.date===todayISO&&e.watchId===wId});
            if(already)return prev;
            var entry={watchId:wId,date:todayISO,ts:Date.now(),outfitId:id};
            var next=prev.concat([entry]);
            ps("wa_wearlog_"+SK,next);
            return next;
          })}
        }
      }
      return n;
    });
    setWearPicker(null);
  },[ps]);

  /* â•â•â• Per-piece swap helpers â•â•â• */
  const getEP=useCallback(function(di,slot,orig){if(!orig&&!pieceSwap[di+"-"+slot])return null;var k=di+"-"+slot;return pieceSwap[k]||orig},[pieceSwap]);
  const slotAlts=useCallback(function(slot){
    var cat=slot==="top"?"tops":slot==="bot"?"bottoms":"shoes";
    return wd.filter(function(it){return catOf(it.garmentType)===cat});
  },[wd]);
  const slotColors=useCallback(function(slot){
    var items=slotAlts(slot);
    var seen={};items.forEach(function(it){if(it.color)seen[it.color]=1});
    return Object.keys(seen).sort();
  },[slotAlts]);
  const slotPatterns=useCallback(function(slot){
    var items=slotAlts(slot);
    var seen={};items.forEach(function(it){if(it.pattern&&it.pattern!=="solid")seen[it.pattern]=1});
    return Object.keys(seen).sort();
  },[slotAlts]);
  const filteredAlts=useCallback(function(slot,curId){
    var items=slotAlts(slot).filter(function(a){return a.id!==curId});
    if(!pieceFilter)return items;
    if(pieceFilter.startsWith("p:"))return items.filter(function(a){return a.pattern===pieceFilter.slice(2)});
    return items.filter(function(a){return a.color===pieceFilter});
  },[slotAlts,pieceFilter]);

  const CTXS=useMemo(function(){return activeCx.slice(0,8).map(function(c){return{id:c.id,l:c.icon+" "+c.l}})},[activeCx]);
  const filtW=wTab==="all"?W:wTab==="genuine"?W.filter(function(w){return w.t==="genuine"}):wTab==="replica"?W.filter(function(w){return w.t==="replica"}):W.filter(function(w){return w.status===wTab});

  /* â•â•â• GARMENT EDIT (rendered in modal) â•â•â• */
  function renderGarmentEdit(item){
    var GE=function(){
      const[f,setF]=useState(Object.assign({},item));
      const[retrying,setRetrying]=useState(false);
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      var retry=async function(){
        if(!item.photoUrl)return;setRetrying(true);
        try{var compressed=await compressImage(item.photoUrl,600,0.6);var b64=compressed.split(",")[1];
          var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
          if(aiResult&&aiResult.length){var first=aiResult[0];setF(function(p){return Object.assign({},p,first)})}
          else alert(getLastAiError()||"AI couldn't identify. Classify manually.")}catch(e){alert("Retry error: "+e)}
        setRetrying(false);
      };
      return React.createElement(Modal,{onClose:function(){setEditG(null)}},
        React.createElement("div",{style:{display:"flex",gap:14,marginBottom:16}},
          f.photoUrl&&React.createElement("img",{src:f.photoUrl,alt:"",onClick:function(){openLightbox(f.photoUrl,item.id)},style:{width:80,height:80,objectFit:"cover",borderRadius:12,flexShrink:0,cursor:"zoom-in"}}),
          React.createElement("div",{style:{flex:1}},
            React.createElement("label",{className:"lbl"},"Name"),
            React.createElement("input",{className:"inp",value:f.name||"",onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy plaid flannel"}))),
        React.createElement("label",{className:"lbl"},"Garment Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},
          f.color&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:8}},React.createElement(Dot,{color:f.color,size:14}),React.createElement("span",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:500}},f.color)),
          React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:14}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){set("material",f.material===m?null:m)},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("label",{className:"lbl"},"Seasons"),
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:16}},
          ["spring","summer","fall","winter"].map(function(s){var icons={spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"};var arr=f.seasons||[];var on=arr.includes(s);return React.createElement("span",{key:s,className:"chip "+(on?"on":""),onClick:function(){set("seasons",on?arr.filter(function(x){return x!==s}):arr.concat([s]))},style:{flex:1,justifyContent:"center",padding:"6px 4px",fontSize:10}},icons[s]+" "+s)})),
        React.createElement("label",{className:"lbl"},"Last Worn"),
        React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:14}},
          React.createElement("input",{className:"inp",type:"date",value:f.lastWorn||"",onChange:function(e){set("lastWorn",e.target.value)},style:{marginBottom:0,maxWidth:180,fontSize:11,flex:1}}),
          React.createElement("button",{onClick:function(){set("lastWorn",new Date().toISOString().slice(0,10))},style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28,whiteSpace:"nowrap"}},"ðŸ‘• Today"),
          f.lastWorn&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d<=2?"var(--warn)":d<=7?"var(--gold)":"var(--good)"})()}},(function(){var d=Math.floor((Date.now()-new Date(f.lastWorn).getTime())/864e5);return d===0?"today":d===1?"yesterday":d+"d ago"})())),
        item.ts&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:8,display:"flex",gap:12,flexWrap:"wrap"}},
          React.createElement("span",null,"Added: "+new Date(item.ts).toLocaleDateString()),
          f.lastWorn&&React.createElement("span",null,"Last worn: "+new Date(f.lastWorn).toLocaleDateString()),
          saved.some(function(o){return(o.items||[]).some(function(it){return it.id===item.id})})&&React.createElement("span",{style:{color:"var(--good)"}},"âœ“ Used in "+saved.filter(function(o){return(o.items||[]).some(function(it){return it.id===item.id})}).length+" saved outfit(s)")),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){if(!f.color){alert("Pick a color");return}updG(item.id,f);setEditG(null)}},"âœ“ Save"),
          f.color&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){if(!f.color){alert("Pick a color");return}updG(item.id,f);setLockItem(Object.assign({},item,f));setEditG(null);setView("fits");setMode("auto")},title:"Lock for fits"},"ðŸ”’"),
          item.photoUrl&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:retry,disabled:retrying},retrying?"â³":"ðŸ”„"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){var dup=Object.assign({},f,{id:Date.now(),ts:Date.now(),name:(f.name||"")+" copy"});addGarment(dup);setEditG(null)},title:"Duplicate"},"ðŸ“‹"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){rmG(item.id);setEditG(null)}},"ðŸ—‘ï¸")));
    };
    return React.createElement(GE,{key:item.id});
  }

  /* â•â•â• QUICK ADD â•â•â• */
  function renderQuickAdd(){
    var QA=function(){
      const[f,setF]=useState({garmentType:"Shirt",name:"",color:"",pattern:"solid"});
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      return React.createElement(Modal,{onClose:function(){setAddG(false)}},
        React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:14}},"Quick Add"),
        React.createElement("label",{className:"lbl"},"Name"),
        React.createElement("input",{className:"inp",value:f.name,onChange:function(e){set("name",e.target.value)},placeholder:"e.g. Navy chinos",style:{marginBottom:12}}),
        React.createElement("label",{className:"lbl"},"Type"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          ALL_T.map(function(t){return React.createElement("span",{key:t,className:"chip "+(f.garmentType===t?"on":""),onClick:function(){set("garmentType",t)}},t)})),
        React.createElement("label",{className:"lbl"},"Color"),
        React.createElement("div",{style:{marginBottom:14}},React.createElement(ColorGrid,{value:f.color,onChange:function(v){set("color",v)}})),
        React.createElement("label",{className:"lbl"},"Pattern"),
        React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:16}},
          PATTERNS.map(function(p){return React.createElement("span",{key:p,className:"chip "+(f.pattern===p?"on":""),onClick:function(){set("pattern",p)}},p)})),
        React.createElement("label",{className:"lbl"},"Material"),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:16}},
          MATERIALS.map(function(m){return React.createElement("span",{key:m,className:"chip "+(f.material===m?"on":""),onClick:function(){setF(function(p){return Object.assign({},p,{material:p.material===m?null:m})})},style:{padding:"4px 10px",fontSize:10}},m)})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){if(!f.color||!f.name){alert("Need name + color");return}var sd=smartDefaults(f);addGarment(Object.assign({},sd,f,{id:Date.now(),ts:Date.now()}));setAddG(false)}},
          "+ Add to Wardrobe"));
    };
    return React.createElement(QA,null);
  }

  /* â•â•â• WATCH EDIT â•â•â• */
  function renderWatchEdit(w){
    var WE=function(){
      const[f,setF]=useState(Object.assign({},migrateStraps(w)));
      var set=function(k,v){setF(function(p){var o={};o[k]=v;return Object.assign({},p,o)})};
      var togArr=function(k,v){setF(function(p){var arr=p[k]||[];var o={};o[k]=arr.includes(v)?arr.filter(function(x){return x!==v}):arr.concat([v]);return Object.assign({},p,o)})};
      const[addSt,setAddSt]=useState(false);
      const[nSt,setNSt]=useState({type:"leather",color:"",material:"calf leather"});
      var setNStF=function(k,v){setNSt(function(p){var o=Object.assign({},p);o[k]=v;if(k==="type"){var td=STRAP_TYPES.find(function(t){return t.id===v});o.material=td&&td.mats[0]?td.mats[0]:"";o.color=v==="bracelet"?"silver":""}return o})};
      var addStrap=function(){if(!nSt.type)return;var s={type:nSt.type,color:nSt.color||"",material:nSt.material||""};setF(function(p){var ns=(p.straps||[]).concat([s]);return Object.assign({},p,{straps:ns,br:ns.some(function(x){return x.type==="bracelet"}),sc:ns.filter(function(x){return x.type!=="bracelet"}).map(function(x){return x.color})})});setAddSt(false);setNSt({type:"leather",color:"",material:"calf leather"})};
      var rmStrap=function(si){setF(function(p){var ns=(p.straps||[]).filter(function(_,i){return i!==si});return Object.assign({},p,{straps:ns,br:ns.some(function(x){return x.type==="bracelet"}),sc:ns.filter(function(x){return x.type!=="bracelet"}).map(function(x){return x.color})})})};
      var wPhotoRef=useRef();
      var handleWPhoto=async function(){var inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=async function(e){var fl=e.target.files[0];if(!fl)return;var raw=await new Promise(function(r){var x=new FileReader();x.onload=function(){r(x.result)};x.readAsDataURL(fl)});var compressed=await compressImage(raw,300,0.6);set("photoUrl",compressed)};inp.click()};
      return React.createElement(Modal,{onClose:function(){setEditW(null)}},
        React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:14}},
          React.createElement("div",{onClick:handleWPhoto,style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",overflow:"hidden",flexShrink:0,border:"2px solid "+(f.photoUrl?"var(--gold)":"var(--border)"),background:f.photoUrl?"none":f.c+"20"}},
            f.photoUrl?React.createElement("img",{src:f.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("span",{style:{fontSize:28}},f.i)),
          React.createElement("div",{style:{flex:1}},React.createElement("input",{className:"inp",value:f.n,onChange:function(e){set("n",e.target.value)},style:{fontWeight:600,border:"none",padding:0,background:"transparent"}})),
          f.photoUrl&&React.createElement("button",{onClick:function(){set("photoUrl",null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--dim)",fontSize:9,fontFamily:"var(--f)"}},"\u2715")),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:12}},
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Dial Color"),React.createElement("input",{className:"inp",value:f.d,onChange:function(e){set("d",e.target.value);if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:e.target.value,mc:autoMatchColors(e.target.value)})})}},style:{marginBottom:4}}),
            React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},["Black","White","Blue","Green","Silver","Grey","Champagne","Ivory"].map(function(dc){return React.createElement("span",{key:dc,onClick:function(){set("d",dc);set("c",(CM[dc.toLowerCase()]||{}).h||"#5a5a5a");if(IS_SHARED){setF(function(p){return Object.assign({},p,{d:dc,c:(CM[dc.toLowerCase()]||{}).h||"#5a5a5a",mc:autoMatchColors(dc)})})}},style:{fontSize:8,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,cursor:"pointer",background:f.d===dc?"rgba(201,168,76,0.2)":"var(--bg)",border:"1px solid "+(f.d===dc?"rgba(201,168,76,0.3)":"var(--border)"),color:f.d===dc?"var(--gold)":"var(--dim)"}},dc)}))),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Type"),React.createElement("select",{className:"sel",value:f.t,onChange:function(e){set("t",e.target.value)}},React.createElement("option",{value:"genuine"},"Genuine"),React.createElement("option",{value:"replica"},"Replica"))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Status"),React.createElement("select",{className:"sel",value:f.status,onChange:function(e){set("status",e.target.value)}},STS.map(function(s){return React.createElement("option",{key:s.id,value:s.id},s.l)}))),
          React.createElement("div",null,React.createElement("label",{className:"lbl"},"Case Size"),React.createElement("input",{className:"inp",value:f.size||"",onChange:function(e){set("size",e.target.value)},placeholder:"e.g. 40mm"})),
          !IS_SHARED&&React.createElement("div",null,React.createElement("label",{className:"lbl"},"Temp"),React.createElement("select",{className:"sel",value:f.mt,onChange:function(e){set("mt",e.target.value)}},React.createElement("option",{value:"cool"},"Cool"),React.createElement("option",{value:"warm"},"Warm"),React.createElement("option",{value:"mixed"},"Mixed")))),
        React.createElement("div",{style:{marginBottom:12}},
          React.createElement("label",{className:"lbl"},"Straps & Bracelets"),
          (f.straps||[]).map(function(st,si){
            var stDef=STRAP_TYPES.find(function(t){return t.id===st.type})||STRAP_TYPES[0];
            return React.createElement("div",{key:si,style:{display:"flex",gap:6,alignItems:"center",background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:4,border:"1px solid var(--border)"}},
              React.createElement("span",{style:{fontSize:14}},stDef.icon),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",minWidth:55,fontWeight:600}},stDef.l),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},st.material),
              st.type!=="bracelet"&&st.color&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},React.createElement(Dot,{color:st.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},st.color)),
              React.createElement("button",{onClick:function(){rmStrap(si)},style:{marginLeft:"auto",background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"3px 8px",cursor:"pointer",color:"var(--del-text)",fontSize:9,fontFamily:"var(--f)",minHeight:24}},"âœ•"))}),
          !addSt&&React.createElement("button",{onClick:function(){setAddSt(true)},style:{width:"100%",background:"var(--bg)",border:"1px dashed var(--border)",borderRadius:8,padding:"10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:11,marginTop:4,minHeight:36}},"+ Add Strap / Bracelet"),
          addSt&&React.createElement("div",{style:{background:"var(--bg)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:8,padding:10,marginTop:4}},
            React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
              STRAP_TYPES.map(function(st){return React.createElement("span",{key:st.id,className:"chip "+(nSt.type===st.id?"on":""),onClick:function(){setNStF("type",st.id)},style:{fontSize:10,padding:"4px 8px"}},st.icon+" "+st.l)})),
            React.createElement("div",{style:{display:"flex",gap:8,marginBottom:8}},
              nSt.type!=="bracelet"&&React.createElement("div",{style:{flex:1}},
                React.createElement("label",{className:"lbl",style:{fontSize:8,marginBottom:2}},"Color"),
                React.createElement("input",{className:"inp",value:nSt.color,onChange:function(e){setNSt(function(p){return Object.assign({},p,{color:e.target.value})})},placeholder:"brown, black...",style:{fontSize:10,padding:"6px 8px",marginBottom:4}}),
                React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},
                  STRAP_COLORS.map(function(c){return React.createElement("span",{key:c,onClick:function(){setNSt(function(p){return Object.assign({},p,{color:c})})},style:{fontSize:7,fontFamily:"var(--f)",padding:"2px 5px",borderRadius:3,cursor:"pointer",background:nSt.color===c?"rgba(201,168,76,0.2)":"transparent",border:"1px solid "+(nSt.color===c?"rgba(201,168,76,0.3)":"var(--border)"),color:nSt.color===c?"var(--gold)":"var(--dim)"}},c)}))),
              React.createElement("div",{style:{flex:1}},
                React.createElement("label",{className:"lbl",style:{fontSize:8,marginBottom:2}},"Material"),
                React.createElement("select",{className:"sel",value:nSt.material,onChange:function(e){setNSt(function(p){return Object.assign({},p,{material:e.target.value})})},style:{fontSize:10,padding:"6px 8px"}},
                  (STRAP_TYPES.find(function(t){return t.id===nSt.type})||{mats:[]}).mats.map(function(m){return React.createElement("option",{key:m,value:m},m)})))),
            React.createElement("div",{style:{display:"flex",gap:6}},
              React.createElement("button",{onClick:addStrap,style:{flex:1,background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:6,padding:"8px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"+  Add"),
              React.createElement("button",{onClick:function(){setAddSt(false)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"8px 14px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:32}},"Cancel")))),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Match Colors"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,maxHeight:100,overflowY:"auto",marginBottom:12}},AC.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.mc||[]).includes(c)?"on":""),onClick:function(){togArr("mc",c)}},React.createElement(Dot,{color:c,size:6}),c)})),
        React.createElement("label",{className:"lbl"},"Contexts"),
        React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:4,marginBottom:12}},activeCxIds.map(function(c){return React.createElement("span",{key:c,className:"chip "+((f.cx||[]).includes(c)?"on":""),onClick:function(){togArr("cx",c)}},(activeCxIcons[c]||"")+" "+c)})),
        !IS_SHARED&&React.createElement("label",{className:"lbl"},"Weather"),
        !IS_SHARED&&React.createElement("div",{style:{display:"flex",gap:6,marginBottom:12}},"light,mid,heavy".split(",").map(function(x){return React.createElement("span",{key:x,className:"chip "+((f.wt||[]).includes(x)?"on":""),onClick:function(){togArr("wt",x)},style:{flex:1,justifyContent:"center"}},(x==="light"?"â˜€ï¸":x==="mid"?"ðŸŒ¤ï¸":"ðŸ§¥")+" "+x)})),
        React.createElement("label",{className:"lbl"},"Emoji"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:14}},EMOJIS.map(function(e){return React.createElement("span",{key:e,onClick:function(){set("i",e)},style:{fontSize:22,cursor:"pointer",opacity:f.i===e?1:0.25,padding:3,minWidth:30,textAlign:"center"}},e)})),
        React.createElement("div",{style:{display:"flex",gap:8}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){var sv=Object.assign({},f);if(sv.straps&&sv.straps.length){sv.br=sv.straps.some(function(s){return s.type==="bracelet"});sv.sc=sv.straps.filter(function(s){return s.type!=="bracelet"}).map(function(s){return s.color})}if(IS_SHARED&&(!sv.mc||!sv.mc.length))sv.mc=autoMatchColors(sv.d);updateW(w.id,sv);setEditW(null)}},"Save"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 20px"},onClick:function(){if(confirm("Delete watch?")){removeW(w.id);setEditW(null)}}},"ðŸ—‘ï¸")));
    };
    return React.createElement(WE,{key:w.id});
  }

  /* â•â•â• ONBOARDING (shared version only) â•â•â• */
  if(!onboarded){
    var obDotStyle=function(s){return{width:8,height:8,borderRadius:"50%",background:onboardStep>=s?"var(--gold)":"var(--border)"}};
    var obFinish=function(){
      var nw=obWatches.map(function(pw){return migrateStraps(Object.assign({},pw,{id:pw.id+"-"+Date.now()+Math.random().toString(36).slice(2,5),active:true,status:"active",t:"genuine"}))});
      var ng=obGarments.map(function(pg){var sd=smartDefaults(pg);return Object.assign({},sd,pg,{id:"g-"+Date.now()+Math.random().toString(36).slice(2,5),ts:Date.now()})});
      if(nw.length){setW(nw);ps("w_"+SK,nw)}
      if(ng.length){setWd(ng);ps("wd_"+SK,ng)}
      setOnboarded(true);ps("wa_onboarded",true);
    };
    /* Step 1: Watches */
    if(onboardStep===1){
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"âŒš"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Watches"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap to add watches you own. You can customize later."),
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,width:"100%",maxWidth:340,marginBottom:16}},
          WATCH_PRESETS.map(function(wp){
            var sel=obWatches.some(function(o){return o.id===wp.id});
            return React.createElement("button",{key:wp.id,onClick:function(){setObWatches(function(prev){return sel?prev.filter(function(o){return o.id!==wp.id}):prev.concat([wp])})},
              style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",borderRadius:10,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",textAlign:"left"}},
              React.createElement("span",{style:{fontSize:20}},wp.i),
              React.createElement("div",null,
                React.createElement("div",{style:{fontSize:12,fontWeight:600,color:"var(--tx)"}},wp.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},wp.d+" dial")))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340}},
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(2)}},obWatches.length?"Next ("+obWatches.length+" selected)":"Skip"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px",fontSize:11},onClick:function(){
            var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){
              var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){
                try{var d=JSON.parse(r.result);if(d.watches){var mw=d.watches.map(migrateStraps);setW(mw);ps("w_"+SK,mw)}if(d.wardrobe){setWd(d.wardrobe);ps("wd_"+SK,d.wardrobe)}if(d.outfits){setSaved(d.outfits);ps("of_"+SK,d.outfits)}if(d.wearLog){setWearLog(d.wearLog);ps("wa_wearlog_"+SK,d.wearLog)}if(d.weekCtx&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}setOnboarded(true);ps("wa_onboarded",true)}catch(ex){alert("Invalid file")}};r.readAsText(f)};inp.click()
          }},"ðŸ“¥ Import")));
    }
    /* Step 2: Closet */
    if(onboardStep===2){
      var gTypes=["Tops","Bottoms","Shoes"];
      var gGroups={Tops:GARMENT_PRESETS.filter(function(g){return["Shirt","T-Shirt","Polo","Sweater/Knit"].includes(g.garmentType)}),Bottoms:GARMENT_PRESETS.filter(function(g){return["Chinos","Jeans","Shorts","Pants/Trousers"].includes(g.garmentType)}),Shoes:GARMENT_PRESETS.filter(function(g){return g.garmentType==="Shoes"})};
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"ðŸ‘”"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Closet"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Tap garments you own. You can add photos and more items later."),
        gTypes.map(function(gt){return React.createElement("div",{key:gt,style:{width:"100%",maxWidth:340,marginBottom:12}},
          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)",marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}},gt),
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:6}},
            gGroups[gt].map(function(gp){
              var gKey=gp.garmentType+"-"+gp.color;
              var sel=obGarments.some(function(o){return o.garmentType===gp.garmentType&&o.color===gp.color});
              return React.createElement("button",{key:gKey,onClick:function(){setObGarments(function(prev){return sel?prev.filter(function(o){return!(o.garmentType===gp.garmentType&&o.color===gp.color)}):prev.concat([gp])})},
                style:{padding:"6px 12px",borderRadius:20,border:sel?"2px solid var(--gold)":"1px solid var(--border)",background:sel?"rgba(183,139,67,0.08)":"var(--card)",cursor:"pointer",fontSize:11,fontFamily:"var(--f)",color:sel?"var(--gold)":"var(--tx)"}},gp.name)
            })))}),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:8}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(1)}},"â† Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){setOnboardStep(3)}},obGarments.length?"Next ("+obGarments.length+" items)":"Skip")));
    }
    /* Step 3: Week context */
    if(onboardStep===3){
      var ctxNames=activeCxIds.length?activeCxIds:["casual","clinic","smart-casual","formal","weekend","travel","date","riviera"];
      var dayNames=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      return React.createElement("div",{className:"onboard",style:{paddingBottom:32}},
        React.createElement("div",{style:{display:"flex",gap:6,marginBottom:20}},React.createElement("div",{style:obDotStyle(1)}),React.createElement("div",{style:obDotStyle(2)}),React.createElement("div",{style:obDotStyle(3)})),
        React.createElement("div",{style:{fontSize:36,marginBottom:8}},"ðŸ“…"),
        React.createElement("h2",{style:{fontSize:16,fontWeight:600,marginBottom:4}},"Your Week"),
        React.createElement("p",{style:{fontFamily:"var(--f)",color:"var(--sub)",fontSize:11,maxWidth:300,lineHeight:1.5,marginBottom:16}},"Set the vibe for each day. This helps match outfits to your schedule."),
        React.createElement("div",{style:{width:"100%",maxWidth:340}},
          dayNames.map(function(dn,di){
            return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{width:32,fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--sub)"}},dn),
              React.createElement("select",{value:weekCtx[di],onChange:function(e){setWeekCtx(function(p){var n=p.slice();n[di]=e.target.value;return n})},
                style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border)",background:"var(--card)",color:"var(--tx)",fontFamily:"var(--f)",fontSize:12}},
                ctxNames.map(function(cx){return React.createElement("option",{key:cx,value:cx},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})))
          })),
        React.createElement("div",{style:{display:"flex",gap:8,width:"100%",maxWidth:340,marginTop:12}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"12px 14px"},onClick:function(){setOnboardStep(2)}},"â† Back"),
          React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_weekctx",weekCtx);obFinish()}},"âœ¨ Start Pairing")));
    }
  }

  /* â•â•â• RENDER â•â•â• */
  return React.createElement("div",{style:{minHeight:"100vh"},onDragOver:function(e){e.preventDefault()},onDrop:function(e){e.preventDefault();if(view==="wardrobe")processFiles(e.dataTransfer.files)}},
    editG&&renderGarmentEdit(editG),
    editW&&renderWatchEdit(editW),
    addG&&renderQuickAdd(),
    /* Duplicate Detection Modal */
    showDupes&&React.createElement(Modal,{onClose:function(){setShowDupes(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"ðŸ” Duplicate Detection"),
      React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:14}},"Items with matching type + color that might be duplicates. Review each group and delete extras."),
      dupeGroups.length===0?React.createElement("div",{style:{textAlign:"center",padding:30}},
        React.createElement("span",{style:{fontSize:28}},"âœ…"),
        React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--good)",marginTop:8}},"No duplicates found!"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},"All "+wd.length+" items are unique."))
      :React.createElement("div",null,
        React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",borderRadius:8,padding:"8px 12px",marginBottom:14,border:"1px solid rgba(200,90,58,0.2)"}},
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},dupeGroups.length+" potential duplicate group"+(dupeGroups.length>1?"s":"")+" found")),
        dupeGroups.map(function(group,gi){
          return React.createElement("div",{key:gi,style:{background:"var(--bg)",borderRadius:12,padding:"14px",marginBottom:12,border:"1px solid var(--border)"}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement(Dot,{color:group[0].color,size:12}),
              React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},group[0].garmentType+" â€” "+group[0].color),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",background:"rgba(200,90,58,0.1)",borderRadius:4,padding:"2px 6px"}},group.length+" items")),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat("+Math.min(group.length,3)+",1fr)",gap:10}},
              group.map(function(item){
                return React.createElement("div",{key:item.id,style:{background:"var(--card)",borderRadius:10,overflow:"hidden",border:"1px solid var(--border)"}},
                  item.photoUrl?React.createElement("img",{src:item.photoUrl,alt:"",onClick:function(e){e.stopPropagation();openLightbox(item.photoUrl,item.id)},style:{width:"100%",height:140,objectFit:"cover",display:"block",cursor:"zoom-in"}}):React.createElement("div",{style:{width:"100%",height:100,background:(CM[item.color]||{}).h||"#3a3a3a",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement(Dot,{color:item.color,size:30})),
                  React.createElement("div",{style:{padding:"8px 10px"}},
                    React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:500,marginBottom:2}},item.name||item.color),
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:2}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" Â· "+item.pattern:"")+(item.material?" Â· "+item.material:"")),
                    item.lastWorn&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:4}},"Last worn: "+new Date(item.lastWorn).toLocaleDateString()),
                    React.createElement("button",{onClick:function(){if(confirm("Delete \""+( item.name||item.color)+"\"?")){rmG(item.id);setDupeGroups(function(prev){return prev.map(function(g){return g.filter(function(x){return x.id!==item.id})}).filter(function(g){return g.length>=2})})}},style:{width:"100%",background:"rgba(200,90,58,0.1)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:28}},"ðŸ—‘ï¸ Delete")))})));
        }))),
    /* Lightbox Modal */
    lightboxSrc&&React.createElement("div",{onClick:function(){setLightboxSrc(null);setLightboxItems([])},style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.95)",zIndex:200,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",animation:"fadeIn .15s ease",cursor:"pointer",padding:16}},
      React.createElement("button",{onClick:function(){setLightboxSrc(null);setLightboxItems([])},style:{position:"absolute",top:16,right:16,background:"none",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"50%",width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",fontSize:18,zIndex:201}},"âœ•"),
      React.createElement("img",{src:lightboxSrc,alt:"",style:{maxWidth:"92vw",maxHeight:lightboxItems.length>1?"60vh":"85vh",objectFit:"contain",borderRadius:8,boxShadow:"0 8px 32px rgba(0,0,0,0.5)"},onClick:function(e){e.stopPropagation()}}),
      lightboxItems.length>0&&React.createElement("div",{onClick:function(e){e.stopPropagation()},style:{display:"flex",gap:8,flexWrap:"wrap",justifyContent:"center",marginTop:12,maxWidth:"92vw"}},
        lightboxItems.map(function(item){
          return React.createElement("div",{key:item.id,onClick:function(){setLightboxSrc(null);setLightboxItems([]);setEditG(item)},style:{display:"flex",alignItems:"center",gap:6,background:"rgba(255,255,255,0.08)",backdropFilter:"blur(8px)",borderRadius:10,padding:"8px 14px",border:"1px solid rgba(255,255,255,0.12)",cursor:"pointer",transition:"background .15s"}},
            React.createElement("div",{style:{width:14,height:14,borderRadius:"50%",background:(CM[item.color]||{}).h||"#5a5a5a",border:"1px solid rgba(255,255,255,0.2)",flexShrink:0}}),
            React.createElement("div",{style:{flex:1}},
              React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",color:"#fff",fontWeight:600}},item.name||item.color),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"rgba(255,255,255,0.5)"}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" Â· "+item.pattern:"")+(item.material?" Â· "+item.material:""))),
            React.createElement("span",{style:{fontSize:11,color:"rgba(255,255,255,0.4)",marginLeft:4}},"âœï¸"),
            item.positionHint&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"rgba(255,255,255,0.35)",marginLeft:4}},"ðŸ“¸ "+item.positionHint))}))),

    showWDupes&&React.createElement(Modal,{onClose:function(){setShowWDupes(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"ðŸ” Watch Duplicates"),
      React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:14}},"Watches with matching names, dials, or similar identifiers. Review and delete extras."),
      wDupeGroups.length===0?React.createElement("div",{style:{textAlign:"center",padding:30}},
        React.createElement("span",{style:{fontSize:28}},"âœ…"),
        React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--good)",marginTop:8}},"No duplicate watches found!"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},W.length+" watches are all unique."))
      :React.createElement("div",null,
        React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",borderRadius:8,padding:"8px 12px",marginBottom:14,border:"1px solid rgba(200,90,58,0.2)"}},
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},wDupeGroups.length+" potential duplicate group"+(wDupeGroups.length>1?"s":"")+" found")),
        wDupeGroups.map(function(group,gi){
          return React.createElement("div",{key:gi,style:{background:"var(--bg)",borderRadius:12,padding:"14px",marginBottom:12,border:"1px solid var(--border)"}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement("span",{style:{fontSize:16}},group[0].i||"âŒš"),
              React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},group[0].t.toUpperCase()+" â€” "+group[0].d+" dial"),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",background:"rgba(200,90,58,0.1)",borderRadius:4,padding:"2px 6px"}},group.length+" watches")),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat("+Math.min(group.length,2)+",1fr)",gap:10}},
              group.map(function(w){
                return React.createElement("div",{key:w.id,style:{background:"var(--card)",borderRadius:10,padding:"12px",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
                    React.createElement("div",{style:{width:36,height:36,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:18,border:"2px solid "+w.c+"60"}},w.photoUrl?React.createElement("img",{src:w.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"50%"}}):w.i||"âŒš"),
                    React.createElement("div",{style:{flex:1}},
                      React.createElement("div",{style:{fontSize:12,fontWeight:600}},w.n),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},w.d+" Â· "+(w.ref||"no ref")+" Â· "+(w.size?w.size+"mm":"")+" Â· "+w.t),
                      w.status&&w.status!=="active"&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:w.status==="incoming"?"#7ab8d8":"var(--warn)",marginTop:2}},w.status))),
                  React.createElement("div",{style:{display:"flex",gap:6}},
                    React.createElement("button",{onClick:function(){setEditW(w);setShowWDupes(false)},style:{flex:1,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:28}},"âœï¸ Edit"),
                    React.createElement("button",{onClick:function(){if(confirm("Delete watch \""+w.n+"\"? This cannot be undone.")){removeW(w.id);setWDupeGroups(function(prev){return prev.map(function(g){return g.filter(function(x){return x.id!==w.id})}).filter(function(g){return g.length>=2})})}},style:{flex:1,background:"rgba(200,90,58,0.1)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"6px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,fontWeight:600,minHeight:28}},"ðŸ—‘ï¸ Delete")))}))),
          /* Bulk remove all non-first items */
          React.createElement("div",{style:{borderTop:"1px solid var(--border)",paddingTop:12,marginTop:8}},
            React.createElement("button",{onClick:function(){
              var toRemove=[];
              wDupeGroups.forEach(function(g){g.slice(1).forEach(function(w){toRemove.push(w.id)})});
              if(!toRemove.length)return;
              if(confirm("Delete "+toRemove.length+" duplicate watch"+(toRemove.length>1?"es":"")+"? This keeps the first watch from each group.")){
                setW(function(p){var n=p.filter(function(w){return!toRemove.includes(w.id)});ps("w_"+SK,n);return n});
                setWDupeGroups([]);
              }},style:{width:"100%",background:"rgba(200,90,58,0.12)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:8,padding:"10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"ðŸ—‘ï¸ Remove All Duplicates (keep first of each group)"))}))),
        showSettings&&React.createElement(Modal,{onClose:function(){setShowSettings(false)}},
      React.createElement("h2",{style:{fontSize:18,fontWeight:600,marginBottom:6}},"âš™ï¸ Settings"),
      React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:16}},"AI photo classification works automatically inside Claude.ai. To use it in a standalone browser, add your Anthropic API key below."),
      React.createElement("label",{className:"lbl"},"Anthropic API Key"),
      React.createElement("input",{className:"inp",type:"password",value:apiKey,onChange:function(e){setApiKey(e.target.value);apiKeyRef.current=e.target.value},placeholder:"sk-ant-...",style:{marginBottom:12,fontFamily:"monospace"}}),
      React.createElement("div",{style:{display:"flex",gap:8,marginBottom:16}},
        React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){ps("wa_apikey",apiKey);apiKeyRef.current=apiKey;setShowSettings(false)}},"ðŸ’¾ Save Key"),
        apiKey&&React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setApiKey("");apiKeyRef.current="";ps("wa_apikey","")}},"Clear")),
      React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",border:"1px solid var(--border)"}},
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"â„¹ï¸ Get your key at console.anthropic.com â†’ API Keys"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 6px"}},"Cost: ~$0.01 per photo (Sonnet vision)"),
        React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:apiKey?"var(--good)":"var(--warn)",margin:0,fontWeight:500}},apiKey?"âœ“ Key configured â€” AI classification active":"âœ— No key â€” manual classification only outside Claude.ai")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Context Categories"),
        React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginTop:6,marginBottom:8}},
          activeCx.map(function(c){return React.createElement("span",{key:c.id,className:"chip on",style:{gap:6}},c.icon+" "+c.l,
            React.createElement("span",{onClick:function(e){e.stopPropagation();var n=activeCx.filter(function(x){return x.id!==c.id});if(n.length<2)return;setUserCx(n);ps("wa_usercx_"+SK,n)},style:{cursor:"pointer",color:"var(--warn)",fontSize:10,marginLeft:2}},"âœ•"))})),
        React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8}},
          React.createElement("input",{id:"newCxName",className:"inp",placeholder:"New context name",style:{flex:1,fontSize:11,padding:"6px 10px"}}),
          React.createElement("input",{id:"newCxIcon",className:"inp",placeholder:"Emoji",style:{width:50,fontSize:14,textAlign:"center",padding:"6px"}}),
          React.createElement("button",{onClick:function(){var nameEl=document.getElementById("newCxName");var iconEl=document.getElementById("newCxIcon");var nm=(nameEl?nameEl.value:"").trim();var ic=(iconEl?iconEl.value:"").trim()||"ðŸ“Œ";if(!nm)return;var nid=nm.toLowerCase().replace(/\s+/g,"-");var n=(userCx||activeCx).concat([{id:nid,l:nm,icon:ic}]);setUserCx(n);ps("wa_usercx_"+SK,n);if(nameEl)nameEl.value="";if(iconEl)iconEl.value=""},style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontFamily:"var(--f)",fontSize:11,fontWeight:600}},"+Add")),
        React.createElement("button",{onClick:function(){setUserCx(null);ps("wa_usercx_"+SK,null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"6px 12px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,marginBottom:8}},"Reset to Defaults")),
      React.createElement("div",{style:{marginTop:16,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"ðŸ” Recovery Credentials"),
        React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",marginBottom:8}},"Set a username + password to encrypt your backups. You'll need these to restore on a new device."),
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:6}},
          React.createElement("input",{className:"inp",type:"text",value:recUser,onChange:function(e){setRecUser(e.target.value)},placeholder:"Username",style:{flex:1,fontSize:11,padding:"8px 12px"}}),
          React.createElement("input",{className:"inp",type:"password",value:recPass,onChange:function(e){setRecPass(e.target.value)},placeholder:"Password",style:{flex:1,fontSize:11,padding:"8px 12px"}})),
        React.createElement("div",{style:{display:"flex",gap:8,marginBottom:8}},
          React.createElement("button",{onClick:function(){if(!recUser.trim()||!recPass.trim()){alert("Enter both username and password.");return}localStorage.setItem("wa_rec_user",recUser);localStorage.setItem("wa_rec_pass",recPass);setRecStatus("saved");setTimeout(function(){setRecStatus("")},2500)},style:{flex:1,background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"ðŸ’¾ Save Credentials"),
          React.createElement("button",{onClick:async function(){
            if(!recUser.trim()||!recPass.trim()){alert("Enter username and password first.");return}
            setRecStatus("encrypting...");
            try{
              var data=JSON.stringify({version:"v22",user:recUser.trim(),ts:Date.now(),watches:W,wardrobe:wd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,rotLock:rotLock,selfieHistory:selfieHistory,theme:theme});
              var encrypted=await encryptData(data,recUser.trim()+"::"+recPass.trim());
              var blob=new Blob([encrypted],{type:"application/octet-stream"});
              var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="watch-advisor-"+recUser.trim()+".wabackup";a.click();
              setRecStatus("exported \u2713");setTimeout(function(){setRecStatus("")},3000);
            }catch(e){setRecStatus("error: "+e.message);setTimeout(function(){setRecStatus("")},4000)}
          },style:{flex:1,background:"rgba(122,184,216,0.08)",border:"1px solid rgba(122,184,216,0.25)",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--info)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"ðŸ“¤ Encrypted Export"),
          React.createElement("button",{onClick:function(){
            if(!recPass.trim()){alert("Enter your password to decrypt the backup.");return}
            var inp=document.createElement("input");inp.type="file";inp.accept=".wabackup";inp.onchange=async function(e){
              var f=e.target.files[0];if(!f)return;
              setRecStatus("decrypting...");
              try{
                var buf=await f.arrayBuffer();
                var packed=new Uint8Array(buf);
                var json=await decryptData(packed,((recUser||"").trim()||f.name.replace("watch-advisor-","").replace(".wabackup",""))+"::"+recPass.trim());
                var d=JSON.parse(json);
                var imported=[];
                if(d.watches&&Array.isArray(d.watches)){var valid=d.watches.filter(function(w){return w&&w.id&&w.n});if(valid.length){var mw=valid.map(migrateStraps);setW(mw);ps("w_"+SK,mw);imported.push(valid.length+" watches")}}
                if(d.wardrobe&&Array.isArray(d.wardrobe)){var vwd=d.wardrobe.filter(function(i){return i&&i.id});if(vwd.length){setWd(vwd);ps("wd_"+SK,vwd);imported.push(vwd.length+" wardrobe items")}}
                if(d.outfits&&Array.isArray(d.outfits)){setSaved(d.outfits);ps("of_"+SK,d.outfits);imported.push(d.outfits.length+" outfits")}
                if(d.wearLog&&Array.isArray(d.wearLog)){var vwl=d.wearLog.filter(function(e2){return e2&&e2.date&&e2.watchId});setWearLog(vwl);ps("wa_wearlog_"+SK,vwl);imported.push(vwl.length+" wear logs")}
                if(d.weekCtx&&Array.isArray(d.weekCtx)&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}
                if(d.userCx&&Array.isArray(d.userCx)){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}
                if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}
                if(d.selfieHistory&&Array.isArray(d.selfieHistory)){setSelfieHistory(d.selfieHistory);ps("wa_selfie_"+SK,d.selfieHistory);imported.push(d.selfieHistory.length+" selfies")}
                if(d.theme){setTheme(d.theme);ps("wa_theme",d.theme)}
                setRecStatus("restored \u2713");alert("\u2705 Restored: "+imported.join(", "));setTimeout(function(){setRecStatus("")},4000);
              }catch(err){
                setRecStatus("");
                if(err.name==="OperationError")alert("\u274c Wrong password or username. Decryption failed.");
                else alert("Error: "+err.message);
              }
            };inp.click();
          },style:{flex:1,background:"rgba(122,184,122,0.08)",border:"1px solid rgba(122,184,122,0.25)",borderRadius:8,padding:"8px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:32}},"ðŸ“¥ Restore .wabackup")),
        recStatus&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:recStatus.includes("error")?"var(--warn)":recStatus.includes("\u2713")?"var(--good)":"var(--info)",marginBottom:6,fontWeight:500}},recStatus),
        React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:16,border:"1px solid var(--border)"}},
          React.createElement("p",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",margin:0}},"AES-256-GCM encryption Â· PBKDF2 310K iterations Â· Your password never leaves this device Â· .wabackup files are unreadable without your credentials"))),
      React.createElement("div",{style:{marginTop:0,paddingTop:12,borderTop:"1px solid var(--border)"}},
        React.createElement("label",{className:"lbl"},"Data Management"),
        React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:6}},
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var data=JSON.stringify({version:"v22",watches:W,wardrobe:wd,outfits:saved,wearLog:wearLog,weekCtx:weekCtx,userCx:userCx,rotLock:rotLock,selfieHistory:selfieHistory,theme:theme});var blob=new Blob([data],{type:"application/json"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="watch-advisor-backup.json";a.click()}},"ðŸ“¤ Export"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{var d=JSON.parse(r.result);if(typeof d!=="object"||d===null||Array.isArray(d)){alert("Invalid backup file: expected JSON object");return}var imported=[];if(d.watches&&Array.isArray(d.watches)){var valid=d.watches.filter(function(w){return w&&typeof w==="object"&&w.id&&w.n});if(valid.length){var mw=valid.map(migrateStraps);setW(mw);ps("w_"+SK,mw);imported.push(valid.length+" watches")}}if(d.wardrobe&&Array.isArray(d.wardrobe)){var vwd=d.wardrobe.filter(function(i){return i&&typeof i==="object"&&i.id});if(vwd.length){setWd(vwd);ps("wd_"+SK,vwd);imported.push(vwd.length+" wardrobe items")}}if(d.outfits&&Array.isArray(d.outfits)){setSaved(d.outfits);ps("of_"+SK,d.outfits);imported.push(d.outfits.length+" outfits")}if(d.wearLog&&Array.isArray(d.wearLog)){var vwl=d.wearLog.filter(function(e){return e&&e.date&&e.watchId});setWearLog(vwl);ps("wa_wearlog_"+SK,vwl);imported.push(vwl.length+" wear logs")}if(d.weekCtx&&Array.isArray(d.weekCtx)&&d.weekCtx.length===7){setWeekCtx(d.weekCtx);ps("wa_weekctx",d.weekCtx)}if(d.userCx&&Array.isArray(d.userCx)&&d.userCx.length){setUserCx(d.userCx);ps("wa_usercx_"+SK,d.userCx)}if(d.rotLock&&Array.isArray(d.rotLock)){setRotLock(d.rotLock);ps("wa_rotlock_"+SK,d.rotLock)}if(d.selfieHistory&&Array.isArray(d.selfieHistory)){setSelfieHistory(d.selfieHistory);ps("wa_selfie_"+SK,d.selfieHistory);imported.push(d.selfieHistory.length+" selfie checks")}if(d.theme&&(d.theme==="dark"||d.theme==="light")){setTheme(d.theme);ps("wa_theme",d.theme)}alert(imported.length?"Imported: "+imported.join(", "):"No valid data found in file")}catch(e){alert("Invalid file: "+String(e.message||e).slice(0,100))}};r.readAsText(f)};inp.click()}},"ðŸ“¥ Import"),
          React.createElement("button",{className:"btn btn-ghost",style:{flex:1,fontSize:11,padding:"10px 14px",minHeight:40},onClick:function(){var inp=document.createElement("input");inp.type="file";inp.accept=".md,.txt";inp.onchange=function(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(){try{var parsed=parseWatchLog(r.result,W);if(parsed&&parsed.length){setW(parsed);ps("w_"+SK,parsed);alert("Imported "+parsed.length+" watches from markdown!")}else{alert("No watches found in file.")}}catch(ex){console.error(ex);alert("Parse error: "+ex.message)}};r.readAsText(f)};inp.click()}},"ðŸ“„ Import .md")))),

    /* Floating Save Button */
    React.createElement("button",{onClick:saveAll,style:{position:"fixed",bottom:24,right:20,zIndex:90,width:52,height:52,borderRadius:"50%",background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",boxShadow:"0 4px 16px rgba(201,168,76,0.35)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,color:"var(--bg)",transition:"transform .15s",touchAction:"manipulation"},onTouchStart:function(e){e.currentTarget.style.transform="scale(0.9)"},onTouchEnd:function(e){e.currentTarget.style.transform="scale(1)"}},"ðŸ’¾"),
    /* Save Toast */
    showSaveToast&&React.createElement("div",{className:"fu",style:{position:"fixed",bottom:84,right:16,zIndex:91,background:"rgba(122,184,122,0.95)",color:"#fff",borderRadius:10,padding:"10px 18px",fontFamily:"var(--f)",fontSize:12,fontWeight:600,boxShadow:"0 4px 16px rgba(0,0,0,0.3)"}},"âœ“ All changes saved!"),

    /* HEADER */
    React.createElement("div",{style:{background:theme==="light"?"linear-gradient(180deg,#f0efe8,var(--bg))":"linear-gradient(180deg,var(--card),var(--bg))",borderBottom:"1px solid var(--border)",padding:"max(env(safe-area-inset-top,12px),12px) 16px 0"}},
      React.createElement("div",{style:{maxWidth:860,margin:"0 auto"}},
        React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},
          React.createElement("h1",{style:{fontSize:20,fontWeight:300,letterSpacing:"0.14em",color:"var(--gold)"}},"WATCH ADVISOR"),
          React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center"}},
            React.createElement("button",{className:"theme-toggle",onClick:function(){var nt=theme==="dark"?"light":"dark";setTheme(nt);ps("wa_theme",nt)},title:theme==="dark"?"Switch to Day mode":"Switch to Night mode"},theme==="dark"?"â˜€ï¸":"ðŸŒ™"),
            React.createElement("button",{onClick:function(){setShowSettings(true)},style:{background:"none",border:"1px solid "+(apiKey?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:8,padding:"6px 10px",cursor:"pointer",color:apiKey?"var(--good)":"var(--dim)",fontSize:14,minHeight:32}},apiKey?"ðŸ”‘":"âš™ï¸"))),
        React.createElement("div",{style:{display:"flex",gap:0,marginTop:6},className:"hscroll"},
          [{id:"wardrobe",l:"ðŸ‘• CLOSET",c:wd.length},{id:"fits",l:"âœ¨ FITS",c:0},{id:"insights",l:"ðŸ”® INSIGHTS",c:0},{id:"watches",l:"âŒš WATCHES",c:actW.length},{id:"saved",l:"ðŸ’¾ SAVED",c:saved.length}].map(function(t){
            return React.createElement("button",{key:t.id,onClick:function(){setView(t.id);setSelFit(null)},style:{background:"none",border:"none",borderBottom:view===t.id?"2px solid var(--gold)":"2px solid transparent",color:view===t.id?"var(--gold)":"var(--dim)",padding:"10px 14px",fontFamily:"var(--f)",fontSize:10,fontWeight:500,letterSpacing:"0.1em",cursor:"pointer",whiteSpace:"nowrap",flexShrink:0,minHeight:40}},
              t.l+(t.c>0?" "+t.c:""))})),
        React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"right",marginTop:2,paddingBottom:2}},"v22"))),

    React.createElement("div",{style:{maxWidth:860,margin:"0 auto",padding:"0 16px"}},

      /* â•â•â• WARDROBE â•â•â• */
      view==="wardrobe"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        wxErr&&!weather&&React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",border:"1px solid rgba(200,90,58,0.25)",borderRadius:12,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",gap:10}},
          React.createElement("span",{style:{fontSize:18}},"âš ï¸"),
          React.createElement("div",null,
            React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"Weather unavailable"),
            React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},"Scoring defaults to mid-weight. Enable location or check connection.")),
          React.createElement("button",{onClick:function(){setWxErr(false);if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(p){setLoc({lat:p.coords.latitude,lon:p.coords.longitude,name:"Your Location"})},function(){},{timeout:5000})},style:{background:"none",border:"1px solid rgba(200,90,58,0.3)",borderRadius:8,padding:"6px 12px",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",whiteSpace:"nowrap"}},"Retry")),
        weather&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid "+(planWx&&planWx.rain?"rgba(100,150,220,0.4)":"var(--border)"),borderRadius:12,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"}},
          React.createElement("span",{style:{fontSize:22}},planWx&&planWx.cond?planWx.cond.i:tier?tier.icon:""),
          React.createElement("div",null,React.createElement("div",{style:{fontSize:18,fontWeight:600,fontFamily:"var(--f)"}},planTemp?planTemp.temp+"Â°C":weather.temp+"Â°C"),React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Feels "+(planTemp?planTemp.feels:weather.feels)+"Â°C Â· "+loc.name+(planDay>0&&forecast[planDay]?" Â· "+forecast[planDay].date:""))),
          React.createElement("div",{style:{flex:1,minWidth:100}},
            React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},planWx&&planWx.cond?planWx.cond.l:tier?tier.label:""),
            React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},tier?tier.advice:"")),
          planWx&&React.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
            planWx.rainPct>0&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.rainPct>=50?"#7ab8d8":"var(--sub)",background:planWx.rainPct>=50?"rgba(100,150,220,0.1)":"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid "+(planWx.rainPct>=50?"rgba(100,150,220,0.25)":"var(--border)")}},"ðŸŒ§ï¸ "+planWx.rainPct+"%"),
            planWx.uv>=4&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.uv>=8?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"â˜€ï¸ UV "+planWx.uv),
            planWx.wind>=20&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:planWx.wind>=40?"var(--warn)":"var(--sub)",background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},"ðŸ’¨ "+planWx.wind+"km/h"))),

        React.createElement("input",{ref:fRef,type:"file",accept:"image/*",multiple:true,style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("input",{ref:cRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files.length){processFiles(e.target.files);e.target.value=""}}}),
        React.createElement("div",{style:{border:"2px dashed var(--border)",borderRadius:14,padding:"18px 16px",textAlign:"center",background:"var(--card)",marginBottom:14}},
          React.createElement("p",{style:{fontSize:18,margin:"0 0 4px"}},"ðŸ“¸"),
          React.createElement("p",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:500,margin:"0 0 10px"}},"Upload photos or add manually"),
          React.createElement("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}},
            React.createElement("button",{onClick:function(){if(fRef.current)fRef.current.click()},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",borderRadius:8,padding:"12px 18px",color:"var(--bg)",fontFamily:"var(--f)",fontSize:12,fontWeight:600,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center",border:"none"}},"ðŸ“ Upload"),
            React.createElement("button",{onClick:function(){if(cRef.current)cRef.current.click()},style:{background:"var(--card2)",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44,display:"flex",alignItems:"center"}},"ðŸ“· Camera"),
            React.createElement("button",{onClick:function(){setAddG(true)},style:{background:"var(--card2)",border:"1px solid var(--border)",borderRadius:8,padding:"12px 18px",color:"var(--sub)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",minHeight:44}},"âœï¸ Manual"))),

        proc.length>0&&React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginBottom:12}},proc.map(function(p){return React.createElement("div",{key:p,style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",display:"flex",alignItems:"center",gap:8}},React.createElement("div",{className:"sp",style:{width:14,height:14,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Identifying..."))})),

        wd.length>0&&React.createElement(React.Fragment,null,
          needsFix>0&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",margin:0,fontWeight:500,flex:1}},"âš ï¸ "+needsFix+" items need classification â€” tap to set type & color"),
              React.createElement("button",{onClick:async function(){
                var broken=wd.filter(function(i){return(i.needsEdit||!i.color)&&i.photoUrl});
                if(!broken.length)return;
                for(var k=0;k<broken.length;k++){
                  var it=broken[k];
                  try{var compressed=await compressImage(it.photoUrl,600,0.6);var b64=compressed.split(",")[1];
                    var aiResult=await aiID(b64,"image/jpeg",apiKeyRef.current);
                    if(aiResult&&aiResult.length)updG(it.id,aiResult[0]);else setAiErr(getLastAiError());
                  }catch(e){}
                  if(k<broken.length-1)await new Promise(function(r){setTimeout(r,800)});
                }
              },style:{background:"var(--gold)",color:"var(--bg)",border:"none",borderRadius:8,padding:"8px 14px",fontFamily:"var(--f)",fontSize:11,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",minHeight:36}},"ðŸ”„ Retry AI"))),
          aiErr&&React.createElement("div",{style:{background:"rgba(200,90,58,0.08)",border:"1px solid rgba(200,90,58,0.3)",borderRadius:10,padding:"10px 14px",marginBottom:10}},
            React.createElement("div",{style:{display:"flex",alignItems:"flex-start",gap:8}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",margin:0,flex:1,wordBreak:"break-all"}},"ðŸš¨ AI Error: "+aiErr),
              React.createElement("button",{onClick:function(){setAiErr("")},style:{background:"none",border:"none",color:"var(--warn)",cursor:"pointer",fontSize:14}},"âœ•"))),

          React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:10}},
            [{id:"all",l:"All "+wd.length},{id:"tops",l:"Tops "+byCat.tops.length},{id:"bottoms",l:"Btms "+byCat.bottoms.length},{id:"shoes",l:"Shoes "+byCat.shoes.length}].map(function(f){return React.createElement(Pill,{key:f.id,on:wFilt===f.id,onClick:function(){setWFilt(f.id);setWMatFilt("all")}},f.l)}),
            React.createElement("button",{onClick:function(){var dupes=findDuplicates();setDupeGroups(dupes);setShowDupes(true)},style:{background:"none",border:"1px solid rgba(201,168,76,0.3)",borderRadius:20,padding:"8px 14px",color:"var(--gold)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",minHeight:36,marginLeft:"auto"}},"ðŸ” Duplicates"),
            React.createElement("button",{onClick:function(){if(confirm("Clear all?")){saveWd([]);setWFilt("all")}},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:20,padding:"8px 14px",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:10,cursor:"pointer",minHeight:36}},"Clear")),
          /* Material quick-filter */
          (function(){var filteredForMats=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});var mc={};filteredForMats.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var mats=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,8);return mats.length>=2?React.createElement("div",{className:"hscroll",style:{display:"flex",gap:4,marginBottom:8,paddingBottom:2}},React.createElement(Pill,{on:wMatFilt==="all",onClick:function(){setWMatFilt("all")}},"All Materials"),mats.map(function(m){return React.createElement(Pill,{key:m[0],on:wMatFilt===m[0],onClick:function(){setWMatFilt(wMatFilt===m[0]?"all":m[0])}},m[0]+" Ã—"+m[1])})):null})(),

          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(105px,1fr))",gap:8}},
            (function(){var arr=wFilt==="all"?wd:wd.filter(function(i){return catOf(i.garmentType)===wFilt});if(wMatFilt!=="all")arr=arr.filter(function(i){return i.material===wMatFilt});return arr})().slice().sort(function(a,b){return(b.ts||0)-(a.ts||0)}).map(function(item){
              return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setEditG(item)},style:{background:item.needsEdit||!item.color?"var(--card2)":"var(--card)",border:"1px solid "+(item.needsEdit||!item.color?"rgba(201,168,76,0.3)":"var(--border)")}},
                item.photoUrl?React.createElement(React.Fragment,null,React.createElement("img",{src:item.photoUrl,alt:"",onClick:function(e){e.stopPropagation();openLightbox(item.photoUrl,item.id)},style:{width:"100%",height:90,objectFit:"cover",display:"block",cursor:"zoom-in"}}),React.createElement("div",{className:"gcard-overlay"})):React.createElement("div",{style:{width:"100%",height:60,background:(CM[item.color]||{}).h||"#2a2a2a",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"#fff8",textShadow:"0 1px 3px #000"}},item.color)),
                React.createElement("div",{style:{padding:"6px 8px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                    item.color&&React.createElement(Dot,{color:item.color,size:6}),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}},item.name||item.color||"Tap to classify")),
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},item.garmentType+(item.pattern&&item.pattern!=="solid"?" Â· "+item.pattern:""))),
                (item.needsEdit||!item.color)&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(201,168,76,0.9)",borderRadius:4,padding:"2px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--bg)",fontWeight:700}},"FIX")),
                item.positionHint&&React.createElement("div",{style:{position:"absolute",top:4,left:4,background:"rgba(0,0,0,0.7)",borderRadius:4,padding:"1px 5px"}},React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)"}},"ðŸ“¸ "+item.positionHint)),
                item.material&&React.createElement("div",{style:{position:"absolute",bottom:28,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:"#aaa"}},item.material)),
                item.lastWorn&&React.createElement("div",{style:{position:"absolute",bottom:28,left:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 4px"}},React.createElement("span",{style:{fontSize:6,fontFamily:"var(--f)",color:(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d<=2?"#e8a87c":d<=7?"#aaa":"#7a7"})()}},(function(){var d=Math.floor((Date.now()-new Date(item.lastWorn).getTime())/864e5);return d===0?"worn today":d===1?"1d ago":d+"d ago"})())),
                item.seasons&&item.seasons.length>0&&item.seasons.length<4&&React.createElement("div",{style:{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.6)",borderRadius:3,padding:"1px 3px"}},React.createElement("span",{style:{fontSize:6}},item.seasons.map(function(s){return{spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"}[s]||""}).join(""))))})),

          React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 14px",marginTop:12}},
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",margin:0}},byCat.tops.length+" tops Â· "+byCat.bottoms.length+" bottoms Â· "+byCat.shoes.length+" shoes"+(function(){var mc={};wd.forEach(function(i){if(i.material)mc[i.material]=(mc[i.material]||0)+1});var ms=Object.entries(mc).sort(function(a,b){return b[1]-a[1]}).slice(0,3);return ms.length?" Â· "+ms.map(function(e){return e[0]+" Ã—"+e[1]}).join(", "):""})()),
            (function(){var nfIds=new Set();saved.forEach(function(o){(o.items||[]).forEach(function(it){nfIds.add(it.id)})});var unused=wd.filter(function(i){return i.color&&!i.needsEdit&&!nfIds.has(i.id)}).length;return unused>0?React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",margin:"4px 0 0"}},"ðŸ’¤ "+unused+" item"+(unused!==1?"s":"")+" never saved in an outfit"):null})(),
            /* Freshness bar */
            (function(){var worn=wd.filter(function(i){return i.lastWorn});if(!worn.length)return null;var now=Date.now();var fresh=0,mid=0,stale=0;worn.forEach(function(i){var d=Math.floor((now-new Date(i.lastWorn).getTime())/864e5);if(d<=3)fresh++;else if(d<=14)mid++;else stale++});var total=fresh+mid+stale;return React.createElement("div",{style:{marginTop:6}},React.createElement("div",{style:{display:"flex",gap:8,fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:3}},React.createElement("span",null,"Rotation freshness:"),fresh>0&&React.createElement("span",{style:{color:"var(--good)"}},"ðŸŸ¢ "+fresh+" fresh"),mid>0&&React.createElement("span",{style:{color:"var(--gold)"}},"ðŸŸ¡ "+mid+" ok"),stale>0&&React.createElement("span",{style:{color:"var(--warn)"}},"ðŸ”´ "+stale+" stale")),React.createElement("div",{style:{height:3,borderRadius:2,background:"var(--bg)",overflow:"hidden",display:"flex"}},fresh>0&&React.createElement("div",{style:{width:fresh/total*100+"%",background:"var(--good)"}}),mid>0&&React.createElement("div",{style:{width:mid/total*100+"%",background:"var(--gold)"}}),stale>0&&React.createElement("div",{style:{width:stale/total*100+"%",background:"var(--warn)"}})))})()))),

      /* â•â•â• FITS â•â•â• */
      view==="fits"&&!selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* MODE CARDS */
        React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:12}},
          [{id:"auto",icon:"âœ¨",l:"Smart",d:"AI-scored"},{id:"build",icon:"ðŸ§©",l:"Create",d:"Build & save"},{id:"selfie",icon:"ðŸ“¸",l:"Selfie",d:"Check look"},{id:"rotation",icon:"ðŸ“…",l:"Week",d:"7-day plan"}].map(function(m){
            var on=mode===m.id;
            return React.createElement("button",{key:m.id,onClick:function(){setMode(m.id);if(m.id!=="auto"){setLockItem(null);setTopType("all")}},style:{background:on?"rgba(201,168,76,0.1)":"var(--card)",border:"1px solid "+(on?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:12,padding:"12px 8px",cursor:"pointer",textAlign:"center",transition:"all .15s"}},
              React.createElement("div",{style:{fontSize:20,marginBottom:2}},m.icon),
              React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:on?700:500,color:on?"var(--gold)":"var(--text)"}},m.l),
              React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:on?"var(--gold)":"var(--dim)",opacity:0.7}},m.d))})),

        /* DAY SELECTOR for Auto/Build */
        mode!=="rotation"&&mode!=="selfie"&&forecast.length>0&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              var t=getWT(fc.feelsAvg);var hasRain=fc.cond&&fc.cond.rain;
              return React.createElement("button",{key:i,onClick:function(){setPlanDay(i)},style:{flex:"0 0 auto",background:planDay===i?"rgba(201,168,76,0.15)":hasRain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(planDay===i?"rgba(201,168,76,0.4)":hasRain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"8px 10px",cursor:"pointer",minWidth:68,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--gold)":"var(--sub)",fontWeight:planDay===i?700:400}},i===0?"Today":i===1?"Tmrw":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:t?t.icon:""),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:planDay===i?"var(--text)":"var(--dim)",fontWeight:600}},fc.high+"Â°/"+fc.low+"Â°"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)",fontWeight:fc.rainPct>=50?600:400}},"ðŸ’§"+fc.rainPct+"%"),
                fc.wind>=25&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},"ðŸ’¨"+fc.wind))}))),

        /* CONTEXT + CONTROLS ROW */
        mode!=="rotation"&&mode!=="selfie"&&React.createElement("div",{style:{marginBottom:10}},
          React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:5,marginBottom:8}},
            planDay>0&&JSON.stringify(effectiveCtx)!==JSON.stringify(ctx)&&React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",alignSelf:"center",marginRight:4}},"ðŸ“… "+(activeCxIcons[primaryCtx]||CXI[primaryCtx]||"")+primaryCtx),
            CTXS.map(function(c){return React.createElement(Pill,{key:c.id,on:Array.isArray(ctx)?ctx.includes(c.id):ctx===c.id,onClick:function(){setCtx(function(prev){var arr=Array.isArray(prev)?prev:[prev];if(arr.includes(c.id)){var f=arr.filter(function(x){return x!==c.id});return f.length?f:["smart-casual"]}return arr.concat([c.id])});if(planDay>0)setPlanDay(0)}},c.l)}),
            !IS_SHARED&&React.createElement("button",{onClick:function(){setReps(!reps)},style:{background:reps?"rgba(201,168,76,0.08)":"var(--card)",border:"1px solid "+(reps?"rgba(201,168,76,0.25)":"var(--border)"),borderRadius:20,padding:"8px 14px",cursor:"pointer",marginLeft:"auto",color:reps?"var(--gold)":"var(--dim)",fontFamily:"var(--f)",fontSize:11,minHeight:36}},reps?"Rep ON":"Rep OFF"))),

        /* AUTO-SPECIFIC FILTERS */
        mode==="auto"&&React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center",marginBottom:10}},
          /* Top type filter */
          [{id:"all",l:"All Tops"},{id:"Shirt",l:"ðŸ‘” Shirts"},{id:"Polo",l:"ðŸ‡ Polos"},{id:"T-Shirt",l:"ðŸ‘• Tees"},{id:"Sweater/Knit",l:"ðŸ§¶ Knits"},{id:"Jacket/Blazer",l:"ðŸ§¥ Jackets"}].map(function(tf){
            return React.createElement("span",{key:tf.id,className:"chip "+(topType===tf.id?"on":""),onClick:function(){setTopType(topType===tf.id&&tf.id!=="all"?"all":tf.id)}},tf.l)}),
          /* Shuffle */
          React.createElement("button",{onClick:function(){setShuffleKey(shuffleKey+1);setPieceSwap({});setPiecePicker(null);setPieceFilter(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:20,padding:"6px 12px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,marginLeft:"auto",minHeight:32}},"ðŸŽ² Shuffle"),
          /* Count */
          React.createElement("select",{className:"sel",value:fitCount,onChange:function(e){setFitCount(parseInt(e.target.value))},style:{width:52,padding:"6px 4px",fontSize:10,textAlign:"center",borderRadius:8}},
            [6,10,15,20].map(function(n){return React.createElement("option",{key:n,value:n},n)}))),

        /* Lock item banner */
        mode==="auto"&&lockItem&&React.createElement("div",{className:"fu",style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:10}},
          lockItem.photoUrl&&React.createElement("img",{src:lockItem.photoUrl,alt:"",style:{width:32,height:32,objectFit:"cover",borderRadius:6}}),
          React.createElement(Dot,{color:lockItem.color,size:8}),
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"ðŸ”’ Locked: "+( lockItem.name||lockItem.color)+" â€” showing fits around this piece"),
          React.createElement("button",{onClick:function(){setLockItem(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"âœ• Unlock")),

        /* BUILD */
        mode==="build"&&React.createElement("div",null,
          /* Top row: 3 top layer slots */
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:8}},
            [{slot:"top",l:"BASE",sub:"T-Shirt / Shirt",val:bTop,set:setBTop},{slot:"mid",l:"MID",sub:"Sweater / Knit",val:bMid,set:setBMid},{slot:"outer",l:"OUTER",sub:"Jacket / Blazer",val:bOuter,set:setBOuter}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:o.val.photoUrl,alt:"",style:{width:"100%",height:50,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:18}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"âœ• clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:18,color:"var(--dim)"}},"+"),
                  React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},o.sub)))})),
          /* Bottom row: bottoms + shoes */
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}},
            [{slot:"bot",l:"BOTTOM",sub:"Pants / Jeans",val:bBot,set:setBBot},{slot:"shoe",l:"SHOES",sub:"Footwear",val:bShoe,set:setBShoe}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:o.val.photoUrl,alt:"",style:{width:"100%",height:50,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:18}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"âœ• clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:18,color:"var(--dim)"}},"+"),
                  React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},o.sub)))})),
          /* Accessory row */
          React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:8,marginBottom:16}},
            [{slot:"acc",l:"ACCESSORY",sub:"Hat / Scarf / Belt / Bag",val:bAcc,set:setBAcc}].map(function(o){
              return React.createElement("div",{key:o.slot,className:"outfit-slot "+(o.val?"filled":"")+" "+(buildSlot===o.slot?"active":""),onClick:function(){setBuildSlot(buildSlot===o.slot?null:o.slot)},style:{minHeight:48}},
                o.val?React.createElement(React.Fragment,null,
                  o.val.photoUrl?React.createElement("img",{src:o.val.photoUrl,alt:"",style:{width:"100%",height:40,objectFit:"cover",borderRadius:8}}):React.createElement(Dot,{color:o.val.color,size:16}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)",fontWeight:500,textAlign:"center"}},o.val.name||o.val.color),
                  React.createElement("button",{onClick:function(e){e.stopPropagation();o.set(null);setBuildAiCritique(null)},style:{background:"none",border:"none",color:"var(--warn)",fontSize:9,fontFamily:"var(--f)",cursor:"pointer",minHeight:24}},"âœ• clear"))
                :React.createElement(React.Fragment,null,
                  React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.1em"}},o.l),
                  React.createElement("span",{style:{fontSize:16,color:"var(--dim)"}},"+"),
                  React.createElement("div",{style:{fontSize:6,fontFamily:"var(--f)",color:"var(--dim)",opacity:0.6,marginTop:1}},o.sub)))})),

          buildSlot&&(function(){
            var cat=buildSlot==="top"||buildSlot==="mid"||buildSlot==="outer"?"tops":buildSlot==="bot"?"bottoms":buildSlot==="acc"?"accessories":"shoes";
            /* Filter items by garment type for layer slots */
            var items=byCat[cat].filter(function(i){return i.color&&!i.needsEdit});
            if(buildSlot==="top")items=items.filter(function(i){return["Shirt","Polo","T-Shirt"].includes(i.garmentType)});
            if(buildSlot==="mid")items=items.filter(function(i){return["Sweater/Knit","Shirt","Polo"].includes(i.garmentType)});
            if(buildSlot==="outer")items=items.filter(function(i){return["Jacket/Blazer","Sweater/Knit"].includes(i.garmentType)});
            /* Fallback: if no items match the layer filter, show all tops */
            if(!items.length&&(buildSlot==="top"||buildSlot==="mid"||buildSlot==="outer"))items=byCat.tops.filter(function(i){return i.color&&!i.needsEdit});
            var setter=buildSlot==="top"?setBTop:buildSlot==="mid"?setBMid:buildSlot==="outer"?setBOuter:buildSlot==="bot"?setBBot:buildSlot==="acc"?setBAcc:setBShoe;
            var pickLabel=buildSlot==="top"?"a base layer":buildSlot==="mid"?"a mid layer":buildSlot==="outer"?"an outer layer":buildSlot==="bot"?"bottoms":buildSlot==="acc"?"an accessory":"shoes";
            return React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:16}},
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8}},"Pick "+pickLabel),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(80px,1fr))",gap:8}},
                items.map(function(item){return React.createElement("div",{key:item.id,className:"gcard",onClick:function(){setter(item);setBuildSlot(null);setBuildAiCritique(null)},style:{background:"var(--bg)",border:"2px solid transparent",textAlign:"center"}},
                  item.photoUrl?React.createElement("img",{src:item.photoUrl,alt:"",style:{width:"100%",height:60,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{height:40,display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement(Dot,{color:item.color,size:14})),
                  React.createElement("div",{style:{padding:"4px 4px 6px"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",fontWeight:500}},item.name||item.color)))}),
                !items.length&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",gridColumn:"1/-1",padding:10}},"No classified items")));
          })(),

          buildFit?React.createElement("div",{className:"fu",style:{background:"var(--card2)",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"16px"}},
            React.createElement("div",{style:{marginBottom:12}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},
                React.createElement("span",{style:{fontSize:15,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"Score: "+buildFit.fs),
                React.createElement("div",{style:{display:"flex",gap:6}},
                  React.createElement("button",{className:"btn btn-gold",style:{width:"auto",padding:"10px 18px",fontSize:11},onClick:function(){saveFit(buildFit);if(buildName.trim()){setSaved(function(p){var n=p.slice();if(n.length>0){n[n.length-1]=Object.assign({},n[n.length-1],{name:buildName.trim()});ps("of_"+SK,n);}return n;});}setBuildName("");setBuildAiCritique(null);}},"ðŸ’¾ Save"),
                  React.createElement("button",{className:"btn btn-ghost",style:{width:"auto",padding:"10px 14px",fontSize:11},onClick:async function(){var critW=buildWatch||(buildFit.watches&&buildFit.watches[0]);if(!critW)return;setBuildAiLoading(true);var result=await aiVision({top:buildFit.outerTop||buildFit.top,bot:buildFit.bot,shoe:buildFit.shoe,layers:buildFit.tops},critW,effectiveCtx,apiKeyRef.current);setBuildAiCritique(result||{vision:"AI unavailable. Check your API key in settings.",impact:0});setBuildAiLoading(false)},disabled:buildAiLoading},buildAiLoading?"â³ Analyzing...":"âœ¨ AI Critique"))),
              React.createElement("input",{className:"inp",value:buildName,onChange:function(e){setBuildName(e.target.value)},placeholder:"Name this outfit (optional)",style:{fontSize:12}})),
            buildFit.wxWarns&&buildFit.wxWarns.length>0&&React.createElement("div",{style:{marginBottom:10,display:"flex",gap:4,flexWrap:"wrap"}},
              buildFit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
            /* Watch selection */
            React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}},
                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.1em"}},"âŒš WATCH PAIRING"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},buildWatch?"Tap again to deselect":"Tap to choose")),
              buildWatch&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:8}},
                React.createElement("span",{style:{fontSize:18}},buildWatch.i),
                React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"ðŸ”’ "+buildWatch.n),
                React.createElement("button",{onClick:function(){setBuildWatch(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"âœ• Clear")),
              React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},
                buildFit.allW.slice(0,6).map(function(w,i){return React.createElement("div",{key:w.id,onClick:function(){setBuildWatch(buildWatch&&buildWatch.id===w.id?null:w);setBuildAiCritique(null)},style:{cursor:"pointer",border:buildWatch&&buildWatch.id===w.id?"2px solid var(--gold)":"2px solid transparent",borderRadius:14,transition:"all .15s"}},React.createElement(WCard,{w:w,rank:buildWatch?buildWatch.id===w.id?0:null:i,detail:true}))}))),
            /* Outfit mannequin preview */
            (function(){var selW=buildWatch||((buildFit.watches&&buildFit.watches[0])?buildFit.watches[0]:null);return React.createElement("div",{style:{display:"flex",justifyContent:"center",marginTop:14,marginBottom:8}},
              React.createElement(OutfitFigure,{topColor:buildFit.outerTop?buildFit.outerTop.color:buildFit.top?buildFit.top.color:"grey",botColor:buildFit.bot?buildFit.bot.color:"charcoal",shoeColor:buildFit.shoe?buildFit.shoe.color:"black",watchColor:selW?selW.c:"#c9a84c",watchIcon:selW?selW.i:"âŒš",watchName:selW?selW.n:"",size:120}))})(),
            /* Layers summary */
            buildFit.tops&&buildFit.tops.length>1&&React.createElement("div",{style:{display:"flex",justifyContent:"center",gap:6,marginBottom:8}},
              buildFit.tops.map(function(t,ti){return React.createElement("div",{key:ti,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"3px 8px",border:"1px solid var(--border)"}},
                t.photoUrl?React.createElement("img",{src:t.photoUrl,alt:"",style:{width:16,height:16,objectFit:"cover",borderRadius:3}}):React.createElement(Dot,{color:t.color,size:6}),
                React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)"}},ti===0?"Base":ti===1&&buildFit.tops.length===2?"Outer":"L"+(ti+1)),
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--text)"}},t.name||t.color))})),
            /* AI Critique for custom build */
            buildAiCritique&&React.createElement("div",{className:"fu",style:{background:"rgba(201,168,76,0.04)",borderRadius:12,padding:"14px",marginTop:10,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
                React.createElement("span",{style:{fontSize:16}},"âœ¨"),
                React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"AI Analysis")),
              buildAiCritique.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,borderLeft:"3px solid var(--gold)"}},
                React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},buildAiCritique.vision)),
              buildAiCritique.impact>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:8}},
                React.createElement("div",{style:{width:42,height:42,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:buildAiCritique.impact>=7?"rgba(122,184,122,0.15)":buildAiCritique.impact>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:16,fontFamily:"var(--f)",fontWeight:700,color:buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"}},buildAiCritique.impact),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:buildAiCritique.impact>=7?"var(--good)":buildAiCritique.impact>=4?"var(--gold)":"var(--warn)"}},buildAiCritique.impact>=8?"Commanding":buildAiCritique.impact>=6?"Solid":buildAiCritique.impact>=4?"Acceptable":"Needs Work"),
                  buildAiCritique.impact_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},buildAiCritique.impact_why))),
              [buildAiCritique.color_story&&{l:"ðŸŽ¨ Colors",t:buildAiCritique.color_story,c:"#9a8abc"},buildAiCritique.works&&{l:"âœ“ What Works",t:buildAiCritique.works,c:"var(--good)"},buildAiCritique.risk&&{l:"âš  Risk",t:buildAiCritique.risk,c:"var(--warn)"},buildAiCritique.upgrade&&{l:"â¬† Upgrade",t:buildAiCritique.upgrade,c:"var(--gold)"},buildAiCritique.strap_call&&{l:"ðŸ”— Strap",t:buildAiCritique.strap_call,c:"var(--sub)"}].filter(Boolean).map(function(item,i){
                return React.createElement("div",{key:i,style:{display:"flex",gap:8,marginBottom:4}},
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:item.c,fontWeight:600,minWidth:70}},item.l),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},item.t))}),
              React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8,fontSize:10},onClick:function(){setBuildAiCritique(null)}},"â†» Re-analyze")))
          :!buildSlot&&React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:20}},"Tap the slots above to build your outfit â€” use layers for sweater + jacket combos")),

        /* SELFIE CHECK */
        mode==="selfie"&&React.createElement("div",null,
          React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"20px",marginBottom:16,textAlign:"center"}},
            React.createElement("div",{style:{fontSize:32,marginBottom:8}},"ðŸ“¸"),
            React.createElement("div",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600,marginBottom:4}},"Selfie Check"),
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:16}},"Take a selfie or upload a photo to get an AI style analysis with impact score"),
            React.createElement("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"}},
              React.createElement("button",{onClick:function(){selfieRef.current&&selfieRef.current.click()},className:"btn btn-gold",style:{padding:"12px 20px",fontSize:12}},"ðŸ¤³ Selfie"),
              React.createElement("button",{onClick:function(){selfieRearRef.current&&selfieRearRef.current.click()},className:"btn btn-ghost",style:{padding:"12px 20px",fontSize:12}},"ðŸ“· Camera"),
              React.createElement("button",{onClick:function(){selfieGalRef.current&&selfieGalRef.current.click()},className:"btn btn-ghost",style:{padding:"12px 20px",fontSize:12}},"ðŸ–¼ï¸ Gallery")),
            React.createElement("input",{ref:selfieRef,type:"file",accept:"image/*",capture:"user",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}}),
            React.createElement("input",{ref:selfieRearRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}}),
            React.createElement("input",{ref:selfieGalRef,type:"file",accept:"image/*",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){checkSelfie(e.target.files[0]);e.target.value=""}}})),
          /* Loading */
          selfieLoading&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.3)",borderRadius:12,padding:"20px",marginBottom:12,textAlign:"center"}},
            React.createElement("div",{className:"sp",style:{width:28,height:28,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 10px"}}),
            React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing your look...")),
          /* Result */
          selfieResult&&!selfieLoading&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:16}},
            selfieResult.error?React.createElement("div",null,
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},
                React.createElement("span",{style:{fontSize:18}},"âš ï¸"),
                React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--warn)"}},selfieResult.error)),
              React.createElement("button",{onClick:function(){setSelfieResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))
            :React.createElement("div",null,
              /* Impact score */
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:14,marginBottom:14}},
                selfieResult.thumb&&React.createElement("img",{src:selfieResult.thumb,alt:"",style:{width:70,height:70,objectFit:"cover",borderRadius:12,border:"2px solid var(--gold)"}}),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
                    React.createElement("div",{style:{width:44,height:44,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"3px solid "+(selfieResult.result.impact>=8?"var(--good)":selfieResult.result.impact>=5?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:selfieResult.result.impact>=8?"var(--good)":selfieResult.result.impact>=5?"var(--gold)":"var(--warn)"}},selfieResult.result.impact+"/10"),
                    React.createElement("div",null,
                      React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--gold)"}},"Impact Score"),
                      selfieResult.result.impact_why&&React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.impact_why))))),
              /* Vision */
              selfieResult.result.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.1em",marginBottom:4}},"EDITORIAL"),
                React.createElement("p",{style:{fontSize:11,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},selfieResult.result.vision)),
              /* Color story */
              selfieResult.result.color_story&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"10px 12px",marginBottom:8,border:"1px solid var(--border)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"ðŸŽ¨ COLORS "),
                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.color_story)),
              /* Works / Risk / Upgrade */
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:10}},
                selfieResult.result.works&&React.createElement("div",{style:{flex:1,minWidth:140,background:"rgba(122,184,122,0.06)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(122,184,122,0.15)"}},
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:2}},"âœ“ WORKS"),
                  React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.works)),
                selfieResult.result.risk&&React.createElement("div",{style:{flex:1,minWidth:140,background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(200,90,58,0.15)"}},
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:2}},"âš ï¸ RISK"),
                  React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.risk))),
              selfieResult.result.upgrade&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(201,168,76,0.15)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"â¬† UPGRADE "),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.upgrade)),
              selfieResult.result.strap_call&&React.createElement("div",{style:{background:"rgba(122,184,122,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(122,184,122,0.15)"}},
                React.createElement("span",{style:{fontSize:10,fontWeight:600,color:"var(--sub)",marginRight:6}},"ðŸ”— Strap"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.strap_call)),
              selfieResult.result.better_watch&&React.createElement("div",{style:{background:"rgba(154,138,188,0.06)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid rgba(154,138,188,0.15)"}},
                React.createElement("span",{style:{fontSize:10,fontWeight:600,color:"var(--sub)",marginRight:6}},"âŒš Better Pick"),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.better_watch)),
              /* Watch detection */
              selfieResult.result.watch_details&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6}},
                  React.createElement("span",{style:{fontSize:14}},"âŒš"),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.watch_details),
                  selfieResult.result.watch_confidence&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:selfieResult.result.watch_confidence>=7?"var(--good)":selfieResult.result.watch_confidence>=4?"var(--gold)":"var(--dim)",background:"var(--card)",borderRadius:4,padding:"1px 5px",border:"1px solid var(--border)"}},selfieResult.result.watch_confidence+"/10"))),
              /* Fit assessment */
              selfieResult.result.fit_assessment&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"8px 10px",marginBottom:10,border:"1px solid var(--border)"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"ðŸ“ FIT "),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},selfieResult.result.fit_assessment)),
              React.createElement("button",{onClick:function(){setSelfieResult(null)},className:"btn btn-ghost",style:{width:"100%",fontSize:10,marginTop:4}},"âœ• Close"))),
          /* History */
          selfieHistory.length>0&&React.createElement("div",{style:{marginTop:8}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:10}},
              React.createElement("span",{style:{fontSize:14}},"ðŸ“‹"),
              React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600}},"History"),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},selfieHistory.length+" check"+(selfieHistory.length>1?"s":""))),
            selfieHistory.map(function(entry){
              return React.createElement("div",{key:entry.id,style:{display:"flex",gap:10,alignItems:"center",background:"var(--card)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 12px",marginBottom:6}},
                entry.thumb&&React.createElement("img",{src:entry.thumb,alt:"",style:{width:44,height:44,objectFit:"cover",borderRadius:8,flexShrink:0}}),
                React.createElement("div",{style:{flex:1,minWidth:0}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6}},
                    React.createElement("div",{style:{width:28,height:28,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(entry.impact>=8?"var(--good)":entry.impact>=5?"var(--gold)":"var(--warn)"),fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:entry.impact>=8?"var(--good)":entry.impact>=5?"var(--gold)":"var(--warn)"}},entry.impact),
                    React.createElement("div",{style:{flex:1}},
                      React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},entry.result&&entry.result.impact_why?entry.result.impact_why.slice(0,60):"Style check"),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},new Date(entry.ts).toLocaleDateString()+" "+new Date(entry.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))))),
                React.createElement("button",{onClick:function(){setSelfieResult(entry)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:24}},"View"),
                React.createElement("button",{onClick:function(){delSelfie(entry.id)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"4px 8px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:9,minHeight:24}},"âœ•"))}))),

        /* ROTATION */
        mode==="rotation"&&(function(){
          var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock);
          /* Apply alt swaps */
          Object.keys(altSwap).forEach(function(k){
            var di=parseInt(k),ai=altSwap[k];
            if(rotation[di]&&rotation[di].altOutfits&&rotation[di].altOutfits[ai]){
              var orig=rotation[di].outfit;
              var origFs=rotation[di].fs||rotation[di].altOutfits[ai].fs;
              rotation[di].outfit=rotation[di].altOutfits[ai];
              rotation[di].fs=rotation[di].altOutfits[ai].fs;
              var newAlts=rotation[di].altOutfits.slice();
              newAlts[ai]={top:orig.top,bot:orig.bot,shoe:orig.shoe,fs:origFs};
              rotation[di].altOutfits=newAlts;
            }
          });
          var DAYS7=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          var genC=rotation.filter(function(d){return d.watch&&d.watch.t==="genuine"}).length;
          var repC=rotation.filter(function(d){return d.watch&&d.watch.t==="replica"}).length;
          var uniqueW={};rotation.forEach(function(d){if(d.watch)uniqueW[d.watch.id]=true});
          return React.createElement("div",null,
            /* Header + stats */
            React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.2)",borderRadius:14,padding:"14px 16px",marginBottom:10}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                React.createElement("span",{style:{fontSize:18}},"ðŸ“…"),
                React.createElement("span",{style:{fontSize:15,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"7-Day Rotation"),
                React.createElement("button",{onClick:function(){setEditRotCtx(!editRotCtx)},style:{marginLeft:"auto",background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},editRotCtx?"Done":"âš™ï¸ Edit Days"),
                React.createElement("button",{onClick:function(){
                  var nl=rotation.map(function(d){return d.watch?d.watch.id:null});
                  setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                },style:{background:"none",border:"1px solid rgba(122,184,122,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"ðŸ’¾ Save"),
                rotLock.some(function(x){return x!==null})&&React.createElement("button",{onClick:function(){
                  setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);
                },style:{background:"none",border:"1px solid rgba(200,90,58,0.3)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"ðŸ”“ Clear")),
              React.createElement("div",{style:{display:"flex",gap:12,fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},
                React.createElement("span",null,"ðŸ”¢ "+Object.keys(uniqueW).length+" unique"),
                !IS_SHARED&&React.createElement("span",null,"âœ“ "+genC+" genuine"),
                !IS_SHARED&&React.createElement("span",null,"â—‡ "+repC+" replica"),
                rotLock.filter(function(x){return x}).length>0&&React.createElement("span",{style:{color:"var(--good)"}},"ðŸ”’ "+rotLock.filter(function(x){return x}).length+" locked"))),

            /* Rotation weather summary */
            (function(){
              var clearD=0,rainD=0,windyD=0,snowD=0;
              rotation.forEach(function(d){if(!d.forecast)return;var c=d.forecast.cond;if(c&&c.rain)rainD++;else if(d.forecast.code>=71&&d.forecast.code<=86)snowD++;else clearD++;if(d.forecast.wind>=30)windyD++});
              var parts=[];if(clearD)parts.push("â˜€ï¸ "+clearD+" clear");if(rainD)parts.push("ðŸŒ§ï¸ "+rainD+" rain");if(snowD)parts.push("â„ï¸ "+snowD+" snow");if(windyD)parts.push("ðŸ’¨ "+windyD+" windy");
              return parts.length?React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",background:"var(--bg)",borderRadius:8,padding:"6px 12px",marginBottom:8,border:"1px solid var(--border)",textAlign:"center"}},parts.join(" Â· ")):null;
            })(),

            /* Smart rotation alerts */
            (function(){
              var alerts=[];
              /* Rep-heavy week */
              if(!IS_SHARED&&repC>=5)alerts.push({icon:"âš ",text:"Rep-heavy week: "+repC+"/7 days are replicas. Consider swapping 1-2 for genuine.",c:"var(--warn)"});
              /* Back-to-back same watch */
              for(var ai=0;ai<rotation.length-1;ai++){if(rotation[ai].watch&&rotation[ai+1].watch&&rotation[ai].watch.id===rotation[ai+1].watch.id)alerts.push({icon:"ðŸ”",text:rotation[ai].watch.n+" repeats "+rotation[ai].dayName+"â†’"+rotation[ai+1].dayName+". Variety matters.",c:"var(--warn)"})}
              /* Neglected watches â€” active watches not in rotation and not worn in 14+ days */
              var rotIds={};rotation.forEach(function(d){if(d.watch)rotIds[d.watch.id]=true});
              var neglected=actW.filter(function(w){return !rotIds[w.id]&&daysSince(w.id)>=14&&w.status==="active"});
              if(neglected.length>=3)alerts.push({icon:"ðŸ’¤",text:neglected.length+" watches haven't been worn in 14+ days: "+neglected.slice(0,3).map(function(w){return w.i+" "+w.n}).join(", "),c:"#7ab8d8"});
              /* Strap mismatch warnings */
              rotation.forEach(function(d){if(d.watch&&d.outfit&&d.outfit.shoe&&!d.watch.br){var sc=d.outfit.shoe.color?d.outfit.shoe.color.toLowerCase():"";var wsc=(d.watch.sc||[]).join(" ").toLowerCase();if(sc.includes("brown")&&wsc.includes("black")&&!wsc.includes("brown"))alerts.push({icon:"ðŸš«",text:d.dayName+": "+d.watch.n+" has black strap but brown shoes. Mismatch.",c:"var(--warn)"});if(sc.includes("black")&&!wsc.includes("black")&&!wsc.includes("navy")&&wsc.length>0)alerts.push({icon:"ðŸš«",text:d.dayName+": "+d.watch.n+" has warm strap but black shoes.",c:"var(--warn)"})}});
              /* Rain + leather strap warnings */
              rotation.forEach(function(d){if(d.forecast&&d.forecast.cond&&d.forecast.cond.rain&&d.watch&&!d.watch.br){alerts.push({icon:"â˜‚ï¸",text:d.dayName+": Rain forecast ("+d.forecast.rainPct+"%) but "+d.watch.n+" has leather strap. Consider bracelet watch or waterproof precautions.",c:"#7ab8d8"})}});
              /* Rainy days count */
              var rainyDays=rotation.filter(function(d){return d.forecast&&d.forecast.cond&&d.forecast.cond.rain}).length;
              if(rainyDays>=3)alerts.push({icon:"ðŸŒ§ï¸",text:"Rain-heavy week: "+rainyDays+" of 7 days have precipitation. Bracelet watches prioritized.",c:"#7ab8d8"});
              if(!alerts.length)return null;
              return React.createElement("div",{style:{marginBottom:10}},alerts.map(function(a,idx){
                var isRainAlert=a.c==="#7ab8d8";
                return React.createElement("div",{key:idx,style:{display:"flex",alignItems:"flex-start",gap:8,background:isRainAlert?"rgba(100,150,220,0.04)":"rgba(200,90,58,0.04)",border:"1px solid "+(isRainAlert?"rgba(100,150,220,0.15)":"rgba(200,90,58,0.15)"),borderRadius:8,padding:"8px 12px",marginBottom:4}},
                  React.createElement("span",{style:{fontSize:14,flexShrink:0}},a.icon),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:a.c,lineHeight:1.4}},a.text))}));
            })(),

            /* Context editor */
            editRotCtx&&React.createElement("div",{className:"fu",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px",marginBottom:10}},
              React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:8,letterSpacing:"0.1em"}},"SET CONTEXT PER DAY"),
              DAYS7.map(function(dn,di){
                return React.createElement("div",{key:di,style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:32,fontWeight:600}},dn),
                  React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap",flex:1},className:"hscroll"},
                    activeCxIds.slice(0,8).map(function(cx){
                      return React.createElement("span",{key:cx,className:"chip "+(weekCtx[di]===cx?"on":""),onClick:function(){
                        var nwc=weekCtx.slice();nwc[di]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      },style:{padding:"3px 8px",fontSize:9,minHeight:24}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})));
              })),

            /* Day cards */
            rotation.map(function(day,i){
              if(!day.watch)return null;
              var w=day.watch;var isToday=i===0;
              var of=day.outfit;var sp=day.strapPick;
              var ds=daysSince(w.id);
              var dayDate=day.date||todayStr;
              var worn=wearLog.find(function(e){return e.date===dayDate&&e.watchId===w.id});
              var isEditing=editDayIdx===i;
              return React.createElement("div",{key:i,className:"card-lift",style:{background:isToday?"var(--card2)":"var(--card)",border:"1px solid "+(isToday?"rgba(201,168,76,0.3)":day.locked?"rgba(122,184,122,0.2)":"var(--border)"),borderRadius:12,padding:"12px 14px",marginBottom:8}},
                React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center"}},
                  /* Day + weather */
                  React.createElement("div",{style:{minWidth:48,textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:isToday?"var(--gold)":"var(--sub)",fontWeight:700}},(function(){var sc=[pieceSwap[i+"-top"],pieceSwap[i+"-bot"],pieceSwap[i+"-shoe"]].filter(Boolean).length;return(isToday?"TODAY":day.dayName.toUpperCase())+(sc?" âœŽ"+sc:"")})()),
                    day.forecast&&React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},day.forecast.cond?day.forecast.cond.i:day.tier?day.tier.icon:""),
                    day.forecast&&React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},day.forecast.high+"Â°/"+day.forecast.low+"Â°"),
                    day.forecast&&day.forecast.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:day.forecast.rainPct>=50?"#7ab8d8":"var(--dim)"}},day.forecast.rainPct>=50?"ðŸ’§"+day.forecast.rainPct+"%":day.forecast.rainPct+"%")),
                  /* Watch â€” tap to swap */
                  React.createElement("div",{onClick:function(){setEditDayIdx(isEditing?null:i);setEditDayMode(isEditing?null:"watch")},style:{width:40,height:40,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"20",fontSize:18,flexShrink:0,border:"2px solid "+(isEditing?"var(--gold)":w.c+"40"),cursor:"pointer"}},w.i),
                  React.createElement("div",{style:{flex:1,minWidth:0}},
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:5,flexWrap:"wrap",marginBottom:2}},
                      React.createElement("span",{style:{fontSize:13,fontWeight:600}},w.n),
                      !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 4px"}},"REP"),
                      /* Context badge â€” tap to cycle */
                      React.createElement("span",{onClick:function(e){e.stopPropagation();setEditDayIdx(isEditing&&editDayMode==="ctx"?null:i);setEditDayMode("ctx")},style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",background:"var(--bg)",borderRadius:4,padding:"1px 6px",cursor:"pointer",border:"1px solid "+(isEditing&&editDayMode==="ctx"?"var(--gold)":"transparent")}},(CXI[day.context]||"")+" "+day.context),
                      day.locked&&React.createElement("span",{style:{fontSize:7,color:"var(--good)"}},"ðŸ”’"),
                      ds<999&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:ds<=2?"var(--warn)":ds>=7?"var(--good)":"var(--sub)",background:"var(--bg)",borderRadius:4,padding:"1px 5px"}},ds===0?"today":ds+"d ago"),
                      of&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:of.fs>=8?"var(--good)":of.fs>=5?"var(--gold)":"var(--warn)",background:of.fs>=8?"rgba(122,184,122,0.1)":of.fs>=5?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",borderRadius:4,padding:"1px 5px",border:"1px solid "+(of.fs>=8?"rgba(122,184,122,0.2)":of.fs>=5?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},of.fs>=8?"ðŸ”¥":"ðŸ‘”"," "+(pieceSwap[i+"-top"]||pieceSwap[i+"-bot"]||pieceSwap[i+"-shoe"]?"~":"")+of.fs)),
                    /* Strap + bracelet line */
                    React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},
                      (function(){
                        var isRain=day.forecast&&day.forecast.cond&&day.forecast.cond.rain;
                        if(sp&&sp.strap){
                          var stT=STRAP_TYPES.find(function(t){return t.id===sp.strap.type})||{icon:"ðŸ”—"};
                          var isWR=sp.strap.type==="bracelet"||sp.strap.type==="rubber"||sp.strap.type==="mesh";
                          var label=sp.strap.type==="bracelet"?"Bracelet"+(sp.strap.material?" ("+sp.strap.material+")":""):sp.strap.color+" "+sp.strap.type+(sp.strap.material?" ("+sp.strap.material+")":"");
                          return React.createElement("span",{style:{color:isRain?(isWR?"var(--good)":"var(--warn)"):sp.type==="good"?"var(--good)":"var(--sub)"}},(isRain&&!isWR?"âš ï¸ ":"")+stT.icon+" "+label+(isRain&&!isWR?" â€” rain risk":isRain&&isWR?" âœ“":""));
                        }
                        if(w.br)return React.createElement("span",{style:{color:isRain?"var(--good)":"var(--sub)"}},"â›“ï¸ Bracelet"+(isRain?" âœ“":""));
                        return React.createElement("span",null,"ðŸ”— "+(w.sc||[]).join(" / "));
                      })())),
                  /* Lock/unlock button */
                  React.createElement("button",{onClick:function(){var nl=rotLock.slice();nl[i]=nl[i]?null:w.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl)},style:{background:"none",border:"1px solid "+(day.locked?"rgba(122,184,122,0.3)":"var(--border)"),borderRadius:6,padding:"4px 8px",cursor:"pointer",color:day.locked?"var(--good)":"var(--dim)",fontSize:12,flexShrink:0,minWidth:32,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center"}},day.locked?"ðŸ”’":"ðŸ”“")),

                /* Inline context picker */
                isEditing&&editDayMode==="ctx"&&React.createElement("div",{className:"fu",style:{display:"flex",gap:3,flexWrap:"wrap",marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                  activeCxIds.slice(0,8).map(function(cx){
                    return React.createElement("span",{key:cx,className:"chip "+(weekCtx[day.dayIdx]===cx?"on":""),onClick:function(){
                      var nwc=weekCtx.slice();nwc[day.dayIdx]=cx;setWeekCtx(nwc);ps("wa_weekctx",nwc);
                      /* Also unlock this day so rotation recalculates */
                      var nl=rotLock.slice();nl[i]=null;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                      setEditDayIdx(null);setEditDayMode(null);
                    },style:{padding:"4px 10px",fontSize:9,minHeight:28}},(activeCxIcons[cx]||CXI[cx]||"")+" "+cx)})),

                /* Inline watch picker */
                isEditing&&editDayMode==="watch"&&React.createElement("div",{className:"fu",style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                  React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"SWAP WATCH FOR "+day.dayName.toUpperCase()),
                  React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(100px,1fr))",gap:6,maxHeight:200,overflowY:"auto"}},
                    actW.filter(function(aw){return reps||aw.t!=="replica"}).map(function(aw){
                      var isActive=aw.id===w.id;
                      return React.createElement("div",{key:aw.id,onClick:function(){
                        var nl=rotLock.slice();nl[i]=aw.id;setRotLock(nl);ps("wa_rotlock_"+SK,nl);
                        setEditDayIdx(null);setEditDayMode(null);
                      },style:{display:"flex",alignItems:"center",gap:6,background:isActive?"rgba(201,168,76,0.1)":"var(--bg)",border:"1px solid "+(isActive?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:8,padding:"6px 8px",cursor:"pointer"}},
                        React.createElement("span",{style:{fontSize:16}},aw.i),
                        React.createElement("div",{style:{flex:1,minWidth:0}},
                          React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},aw.n),
                          React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},aw.d+(!IS_SHARED&&aw.t==="replica"?" Â· rep":""))))}))),

                /* Confirm wear / undo for today */
                isToday&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)",alignItems:"center"}},
                  !worn?React.createElement("button",{onClick:function(){logWear(w.id,todayStr)},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:8,padding:"8px 14px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,flex:1,minHeight:36}},"âœ“ Wearing this today")
                  :React.createElement(React.Fragment,null,
                    React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--good)",flex:1}},"âœ“ Logged for today"),
                    React.createElement("button",{onClick:function(){undoWear(todayStr)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"Undo"))),
                /* Outfit pairing row â€” tappable for alternatives */
                of&&React.createElement("div",{style:{marginTop:isToday?6:8,paddingTop:isToday?0:8,borderTop:isToday?"none":"1px solid var(--border)"}},
                  React.createElement("div",{onClick:function(){setExpandDay(expandDay===i?null:i);setPiecePicker(null);setPieceFilter(null)},style:{display:"flex",gap:6,cursor:"pointer"}},
                    [{l:"TOP",slot:"top",item:of.top},{l:"BTM",slot:"bot",item:of.bot},{l:"SHOE",slot:"shoe",item:of.shoe}].map(function(o){
                      var ep=getEP(i,o.slot,o.item);if(!ep)return null;
                      var swapped=pieceSwap[i+"-"+o.slot];
                      return React.createElement("div",{key:o.l,style:{flex:1,background:swapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid "+(swapped?"rgba(201,168,76,0.25)":"var(--border)"),minWidth:0}},
                        ep.photoUrl?React.createElement("img",{src:ep.photoUrl,alt:"",style:{width:"100%",height:56,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:56,background:(CM[ep.color]||{}).h||"#3a3a3a"}}),
                        React.createElement("div",{style:{padding:"4px 6px",display:"flex",alignItems:"center",gap:3}},
                          React.createElement(Dot,{color:ep.color,size:5}),
                          React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:swapped?"var(--gold)":"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},swapped?"âœŽ ":"",ep.name||ep.color)))}),
                    React.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4,flexShrink:0,minWidth:28}},
                      React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},expandDay===i?"â–²":"â–¼"),
                      /* Per-day AI critique button */
                      React.createElement("button",{onClick:function(e){e.stopPropagation();
                        if(dayAi[i]){setDayAi(function(p){var n=Object.assign({},p);delete n[i];return n});return}
                        setDayAiLoading(i);
                        aiVision({top:getEP(i,"top",of.top),bot:getEP(i,"bot",of.bot),shoe:getEP(i,"shoe",of.shoe)},w,day.context,apiKeyRef.current).then(function(result){
                          setDayAi(function(p){var n=Object.assign({},p);n[i]=result||{vision:"AI unavailable",impact:0};return n});
                          setDayAiLoading(null);
                        });
                      },style:{background:"none",border:"1px solid "+(dayAi[i]?"rgba(201,168,76,0.4)":"var(--border)"),borderRadius:6,padding:"3px 8px",cursor:"pointer",color:dayAiLoading===i?"var(--gold)":dayAi[i]?"var(--gold)":"var(--dim)",fontSize:10,minHeight:24}},dayAiLoading===i?"â³":dayAi[i]?"âœ¨ "+dayAi[i].impact:"âœ¨"))),

                  /* Expanded: AI critique result */
                  dayAi[i]&&React.createElement("div",{className:"fu",style:{marginTop:6,background:"rgba(201,168,76,0.04)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(201,168,76,0.15)"}},
                    dayAi[i].vision&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.5,color:"var(--text)",marginBottom:4}},dayAi[i].vision),
                    React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",fontSize:8,fontFamily:"var(--f)"}},
                      dayAi[i].impact>0&&React.createElement("span",{style:{color:dayAi[i].impact>=7?"var(--good)":dayAi[i].impact>=4?"var(--gold)":"var(--warn)",fontWeight:700}},"Impact: "+dayAi[i].impact+"/10"),
                      dayAi[i].color_story&&React.createElement("span",{style:{color:"#9a8abc"}},"ðŸŽ¨ "+dayAi[i].color_story),
                      dayAi[i].works&&React.createElement("span",{style:{color:"var(--good)"}},"âœ“ "+dayAi[i].works),
                      dayAi[i].risk&&React.createElement("span",{style:{color:"var(--warn)"}},"âš  "+dayAi[i].risk))),

                  /* Expanded: outfit mannequin */
                  expandDay===i&&(pieceSwap[i+"-top"]||pieceSwap[i+"-bot"]||pieceSwap[i+"-shoe"])&&React.createElement("div",{style:{display:"flex",justifyContent:"flex-end",gap:6,marginTop:6,padding:"0 4px"},onClick:function(ev){ev.stopPropagation()}},
                    React.createElement("button",{onClick:function(){var ps2=Object.assign({},pieceSwap);delete ps2[i+"-top"];delete ps2[i+"-bot"];delete ps2[i+"-shoe"];setPieceSwap(ps2)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",color:"var(--del-text)",cursor:"pointer"}},"â†© Reset swaps"),
                    React.createElement("button",{onClick:function(){var newFit={watches:[w],top:getEP(i,"top",of.top),bot:getEP(i,"bot",of.bot),shoe:getEP(i,"shoe",of.shoe),context:day.context,name:day.dayName+" custom"};saveFit(newFit)},style:{background:"none",border:"1px solid var(--gold)",borderRadius:6,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",cursor:"pointer"}},"ðŸ’¾ Save custom")),
                  expandDay===i&&React.createElement("div",{className:"fu",style:{marginTop:8,display:"flex",gap:12,alignItems:"flex-start",justifyContent:"center"}},
                    React.createElement(OutfitFigure,{topColor:getEP(i,"top",of.top)?getEP(i,"top",of.top).color:"grey",botColor:getEP(i,"bot",of.bot)?getEP(i,"bot",of.bot).color:"charcoal",shoeColor:getEP(i,"shoe",of.shoe)?getEP(i,"shoe",of.shoe).color:"black",watchColor:w.c,watchIcon:w.i,watchName:w.n,size:100}),
                    sp&&sp.strap&&React.createElement("div",{style:{textAlign:"center",padding:"6px 0 2px",fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},
                      (function(){var stT=STRAP_TYPES.find(function(t){return t.id===sp.strap.type})||{icon:"ðŸ”—"};return stT.icon+" "+(sp.strap.type==="bracelet"?"Bracelet":sp.strap.color+" "+sp.strap.type)+(sp.strap.brand?" Â· "+sp.strap.brand:"")})()),
                    React.createElement("div",{style:{flex:1,minWidth:0}},
                      [{l:"TOP",slot:"top",item:getEP(i,"top",of.top)},{l:"BOTTOM",slot:"bot",item:getEP(i,"bot",of.bot)},{l:"SHOES",slot:"shoe",item:getEP(i,"shoe",of.shoe)}].map(function(o){
                        if(!o.item)return null;
                        var pk=i+"-"+o.slot;var isOpen=piecePicker===pk;var isSwapped=!!pieceSwap[pk];
                        return React.createElement("div",{key:o.l},
                          React.createElement("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:isOpen?4:8,background:isSwapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:8,padding:"6px 8px",border:isSwapped?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",cursor:"pointer"},onClick:function(ev){ev.stopPropagation();setPiecePicker(isOpen?null:pk);setPieceFilter(null)}},
                            o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:44,height:44,objectFit:"cover",borderRadius:6,flexShrink:0}}):React.createElement("div",{style:{width:44,height:44,borderRadius:6,background:(CM[o.item.color]||{}).h||"#3a3a3a",flexShrink:0}}),
                            React.createElement("div",{style:{flex:1,minWidth:0}},
                              React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em"}},o.l+(isSwapped?" âœŽ":"")),
                              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},
                                React.createElement(Dot,{color:o.item.color,size:6}),
                                React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:isSwapped?"var(--gold)":"var(--text)",fontWeight:500}},o.item.name||o.item.color)),
                              React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" Â· "+o.item.pattern:""))),
                            React.createElement("span",{style:{fontSize:10,color:"var(--dim)"}},isOpen?"â–²":"ðŸ”„")),
                          /* â• Piece picker â• */
                          isOpen&&React.createElement(React.Fragment,null,
                          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"4px 0 2px",marginBottom:2},onClick:function(ev){ev.stopPropagation()}},
                        [null].concat(slotAlts(o.slot).reduce(function(acc,it){if(acc.indexOf(it.color)===-1)acc.push(it.color);return acc},[])).map(function(fc){
                          var label=fc?fc.charAt(0).toUpperCase()+fc.slice(1):"All";var cnt=slotAlts(o.slot).filter(function(a){return !a.id||(fc===null||a.color===fc)}).length;
                          var isActive=pieceFilter===fc;
                          return React.createElement("button",{key:label,onClick:function(){setPieceFilter(isActive?null:fc)},style:{display:"flex",alignItems:"center",gap:3,background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400}},fc&&React.createElement(Dot,{color:fc,size:6}),label,fc?" ("+slotAlts(o.slot).filter(function(x){return x.color===fc}).length+")":"")})),
                        slotPatterns(o.slot).length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"2px 0 4px"},onClick:function(ev){ev.stopPropagation()}},
                          slotPatterns(o.slot).map(function(pt){
                            var isActive=pieceFilter==="p:"+pt;
                            return React.createElement("button",{key:pt,onClick:function(){setPieceFilter(isActive?null:"p:"+pt)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400,fontStyle:"italic"}},pt," (",slotAlts(o.slot).filter(function(x){return x.pattern===pt}).length,")")})),
                          React.createElement("div",{style:{display:"flex",gap:6,overflowX:"auto",padding:"6px 0 8px",marginBottom:8,WebkitOverflowScrolling:"touch"},onClick:function(ev){ev.stopPropagation()}},
                            isSwapped&&React.createElement("div",{onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);delete n[pk];return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 8px",borderRadius:8,border:"1px solid var(--del-border)",cursor:"pointer",minWidth:52}},
                              React.createElement("span",{style:{fontSize:14}},"â†©ï¸"),
                              React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--del-text)"}},"Reset")),
                            (function(){var _fa=filteredAlts(o.slot,o.item&&o.item.id);return _fa.length===0?[React.createElement("div",{key:"_empty",style:{flexShrink:0,padding:"8px 12px",color:"var(--dim)",fontSize:8,fontFamily:"var(--f)",fontStyle:"italic",whiteSpace:"nowrap"}},"No matches")]:_fa})().map(function(alt){
                              return React.createElement("div",{key:alt.id,onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);n[pk]=alt;return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 6px",borderRadius:8,border:"1px solid var(--border)",cursor:"pointer",minWidth:52,maxWidth:64}},
                                alt.photoUrl?React.createElement("img",{src:alt.photoUrl,alt:"",style:{width:40,height:40,objectFit:"cover",borderRadius:6}}):React.createElement("div",{style:{width:40,height:40,borderRadius:6,background:(CM[alt.color]||{}).h||"#3a3a3a"}}),
                                React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:56}},alt.name||alt.color))}))))}),
                      React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"6px 8px"}},
                        React.createElement("span",{style:{fontSize:16}},w.i),
                        React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},w.n),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},w.d+" Â· "+(w.straps&&w.straps.length?w.straps.map(function(s){return s.type}).join("+"):w.br?"Bracelet":(w.sc||[]).join("/")))))),

                  /* Expanded: alternative outfits */
                  expandDay===i&&day.altOutfits&&day.altOutfits.length>0&&React.createElement("div",{className:"fu",style:{marginTop:6}},
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:4,letterSpacing:"0.08em"}},"ALTERNATIVES"),
                    day.altOutfits.map(function(alt,ai2){
                      return React.createElement("div",{key:ai2,onClick:function(){var sw=Object.assign({},altSwap);if(sw[i]===ai2){delete sw[i]}else{sw[i]=ai2}setAltSwap(sw);var ps2=Object.assign({},pieceSwap);delete ps2[i+"-top"];delete ps2[i+"-bot"];delete ps2[i+"-shoe"];setPieceSwap(ps2)},style:{display:"flex",gap:6,marginBottom:4,padding:"4px 0",borderBottom:ai2<day.altOutfits.length-1?"1px solid var(--border)":"none",cursor:"pointer",opacity:altSwap[i]===ai2?1:0.7,background:altSwap[i]===ai2?"rgba(184,150,42,0.08)":"none",borderRadius:4}},
                        [{item:alt.top},{item:alt.bot},{item:alt.shoe}].map(function(o,oi){
                          if(!o.item)return null;
                          return React.createElement("div",{key:oi,style:{display:"flex",alignItems:"center",gap:3,flex:"1 1 0",minWidth:0}},
                            o.item.photoUrl&&React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}),
                            React.createElement(Dot,{color:o.item.color,size:4}),
                            React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))}),
                        React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",flexShrink:0}},alt.fs))})),
                  expandDay===i&&(!day.altOutfits||!day.altOutfits.length)&&React.createElement("div",{style:{marginTop:6,fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:6}},"No alternative combos for this context")));
            }),
            React.createElement("button",{onClick:function(){setRotLock([null,null,null,null,null,null,null]);ps("wa_rotlock_"+SK,[null,null,null,null,null,null,null]);setMode("auto");setTimeout(function(){setMode("rotation")},50)},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,minHeight:40}},"ðŸ”„ Shuffle Rotation"));
        })(),

        /* AUTO */
        mode==="auto"&&React.createElement(React.Fragment,null,
          tier&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)",margin:"0 0 8px"}},"ðŸŒ¡ï¸ ",React.createElement("strong",{style:{color:"var(--gold)"}},tier.label+(planDay>0?" ("+forecast[planDay].date+")":"")),
            " Â· "+ww+" Â· "+actW.length+" watches Â· "+fits.length+" fits",
            planWx&&planWx.cond?React.createElement("span",{style:{color:planWx.rain?"#7ab8d8":"var(--sub)",marginLeft:6}},planWx.cond.i+" "+planWx.cond.l):null),
          /* Weather-specific advice banner */
          planWx&&(planWx.rain||planWx.uv>=8||(planWx.wind&&planWx.wind>=35))&&React.createElement("div",{style:{background:planWx.rain?"rgba(100,150,220,0.06)":"rgba(200,90,58,0.06)",border:"1px solid "+(planWx.rain?"rgba(100,150,220,0.2)":"rgba(200,90,58,0.2)"),borderRadius:10,padding:"8px 12px",marginBottom:10,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},
            React.createElement("span",{style:{fontSize:14}},planWx.rain?"â˜‚ï¸":planWx.uv>=8?"ðŸ•¶ï¸":"ðŸ’¨"),
            React.createElement("div",{style:{flex:1,minWidth:120}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",fontWeight:600,color:planWx.rain?"#7ab8d8":"var(--warn)"}},planWx.rain?"Rain Day â€” Bracelet Watches Boosted":planWx.uv>=8?"High UV â€” Light Fabrics":"High Wind â€” Secure Layers"),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},planWx.rain?"Leather straps penalized. White/cream shoes downranked."+(planWx.rainPct?" "+planWx.rainPct+"% chance.":""):planWx.uv>=8?"UV "+planWx.uv+" â€” light colors preferred":"Wind "+planWx.wind+"km/h"))),
          !fits.length?React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"ðŸ‘•"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},wd.length<2?"Add wardrobe items":needsFix>0?"Classify items first":"No valid combos"))
          :fits.map(function(fit,idx){
            return React.createElement("div",{key:fit.id,className:"card-lift",onClick:function(){setSelFit(fit);setFitWatch(null)},style:{background:idx===0?"var(--card2)":"var(--card)",border:idx===0?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10,cursor:"pointer",position:"relative"}},
              idx===0&&React.createElement("div",{style:{position:"absolute",top:8,right:12,fontSize:8,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:700}},"TOP"),
              React.createElement("div",{className:"dots-row",style:{marginBottom:8}},
                [fit.top,fit.bot,fit.shoe].filter(Boolean).map(function(item,i){return React.createElement(Dot,{key:i,color:item.color,size:8})}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:fit.fs>=8?"var(--good)":fit.fs>=5?"var(--gold)":"var(--warn)",marginLeft:4,fontWeight:600}},(fit.fs>=8?"ðŸ”¥ ":fit.fs>=5?"":"âš  ")+fit.fs),
                fit.topType&&fit.topType!=="Shirt"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:2}},fit.topType==="Sweater/Knit"?"ðŸ§¶":fit.topType==="Jacket/Blazer"?"ðŸ§¥":fit.topType==="Polo"?"ðŸ‡":fit.topType==="T-Shirt"?"ðŸ‘•":"")),
              React.createElement("div",{style:{display:"flex",gap:6,marginBottom:10}},
                [{l:"TOP",item:fit.top},{l:"BTM",item:fit.bot},{l:"SHOE",item:fit.shoe}].map(function(o){
                  if(!o.item)return null;
                  return React.createElement("div",{key:o.l,style:{flex:1,background:"var(--bg)",borderRadius:8,overflow:"hidden",border:"1px solid var(--border)",minWidth:0}},
                    o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:"100%",height:52,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:36,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{padding:"4px 6px"}},React.createElement("div",{style:{display:"flex",alignItems:"center",gap:3}},React.createElement(Dot,{color:o.item.color,size:5}),React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},o.item.name||o.item.color))))})),
              React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                fit.watches.map(function(w,i){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"var(--sub)",fontWeight:i===0?600:400}},w.n))})),
              fit.wxWarns&&fit.wxWarns.length>0&&React.createElement("div",{style:{marginTop:6,display:"flex",gap:4,flexWrap:"wrap"}},
                fit.wxWarns.map(function(warn,wi){return React.createElement("span",{key:wi,style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"2px 6px",border:"1px solid rgba(100,150,220,0.15)"}},warn)})),
              /* Recently worn warning */
              (function(){var rw=fit.items.filter(function(it){if(!it.lastWorn)return false;return Math.floor((Date.now()-new Date(it.lastWorn).getTime())/864e5)<=2});return rw.length?React.createElement("div",{style:{marginTop:4,fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},
                "ðŸ”„ "+(rw.length===1?(rw[0].name||rw[0].color)+" worn recently":rw.length+" items worn recently")):null})())}))),

      /* â•â•â• FIT DETAIL â•â•â• */
      view==="fits"&&selFit&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        React.createElement("button",{onClick:function(){setSelFit(null)},style:{background:"none",border:"none",color:"var(--gold)",fontFamily:"var(--f)",fontSize:12,cursor:"pointer",padding:0,marginBottom:12,minHeight:44}},"â† Back"),
        /* Outfit mannequin preview */
        React.createElement("div",{style:{display:"flex",justifyContent:"center",marginBottom:16,background:"linear-gradient(145deg,var(--card),var(--card2))",borderRadius:14,padding:"16px",border:"1px solid rgba(201,168,76,0.15)"}},
          (function(){var dw=fitWatch||(selFit.watches&&selFit.watches[0])||null;return React.createElement(OutfitFigure,{topColor:selFit.top?selFit.top.color:"grey",botColor:selFit.bot?selFit.bot.color:"charcoal",shoeColor:selFit.shoe?selFit.shoe.color:"black",watchColor:dw?dw.c:"#c9a84c",watchIcon:dw?dw.i:"âŒš",watchName:dw?dw.n:"",size:130})})()),
        [{slot:"top",l:"TOP",item:selFit.top},{slot:"bot",l:"BOTTOM",item:selFit.bot},{slot:"shoes",l:"SHOES",item:selFit.shoe}].map(function(o){
          if(!o.item)return null;
          var swaps=getSwaps(wd,selFit,o.slot);
          return React.createElement("div",{key:o.slot,style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"12px 14px",marginBottom:8}},
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10}},
              o.item.photoUrl&&React.createElement("img",{src:o.item.photoUrl,alt:"",onClick:function(e){e.stopPropagation();openLightbox(o.item.photoUrl,o.item.id)},style:{width:64,height:64,objectFit:"cover",borderRadius:10,cursor:"zoom-in"}}),
              React.createElement("div",{onClick:function(){setEditG(o.item)},style:{flex:1,cursor:"pointer"}},React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},o.l),React.createElement("div",{style:{display:"flex",alignItems:"center",gap:4}},React.createElement(Dot,{color:o.item.color}),React.createElement("span",{style:{fontSize:14,fontWeight:500}},o.item.name||(o.item.color+" "+o.item.garmentType))),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},o.item.garmentType+(o.item.pattern&&o.item.pattern!=="solid"?" Â· "+o.item.pattern:""))),
              React.createElement("button",{onClick:function(e){e.stopPropagation();setEditG(o.item)},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,flexShrink:0,minHeight:32}},"âœï¸ Edit"),
              React.createElement("button",{onClick:function(e){e.stopPropagation();setLockItem(o.item);setSelFit(null);setMode("auto")},style:{background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:9,flexShrink:0,minHeight:32}},"ðŸ”’ Lock")),
            swaps.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
              React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.08em",textTransform:"uppercase"}},"SWAP WITH"),
              React.createElement("div",{style:{display:"flex",gap:6,marginTop:4},className:"hscroll"},
                swaps.map(function(s){return React.createElement("div",{key:s.id,onClick:function(){
                  var newItems=(selFit.items||[]).map(function(it){return it.id===(o.slot==="top"?selFit.top:o.slot==="bot"?selFit.bot:selFit.shoe).id?s:it});
                  var newFit=makeOutfit(newItems,actW,effectiveCtx,reps,planWx,planTemp?planTemp.feels:18);
                  setSelFit(newFit);
                },style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:8,padding:"6px 10px",border:"1px solid var(--border)",flexShrink:0,cursor:"pointer",transition:"all .15s"},className:"card-lift"},
                  s.photoUrl&&React.createElement("img",{src:s.photoUrl,alt:"",style:{width:24,height:24,objectFit:"cover",borderRadius:4}}),
                  React.createElement(Dot,{color:s.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},s.name||s.color),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--gold)"}},s.ss))}))))}),
        React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"16px 0 10px"}},
          React.createElement("h2",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,letterSpacing:"0.14em",color:"var(--gold)",textTransform:"uppercase",margin:0}},"Watch Pairings"),
          React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},fitWatch?"Tap again to deselect":"Tap to choose")),
        fitWatch&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,background:"rgba(201,168,76,0.06)",border:"1px solid rgba(201,168,76,0.25)",borderRadius:10,padding:"8px 12px",marginBottom:8}},
          React.createElement("span",{style:{fontSize:18}},fitWatch.i),
          React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,flex:1}},"ðŸ”’ "+fitWatch.n),
          React.createElement("button",{onClick:function(){setFitWatch(null)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:9,minHeight:28}},"âœ• Clear")),
        React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:16}},(selFit.allW||selFit.watches).slice(0,6).map(function(w,i){
          return React.createElement("div",{key:w.id,onClick:function(){setFitWatch(fitWatch&&fitWatch.id===w.id?null:w)},style:{cursor:"pointer",border:fitWatch&&fitWatch.id===w.id?"2px solid var(--gold)":"2px solid transparent",borderRadius:14,transition:"all .15s"}},
            React.createElement(WCard,{w:w,rank:fitWatch?fitWatch.id===w.id?0:null:i,detail:true}))})),
        React.createElement("button",{className:"btn btn-gold",onClick:function(){
          /* If user selected a watch, reorder watches so selected is first */
          if(fitWatch){var reordered=[fitWatch].concat((selFit.allW||selFit.watches).filter(function(w){return w.id!==fitWatch.id}));var updFit=Object.assign({},selFit,{watches:reordered.slice(0,3)});saveFit(updFit)}else{saveFit(selFit)}
        }},"ðŸ’¾ Save Outfit")),

      /* â•â•â• INSIGHTS â•â•â• */
      view==="insights"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},

        /* 7-day weather strip */
        forecast.length>0&&React.createElement("div",{style:{marginBottom:14}},
          React.createElement("div",{style:{display:"flex",gap:4,overflowX:"auto",paddingBottom:4},className:"hscroll"},
            forecast.map(function(fc,i){
              var d=new Date(fc.date+"T12:00:00");var dn=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
              return React.createElement("div",{key:i,style:{flex:"0 0 auto",background:fc.cond&&fc.cond.rain?"rgba(100,150,220,0.06)":"var(--card)",border:"1px solid "+(fc.cond&&fc.cond.rain?"rgba(100,150,220,0.2)":"var(--border)"),borderRadius:10,padding:"6px 10px",minWidth:62,textAlign:"center"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",fontWeight:500}},i===0?"Today":dn),
                React.createElement("div",{style:{fontSize:16,margin:"2px 0"}},fc.cond?fc.cond.i:""),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",fontWeight:600}},fc.high+"Â°/"+fc.low+"Â°"),
                fc.rainPct>0&&React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:fc.rainPct>=50?"#7ab8d8":"var(--dim)"}},"ðŸ’§"+fc.rainPct+"%"))}))),

        /* â”€â”€ ONE-TAP DAILY PICK â”€â”€ */
        React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"âš¡"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600,color:"var(--gold)"}},"Today's Pick")),
          !dailyPick?React.createElement("button",{className:"btn btn-gold",onClick:function(){
            var cx0=weekCtx[new Date().getDay()]||"smart-casual";
            var rotation=genWeekRotation(actW,forecast,weekCtx,wd,reps,wearLog,rotLock);
            /* Apply alt swaps for today */
            if(altSwap[0]!=null&&rotation[0]&&rotation[0].altOutfits&&rotation[0].altOutfits[altSwap[0]]){
              var orig0=rotation[0].outfit;var origFs0=rotation[0].fs||rotation[0].altOutfits[altSwap[0]].fs;
              rotation[0].outfit=rotation[0].altOutfits[altSwap[0]];rotation[0].fs=rotation[0].altOutfits[altSwap[0]].fs;
              var na0=rotation[0].altOutfits.slice();na0[altSwap[0]]={top:orig0.top,bot:orig0.bot,shoe:orig0.shoe,fs:origFs0};rotation[0].altOutfits=na0;
            }
            var today=rotation[0];
            if(today&&today.watch){
              var sp=today.strapPick;
              setDailyPick({watch:today.watch,outfit:today.outfit,strap:sp,context:cx0,tier:tier});setPieceSwap(function(p){var n=Object.assign({},p);delete n["t-top"];delete n["t-bot"];delete n["t-shoe"];return n});setPiecePicker(null);
            }
          }},"âš¡ What Should I Wear?")
          :React.createElement("div",{className:"fu"},
            /* Watch */
            React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:12}},
              React.createElement("div",{style:{width:52,height:52,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:dailyPick.watch.c+"25",fontSize:26,border:"3px solid "+dailyPick.watch.c+"50"}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:18,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},dailyPick.watch.d+" Â· "+(dailyPick.strap&&dailyPick.strap.strap?((STRAP_TYPES.find(function(t){return t.id===dailyPick.strap.strap.type})||{icon:"ðŸ”—"}).icon+" "+(dailyPick.strap.strap.type==="bracelet"?"Bracelet ("+dailyPick.strap.strap.material+")":dailyPick.strap.strap.color+" "+dailyPick.strap.strap.type)):dailyPick.watch.br?"â›“ï¸ Bracelet":dailyPick.strap?dailyPick.strap.text:"Strap")+" Â· "+(CXI[dailyPick.context]||"")+dailyPick.context),
                !IS_SHARED&&dailyPick.watch.t==="replica"&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px",marginTop:2,display:"inline-block"}},"REP"))),
            /* Outfit with mannequin */
            dailyPick.outfit&&React.createElement("div",{style:{display:"flex",gap:12,marginBottom:12,alignItems:"flex-start"}},
              React.createElement(OutfitFigure,{topColor:getEP("t","top",dailyPick.outfit.top)?getEP("t","top",dailyPick.outfit.top).color:"grey",botColor:getEP("t","bot",dailyPick.outfit.bot)?getEP("t","bot",dailyPick.outfit.bot).color:"charcoal",shoeColor:getEP("t","shoe",dailyPick.outfit.shoe)?getEP("t","shoe",dailyPick.outfit.shoe).color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:dailyPick.watch.n,size:110}),
              React.createElement("div",{style:{flex:1,display:"flex",flexDirection:"column",gap:6}},
                [{l:"TOP",slot:"top",item:getEP("t","top",dailyPick.outfit.top)},{l:"BTM",slot:"bot",item:getEP("t","bot",dailyPick.outfit.bot)},{l:"SHOE",slot:"shoe",item:getEP("t","shoe",dailyPick.outfit.shoe)}].map(function(o){
                  if(!o.item)return null;
                  var pk="t-"+o.slot;var isOpen=piecePicker===pk;var isSwapped=!!pieceSwap[pk];
                  return React.createElement("div",{key:o.l},
                    React.createElement("div",{style:{background:isSwapped?"rgba(201,168,76,0.06)":"var(--bg)",borderRadius:10,overflow:"hidden",border:isSwapped?"1px solid rgba(201,168,76,0.25)":"1px solid var(--border)",cursor:"pointer"},onClick:function(ev){ev.stopPropagation();setPiecePicker(isOpen?null:pk);setPieceFilter(null)}},
                      o.item.photoUrl?React.createElement("img",{src:o.item.photoUrl,alt:"",style:{width:"100%",height:64,objectFit:"cover",display:"block"}}):React.createElement("div",{style:{width:"100%",height:40,background:(CM[o.item.color]||{}).h||"#3a3a3a"}}),
                      React.createElement("div",{style:{padding:"5px 8px",display:"flex",alignItems:"center",gap:4}},
                        React.createElement(Dot,{color:o.item.color,size:6}),
                        React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:isSwapped?"var(--gold)":"var(--text)",fontWeight:500}},o.item.name||o.item.color),
                        React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:"auto"}},o.l+(isSwapped?" âœŽ":"")),
                        React.createElement("span",{style:{fontSize:10,color:"var(--dim)",marginLeft:4}},isOpen?"â–²":"ðŸ”„"))),
                    isOpen&&React.createElement(React.Fragment,null,
                    React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"4px 0 6px",marginBottom:2},onClick:function(ev){ev.stopPropagation()}},
                      [null].concat(slotAlts(o.slot).reduce(function(acc,it){if(acc.indexOf(it.color)===-1)acc.push(it.color);return acc},[])).map(function(fc){
                        var label=fc?fc.charAt(0).toUpperCase()+fc.slice(1):"All";var cnt=slotAlts(o.slot).filter(function(a){return !a.id||(fc===null||a.color===fc)}).length;
                        var isActive=pieceFilter===fc;
                        return React.createElement("button",{key:label,onClick:function(){setPieceFilter(isActive?null:fc)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400}},fc?React.createElement(React.Fragment,null,React.createElement(Dot,{color:fc,size:5})," ",label," (",slotAlts(o.slot).filter(function(x){return x.color===fc}).length,")"):label)})),
                    slotPatterns(o.slot).length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",padding:"2px 0 4px"},onClick:function(ev){ev.stopPropagation()}},
                      slotPatterns(o.slot).map(function(pt){
                        var isActive=pieceFilter==="p:"+pt;
                        return React.createElement("button",{key:pt,onClick:function(){setPieceFilter(isActive?null:"p:"+pt)},style:{background:isActive?"var(--gold)":"var(--bg)",color:isActive?"var(--bg)":"var(--sub)",border:"1px solid "+(isActive?"var(--gold)":"var(--border)"),borderRadius:12,padding:"2px 8px",fontSize:8,fontFamily:"var(--f)",cursor:"pointer",fontWeight:isActive?600:400,fontStyle:"italic"}},pt," (",slotAlts(o.slot).filter(function(x){return x.pattern===pt}).length,")")})),
                    React.createElement("div",{style:{display:"flex",gap:6,overflowX:"auto",padding:"6px 0",WebkitOverflowScrolling:"touch"},onClick:function(ev){ev.stopPropagation()}},
                      isSwapped&&React.createElement("div",{onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);delete n[pk];return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 8px",borderRadius:8,border:"1px solid var(--del-border)",cursor:"pointer",minWidth:52}},
                        React.createElement("span",{style:{fontSize:14}},"â†©ï¸"),
                        React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--del-text)"}},"Reset")),
                      (function(){var _fa=filteredAlts(o.slot,o.item&&o.item.id);return _fa.length===0?[React.createElement("div",{key:"_empty",style:{flexShrink:0,padding:"8px 12px",color:"var(--dim)",fontSize:8,fontFamily:"var(--f)",fontStyle:"italic",whiteSpace:"nowrap"}},"No matches")]:_fa})().map(function(alt){
                        return React.createElement("div",{key:alt.id,onClick:function(){setPieceSwap(function(p){var n=Object.assign({},p);n[pk]=alt;return n});setPiecePicker(null)},style:{flexShrink:0,display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"4px 6px",borderRadius:8,border:"1px solid var(--border)",cursor:"pointer",minWidth:52,maxWidth:64}},
                          alt.photoUrl?React.createElement("img",{src:alt.photoUrl,alt:"",style:{width:40,height:40,objectFit:"cover",borderRadius:6}}):React.createElement("div",{style:{width:40,height:40,borderRadius:6,background:(CM[alt.color]||{}).h||"#3a3a3a"}}),
                          React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--sub)",textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:56}},alt.name||alt.color))}))))}))),
            /* Actions */
            React.createElement("div",{style:{display:"flex",gap:8}},
              !todayWorn&&React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){logWear(dailyPick.watch.id,todayStr)}},"âœ“ Wearing This"),
              todayWorn&&React.createElement("span",{style:{flex:1,textAlign:"center",fontSize:12,fontFamily:"var(--f)",color:"var(--good)",padding:14}},"âœ“ Logged"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setDailyPick(null);setAiCritique(null);setPieceSwap(function(p){var n=Object.assign({},p);delete n["t-top"];delete n["t-bot"];delete n["t-shoe"];return n});setPiecePicker(null)}},"â†»")))),

        /* â”€â”€ AI OUTFIT CRITIQUE â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ§ "),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Critique")),
          dailyPick&&dailyPick.outfit&&dailyPick.watch?React.createElement("div",null,
            !aiCritique&&!aiLoading&&React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiLoading(true);
              var result=await aiVision(dailyPick.outfit,dailyPick.watch,dailyPick.context,apiKeyRef.current);
              if(result)setAiCritique(result);else setAiCritique({vision:"AI unavailable. Check your API key in settings.",impact:0,impact_why:"",works:"",risk:"",strap_call:""});
              setAiLoading(false);
            }},"ðŸ§  Critique Today's Pick"),
            aiLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing...")),
            aiCritique&&React.createElement("div",{className:"fu"},
              /* Vision */
              aiCritique.vision&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,borderLeft:"3px solid var(--gold)"}},
                React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiCritique.vision)),
              /* Impact score */
              aiCritique.impact>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:10}},
                React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiCritique.impact>=7?"rgba(122,184,122,0.15)":aiCritique.impact>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact),
                React.createElement("div",{style:{flex:1}},
                  React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact>=8?"Commanding":aiCritique.impact>=6?"Solid":aiCritique.impact>=4?"Acceptable":"Needs Work"),
                  aiCritique.impact_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},aiCritique.impact_why))),
              /* Details */
              [aiCritique.color_story&&{l:"ðŸŽ¨ Colors",t:aiCritique.color_story,c:"#9a8abc"},aiCritique.works&&{l:"âœ“ What Works",t:aiCritique.works,c:"var(--good)"},aiCritique.risk&&{l:"âš  Risk",t:aiCritique.risk,c:"var(--warn)"},aiCritique.upgrade&&{l:"â¬† Upgrade",t:aiCritique.upgrade,c:"var(--gold)"},aiCritique.strap_call&&{l:"ðŸ”— Strap Call",t:aiCritique.strap_call,c:"var(--sub)"}].filter(Boolean).map(function(item,i){
                return React.createElement("div",{key:i,style:{display:"flex",gap:8,marginBottom:6}},
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:item.c,fontWeight:600,minWidth:70}},item.l),
                  React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},item.t))}),
              React.createElement("button",{className:"btn btn-ghost",style:{marginTop:8,fontSize:11},onClick:function(){setAiCritique(null)}},"â†» Re-critique")))
          :React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Generate Today's Pick first â†‘")),

        /* â”€â”€ VISUAL OUTFIT CARD â”€â”€ */
        dailyPick&&dailyPick.outfit&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ´"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Outfit Card")),
          /* The card itself */
          React.createElement("div",{id:"outfit-card",style:{background:"linear-gradient(145deg,var(--card),var(--card2))",borderRadius:16,padding:"20px",border:"1px solid rgba(201,168,76,0.2)",maxWidth:340,margin:"0 auto"}},
            /* Date + context header */
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,letterSpacing:"0.12em"}},new Date().toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}).toUpperCase()),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},(CXI[dailyPick.context]||"")+" "+dailyPick.context)),
            /* Mannequin + Color blocks */
            React.createElement("div",{style:{display:"flex",gap:12,marginBottom:16,alignItems:"center"}},
              React.createElement(OutfitFigure,{topColor:getEP("t","top",dailyPick.outfit.top)?getEP("t","top",dailyPick.outfit.top).color:"grey",botColor:getEP("t","bot",dailyPick.outfit.bot)?getEP("t","bot",dailyPick.outfit.bot).color:"charcoal",shoeColor:getEP("t","shoe",dailyPick.outfit.shoe)?getEP("t","shoe",dailyPick.outfit.shoe).color:"black",watchColor:dailyPick.watch.c,watchIcon:dailyPick.watch.i,watchName:"",size:90}),
              React.createElement("div",{style:{flex:1,display:"flex",gap:4,height:120}},
                [dailyPick.outfit.top,dailyPick.outfit.bot,dailyPick.outfit.shoe].filter(Boolean).map(function(item,i){
                  return React.createElement("div",{key:i,style:{flex:1,borderRadius:10,overflow:"hidden",position:"relative"}},
                    item.photoUrl?React.createElement("img",{src:item.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):React.createElement("div",{style:{width:"100%",height:"100%",background:(CM[item.color]||{}).h||"#3a3a3a"}}),
                    React.createElement("div",{style:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent,rgba(0,0,0,0.7))",padding:"4px 6px"}},
                      React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#fff"}},["TOP","BTM","SHOE"][i])))}))),
            /* Watch row */
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,background:"rgba(201,168,76,0.06)",borderRadius:10,padding:"10px 12px"}},
              React.createElement("span",{style:{fontSize:24}},dailyPick.watch.i),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:14,fontWeight:600,color:"var(--gold)"}},dailyPick.watch.n),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},dailyPick.watch.d+" Â· "+(dailyPick.strap&&dailyPick.strap.strap?((STRAP_TYPES.find(function(t){return t.id===dailyPick.strap.strap.type})||{icon:"ðŸ”—"}).icon+" "+(dailyPick.strap.strap.type==="bracelet"?"Bracelet":dailyPick.strap.strap.color+" "+dailyPick.strap.strap.type)):dailyPick.watch.br?"â›“ï¸ Bracelet":dailyPick.strap?dailyPick.strap.text:"Strap"))),
              aiCritique&&aiCritique.impact>0&&React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"),fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:aiCritique.impact>=7?"var(--good)":aiCritique.impact>=4?"var(--gold)":"var(--warn)"}},aiCritique.impact)),
            React.createElement("div",{style:{textAlign:"center",marginTop:12}},
              React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--border)",letterSpacing:"0.2em"}},"WATCH ADVISOR")))),

        /* â”€â”€ AI STYLE COACH â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ“"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Style Coach")),
          !aiCoach&&!aiCoachLoading&&React.createElement("div",null,
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Get personalized style advice based on your entire wardrobe and watch collection."),
            React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiCoachLoading(true);
              var result=await aiStyleCoach(wd,actW,ctx,apiKeyRef.current);
              setAiCoach(result||{summary:"AI unavailable. Check your API key in settings.",strengths:[],gaps:[],next_buys:[],style_tip:"",versatility:0});
              setAiCoachLoading(false);
            }},"ðŸŽ“ Get Style Advice")),
          aiCoachLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Analyzing your wardrobe...")),
          aiCoach&&React.createElement("div",{className:"fu"},
            aiCoach.versatility>0&&React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12}},
              React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiCoach.versatility>=7?"rgba(122,184,122,0.15)":aiCoach.versatility>=4?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"2px solid "+(aiCoach.versatility>=7?"var(--good)":aiCoach.versatility>=4?"var(--gold)":"var(--warn)"),fontSize:18,fontFamily:"var(--f)",fontWeight:700,color:aiCoach.versatility>=7?"var(--good)":aiCoach.versatility>=4?"var(--gold)":"var(--warn)"}},aiCoach.versatility+"/10"),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:"var(--gold)"}},"Versatility Score"),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},aiCoach.versatility>=8?"Exceptional range":"Room to grow"))),
            aiCoach.summary&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:12,borderLeft:"3px solid var(--gold)"}},
              React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiCoach.summary)),
            aiCoach.strengths&&aiCoach.strengths.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:6}},"âœ“ STRENGTHS"),
              aiCoach.strengths.map(function(s,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},"â€¢ "+s)})),
            aiCoach.gaps&&aiCoach.gaps.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"âš  GAPS"),
              aiCoach.gaps.map(function(g,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},"â€¢ "+g)})),
            aiCoach.next_buys&&aiCoach.next_buys.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"ðŸ›ï¸ NEXT BUYS"),
              aiCoach.next_buys.map(function(b,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"4px 0",borderBottom:"1px solid var(--border)"}},(i+1)+". "+b)})),
            aiCoach.signature_combos&&aiCoach.signature_combos.length>0&&React.createElement("div",{style:{marginBottom:10}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6}},"ðŸ”¥ SIGNATURE COMBINATIONS"),
              aiCoach.signature_combos.map(function(c,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"6px 8px",marginBottom:4,background:"rgba(201,168,76,0.04)",borderRadius:6,border:"1px solid rgba(201,168,76,0.1)",borderLeft:"3px solid var(--gold)"}},(i+1)+". "+c)})),
            aiCoach.seasonal_weak&&React.createElement("div",{style:{background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 12px",marginBottom:8,border:"1px solid rgba(200,90,58,0.15)"}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"ðŸ“… Seasonal Gap: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiCoach.seasonal_weak)),
            aiCoach.style_tip&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"10px 12px",marginTop:8,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"ðŸ’¡ Pro Tip: "),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiCoach.style_tip)),
            React.createElement("button",{className:"btn btn-ghost",style:{marginTop:10,fontSize:10},onClick:function(){setAiCoach(null)}},"â†» Re-analyze"))),

        /* â”€â”€ AI OCCASION PLANNER â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ¯"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Occasion Planner")),
          React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Describe an event or occasion and get outfit recommendations from your wardrobe."),
          React.createElement("input",{className:"inp",value:aiOccasionInput,onChange:function(e){setAiOccasionInput(e.target.value)},placeholder:"e.g. Business dinner, Beach wedding, First date at rooftop bar...",style:{marginBottom:10,fontSize:12}}),
          React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:10}},
            ["Business Dinner","Date Night","Wedding Guest","Casual Friday","Cocktail Party","Weekend Brunch"].map(function(sug){
              return React.createElement("span",{key:sug,className:"chip",onClick:function(){setAiOccasionInput(sug)},style:{fontSize:9}},sug)})),
          !aiOccasion&&!aiOccasionLoading&&React.createElement("button",{className:"btn btn-gold",onClick:async function(){
            if(!aiOccasionInput.trim()){alert("Describe an occasion first");return}
            setAiOccasionLoading(true);
            var result=await aiOccasionPlan(aiOccasionInput.trim(),wd,actW,apiKeyRef.current);
            setAiOccasion(result||{occasion_tips:"AI unavailable. Check your API key in settings.",outfits:[],avoid:""});
            setAiOccasionLoading(false);
          }},"ðŸŽ¯ Plan My Outfit"),
          aiOccasionLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Planning outfit...")),
          aiOccasion&&React.createElement("div",{className:"fu"},
            aiOccasion.occasion_tips&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:12,borderLeft:"3px solid var(--gold)"}},
              React.createElement("p",{style:{fontSize:12,fontFamily:"var(--sf)",fontStyle:"italic",lineHeight:1.6,color:"var(--text)"}},aiOccasion.occasion_tips)),
            aiOccasion.outfits&&aiOccasion.outfits.map(function(outfit,oi){
              return React.createElement("div",{key:oi,style:{background:"var(--bg)",borderRadius:10,padding:"12px",marginBottom:10,border:"1px solid "+(oi===0?"rgba(201,168,76,0.3)":"var(--border)")}},
                React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
                  React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",fontWeight:600,color:oi===0?"var(--gold)":"var(--text)"}},outfit.name),
                  outfit.confidence&&React.createElement("div",{style:{width:28,height:28,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(outfit.confidence>=7?"var(--good)":"var(--gold)"),fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:outfit.confidence>=7?"var(--good)":"var(--gold)"}},outfit.confidence)),
                React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,marginBottom:6}},
                  [{l:"ðŸ‘• Top",v:outfit.top},{l:"ðŸ‘– Bottom",v:outfit.bottom},{l:"ðŸ‘ž Shoes",v:outfit.shoes},{l:"âŒš Watch",v:outfit.watch},outfit.layers&&{l:"ðŸ§¥ Layers",v:outfit.layers}].filter(Boolean).map(function(p,pi){
                    return React.createElement("div",{key:pi,style:{display:"flex",gap:8,fontSize:10,fontFamily:"var(--f)"}},
                      React.createElement("span",{style:{color:"var(--dim)",minWidth:55}},p.l),
                      React.createElement("span",{style:{color:"var(--text)",fontWeight:500}},p.v))})),
                outfit.why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",fontStyle:"italic",marginTop:4}},outfit.why))}),
            aiOccasion.avoid&&React.createElement("div",{style:{background:"rgba(200,90,58,0.06)",borderRadius:8,padding:"8px 12px",border:"1px solid rgba(200,90,58,0.15)",marginBottom:8}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"âŒ Avoid: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiOccasion.avoid)),
            aiOccasion.power_move&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"8px 12px",border:"1px solid rgba(201,168,76,0.2)",marginBottom:8}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"âš¡ Power Move: "),
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--text)"}},aiOccasion.power_move)),
            React.createElement("button",{className:"btn btn-ghost",style:{fontSize:10},onClick:function(){setAiOccasion(null)}},"â†» Try Again"))),

        /* â”€â”€ AI WARDROBE AUDIT â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ“‹"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"AI Wardrobe Audit")),
          !aiAudit&&!aiAuditLoading&&React.createElement("div",null,
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Comprehensive AI analysis of your entire wardrobe â€” grading, seasonal readiness, and investment recommendations."),
            React.createElement("button",{className:"btn btn-gold",onClick:async function(){
              setAiAuditLoading(true);
              var result=await aiWardrobeAudit(wd,actW,saved,wearLog,apiKeyRef.current);
              setAiAudit(result||{grade:"?",grade_why:"AI unavailable. Check your API key in settings."});
              setAiAuditLoading(false);
            }},"ðŸ“‹ Run Full Audit")),
          aiAuditLoading&&React.createElement("div",{style:{textAlign:"center",padding:20}},React.createElement("div",{className:"sp",style:{width:20,height:20,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),React.createElement("span",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--gold)"}},"Auditing wardrobe...")),
          aiAudit&&React.createElement("div",{className:"fu"},
            /* Grade */
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:14,marginBottom:14}},
              React.createElement("div",{style:{width:56,height:56,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:aiAudit.grade==="A"||aiAudit.grade==="A+"?"rgba(122,184,122,0.15)":aiAudit.grade==="B"?"rgba(201,168,76,0.15)":"rgba(200,90,58,0.15)",border:"3px solid "+(aiAudit.grade==="A"||aiAudit.grade==="A+"?"var(--good)":aiAudit.grade==="B"?"var(--gold)":"var(--warn)"),fontSize:22,fontFamily:"var(--f)",fontWeight:700,color:aiAudit.grade==="A"||aiAudit.grade==="A+"?"var(--good)":aiAudit.grade==="B"?"var(--gold)":"var(--warn)"}},aiAudit.grade),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)"}},"Wardrobe Grade"),
                aiAudit.grade_why&&React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginTop:2}},aiAudit.grade_why))),
            /* Details */
            [aiAudit.color_harmony&&{l:"ðŸŽ¨ Color Harmony",t:aiAudit.color_harmony},aiAudit.versatility&&{l:"ðŸ”„ Versatility",t:aiAudit.versatility},aiAudit.cost_efficiency&&{l:"ðŸ’° Efficiency",t:aiAudit.cost_efficiency},aiAudit.watch_wardrobe_synergy&&{l:"âŒš Watch Synergy",t:aiAudit.watch_wardrobe_synergy}].filter(Boolean).map(function(d,i){
              return React.createElement("div",{key:i,style:{background:"var(--bg)",borderRadius:8,padding:"10px 12px",marginBottom:6,border:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:3}},d.l),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},d.t))}),
            /* Seasonal scores */
            aiAudit.seasonal_score&&React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:10,marginTop:8}},
              [{s:"spring",i:"ðŸŒ¸"},{s:"summer",i:"â˜€ï¸"},{s:"fall",i:"ðŸ‚"},{s:"winter",i:"â„ï¸"}].map(function(sn){
                var sc=aiAudit.seasonal_score[sn.s]||0;
                return React.createElement("div",{key:sn.s,style:{textAlign:"center",background:"var(--bg)",borderRadius:8,padding:"8px 4px",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:16}},sn.i),
                  React.createElement("div",{style:{fontSize:16,fontFamily:"var(--f)",fontWeight:700,color:sc>=7?"var(--good)":sc>=4?"var(--gold)":"var(--warn)"}},sc+"/10"),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textTransform:"capitalize"}},sn.s))})),
            /* Declutter + Invest */
            aiAudit.declutter&&aiAudit.declutter.length>0&&React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:4}},"ðŸ§¹ Consider Decluttering"),
              aiAudit.declutter.map(function(d,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"3px 0"}},"â€¢ "+d)})),
            aiAudit.invest&&aiAudit.invest.length>0&&React.createElement("div",{style:{marginBottom:8}},
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--good)",fontWeight:600,marginBottom:4}},"ðŸ’Ž Worth Investing In"),
              aiAudit.invest.map(function(d,i){return React.createElement("div",{key:i,style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)",padding:"3px 0"}},"â€¢ "+d)})),
            aiAudit.style_identity&&React.createElement("div",{style:{background:"var(--bg)",borderRadius:8,padding:"10px 12px",marginBottom:8,border:"1px solid var(--border)"}},
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:3}},"ðŸŽ­ Style Identity"),
              React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiAudit.style_identity)),
            aiAudit.pro_tip&&React.createElement("div",{style:{background:"rgba(201,168,76,0.06)",borderRadius:8,padding:"10px 12px",marginTop:8,border:"1px solid rgba(201,168,76,0.2)"}},
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"ðŸ’¡ "),
              React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--text)"}},aiAudit.pro_tip)),
            React.createElement("button",{className:"btn btn-ghost",style:{marginTop:10,fontSize:10},onClick:function(){setAiAudit(null)}},"â†» Re-audit"))),

        /* â”€â”€ COLLECTION HEATMAP â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ—ºï¸"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Context Coverage")),
          React.createElement("div",{style:{overflowX:"auto"},className:"hscroll"},
            React.createElement("div",{style:{minWidth:Math.max(500,activeCxIds.slice(0,8).length*60+120)}},
              /* Header row */
              React.createElement("div",{style:{display:"flex",gap:2,marginBottom:4,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)",letterSpacing:"0.05em"}},(activeCxIcons[cx]||CXI[cx]||"")+"\n"+cx)})),
              /* Watch rows */
              actW.slice(0,20).map(function(w){
                return React.createElement("div",{key:w.id,style:{display:"flex",gap:2,marginBottom:2,alignItems:"center"}},
                  React.createElement("div",{style:{flex:"0 0 108px",display:"flex",alignItems:"center",gap:4,overflow:"hidden"}},
                    React.createElement("span",{style:{fontSize:12}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},w.n)),
                  activeCxIds.slice(0,8).map(function(cx){
                    var inCtx=(w.cx||[]).includes(cx);
                    var colorScore=0;
                    (w.mc||[]).forEach(function(mc){if(["navy","charcoal","white","cream","black","grey"].includes(mc))colorScore++});
                    var heat=inCtx?(colorScore>4?3:colorScore>2?2:1):0;
                    var bg=heat===3?"rgba(122,184,122,0.4)":heat===2?"rgba(122,184,122,0.2)":heat===1?"rgba(201,168,76,0.15)":"var(--card)";
                    return React.createElement("div",{key:cx,style:{flex:"0 0 52px",height:20,borderRadius:3,background:bg,border:"1px solid "+(inCtx?"rgba(122,184,122,0.15)":"var(--border)")}})}))}),
              /* Coverage summary */
              React.createElement("div",{style:{display:"flex",gap:2,marginTop:8,paddingLeft:110}},
                activeCxIds.slice(0,8).map(function(cx){
                  var count=actW.filter(function(w){return(w.cx||[]).includes(cx)}).length;
                  var pct=actW.length?Math.round(count/actW.length*100):0;
                  return React.createElement("div",{key:cx,style:{flex:"0 0 52px",textAlign:"center"}},
                    React.createElement("div",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:700,color:count>=5?"var(--good)":count>=3?"var(--gold)":"var(--warn)"}},count),
                    React.createElement("div",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},pct+"%"))})),
              /* Legend */
              React.createElement("div",{style:{display:"flex",gap:12,marginTop:10,paddingLeft:110}},
                [{c:"rgba(122,184,122,0.4)",l:"Strong"},{c:"rgba(122,184,122,0.2)",l:"Good"},{c:"rgba(201,168,76,0.15)",l:"Basic"},{c:"var(--card)",l:"None"}].map(function(lg){
                  return React.createElement("div",{key:lg.l,style:{display:"flex",alignItems:"center",gap:4}},
                    React.createElement("div",{style:{width:12,height:12,borderRadius:2,background:lg.c,border:"1px solid var(--border)"}}),
                    React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},lg.l))})))),

        /* â”€â”€ WARDROBE COLOR WHEEL â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸŽ¨"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Color Distribution")),
          (function(){
            /* Count colors across wardrobe */
            var colorCounts={};
            wd.filter(function(i){return i.color}).forEach(function(i){var c=i.color.toLowerCase();colorCounts[c]=(colorCounts[c]||0)+1});
            var sorted=Object.entries(colorCounts).sort(function(a,b){return b[1]-a[1]});
            var total=wd.filter(function(i){return i.color}).length||1;
            /* Watch dial colors */
            var watchColors={};
            actW.forEach(function(w){var d=(w.d||"").toLowerCase();watchColors[d]=(watchColors[d]||0)+1});
            var wSorted=Object.entries(watchColors).sort(function(a,b){return b[1]-a[1]});
            /* Temperature balance */
            var warm=0,cool=0,neutral=0;
            sorted.forEach(function(e){var t=(CM[e[0]]||{}).t;if(t==="warm")warm+=e[1];else if(t==="cool")cool+=e[1];else neutral+=e[1]});
            return React.createElement("div",null,
              /* Color bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var pct=Math.round(e[1]/total*100);
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
                    React.createElement(Dot,{color:e[0],size:12}),
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",minWidth:70}},e[0]),
                    React.createElement("div",{style:{flex:1,height:14,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:(CM[e[0]]||{}).h||"#5a5a5a",borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:24,textAlign:"right"}},e[1]))})),
              /* Temp balance */
              React.createElement("div",{style:{display:"flex",gap:4,marginBottom:14}},
                [{l:"Warm",v:warm,c:"#d87a2a"},{l:"Cool",v:cool,c:"#2a5a9a"},{l:"Neutral",v:neutral,c:"#8a8a8a"}].map(function(t){
                  var pct=Math.round(t.v/total*100);
                  return React.createElement("div",{key:t.l,style:{flex:t.v||1,background:t.c+"30",borderRadius:8,padding:"8px 10px",textAlign:"center",border:"1px solid "+t.c+"20"}},
                    React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:t.c}},pct+"%"),
                    React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},t.l))})),
              /* Watch dials */
              wSorted.length>0&&React.createElement("div",null,
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WATCH DIAL COLORS"),
                React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
                  wSorted.map(function(e){return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},
                    React.createElement("span",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},e[0]),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600}},"Ã—"+e[1]))}))));
          })())),

        /* â”€â”€ SEASONAL CLOSET GAPS â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ“…"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Seasonal Readiness")),
          (function(){
            var seasons=["spring","summer","fall","winter"];var icons={spring:"ðŸŒ¸",summer:"â˜€ï¸",fall:"ðŸ‚",winter:"â„ï¸"};
            var cats=["tops","bottoms","shoes"];
            var data=seasons.map(function(s){
              var counts={};cats.forEach(function(cat){
                counts[cat]=wd.filter(function(i){return catOf(i.garmentType)===cat&&i.color&&(!i.seasons||!i.seasons.length||i.seasons.length>=4||i.seasons.includes(s))}).length;
              });
              var total=counts.tops+counts.bottoms+counts.shoes;
              var ready=counts.tops>=2&&counts.bottoms>=2&&counts.shoes>=1;
              return{s:s,icon:icons[s],counts:counts,total:total,ready:ready};
            });
            var curSn=(function(){var m=new Date().getMonth();if(m>=2&&m<=4)return"spring";if(m>=5&&m<=7)return"summer";if(m>=8&&m<=10)return"fall";return"winter"})();
            return React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
              data.map(function(d){
                return React.createElement("div",{key:d.s,style:{background:d.s===curSn?"rgba(201,168,76,0.06)":"var(--bg)",border:"1px solid "+(d.s===curSn?"rgba(201,168,76,0.3)":"var(--border)"),borderRadius:10,padding:"10px 12px"}},
                  React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:6}},
                    React.createElement("span",{style:{fontSize:16}},d.icon),
                    React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",fontWeight:600,color:d.s===curSn?"var(--gold)":"var(--text)",textTransform:"capitalize"}},d.s),
                    d.s===curSn&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"var(--gold)",background:"rgba(201,168,76,0.15)",borderRadius:3,padding:"1px 5px"}},"NOW"),
                    React.createElement("span",{style:{marginLeft:"auto",fontSize:10,color:d.ready?"var(--good)":"var(--warn)"}},d.ready?"âœ“":"âš ")),
                  React.createElement("div",{style:{display:"flex",gap:4}},
                    [{l:"ðŸ‘•",v:d.counts.tops,min:2},{l:"ðŸ‘–",v:d.counts.bottoms,min:2},{l:"ðŸ‘ž",v:d.counts.shoes,min:1}].map(function(c,ci){
                      return React.createElement("div",{key:ci,style:{flex:1,textAlign:"center",borderRadius:6,padding:"4px 2px",background:c.v>=c.min?"rgba(122,184,122,0.1)":"rgba(200,90,58,0.08)",border:"1px solid "+(c.v>=c.min?"rgba(122,184,122,0.15)":"rgba(200,90,58,0.15)")}},
                        React.createElement("div",{style:{fontSize:10}},c.l),
                        React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:700,color:c.v>=c.min?"var(--good)":"var(--warn)"}},c.v))})));
              }));
          })()),

        /* â”€â”€ COLOR GAP ANALYSIS â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ”"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Color Gap Analysis")),
          (function(){
            /* Find colors needed by watches but missing from wardrobe */
            var wdColors={};wd.filter(function(i){return i.color}).forEach(function(i){wdColors[i.color.toLowerCase()]=true});
            var needed={};actW.forEach(function(w){(w.mc||[]).forEach(function(c){if(c!=="anything"&&!wdColors[c])needed[c]=(needed[c]||0)+1})});
            var gaps=Object.entries(needed).sort(function(a,b){return b[1]-a[1]}).slice(0,8);
            if(!gaps.length)return React.createElement("div",{style:{textAlign:"center",padding:10}},
              React.createElement("span",{style:{fontSize:12}},"âœ“"),
              React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--good)",margin:"4px 0 0"}},"Great coverage! Your wardrobe has colors for all your watches."));
            return React.createElement("div",null,
              React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Colors your watches want but your wardrobe doesn't have:"),
              React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:6}},
                gaps.map(function(g){
                  var matchingWatches=actW.filter(function(w){return(w.mc||[]).includes(g[0])}).slice(0,3);
                  return React.createElement("div",{key:g[0],style:{display:"flex",alignItems:"center",gap:8,background:"var(--bg)",borderRadius:8,padding:"8px 10px",border:"1px solid rgba(200,90,58,0.15)"}},
                    React.createElement(Dot,{color:g[0],size:14}),
                    React.createElement("div",{style:{flex:1,minWidth:0}},
                      React.createElement("div",{style:{fontSize:11,fontFamily:"var(--f)",fontWeight:600,color:"var(--text)",textTransform:"capitalize"}},g[0]),
                      React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Needed by "+matchingWatches.map(function(w){return w.i+" "+w.n}).join(", "))),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,flexShrink:0}},g[1]+" watch"+(g[1]>1?"es":"")))})));
          })()),

        /* â”€â”€ WATCH PAIRING SUGGESTIONS â”€â”€ */
        actW.length>0&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"âŒš"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Watch Pairing Guide")),
          React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:10}},"Best garment colors for each watch, based on your wardrobe:"),
          actW.slice(0,8).map(function(w){
            /* Find best matching garments from wardrobe */
            var scored=wd.filter(function(i){return i.color&&!i.needsEdit}).map(function(i){
              var ic=i.color.toLowerCase().trim();var s=0;
              for(var m of(w.mc||[])){if(m==="anything"||ic.includes(m)||m.includes(ic)){s+=3;break}}
              for(var a of(w.ac||[])){if(ic.includes(a)||a.includes(ic)){s-=3;break}}
              var wt=(CM[ic]||{}).t||"neutral";if(w.mt===wt)s+=1;
              return{g:i,s:s};
            }).filter(function(x){return x.s>0}).sort(function(a,b){return b.s-a.s}).slice(0,4);
            var missingColors=(w.mc||[]).filter(function(mc){return mc!=="anything"&&!wd.some(function(i){return i.color&&i.color.toLowerCase()===mc})}).slice(0,3);
            return React.createElement("div",{key:w.id,style:{background:"var(--bg)",borderRadius:10,padding:"10px 12px",marginBottom:6,border:"1px solid var(--border)"}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
                React.createElement("div",{style:{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.c+"18",fontSize:16,flexShrink:0}},w.i),
                React.createElement("div",{style:{flex:1,minWidth:0}},
                  React.createElement("span",{style:{fontSize:12,fontWeight:600}},w.n),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",marginLeft:6}},w.d+" Â· "+(w.straps&&w.straps.length?w.straps.length+" strap"+(w.straps.length>1?"s":""):w.br?"Bracelet":"Strap")))),
              scored.length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:missingColors.length?6:0}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--good)",alignSelf:"center"}},"âœ“ Best:"),
                scored.map(function(x){return React.createElement("div",{key:x.g.id,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(122,184,122,0.06)",borderRadius:6,padding:"3px 8px",border:"1px solid rgba(122,184,122,0.15)"}},
                  React.createElement(Dot,{color:x.g.color,size:5}),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--text)"}},x.g.name||x.g.color))})),
              missingColors.length>0&&React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
                React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)",alignSelf:"center"}},"+ Need:"),
                missingColors.map(function(mc){return React.createElement("div",{key:mc,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(200,90,58,0.06)",borderRadius:6,padding:"3px 8px",border:"1px solid rgba(200,90,58,0.15)"}},
                  React.createElement(Dot,{color:mc,size:5}),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--sub)"}},mc))})));
          })),

        /* â”€â”€ GARMENT ROTATION STATS â”€â”€ */
        wd.some(function(i){return i.lastWorn})&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ‘”"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Garment Rotation")),
          (function(){
            var now=Date.now();var tracked=wd.filter(function(i){return i.lastWorn&&i.color});
            if(!tracked.length)return null;
            /* Sort by stalest first */
            var sorted=tracked.map(function(i){return{g:i,d:Math.floor((now-new Date(i.lastWorn).getTime())/864e5)}}).sort(function(a,b){return b.d-a.d});
            var maxD=sorted[0].d||1;
            return React.createElement("div",null,
              React.createElement("div",{style:{display:"flex",gap:8,fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:8}},
                React.createElement("span",null,"ðŸ“ "+tracked.length+" garments tracked"),
                React.createElement("span",null,"Avg "+Math.round(sorted.reduce(function(a,b){return a+b.d},0)/sorted.length)+"d between wears")),
              sorted.slice(0,8).map(function(e){
                var pct=Math.round(e.d/maxD*100);
                var col=e.d<=2?"var(--warn)":e.d<=7?"var(--gold)":e.d<=14?"var(--sub)":"var(--good)";
                return React.createElement("div",{key:e.g.id,style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                  e.g.photoUrl?React.createElement("img",{src:e.g.photoUrl,alt:"",style:{width:18,height:18,objectFit:"cover",borderRadius:3,flexShrink:0}}):React.createElement(Dot,{color:e.g.color,size:8}),
                  React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},e.g.name||e.g.color),
                  React.createElement("div",{style:{flex:1,height:8,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                    React.createElement("div",{style:{height:"100%",width:pct+"%",background:col,borderRadius:4,minWidth:2}})),
                  React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:col,minWidth:32,textAlign:"right"}},e.d===0?"today":e.d+"d"))}),
              sorted.length>8&&React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",marginTop:4}},"+"+(sorted.length-8)+" more garments tracked"));
          })()),

        /* â”€â”€ WEAR STATS DASHBOARD â”€â”€ */
        React.createElement("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:14,padding:"16px",marginBottom:16}},
          React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:12}},
            React.createElement("span",{style:{fontSize:20}},"ðŸ“Š"),
            React.createElement("span",{style:{fontSize:16,fontFamily:"var(--sf)",fontWeight:600}},"Wear Stats")),
          (function(){
            if(!wearLog.length)return React.createElement("p",{style:{fontSize:11,fontFamily:"var(--f)",color:"var(--dim)",textAlign:"center",padding:10}},"Start logging wear in the rotation tab to build stats.");
            /* Count wears per watch */
            var wearCounts={};var genWears=0;var repWears=0;
            wearLog.forEach(function(e){wearCounts[e.watchId]=(wearCounts[e.watchId]||0)+1;var wObj=W.find(function(w){return w.id===e.watchId});if(wObj){if(wObj.t==="genuine")genWears++;else repWears++}});
            var sorted=Object.entries(wearCounts).sort(function(a,b){return b[1]-a[1]});
            var maxWears=sorted.length?sorted[0][1]:1;
            /* Never-worn active watches */
            var neverWorn=actW.filter(function(w){return !wearCounts[w.id]&&w.status==="active"});
            /* Streak â€” consecutive days logged */
            var dates=wearLog.map(function(e){return e.date}).sort().reverse();
            var uniqueDates=[...new Set(dates)];
            var streak=0;var checkDate=new Date();
            for(var si=0;si<90;si++){var ds=checkDate.toISOString().slice(0,10);if(uniqueDates.includes(ds)){streak++;checkDate.setDate(checkDate.getDate()-1)}else if(si===0){checkDate.setDate(checkDate.getDate()-1);continue}else break}
            return React.createElement("div",null,
              /* Summary row */
              React.createElement("div",{style:{display:"flex",gap:8,marginBottom:14}},
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--gold)"}},wearLog.length),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Total wears")),
                React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid var(--border)"}},
                  React.createElement("div",{style:{fontSize:20,fontFamily:"var(--f)",fontWeight:700,color:"var(--good)"}},streak),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Day streak")),
                !IS_SHARED&&React.createElement("div",{style:{flex:1,background:"var(--bg)",borderRadius:10,padding:"10px",textAlign:"center",border:"1px solid "+(genWears>=repWears?"rgba(122,184,122,0.3)":"rgba(200,90,58,0.3)")}},
                  React.createElement("div",{style:{fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:genWears>=repWears?"var(--good)":"var(--warn)"}},genWears+"/"+repWears),
                  React.createElement("div",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--dim)"}},"Gen / Rep"))),
              /* Frequency bars */
              React.createElement("div",{style:{marginBottom:14}},
                sorted.slice(0,12).map(function(e){
                  var wObj=W.find(function(w){return w.id===e[0]});if(!wObj)return null;
                  var pct=Math.round(e[1]/maxWears*100);
                  var barC=IS_SHARED?"var(--gold)":(wObj.t==="genuine"?"var(--good)":"#7ab8d8");
                  return React.createElement("div",{key:e[0],style:{display:"flex",alignItems:"center",gap:6,marginBottom:4}},
                    React.createElement("span",{style:{fontSize:12,flexShrink:0,width:18,textAlign:"center"}},wObj.i),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",minWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},wObj.n),
                    React.createElement("div",{style:{flex:1,height:12,background:"var(--card)",borderRadius:4,overflow:"hidden"}},
                      React.createElement("div",{style:{height:"100%",width:pct+"%",background:barC,borderRadius:4,minWidth:2}})),
                    React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",minWidth:18,textAlign:"right"}},e[1]))})),
              /* 4-week wear calendar */
              React.createElement("div",{style:{marginTop:10,paddingTop:10,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--gold)",fontWeight:600,marginBottom:6,letterSpacing:"0.08em"}},"WEAR CALENDAR"),
                React.createElement("div",{style:{display:"flex",gap:3,marginBottom:4}},["S","M","T","W","T","F","S"].map(function(d,i){return React.createElement("div",{key:i,style:{flex:1,textAlign:"center",fontSize:7,fontFamily:"var(--f)",color:"var(--dim)"}},d)})),
                (function(){
                  var cells=[];var today=new Date();
                  for(var ci=27;ci>=0;ci--){var cd=new Date(today);cd.setDate(cd.getDate()-ci);cells.push({date:cd.toISOString().slice(0,10),dow:cd.getDay()})}
                  /* Pad start to align with day-of-week */
                  var padStart=cells[0]?cells[0].dow:0;var padded=[];for(var pi=0;pi<padStart;pi++)padded.push(null);padded=padded.concat(cells);
                  var rows=[];for(var ri=0;ri<padded.length;ri+=7)rows.push(padded.slice(ri,ri+7));
                  return React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:2}},
                    rows.map(function(row,ri2){return React.createElement("div",{key:ri2,style:{display:"flex",gap:3}},
                      row.concat(Array(7-row.length).fill(null)).slice(0,7).map(function(cell,ci2){
                        if(!cell)return React.createElement("div",{key:ci2,style:{flex:1,height:18,borderRadius:3}});
                        var entry=wearLog.find(function(e){return e.date===cell.date});var wObj=entry?W.find(function(w){return w.id===entry.watchId}):null;
                        var bg=wObj?wObj.c:"var(--card2)";
                        return React.createElement("div",{key:ci2,title:cell.date+(wObj?" â€” "+wObj.n:""),style:{flex:1,height:18,borderRadius:3,background:bg,border:"1px solid "+(wObj?bg+"60":"var(--border)"),opacity:wObj?1:0.4}})}))}));
                })()),

              /* Never worn section */
              neverWorn.length>0&&React.createElement("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600,marginBottom:6}},"ðŸ’¤ NEVER LOGGED ("+neverWorn.length+")"),
                React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
                  neverWorn.map(function(w){return React.createElement("div",{key:w.id,style:{display:"flex",alignItems:"center",gap:3,background:"rgba(200,90,58,0.06)",border:"1px solid rgba(200,90,58,0.15)",borderRadius:6,padding:"3px 8px"}},
                    React.createElement("span",{style:{fontSize:10}},w.i),
                    React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"var(--warn)"}},w.n))}))));
          })())),

      /* â•â•â• WATCHES â•â•â• */
      view==="watches"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        /* Collection Stats */
        (function(){
          var gen=W.filter(function(w){return w.t==="genuine"&&w.active}).length;
          var rep=W.filter(function(w){return w.t==="replica"&&w.active}).length;
          var brC=W.filter(function(w){return w.br&&w.active}).length;
          var stC=W.filter(function(w){return!w.br&&w.active}).length;
          var incC=W.filter(function(w){return w.status==="incoming"}).length;
          var pendC=W.filter(function(w){return w.status==="pending-trade"}).length;
          var cats={};W.filter(function(w){return w.active}).forEach(function(w){(w.cx||[]).forEach(function(c){cats[c]=(cats[c]||0)+1})});
          var topCx=Object.entries(cats).sort(function(a,b){return b[1]-a[1]}).slice(0,3);
          return React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid var(--border)",borderRadius:12,padding:"12px 16px",marginBottom:12}},
            React.createElement("div",{style:{display:"flex",gap:16,flexWrap:"wrap",fontSize:10,fontFamily:"var(--f)"}},
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--gold)",fontWeight:700,fontSize:18}},gen+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"active")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"var(--good)"}},"âœ“ "+gen),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"genuine")),
              !IS_SHARED&&React.createElement("div",null,React.createElement("span",{style:{color:"#7ab8d8"}},"â—‡ "+rep),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"replica")),
              React.createElement("div",null,React.createElement("span",{style:{color:"var(--sub)"}},"â›“ï¸"+brC+" ðŸ”—"+stC)),
              incC>0&&React.createElement("div",null,React.createElement("span",{style:{color:"#d4b82a"}},"ðŸ“¦ "+incC),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"incoming")),
              pendC>0&&React.createElement("div",null,React.createElement("span",{style:{color:"var(--warn)"}},"ðŸ”„ "+pendC),React.createElement("span",{style:{color:"var(--dim)",marginLeft:4}},"pending"))),
            topCx.length>0&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:6}},
              React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)"}},"Top contexts:"),
              topCx.map(function(e){return React.createElement("span",{key:e[0],style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},(CXI[e[0]]||"")+e[0]+" Ã—"+e[1])})));
        })(),
        React.createElement("div",{style:{display:"flex",gap:5,flexWrap:"wrap",marginBottom:12}},
          (IS_SHARED?[{id:"all",l:"All "+W.length},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]:[{id:"all",l:"All "+W.length},{id:"genuine",l:"Gen"},{id:"replica",l:"Rep"},{id:"incoming",l:"Incoming"},{id:"pending-trade",l:"Pending"}]).map(function(f){return React.createElement(Pill,{key:f.id,on:wTab===f.id,onClick:function(){setWTab(f.id)}},f.l)}),
          React.createElement("button",{onClick:function(){wPhotoRef.current?wPhotoRef.current.click():wCamRef.current&&wCamRef.current.click()},style:{marginLeft:"auto",background:"none",border:"1px solid rgba(201,168,76,0.4)",borderRadius:20,padding:"8px 14px",cursor:"pointer",color:"var(--gold)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"ðŸ“¸ Scan"),
          React.createElement("button",{onClick:function(){var nw={id:"c-"+Date.now(),n:"New Watch",t:"genuine",d:"",c:"#5a5a5a",br:true,sc:[],straps:[{type:"bracelet",color:"silver",material:"steel"}],mt:"neutral",i:"âŒš",mc:IS_SHARED?autoMatchColors(""):[],ac:[],cx:["casual"],wt:IS_SHARED?["light","mid","heavy"]:["mid"],sg:"",active:true,status:"active"};setW(function(p){var u=p.concat([nw]);ps("w_"+SK,u);return u});setEditW(nw)},style:{background:"linear-gradient(135deg,var(--gold),#a8882a)",border:"none",borderRadius:20,padding:"8px 16px",cursor:"pointer",color:"var(--bg)",fontFamily:"var(--f)",fontSize:11,fontWeight:600,minHeight:36}},"+ Add"),
          React.createElement("button",{onClick:function(){var d=findWatchDupes();setWDupeGroups(d);setShowWDupes(true)},style:{background:"none",border:"1px solid rgba(200,90,58,0.4)",borderRadius:20,padding:"8px 12px",cursor:"pointer",color:"var(--warn)",fontFamily:"var(--f)",fontSize:10,fontWeight:600,minHeight:36}},"ðŸ” Dupes")),
        /* Hidden file inputs for watch scan */
        React.createElement("input",{ref:wPhotoRef,type:"file",accept:"image/*",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){scanWatch(e.target.files[0]);e.target.value=""}}}),
        React.createElement("input",{ref:wCamRef,type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:function(e){if(e.target.files&&e.target.files[0]){scanWatch(e.target.files[0]);e.target.value=""}}}),
        /* Watch scan loading */
        watchScanLoading&&React.createElement("div",{style:{background:"var(--card)",border:"1px solid rgba(201,168,76,0.3)",borderRadius:12,padding:"16px",marginBottom:12,textAlign:"center"}},
          React.createElement("div",{className:"sp",style:{width:24,height:24,border:"2px solid var(--gold)",borderTopColor:"transparent",borderRadius:"50%",margin:"0 auto 8px"}}),
          React.createElement("span",{style:{fontSize:12,fontFamily:"var(--f)",color:"var(--gold)"}},"Identifying watch...")),
        /* Watch scan result */
        watchScanResult&&!watchScanLoading&&React.createElement("div",{style:{background:"linear-gradient(135deg,var(--card),var(--card2))",border:"1px solid rgba(201,168,76,0.3)",borderRadius:14,padding:"16px",marginBottom:12}},
          watchScanResult.error?React.createElement("div",null,
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8}},
              React.createElement("span",{style:{fontSize:18}},"âš ï¸"),
              React.createElement("span",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--warn)",fontWeight:600}},"Could Not Identify Watch")),
            React.createElement("p",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--dim)"}},watchScanResult.error),
            React.createElement("button",{onClick:function(){setWatchScanResult(null)},className:"btn btn-ghost",style:{marginTop:8,fontSize:10}},"Dismiss"))
          :React.createElement("div",null,
            React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12}},
              React.createElement("div",{style:{width:48,height:48,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:(watchScanResult.ai.dial_hex||"#5a5a5a")+"20",fontSize:24,border:"2px solid "+(watchScanResult.ai.dial_hex||"#5a5a5a")+"50"}},watchScanResult.ai.emoji||"âŒš"),
              React.createElement("div",{style:{flex:1}},
                React.createElement("div",{style:{fontSize:16,fontWeight:600,color:"var(--gold)"}},watchScanResult.ai.brand+" "+watchScanResult.ai.model),
                React.createElement("div",{style:{fontSize:10,fontFamily:"var(--f)",color:"var(--sub)"}},(watchScanResult.ai.dial_color||"")+" dial"+(watchScanResult.ai.case_size?" Â· "+watchScanResult.ai.case_size+"mm":"")+" Â· "+(watchScanResult.ai.case_material||"steel")+(watchScanResult.ai.reference?" Â· Ref "+watchScanResult.ai.reference:"")),
                React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",marginTop:2}},(watchScanResult.ai.complications||[]).join(", "))),
              watchScanResult.ai.confidence&&React.createElement("div",{style:{width:36,height:36,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(watchScanResult.ai.confidence>=7?"var(--good)":watchScanResult.ai.confidence>=4?"var(--gold)":"var(--warn)"),fontSize:14,fontFamily:"var(--f)",fontWeight:700,color:watchScanResult.ai.confidence>=7?"var(--good)":watchScanResult.ai.confidence>=4?"var(--gold)":"var(--warn)"}},watchScanResult.ai.confidence)),
            watchScanResult.ai.notes&&React.createElement("p",{style:{fontSize:10,fontFamily:"var(--sf)",fontStyle:"italic",color:"var(--sub)",marginBottom:10,lineHeight:1.5}},watchScanResult.ai.notes),
            React.createElement("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:10}},(watchScanResult.ai.suggested_contexts||[]).map(function(cx){return React.createElement("span",{key:cx,className:"chip",style:{fontSize:8,padding:"2px 8px"}},(CXI[cx]||"")+" "+cx)})),
            watchScanResult.watch&&watchScanResult.watch.photoUrl&&React.createElement("img",{src:watchScanResult.watch.photoUrl,alt:"Scanned watch",style:{width:"100%",maxHeight:180,objectFit:"cover",borderRadius:10,marginBottom:10,border:"1px solid var(--border)"}}),
            React.createElement("div",{style:{display:"flex",gap:8}},
              React.createElement("button",{className:"btn btn-gold",style:{flex:1},onClick:function(){
                var nw=watchScanResult.watch;
                setW(function(p){var u=p.concat([nw]);ps("w_"+SK,u);return u});
                setEditW(nw);setWatchScanResult(null);
              }},"âœ“ Add to Collection"),
              React.createElement("button",{className:"btn btn-ghost",style:{flex:0,padding:"14px 16px"},onClick:function(){setWatchScanResult(null)}},"âœ•")))),
        filtW.length===0&&React.createElement("div",{style:{textAlign:"center",padding:"40px 16px"}},React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},"No watches match filter")),
        filtW.map(function(w){var st=STS.find(function(s){return s.id===w.status});return React.createElement("div",{key:w.id,className:"card-lift",style:{background:w.active?"var(--card)":"var(--bg)",border:"1px solid "+(w.active?"var(--border)":"var(--border)"),borderRadius:12,padding:"14px 16px",opacity:w.active?1:0.5,marginBottom:8}},
          React.createElement("div",{style:{display:"flex",gap:12,alignItems:"flex-start"}},
            React.createElement("div",{onClick:function(){toggleW(w.id)},style:{width:44,height:44,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:w.active?w.c+"20":"var(--card)",fontSize:20,flexShrink:0,cursor:"pointer",border:"2px solid "+(w.active?w.c+"60":"var(--border)"),overflow:"hidden"}},w.photoUrl?React.createElement("img",{src:w.photoUrl,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):w.i),
            React.createElement("div",{style:{flex:1,minWidth:0,cursor:"pointer"},onClick:function(){setEditW(w)}},
              React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:3}},
                React.createElement("span",{style:{fontSize:14,fontWeight:600,color:w.active?"var(--text)":"var(--dim)"}},w.n),
                !IS_SHARED&&w.t==="replica"&&React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",color:"#6a5a50",border:"1px solid var(--rep-border)",borderRadius:3,padding:"1px 5px"}},"REP"),
                React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:w.c}}),
                React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:st?st.c:"var(--dim)"}},st?st.l:"")),
              React.createElement("div",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)",marginBottom:4}},w.d+(w.size?" Â· "+w.size:"")+(w.ref?" Â· Ref "+w.ref:"")+" Â· "+(w.straps&&w.straps.length?w.straps.map(function(s){var td=STRAP_TYPES.find(function(t){return t.id===s.type});return(td?td.icon:"")+s.type+(s.type!=="bracelet"&&s.color?" "+s.color:"")}).join(", "):w.br?"Bracelet":"Strap"+(w.sc&&w.sc.length?": "+w.sc.join(", "):""))+" Â· "+w.mt+(w.movement?" Â· "+w.movement:"")),
              React.createElement("div",{style:{display:"flex",gap:3,flexWrap:"wrap"}},(w.cx||[]).map(function(c){return React.createElement("span",{key:c,style:{fontSize:8,fontFamily:"var(--f)",background:"var(--bg)",borderRadius:8,padding:"2px 6px",color:"var(--dim)"}},(CXI[c]||"")+c)}))),
            React.createElement("button",{onClick:function(e){e.stopPropagation();toggleW(w.id)},style:{width:44,height:26,borderRadius:13,background:w.active?"var(--gold)":"var(--card2)",border:"none",cursor:"pointer",position:"relative",flexShrink:0,minHeight:26}},
              React.createElement("div",{style:{width:20,height:20,borderRadius:"50%",background:w.active?"var(--bg)":"var(--dim)",position:"absolute",top:3,left:w.active?21:3,transition:"left .2s"}}))))}),
        React.createElement("button",{onClick:function(){if(confirm("Reset to defaults?")){setW(DEFAULTS);ps("w_"+SK,DEFAULTS)}},style:{display:"block",margin:"12px auto 0",background:"none",border:"1px solid var(--border)",borderRadius:8,padding:"10px 16px",cursor:"pointer",color:"var(--dim)",fontFamily:"var(--f)",fontSize:10,minHeight:40}},"Reset Defaults")),

      /* â•â•â• SAVED â•â•â• */
      view==="saved"&&React.createElement("div",{style:{paddingTop:16,paddingBottom:40}},
        !saved.length?React.createElement("div",{style:{textAlign:"center",padding:"50px 16px"}},React.createElement("p",{style:{fontSize:28,margin:"0 0 8px"}},"ðŸ“‹"),React.createElement("p",{style:{fontSize:13,fontFamily:"var(--f)",color:"var(--dim)"}},"No saved outfits"))
        :function(){
      var todayISO=new Date().toISOString().slice(0,10);
      return saved.slice().sort(function(a,b){
        var aIsToday=a.wearDate===todayISO?1:0;
        var bIsToday=b.wearDate===todayISO?1:0;
        if(aIsToday!==bIsToday)return bIsToday-aIsToday;
        var aHasDate=a.wearDate?1:0;
        var bHasDate=b.wearDate?1:0;
        if(aHasDate!==bHasDate)return bHasDate-aHasDate;
        if(aHasDate&&bHasDate)return a.wearDate<b.wearDate?-1:a.wearDate>b.wearDate?1:0;
        return (b.ts||0)-(a.ts||0);
      });
    }().map(function(o){var oTop=o.items?o.items.find(function(i){return catOf(i.garmentType)==="tops"}):null;var oBot=o.items?o.items.find(function(i){return catOf(i.garmentType)==="bottoms"}):null;var oSh=o.items?o.items.find(function(i){return catOf(i.garmentType)==="shoes"}):null;return React.createElement("div",{key:o.id,className:"card-lift",style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:12,padding:"14px 16px",marginBottom:10}},
          React.createElement("div",{style:{display:"flex",gap:10,marginBottom:8}},
            React.createElement(OutfitFigure,{topColor:oTop?oTop.color:"grey",botColor:oBot?oBot.color:"charcoal",shoeColor:oSh?oSh.color:"black",watchColor:o.watches&&o.watches[0]?o.watches[0].c:"#c9a84c",watchIcon:o.watches&&o.watches[0]?o.watches[0].i:"âŒš",watchName:"",size:60}),
            React.createElement("div",{style:{flex:1,minWidth:0}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}},
                React.createElement("div",null,React.createElement("h3",{style:{fontSize:14,fontWeight:500,margin:"0 0 2px"}},o.name),React.createElement("p",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--dim)",margin:0}},(activeCxIcons[o.context]||"")+" "+o.context+" Â· "+new Date(o.ts).toLocaleDateString()+(o.fs?" Â· Score "+o.fs:"")),o.weather&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",color:"#7ab8d8",background:"rgba(100,150,220,0.08)",borderRadius:4,padding:"1px 6px",border:"1px solid rgba(100,150,220,0.15)",marginTop:2,display:"inline-block"}},(o.weather.cond?o.weather.cond.i:"")+" "+o.weather.temp+"Â°C")),
                React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end"}},
                  React.createElement("button",{onClick:function(){delSaved(o.id)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:10,minHeight:30}},"âœ•"),
                  /* â•â•â• WEAR DATE BUTTON â•â•â• */
                    o.wearDate&&React.createElement("span",{style:{fontSize:8,fontFamily:"var(--f)",fontWeight:600,padding:"2px 7px",borderRadius:4,color:o.wearDate===new Date().toISOString().slice(0,10)?"var(--good)":"var(--gold)",background:o.wearDate===new Date().toISOString().slice(0,10)?"rgba(122,184,122,0.12)":"rgba(201,168,76,0.1)",border:"1px solid "+(o.wearDate===new Date().toISOString().slice(0,10)?"rgba(122,184,122,0.25)":"rgba(201,168,76,0.2)")}},o.wearDate===new Date().toISOString().slice(0,10)?"ðŸ‘” Wearing Today":"ðŸ“Œ "+new Date(o.wearDate+"T12:00").toLocaleDateString(undefined,{month:"short",day:"numeric"})),
                    React.createElement("button",{onClick:function(ev){ev.stopPropagation();setWearPicker(wearPicker===o.id?null:o.id)},style:{background:"none",border:"1px solid var(--border)",borderRadius:6,padding:"5px 9px",cursor:"pointer",color:"var(--sub)",fontFamily:"var(--f)",fontSize:9,minHeight:26}},o.wearDate?"âœŽ Change":"ðŸ‘” Wear"),
                    wearPicker===o.id&&React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:4,padding:"8px 10px",background:"var(--card)",border:"1px solid var(--gold)",borderRadius:8,marginTop:2,boxShadow:"0 4px 16px rgba(0,0,0,0.15)"}},
                      React.createElement("button",{onClick:function(){setOutfitWear(o.id,new Date().toISOString().slice(0,10))},style:{background:"rgba(122,184,122,0.12)",border:"1px solid rgba(122,184,122,0.25)",borderRadius:6,padding:"6px 12px",cursor:"pointer",color:"var(--good)",fontFamily:"var(--f)",fontSize:10,fontWeight:600}},"ðŸ‘” Today"),
                      React.createElement("label",{style:{display:"flex",alignItems:"center",gap:6}},React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},"Pick:"),React.createElement("input",{type:"date",defaultValue:o.wearDate||"",onChange:function(ev){if(ev.target.value)setOutfitWear(o.id,ev.target.value)},style:{fontSize:10,fontFamily:"var(--f)",background:"var(--bg)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:4,padding:"4px 6px"}})),
                      o.wearDate&&React.createElement("button",{onClick:function(){setOutfitWear(o.id,null)},style:{background:"none",border:"1px solid var(--del-border)",borderRadius:6,padding:"4px 10px",cursor:"pointer",color:"var(--del-text)",fontFamily:"var(--f)",fontSize:9}},"âœ• Clear date")),
                  /* Weather match badge */
                  weather&&o.weather&&(function(){var ct=weather.temp||18,ot=o.weather.temp||18,diff=Math.abs(ct-ot);var cRain=weather.cond&&weather.cond.rain,oRain=o.weather.cond&&o.weather.cond.rain;var match=diff<=5&&cRain===oRain?"great":diff<=10?"ok":"poor";return React.createElement("span",{style:{fontSize:7,fontFamily:"var(--f)",padding:"2px 6px",borderRadius:4,color:match==="great"?"var(--good)":match==="ok"?"var(--gold)":"var(--warn)",background:match==="great"?"rgba(122,184,122,0.1)":match==="ok"?"rgba(201,168,76,0.1)":"rgba(200,90,58,0.1)",border:"1px solid "+(match==="great"?"rgba(122,184,122,0.2)":match==="ok"?"rgba(201,168,76,0.2)":"rgba(200,90,58,0.2)")}},match==="great"?"âœ“ Today match":match==="ok"?"~ Similar wx":"âœ— Diff weather")})())))),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}},(o.items||[]).map(function(item,i){return React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:4,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:"1px solid var(--border)"}},item.photoUrl&&React.createElement("img",{src:item.photoUrl,alt:"",style:{width:20,height:20,objectFit:"cover",borderRadius:3}}),React.createElement(Dot,{color:item.color,size:6}),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:"var(--sub)"}},item.name||item.color))})),
          React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},(o.watches||[]).slice(0,3).map(function(w,i){return React.createElement("div",{key:w.id||i,style:{display:"flex",alignItems:"center",gap:3,background:"var(--bg)",borderRadius:6,padding:"4px 8px",border:i===0?"1px solid rgba(201,168,76,0.2)":"1px solid var(--border)"}},React.createElement("span",{style:{fontSize:12}},w.i),React.createElement("span",{style:{fontSize:9,fontFamily:"var(--f)",color:i===0?"var(--gold)":"var(--sub)"}},w.n))})))})))
  );
}
ReactDOM.render(React.createElement(App),document.getElementById("root"));
</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(function(e){console.log('SW reg failed:',e)})}
</script>
</body>
</html>
